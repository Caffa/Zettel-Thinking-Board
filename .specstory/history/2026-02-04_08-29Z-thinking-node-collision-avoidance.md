<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session 5151135c-9b03-4d41-ba5f-7fb75740ef6c (2026-02-04 08:29Z) -->

# Thinking node collision avoidance (2026-02-04 08:29Z)

_**User**_

The thinking node that is created to show the thinking of the AI model does not have collision avoidance with other nodes. Please implement for it to go towards the left side of the node preferentially and just to shift out of the way in any direction instead of Overlapping if the left side is already occupied. 

---

_**Agent (model default, mode Agent)**_


Searching the codebase for where the thinking node is created and how its position is set.


---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "thinking",
  "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
  "caseInsensitive": true
}
```
Result:

```json
{
  "success": {
    "pattern": "thinking",
    "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board": {
        "content": {
          "matches": [
            {
              "file": "src/main.ts",
              "matches": [
                {
                  "lineNumber": 278,
                  "content": "\t\tn(welcome, \"Welcome to Zettel Thinking Board. Each column is a separate showcase. Nodes run top to bottom. Right-click a card → Run node or Run chain. Uncolored or unused-color cards are not connected to any node and do not add to the prompt.\", TUT_LEFT, welcomeY, \"\", TUT_WELCOME_W, 132),"
                },
                {
                  "lineNumber": 339,
                  "content": "export default class ZettelThinkingBoardPlugin extends Plugin {"
                },
                {
                  "lineNumber": 452,
                  "content": "\t\t\t\t\tconsole.error(\"Zettel Thinking Board: could not register canvas node menu.\", e);"
                },
                {
                  "lineNumber": 479,
                  "content": "\t\t\t\tconsole.error(\"Zettel Thinking Board: could not register canvas background menu.\", e);"
                },
                {
                  "lineNumber": 601,
                  "content": "\t\t\tconsole.error(\"Zettel Thinking Board onload error:\", e);"
                },
                {
                  "lineNumber": 668,
                  "content": "\t\t\tnew Notice(\"Canvas template folder not configured. Please set it in Settings → Zettel Thinking Board → Canvas Templates.\");"
                },
                {
                  "lineNumber": 712,
                  "content": "\t\t\tnew Notice(\"Canvas template folder not configured. Please set it in Settings → Zettel Thinking Board → Canvas Templates.\");"
                },
                {
                  "lineNumber": 740,
                  "content": "\t\t\tnew Notice(\"Canvas template folder not configured. Please set it in Settings → Zettel Thinking Board → Canvas Templates.\");"
                },
                {
                  "lineNumber": 813,
                  "content": "\t\tcontainerEl.querySelectorAll(&#96;.${ZettelThinkingBoardPlugin.ZTB_TOOLBAR_CLASS}&#96;).forEach((el) =&gt; el.remove());"
                },
                {
                  "lineNumber": 818,
                  "content": "\t\tif (containerEl.querySelector(&#96;.${ZettelThinkingBoardPlugin.ZTB_TOOLBAR_CLASS}&#96;)) return;"
                },
                {
                  "lineNumber": 819,
                  "content": "\t\tconst bar = containerEl.createDiv({ cls: ZettelThinkingBoardPlugin.ZTB_TOOLBAR_CLASS });"
                },
                {
                  "lineNumber": 834,
                  "content": "\t\tcontainerEl.querySelectorAll(&#96;.${ZettelThinkingBoardPlugin.ZTB_TEMPLATE_BANNER_CLASS}&#96;).forEach((el) =&gt; el.remove());"
                },
                {
                  "lineNumber": 842,
                  "content": "\t\tconst existingBanner = containerEl.querySelector(&#96;.${ZettelThinkingBoardPlugin.ZTB_TEMPLATE_BANNER_CLASS}&#96;);"
                },
                {
                  "lineNumber": 846,
                  "content": "\t\t\tconst banner = containerEl.createDiv({ cls: ZettelThinkingBoardPlugin.ZTB_TEMPLATE_BANNER_CLASS });"
                }
              ]
            },
            {
              "file": "src/canvas/types.test.ts",
              "matches": [
                {
                  "lineNumber": 18,
                  "content": "\tEDGE_LABEL_THINKING,"
                },
                {
                  "lineNumber": 96,
                  "content": "\tit(\"returns true for output, prompt, and thinking labels\", () =&gt; {"
                },
                {
                  "lineNumber": 99,
                  "content": "\t\texpect(isAuxiliaryEdge({ id: \"e\", fromNode: \"a\", toNode: \"b\", label: EDGE_LABEL_THINKING })).toBe(true);"
                }
              ]
            },
            {
              "file": "src/engine/runner.ts",
              "matches": [
                {
                  "lineNumber": 6,
                  "content": "\tEDGE_LABEL_THINKING,"
                },
                {
                  "lineNumber": 248,
                  "content": "/** Set of node ids that are our output/prompt/thinking nodes; we must not overwrite them with live data. */"
                },
                {
                  "lineNumber": 250,
                  "content": "\tconst auxiliaryLabels = [EDGE_LABEL_OUTPUT, EDGE_LABEL_PROMPT, EDGE_LABEL_THINKING];"
                },
                {
                  "lineNumber": 382,
                  "content": "\t\t\tthinking: result.thinking,"
                },
                {
                  "lineNumber": 401,
                  "content": "\t\t\tthinking: result.thinking,"
                },
                {
                  "lineNumber": 420,
                  "content": "\t\t\tthinking: result.thinking,"
                },
                {
                  "lineNumber": 519,
                  "content": "/** Preferred order for auxiliary edges (prompt/thinking): use left/right to avoid input (top) and output (bottom). */"
                },
                {
                  "lineNumber": 522,
                  "content": "/** Pick a side of sourceNode that is not already used by edges from/to that node. Used so prompt/thinking connect on a free side. */"
                },
                {
                  "lineNumber": 535,
                  "content": "/** Options for ensureOutputNodeAndEdge: optional prompt and thinking to show in separate nodes. */"
                },
                {
                  "lineNumber": 538,
                  "content": "\tthinking?: string;"
                },
                {
                  "lineNumber": 541,
                  "content": "/** Create or replace the Green output node (and optional prompt/thinking nodes) and ensure edges from source. Mutates data only. */"
                },
                {
                  "lineNumber": 549,
                  "content": "\tconst { fullPrompt, thinking } = options;"
                },
                {
                  "lineNumber": 551,
                  "content": "\tconst thinkingId = findAuxiliaryNodeForSource(data, sourceNode.id, EDGE_LABEL_THINKING);"
                },
                {
                  "lineNumber": 558,
                  "content": "\tconst extraExclude = [promptId, thinkingId].filter((id): id is string =&gt; id != null);"
                },
                {
                  "lineNumber": 631,
                  "content": "\t// 2. Ensure thinking node (above output) when setting on and thinking present"
                },
                {
                  "lineNumber": 632,
                  "content": "\tif (settings.showThinkingNode &amp;&amp; thinking != null &amp;&amp; thinking.length &gt; 0) {"
                },
                {
                  "lineNumber": 633,
                  "content": "\t\tconst thinkingSide = chooseFreeSideForAuxiliaryEdge(data, sourceNode.id);"
                },
                {
                  "lineNumber": 634,
                  "content": "\t\tconst thinkingDefaultY = outputY - height - GREEN_NODE_PADDING;"
                },
                {
                  "lineNumber": 635,
                  "content": "\t\tconst thinkingExclude = [sourceNode.id, resolvedOutputId, promptId].filter((id): id is string =&gt; id != null);"
                },
                {
                  "lineNumber": 639,
                  "content": "\t\t\tthinkingId,"
                },
                {
                  "lineNumber": 641,
                  "content": "\t\t\tthinkingDefaultY,"
                },
                {
                  "lineNumber": 644,
                  "content": "\t\t\tthinkingExclude"
                },
                {
                  "lineNumber": 646,
                  "content": "\t\tconst thinkingColor = shadeColor(settings.colorGreen, 0.15);"
                },
                {
                  "lineNumber": 648,
                  "content": "\t\tif (thinkingId) {"
                },
                {
                  "lineNumber": 649,
                  "content": "\t\t\tconst tn = getNodeById(data, thinkingId);"
                },
                {
                  "lineNumber": 653,
                  "content": "\t\t\t\t\ttext: thinking,"
                },
                {
                  "lineNumber": 656,
                  "content": "\t\t\t\t\tcolor: thinkingColor,"
                },
                {
                  "lineNumber": 658,
                  "content": "\t\t\t\tconst idx = data.nodes.findIndex((n) =&gt; n.id === thinkingId);"
                },
                {
                  "lineNumber": 662,
                  "content": "\t\t\t\t(e) =&gt; e.fromNode === sourceNode.id &amp;&amp; e.toNode === thinkingId &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_THINKING"
                },
                {
                  "lineNumber": 668,
                  "content": "\t\t\t\t\tfromSide: thinkingSide,"
                },
                {
                  "lineNumber": 669,
                  "content": "\t\t\t\t\ttoNode: thinkingId,"
                },
                {
                  "lineNumber": 670,
                  "content": "\t\t\t\t\ttoSide: thinkingSide === \"left\" ? \"right\" : thinkingSide === \"right\" ? \"left\" : thinkingSide === \"top\" ? \"bottom\" : \"top\","
                },
                {
                  "lineNumber": 671,
                  "content": "\t\t\t\t\tlabel: EDGE_LABEL_THINKING,"
                },
                {
                  "lineNumber": 679,
                  "content": "\t\t\t\ttext: thinking,"
                },
                {
                  "lineNumber": 684,
                  "content": "\t\t\t\tcolor: thinkingColor,"
                },
                {
                  "lineNumber": 689,
                  "content": "\t\t\t\tfromSide: thinkingSide,"
                },
                {
                  "lineNumber": 691,
                  "content": "\t\t\t\ttoSide: thinkingSide === \"left\" ? \"right\" : thinkingSide === \"right\" ? \"left\" : thinkingSide === \"top\" ? \"bottom\" : \"top\","
                },
                {
                  "lineNumber": 692,
                  "content": "\t\t\t\tlabel: EDGE_LABEL_THINKING,"
                },
                {
                  "lineNumber": 697,
                  "content": "\t// 3. Ensure prompt node (above thinking or output) when setting on and fullPrompt present"
                },
                {
                  "lineNumber": 700,
                  "content": "\t\tconst thinkingNodeId = settings.showThinkingNode &amp;&amp; thinking ? findAuxiliaryNodeForSource(data, sourceNode.id, EDGE_LABEL_THINKING) : null;"
                },
                {
                  "lineNumber": 701,
                  "content": "\t\tconst anchorNode = thinkingNodeId ? getNodeById(data, thinkingNodeId) : outputNode;"
                },
                {
                  "lineNumber": 704,
                  "content": "\t\tconst promptExclude = [sourceNode.id, resolvedOutputId, thinkingId, promptId].filter((id): id is string =&gt; id != null);"
                },
                {
                  "lineNumber": 863,
                  "content": "/** Remove the Green output node and any prompt/thinking nodes (and their edges) for a given source node; mutates data and saves. */"
                },
                {
                  "lineNumber": 875,
                  "content": "\tconst thinkingId = findAuxiliaryNodeForSource(data, sourceNodeId, EDGE_LABEL_THINKING);"
                },
                {
                  "lineNumber": 876,
                  "content": "\tconst toRemove = new Set&lt;string&gt;([outId, promptId, thinkingId].filter((id): id is string =&gt; id != null));"
                },
                {
                  "lineNumber": 881,
                  "content": "\t\t\t!(e.fromNode === sourceNodeId &amp;&amp; toRemove.has(e.toNode) &amp;&amp; [EDGE_LABEL_OUTPUT, EDGE_LABEL_PROMPT, EDGE_LABEL_THINKING].includes(parseEdgeVariableName(e.label)))"
                },
                {
                  "lineNumber": 891,
                  "content": "/** Remove all Green output, prompt, and thinking nodes and their edges on the canvas; mutates data and saves. */"
                },
                {
                  "lineNumber": 899,
                  "content": "\tconst auxiliaryLabels = [EDGE_LABEL_OUTPUT, EDGE_LABEL_PROMPT, EDGE_LABEL_THINKING];"
                }
              ]
            },
            {
              "file": "src/canvas/nodes.ts",
              "matches": [
                {
                  "lineNumber": 63,
                  "content": "\tEDGE_LABEL_THINKING,"
                }
              ]
            },
            {
              "file": "src/canvas/types.ts",
              "matches": [
                {
                  "lineNumber": 42,
                  "content": "/** Reserved edge label from run node to optional thinking display node. */"
                },
                {
                  "lineNumber": 43,
                  "content": "export const EDGE_LABEL_THINKING = \"thinking\";"
                },
                {
                  "lineNumber": 57,
                  "content": "/** True if edge is a reserved auxiliary edge (output, prompt, thinking); ignored by execution. */"
                },
                {
                  "lineNumber": 60,
                  "content": "\treturn label === EDGE_LABEL_OUTPUT || label === EDGE_LABEL_PROMPT || label === EDGE_LABEL_THINKING;"
                },
                {
                  "lineNumber": 76,
                  "content": "/** Get incoming edges for a node with parent id and variable name, sorted by parent y then x (higher, then left-most). Excludes output/prompt/thinking edges. Connections to a green output node are treated as connections to that output's source node. */"
                },
                {
                  "lineNumber": 97,
                  "content": "/** Get parent node IDs for a node, sorted by y (top to bottom). Excludes output/prompt/thinking edges. Connections to a green output node are treated as connections to that output's source node. */"
                },
                {
                  "lineNumber": 177,
                  "content": "/** Find the node id for an auxiliary edge from source with the given label (e.g. EDGE_LABEL_PROMPT, EDGE_LABEL_THINKING). */"
                }
              ]
            },
            {
              "file": "src/engine/ollama.ts",
              "matches": [
                {
                  "lineNumber": 34,
                  "content": "/** Response from Ollama /api/generate (thinking is present for reasoning models). */"
                },
                {
                  "lineNumber": 37,
                  "content": "\tthinking?: string;"
                },
                {
                  "lineNumber": 40,
                  "content": "/** Call Ollama /api/generate and return the response and optional thinking. */"
                },
                {
                  "lineNumber": 62,
                  "content": "\tconst data = (await res.json()) as { response?: string; thinking?: string };"
                },
                {
                  "lineNumber": 64,
                  "content": "\tconst thinking = typeof data.thinking === \"string\" &amp;&amp; data.thinking.length &gt; 0 ? data.thinking : undefined;"
                },
                {
                  "lineNumber": 65,
                  "content": "\treturn { response, thinking };"
                }
              ]
            },
            {
              "file": "src/settings.ts",
              "matches": [
                {
                  "lineNumber": 107,
                  "content": "\tshowThinkingNode: boolean;"
                },
                {
                  "lineNumber": 131,
                  "content": "\tshowThinkingNode: false,"
                },
                {
                  "lineNumber": 670,
                  "content": "\t\t\t.setName(\"Show model thinking node\")"
                },
                {
                  "lineNumber": 671,
                  "content": "\t\t\t.setDesc(\"When enabled and the model returns thinking (e.g. reasoning trace), create an extra node to display it\")"
                },
                {
                  "lineNumber": 673,
                  "content": "\t\t\t\t.setValue(s.showThinkingNode)"
                },
                {
                  "lineNumber": 675,
                  "content": "\t\t\t\t\tthis.plugin.settings.showThinkingNode = value;"
                }
              ]
            },
            {
              "file": "src/engine/installer.ts",
              "matches": [
                {
                  "lineNumber": 28,
                  "content": "\t\tuseCase: \"Complex analysis, logical reasoning, and structured thinking\","
                }
              ]
            },
            {
              "file": "src/views/ZettelControlsView.ts",
              "matches": [
                {
                  "lineNumber": 2,
                  "content": "import type {IZettelThinkingBoardPlugin} from \"../types\";"
                },
                {
                  "lineNumber": 27,
                  "content": "\tconstructor(leaf: WorkspaceLeaf, public readonly plugin: IZettelThinkingBoardPlugin) {"
                }
              ]
            },
            {
              "file": "src/types.ts",
              "matches": [
                {
                  "lineNumber": 5,
                  "content": "export interface IZettelThinkingBoardPlugin {"
                }
              ]
            }
          ],
          "totalLines": 89,
          "totalMatchedLines": 89
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="semantic_search_full">
<details>
<summary>Tool use: **semantic_search_full**</summary>


Parameters:

```json
{
  "query": "Where is the thinking node created and positioned on the canvas?",
  "includePattern": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
  "topK": 10,
  "explanation": ""
}
```
Result:

```json
{
  "codeResults": [
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 541
          },
          "endPosition": {
            "line": 765,
            "column": 1
          }
        },
        "contents": "function ensureOutputNodeAndEdge(\n\tdata: CanvasData,\n\tsourceNode: AllCanvasNodeData,\n\ttext: string,\n\tsettings: ZettelPluginSettings,\n\toptions: EnsureOutputOptions = {}\n): void {\n\n\n\t// 2. Ensure thinking node (above output) when setting on and thinking present\n\tif (settings.showThinkingNode &amp;&amp; thinking != null &amp;&amp; thinking.length &gt; 0) {\n\t\tconst thinkingSide = chooseFreeSideForAuxiliaryEdge(data, sourceNode.id);\n\t\tconst thinkingDefaultY = outputY - height - GREEN_NODE_PADDING;\n\t\tconst thinkingExclude = [sourceNode.id, resolvedOutputId, promptId].filter((id): id is string =&gt; id != null);\n\t\tconst { x: tx, y: ty } = chooseOutputPositionXY(\n\t\t\tdata,\n\t\t\tsourceNode.id,\n\t\t\tthinkingId,\n\t\t\tdefaultX,\n\t\t\tthinkingDefaultY,\n\t\t\twidth,\n\t\t\theight,\n\t\t\tthinkingExclude\n\t\t);\n\t\tconst thinkingColor = shadeColor(settings.colorGreen, 0.15);\n\n\t\tif (thinkingId) {\n\t\t\tconst tn = getNodeById(data, thinkingId);\n\t\t\tif (tn &amp;&amp; isTextNode(tn)) {\n\t\t\t\tconst updated = {\n\t\t\t\t\t...(tn as CanvasTextData),\n\t\t\t\t\ttext: thinking,\n\t\t\t\t\twidth,\n\t\t\t\t\theight,\n\t\t\t\t\tcolor: thinkingColor,\n\t\t\t\t};\n\t\t\t\tconst idx = data.nodes.findIndex((n) =&gt; n.id === thinkingId);\n\t\t\t\tif (idx &gt;= 0) data.nodes[idx] = updated;\n\t\t\t}\n\t\t\tconst hasEdge = data.edges.some(\n\t\t\t\t(e) =&gt; e.fromNode === sourceNode.id &amp;&amp; e.toNode === thinkingId &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_THINKING\n\t\t\t);\n\t\t\tif (!hasEdge) {\n\t\t\t\tdata.edges.push({\n\t\t\t\t\tid: randomId(),\n\t\t\t\t\tfromNode: sourceNode.id,\n\t\t\t\t\tfromSide: thinkingSide,\n\t\t\t\t\ttoNode: thinkingId,\n\t\t\t\t\ttoSide: thinkingSide === \"left\" ? \"right\" : thinkingSide === \"right\" ? \"left\" : thinkingSide === \"top\" ? \"bottom\" : \"top\",\n\t\t\t\t\tlabel: EDGE_LABEL_THINKING,\n\t\t\t\t});\n\t\t\t}\n\t\t} else {\n\t\t\tconst newId = randomId();\n\t\t\tdata.nodes.push({\n\t\t\t\tid: newId,\n\t\t\t\ttype: \"text\",\n\t\t\t\ttext: thinking,\n\t\t\t\tx: tx,\n\t\t\t\ty: ty,\n\t\t\t\twidth,\n\t\t\t\theight,\n\t\t\t\tcolor: thinkingColor,\n\t\t\t} as CanvasTextData);\n\t\t\tdata.edges.push({\n\t\t\t\tid: randomId(),\n\t\t\t\tfromNode: sourceNode.id,\n\t\t\t\tfromSide: thinkingSide,\n\t\t\t\ttoNode: newId,\n\t\t\t\ttoSide: thinkingSide === \"left\" ? \"right\" : thinkingSide === \"right\" ? \"left\" : thinkingSide === \"top\" ? \"bottom\" : \"top\",\n\t\t\t\tlabel: EDGE_LABEL_THINKING,\n\t\t\t});\n\t\t}\n\t}\n\n\t// 3. Ensure prompt node (above thinking or output) when setting on and fullPrompt present\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 542,
                "column": 1
              },
              "endPosition": {
                "line": 549,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "function ensureOutputNodeAndEdge(",
            "lineNumber": 542,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 543,
            "isSignature": true
          },
          {
            "text": "\tsourceNode: AllCanvasNodeData,",
            "lineNumber": 544,
            "isSignature": true
          },
          {
            "text": "\ttext: string,",
            "lineNumber": 545,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 546,
            "isSignature": true
          },
          {
            "text": "\toptions: EnsureOutputOptions = {}",
            "lineNumber": 547,
            "isSignature": true
          },
          {
            "text": "): void {",
            "lineNumber": 548,
            "isSignature": true
          },
          {
            "lineNumber": 629
          },
          {
            "lineNumber": 630
          },
          {
            "text": "\t// 2. Ensure thinking node (above output) when setting on and thinking present",
            "lineNumber": 631
          },
          {
            "text": "\tif (settings.showThinkingNode &amp;&amp; thinking != null &amp;&amp; thinking.length &gt; 0) {",
            "lineNumber": 632
          },
          {
            "text": "\t\tconst thinkingSide = chooseFreeSideForAuxiliaryEdge(data, sourceNode.id);",
            "lineNumber": 633
          },
          {
            "text": "\t\tconst thinkingDefaultY = outputY - height - GREEN_NODE_PADDING;",
            "lineNumber": 634
          },
          {
            "text": "\t\tconst thinkingExclude = [sourceNode.id, resolvedOutputId, promptId].filter((id): id is string =&gt; id != null);",
            "lineNumber": 635
          },
          {
            "text": "\t\tconst { x: tx, y: ty } = chooseOutputPositionXY(",
            "lineNumber": 636
          },
          {
            "text": "\t\t\tdata,",
            "lineNumber": 637
          },
          {
            "text": "\t\t\tsourceNode.id,",
            "lineNumber": 638
          },
          {
            "text": "\t\t\tthinkingId,",
            "lineNumber": 639
          },
          {
            "text": "\t\t\tdefaultX,",
            "lineNumber": 640
          },
          {
            "text": "\t\t\tthinkingDefaultY,",
            "lineNumber": 641
          },
          {
            "text": "\t\t\twidth,",
            "lineNumber": 642
          },
          {
            "text": "\t\t\theight,",
            "lineNumber": 643
          },
          {
            "text": "\t\t\tthinkingExclude",
            "lineNumber": 644
          },
          {
            "text": "\t\t);",
            "lineNumber": 645
          },
          {
            "text": "\t\tconst thinkingColor = shadeColor(settings.colorGreen, 0.15);",
            "lineNumber": 646
          },
          {
            "lineNumber": 647
          },
          {
            "text": "\t\tif (thinkingId) {",
            "lineNumber": 648
          },
          {
            "text": "\t\t\tconst tn = getNodeById(data, thinkingId);",
            "lineNumber": 649
          },
          {
            "text": "\t\t\tif (tn &amp;&amp; isTextNode(tn)) {",
            "lineNumber": 650
          },
          {
            "text": "\t\t\t\tconst updated = {",
            "lineNumber": 651
          },
          {
            "text": "\t\t\t\t\t...(tn as CanvasTextData),",
            "lineNumber": 652
          },
          {
            "text": "\t\t\t\t\ttext: thinking,",
            "lineNumber": 653
          },
          {
            "text": "\t\t\t\t\twidth,",
            "lineNumber": 654
          },
          {
            "text": "\t\t\t\t\theight,",
            "lineNumber": 655
          },
          {
            "text": "\t\t\t\t\tcolor: thinkingColor,",
            "lineNumber": 656
          },
          {
            "text": "\t\t\t\t};",
            "lineNumber": 657
          },
          {
            "text": "\t\t\t\tconst idx = data.nodes.findIndex((n) =&gt; n.id === thinkingId);",
            "lineNumber": 658
          },
          {
            "text": "\t\t\t\tif (idx &gt;= 0) data.nodes[idx] = updated;",
            "lineNumber": 659
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 660
          },
          {
            "text": "\t\t\tconst hasEdge = data.edges.some(",
            "lineNumber": 661
          },
          {
            "text": "\t\t\t\t(e) =&gt; e.fromNode === sourceNode.id &amp;&amp; e.toNode === thinkingId &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_THINKING",
            "lineNumber": 662
          },
          {
            "text": "\t\t\t);",
            "lineNumber": 663
          },
          {
            "text": "\t\t\tif (!hasEdge) {",
            "lineNumber": 664
          },
          {
            "text": "\t\t\t\tdata.edges.push({",
            "lineNumber": 665
          },
          {
            "text": "\t\t\t\t\tid: randomId(),",
            "lineNumber": 666
          },
          {
            "text": "\t\t\t\t\tfromNode: sourceNode.id,",
            "lineNumber": 667
          },
          {
            "text": "\t\t\t\t\tfromSide: thinkingSide,",
            "lineNumber": 668
          },
          {
            "text": "\t\t\t\t\ttoNode: thinkingId,",
            "lineNumber": 669
          },
          {
            "text": "\t\t\t\t\ttoSide: thinkingSide === \"left\" ? \"right\" : thinkingSide === \"right\" ? \"left\" : thinkingSide === \"top\" ? \"bottom\" : \"top\",",
            "lineNumber": 670
          },
          {
            "text": "\t\t\t\t\tlabel: EDGE_LABEL_THINKING,",
            "lineNumber": 671
          },
          {
            "text": "\t\t\t\t});",
            "lineNumber": 672
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 673
          },
          {
            "text": "\t\t} else {",
            "lineNumber": 674
          },
          {
            "text": "\t\t\tconst newId = randomId();",
            "lineNumber": 675
          },
          {
            "text": "\t\t\tdata.nodes.push({",
            "lineNumber": 676
          },
          {
            "text": "\t\t\t\tid: newId,",
            "lineNumber": 677
          },
          {
            "text": "\t\t\t\ttype: \"text\",",
            "lineNumber": 678
          },
          {
            "text": "\t\t\t\ttext: thinking,",
            "lineNumber": 679
          },
          {
            "text": "\t\t\t\tx: tx,",
            "lineNumber": 680
          },
          {
            "text": "\t\t\t\ty: ty,",
            "lineNumber": 681
          },
          {
            "text": "\t\t\t\twidth,",
            "lineNumber": 682
          },
          {
            "text": "\t\t\t\theight,",
            "lineNumber": 683
          },
          {
            "text": "\t\t\t\tcolor: thinkingColor,",
            "lineNumber": 684
          },
          {
            "text": "\t\t\t} as CanvasTextData);",
            "lineNumber": 685
          },
          {
            "text": "\t\t\tdata.edges.push({",
            "lineNumber": 686
          },
          {
            "text": "\t\t\t\tid: randomId(),",
            "lineNumber": 687
          },
          {
            "text": "\t\t\t\tfromNode: sourceNode.id,",
            "lineNumber": 688
          },
          {
            "text": "\t\t\t\tfromSide: thinkingSide,",
            "lineNumber": 689
          },
          {
            "text": "\t\t\t\ttoNode: newId,",
            "lineNumber": 690
          },
          {
            "text": "\t\t\t\ttoSide: thinkingSide === \"left\" ? \"right\" : thinkingSide === \"right\" ? \"left\" : thinkingSide === \"top\" ? \"bottom\" : \"top\",",
            "lineNumber": 691
          },
          {
            "text": "\t\t\t\tlabel: EDGE_LABEL_THINKING,",
            "lineNumber": 692
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 693
          },
          {
            "text": "\t\t}",
            "lineNumber": 694
          },
          {
            "text": "\t}",
            "lineNumber": 695
          },
          {
            "lineNumber": 696
          },
          {
            "text": "\t// 3. Ensure prompt node (above thinking or output) when setting on and fullPrompt present",
            "lineNumber": 697
          },
          {
            "text": "}",
            "lineNumber": 766,
            "isSignature": true
          }
        ]
      },
      "score": 0.46714940667152405
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 324,
            "column": 93
          },
          "endPosition": {
            "line": 928,
            "column": 1
          }
        },
        "contents": "function resolveCanvasNodeId(node: unknown): string | undefined {\n\tif (!node || typeof node !== \"object\") return undefined;\n\tconst n = node as Record&lt;string, unknown&gt;;\n\tif (typeof n.id === \"string\") return n.id;\n\tconst inner = n.node as Record&lt;string, unknown&gt; | undefined;\n\tif (inner &amp;&amp; typeof inner.id === \"string\") return inner.id;\n\tconst data = typeof n.getData === \"function\" ? (n.getData as () =&gt; { id?: string })() : undefined;\n\treturn data?.id;\n}\n\n/** Debug: set to true when canvas:node-menu callback has fired at least once (proves event is received). */\nlet debugNodeMenuFired = false;\n\nexport default class ZettelThinkingBoardPlugin extends Plugin {\n\tsettings: ZettelPluginSettings;\n\n\tasync onload() {\n\t\ttry {\n\t\t\tawait this.loadSettings();\n\t\t\tthis.addSettingTab(new ZettelSettingTab(this.app, this));\n\n\t\t\tthis.registerView(\n\t\t\t\tZETTEL_CONTROLS_VIEW_TYPE,\n\t\t\t\t(leaf: WorkspaceLeaf) =&gt; new ZettelControlsView(leaf, this)\n\t\t\t);\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"open-zettel-controls\",\n\t\t\t\tname: \"Open Zettel Controls\",\n\t\t\t\tcallback: () =&gt; this.activateZettelControls(),\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"create-tutorial-canvas\",\n\t\t\t\tname: \"Create tutorial canvas\",\n\t\t\t\tcallback: () =&gt; this.createTutorialCanvas(),\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"duplicate-canvas-template\",\n\t\t\t\tname: \"Duplicate canvas template\",\n\t\t\t\tcallback: () =&gt; this.duplicateCanvasTemplate(),\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"save-canvas-as-template\",\n\t\t\t\tname: \"Save canvas as template\",\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\t\tif (!view) return false;\n\t\t\t\t\tif (checking) return true;\n\t\t\t\t\tthis.saveCanvasAsTemplate();\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"edit-canvas-template\",\n\t\t\t\tname: \"Edit canvas template\",\n\t\t\t\tcallback: () =&gt; this.editCanvasTemplate(),\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"run-node\",\n\t\t\t\tname: \"Run node\",\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\t}\n\n\t}\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "function resolveCanvasNodeId(node: unknown): string | undefined {",
            "lineNumber": 326,
            "isSignature": true
          },
          {
            "text": "\tif (!node || typeof node !== \"object\") return undefined;",
            "lineNumber": 327
          },
          {
            "text": "\tconst n = node as Record&lt;string, unknown&gt;;",
            "lineNumber": 328
          },
          {
            "text": "\tif (typeof n.id === \"string\") return n.id;",
            "lineNumber": 329
          },
          {
            "text": "\tconst inner = n.node as Record&lt;string, unknown&gt; | undefined;",
            "lineNumber": 330
          },
          {
            "text": "\tif (inner &amp;&amp; typeof inner.id === \"string\") return inner.id;",
            "lineNumber": 331
          },
          {
            "text": "\tconst data = typeof n.getData === \"function\" ? (n.getData as () =&gt; { id?: string })() : undefined;",
            "lineNumber": 332
          },
          {
            "text": "\treturn data?.id;",
            "lineNumber": 333
          },
          {
            "text": "}",
            "lineNumber": 334,
            "isSignature": true
          },
          {
            "lineNumber": 335
          },
          {
            "text": "/** Debug: set to true when canvas:node-menu callback has fired at least once (proves event is received). */",
            "lineNumber": 336
          },
          {
            "text": "let debugNodeMenuFired = false;",
            "lineNumber": 337
          },
          {
            "lineNumber": 338
          },
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 339,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings;",
            "lineNumber": 340
          },
          {
            "lineNumber": 341
          },
          {
            "text": "\tasync onload() {",
            "lineNumber": 342
          },
          {
            "text": "\t\ttry {",
            "lineNumber": 343
          },
          {
            "text": "\t\t\tawait this.loadSettings();",
            "lineNumber": 344
          },
          {
            "text": "\t\t\tthis.addSettingTab(new ZettelSettingTab(this.app, this));",
            "lineNumber": 345
          },
          {
            "lineNumber": 346
          },
          {
            "text": "\t\t\tthis.registerView(",
            "lineNumber": 347
          },
          {
            "text": "\t\t\t\tZETTEL_CONTROLS_VIEW_TYPE,",
            "lineNumber": 348
          },
          {
            "text": "\t\t\t\t(leaf: WorkspaceLeaf) =&gt; new ZettelControlsView(leaf, this)",
            "lineNumber": 349
          },
          {
            "text": "\t\t\t);",
            "lineNumber": 350
          },
          {
            "lineNumber": 351
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 352
          },
          {
            "text": "\t\t\t\tid: \"open-zettel-controls\",",
            "lineNumber": 353
          },
          {
            "text": "\t\t\t\tname: \"Open Zettel Controls\",",
            "lineNumber": 354
          },
          {
            "text": "\t\t\t\tcallback: () =&gt; this.activateZettelControls(),",
            "lineNumber": 355
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 356
          },
          {
            "lineNumber": 357
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 358
          },
          {
            "text": "\t\t\t\tid: \"create-tutorial-canvas\",",
            "lineNumber": 359
          },
          {
            "text": "\t\t\t\tname: \"Create tutorial canvas\",",
            "lineNumber": 360
          },
          {
            "text": "\t\t\t\tcallback: () =&gt; this.createTutorialCanvas(),",
            "lineNumber": 361
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 362
          },
          {
            "lineNumber": 363
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 364
          },
          {
            "text": "\t\t\t\tid: \"duplicate-canvas-template\",",
            "lineNumber": 365
          },
          {
            "text": "\t\t\t\tname: \"Duplicate canvas template\",",
            "lineNumber": 366
          },
          {
            "text": "\t\t\t\tcallback: () =&gt; this.duplicateCanvasTemplate(),",
            "lineNumber": 367
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 368
          },
          {
            "lineNumber": 369
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 370
          },
          {
            "text": "\t\t\t\tid: \"save-canvas-as-template\",",
            "lineNumber": 371
          },
          {
            "text": "\t\t\t\tname: \"Save canvas as template\",",
            "lineNumber": 372
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 373
          },
          {
            "text": "\t\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 374
          },
          {
            "text": "\t\t\t\t\tif (!view) return false;",
            "lineNumber": 375
          },
          {
            "text": "\t\t\t\t\tif (checking) return true;",
            "lineNumber": 376
          },
          {
            "text": "\t\t\t\t\tthis.saveCanvasAsTemplate();",
            "lineNumber": 377
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 378
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 379
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 380
          },
          {
            "lineNumber": 381
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 382
          },
          {
            "text": "\t\t\t\tid: \"edit-canvas-template\",",
            "lineNumber": 383
          },
          {
            "text": "\t\t\t\tname: \"Edit canvas template\",",
            "lineNumber": 384
          },
          {
            "text": "\t\t\t\tcallback: () =&gt; this.editCanvasTemplate(),",
            "lineNumber": 385
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 386
          },
          {
            "lineNumber": 387
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 388
          },
          {
            "text": "\t\t\t\tid: \"run-node\",",
            "lineNumber": 389
          },
          {
            "text": "\t\t\t\tname: \"Run node\",",
            "lineNumber": 390
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 391
          },
          {
            "text": "\t\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 392
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 398
          },
          {
            "lineNumber": 399
          },
          {
            "text": "\t}",
            "lineNumber": 604
          },
          {
            "text": "}",
            "lineNumber": 929,
            "isSignature": true
          }
        ]
      },
      "score": 0.38636279106140137
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 538,
            "column": 1
          },
          "endPosition": {
            "line": 765,
            "column": 1
          }
        },
        "contents": "/** Create or replace the Green output node (and optional prompt/thinking nodes) and ensure edges from source. Mutates data only. */\nfunction ensureOutputNodeAndEdge(\n\tdata: CanvasData,\n\tsourceNode: AllCanvasNodeData,\n\ttext: string,\n\tsettings: ZettelPluginSettings,\n\toptions: EnsureOutputOptions = {}\n): void {\n\tconst { fullPrompt, thinking } = options;\n\tconst promptId = findAuxiliaryNodeForSource(data, sourceNode.id, EDGE_LABEL_PROMPT);\n\tconst thinkingId = findAuxiliaryNodeForSource(data, sourceNode.id, EDGE_LABEL_THINKING);\n\tconst outId = findOutputNodeForSource(data, sourceNode.id, settings);\n\n\tconst defaultY = sourceNode.y + sourceNode.height + GREEN_NODE_PADDING;\n\tconst width = Math.max(320, sourceNode.width);\n\tconst height = 180;\n\tconst defaultX = sourceNode.x;\n\tconst extraExclude = [promptId, thinkingId].filter((id): id is string =&gt; id != null);\n\n\tconst { x: chosenX, y: chosenY } = chooseOutputPositionXY(\n\t\tdata,\n\t\tsourceNode.id,\n\t\toutId,\n\t\tdefaultX,\n\t\tdefaultY,\n\t\twidth,\n\t\theight,\n\t\textraExclude\n\t);\n\tconst greenColor = settings.colorGreen;\n\n\t// 1. Ensure output node\n\tlet resolvedOutputId: string;\n\tif (outId) {\n\t\tresolvedOutputId = outId;\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Create or replace the Green output node (and optional prompt/thinking nodes) and ensure edges from source. Mutates data only. */",
            "lineNumber": 541
          },
          {
            "text": "function ensureOutputNodeAndEdge(",
            "lineNumber": 542,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 543,
            "isSignature": true
          },
          {
            "text": "\tsourceNode: AllCanvasNodeData,",
            "lineNumber": 544,
            "isSignature": true
          },
          {
            "text": "\ttext: string,",
            "lineNumber": 545,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 546,
            "isSignature": true
          },
          {
            "text": "\toptions: EnsureOutputOptions = {}",
            "lineNumber": 547,
            "isSignature": true
          },
          {
            "text": "): void {",
            "lineNumber": 548,
            "isSignature": true
          },
          {
            "text": "\tconst { fullPrompt, thinking } = options;",
            "lineNumber": 549
          },
          {
            "text": "\tconst promptId = findAuxiliaryNodeForSource(data, sourceNode.id, EDGE_LABEL_PROMPT);",
            "lineNumber": 550
          },
          {
            "text": "\tconst thinkingId = findAuxiliaryNodeForSource(data, sourceNode.id, EDGE_LABEL_THINKING);",
            "lineNumber": 551
          },
          {
            "text": "\tconst outId = findOutputNodeForSource(data, sourceNode.id, settings);",
            "lineNumber": 552
          },
          {
            "lineNumber": 553
          },
          {
            "text": "\tconst defaultY = sourceNode.y + sourceNode.height + GREEN_NODE_PADDING;",
            "lineNumber": 554
          },
          {
            "text": "\tconst width = Math.max(320, sourceNode.width);",
            "lineNumber": 555
          },
          {
            "text": "\tconst height = 180;",
            "lineNumber": 556
          },
          {
            "text": "\tconst defaultX = sourceNode.x;",
            "lineNumber": 557
          },
          {
            "text": "\tconst extraExclude = [promptId, thinkingId].filter((id): id is string =&gt; id != null);",
            "lineNumber": 558
          },
          {
            "lineNumber": 559
          },
          {
            "text": "\tconst { x: chosenX, y: chosenY } = chooseOutputPositionXY(",
            "lineNumber": 560
          },
          {
            "text": "\t\tdata,",
            "lineNumber": 561
          },
          {
            "text": "\t\tsourceNode.id,",
            "lineNumber": 562
          },
          {
            "text": "\t\toutId,",
            "lineNumber": 563
          },
          {
            "text": "\t\tdefaultX,",
            "lineNumber": 564
          },
          {
            "text": "\t\tdefaultY,",
            "lineNumber": 565
          },
          {
            "text": "\t\twidth,",
            "lineNumber": 566
          },
          {
            "text": "\t\theight,",
            "lineNumber": 567
          },
          {
            "text": "\t\textraExclude",
            "lineNumber": 568
          },
          {
            "text": "\t);",
            "lineNumber": 569
          },
          {
            "text": "\tconst greenColor = settings.colorGreen;",
            "lineNumber": 570
          },
          {
            "lineNumber": 571
          },
          {
            "text": "\t// 1. Ensure output node",
            "lineNumber": 572
          },
          {
            "text": "\tlet resolvedOutputId: string;",
            "lineNumber": 573
          },
          {
            "text": "\tif (outId) {",
            "lineNumber": 574
          },
          {
            "text": "\t\tresolvedOutputId = outId;",
            "lineNumber": 575
          },
          {
            "text": "}",
            "lineNumber": 766,
            "isSignature": true
          }
        ]
      },
      "score": 0.37858688831329346
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 106
          },
          "endPosition": {
            "line": 322,
            "column": 1
          }
        },
        "contents": "function getTutorialCanvasData(settings: ZettelPluginSettings): CanvasData {\nconst groupCol5 = \n\n\t);\n\tconst groupCol6 = g(\n\t\t\"grp-col6\",\n\t\tcommentLeftX(col6) - TUT_GROUP_PAD,\n\t\ty6 - TUT_GROUP_PAD,\n\t\tTUT_COL_TOTAL_W + 2 * TUT_GROUP_PAD,\n\t\t145 + 2 * TUT_GROUP_PAD,\n\t\t\"Sidebar\"\n\t);\n\n\tconst nodes: CanvasData[\"nodes\"] = [\n\t\t// Groups first (render behind)\n\t\tgroupWelcome,\n\t\tgroupCol1,\n\t\tgroupCol2,\n\t\tgroupCol3,\n\t\tgroupCol4,\n\t\tgroupCol5,\n\t\tgroupCol6,\n\t\t// Welcome: plain text (no color = no role; not connected, does not add to prompt)\n\t\tn(welcome, \"Welcome to Zettel Thinking Board. Each column is a separate showcase. Nodes run top to bottom. Right-click a card → Run node or Run chain. Uncolored or unused-color cards are not connected to any node and do not add to the prompt.\", TUT_LEFT, welcomeY, \"\", TUT_WELCOME_W, 132),\n\n\t\t// Column 1: label = plain text; nodes in lane have roles\n\t\tn(lab1, \"Primary model: sends prompt to Ollama. Set the model in Zettel Controls.\", commentLeftX(col1), orangeY, \"\", TUT_COMMENT_W, TUT_LABEL_H),\n\t\tn(orangeNode, \"What is 2+2? Reply in one sentence.\", laneNodeX(col1, 0), orangeY, cOrange, TUT_NODE_LANE_W, TUT_NODE_H),\n\t\tn(orangeOut, \"\", laneNodeX(col1, LANE_OFFSET), orangeOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),\n\n\t\t// Column 2\n\t\tn\n,\n\t];\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 98,
                "column": 1
              },
              "endPosition": {
                "line": 99,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "function getTutorialCanvasData(settings: ZettelPluginSettings): CanvasData {",
            "lineNumber": 107,
            "isSignature": true
          },
          {
            "text": "const groupCol5 = ",
            "lineNumber": 251
          },
          {
            "lineNumber": 257
          },
          {
            "text": "\t);",
            "lineNumber": 258
          },
          {
            "text": "\tconst groupCol6 = g(",
            "lineNumber": 259
          },
          {
            "text": "\t\t\"grp-col6\",",
            "lineNumber": 260
          },
          {
            "text": "\t\tcommentLeftX(col6) - TUT_GROUP_PAD,",
            "lineNumber": 261
          },
          {
            "text": "\t\ty6 - TUT_GROUP_PAD,",
            "lineNumber": 262
          },
          {
            "text": "\t\tTUT_COL_TOTAL_W + 2 * TUT_GROUP_PAD,",
            "lineNumber": 263
          },
          {
            "text": "\t\t145 + 2 * TUT_GROUP_PAD,",
            "lineNumber": 264
          },
          {
            "text": "\t\t\"Sidebar\"",
            "lineNumber": 265
          },
          {
            "text": "\t);",
            "lineNumber": 266
          },
          {
            "lineNumber": 267
          },
          {
            "text": "\tconst nodes: CanvasData[\"nodes\"] = [",
            "lineNumber": 268
          },
          {
            "text": "\t\t// Groups first (render behind)",
            "lineNumber": 269
          },
          {
            "text": "\t\tgroupWelcome,",
            "lineNumber": 270
          },
          {
            "text": "\t\tgroupCol1,",
            "lineNumber": 271
          },
          {
            "text": "\t\tgroupCol2,",
            "lineNumber": 272
          },
          {
            "text": "\t\tgroupCol3,",
            "lineNumber": 273
          },
          {
            "text": "\t\tgroupCol4,",
            "lineNumber": 274
          },
          {
            "text": "\t\tgroupCol5,",
            "lineNumber": 275
          },
          {
            "text": "\t\tgroupCol6,",
            "lineNumber": 276
          },
          {
            "text": "\t\t// Welcome: plain text (no color = no role; not connected, does not add to prompt)",
            "lineNumber": 277
          },
          {
            "text": "\t\tn(welcome, \"Welcome to Zettel Thinking Board. Each column is a separate showcase. Nodes run top to bottom. Right-click a card → Run node or Run chain. Uncolored or unused-color cards are not connected to any node and do not add to the prompt.\", TUT_LEFT, welcomeY, \"\", TUT_WELCOME_W, 132),",
            "lineNumber": 278
          },
          {
            "lineNumber": 279
          },
          {
            "text": "\t\t// Column 1: label = plain text; nodes in lane have roles",
            "lineNumber": 280
          },
          {
            "text": "\t\tn(lab1, \"Primary model: sends prompt to Ollama. Set the model in Zettel Controls.\", commentLeftX(col1), orangeY, \"\", TUT_COMMENT_W, TUT_LABEL_H),",
            "lineNumber": 281
          },
          {
            "text": "\t\tn(orangeNode, \"What is 2+2? Reply in one sentence.\", laneNodeX(col1, 0), orangeY, cOrange, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 282
          },
          {
            "text": "\t\tn(orangeOut, \"\", laneNodeX(col1, LANE_OFFSET), orangeOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 283
          },
          {
            "lineNumber": 284
          },
          {
            "text": "\t\t// Column 2",
            "lineNumber": 285
          },
          {
            "text": "\t\tn",
            "lineNumber": 286
          },
          {
            "text": ",",
            "lineNumber": 309
          },
          {
            "text": "\t];",
            "lineNumber": 310
          },
          {
            "text": "}",
            "lineNumber": 323,
            "isSignature": true
          }
        ]
      },
      "score": 0.37365400791168213
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/settings.ts",
        "range": {
          "startPosition": {
            "line": 541
          },
          "endPosition": {
            "line": 941,
            "column": 1
          }
        },
        "contents": "export class ZettelSettingTab extends PluginSettingTab {\ndisplay(): void {\n\");\n\n\t\tnew Setting(displaySection)\n\t\t\t.setName(\"Show role labels on canvas\")\n\t\t\t.setDesc(\"Show a floating label above each node (e.g. Model: llama2, Text, Python) based on its color\")\n\t\t\t.addToggle((toggle) =&gt; toggle\n\t\t\t\t.setValue(s.showNodeRoleLabels)\n\t\t\t\t.onChange(async (value) =&gt; {\n\t\t\t\t\tthis.plugin.settings.showNodeRoleLabels = value;\n\t\t\t\t\tawait this.plugin.saveSettings();\n\t\t\t\t}));\n\n\t\taddColorSetting(\n\t\t\tdisplaySection,\n\t\t\tthis.plugin,\n\t\t\t\"blue\",\n\t\t\t\"Python node color\",\n\t\t\t\"Color for Python execution nodes on the canvas\",\n\t\t\twarningCallback\n\t\t);\n\t\taddColorSetting(\n\t\t\tdisplaySection,\n\t\t\tthis.plugin,\n\t\t\t\"yellow\",\n\t\t\t\"Text node color\",\n\t\t\t\"Color for text (input) nodes: pass-through text, no AI processing\",\n\t\t\twarningCallback\n\t\t);\n\t\taddColorSetting(\n\t\t\tdisplaySection,\n\t\t\tthis.plugin,\n\t\t\t\"green\",\n\t\t\t\"Output node color\",\n\t\t\t\"Color for auto-generated output nodes on the canvas\",\n\t\t\twarningCallback\n\t\t);\n\n\t\tnew Setting(displaySection)\n\t\t\t.setName(\"Show prompt in output\")\n\t\t\t.setDesc(\"When enabled, create a separate node above the output showing the full prompt sent to the model (in a lighter shade of the output color)\")\n\t\t\t.addToggle((toggle) =&gt; toggle\n\t\t\t\t.setValue(s.showPromptInOutput)\n\t\t\t\t.onChange(async (value) =&gt; {\n\t\t\t\t\tthis.plugin.settings.showPromptInOutput = value;\n\t\t\t\t\tawait this.plugin.saveSettings();\n\t\t\t\t}));\n\n\t\tnew Setting(displaySection)\n\t\t\t.setName(\"Show model thinking node\")\n\t\t\t.setDesc(\"When enabled and the model returns thinking (e.g. reasoning trace), create an extra node to display it\")\n\t\t\t.addToggle((toggle) =&gt; toggle\n\t\t\t\t.setValue(s.showThinkingNode)\n\t\t\t\t.onChange(async (value) =&gt; {\n\t\t\t\t\tthis.plugin.settings.showThinkingNode = value;\n\t\t\t\t\tawait this.plugin.saveSettings();\n\t\t\t\t}));\n\n\t\t// Canvas Templates section\n\t\tconst templatesSection = containerEl.createDiv({ cls: \"ztb-settings-section\" });\n\t\ttemplatesSection.createEl(\"h4\", { text: \"Canvas Templates\", cls: \"ztb-section-title\" });\n\t\tconst templatesHint = templatesSection.createDiv({ cls: \"ztb-settings-hint setting-item-description\" });\n\t\ttemplatesHint.setText(\"Define folders for canvas templates and where new canvases from templates should be created. Use the \n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 542,
                "column": 1
              },
              "endPosition": {
                "line": 542,
                "column": 8
              }
            },
            {
              "startPosition": {
                "line": 542,
                "column": 8
              },
              "endPosition": {
                "line": 543,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 550,
                "column": 2
              },
              "endPosition": {
                "line": 551,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export class ZettelSettingTab extends PluginSettingTab {",
            "lineNumber": 542,
            "isSignature": true
          },
          {
            "text": "display(): void {",
            "lineNumber": 550
          },
          {
            "text": "\");",
            "lineNumber": 622
          },
          {
            "lineNumber": 623
          },
          {
            "text": "\t\tnew Setting(displaySection)",
            "lineNumber": 624
          },
          {
            "text": "\t\t\t.setName(\"Show role labels on canvas\")",
            "lineNumber": 625
          },
          {
            "text": "\t\t\t.setDesc(\"Show a floating label above each node (e.g. Model: llama2, Text, Python) based on its color\")",
            "lineNumber": 626
          },
          {
            "text": "\t\t\t.addToggle((toggle) =&gt; toggle",
            "lineNumber": 627
          },
          {
            "text": "\t\t\t\t.setValue(s.showNodeRoleLabels)",
            "lineNumber": 628
          },
          {
            "text": "\t\t\t\t.onChange(async (value) =&gt; {",
            "lineNumber": 629
          },
          {
            "text": "\t\t\t\t\tthis.plugin.settings.showNodeRoleLabels = value;",
            "lineNumber": 630
          },
          {
            "text": "\t\t\t\t\tawait this.plugin.saveSettings();",
            "lineNumber": 631
          },
          {
            "text": "\t\t\t\t}));",
            "lineNumber": 632
          },
          {
            "lineNumber": 633
          },
          {
            "text": "\t\taddColorSetting(",
            "lineNumber": 634
          },
          {
            "text": "\t\t\tdisplaySection,",
            "lineNumber": 635
          },
          {
            "text": "\t\t\tthis.plugin,",
            "lineNumber": 636
          },
          {
            "text": "\t\t\t\"blue\",",
            "lineNumber": 637
          },
          {
            "text": "\t\t\t\"Python node color\",",
            "lineNumber": 638
          },
          {
            "text": "\t\t\t\"Color for Python execution nodes on the canvas\",",
            "lineNumber": 639
          },
          {
            "text": "\t\t\twarningCallback",
            "lineNumber": 640
          },
          {
            "text": "\t\t);",
            "lineNumber": 641
          },
          {
            "text": "\t\taddColorSetting(",
            "lineNumber": 642
          },
          {
            "text": "\t\t\tdisplaySection,",
            "lineNumber": 643
          },
          {
            "text": "\t\t\tthis.plugin,",
            "lineNumber": 644
          },
          {
            "text": "\t\t\t\"yellow\",",
            "lineNumber": 645
          },
          {
            "text": "\t\t\t\"Text node color\",",
            "lineNumber": 646
          },
          {
            "text": "\t\t\t\"Color for text (input) nodes: pass-through text, no AI processing\",",
            "lineNumber": 647
          },
          {
            "text": "\t\t\twarningCallback",
            "lineNumber": 648
          },
          {
            "text": "\t\t);",
            "lineNumber": 649
          },
          {
            "text": "\t\taddColorSetting(",
            "lineNumber": 650
          },
          {
            "text": "\t\t\tdisplaySection,",
            "lineNumber": 651
          },
          {
            "text": "\t\t\tthis.plugin,",
            "lineNumber": 652
          },
          {
            "text": "\t\t\t\"green\",",
            "lineNumber": 653
          },
          {
            "text": "\t\t\t\"Output node color\",",
            "lineNumber": 654
          },
          {
            "text": "\t\t\t\"Color for auto-generated output nodes on the canvas\",",
            "lineNumber": 655
          },
          {
            "text": "\t\t\twarningCallback",
            "lineNumber": 656
          },
          {
            "text": "\t\t);",
            "lineNumber": 657
          },
          {
            "lineNumber": 658
          },
          {
            "text": "\t\tnew Setting(displaySection)",
            "lineNumber": 659
          },
          {
            "text": "\t\t\t.setName(\"Show prompt in output\")",
            "lineNumber": 660
          },
          {
            "text": "\t\t\t.setDesc(\"When enabled, create a separate node above the output showing the full prompt sent to the model (in a lighter shade of the output color)\")",
            "lineNumber": 661
          },
          {
            "text": "\t\t\t.addToggle((toggle) =&gt; toggle",
            "lineNumber": 662
          },
          {
            "text": "\t\t\t\t.setValue(s.showPromptInOutput)",
            "lineNumber": 663
          },
          {
            "text": "\t\t\t\t.onChange(async (value) =&gt; {",
            "lineNumber": 664
          },
          {
            "text": "\t\t\t\t\tthis.plugin.settings.showPromptInOutput = value;",
            "lineNumber": 665
          },
          {
            "text": "\t\t\t\t\tawait this.plugin.saveSettings();",
            "lineNumber": 666
          },
          {
            "text": "\t\t\t\t}));",
            "lineNumber": 667
          },
          {
            "lineNumber": 668
          },
          {
            "text": "\t\tnew Setting(displaySection)",
            "lineNumber": 669
          },
          {
            "text": "\t\t\t.setName(\"Show model thinking node\")",
            "lineNumber": 670
          },
          {
            "text": "\t\t\t.setDesc(\"When enabled and the model returns thinking (e.g. reasoning trace), create an extra node to display it\")",
            "lineNumber": 671
          },
          {
            "text": "\t\t\t.addToggle((toggle) =&gt; toggle",
            "lineNumber": 672
          },
          {
            "text": "\t\t\t\t.setValue(s.showThinkingNode)",
            "lineNumber": 673
          },
          {
            "text": "\t\t\t\t.onChange(async (value) =&gt; {",
            "lineNumber": 674
          },
          {
            "text": "\t\t\t\t\tthis.plugin.settings.showThinkingNode = value;",
            "lineNumber": 675
          },
          {
            "text": "\t\t\t\t\tawait this.plugin.saveSettings();",
            "lineNumber": 676
          },
          {
            "text": "\t\t\t\t}));",
            "lineNumber": 677
          },
          {
            "lineNumber": 678
          },
          {
            "text": "\t\t// Canvas Templates section",
            "lineNumber": 679
          },
          {
            "text": "\t\tconst templatesSection = containerEl.createDiv({ cls: \"ztb-settings-section\" });",
            "lineNumber": 680
          },
          {
            "text": "\t\ttemplatesSection.createEl(\"h4\", { text: \"Canvas Templates\", cls: \"ztb-section-title\" });",
            "lineNumber": 681
          },
          {
            "text": "\t\tconst templatesHint = templatesSection.createDiv({ cls: \"ztb-settings-hint setting-item-description\" });",
            "lineNumber": 682
          },
          {
            "text": "\t\ttemplatesHint.setText(\"Define folders for canvas templates and where new canvases from templates should be created. Use the ",
            "lineNumber": 683
          },
          {
            "text": "\t}",
            "lineNumber": 706
          },
          {
            "text": "}",
            "lineNumber": 942,
            "isSignature": true
          }
        ]
      },
      "score": 0.3540278673171997
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "column": 76
          },
          "endPosition": {
            "line": 43,
            "column": 24
          }
        },
        "contents": " from \"obsidian\";\nimport {DEFAULT_SETTINGS, ZettelPluginSettings, ZettelSettingTab} from \"./settings\";\nimport {ZettelControlsView, ZETTEL_CONTROLS_VIEW_TYPE} from \"./views/ZettelControlsView\";\nimport {CanvasTemplateModal} from \"./views/CanvasTemplateModal\";\nimport {duplicateCanvasTemplate, saveCanvasAsTemplate, isCanvasInTemplateFolder} from \"./canvas/canvasTemplates\";\nimport {\n\tdismissAllOutput as runnerDismissAllOutput,\n\tdismissOutput as runnerDismissOutput,\n\trunChain as runnerRunChain,\n\trunEntireCanvas as runnerRunEntireCanvas,\n\trunNode as runnerRunNode,\n} from \"./engine/runner\";\nimport {\n\tclearCanvasEdgeModeLabels,\n\tclearCanvasLegend,\n\tclearCanvasRoleLabels,\n\tsyncCanvasEdgeModeLabels,\n\tsyncCanvasRoleLabels,\n} from \"./canvas/canvasNodeLabels\";\nimport {hasOutputNodes, loadCanvasData, saveCanvasData} from \"./canvas/nodes\";\nimport type {CanvasData} from \"./canvas/types\";\nimport {EDGE_LABEL_OUTPUT} from \"./canvas/types\";\nimport {getKernelForCanvas, terminateAllKernels, terminateKernel} from \"./engine/kernelManager\";\nimport {\n\tclearRunQueue,\n\tdequeueRun,\n\tenqueueRun,\n\tgetCanvasKey,\n\tgetRunInProgress,\n\tsetRunInProgress,\n\ttype RunQueueJob,\n} from \"./engine/state\";\nimport {getExample1CanvasData} from \"./tutorials/example1Data\";\nimport {getExample4CanvasData} from \"./tutorials/example4Data\";\n\n/** Layout constants: comment margins left/right, central lane for nodes, no overlap. */\nconst TUT_LEFT = 80;\nconst TUT_TOP = 50;\nconst TUT_WELCOME_W = 420;\nconst TUT_WELCOME_H = 118;\nconst TUT_WELCOME_BOTTOM_GAP = 70;\n/** Per-column: left comment margin | node lane | right comment margin. */\nconst TUT_COMMENT_W = 185;\nconst TUT_LANE_GAP = 22;",
        "signatures": {},
        "detailedLines": [
          {
            "text": " from \"obsidian\";",
            "lineNumber": 1
          },
          {
            "text": "import {DEFAULT_SETTINGS, ZettelPluginSettings, ZettelSettingTab} from \"./settings\";",
            "lineNumber": 2
          },
          {
            "text": "import {ZettelControlsView, ZETTEL_CONTROLS_VIEW_TYPE} from \"./views/ZettelControlsView\";",
            "lineNumber": 3
          },
          {
            "text": "import {CanvasTemplateModal} from \"./views/CanvasTemplateModal\";",
            "lineNumber": 4
          },
          {
            "text": "import {duplicateCanvasTemplate, saveCanvasAsTemplate, isCanvasInTemplateFolder} from \"./canvas/canvasTemplates\";",
            "lineNumber": 5
          },
          {
            "text": "import {",
            "lineNumber": 6
          },
          {
            "text": "\tdismissAllOutput as runnerDismissAllOutput,",
            "lineNumber": 7
          },
          {
            "text": "\tdismissOutput as runnerDismissOutput,",
            "lineNumber": 8
          },
          {
            "text": "\trunChain as runnerRunChain,",
            "lineNumber": 9
          },
          {
            "text": "\trunEntireCanvas as runnerRunEntireCanvas,",
            "lineNumber": 10
          },
          {
            "text": "\trunNode as runnerRunNode,",
            "lineNumber": 11
          },
          {
            "text": "} from \"./engine/runner\";",
            "lineNumber": 12
          },
          {
            "text": "import {",
            "lineNumber": 13
          },
          {
            "text": "\tclearCanvasEdgeModeLabels,",
            "lineNumber": 14
          },
          {
            "text": "\tclearCanvasLegend,",
            "lineNumber": 15
          },
          {
            "text": "\tclearCanvasRoleLabels,",
            "lineNumber": 16
          },
          {
            "text": "\tsyncCanvasEdgeModeLabels,",
            "lineNumber": 17
          },
          {
            "text": "\tsyncCanvasRoleLabels,",
            "lineNumber": 18
          },
          {
            "text": "} from \"./canvas/canvasNodeLabels\";",
            "lineNumber": 19
          },
          {
            "text": "import {hasOutputNodes, loadCanvasData, saveCanvasData} from \"./canvas/nodes\";",
            "lineNumber": 20
          },
          {
            "text": "import type {CanvasData} from \"./canvas/types\";",
            "lineNumber": 21
          },
          {
            "text": "import {EDGE_LABEL_OUTPUT} from \"./canvas/types\";",
            "lineNumber": 22
          },
          {
            "text": "import {getKernelForCanvas, terminateAllKernels, terminateKernel} from \"./engine/kernelManager\";",
            "lineNumber": 23
          },
          {
            "text": "import {",
            "lineNumber": 24
          },
          {
            "text": "\tclearRunQueue,",
            "lineNumber": 25
          },
          {
            "text": "\tdequeueRun,",
            "lineNumber": 26
          },
          {
            "text": "\tenqueueRun,",
            "lineNumber": 27
          },
          {
            "text": "\tgetCanvasKey,",
            "lineNumber": 28
          },
          {
            "text": "\tgetRunInProgress,",
            "lineNumber": 29
          },
          {
            "text": "\tsetRunInProgress,",
            "lineNumber": 30
          },
          {
            "text": "\ttype RunQueueJob,",
            "lineNumber": 31
          },
          {
            "text": "} from \"./engine/state\";",
            "lineNumber": 32
          },
          {
            "text": "import {getExample1CanvasData} from \"./tutorials/example1Data\";",
            "lineNumber": 33
          },
          {
            "text": "import {getExample4CanvasData} from \"./tutorials/example4Data\";",
            "lineNumber": 34
          },
          {
            "lineNumber": 35
          },
          {
            "text": "/** Layout constants: comment margins left/right, central lane for nodes, no overlap. */",
            "lineNumber": 36
          },
          {
            "text": "const TUT_LEFT = 80;",
            "lineNumber": 37
          },
          {
            "text": "const TUT_TOP = 50;",
            "lineNumber": 38
          },
          {
            "text": "const TUT_WELCOME_W = 420;",
            "lineNumber": 39
          },
          {
            "text": "const TUT_WELCOME_H = 118;",
            "lineNumber": 40
          },
          {
            "text": "const TUT_WELCOME_BOTTOM_GAP = 70;",
            "lineNumber": 41
          },
          {
            "text": "/** Per-column: left comment margin | node lane | right comment margin. */",
            "lineNumber": 42
          },
          {
            "text": "const TUT_COMMENT_W = 185;",
            "lineNumber": 43
          },
          {
            "text": "const TUT_LANE_GAP = 22;",
            "lineNumber": 44
          }
        ]
      },
      "score": 0.3264724910259247
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 541
          },
          "endPosition": {
            "line": 765,
            "column": 1
          }
        },
        "contents": "function ensureOutputNodeAndEdge(\n\tdata: CanvasData,\n\tsourceNode: AllCanvasNodeData,\n\ttext: string,\n\tsettings: ZettelPluginSettings,\n\toptions: EnsureOutputOptions = {}\n): void {\n\n\n\t// 3. Ensure prompt node (above thinking or output) when setting on and fullPrompt present\n\tif (settings.showPromptInOutput &amp;&amp; fullPrompt != null &amp;&amp; fullPrompt.length &gt; 0) {\n\t\tconst promptSide = chooseFreeSideForAuxiliaryEdge(data, sourceNode.id);\n\t\tconst thinkingNodeId = settings.showThinkingNode &amp;&amp; thinking ? findAuxiliaryNodeForSource(data, sourceNode.id, EDGE_LABEL_THINKING) : null;\n\t\tconst anchorNode = thinkingNodeId ? getNodeById(data, thinkingNodeId) : outputNode;\n\t\tconst anchorY = anchorNode &amp;&amp; \"y\" in anchorNode ? (anchorNode as { y: number }).y : outputY;\n\t\tconst promptDefaultY = anchorY - height - GREEN_NODE_PADDING;\n\t\tconst promptExclude = [sourceNode.id, resolvedOutputId, thinkingId, promptId].filter((id): id is string =&gt; id != null);\n\t\tconst { x: px, y: py } = chooseOutputPositionXY(\n\t\t\tdata,\n\t\t\tsourceNode.id,\n\t\t\tpromptId,\n\t\t\tdefaultX,\n\t\t\tpromptDefaultY,\n\t\t\twidth,\n\t\t\theight,\n\t\t\tpromptExclude\n\t\t);\n\t\tconst promptColor = shadeColor(settings.colorGreen, 0.25);\n\t\tconst promptToSide = promptSide === \"left\" ? \"right\" : promptSide === \"right\" ? \"left\" : promptSide === \"top\" ? \"bottom\" : \"top\";\n\n\t\tif (promptId)\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 542,
                "column": 1
              },
              "endPosition": {
                "line": 549,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "function ensureOutputNodeAndEdge(",
            "lineNumber": 542,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 543,
            "isSignature": true
          },
          {
            "text": "\tsourceNode: AllCanvasNodeData,",
            "lineNumber": 544,
            "isSignature": true
          },
          {
            "text": "\ttext: string,",
            "lineNumber": 545,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 546,
            "isSignature": true
          },
          {
            "text": "\toptions: EnsureOutputOptions = {}",
            "lineNumber": 547,
            "isSignature": true
          },
          {
            "text": "): void {",
            "lineNumber": 548,
            "isSignature": true
          },
          {
            "lineNumber": 695
          },
          {
            "lineNumber": 696
          },
          {
            "text": "\t// 3. Ensure prompt node (above thinking or output) when setting on and fullPrompt present",
            "lineNumber": 697
          },
          {
            "text": "\tif (settings.showPromptInOutput &amp;&amp; fullPrompt != null &amp;&amp; fullPrompt.length &gt; 0) {",
            "lineNumber": 698
          },
          {
            "text": "\t\tconst promptSide = chooseFreeSideForAuxiliaryEdge(data, sourceNode.id);",
            "lineNumber": 699
          },
          {
            "text": "\t\tconst thinkingNodeId = settings.showThinkingNode &amp;&amp; thinking ? findAuxiliaryNodeForSource(data, sourceNode.id, EDGE_LABEL_THINKING) : null;",
            "lineNumber": 700
          },
          {
            "text": "\t\tconst anchorNode = thinkingNodeId ? getNodeById(data, thinkingNodeId) : outputNode;",
            "lineNumber": 701
          },
          {
            "text": "\t\tconst anchorY = anchorNode &amp;&amp; \"y\" in anchorNode ? (anchorNode as { y: number }).y : outputY;",
            "lineNumber": 702
          },
          {
            "text": "\t\tconst promptDefaultY = anchorY - height - GREEN_NODE_PADDING;",
            "lineNumber": 703
          },
          {
            "text": "\t\tconst promptExclude = [sourceNode.id, resolvedOutputId, thinkingId, promptId].filter((id): id is string =&gt; id != null);",
            "lineNumber": 704
          },
          {
            "text": "\t\tconst { x: px, y: py } = chooseOutputPositionXY(",
            "lineNumber": 705
          },
          {
            "text": "\t\t\tdata,",
            "lineNumber": 706
          },
          {
            "text": "\t\t\tsourceNode.id,",
            "lineNumber": 707
          },
          {
            "text": "\t\t\tpromptId,",
            "lineNumber": 708
          },
          {
            "text": "\t\t\tdefaultX,",
            "lineNumber": 709
          },
          {
            "text": "\t\t\tpromptDefaultY,",
            "lineNumber": 710
          },
          {
            "text": "\t\t\twidth,",
            "lineNumber": 711
          },
          {
            "text": "\t\t\theight,",
            "lineNumber": 712
          },
          {
            "text": "\t\t\tpromptExclude",
            "lineNumber": 713
          },
          {
            "text": "\t\t);",
            "lineNumber": 714
          },
          {
            "text": "\t\tconst promptColor = shadeColor(settings.colorGreen, 0.25);",
            "lineNumber": 715
          },
          {
            "text": "\t\tconst promptToSide = promptSide === \"left\" ? \"right\" : promptSide === \"right\" ? \"left\" : promptSide === \"top\" ? \"bottom\" : \"top\";",
            "lineNumber": 716
          },
          {
            "lineNumber": 717
          },
          {
            "text": "\t\tif (promptId)",
            "lineNumber": 718
          },
          {
            "text": "}",
            "lineNumber": 766,
            "isSignature": true
          }
        ]
      },
      "score": 0.31044793128967285
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 338
          },
          "endPosition": {
            "line": 928,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\nasync onload() {\nconst runSyncLabels = \n\n\t\t\t\t\tthis.clearTemplateBanner(roleLabelsContainerEl);\n\t\t\t\t}\n\t\t\t\troleLabelsContainerEl = view.containerEl;\n\t\t\t\t// Show template banner if this canvas is in the template folder\n\t\t\t\tthis.syncTemplateBanner(view.containerEl, view.file.path);\n\t\t\t\t// Add \"Run entire canvas\" and \"Dismiss all output\" to the canvas (title bar if supported, else toolbar in container).\n\t\t\t\t// Use a property on the view so we only add once even after plugin hot-reload (WeakSet would be cleared on reload).\n\t\t\t\tconst leaf = this.app.workspace.activeLeaf;\n\t\t\t\tlet addedToTitleBar = false;\n\t\t\t\ttype ViewWithFlag = ItemView &amp; { addAction?: (icon: string, title: string, callback: (evt: MouseEvent) =&gt; void) =&gt; HTMLElement; _ztbTitleBarActionsAdded?: boolean };\n\t\t\t\tif (leaf?.view) {\n\t\t\t\t\tconst itemView = leaf.view as ViewWithFlag;\n\t\t\t\t\tif (itemView._ztbTitleBarActionsAdded) {\n\t\t\t\t\t\taddedToTitleBar = true;\n\t\t\t\t\t} else if (typeof itemView.addAction === \"function\") {\n\t\t\t\t\t\titemView.addAction(\"play\", \"Run entire canvas\", () =&gt; this.runEntireCanvas());\n\t\t\t\t\t\titemView.addAction(\"trash\", \"Dismiss all output\", () =&gt; this.dismissAllOutput());\n\t\t\t\t\t\titemView._ztbTitleBarActionsAdded = true;\n\t\t\t\t\t\taddedToTitleBar = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (!addedToTitleBar) this.addCanvasToolbarToContainer(view.containerEl);\n\t\t\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;\n\t\t\t\tconst isStillActive = (): boolean =&gt; this.getActiveCanvasView()?.containerEl === roleLabelsContainerEl;\n\t\t\t\tsyncCanvasRoleLabels(this.app.vault, view.file.path, view.containerEl, this.settings, liveCanvas, isStillActive);\n\t\t\t\tsyncCanvasEdgeModeLabels(this.app.vault, view.file.path, view.containerEl, liveCanvas, isStillActive);\n\t\t\t\tif (roleLabelsIntervalId == null) {\n\t\t\t\t\troleLabelsIntervalId = window.setInterval(() =&gt; {\n\t\t\t\t\t\tconst v = this.getActiveCanvasView();\n\t\t\t\t\t\tif (v != null &amp;&amp; v.containerEl === roleLabelsContainerEl) {\n\t\t\t\t\t\t\tconst stillActive = (): boolean =&gt; this.getActiveCanvasView()?.containerEl === roleLabelsContainerEl;\n\t\t\t\t\t\t\tsyncCanvasRoleLabels(this.app.vault, v.file.path, v.containerEl, this.settings, v.canvas as import(\"./engine/canvasApi\").LiveCanvas, stillActive);\n\t\t\t\t\t\t\tsyncCanvasEdgeModeLabels(this.app.vault, v.file.path, v.containerEl, v.canvas as import(\"./engine/canvasApi\").LiveCanvas, stillActive);\n\t\t\t\t\t\t}\n\t\t\t\t\t}, 2000);\n\t\t\t\t\t(this as unknown as { _roleLabelsIntervalId: number })._roleLabelsIntervalId = roleLabelsIntervalId;\n\t\t\t\t}\n\t\t\t};\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 330,
                "column": 1
              },
              "endPosition": {
                "line": 330,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 330,
                "column": 16
              },
              "endPosition": {
                "line": 331,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 333,
                "column": 2
              },
              "endPosition": {
                "line": 334,
                "column": 3
              }
            },
            {
              "startPosition": {
                "line": 528,
                "column": 4
              },
              "endPosition": {
                "line": 528,
                "column": 10
              }
            },
            {
              "startPosition": {
                "line": 528,
                "column": 10
              },
              "endPosition": {
                "line": 528,
                "column": 26
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 339,
            "isSignature": true
          },
          {
            "text": "async onload() {",
            "lineNumber": 342
          },
          {
            "text": "const runSyncLabels = ",
            "lineNumber": 537
          },
          {
            "lineNumber": 559
          },
          {
            "text": "\t\t\t\t\tthis.clearTemplateBanner(roleLabelsContainerEl);",
            "lineNumber": 560
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 561
          },
          {
            "text": "\t\t\t\troleLabelsContainerEl = view.containerEl;",
            "lineNumber": 562
          },
          {
            "text": "\t\t\t\t// Show template banner if this canvas is in the template folder",
            "lineNumber": 563
          },
          {
            "text": "\t\t\t\tthis.syncTemplateBanner(view.containerEl, view.file.path);",
            "lineNumber": 564
          },
          {
            "text": "\t\t\t\t// Add \"Run entire canvas\" and \"Dismiss all output\" to the canvas (title bar if supported, else toolbar in container).",
            "lineNumber": 565
          },
          {
            "text": "\t\t\t\t// Use a property on the view so we only add once even after plugin hot-reload (WeakSet would be cleared on reload).",
            "lineNumber": 566
          },
          {
            "text": "\t\t\t\tconst leaf = this.app.workspace.activeLeaf;",
            "lineNumber": 567
          },
          {
            "text": "\t\t\t\tlet addedToTitleBar = false;",
            "lineNumber": 568
          },
          {
            "text": "\t\t\t\ttype ViewWithFlag = ItemView &amp; { addAction?: (icon: string, title: string, callback: (evt: MouseEvent) =&gt; void) =&gt; HTMLElement; _ztbTitleBarActionsAdded?: boolean };",
            "lineNumber": 569
          },
          {
            "text": "\t\t\t\tif (leaf?.view) {",
            "lineNumber": 570
          },
          {
            "text": "\t\t\t\t\tconst itemView = leaf.view as ViewWithFlag;",
            "lineNumber": 571
          },
          {
            "text": "\t\t\t\t\tif (itemView._ztbTitleBarActionsAdded) {",
            "lineNumber": 572
          },
          {
            "text": "\t\t\t\t\t\taddedToTitleBar = true;",
            "lineNumber": 573
          },
          {
            "text": "\t\t\t\t\t} else if (typeof itemView.addAction === \"function\") {",
            "lineNumber": 574
          },
          {
            "text": "\t\t\t\t\t\titemView.addAction(\"play\", \"Run entire canvas\", () =&gt; this.runEntireCanvas());",
            "lineNumber": 575
          },
          {
            "text": "\t\t\t\t\t\titemView.addAction(\"trash\", \"Dismiss all output\", () =&gt; this.dismissAllOutput());",
            "lineNumber": 576
          },
          {
            "text": "\t\t\t\t\t\titemView._ztbTitleBarActionsAdded = true;",
            "lineNumber": 577
          },
          {
            "text": "\t\t\t\t\t\taddedToTitleBar = true;",
            "lineNumber": 578
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 579
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 580
          },
          {
            "text": "\t\t\t\tif (!addedToTitleBar) this.addCanvasToolbarToContainer(view.containerEl);",
            "lineNumber": 581
          },
          {
            "text": "\t\t\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;",
            "lineNumber": 582
          },
          {
            "text": "\t\t\t\tconst isStillActive = (): boolean =&gt; this.getActiveCanvasView()?.containerEl === roleLabelsContainerEl;",
            "lineNumber": 583
          },
          {
            "text": "\t\t\t\tsyncCanvasRoleLabels(this.app.vault, view.file.path, view.containerEl, this.settings, liveCanvas, isStillActive);",
            "lineNumber": 584
          },
          {
            "text": "\t\t\t\tsyncCanvasEdgeModeLabels(this.app.vault, view.file.path, view.containerEl, liveCanvas, isStillActive);",
            "lineNumber": 585
          },
          {
            "text": "\t\t\t\tif (roleLabelsIntervalId == null) {",
            "lineNumber": 586
          },
          {
            "text": "\t\t\t\t\troleLabelsIntervalId = window.setInterval(() =&gt; {",
            "lineNumber": 587
          },
          {
            "text": "\t\t\t\t\t\tconst v = this.getActiveCanvasView();",
            "lineNumber": 588
          },
          {
            "text": "\t\t\t\t\t\tif (v != null &amp;&amp; v.containerEl === roleLabelsContainerEl) {",
            "lineNumber": 589
          },
          {
            "text": "\t\t\t\t\t\t\tconst stillActive = (): boolean =&gt; this.getActiveCanvasView()?.containerEl === roleLabelsContainerEl;",
            "lineNumber": 590
          },
          {
            "text": "\t\t\t\t\t\t\tsyncCanvasRoleLabels(this.app.vault, v.file.path, v.containerEl, this.settings, v.canvas as import(\"./engine/canvasApi\").LiveCanvas, stillActive);",
            "lineNumber": 591
          },
          {
            "text": "\t\t\t\t\t\t\tsyncCanvasEdgeModeLabels(this.app.vault, v.file.path, v.containerEl, v.canvas as import(\"./engine/canvasApi\").LiveCanvas, stillActive);",
            "lineNumber": 592
          },
          {
            "text": "\t\t\t\t\t\t}",
            "lineNumber": 593
          },
          {
            "text": "\t\t\t\t\t}, 2000);",
            "lineNumber": 594
          },
          {
            "text": "\t\t\t\t\t(this as unknown as { _roleLabelsIntervalId: number })._roleLabelsIntervalId = roleLabelsIntervalId;",
            "lineNumber": 595
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 596
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 597
          },
          {
            "text": "\t}",
            "lineNumber": 604
          },
          {
            "text": "}",
            "lineNumber": 929,
            "isSignature": true
          }
        ]
      },
      "score": 0.3070226013660431
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 338
          },
          "endPosition": {
            "line": 928,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\nasync onload() {\nconst addNodeMenuItems = \n((item) =&gt;\n\t\t\t\t\titem.setTitle(\"Run node\").setIcon(\"play\").onClick(() =&gt; this.runNode(nodeId))\n\t\t\t\t);\n\t\t\t\tmenu.addItem((item) =&gt;\n\t\t\t\t\titem.setTitle(\"Run chain\").setIcon(\"forward\").onClick(() =&gt; this.runChain(nodeId))\n\t\t\t\t);\n\t\t\t\tmenu.addItem((item) =&gt;\n\t\t\t\t\titem.setTitle(\"Dismiss output\").setIcon(\"trash\").onClick(() =&gt; this.dismissOutput(nodeId))\n\t\t\t\t);\n\t\t\t};\n\t\t\tconst registerCanvasNodeMenu = () =&gt; {\n\t\t\t\ttry {\n\t\t\t\t\tconst on = this.app.workspace.on.bind(this.app.workspace) as (\n\t\t\t\t\t\tname: string,\n\t\t\t\t\t\tcallback: (menu: Menu, node: unknown) =&gt; void\n\t\t\t\t\t) =&gt; ReturnType&lt;typeof this.app.workspace.on&gt;;\n\t\t\t\t\t// Try documented-style event name first; some Obsidian builds use \"canvas:node-menu\".\n\t\t\t\t\tthis.registerEvent(on(\"canvas:node-menu\", addNodeMenuItems));\n\t\t\t\t\t// Fallback: try hyphenated name in case the app triggers a different event.\n\t\t\t\t\tthis.registerEvent(on(\"canvas-node-menu\", addNodeMenuItems));\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconsole.error(\"Zettel Thinking Board: could not register canvas node menu.\", e);\n\t\t\t\t}\n\t\t\t};\n\t\t\tconst timeoutId = window.setTimeout(registerCanvasNodeMenu, 0);\n\t\t\tthis.register(() =&gt; window.clearTimeout(timeoutId));\n\n\t\t\t// Canvas background context menu: use undocumented \"canvas:edge-menu\" (Obsidian broadcasts it;\n\t\t\t// when right-click is on empty area, edge is null). Same pattern as canvas:node-menu: addItem with setTitle, setIcon, onClick.\n\t\t\tconst addCanvasMenuItems = (menu: Menu): void =&gt; {\n\t\t\t\tmenu.addItem((item) =&gt;\n\t\t\t\t\titem.setTitle(\"Run entire canvas\").setIcon(\"play\").onClick(() =&gt; this.runEntireCanvas())\n\t\t\t\t);\n\t\t\t\tmenu.addItem((item) =&gt;\n\t\t\t\t\titem.setTitle(\"Dismiss all output\").setIcon(\"trash\").onClick(() =&gt; this.dismissAllOutput())\n\t\t\t\t);\n\t\t\t};\n\t\t\ttry {\n\t\t\t\tconst onWorkspace = this.app.workspace.on.bind(this.app.workspace) as (\n\t\t\t\t\tname: string,\n\t\t\t\t\tcallback: (menu: Menu, edge: unknown) =&gt; void\n\t\t\t\t) =&gt; ReturnType&lt;typeof this.app.workspace.on&gt;;\n\t\t\t\tthis.registerEvent(\n\t\t\t\t\tonWorkspace\n\n\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 330,
                "column": 1
              },
              "endPosition": {
                "line": 330,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 330,
                "column": 16
              },
              "endPosition": {
                "line": 331,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 333,
                "column": 2
              },
              "endPosition": {
                "line": 334,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 339,
            "isSignature": true
          },
          {
            "text": "async onload() {",
            "lineNumber": 342
          },
          {
            "text": "const addNodeMenuItems = ",
            "lineNumber": 427
          },
          {
            "text": "((item) =&gt;",
            "lineNumber": 431
          },
          {
            "text": "\t\t\t\t\titem.setTitle(\"Run node\").setIcon(\"play\").onClick(() =&gt; this.runNode(nodeId))",
            "lineNumber": 432
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 433
          },
          {
            "text": "\t\t\t\tmenu.addItem((item) =&gt;",
            "lineNumber": 434
          },
          {
            "text": "\t\t\t\t\titem.setTitle(\"Run chain\").setIcon(\"forward\").onClick(() =&gt; this.runChain(nodeId))",
            "lineNumber": 435
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 436
          },
          {
            "text": "\t\t\t\tmenu.addItem((item) =&gt;",
            "lineNumber": 437
          },
          {
            "text": "\t\t\t\t\titem.setTitle(\"Dismiss output\").setIcon(\"trash\").onClick(() =&gt; this.dismissOutput(nodeId))",
            "lineNumber": 438
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 439
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 440
          },
          {
            "text": "\t\t\tconst registerCanvasNodeMenu = () =&gt; {",
            "lineNumber": 441
          },
          {
            "text": "\t\t\t\ttry {",
            "lineNumber": 442
          },
          {
            "text": "\t\t\t\t\tconst on = this.app.workspace.on.bind(this.app.workspace) as (",
            "lineNumber": 443
          },
          {
            "text": "\t\t\t\t\t\tname: string,",
            "lineNumber": 444
          },
          {
            "text": "\t\t\t\t\t\tcallback: (menu: Menu, node: unknown) =&gt; void",
            "lineNumber": 445
          },
          {
            "text": "\t\t\t\t\t) =&gt; ReturnType&lt;typeof this.app.workspace.on&gt;;",
            "lineNumber": 446
          },
          {
            "text": "\t\t\t\t\t// Try documented-style event name first; some Obsidian builds use \"canvas:node-menu\".",
            "lineNumber": 447
          },
          {
            "text": "\t\t\t\t\tthis.registerEvent(on(\"canvas:node-menu\", addNodeMenuItems));",
            "lineNumber": 448
          },
          {
            "text": "\t\t\t\t\t// Fallback: try hyphenated name in case the app triggers a different event.",
            "lineNumber": 449
          },
          {
            "text": "\t\t\t\t\tthis.registerEvent(on(\"canvas-node-menu\", addNodeMenuItems));",
            "lineNumber": 450
          },
          {
            "text": "\t\t\t\t} catch (e) {",
            "lineNumber": 451
          },
          {
            "text": "\t\t\t\t\tconsole.error(\"Zettel Thinking Board: could not register canvas node menu.\", e);",
            "lineNumber": 452
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 453
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 454
          },
          {
            "text": "\t\t\tconst timeoutId = window.setTimeout(registerCanvasNodeMenu, 0);",
            "lineNumber": 455
          },
          {
            "text": "\t\t\tthis.register(() =&gt; window.clearTimeout(timeoutId));",
            "lineNumber": 456
          },
          {
            "lineNumber": 457
          },
          {
            "text": "\t\t\t// Canvas background context menu: use undocumented \"canvas:edge-menu\" (Obsidian broadcasts it;",
            "lineNumber": 458
          },
          {
            "text": "\t\t\t// when right-click is on empty area, edge is null). Same pattern as canvas:node-menu: addItem with setTitle, setIcon, onClick.",
            "lineNumber": 459
          },
          {
            "text": "\t\t\tconst addCanvasMenuItems = (menu: Menu): void =&gt; {",
            "lineNumber": 460
          },
          {
            "text": "\t\t\t\tmenu.addItem((item) =&gt;",
            "lineNumber": 461
          },
          {
            "text": "\t\t\t\t\titem.setTitle(\"Run entire canvas\").setIcon(\"play\").onClick(() =&gt; this.runEntireCanvas())",
            "lineNumber": 462
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 463
          },
          {
            "text": "\t\t\t\tmenu.addItem((item) =&gt;",
            "lineNumber": 464
          },
          {
            "text": "\t\t\t\t\titem.setTitle(\"Dismiss all output\").setIcon(\"trash\").onClick(() =&gt; this.dismissAllOutput())",
            "lineNumber": 465
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 466
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 467
          },
          {
            "text": "\t\t\ttry {",
            "lineNumber": 468
          },
          {
            "text": "\t\t\t\tconst onWorkspace = this.app.workspace.on.bind(this.app.workspace) as (",
            "lineNumber": 469
          },
          {
            "text": "\t\t\t\t\tname: string,",
            "lineNumber": 470
          },
          {
            "text": "\t\t\t\t\tcallback: (menu: Menu, edge: unknown) =&gt; void",
            "lineNumber": 471
          },
          {
            "text": "\t\t\t\t) =&gt; ReturnType&lt;typeof this.app.workspace.on&gt;;",
            "lineNumber": 472
          },
          {
            "text": "\t\t\t\tthis.registerEvent(",
            "lineNumber": 473
          },
          {
            "text": "\t\t\t\t\tonWorkspace",
            "lineNumber": 474
          },
          {
            "lineNumber": 476
          },
          {
            "lineNumber": 477
          },
          {
            "text": "\t}",
            "lineNumber": 604
          },
          {
            "text": "}",
            "lineNumber": 929,
            "isSignature": true
          }
        ]
      },
      "score": 0.2989600896835327
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 78
          },
          "endPosition": {
            "line": 322,
            "column": 1
          }
        },
        "contents": "function getCombinedTutorialCanvasData(settings: ZettelPluginSettings): CanvasData {\nconst wf23Edges = (edge, i) =&gt; (\n\n\t}));\n\t// Apply color settings to workflow 1 as well\n\tconst wf1NodesWithColors = wf1.nodes.map((node) =&gt; ({\n\t\t...node,\n\t\tcolor: applyColorSettings(node.color, settings),\n\t}));\n\treturn {\n\t\tnodes: [...wf1NodesWithColors, ...wf23Nodes],\n\t\tedges: [...wf1.edges, ...wf23Edges],\n\t};\n}\n\n/** Build tutorial canvas: columns with comment margins, node lane center, edges, groups. */\nfunction getTutorialCanvasData(settings: ZettelPluginSettings): CanvasData {\n\tconst cOrange = tutorialColor(settings, \"colorOrange\");\n\tconst cPurple = tutorialColor(settings, \"colorPurple\");\n\tconst cBlue = tutorialColor(settings, \"colorBlue\");\n\tconst cYellow = tutorialColor(settings, \"colorYellow\");\n\tconst cGreen = tutorialColor(settings, \"colorGreen\");\n\n\t/** Plain text node (no role): use for labels/instructions so they are not treated as comment nodes. */\n\tconst n = (id: string, text: string, x: number, y: number, color: string, w: number, h: number) =&gt;\n\t\t({ id, type: \"text\" as const, text, x, y, width: w, height: h, color });\n\tconst e = (id: string, from: string, to: string, label?: string) =&gt; ({\n\t\tid,\n\t\tfromNode: from,\n\t\ttoNode: to,\n\t\tfromSide: \"bottom\" as const,\n\t\ttoSide: \"top\" as const,\n\t\tlabel: label ?? \"\",\n\t});\n\t/** Group node to visually separate a workflow block. */\n\tconst g = (id: string, x: number, y: number, w: number, h: number, label: string) =&gt;\n\t\t({ id, type: \"group\" as const, x, y, width: w, height: h, label });\n\n\t/** Column 1..6: x of left comment margin (column 1 starts right after welcome). */\n\tconst colLeft = (index: number) =&gt;\n\t\tTUT_LEFT + TUT_WELCOME_W + TUT_COL_GAP + (index - 1) * (TUT_COL_TOTAL_W + TUT_COL_GAP);\n\tconst commentLeftX = (colIndex: number) =&gt; colLeft(colIndex);\n\t/** Node lane: center x; offsetPx shifts right so alternating nodes make arrows more visible. */\n\tconst laneNodeX = (colIndex: number, offsetPx: number = 0) =&gt;\n\t\tcolLeft(colIndex) + TUT_COMMENT_W + TUT_LANE_GAP + offsetPx;\n\tconst commentRightX = (colIndex: number) =&gt;\n\t\tcolLeft(colIndex) + TUT_COMMENT_W + TUT_LANE_GAP + TUT_NODE_LANE_W + TUT_LANE_GAP;\n\tconst LANE_OFFSET = 36;\n\n\t// —— Welcome: alone in first block, no overlap with column 1 ——\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "function getCombinedTutorialCanvasData(settings: ZettelPluginSettings): CanvasData {",
            "lineNumber": 79,
            "isSignature": true
          },
          {
            "text": "const wf23Edges = (edge, i) =&gt; (",
            "lineNumber": 88
          },
          {
            "lineNumber": 93
          },
          {
            "text": "\t}));",
            "lineNumber": 94
          },
          {
            "text": "\t// Apply color settings to workflow 1 as well",
            "lineNumber": 95
          },
          {
            "text": "\tconst wf1NodesWithColors = wf1.nodes.map((node) =&gt; ({",
            "lineNumber": 96
          },
          {
            "text": "\t\t...node,",
            "lineNumber": 97
          },
          {
            "text": "\t\tcolor: applyColorSettings(node.color, settings),",
            "lineNumber": 98
          },
          {
            "text": "\t}));",
            "lineNumber": 99
          },
          {
            "text": "\treturn {",
            "lineNumber": 100
          },
          {
            "text": "\t\tnodes: [...wf1NodesWithColors, ...wf23Nodes],",
            "lineNumber": 101
          },
          {
            "text": "\t\tedges: [...wf1.edges, ...wf23Edges],",
            "lineNumber": 102
          },
          {
            "text": "\t};",
            "lineNumber": 103
          },
          {
            "text": "}",
            "lineNumber": 104,
            "isSignature": true
          },
          {
            "lineNumber": 105
          },
          {
            "text": "/** Build tutorial canvas: columns with comment margins, node lane center, edges, groups. */",
            "lineNumber": 106
          },
          {
            "text": "function getTutorialCanvasData(settings: ZettelPluginSettings): CanvasData {",
            "lineNumber": 107,
            "isSignature": true
          },
          {
            "text": "\tconst cOrange = tutorialColor(settings, \"colorOrange\");",
            "lineNumber": 108
          },
          {
            "text": "\tconst cPurple = tutorialColor(settings, \"colorPurple\");",
            "lineNumber": 109
          },
          {
            "text": "\tconst cBlue = tutorialColor(settings, \"colorBlue\");",
            "lineNumber": 110
          },
          {
            "text": "\tconst cYellow = tutorialColor(settings, \"colorYellow\");",
            "lineNumber": 111
          },
          {
            "text": "\tconst cGreen = tutorialColor(settings, \"colorGreen\");",
            "lineNumber": 112
          },
          {
            "lineNumber": 113
          },
          {
            "text": "\t/** Plain text node (no role): use for labels/instructions so they are not treated as comment nodes. */",
            "lineNumber": 114
          },
          {
            "text": "\tconst n = (id: string, text: string, x: number, y: number, color: string, w: number, h: number) =&gt;",
            "lineNumber": 115
          },
          {
            "text": "\t\t({ id, type: \"text\" as const, text, x, y, width: w, height: h, color });",
            "lineNumber": 116
          },
          {
            "text": "\tconst e = (id: string, from: string, to: string, label?: string) =&gt; ({",
            "lineNumber": 117
          },
          {
            "text": "\t\tid,",
            "lineNumber": 118
          },
          {
            "text": "\t\tfromNode: from,",
            "lineNumber": 119
          },
          {
            "text": "\t\ttoNode: to,",
            "lineNumber": 120
          },
          {
            "text": "\t\tfromSide: \"bottom\" as const,",
            "lineNumber": 121
          },
          {
            "text": "\t\ttoSide: \"top\" as const,",
            "lineNumber": 122
          },
          {
            "text": "\t\tlabel: label ?? \"\",",
            "lineNumber": 123
          },
          {
            "text": "\t});",
            "lineNumber": 124
          },
          {
            "text": "\t/** Group node to visually separate a workflow block. */",
            "lineNumber": 125
          },
          {
            "text": "\tconst g = (id: string, x: number, y: number, w: number, h: number, label: string) =&gt;",
            "lineNumber": 126
          },
          {
            "text": "\t\t({ id, type: \"group\" as const, x, y, width: w, height: h, label });",
            "lineNumber": 127
          },
          {
            "lineNumber": 128
          },
          {
            "text": "\t/** Column 1..6: x of left comment margin (column 1 starts right after welcome). */",
            "lineNumber": 129
          },
          {
            "text": "\tconst colLeft = (index: number) =&gt;",
            "lineNumber": 130
          },
          {
            "text": "\t\tTUT_LEFT + TUT_WELCOME_W + TUT_COL_GAP + (index - 1) * (TUT_COL_TOTAL_W + TUT_COL_GAP);",
            "lineNumber": 131
          },
          {
            "text": "\tconst commentLeftX = (colIndex: number) =&gt; colLeft(colIndex);",
            "lineNumber": 132
          },
          {
            "text": "\t/** Node lane: center x; offsetPx shifts right so alternating nodes make arrows more visible. */",
            "lineNumber": 133
          },
          {
            "text": "\tconst laneNodeX = (colIndex: number, offsetPx: number = 0) =&gt;",
            "lineNumber": 134
          },
          {
            "text": "\t\tcolLeft(colIndex) + TUT_COMMENT_W + TUT_LANE_GAP + offsetPx;",
            "lineNumber": 135
          },
          {
            "text": "\tconst commentRightX = (colIndex: number) =&gt;",
            "lineNumber": 136
          },
          {
            "text": "\t\tcolLeft(colIndex) + TUT_COMMENT_W + TUT_LANE_GAP + TUT_NODE_LANE_W + TUT_LANE_GAP;",
            "lineNumber": 137
          },
          {
            "text": "\tconst LANE_OFFSET = 36;",
            "lineNumber": 138
          },
          {
            "lineNumber": 139
          },
          {
            "text": "\t// —— Welcome: alone in first block, no overlap with column 1 ——",
            "lineNumber": 140
          },
          {
            "text": "}",
            "lineNumber": 323,
            "isSignature": true
          }
        ]
      },
      "score": 0.28519999980926514
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 338
          },
          "endPosition": {
            "line": 928,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\nasync activateZettelControls(): Promise&lt;void&gt; {\n {\n\t\t\tworkspace.revealLeaf(existing);\n\t\t\treturn;\n\t\t}\n\t\tconst leaf = workspace.getRightLeaf(false);\n\t\tif (leaf != null) {\n\t\t\tawait leaf.setViewState({ type: ZETTEL_CONTROLS_VIEW_TYPE });\n\t\t\tworkspace.revealLeaf(leaf);\n\t\t}\n\t}\n\n\t/** Create a new tutorial canvas file in the vault and open it. */\n\tasync createTutorialCanvas(): Promise&lt;void&gt; {\n\t\tconst {vault, workspace} = this.app;\n\t\tconst baseName = \"Tutorial canvas\";\n\t\tlet n = 0;\n\t\tlet path = normalizePath(&#96;${baseName}.canvas&#96;);\n\t\twhile (vault.getAbstractFileByPath(path) != null) {\n\t\t\tn += 1;\n\t\t\tpath = normalizePath(&#96;${baseName} ${n}.canvas&#96;);\n\t\t}\n\t\tconst data = getCombinedTutorialCanvasData(this.settings);\n\t\tconst saved = await saveCanvasData(vault, path, data);\n\t\tif (!saved) {\n\t\t\tnew Notice(\"Could not create tutorial canvas.\");\n\t\t\treturn;\n\t\t}\n\t\tconst file = vault.getAbstractFileByPath(path);\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 330,
                "column": 1
              },
              "endPosition": {
                "line": 330,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 330,
                "column": 16
              },
              "endPosition": {
                "line": 331,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 339,
            "isSignature": true
          },
          {
            "text": "async activateZettelControls(): Promise&lt;void&gt; {",
            "lineNumber": 624
          },
          {
            "text": " {",
            "lineNumber": 628
          },
          {
            "text": "\t\t\tworkspace.revealLeaf(existing);",
            "lineNumber": 629
          },
          {
            "text": "\t\t\treturn;",
            "lineNumber": 630
          },
          {
            "text": "\t\t}",
            "lineNumber": 631
          },
          {
            "text": "\t\tconst leaf = workspace.getRightLeaf(false);",
            "lineNumber": 632
          },
          {
            "text": "\t\tif (leaf != null) {",
            "lineNumber": 633
          },
          {
            "text": "\t\t\tawait leaf.setViewState({ type: ZETTEL_CONTROLS_VIEW_TYPE });",
            "lineNumber": 634
          },
          {
            "text": "\t\t\tworkspace.revealLeaf(leaf);",
            "lineNumber": 635
          },
          {
            "text": "\t\t}",
            "lineNumber": 636
          },
          {
            "text": "\t}",
            "lineNumber": 637
          },
          {
            "lineNumber": 638
          },
          {
            "text": "\t/** Create a new tutorial canvas file in the vault and open it. */",
            "lineNumber": 639
          },
          {
            "text": "\tasync createTutorialCanvas(): Promise&lt;void&gt; {",
            "lineNumber": 640
          },
          {
            "text": "\t\tconst {vault, workspace} = this.app;",
            "lineNumber": 641
          },
          {
            "text": "\t\tconst baseName = \"Tutorial canvas\";",
            "lineNumber": 642
          },
          {
            "text": "\t\tlet n = 0;",
            "lineNumber": 643
          },
          {
            "text": "\t\tlet path = normalizePath(&#96;${baseName}.canvas&#96;);",
            "lineNumber": 644
          },
          {
            "text": "\t\twhile (vault.getAbstractFileByPath(path) != null) {",
            "lineNumber": 645
          },
          {
            "text": "\t\t\tn += 1;",
            "lineNumber": 646
          },
          {
            "text": "\t\t\tpath = normalizePath(&#96;${baseName} ${n}.canvas&#96;);",
            "lineNumber": 647
          },
          {
            "text": "\t\t}",
            "lineNumber": 648
          },
          {
            "text": "\t\tconst data = getCombinedTutorialCanvasData(this.settings);",
            "lineNumber": 649
          },
          {
            "text": "\t\tconst saved = await saveCanvasData(vault, path, data);",
            "lineNumber": 650
          },
          {
            "text": "\t\tif (!saved) {",
            "lineNumber": 651
          },
          {
            "text": "\t\t\tnew Notice(\"Could not create tutorial canvas.\");",
            "lineNumber": 652
          },
          {
            "text": "\t\t\treturn;",
            "lineNumber": 653
          },
          {
            "text": "\t\t}",
            "lineNumber": 654
          },
          {
            "text": "\t\tconst file = vault.getAbstractFileByPath(path);",
            "lineNumber": 655
          },
          {
            "text": "\t}",
            "lineNumber": 662
          },
          {
            "text": "}",
            "lineNumber": 929,
            "isSignature": true
          }
        ]
      },
      "score": 0.2815566956996918
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 338
          },
          "endPosition": {
            "line": 928,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\nasync onload() {\n\n\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\t\tif (!view) return false;\n\t\t\t\t\tif (checking) return true;\n\t\t\t\t\t// Command palette: no node selected; prompt user to use context menu\n\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Run node\\\" to run it.\");\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"run-chain\",\n\t\t\t\tname: \"Run chain\",\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\t\tif (!view) return false;\n\t\t\t\t\tif (checking) return true;\n\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Run chain\\\" to run from roots.\");\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"dismiss-output\",\n\t\t\t\tname: \"Dismiss output\",\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\t\tif (!view) return false;\n\t\t\t\t\tif (checking) return true;\n\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Dismiss output\\\" to remove its output.\");\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\t// Canvas node context menu (event name is undocumented; try workspace.on(\"canvas:node-menu\")).\n\t\t\t// Defer registration so Obsidian canvas is ready (avoids \"reading '_'\" in app.js).\n\t\t\tconst addNodeMenuItems = (menu: Menu, node: unknown): void =&gt; {\n\t\t\t\tdebugNodeMenuFired = true;\n\t\t\t\tconst nodeId = resolveCanvasNodeId(node);\n\t\t\t\tif (!nodeId) return;\n\t\t\t\tmenu.addItem((item) =&gt;\n\t\t\t\t\titem.setTitle(\"Run node\").setIcon(\"play\").onClick(() =&gt; this.runNode(nodeId))\n\t\t\t\t);\n\t\t\t\tmenu.addItem\n\n;\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 330,
                "column": 1
              },
              "endPosition": {
                "line": 330,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 330,
                "column": 16
              },
              "endPosition": {
                "line": 331,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 333,
                "column": 2
              },
              "endPosition": {
                "line": 334,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 339,
            "isSignature": true
          },
          {
            "text": "async onload() {",
            "lineNumber": 342
          },
          {
            "lineNumber": 388
          },
          {
            "lineNumber": 390
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 391
          },
          {
            "text": "\t\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 392
          },
          {
            "text": "\t\t\t\t\tif (!view) return false;",
            "lineNumber": 393
          },
          {
            "text": "\t\t\t\t\tif (checking) return true;",
            "lineNumber": 394
          },
          {
            "text": "\t\t\t\t\t// Command palette: no node selected; prompt user to use context menu",
            "lineNumber": 395
          },
          {
            "text": "\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Run node\\\" to run it.\");",
            "lineNumber": 396
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 397
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 398
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 399
          },
          {
            "lineNumber": 400
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 401
          },
          {
            "text": "\t\t\t\tid: \"run-chain\",",
            "lineNumber": 402
          },
          {
            "text": "\t\t\t\tname: \"Run chain\",",
            "lineNumber": 403
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 404
          },
          {
            "text": "\t\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 405
          },
          {
            "text": "\t\t\t\t\tif (!view) return false;",
            "lineNumber": 406
          },
          {
            "text": "\t\t\t\t\tif (checking) return true;",
            "lineNumber": 407
          },
          {
            "text": "\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Run chain\\\" to run from roots.\");",
            "lineNumber": 408
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 409
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 410
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 411
          },
          {
            "lineNumber": 412
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 413
          },
          {
            "text": "\t\t\t\tid: \"dismiss-output\",",
            "lineNumber": 414
          },
          {
            "text": "\t\t\t\tname: \"Dismiss output\",",
            "lineNumber": 415
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 416
          },
          {
            "text": "\t\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 417
          },
          {
            "text": "\t\t\t\t\tif (!view) return false;",
            "lineNumber": 418
          },
          {
            "text": "\t\t\t\t\tif (checking) return true;",
            "lineNumber": 419
          },
          {
            "text": "\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Dismiss output\\\" to remove its output.\");",
            "lineNumber": 420
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 421
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 422
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 423
          },
          {
            "lineNumber": 424
          },
          {
            "text": "\t\t\t// Canvas node context menu (event name is undocumented; try workspace.on(\"canvas:node-menu\")).",
            "lineNumber": 425
          },
          {
            "text": "\t\t\t// Defer registration so Obsidian canvas is ready (avoids \"reading '_'\" in app.js).",
            "lineNumber": 426
          },
          {
            "text": "\t\t\tconst addNodeMenuItems = (menu: Menu, node: unknown): void =&gt; {",
            "lineNumber": 427
          },
          {
            "text": "\t\t\t\tdebugNodeMenuFired = true;",
            "lineNumber": 428
          },
          {
            "text": "\t\t\t\tconst nodeId = resolveCanvasNodeId(node);",
            "lineNumber": 429
          },
          {
            "text": "\t\t\t\tif (!nodeId) return;",
            "lineNumber": 430
          },
          {
            "text": "\t\t\t\tmenu.addItem((item) =&gt;",
            "lineNumber": 431
          },
          {
            "text": "\t\t\t\t\titem.setTitle(\"Run node\").setIcon(\"play\").onClick(() =&gt; this.runNode(nodeId))",
            "lineNumber": 432
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 433
          },
          {
            "text": "\t\t\t\tmenu.addItem",
            "lineNumber": 434
          },
          {
            "lineNumber": 436
          },
          {
            "text": ";",
            "lineNumber": 440
          },
          {
            "text": "\t}",
            "lineNumber": 604
          },
          {
            "text": "}",
            "lineNumber": 929,
            "isSignature": true
          }
        ]
      },
      "score": 0.27472376823425293
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 106
          },
          "endPosition": {
            "line": 322,
            "column": 1
          }
        },
        "contents": "function getTutorialCanvasData(settings: ZettelPluginSettings): CanvasData {\nconst commentRightX = \n\t\tcolLeft(colIndex) + TUT_COMMENT_W + TUT_LANE_GAP + TUT_NODE_LANE_W + TUT_LANE_GAP;\n\tconst LANE_OFFSET = 36;\n\n\t// —— Welcome: alone in first block, no overlap with column 1 ——\n\tconst welcome = \"welcome\";\n\tconst welcomeY = TUT_TOP;\n\n\t// —— Column 1: Primary (comment left, node → output in lane) ——\n\tconst col1 = 1;\n\tconst lab1 = \"lab-primary\";\n\tconst orangeNode = \"orange-example\";\n\tconst orangeOut = \"orange-out\";\n\tlet y1 = TUT_TOP + TUT_WELCOME_H + TUT_WELCOME_BOTTOM_GAP;\n\tconst orangeY = y1;\n\ty1 += TUT_NODE_H + TUT_NODE_GAP;\n\tconst orangeOutY = y1;\n\n\t// —— Column 2: Purple, Yellow, Blue (comments in margins, nodes in lane) ——\n\tconst col2 = 2;\n\tconst lab2a = \"lab-purple\";\n\tconst purpleNode = \"purple-example\";\n\tconst purpleOut = \"purple-out\";\n\tconst lab2b = \"lab-yellow\";\n\tconst yellowNode = \"yellow-example\";\n\tconst lab2c = \"lab-blue\";\n\tconst blueNode = \"blue-example\";\n\tconst blueOut = \"blue-out\";\n\tlet y2 = TUT_TOP + TUT_WELCOME_H + TUT_WELCOME_BOTTOM_GAP;\n\tconst purpleY = y2;\n\ty2 += TUT_NODE_H + TUT_NODE_GAP;\n\tconst purpleOutY = y2;\n\ty2 += TUT_NODE_H + TUT_NODE_GAP + 20;\n\tconst yellowY = y2;\n\ty2 += TUT_NODE_H + TUT_NODE_GAP + 20;\n\tconst blueY = y2;\n\ty2 += TUT_NODE_H + TUT_NODE_GAP;\n\tconst blueOutY = y2;\n\n\t// —— Column 3: Concatenation ——\n\tconst col3 = 3;\n\tconst lab3 = \"lab-concat\";\n\tconst concatComment = \"concat-comment\";\n\tconst concatOrange = \"concat-orange\";\n\tconst concatOut = \"concat-out\";\n\tlet y3 = TUT_TOP + TUT_WELCOME_H + TUT_WELCOME_BOTTOM_GAP;\n\tconst concatCommentY = y3;\n\ty3 += TUT_NODE_H + TUT_NODE_GAP;\n\tconst concatOrangeY = y3;\n\ty3 += TUT_NODE_H + TUT_NODE_GAP;\n\tconst concatOutY = y3;\n\n\t// —— Column 4: Variable injection ——\n\tconst col4 = 4;\n\tconst lab4 = \"lab-inject\";\n\tconst injectFirst = \"inject-first\";\n\tconst injectSecond = \"inject-second\";\n\tconst injectOut = \"inject-out\";\n\tlet y4 = TUT_TOP + TUT_WELCOME_H + TUT_WELCOME_BOTTOM_GAP;\n\tconst injectFirstY = y4;\n\ty4 += TUT_NODE_H + TUT_NODE_GAP;\n\tconst injectSecondY = y4;\n\ty4 += TUT_NODE_H + TUT_NODE_GAP;\n\tconst injectOutY = y4;\n\n\t// —— Column 5 &amp; 6: Comments only (left margin + optional right), no nodes in lane ——\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 98,
                "column": 1
              },
              "endPosition": {
                "line": 99,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "function getTutorialCanvasData(settings: ZettelPluginSettings): CanvasData {",
            "lineNumber": 107,
            "isSignature": true
          },
          {
            "text": "const commentRightX = ",
            "lineNumber": 136
          },
          {
            "text": "\t\tcolLeft(colIndex) + TUT_COMMENT_W + TUT_LANE_GAP + TUT_NODE_LANE_W + TUT_LANE_GAP;",
            "lineNumber": 137
          },
          {
            "text": "\tconst LANE_OFFSET = 36;",
            "lineNumber": 138
          },
          {
            "lineNumber": 139
          },
          {
            "text": "\t// —— Welcome: alone in first block, no overlap with column 1 ——",
            "lineNumber": 140
          },
          {
            "text": "\tconst welcome = \"welcome\";",
            "lineNumber": 141
          },
          {
            "text": "\tconst welcomeY = TUT_TOP;",
            "lineNumber": 142
          },
          {
            "lineNumber": 143
          },
          {
            "text": "\t// —— Column 1: Primary (comment left, node → output in lane) ——",
            "lineNumber": 144
          },
          {
            "text": "\tconst col1 = 1;",
            "lineNumber": 145
          },
          {
            "text": "\tconst lab1 = \"lab-primary\";",
            "lineNumber": 146
          },
          {
            "text": "\tconst orangeNode = \"orange-example\";",
            "lineNumber": 147
          },
          {
            "text": "\tconst orangeOut = \"orange-out\";",
            "lineNumber": 148
          },
          {
            "text": "\tlet y1 = TUT_TOP + TUT_WELCOME_H + TUT_WELCOME_BOTTOM_GAP;",
            "lineNumber": 149
          },
          {
            "text": "\tconst orangeY = y1;",
            "lineNumber": 150
          },
          {
            "text": "\ty1 += TUT_NODE_H + TUT_NODE_GAP;",
            "lineNumber": 151
          },
          {
            "text": "\tconst orangeOutY = y1;",
            "lineNumber": 152
          },
          {
            "lineNumber": 153
          },
          {
            "text": "\t// —— Column 2: Purple, Yellow, Blue (comments in margins, nodes in lane) ——",
            "lineNumber": 154
          },
          {
            "text": "\tconst col2 = 2;",
            "lineNumber": 155
          },
          {
            "text": "\tconst lab2a = \"lab-purple\";",
            "lineNumber": 156
          },
          {
            "text": "\tconst purpleNode = \"purple-example\";",
            "lineNumber": 157
          },
          {
            "text": "\tconst purpleOut = \"purple-out\";",
            "lineNumber": 158
          },
          {
            "text": "\tconst lab2b = \"lab-yellow\";",
            "lineNumber": 159
          },
          {
            "text": "\tconst yellowNode = \"yellow-example\";",
            "lineNumber": 160
          },
          {
            "text": "\tconst lab2c = \"lab-blue\";",
            "lineNumber": 161
          },
          {
            "text": "\tconst blueNode = \"blue-example\";",
            "lineNumber": 162
          },
          {
            "text": "\tconst blueOut = \"blue-out\";",
            "lineNumber": 163
          },
          {
            "text": "\tlet y2 = TUT_TOP + TUT_WELCOME_H + TUT_WELCOME_BOTTOM_GAP;",
            "lineNumber": 164
          },
          {
            "text": "\tconst purpleY = y2;",
            "lineNumber": 165
          },
          {
            "text": "\ty2 += TUT_NODE_H + TUT_NODE_GAP;",
            "lineNumber": 166
          },
          {
            "text": "\tconst purpleOutY = y2;",
            "lineNumber": 167
          },
          {
            "text": "\ty2 += TUT_NODE_H + TUT_NODE_GAP + 20;",
            "lineNumber": 168
          },
          {
            "text": "\tconst yellowY = y2;",
            "lineNumber": 169
          },
          {
            "text": "\ty2 += TUT_NODE_H + TUT_NODE_GAP + 20;",
            "lineNumber": 170
          },
          {
            "text": "\tconst blueY = y2;",
            "lineNumber": 171
          },
          {
            "text": "\ty2 += TUT_NODE_H + TUT_NODE_GAP;",
            "lineNumber": 172
          },
          {
            "text": "\tconst blueOutY = y2;",
            "lineNumber": 173
          },
          {
            "lineNumber": 174
          },
          {
            "text": "\t// —— Column 3: Concatenation ——",
            "lineNumber": 175
          },
          {
            "text": "\tconst col3 = 3;",
            "lineNumber": 176
          },
          {
            "text": "\tconst lab3 = \"lab-concat\";",
            "lineNumber": 177
          },
          {
            "text": "\tconst concatComment = \"concat-comment\";",
            "lineNumber": 178
          },
          {
            "text": "\tconst concatOrange = \"concat-orange\";",
            "lineNumber": 179
          },
          {
            "text": "\tconst concatOut = \"concat-out\";",
            "lineNumber": 180
          },
          {
            "text": "\tlet y3 = TUT_TOP + TUT_WELCOME_H + TUT_WELCOME_BOTTOM_GAP;",
            "lineNumber": 181
          },
          {
            "text": "\tconst concatCommentY = y3;",
            "lineNumber": 182
          },
          {
            "text": "\ty3 += TUT_NODE_H + TUT_NODE_GAP;",
            "lineNumber": 183
          },
          {
            "text": "\tconst concatOrangeY = y3;",
            "lineNumber": 184
          },
          {
            "text": "\ty3 += TUT_NODE_H + TUT_NODE_GAP;",
            "lineNumber": 185
          },
          {
            "text": "\tconst concatOutY = y3;",
            "lineNumber": 186
          },
          {
            "lineNumber": 187
          },
          {
            "text": "\t// —— Column 4: Variable injection ——",
            "lineNumber": 188
          },
          {
            "text": "\tconst col4 = 4;",
            "lineNumber": 189
          },
          {
            "text": "\tconst lab4 = \"lab-inject\";",
            "lineNumber": 190
          },
          {
            "text": "\tconst injectFirst = \"inject-first\";",
            "lineNumber": 191
          },
          {
            "text": "\tconst injectSecond = \"inject-second\";",
            "lineNumber": 192
          },
          {
            "text": "\tconst injectOut = \"inject-out\";",
            "lineNumber": 193
          },
          {
            "text": "\tlet y4 = TUT_TOP + TUT_WELCOME_H + TUT_WELCOME_BOTTOM_GAP;",
            "lineNumber": 194
          },
          {
            "text": "\tconst injectFirstY = y4;",
            "lineNumber": 195
          },
          {
            "text": "\ty4 += TUT_NODE_H + TUT_NODE_GAP;",
            "lineNumber": 196
          },
          {
            "text": "\tconst injectSecondY = y4;",
            "lineNumber": 197
          },
          {
            "text": "\ty4 += TUT_NODE_H + TUT_NODE_GAP;",
            "lineNumber": 198
          },
          {
            "text": "\tconst injectOutY = y4;",
            "lineNumber": 199
          },
          {
            "lineNumber": 200
          },
          {
            "text": "\t// —— Column 5 &amp; 6: Comments only (left margin + optional right), no nodes in lane ——",
            "lineNumber": 201
          },
          {
            "text": "}",
            "lineNumber": 323,
            "isSignature": true
          }
        ]
      },
      "score": 0.27183473110198975
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 313,
            "column": 1
          },
          "endPosition": {
            "line": 434,
            "column": 1
          }
        },
        "contents": "/** Run a single node: get input + parent context (concatenate or {{var:name}}), call LLM or Python, store result. */\nasync function runSingleNode(\n\tapp: App,\n\tsettings: ZettelPluginSettings,\n\tcanvasKey: string,\n\tcanvasFilePath: string,\n\tdata: CanvasData,\n\tnodeId: string,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;string&gt; {\n\tconst node = getNodeById(data, nodeId);\n\tif (!node) return \"\";\n\tconst role = getNodeRole(node, settings);\n\tif (!role || role === \"yellow\" || role === \"green\") {\n\t\t// Yellow = text (input pass-through): merge parent results with own content, same as AI/Python nodes\n\t\tif (role === \"yellow\") {\n\t\t\tconst incoming = getIncomingEdgesWithLabels(nodeId, data);\n\t\t\tconst nodeInput = await getNodeContent(node, app.vault);\n\t\t\tconst { concatenatedPart, template } = buildInputWithVariables(\n\t\t\t\tcanvasKey,\n\t\t\t\tnodeInput,\n\t\t\t\tincoming\n\t\t\t);\n\t\t\tconst fullContent =\n\t\t\t\tconcatenatedPart.length &gt; 0 ? &#96;${concatenatedPart}\\n\\n---\\n\\n${template}&#96; : template;\n\t\t\tsetNodeResult(canvasKey, nodeId, fullContent);\n\t\t\treturn fullContent;\n\t\t}\n\t\treturn \"\";\n\t}\n\t// For Python (blue) text nodes, auto-wrap content in &#96;&#96;&#96;python ... &#96;&#96;&#96; so # comments render correctly\n\tif (role === \"blue\" &amp;&amp; isTextNode(node)) {\n\t\tconst raw = getTextNodeContent(node as CanvasTextData);\n\t\tif (!isPythonCodeFenced(raw)) {\n\t\t\t(node as CanvasTextData).text = ensurePythonCodeFence(raw);\n\t\t\tconst liveData = liveCanvas?.getData?.();\n\t\t\tif (liveData?.nodes) mergePreserveUserNodeProps(data, liveData);\n\t\t\tliveCanvas?.setData?.(data);\n\t\t\tif (liveCanvas?.requestSave) liveCanvas.requestSave();\n\t\t\tawait saveCanvasData(app.vault, canvasFilePath, data);\n\t\t}\n\t}\n\tconst incoming = getIncomingEdgesWithLabels(nodeId, data);\n\tconst nodeInput = await getNodeContent(node, app.vault);\n\tconst { concatenatedPart, template, edgeModes } = buildInputWithVariables(\n\t\tcanvasKey,\n\t\tnodeInput,\n\t\tincoming\n\t);\n\tconst fullPrompt =\n\t\tconcatenatedPart.length &gt; 0 ? &#96;${concatenatedPart}\\n\\n---\\n\\n${template}&#96; : template;\n\n\tif (role === \"orange\") {\n\t\tconst model = settings.ollamaOrangeModel || \"llama2\";\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Run a single node: get input + parent context (concatenate or {{var:name}}), call LLM or Python, store result. */",
            "lineNumber": 316
          },
          {
            "text": "async function runSingleNode(",
            "lineNumber": 317,
            "isSignature": true
          },
          {
            "text": "\tapp: App,",
            "lineNumber": 318,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 319,
            "isSignature": true
          },
          {
            "text": "\tcanvasKey: string,",
            "lineNumber": 320,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 321,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 322,
            "isSignature": true
          },
          {
            "text": "\tnodeId: string,",
            "lineNumber": 323,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 324,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;string&gt; {",
            "lineNumber": 325,
            "isSignature": true
          },
          {
            "text": "\tconst node = getNodeById(data, nodeId);",
            "lineNumber": 326
          },
          {
            "text": "\tif (!node) return \"\";",
            "lineNumber": 327
          },
          {
            "text": "\tconst role = getNodeRole(node, settings);",
            "lineNumber": 328
          },
          {
            "text": "\tif (!role || role === \"yellow\" || role === \"green\") {",
            "lineNumber": 329
          },
          {
            "text": "\t\t// Yellow = text (input pass-through): merge parent results with own content, same as AI/Python nodes",
            "lineNumber": 330
          },
          {
            "text": "\t\tif (role === \"yellow\") {",
            "lineNumber": 331
          },
          {
            "text": "\t\t\tconst incoming = getIncomingEdgesWithLabels(nodeId, data);",
            "lineNumber": 332
          },
          {
            "text": "\t\t\tconst nodeInput = await getNodeContent(node, app.vault);",
            "lineNumber": 333
          },
          {
            "text": "\t\t\tconst { concatenatedPart, template } = buildInputWithVariables(",
            "lineNumber": 334
          },
          {
            "text": "\t\t\t\tcanvasKey,",
            "lineNumber": 335
          },
          {
            "text": "\t\t\t\tnodeInput,",
            "lineNumber": 336
          },
          {
            "text": "\t\t\t\tincoming",
            "lineNumber": 337
          },
          {
            "text": "\t\t\t);",
            "lineNumber": 338
          },
          {
            "text": "\t\t\tconst fullContent =",
            "lineNumber": 339
          },
          {
            "text": "\t\t\t\tconcatenatedPart.length &gt; 0 ? &#96;${concatenatedPart}\\n\\n---\\n\\n${template}&#96; : template;",
            "lineNumber": 340
          },
          {
            "text": "\t\t\tsetNodeResult(canvasKey, nodeId, fullContent);",
            "lineNumber": 341
          },
          {
            "text": "\t\t\treturn fullContent;",
            "lineNumber": 342
          },
          {
            "text": "\t\t}",
            "lineNumber": 343
          },
          {
            "text": "\t\treturn \"\";",
            "lineNumber": 344
          },
          {
            "text": "\t}",
            "lineNumber": 345
          },
          {
            "text": "\t// For Python (blue) text nodes, auto-wrap content in &#96;&#96;&#96;python ... &#96;&#96;&#96; so # comments render correctly",
            "lineNumber": 346
          },
          {
            "text": "\tif (role === \"blue\" &amp;&amp; isTextNode(node)) {",
            "lineNumber": 347
          },
          {
            "text": "\t\tconst raw = getTextNodeContent(node as CanvasTextData);",
            "lineNumber": 348
          },
          {
            "text": "\t\tif (!isPythonCodeFenced(raw)) {",
            "lineNumber": 349
          },
          {
            "text": "\t\t\t(node as CanvasTextData).text = ensurePythonCodeFence(raw);",
            "lineNumber": 350
          },
          {
            "text": "\t\t\tconst liveData = liveCanvas?.getData?.();",
            "lineNumber": 351
          },
          {
            "text": "\t\t\tif (liveData?.nodes) mergePreserveUserNodeProps(data, liveData);",
            "lineNumber": 352
          },
          {
            "text": "\t\t\tliveCanvas?.setData?.(data);",
            "lineNumber": 353
          },
          {
            "text": "\t\t\tif (liveCanvas?.requestSave) liveCanvas.requestSave();",
            "lineNumber": 354
          },
          {
            "text": "\t\t\tawait saveCanvasData(app.vault, canvasFilePath, data);",
            "lineNumber": 355
          },
          {
            "text": "\t\t}",
            "lineNumber": 356
          },
          {
            "text": "\t}",
            "lineNumber": 357
          },
          {
            "text": "\tconst incoming = getIncomingEdgesWithLabels(nodeId, data);",
            "lineNumber": 358
          },
          {
            "text": "\tconst nodeInput = await getNodeContent(node, app.vault);",
            "lineNumber": 359
          },
          {
            "text": "\tconst { concatenatedPart, template, edgeModes } = buildInputWithVariables(",
            "lineNumber": 360
          },
          {
            "text": "\t\tcanvasKey,",
            "lineNumber": 361
          },
          {
            "text": "\t\tnodeInput,",
            "lineNumber": 362
          },
          {
            "text": "\t\tincoming",
            "lineNumber": 363
          },
          {
            "text": "\t);",
            "lineNumber": 364
          },
          {
            "text": "\tconst fullPrompt =",
            "lineNumber": 365
          },
          {
            "text": "\t\tconcatenatedPart.length &gt; 0 ? &#96;${concatenatedPart}\\n\\n---\\n\\n${template}&#96; : template;",
            "lineNumber": 366
          },
          {
            "lineNumber": 367
          },
          {
            "text": "\tif (role === \"orange\") {",
            "lineNumber": 368
          },
          {
            "text": "\t\tconst model = settings.ollamaOrangeModel || \"llama2\";",
            "lineNumber": 369
          },
          {
            "text": "}",
            "lineNumber": 435,
            "isSignature": true
          }
        ]
      },
      "score": 0.2640947997570038
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 338
          },
          "endPosition": {
            "line": 928,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\nasync onload() {\n\nasync () =&gt; {\n\n 60000); // Clear after 1 minute\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tpreviousCanvasPaths = openPaths;\n\t\t\t\t})\n\t\t\t);\n\n\t\t\t// Floating role labels on canvas: sync when active leaf is a canvas, clear when not\n\t\t\tlet roleLabelsContainerEl: HTMLElement | null = null;\n\t\t\tlet roleLabelsIntervalId: number | null = null;\n\t\t\tconst runSyncLabels = (): void =&gt; {\n\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\tif (!view) {\n\t\t\t\t\tif (roleLabelsIntervalId != null) {\n\t\t\t\t\t\tclearInterval(roleLabelsIntervalId);\n\t\t\t\t\t\troleLabelsIntervalId = null;\n\t\t\t\t\t\tdelete (this as unknown as Record&lt;string, unknown&gt;)._roleLabelsIntervalId;\n\t\t\t\t\t}\n\t\t\t\t\tif (roleLabelsContainerEl != null) {\n\t\t\t\t\t\tclearCanvasRoleLabels(roleLabelsContainerEl);\n\t\t\t\t\t\tclearCanvasLegend(roleLabelsContainerEl);\n\t\t\t\t\t\tclearCanvasEdgeModeLabels(roleLabelsContainerEl);\n\t\t\t\t\t\tthis.clearCanvasToolbar(roleLabelsContainerEl);\n\t\t\t\t\t\tthis.clearTemplateBanner(roleLabelsContainerEl);\n\t\t\t\t\t\troleLabelsContainerEl = null;\n\t\t\t\t\t}\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tif (roleLabelsContainerEl != null &amp;&amp; roleLabelsContainerEl !== view.containerEl) {\n\t\t\t\t\tclearCanvasRoleLabels(roleLabelsContainerEl);\n\t\t\t\t\tclearCanvasLegend(roleLabelsContainerEl);\n\t\t\t\t\tclearCanvasEdgeModeLabels(roleLabelsContainerEl);\n\t\t\t\t\tthis.clearCanvasToolbar(roleLabelsContainerEl);\n\t\t\t\t\tthis.clearTemplateBanner(roleLabelsContainerEl);\n\t\t\t\t}\n\t\t\t\troleLabelsContainerEl = view.containerEl;\n;\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 330,
                "column": 1
              },
              "endPosition": {
                "line": 330,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 330,
                "column": 16
              },
              "endPosition": {
                "line": 331,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 333,
                "column": 2
              },
              "endPosition": {
                "line": 334,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 339,
            "isSignature": true
          },
          {
            "text": "async onload() {",
            "lineNumber": 342
          },
          {
            "lineNumber": 503
          },
          {
            "text": "async () =&gt; {",
            "lineNumber": 504
          },
          {
            "lineNumber": 525
          },
          {
            "text": " 60000); // Clear after 1 minute",
            "lineNumber": 527
          },
          {
            "text": "\t\t\t\t\t\t}",
            "lineNumber": 528
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 529
          },
          {
            "text": "\t\t\t\t\tpreviousCanvasPaths = openPaths;",
            "lineNumber": 530
          },
          {
            "text": "\t\t\t\t})",
            "lineNumber": 531
          },
          {
            "text": "\t\t\t);",
            "lineNumber": 532
          },
          {
            "lineNumber": 533
          },
          {
            "text": "\t\t\t// Floating role labels on canvas: sync when active leaf is a canvas, clear when not",
            "lineNumber": 534
          },
          {
            "text": "\t\t\tlet roleLabelsContainerEl: HTMLElement | null = null;",
            "lineNumber": 535
          },
          {
            "text": "\t\t\tlet roleLabelsIntervalId: number | null = null;",
            "lineNumber": 536
          },
          {
            "text": "\t\t\tconst runSyncLabels = (): void =&gt; {",
            "lineNumber": 537
          },
          {
            "text": "\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 538
          },
          {
            "text": "\t\t\t\tif (!view) {",
            "lineNumber": 539
          },
          {
            "text": "\t\t\t\t\tif (roleLabelsIntervalId != null) {",
            "lineNumber": 540
          },
          {
            "text": "\t\t\t\t\t\tclearInterval(roleLabelsIntervalId);",
            "lineNumber": 541
          },
          {
            "text": "\t\t\t\t\t\troleLabelsIntervalId = null;",
            "lineNumber": 542
          },
          {
            "text": "\t\t\t\t\t\tdelete (this as unknown as Record&lt;string, unknown&gt;)._roleLabelsIntervalId;",
            "lineNumber": 543
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 544
          },
          {
            "text": "\t\t\t\t\tif (roleLabelsContainerEl != null) {",
            "lineNumber": 545
          },
          {
            "text": "\t\t\t\t\t\tclearCanvasRoleLabels(roleLabelsContainerEl);",
            "lineNumber": 546
          },
          {
            "text": "\t\t\t\t\t\tclearCanvasLegend(roleLabelsContainerEl);",
            "lineNumber": 547
          },
          {
            "text": "\t\t\t\t\t\tclearCanvasEdgeModeLabels(roleLabelsContainerEl);",
            "lineNumber": 548
          },
          {
            "text": "\t\t\t\t\t\tthis.clearCanvasToolbar(roleLabelsContainerEl);",
            "lineNumber": 549
          },
          {
            "text": "\t\t\t\t\t\tthis.clearTemplateBanner(roleLabelsContainerEl);",
            "lineNumber": 550
          },
          {
            "text": "\t\t\t\t\t\troleLabelsContainerEl = null;",
            "lineNumber": 551
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 552
          },
          {
            "text": "\t\t\t\t\treturn;",
            "lineNumber": 553
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 554
          },
          {
            "text": "\t\t\t\tif (roleLabelsContainerEl != null &amp;&amp; roleLabelsContainerEl !== view.containerEl) {",
            "lineNumber": 555
          },
          {
            "text": "\t\t\t\t\tclearCanvasRoleLabels(roleLabelsContainerEl);",
            "lineNumber": 556
          },
          {
            "text": "\t\t\t\t\tclearCanvasLegend(roleLabelsContainerEl);",
            "lineNumber": 557
          },
          {
            "text": "\t\t\t\t\tclearCanvasEdgeModeLabels(roleLabelsContainerEl);",
            "lineNumber": 558
          },
          {
            "text": "\t\t\t\t\tthis.clearCanvasToolbar(roleLabelsContainerEl);",
            "lineNumber": 559
          },
          {
            "text": "\t\t\t\t\tthis.clearTemplateBanner(roleLabelsContainerEl);",
            "lineNumber": 560
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 561
          },
          {
            "text": "\t\t\t\troleLabelsContainerEl = view.containerEl;",
            "lineNumber": 562
          },
          {
            "text": ";",
            "lineNumber": 597
          },
          {
            "text": "\t}",
            "lineNumber": 604
          },
          {
            "text": "}",
            "lineNumber": 929,
            "isSignature": true
          }
        ]
      },
      "score": 0.26328718662261963
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 338
          },
          "endPosition": {
            "line": 928,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\naddCanvasToolbarToContainer(containerEl: HTMLElement): void {\n\n\t\tdismissBtn.createSpan({ cls: \"ztb-toolbar-label\", text: \"Dismiss all output\" });\n\t\tdismissBtn.addEventListener(\"click\", () =&gt; this.dismissAllOutput());\n\t}\n\n\t/** Remove the template banner from the canvas container. */\n\tclearTemplateBanner(containerEl: HTMLElement): void {\n\t\tcontainerEl.querySelectorAll(&#96;.${ZettelThinkingBoardPlugin.ZTB_TEMPLATE_BANNER_CLASS}&#96;).forEach((el) =&gt; el.remove());\n\t}\n\n\t/** Show or hide the template banner based on whether the canvas is in the template folder. */\n\tsyncTemplateBanner(containerEl: HTMLElement, canvasPath: string): void {\n\t\tconst templateFolder = this.settings.canvasTemplateFolder.trim();\n\t\tconst isTemplate = isCanvasInTemplateFolder(canvasPath, templateFolder);\n\n\t\tconst existingBanner = containerEl.querySelector(&#96;.${ZettelThinkingBoardPlugin.ZTB_TEMPLATE_BANNER_CLASS}&#96;);\n\n\t\tif (isTemplate &amp;&amp; !existingBanner) {\n\t\t\t// Add banner\n\t\t\tconst banner = containerEl.createDiv;\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 330,
                "column": 1
              },
              "endPosition": {
                "line": 330,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 330,
                "column": 16
              },
              "endPosition": {
                "line": 331,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 339,
            "isSignature": true
          },
          {
            "text": "addCanvasToolbarToContainer(containerEl: HTMLElement): void {",
            "lineNumber": 817
          },
          {
            "lineNumber": 827
          },
          {
            "text": "\t\tdismissBtn.createSpan({ cls: \"ztb-toolbar-label\", text: \"Dismiss all output\" });",
            "lineNumber": 828
          },
          {
            "text": "\t\tdismissBtn.addEventListener(\"click\", () =&gt; this.dismissAllOutput());",
            "lineNumber": 829
          },
          {
            "text": "\t}",
            "lineNumber": 830
          },
          {
            "lineNumber": 831
          },
          {
            "text": "\t/** Remove the template banner from the canvas container. */",
            "lineNumber": 832
          },
          {
            "text": "\tclearTemplateBanner(containerEl: HTMLElement): void {",
            "lineNumber": 833
          },
          {
            "text": "\t\tcontainerEl.querySelectorAll(&#96;.${ZettelThinkingBoardPlugin.ZTB_TEMPLATE_BANNER_CLASS}&#96;).forEach((el) =&gt; el.remove());",
            "lineNumber": 834
          },
          {
            "text": "\t}",
            "lineNumber": 835
          },
          {
            "lineNumber": 836
          },
          {
            "text": "\t/** Show or hide the template banner based on whether the canvas is in the template folder. */",
            "lineNumber": 837
          },
          {
            "text": "\tsyncTemplateBanner(containerEl: HTMLElement, canvasPath: string): void {",
            "lineNumber": 838
          },
          {
            "text": "\t\tconst templateFolder = this.settings.canvasTemplateFolder.trim();",
            "lineNumber": 839
          },
          {
            "text": "\t\tconst isTemplate = isCanvasInTemplateFolder(canvasPath, templateFolder);",
            "lineNumber": 840
          },
          {
            "lineNumber": 841
          },
          {
            "text": "\t\tconst existingBanner = containerEl.querySelector(&#96;.${ZettelThinkingBoardPlugin.ZTB_TEMPLATE_BANNER_CLASS}&#96;);",
            "lineNumber": 842
          },
          {
            "lineNumber": 843
          },
          {
            "text": "\t\tif (isTemplate &amp;&amp; !existingBanner) {",
            "lineNumber": 844
          },
          {
            "text": "\t\t\t// Add banner",
            "lineNumber": 845
          },
          {
            "text": "\t\t\tconst banner = containerEl.createDiv;",
            "lineNumber": 846
          },
          {
            "text": "\t}",
            "lineNumber": 853
          },
          {
            "text": "}",
            "lineNumber": 929,
            "isSignature": true
          }
        ]
      },
      "score": 0.25978970527648926
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/types.ts",
        "range": {
          "startPosition": {
            "line": 40,
            "column": 42
          },
          "endPosition": {
            "line": 44,
            "column": 83
          }
        },
        "contents": "/** Reserved edge label from run node to optional thinking display node. */\nexport const EDGE_LABEL_THINKING = \"thinking\";\n\n/** Parse variable name from edge label; ignore anything in brackets at the end. */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Reserved edge label from run node to optional thinking display node. */",
            "lineNumber": 42
          },
          {
            "text": "export const EDGE_LABEL_THINKING = \"thinking\";",
            "lineNumber": 43
          },
          {
            "lineNumber": 44
          },
          {
            "text": "/** Parse variable name from edge label; ignore anything in brackets at the end. */",
            "lineNumber": 45
          }
        ]
      },
      "score": 0.25929608941078186
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/canvasNodeLabels.ts",
        "range": {
          "startPosition": {
            "line": 151,
            "column": 1
          },
          "endPosition": {
            "line": 208,
            "column": 1
          }
        },
        "contents": "/**\n * Sync floating role labels for the active canvas: for each node whose color maps to a role,\n * add a small label above the node (e.g. \"Text\", \"Python\"). Removes existing labels first.\n * Uses the live canvas node map to find each node's DOM element (.canvas-node).\n * @param isStillActive - if provided, called after async load; when false we skip applying to avoid stale canvas\n */\nexport async function syncCanvasRoleLabels(\n\tvault: Vault,\n\tcanvasFilePath: string,\n\tcontainerEl: HTMLElement,\n\tsettings: ZettelPluginSettings,\n\tcanvas: LiveCanvas | null,\n\tisStillActive?: () =&gt; boolean\n): Promise&lt;void&gt; {\n\tif (!settings.showNodeRoleLabels) {\n\t\tclearCanvasRoleLabels(containerEl);\n\t\tclearCanvasLegend(containerEl);\n\t\treturn;\n\t}\n\tconst data = await loadCanvasData(vault, canvasFilePath);\n\tif (isStillActive &amp;&amp; !isStillActive()) return;\n\tif (!data?.nodes) {\n\t\tclearCanvasRoleLabels(containerEl);\n\t\tclearCanvasLegend(containerEl);\n\t\treturn;\n\t}\n\t// Clear only after we have data so we never paint a frame with labels removed and nothing to show (avoids flicker).\n\tclearCanvasRoleLabels(containerEl);\n\tsyncCanvasLegend(containerEl, settings);\n\tconst canvasKey = getCanvasKey(canvasFilePath);\n\tfor (const node of data.nodes) {\n\t\tconst role = getNodeRole(node, settings);\n\t\tif (!role) continue;\n\t\tconst labelText = getRoleLabel(role, settings);\n\t\tconst nodeEl =\n\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, node.id)) ||\n\t\t\tfindNodeElementByDataId(containerEl, node.id);\n\t\tif (!nodeEl) continue;\n\t\tconst label = createLabelEl(labelText);\n\t\t// Append after .canvas-node-container so it matches Obsidian file node label position\n\t\tnodeEl.append(label);\n\t\tif (isAIRole(role)) {\n\t\t\tconst durationMs = getNodeDuration(canvasKey, node.id);\n\t\t\tif (durationMs !== undefined) {\n\t\t\t\tconst durationLabel = createDurationLabelEl(formatDurationMs(durationMs));\n\t\t\t\tnodeEl.append(durationLabel);\n\t\t\t}\n\t\t}\n\t}\n}\n\n/** Get center of an element in viewport coordinates. */\nfunction getElCenter(el: HTMLElement): { x: number; y: number } {\n\tconst r = el.getBoundingClientRect();\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/**",
            "lineNumber": 154
          },
          {
            "text": " * Sync floating role labels for the active canvas: for each node whose color maps to a role,",
            "lineNumber": 155
          },
          {
            "text": " * add a small label above the node (e.g. \"Text\", \"Python\"). Removes existing labels first.",
            "lineNumber": 156
          },
          {
            "text": " * Uses the live canvas node map to find each node's DOM element (.canvas-node).",
            "lineNumber": 157
          },
          {
            "text": " * @param isStillActive - if provided, called after async load; when false we skip applying to avoid stale canvas",
            "lineNumber": 158
          },
          {
            "text": " */",
            "lineNumber": 159
          },
          {
            "text": "export async function syncCanvasRoleLabels(",
            "lineNumber": 160,
            "isSignature": true
          },
          {
            "text": "\tvault: Vault,",
            "lineNumber": 161,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 162,
            "isSignature": true
          },
          {
            "text": "\tcontainerEl: HTMLElement,",
            "lineNumber": 163,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 164,
            "isSignature": true
          },
          {
            "text": "\tcanvas: LiveCanvas | null,",
            "lineNumber": 165,
            "isSignature": true
          },
          {
            "text": "\tisStillActive?: () =&gt; boolean",
            "lineNumber": 166,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;void&gt; {",
            "lineNumber": 167,
            "isSignature": true
          },
          {
            "text": "\tif (!settings.showNodeRoleLabels) {",
            "lineNumber": 168
          },
          {
            "text": "\t\tclearCanvasRoleLabels(containerEl);",
            "lineNumber": 169
          },
          {
            "text": "\t\tclearCanvasLegend(containerEl);",
            "lineNumber": 170
          },
          {
            "text": "\t\treturn;",
            "lineNumber": 171
          },
          {
            "text": "\t}",
            "lineNumber": 172
          },
          {
            "text": "\tconst data = await loadCanvasData(vault, canvasFilePath);",
            "lineNumber": 173
          },
          {
            "text": "\tif (isStillActive &amp;&amp; !isStillActive()) return;",
            "lineNumber": 174
          },
          {
            "text": "\tif (!data?.nodes) {",
            "lineNumber": 175
          },
          {
            "text": "\t\tclearCanvasRoleLabels(containerEl);",
            "lineNumber": 176
          },
          {
            "text": "\t\tclearCanvasLegend(containerEl);",
            "lineNumber": 177
          },
          {
            "text": "\t\treturn;",
            "lineNumber": 178
          },
          {
            "text": "\t}",
            "lineNumber": 179
          },
          {
            "text": "\t// Clear only after we have data so we never paint a frame with labels removed and nothing to show (avoids flicker).",
            "lineNumber": 180
          },
          {
            "text": "\tclearCanvasRoleLabels(containerEl);",
            "lineNumber": 181
          },
          {
            "text": "\tsyncCanvasLegend(containerEl, settings);",
            "lineNumber": 182
          },
          {
            "text": "\tconst canvasKey = getCanvasKey(canvasFilePath);",
            "lineNumber": 183
          },
          {
            "text": "\tfor (const node of data.nodes) {",
            "lineNumber": 184
          },
          {
            "text": "\t\tconst role = getNodeRole(node, settings);",
            "lineNumber": 185
          },
          {
            "text": "\t\tif (!role) continue;",
            "lineNumber": 186
          },
          {
            "text": "\t\tconst labelText = getRoleLabel(role, settings);",
            "lineNumber": 187
          },
          {
            "text": "\t\tconst nodeEl =",
            "lineNumber": 188
          },
          {
            "text": "\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, node.id)) ||",
            "lineNumber": 189
          },
          {
            "text": "\t\t\tfindNodeElementByDataId(containerEl, node.id);",
            "lineNumber": 190
          },
          {
            "text": "\t\tif (!nodeEl) continue;",
            "lineNumber": 191
          },
          {
            "text": "\t\tconst label = createLabelEl(labelText);",
            "lineNumber": 192
          },
          {
            "text": "\t\t// Append after .canvas-node-container so it matches Obsidian file node label position",
            "lineNumber": 193
          },
          {
            "text": "\t\tnodeEl.append(label);",
            "lineNumber": 194
          },
          {
            "text": "\t\tif (isAIRole(role)) {",
            "lineNumber": 195
          },
          {
            "text": "\t\t\tconst durationMs = getNodeDuration(canvasKey, node.id);",
            "lineNumber": 196
          },
          {
            "text": "\t\t\tif (durationMs !== undefined) {",
            "lineNumber": 197
          },
          {
            "text": "\t\t\t\tconst durationLabel = createDurationLabelEl(formatDurationMs(durationMs));",
            "lineNumber": 198
          },
          {
            "text": "\t\t\t\tnodeEl.append(durationLabel);",
            "lineNumber": 199
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 200
          },
          {
            "text": "\t\t}",
            "lineNumber": 201
          },
          {
            "text": "\t}",
            "lineNumber": 202
          },
          {
            "text": "}",
            "lineNumber": 203,
            "isSignature": true
          },
          {
            "lineNumber": 204
          },
          {
            "text": "/** Get center of an element in viewport coordinates. */",
            "lineNumber": 205
          },
          {
            "text": "function getElCenter(el: HTMLElement): { x: number; y: number } {",
            "lineNumber": 206,
            "isSignature": true
          },
          {
            "text": "\tconst r = el.getBoundingClientRect();",
            "lineNumber": 207
          },
          {
            "text": "}",
            "lineNumber": 209,
            "isSignature": true
          }
        ]
      },
      "score": 0.2580398917198181
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/settings.ts",
        "range": {
          "startPosition": {
            "line": 111,
            "column": 1
          },
          "endPosition": {
            "line": 137,
            "column": 82
          }
        },
        "contents": "export const DEFAULT_SETTINGS: ZettelPluginSettings = {\n\tollamaOrangeModel: \"\",\n\tollamaPurpleModel: \"\",\n\tollamaRedModel: \"\",\n\tmodelLabelOrange: \"\",\n\tmodelLabelPurple: \"\",\n\tmodelLabelRed: \"\",\n\tollamaOrangeTemperature: 0.8,\n\tollamaPurpleTemperature: 0.8,\n\tollamaRedTemperature: 0.8,\n\tcolorRed: \"5\",\n\tcolorOrange: \"1\",\n\tcolorPurple: \"2\",\n\tcolorBlue: \"6\",\n\tcolorYellow: \"3\",\n\tcolorGreen: \"4\",\n\tshowPromptInOutput: false,\n\tshowThinkingNode: false,\n\tshowNodeRoleLabels: true,\n\tpythonPath: \"python3\",\n\tcanvasTemplateFolder: \"\",\n\tcanvasOutputFolder: \"\",\n};\n\n/** Fallback hex for preset 1–6 to match Obsidian order (mod-canvas-color-N). */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "export const DEFAULT_SETTINGS: ZettelPluginSettings = {",
            "lineNumber": 114
          },
          {
            "text": "\tollamaOrangeModel: \"\",",
            "lineNumber": 115
          },
          {
            "text": "\tollamaPurpleModel: \"\",",
            "lineNumber": 116
          },
          {
            "text": "\tollamaRedModel: \"\",",
            "lineNumber": 117
          },
          {
            "text": "\tmodelLabelOrange: \"\",",
            "lineNumber": 118
          },
          {
            "text": "\tmodelLabelPurple: \"\",",
            "lineNumber": 119
          },
          {
            "text": "\tmodelLabelRed: \"\",",
            "lineNumber": 120
          },
          {
            "text": "\tollamaOrangeTemperature: 0.8,",
            "lineNumber": 121
          },
          {
            "text": "\tollamaPurpleTemperature: 0.8,",
            "lineNumber": 122
          },
          {
            "text": "\tollamaRedTemperature: 0.8,",
            "lineNumber": 123
          },
          {
            "text": "\tcolorRed: \"5\",",
            "lineNumber": 124
          },
          {
            "text": "\tcolorOrange: \"1\",",
            "lineNumber": 125
          },
          {
            "text": "\tcolorPurple: \"2\",",
            "lineNumber": 126
          },
          {
            "text": "\tcolorBlue: \"6\",",
            "lineNumber": 127
          },
          {
            "text": "\tcolorYellow: \"3\",",
            "lineNumber": 128
          },
          {
            "text": "\tcolorGreen: \"4\",",
            "lineNumber": 129
          },
          {
            "text": "\tshowPromptInOutput: false,",
            "lineNumber": 130
          },
          {
            "text": "\tshowThinkingNode: false,",
            "lineNumber": 131
          },
          {
            "text": "\tshowNodeRoleLabels: true,",
            "lineNumber": 132
          },
          {
            "text": "\tpythonPath: \"python3\",",
            "lineNumber": 133
          },
          {
            "text": "\tcanvasTemplateFolder: \"\",",
            "lineNumber": 134
          },
          {
            "text": "\tcanvasOutputFolder: \"\",",
            "lineNumber": 135
          },
          {
            "text": "};",
            "lineNumber": 136
          },
          {
            "lineNumber": 137
          },
          {
            "text": "/** Fallback hex for preset 1–6 to match Obsidian order (mod-canvas-color-N). */",
            "lineNumber": 138
          }
        ]
      },
      "score": 0.2578352987766266
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/state.ts",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 23,
            "column": 95
          }
        },
        "contents": "/** Per-canvas state: NodeID -&gt; last output result string. */\nconst canvasState = new Map&lt;string, Map&lt;string, string&gt;&gt;();\n\n/** Per-canvas edge mode: EdgeID -&gt; \"inject\" | \"concatenate\" (shown in floating label under edge). */\nconst edgeModeState = new Map&lt;string, Map&lt;string, \"inject\" | \"concatenate\"&gt;&gt;();\n\n/** Node currently running (waiting for AI/kernel) per canvas; used to show \"running\" on incoming edges. */\nconst runningNodeState = new Map&lt;string, string | null&gt;();\n\n/** Per-canvas AI node duration: NodeID -&gt; duration in milliseconds. */\nconst nodeDurationState = new Map&lt;string, Map&lt;string, number&gt;&gt;();\n\n/** Global lock: only one run (node/chain/entire) at a time across all canvases. */\nlet runInProgress = false;\n\n/** Run queue: jobs waiting to run. */\nexport type RunQueueJob =\n\t| { type: \"node\"; canvasFilePath: string; nodeId: string }\n\t| { type: \"chain\"; canvasFilePath: string; nodeId: string }\n\t| { type: \"entire\"; canvasFilePath: string };\n\nconst runQueue: RunQueueJob[] = [];\n\n/** Per-canvas set of node IDs that are the target of a queued job (for \"queued\" indicator). */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Per-canvas state: NodeID -&gt; last output result string. */",
            "lineNumber": 1
          },
          {
            "text": "const canvasState = new Map&lt;string, Map&lt;string, string&gt;&gt;();",
            "lineNumber": 2
          },
          {
            "lineNumber": 3
          },
          {
            "text": "/** Per-canvas edge mode: EdgeID -&gt; \"inject\" | \"concatenate\" (shown in floating label under edge). */",
            "lineNumber": 4
          },
          {
            "text": "const edgeModeState = new Map&lt;string, Map&lt;string, \"inject\" | \"concatenate\"&gt;&gt;();",
            "lineNumber": 5
          },
          {
            "lineNumber": 6
          },
          {
            "text": "/** Node currently running (waiting for AI/kernel) per canvas; used to show \"running\" on incoming edges. */",
            "lineNumber": 7
          },
          {
            "text": "const runningNodeState = new Map&lt;string, string | null&gt;();",
            "lineNumber": 8
          },
          {
            "lineNumber": 9
          },
          {
            "text": "/** Per-canvas AI node duration: NodeID -&gt; duration in milliseconds. */",
            "lineNumber": 10
          },
          {
            "text": "const nodeDurationState = new Map&lt;string, Map&lt;string, number&gt;&gt;();",
            "lineNumber": 11
          },
          {
            "lineNumber": 12
          },
          {
            "text": "/** Global lock: only one run (node/chain/entire) at a time across all canvases. */",
            "lineNumber": 13
          },
          {
            "text": "let runInProgress = false;",
            "lineNumber": 14
          },
          {
            "lineNumber": 15
          },
          {
            "text": "/** Run queue: jobs waiting to run. */",
            "lineNumber": 16
          },
          {
            "text": "export type RunQueueJob =",
            "lineNumber": 17,
            "isSignature": true
          },
          {
            "text": "\t| { type: \"node\"; canvasFilePath: string; nodeId: string }",
            "lineNumber": 18
          },
          {
            "text": "\t| { type: \"chain\"; canvasFilePath: string; nodeId: string }",
            "lineNumber": 19
          },
          {
            "text": "\t| { type: \"entire\"; canvasFilePath: string };",
            "lineNumber": 20,
            "isSignature": true
          },
          {
            "lineNumber": 21
          },
          {
            "text": "const runQueue: RunQueueJob[] = [];",
            "lineNumber": 22
          },
          {
            "lineNumber": 23
          },
          {
            "text": "/** Per-canvas set of node IDs that are the target of a queued job (for \"queued\" indicator). */",
            "lineNumber": 24
          }
        ]
      },
      "score": 0.25563645362854004
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 106
          },
          "endPosition": {
            "line": 322,
            "column": 1
          }
        },
        "contents": "function getTutorialCanvasData(settings: ZettelPluginSettings): CanvasData {\nconst nodes: CanvasData[\"nodes\"] = [\n TUT_NODE_LANE_W, TUT_NODE_H),\n\n\t\t// Column 2\n\t\tn(lab2a, \"Secondary model (same idea, different model).\", commentLeftX(col2), purpleY, \"\", TUT_COMMENT_W, TUT_LABEL_H),\n\t\tn(purpleNode, \"Summarize in 5 words: The quick brown fox jumps.\", laneNodeX(col2, 0), purpleY, cPurple, TUT_NODE_LANE_W, TUT_NODE_H),\n\t\tn(purpleOut, \"\", laneNodeX(col2, LANE_OFFSET), purpleOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),\n\t\tn(lab2b, \"Text: input text; passed to next node as-is (pass-through).\", commentRightX(col2), yellowY, \"\", TUT_COMMENT_W, TUT_LABEL_H),\n\t\tn(yellowNode, \"I'm input text. My text is passed to the next node (concatenated).\", laneNodeX(col2, 0), yellowY, cYellow, TUT_NODE_LANE_W, TUT_NODE_H),\n\t\tn(lab2c, \"Python: runs code. Use variable input for parent text.\", commentLeftX(col2), blueY, \"\", TUT_COMMENT_W, TUT_LABEL_H),\n\t\tn(blueNode, \"print('Python says:', (input or '')[:80] or '(no input)')\\n# input = text from parent\", laneNodeX(col2, LANE_OFFSET), blueY, cBlue, TUT_NODE_LANE_W, TUT_NODE_H),\n\t\tn(blueOut, \"\", laneNodeX(col2, 0), blueOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),\n\n\t\t// Column 3\n\t\tn(lab3, \"Concatenation: no edge label → parent output appended before your prompt (then \\\"---\\\", then this card).\", commentLeftX(col3), concatCommentY, \"\", TUT_COMMENT_W, TUT_LABEL_H + 12),\n\t\tn(concatComment, \"I'm input text. My full text is added to the next node's prompt.\", laneNodeX(col3, 0), concatCommentY, cYellow, TUT_NODE_LANE_W, TUT_NODE_H),\n\t\tn(concatOrange, \"Reply in one word: what did the previous card say?\", laneNodeX(col3, LANE_OFFSET), concatOrangeY, cOrange, TUT_NODE_LANE_W, TUT_NODE_H),\n\t\tn(concatOut, \"\", laneNodeX(col3, 0), concatOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),\n\n\t\t// Column 4\n\t\tn(lab4, \"Variable injection: put a name on the edge and use {{var:name}} in the prompt; that parent is injected there.\", commentLeftX(col4), injectFirstY, \"\", TUT_COMMENT_W, TUT_LABEL_H + 12),\n\t\tn(injectFirst, \"Say exactly: Hello world.\", laneNodeX(col4, 0), injectFirstY\n,\n\t];\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 98,
                "column": 1
              },
              "endPosition": {
                "line": 99,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 259,
                "column": 2
              },
              "endPosition": {
                "line": 259,
                "column": 8
              }
            },
            {
              "startPosition": {
                "line": 259,
                "column": 8
              },
              "endPosition": {
                "line": 260,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "function getTutorialCanvasData(settings: ZettelPluginSettings): CanvasData {",
            "lineNumber": 107,
            "isSignature": true
          },
          {
            "text": "const nodes: CanvasData[\"nodes\"] = [",
            "lineNumber": 268
          },
          {
            "text": " TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 283
          },
          {
            "lineNumber": 284
          },
          {
            "text": "\t\t// Column 2",
            "lineNumber": 285
          },
          {
            "text": "\t\tn(lab2a, \"Secondary model (same idea, different model).\", commentLeftX(col2), purpleY, \"\", TUT_COMMENT_W, TUT_LABEL_H),",
            "lineNumber": 286
          },
          {
            "text": "\t\tn(purpleNode, \"Summarize in 5 words: The quick brown fox jumps.\", laneNodeX(col2, 0), purpleY, cPurple, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 287
          },
          {
            "text": "\t\tn(purpleOut, \"\", laneNodeX(col2, LANE_OFFSET), purpleOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 288
          },
          {
            "text": "\t\tn(lab2b, \"Text: input text; passed to next node as-is (pass-through).\", commentRightX(col2), yellowY, \"\", TUT_COMMENT_W, TUT_LABEL_H),",
            "lineNumber": 289
          },
          {
            "text": "\t\tn(yellowNode, \"I'm input text. My text is passed to the next node (concatenated).\", laneNodeX(col2, 0), yellowY, cYellow, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 290
          },
          {
            "text": "\t\tn(lab2c, \"Python: runs code. Use variable input for parent text.\", commentLeftX(col2), blueY, \"\", TUT_COMMENT_W, TUT_LABEL_H),",
            "lineNumber": 291
          },
          {
            "text": "\t\tn(blueNode, \"print('Python says:', (input or '')[:80] or '(no input)')\\n# input = text from parent\", laneNodeX(col2, LANE_OFFSET), blueY, cBlue, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 292
          },
          {
            "text": "\t\tn(blueOut, \"\", laneNodeX(col2, 0), blueOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 293
          },
          {
            "lineNumber": 294
          },
          {
            "text": "\t\t// Column 3",
            "lineNumber": 295
          },
          {
            "text": "\t\tn(lab3, \"Concatenation: no edge label → parent output appended before your prompt (then \\\"---\\\", then this card).\", commentLeftX(col3), concatCommentY, \"\", TUT_COMMENT_W, TUT_LABEL_H + 12),",
            "lineNumber": 296
          },
          {
            "text": "\t\tn(concatComment, \"I'm input text. My full text is added to the next node's prompt.\", laneNodeX(col3, 0), concatCommentY, cYellow, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 297
          },
          {
            "text": "\t\tn(concatOrange, \"Reply in one word: what did the previous card say?\", laneNodeX(col3, LANE_OFFSET), concatOrangeY, cOrange, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 298
          },
          {
            "text": "\t\tn(concatOut, \"\", laneNodeX(col3, 0), concatOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 299
          },
          {
            "lineNumber": 300
          },
          {
            "text": "\t\t// Column 4",
            "lineNumber": 301
          },
          {
            "text": "\t\tn(lab4, \"Variable injection: put a name on the edge and use {{var:name}} in the prompt; that parent is injected there.\", commentLeftX(col4), injectFirstY, \"\", TUT_COMMENT_W, TUT_LABEL_H + 12),",
            "lineNumber": 302
          },
          {
            "text": "\t\tn(injectFirst, \"Say exactly: Hello world.\", laneNodeX(col4, 0), injectFirstY",
            "lineNumber": 303
          },
          {
            "text": ",",
            "lineNumber": 309
          },
          {
            "text": "\t];",
            "lineNumber": 310
          },
          {
            "text": "}",
            "lineNumber": 323,
            "isSignature": true
          }
        ]
      },
      "score": 0.2526857852935791
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/types.ts",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 12,
            "column": 1
          }
        },
        "contents": "import type {App} from \"obsidian\";\nimport type {ZettelPluginSettings} from \"./settings\";\n\n/** Plugin interface used by views to avoid circular dependency on main. */\nexport interface IZettelThinkingBoardPlugin {\n\tapp: App;\n\tsettings: ZettelPluginSettings;\n\tsaveSettings(): Promise&lt;void&gt;;\n\tgetActiveCanvasView(): { canvas: unknown; file: { path: string } } | null;\n\tgetActiveOrFirstCanvasView(): { canvas: unknown; file: { path: string } } | null;\n\tgetKernelForActiveCanvas(): { onLog?: ((line: string) =&gt; void) | undefined; run(code: string, inputText: string): Promise&lt;string&gt;; terminate(): void } | null;\n\tregisterEvent(ref: unknown): void;\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "import type {App} from \"obsidian\";",
            "lineNumber": 1
          },
          {
            "text": "import type {ZettelPluginSettings} from \"./settings\";",
            "lineNumber": 2
          },
          {
            "lineNumber": 3
          },
          {
            "text": "/** Plugin interface used by views to avoid circular dependency on main. */",
            "lineNumber": 4
          },
          {
            "text": "export interface IZettelThinkingBoardPlugin {",
            "lineNumber": 5,
            "isSignature": true
          },
          {
            "text": "\tapp: App;",
            "lineNumber": 6
          },
          {
            "text": "\tsettings: ZettelPluginSettings;",
            "lineNumber": 7
          },
          {
            "text": "\tsaveSettings(): Promise&lt;void&gt;;",
            "lineNumber": 8
          },
          {
            "text": "\tgetActiveCanvasView(): { canvas: unknown; file: { path: string } } | null;",
            "lineNumber": 9
          },
          {
            "text": "\tgetActiveOrFirstCanvasView(): { canvas: unknown; file: { path: string } } | null;",
            "lineNumber": 10
          },
          {
            "text": "\tgetKernelForActiveCanvas(): { onLog?: ((line: string) =&gt; void) | undefined; run(code: string, inputText: string): Promise&lt;string&gt;; terminate(): void } | null;",
            "lineNumber": 11
          },
          {
            "text": "\tregisterEvent(ref: unknown): void;",
            "lineNumber": 12,
            "isSignature": true
          },
          {
            "text": "}",
            "lineNumber": 13,
            "isSignature": true
          }
        ]
      },
      "score": 0.24736225605010986
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/canvasApi.ts",
        "range": {
          "startPosition": {
            "column": 86
          },
          "endPosition": {
            "line": 17,
            "column": 1
          }
        },
        "contents": "export interface LiveCanvas {\n\tcreateTextNode(options: {\n\t\ttext: string;\n\t\tpos: { x: number; y: number };\n\t\tsize: { width: number; height: number };\n\t\tsave?: boolean;\n\t\tfocus?: boolean;\n\t}): { id: string; x: number; y: number; width: number; height: number; moveTo: (pos: { x: number; y: number }) =&gt; void; resize: (size: { width: number; height: number }) =&gt; void };\n\taddNode(node: unknown): void;\n\trequestSave?: () =&gt; void;\n\tremoveNode?(node: unknown): void;\n\tnodes?: Map&lt;string, unknown&gt; | Iterable&lt;unknown&gt;;\n\t/** If present, used to refresh canvas after edge label updates (Obsidian canvas view). */\n\tsetData?(data: unknown): void;\n\t/** If present, returns current canvas data from the view (used to preserve user edits like node color when saving). */\n\tgetData?(): { nodes: Array&lt;{ id: string; color?: string; x?: number; y?: number; width?: number; height?: number; [k: string]: unknown }&gt;; edges: unknown[] } | undefined;\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "export interface LiveCanvas {",
            "lineNumber": 2,
            "isSignature": true
          },
          {
            "text": "\tcreateTextNode(options: {",
            "lineNumber": 3
          },
          {
            "text": "\t\ttext: string;",
            "lineNumber": 4
          },
          {
            "text": "\t\tpos: { x: number; y: number };",
            "lineNumber": 5
          },
          {
            "text": "\t\tsize: { width: number; height: number };",
            "lineNumber": 6
          },
          {
            "text": "\t\tsave?: boolean;",
            "lineNumber": 7
          },
          {
            "text": "\t\tfocus?: boolean;",
            "lineNumber": 8
          },
          {
            "text": "\t}): { id: string; x: number; y: number; width: number; height: number; moveTo: (pos: { x: number; y: number }) =&gt; void; resize: (size: { width: number; height: number }) =&gt; void };",
            "lineNumber": 9
          },
          {
            "text": "\taddNode(node: unknown): void;",
            "lineNumber": 10
          },
          {
            "text": "\trequestSave?: () =&gt; void;",
            "lineNumber": 11
          },
          {
            "text": "\tremoveNode?(node: unknown): void;",
            "lineNumber": 12
          },
          {
            "text": "\tnodes?: Map&lt;string, unknown&gt; | Iterable&lt;unknown&gt;;",
            "lineNumber": 13
          },
          {
            "text": "\t/** If present, used to refresh canvas after edge label updates (Obsidian canvas view). */",
            "lineNumber": 14
          },
          {
            "text": "\tsetData?(data: unknown): void;",
            "lineNumber": 15
          },
          {
            "text": "\t/** If present, returns current canvas data from the view (used to preserve user edits like node color when saving). */",
            "lineNumber": 16
          },
          {
            "text": "\tgetData?(): { nodes: Array&lt;{ id: string; color?: string; x?: number; y?: number; width?: number; height?: number; [k: string]: unknown }&gt;; edges: unknown[] } | undefined;",
            "lineNumber": 17,
            "isSignature": true
          },
          {
            "text": "}",
            "lineNumber": 18,
            "isSignature": true
          }
        ]
      },
      "score": 0.24357999861240387
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 316
          },
          "endPosition": {
            "line": 436,
            "column": 99
          }
        },
        "contents": "async function runSingleNode(\n\tapp: App,\n\tsettings: ZettelPluginSettings,\n\tcanvasKey: string,\n\tcanvasFilePath: string,\n\tdata: CanvasData,\n\tnodeId: string,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;string&gt; {\n\n\tif (role === \"red\") {\n\t\tconst model = settings.ollamaRedModel || \"llama2\";\n\t\tconst temperature = settings.ollamaRedTemperature ?? DEFAULT_SETTINGS.ollamaRedTemperature;\n\t\tconst start = performance.now();\n\t\tconst result = await ollamaGenerate({\n\t\t\tmodel,\n\t\t\tprompt: fullPrompt,\n\t\t\tstream: false,\n\t\t\toptions: { temperature },\n\t\t});\n\t\tsetNodeDuration(canvasKey, nodeId, performance.now() - start);\n\t\tsetNodeResult(canvasKey, nodeId, result.response);\n\t\tensureOutputNodeAndEdge(data, node, result.response, settings, {\n\t\t\tfullPrompt,\n\t\t\tthinking: result.thinking,\n\t\t});\n\t\tawait updateEdgeLabelsAndSave(app.vault, canvasFilePath, data, nodeId, edgeModes, liveCanvas);\n\t\treturn result.response;\n\t}\n\tif (role === \"blue\") {\n\t\tconst kernel = getKernelForCanvas(canvasKey, settings.pythonPath);\n\t\tconst code = stripPythonCodeFence(template);\n\t\tconst result = await kernel.run(code, concatenatedPart);\n\t\tsetNodeResult(canvasKey, nodeId, result);\n\t\tensureOutputNodeAndEdge(data, node, result, settings);\n\t\tawait updateEdgeLabelsAndSave(app.vault, canvasFilePath, data, nodeId, edgeModes, liveCanvas);\n\t\treturn result;\n\t}\n\treturn \"\";\n}\n\n/** Max horizontal offset (px) for output box collision avoidance; beyond this we allow overlap. */",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 317,
                "column": 1
              },
              "endPosition": {
                "line": 326,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "async function runSingleNode(",
            "lineNumber": 317,
            "isSignature": true
          },
          {
            "text": "\tapp: App,",
            "lineNumber": 318,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 319,
            "isSignature": true
          },
          {
            "text": "\tcanvasKey: string,",
            "lineNumber": 320,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 321,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 322,
            "isSignature": true
          },
          {
            "text": "\tnodeId: string,",
            "lineNumber": 323,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 324,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;string&gt; {",
            "lineNumber": 325,
            "isSignature": true
          },
          {
            "lineNumber": 405
          },
          {
            "text": "\tif (role === \"red\") {",
            "lineNumber": 406
          },
          {
            "text": "\t\tconst model = settings.ollamaRedModel || \"llama2\";",
            "lineNumber": 407
          },
          {
            "text": "\t\tconst temperature = settings.ollamaRedTemperature ?? DEFAULT_SETTINGS.ollamaRedTemperature;",
            "lineNumber": 408
          },
          {
            "text": "\t\tconst start = performance.now();",
            "lineNumber": 409
          },
          {
            "text": "\t\tconst result = await ollamaGenerate({",
            "lineNumber": 410
          },
          {
            "text": "\t\t\tmodel,",
            "lineNumber": 411
          },
          {
            "text": "\t\t\tprompt: fullPrompt,",
            "lineNumber": 412
          },
          {
            "text": "\t\t\tstream: false,",
            "lineNumber": 413
          },
          {
            "text": "\t\t\toptions: { temperature },",
            "lineNumber": 414
          },
          {
            "text": "\t\t});",
            "lineNumber": 415
          },
          {
            "text": "\t\tsetNodeDuration(canvasKey, nodeId, performance.now() - start);",
            "lineNumber": 416
          },
          {
            "text": "\t\tsetNodeResult(canvasKey, nodeId, result.response);",
            "lineNumber": 417
          },
          {
            "text": "\t\tensureOutputNodeAndEdge(data, node, result.response, settings, {",
            "lineNumber": 418
          },
          {
            "text": "\t\t\tfullPrompt,",
            "lineNumber": 419
          },
          {
            "text": "\t\t\tthinking: result.thinking,",
            "lineNumber": 420
          },
          {
            "text": "\t\t});",
            "lineNumber": 421
          },
          {
            "text": "\t\tawait updateEdgeLabelsAndSave(app.vault, canvasFilePath, data, nodeId, edgeModes, liveCanvas);",
            "lineNumber": 422
          },
          {
            "text": "\t\treturn result.response;",
            "lineNumber": 423
          },
          {
            "text": "\t}",
            "lineNumber": 424
          },
          {
            "text": "\tif (role === \"blue\") {",
            "lineNumber": 425
          },
          {
            "text": "\t\tconst kernel = getKernelForCanvas(canvasKey, settings.pythonPath);",
            "lineNumber": 426
          },
          {
            "text": "\t\tconst code = stripPythonCodeFence(template);",
            "lineNumber": 427
          },
          {
            "text": "\t\tconst result = await kernel.run(code, concatenatedPart);",
            "lineNumber": 428
          },
          {
            "text": "\t\tsetNodeResult(canvasKey, nodeId, result);",
            "lineNumber": 429
          },
          {
            "text": "\t\tensureOutputNodeAndEdge(data, node, result, settings);",
            "lineNumber": 430
          },
          {
            "text": "\t\tawait updateEdgeLabelsAndSave(app.vault, canvasFilePath, data, nodeId, edgeModes, liveCanvas);",
            "lineNumber": 431
          },
          {
            "text": "\t\treturn result;",
            "lineNumber": 432
          },
          {
            "text": "\t}",
            "lineNumber": 433
          },
          {
            "text": "\treturn \"\";",
            "lineNumber": 434
          },
          {
            "text": "}",
            "lineNumber": 435,
            "isSignature": true
          },
          {
            "lineNumber": 436
          },
          {
            "text": "/** Max horizontal offset (px) for output box collision avoidance; beyond this we allow overlap. */",
            "lineNumber": 437
          }
        ]
      },
      "score": 0.243129700422287
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 765,
            "column": 1
          },
          "endPosition": {
            "line": 800,
            "column": 93
          }
        },
        "contents": "/** Run a single node (for \"Run Node\" command). If parents are not run, runs chain to this node instead. */\nexport async function runNode(\n\tapp: App,\n\tsettings: ZettelPluginSettings,\n\tcanvasFilePath: string,\n\tnodeId: string,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;{ ok: boolean; message?: string }&gt; {\n\tconst data = await loadCanvasData(app.vault, canvasFilePath);\n\tif (!data) return { ok: false, message: \"Could not load canvas data.\" };\n\tconst node = getNodeById(data, nodeId);\n\tif (!node) return { ok: false, message: \"Node not found.\" };\n\tconst role = getNodeRole(node, settings);\n\tif (!role) return { ok: false, message: \"Node color is not mapped to a role.\" };\n\tif (role === \"green\") return { ok: false, message: \"Green nodes are output-only.\" };\n\tconst parentIds = getParentIdsSortedByY(nodeId, data);\n\tconst canvasKey = getCanvasKey(canvasFilePath);\n\tfor (const pid of parentIds) {\n\t\tif (getNodeResult(canvasKey, pid) == null) {\n\t\t\treturn runChain(app, settings, canvasFilePath, nodeId, liveCanvas);\n\t\t}\n\t}\n\ttry {\n\t\tsetRunningNodeId(canvasKey, nodeId);\n\t\tawait runSingleNode(app, settings, canvasKey, canvasFilePath, data, nodeId, liveCanvas);\n\t\treturn { ok: true };\n\t} catch (e) {\n\t\treturn { ok: false, message: e instanceof Error ? e.message : String(e) };\n\t} finally {\n\t\tsetRunningNodeId(canvasKey, null);\n\t}\n}\n\nconst CYCLE_ERROR_MESSAGE = \"Execution graph contains a cycle; fix connections and try again.\";",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Run a single node (for \"Run Node\" command). If parents are not run, runs chain to this node instead. */",
            "lineNumber": 768
          },
          {
            "text": "export async function runNode(",
            "lineNumber": 769,
            "isSignature": true
          },
          {
            "text": "\tapp: App,",
            "lineNumber": 770,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 771,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 772,
            "isSignature": true
          },
          {
            "text": "\tnodeId: string,",
            "lineNumber": 773,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 774,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;{ ok: boolean; message?: string }&gt; {",
            "lineNumber": 775,
            "isSignature": true
          },
          {
            "text": "\tconst data = await loadCanvasData(app.vault, canvasFilePath);",
            "lineNumber": 776
          },
          {
            "text": "\tif (!data) return { ok: false, message: \"Could not load canvas data.\" };",
            "lineNumber": 777
          },
          {
            "text": "\tconst node = getNodeById(data, nodeId);",
            "lineNumber": 778
          },
          {
            "text": "\tif (!node) return { ok: false, message: \"Node not found.\" };",
            "lineNumber": 779
          },
          {
            "text": "\tconst role = getNodeRole(node, settings);",
            "lineNumber": 780
          },
          {
            "text": "\tif (!role) return { ok: false, message: \"Node color is not mapped to a role.\" };",
            "lineNumber": 781
          },
          {
            "text": "\tif (role === \"green\") return { ok: false, message: \"Green nodes are output-only.\" };",
            "lineNumber": 782
          },
          {
            "text": "\tconst parentIds = getParentIdsSortedByY(nodeId, data);",
            "lineNumber": 783
          },
          {
            "text": "\tconst canvasKey = getCanvasKey(canvasFilePath);",
            "lineNumber": 784
          },
          {
            "text": "\tfor (const pid of parentIds) {",
            "lineNumber": 785
          },
          {
            "text": "\t\tif (getNodeResult(canvasKey, pid) == null) {",
            "lineNumber": 786
          },
          {
            "text": "\t\t\treturn runChain(app, settings, canvasFilePath, nodeId, liveCanvas);",
            "lineNumber": 787
          },
          {
            "text": "\t\t}",
            "lineNumber": 788
          },
          {
            "text": "\t}",
            "lineNumber": 789
          },
          {
            "text": "\ttry {",
            "lineNumber": 790
          },
          {
            "text": "\t\tsetRunningNodeId(canvasKey, nodeId);",
            "lineNumber": 791
          },
          {
            "text": "\t\tawait runSingleNode(app, settings, canvasKey, canvasFilePath, data, nodeId, liveCanvas);",
            "lineNumber": 792
          },
          {
            "text": "\t\treturn { ok: true };",
            "lineNumber": 793
          },
          {
            "text": "\t} catch (e) {",
            "lineNumber": 794
          },
          {
            "text": "\t\treturn { ok: false, message: e instanceof Error ? e.message : String(e) };",
            "lineNumber": 795
          },
          {
            "text": "\t} finally {",
            "lineNumber": 796
          },
          {
            "text": "\t\tsetRunningNodeId(canvasKey, null);",
            "lineNumber": 797
          },
          {
            "text": "\t}",
            "lineNumber": 798
          },
          {
            "text": "}",
            "lineNumber": 799,
            "isSignature": true
          },
          {
            "lineNumber": 800
          },
          {
            "text": "const CYCLE_ERROR_MESSAGE = \"Execution graph contains a cycle; fix connections and try again.\";",
            "lineNumber": 801
          }
        ]
      },
      "score": 0.23622453212738037
    }
  ]
}
```
Status: **completed**


</details>
</tool-use>

---


Inspecting `chooseOutputPositionXY` and how positions are chosen for output/thinking nodes:


---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "chooseOutputPositionXY|chooseFreeSideForAuxiliaryEdge",
  "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "chooseOutputPositionXY|chooseFreeSideForAuxiliaryEdge",
    "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board": {
        "content": {
          "matches": [
            {
              "file": "src/engine/runner.ts",
              "matches": [
                {
                  "lineNumber": 461,
                  "content": "function chooseOutputPositionXY("
                },
                {
                  "lineNumber": 523,
                  "content": "function chooseFreeSideForAuxiliaryEdge(data: CanvasData, sourceNodeId: string): NodeSide {"
                },
                {
                  "lineNumber": 560,
                  "content": "\tconst { x: chosenX, y: chosenY } = chooseOutputPositionXY("
                },
                {
                  "lineNumber": 633,
                  "content": "\t\tconst thinkingSide = chooseFreeSideForAuxiliaryEdge(data, sourceNode.id);"
                },
                {
                  "lineNumber": 636,
                  "content": "\t\tconst { x: tx, y: ty } = chooseOutputPositionXY("
                },
                {
                  "lineNumber": 699,
                  "content": "\t\tconst promptSide = chooseFreeSideForAuxiliaryEdge(data, sourceNode.id);"
                },
                {
                  "lineNumber": 705,
                  "content": "\t\tconst { x: px, y: py } = chooseOutputPositionXY("
                }
              ]
            }
          ],
          "totalLines": 7,
          "totalMatchedLines": 7
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>
</tool-use>

---





---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>
</tool-use>

---


Checking how the output node's default position relates to the source and whether `xOffsets` order explains the behavior:


---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "GREEN_NODE_PADDING",
  "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "GREEN_NODE_PADDING",
    "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board": {
        "content": {
          "matches": [
            {
              "file": "src/canvas/types.test.ts",
              "matches": [
                {
                  "lineNumber": 13,
                  "content": "\tGREEN_NODE_PADDING,"
                },
                {
                  "lineNumber": 265,
                  "content": "\t\tconst greenY = sourceY + 50 + GREEN_NODE_PADDING; // 170"
                },
                {
                  "lineNumber": 327,
                  "content": "describe(\"GREEN_NODE_PADDING\", () =&gt; {"
                },
                {
                  "lineNumber": 329,
                  "content": "\t\texpect(GREEN_NODE_PADDING).toBe(20);"
                }
              ]
            },
            {
              "file": "src/engine/runner.ts",
              "matches": [
                {
                  "lineNumber": 15,
                  "content": "\tGREEN_NODE_PADDING,"
                },
                {
                  "lineNumber": 554,
                  "content": "\tconst defaultY = sourceNode.y + sourceNode.height + GREEN_NODE_PADDING;"
                },
                {
                  "lineNumber": 634,
                  "content": "\t\tconst thinkingDefaultY = outputY - height - GREEN_NODE_PADDING;"
                },
                {
                  "lineNumber": 703,
                  "content": "\t\tconst promptDefaultY = anchorY - height - GREEN_NODE_PADDING;"
                }
              ]
            },
            {
              "file": "src/canvas/nodes.ts",
              "matches": [
                {
                  "lineNumber": 71,
                  "content": "\tGREEN_NODE_PADDING,"
                }
              ]
            },
            {
              "file": "src/canvas/types.ts",
              "matches": [
                {
                  "lineNumber": 139,
                  "content": "export const GREEN_NODE_PADDING = 20;"
                },
                {
                  "lineNumber": 158,
                  "content": "\tconst expectedY = source.y + source.height + GREEN_NODE_PADDING;"
                }
              ]
            }
          ],
          "totalLines": 11,
          "totalMatchedLines": 11
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---


Checking how the prompt node is positioned for consistency:


---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>
</tool-use>

---


Creating a plan for thinking-node collision avoidance and left-side preference.


---

<tool-use data-tool-type="unknown" data-tool-name="create_plan">
<details>
<summary>Tool use: **create_plan**</summary>


Parameters:

```json
{
  "plan": "# Thinking node collision avoidance and left preference\n\n## Current behavior\n\n- **Position:** The thinking node uses [&#96;chooseOutputPositionXY&#96;](src/engine/runner.ts) in [runner.ts](src/engine/runner.ts) with default &#96;(defaultX, thinkingDefaultY)&#96; where &#96;defaultX = sourceNode.x&#96; and &#96;thinkingDefaultY = outputY - height - GREEN_NODE_PADDING&#96; (above the output node, same x as source).\n- **Collision logic:** &#96;chooseOutputPositionXY&#96; (lines 461–497) tries the default, then horizontal offsets via &#96;xOffsets()&#96; (0, +80, -80, +160, -160…), and **only downward** vertical steps (0, 60, 120… up to 400). So:\n  - There is no preference for the **left** of the source (default is centered; horizontal order is 0, right, left).\n  - Vertical search is **down only**; if the area above the output is blocked, it never tries moving the thinking node up or in other directions, which can lead to overlap or poor placement.\n\n## Desired behavior\n\n1. **Prefer left:** Default position for the thinking node should be to the **left** of the source node (e.g. &#96;sourceNode.x - width - GREEN_NODE_PADDING&#96;), vertically aligned with the source (e.g. &#96;sourceNode.y&#96; or vertically centered).\n2. **Collision avoidance in any direction:** If that default overlaps other nodes, try candidate positions in **all directions** (left, right, up, down, and optionally diagonals) with a small step until a non-overlapping spot is found; do not limit to horizontal + down only.\n\n## Implementation plan\n\n### 1. Add a dedicated position chooser for the thinking node\n\nIn [src/engine/runner.ts](src/engine/runner.ts):\n\n- Add a new function, e.g. **&#96;chooseThinkingNodePositionXY&#96;**, that:\n  - Takes &#96;data&#96;, &#96;sourceNodeId&#96;, &#96;thinkingNodeId&#96;, &#96;defaultX&#96;, &#96;defaultY&#96;, &#96;width&#96;, &#96;height&#96;, and &#96;extraExcludeIds&#96;.\n  - Uses the same overlap and exclude rules as &#96;chooseOutputPositionXY&#96;: build an exclude set (source, thinking node if existing, and &#96;extraExcludeIds&#96;), and for each candidate box check against all other nodes with &#96;rectanglesOverlap(box, expanded)&#96; where &#96;expanded&#96; includes &#96;OUTPUT_COLLISION_BUFFER&#96; (reuse existing constant).\n  - Generates candidate positions in **all directions**:\n    - First try &#96;(defaultX, defaultY)&#96;.\n    - Then try offsets &#96;(dx, dy)&#96; in a deterministic order that explores in all directions: e.g. rings of increasing radius (step 60px), or a fixed order like: (0,0), (-step,0), (step,0), (0,-step), (0,step), (-step,-step), (-step,step), (step,-step), (step,step), then (-2*step,0), (2*step,0), … up to a max radius (e.g. 400px). Reuse or define constants (e.g. &#96;AUXILIARY_COLLISION_STEP = 60&#96;, &#96;AUXILIARY_COLLISION_MAX_RADIUS = 400&#96;).\n  - Returns the first &#96;(x, y)&#96; that passes the overlap check, or the default if none found (same fallback as current code).\n\n- Keep **&#96;rectanglesOverlap&#96;** and the buffer logic as-is; no need to change them.\n\n### 2. Use left-of-source default for the thinking node\n\nIn **&#96;ensureOutputNodeAndEdge&#96;** (around lines 631–646):\n\n- For the thinking node only, compute a **left-preferring default**:\n  - &#96;thinkingDefaultX = sourceNode.x - width - GREEN_NODE_PADDING&#96; (left of source).\n  - &#96;thinkingDefaultY = sourceNode.y&#96; (align top with source), or &#96;sourceNode.y + (sourceNode.height - height) / 2&#96; for vertical centering with the source. Choose one (e.g. top-align for simplicity).\n- Call **&#96;chooseThinkingNodePositionXY&#96;** instead of &#96;chooseOutputPositionXY&#96; for the thinking node, passing this default and the same &#96;data&#96;, &#96;sourceNode.id&#96;, &#96;thinkingId&#96;, &#96;width&#96;, &#96;height&#96;, and &#96;thinkingExclude&#96;.\n\n### 3. Edge connection\n\n- **No change** to edge side selection: continue using &#96;chooseFreeSideForAuxiliaryEdge(data, sourceNode.id)&#96;. The preferred order already includes &#96;\"left\"&#96; first, so when the thinking node is placed to the left, the edge will typically attach to the left side of the source if available.\n- Existing edge creation (from source to thinking node with &#96;fromSide&#96;/&#96;toSide&#96;) remains unchanged.\n\n### 4. Scope: thinking node only\n\n- Apply the new logic **only to the thinking node**. The prompt node and the main output node can keep using &#96;chooseOutputPositionXY&#96; unless you later decide to give the prompt node the same “prefer left + all-direction avoidance” behavior.\n\n## Files to change\n\n- **[src/engine/runner.ts](src/engine/runner.ts):**\n  - Add constants for auxiliary collision search (e.g. &#96;AUXILIARY_COLLISION_STEP&#96;, &#96;AUXILIARY_COLLISION_MAX_RADIUS&#96;).\n  - Add &#96;chooseThinkingNodePositionXY&#96; with all-direction candidate generation and same overlap/exclude semantics as &#96;chooseOutputPositionXY&#96;.\n  - In &#96;ensureOutputNodeAndEdge&#96;, for the thinking block: set &#96;thinkingDefaultX&#96; / &#96;thinkingDefaultY&#96; to the left-of-source default and call &#96;chooseThinkingNodePositionXY&#96; instead of &#96;chooseOutputPositionXY&#96;.\n\n## Optional: document in rules\n\nIf this is a recurring UX requirement (e.g. “auxiliary nodes prefer left and must avoid overlap in all directions”), consider adding a short note to [.cursor/rules/plugin-coding.mdc](.cursor/rules/plugin-coding.mdc) so future changes (e.g. prompt node) stay consistent.\n",
  "name": "Thinking node collision avoidance",
  "overview": "Add collision avoidance for the thinking node with a left-of-source default position and candidate search in all directions so it never overlaps other nodes."
}
```
Additional data:

```json
{
  "reviewData": {
    "status": "Requested",
    "selectedOption": "none",
    "isShowingInput": false
  },
  "planUri": "file:///Users/caffae/.cursor/plans/thinking_node_collision_avoidance_deccff7b.plan.md",
  "hasOpenedEditor": true
}
```
Result:

```json
{
  "rejected": {}
}
```
Status: **completed**


</details>
</tool-use>

---

_**User**_

Implement the plan as specified, it is attached for your reference. Do NOT edit the plan file itself.

To-do's from the plan have already been created. Do not create them again. Mark them as in_progress as you work, starting with the first one. Don't stop until you have completed all the to-dos.

---

_**Agent (model default, mode Agent)**_


Implementing the plan: reading runner.ts and locating the sections to change.


---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [-] Add AUXILIARY_COLLISION constants and chooseThinkingNodePositionXY
- [ ] Use left-of-source default and chooseThinkingNodePositionXY for thinking

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>
</tool-use>

---


Adding auxiliary collision constants and the `chooseThinkingNodePositionXY` function.


---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** • Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>

</tool-use>

---





---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** • Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>

</tool-use>

---





---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Add AUXILIARY_COLLISION constants and chooseThinkingNodePositionXY
- [-] Use left-of-source default and chooseThinkingNodePositionXY for thinking

</details>
</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** • Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>

</tool-use>

---





---

<tool-use data-tool-type="unknown" data-tool-name="read_lints">
<details>
<summary>Tool use: **read_lints**</summary>


Parameters:

```json
{
  "paths": [
    "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts"
  ]
}
```
Result:

```json
{
  "linterErrorsByFile": [
    {
      "relativeWorkspacePath": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts"
    }
  ]
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Add AUXILIARY_COLLISION constants and chooseThinkingNodePositionXY
- [x] Use left-of-source default and chooseThinkingNodePositionXY for thinking

</details>
</tool-use>

---


Summary of what was implemented:

**1. Constants and helpers** ([src/engine/runner.ts](src/engine/runner.ts))
- **`AUXILIARY_COLLISION_STEP = 60`** – step between candidate positions for the thinking node.
- **`AUXILIARY_COLLISION_MAX_RADIUS = 400`** – max distance from the default position when searching.
- **`auxiliaryPositionOffsets()`** – generator that yields `(dx, dy)` in ring order: `(0,0)` first, then ring at 60px, then 120px, etc., so all directions (left, right, up, down, diagonals) are tried.
- **`chooseThinkingNodePositionXY(...)`** – same overlap/exclude rules as `chooseOutputPositionXY` (exclude source, thinking node if present, and `extraExcludeIds`; use `OUTPUT_COLLISION_BUFFER`). Tries `(defaultX + dx, defaultY + dy)` for each offset from the generator and returns the first non-overlapping position, or the default if none is found.

**2. Thinking node placement** ([src/engine/runner.ts](src/engine/runner.ts))
- **Default position** is now left of the source: `thinkingDefaultX = sourceNode.x - width - GREEN_NODE_PADDING`, `thinkingDefaultY = sourceNode.y` (top-aligned with source).
- The thinking block calls **`chooseThinkingNodePositionXY`** instead of `chooseOutputPositionXY`, so placement prefers left and then searches in all directions to avoid overlaps.

Edge side selection and creation are unchanged; `chooseFreeSideForAuxiliaryEdge` still prefers `"left"` first, which matches the new default position.

---

