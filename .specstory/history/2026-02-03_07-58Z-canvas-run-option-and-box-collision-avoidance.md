<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session d50d4417-ef0f-4284-9d1b-7047328f0723 (2026-02-03 07:58Z) -->

# Canvas run option and box collision avoidance (2026-02-03 07:58Z)

_**User**_

Add an option to run the entire canvas when I right click on the canvas. 
Also help me work out some collision avoidance to move the output box to the left or right on where there is space so it doesn't overlap with another box. Limit the distance that the collision avoidance can go. So if there is no way to escape a certain radius without overlapping, it will just choose to overlap. 

---

_**Agent (model default, mode Agent)**_


Exploring the codebase to find how the canvas context menu and run flow work and where output positioning is handled.


---

<tool-use data-tool-type="unknown" data-tool-name="semantic_search_full">
<details>
<summary>Tool use: **semantic_search_full**</summary>


Parameters:

```json
{
  "query": "Where is the canvas context menu or right-click menu registered?",
  "includePattern": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
  "topK": 10,
  "explanation": ""
}
```
Result:

```json
{
  "codeResults": [
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 27
          },
          "endPosition": {
            "line": 298,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\nasync onload() {\n\n\n\t\t\t// Canvas node context menu (event name is undocumented; try workspace.on(\"canvas:node-menu\")).\n\t\t\t// Defer registration so Obsidian canvas is ready (avoids \"reading '_'\" in app.js).\n\t\t\tconst addNodeMenuItems = (menu: Menu, node: unknown): void =&gt; {\n\t\t\t\tdebugNodeMenuFired = true;\n\t\t\t\tconst nodeId = resolveCanvasNodeId(node);\n\t\t\t\tif (!nodeId) return;\n\t\t\t\tmenu.addItem((item) =&gt;\n\t\t\t\t\titem.setTitle(\"Run node\").setIcon(\"play\").onClick(() =&gt; this.runNode(nodeId))\n\t\t\t\t);\n\t\t\t\tmenu.addItem((item) =&gt;\n\t\t\t\t\titem.setTitle(\"Run chain\").setIcon(\"forward\").onClick(() =&gt; this.runChain(nodeId))\n\t\t\t\t);\n\t\t\t\tmenu.addItem((item) =&gt;\n\t\t\t\t\titem.setTitle(\"Dismiss output\").setIcon(\"trash\").onClick(() =&gt; this.dismissOutput(nodeId))\n\t\t\t\t);\n\t\t\t};\n\t\t\tconst registerCanvasNodeMenu = () =&gt; {\n\t\t\t\ttry {\n\t\t\t\t\tconst on = this.app.workspace.on.bind(this.app.workspace) as (\n\t\t\t\t\t\tname: string,\n\t\t\t\t\t\tcallback: (menu: Menu, node: unknown) =&gt; void\n\t\t\t\t\t) =&gt; ReturnType&lt;typeof this.app.workspace.on&gt;;\n\t\t\t\t\t// Try documented-style event name first; some Obsidian builds use \"canvas:node-menu\".\n\t\t\t\t\tthis.registerEvent(on(\"canvas:node-menu\", addNodeMenuItems));\n\t\t\t\t\t// Fallback: try hyphenated name in case the app triggers a different event.\n\t\t\t\t\tthis.registerEvent(on(\"canvas-node-menu\", addNodeMenuItems));\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconsole.error(\"Zettel Thinking Board: could not register canvas node menu.\", e);\n\t\t\t\t}\n\t\t\t};\n\t\t\tconst timeoutId = window.setTimeout(registerCanvasNodeMenu, 0);\n\t\t\tthis.register(() =&gt; window.clearTimeout(timeoutId));\n\n\t\t\t// Debug: command to test if we can affect the canvas and if canvas:node-menu ever fires.\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 28,
                "column": 1
              },
              "endPosition": {
                "line": 28,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 28,
                "column": 16
              },
              "endPosition": {
                "line": 29,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 31,
                "column": 2
              },
              "endPosition": {
                "line": 32,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 28,
            "isSignature": true
          },
          {
            "text": "async onload() {",
            "lineNumber": 31
          },
          {
            "lineNumber": 82
          },
          {
            "lineNumber": 83
          },
          {
            "text": "\t\t\t// Canvas node context menu (event name is undocumented; try workspace.on(\"canvas:node-menu\")).",
            "lineNumber": 84
          },
          {
            "text": "\t\t\t// Defer registration so Obsidian canvas is ready (avoids \"reading '_'\" in app.js).",
            "lineNumber": 85
          },
          {
            "text": "\t\t\tconst addNodeMenuItems = (menu: Menu, node: unknown): void =&gt; {",
            "lineNumber": 86
          },
          {
            "text": "\t\t\t\tdebugNodeMenuFired = true;",
            "lineNumber": 87
          },
          {
            "text": "\t\t\t\tconst nodeId = resolveCanvasNodeId(node);",
            "lineNumber": 88
          },
          {
            "text": "\t\t\t\tif (!nodeId) return;",
            "lineNumber": 89
          },
          {
            "text": "\t\t\t\tmenu.addItem((item) =&gt;",
            "lineNumber": 90
          },
          {
            "text": "\t\t\t\t\titem.setTitle(\"Run node\").setIcon(\"play\").onClick(() =&gt; this.runNode(nodeId))",
            "lineNumber": 91
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 92
          },
          {
            "text": "\t\t\t\tmenu.addItem((item) =&gt;",
            "lineNumber": 93
          },
          {
            "text": "\t\t\t\t\titem.setTitle(\"Run chain\").setIcon(\"forward\").onClick(() =&gt; this.runChain(nodeId))",
            "lineNumber": 94
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 95
          },
          {
            "text": "\t\t\t\tmenu.addItem((item) =&gt;",
            "lineNumber": 96
          },
          {
            "text": "\t\t\t\t\titem.setTitle(\"Dismiss output\").setIcon(\"trash\").onClick(() =&gt; this.dismissOutput(nodeId))",
            "lineNumber": 97
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 98
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 99
          },
          {
            "text": "\t\t\tconst registerCanvasNodeMenu = () =&gt; {",
            "lineNumber": 100
          },
          {
            "text": "\t\t\t\ttry {",
            "lineNumber": 101
          },
          {
            "text": "\t\t\t\t\tconst on = this.app.workspace.on.bind(this.app.workspace) as (",
            "lineNumber": 102
          },
          {
            "text": "\t\t\t\t\t\tname: string,",
            "lineNumber": 103
          },
          {
            "text": "\t\t\t\t\t\tcallback: (menu: Menu, node: unknown) =&gt; void",
            "lineNumber": 104
          },
          {
            "text": "\t\t\t\t\t) =&gt; ReturnType&lt;typeof this.app.workspace.on&gt;;",
            "lineNumber": 105
          },
          {
            "text": "\t\t\t\t\t// Try documented-style event name first; some Obsidian builds use \"canvas:node-menu\".",
            "lineNumber": 106
          },
          {
            "text": "\t\t\t\t\tthis.registerEvent(on(\"canvas:node-menu\", addNodeMenuItems));",
            "lineNumber": 107
          },
          {
            "text": "\t\t\t\t\t// Fallback: try hyphenated name in case the app triggers a different event.",
            "lineNumber": 108
          },
          {
            "text": "\t\t\t\t\tthis.registerEvent(on(\"canvas-node-menu\", addNodeMenuItems));",
            "lineNumber": 109
          },
          {
            "text": "\t\t\t\t} catch (e) {",
            "lineNumber": 110
          },
          {
            "text": "\t\t\t\t\tconsole.error(\"Zettel Thinking Board: could not register canvas node menu.\", e);",
            "lineNumber": 111
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 112
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 113
          },
          {
            "text": "\t\t\tconst timeoutId = window.setTimeout(registerCanvasNodeMenu, 0);",
            "lineNumber": 114
          },
          {
            "text": "\t\t\tthis.register(() =&gt; window.clearTimeout(timeoutId));",
            "lineNumber": 115
          },
          {
            "lineNumber": 116
          },
          {
            "text": "\t\t\t// Debug: command to test if we can affect the canvas and if canvas:node-menu ever fires.",
            "lineNumber": 117
          },
          {
            "text": "\t}",
            "lineNumber": 196
          },
          {
            "text": "}",
            "lineNumber": 299,
            "isSignature": true
          }
        ]
      },
      "score": 0.4801805019378662
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 22,
            "column": 1
          },
          "endPosition": {
            "line": 298,
            "column": 1
          }
        },
        "contents": "/** Debug: set to true when canvas:node-menu callback has fired at least once (proves event is received). */\nlet debugNodeMenuFired = false;\n\nexport default class ZettelThinkingBoardPlugin extends Plugin {\n\tsettings: ZettelPluginSettings;\n\n\tasync onload() {\n\t\ttry {\n\t\t\tawait this.loadSettings();\n\t\t\tthis.addSettingTab(new ZettelSettingTab(this.app, this));\n\n\t\t\tthis.registerView(\n\t\t\t\tZETTEL_CONTROLS_VIEW_TYPE,\n\t\t\t\t(leaf: WorkspaceLeaf) =&gt; new ZettelControlsView(leaf, this)\n\t\t\t);\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"open-zettel-controls\",\n\t\t\t\tname: \"Open Zettel Controls\",\n\t\t\t\tcallback: () =&gt; this.activateZettelControls(),\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"run-node\",\n\t\t\t\tname: \"Run node\",\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\t\tif (!view) return false;\n\t\t\t\t\tif (checking) return true;\n\t\t\t\t\t// Command palette: no node selected; prompt user to use context menu\n\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Run node\\\" to run it.\");\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"run-chain\",\n\t\t\t\tname: \"Run chain\",\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\t\tif (!view) return false;\n\t\t\t\t\tif (checking) return true;\n\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Run chain\\\" to run from roots.\");\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"dismiss-output\",\n\t\t\t\tname: \"Dismiss output\",\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\t\tif (!view) return false;\n\t\t\t\t\tif (checking) return true;\n\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Dismiss output\\\" to remove its output.\");\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\t// Canvas node context menu (event name is undocumented; try workspace.on(\"canvas:node-menu\")).\n\t}\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Debug: set to true when canvas:node-menu callback has fired at least once (proves event is received). */",
            "lineNumber": 25
          },
          {
            "text": "let debugNodeMenuFired = false;",
            "lineNumber": 26
          },
          {
            "lineNumber": 27
          },
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 28,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings;",
            "lineNumber": 29
          },
          {
            "lineNumber": 30
          },
          {
            "text": "\tasync onload() {",
            "lineNumber": 31
          },
          {
            "text": "\t\ttry {",
            "lineNumber": 32
          },
          {
            "text": "\t\t\tawait this.loadSettings();",
            "lineNumber": 33
          },
          {
            "text": "\t\t\tthis.addSettingTab(new ZettelSettingTab(this.app, this));",
            "lineNumber": 34
          },
          {
            "lineNumber": 35
          },
          {
            "text": "\t\t\tthis.registerView(",
            "lineNumber": 36
          },
          {
            "text": "\t\t\t\tZETTEL_CONTROLS_VIEW_TYPE,",
            "lineNumber": 37
          },
          {
            "text": "\t\t\t\t(leaf: WorkspaceLeaf) =&gt; new ZettelControlsView(leaf, this)",
            "lineNumber": 38
          },
          {
            "text": "\t\t\t);",
            "lineNumber": 39
          },
          {
            "lineNumber": 40
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 41
          },
          {
            "text": "\t\t\t\tid: \"open-zettel-controls\",",
            "lineNumber": 42
          },
          {
            "text": "\t\t\t\tname: \"Open Zettel Controls\",",
            "lineNumber": 43
          },
          {
            "text": "\t\t\t\tcallback: () =&gt; this.activateZettelControls(),",
            "lineNumber": 44
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 45
          },
          {
            "lineNumber": 46
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 47
          },
          {
            "text": "\t\t\t\tid: \"run-node\",",
            "lineNumber": 48
          },
          {
            "text": "\t\t\t\tname: \"Run node\",",
            "lineNumber": 49
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 50
          },
          {
            "text": "\t\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 51
          },
          {
            "text": "\t\t\t\t\tif (!view) return false;",
            "lineNumber": 52
          },
          {
            "text": "\t\t\t\t\tif (checking) return true;",
            "lineNumber": 53
          },
          {
            "text": "\t\t\t\t\t// Command palette: no node selected; prompt user to use context menu",
            "lineNumber": 54
          },
          {
            "text": "\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Run node\\\" to run it.\");",
            "lineNumber": 55
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 56
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 57
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 58
          },
          {
            "lineNumber": 59
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 60
          },
          {
            "text": "\t\t\t\tid: \"run-chain\",",
            "lineNumber": 61
          },
          {
            "text": "\t\t\t\tname: \"Run chain\",",
            "lineNumber": 62
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 63
          },
          {
            "text": "\t\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 64
          },
          {
            "text": "\t\t\t\t\tif (!view) return false;",
            "lineNumber": 65
          },
          {
            "text": "\t\t\t\t\tif (checking) return true;",
            "lineNumber": 66
          },
          {
            "text": "\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Run chain\\\" to run from roots.\");",
            "lineNumber": 67
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 68
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 69
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 70
          },
          {
            "lineNumber": 71
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 72
          },
          {
            "text": "\t\t\t\tid: \"dismiss-output\",",
            "lineNumber": 73
          },
          {
            "text": "\t\t\t\tname: \"Dismiss output\",",
            "lineNumber": 74
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 75
          },
          {
            "text": "\t\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 76
          },
          {
            "text": "\t\t\t\t\tif (!view) return false;",
            "lineNumber": 77
          },
          {
            "text": "\t\t\t\t\tif (checking) return true;",
            "lineNumber": 78
          },
          {
            "text": "\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Dismiss output\\\" to remove its output.\");",
            "lineNumber": 79
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 80
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 81
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 82
          },
          {
            "lineNumber": 83
          },
          {
            "text": "\t\t\t// Canvas node context menu (event name is undocumented; try workspace.on(\"canvas:node-menu\")).",
            "lineNumber": 84
          },
          {
            "text": "\t}",
            "lineNumber": 196
          },
          {
            "text": "}",
            "lineNumber": 299,
            "isSignature": true
          }
        ]
      },
      "score": 0.41294974088668823
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 27
          },
          "endPosition": {
            "line": 298,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\nasync onload() {\n\n\n\t\t\t// Debug: command to test if we can affect the canvas and if canvas:node-menu ever fires.\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"zettel-debug-canvas-hook\",\n\t\t\t\tname: \"Debug canvas hook\",\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tif (checking) return true;\n\t\t\t\t\tconst canvasActive = this.getActiveCanvasView() != null;\n\t\t\t\t\tconst msg =\n\t\t\t\t\t\t\"Canvas active: \" +\n\t\t\t\t\t\t(canvasActive ? \"yes\" : \"no (focus a canvas first)\") +\n\t\t\t\t\t\t\". Node menu ever fired: \" +\n\t\t\t\t\t\t(debugNodeMenuFired ? \"yes\" : \"no (right-click a node to test).\");\n\t\t\t\t\tnew Notice(msg);\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\t// Terminate kernel when a canvas is closed (one kernel per canvas)\n\t\t\tlet previousCanvasPaths = new Set&lt;string&gt;();\n\t\t\tthis.registerEvent(\n\t\t\t\tthis.app.workspace.on(\"layout-change\", () =&gt; {\n\t\t\t\t\tconst leaves = this.app.workspace.getLeavesOfType(\"canvas\");\n\t\t\t\t\tconst openPaths = new Set&lt;string&gt;();\n\t\t\t\t\tfor (const leaf of leaves) {\n\t\t\t\t\t\tconst v = leaf.view as { file?: { path: string } };\n\t\t\t\t\t\tif (v?.file?.path) openPaths.add(v.file.path);\n\t\t\t\t\t}\n\t\t\t\t\tfor (const path of previousCanvasPaths) {\n\t\t\t\t\t\tif (!openPaths.has(path)) terminateKernel(path);\n\t\t\t\t\t}\n\t\t\t\t\tpreviousCanvasPaths = openPaths;\n\t\t\t\t})\n\t\t\t);\n\n\t\t\t// Floating role labels on canvas: sync when active leaf is a canvas, clear when not\n\t\t\tlet roleLabelsContainerEl: HTMLElement | null = null;\n\t\t\tlet roleLabelsIntervalId: number | null = null;\n\t\t\tconst runSyncLabels = (): void =&gt; {\n\t\t\t\tconst view = this.getActiveCanvasView();\n;\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 28,
                "column": 1
              },
              "endPosition": {
                "line": 28,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 28,
                "column": 16
              },
              "endPosition": {
                "line": 29,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 31,
                "column": 2
              },
              "endPosition": {
                "line": 32,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 28,
            "isSignature": true
          },
          {
            "text": "async onload() {",
            "lineNumber": 31
          },
          {
            "lineNumber": 115
          },
          {
            "lineNumber": 116
          },
          {
            "text": "\t\t\t// Debug: command to test if we can affect the canvas and if canvas:node-menu ever fires.",
            "lineNumber": 117
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 118
          },
          {
            "text": "\t\t\t\tid: \"zettel-debug-canvas-hook\",",
            "lineNumber": 119
          },
          {
            "text": "\t\t\t\tname: \"Debug canvas hook\",",
            "lineNumber": 120
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 121
          },
          {
            "text": "\t\t\t\t\tif (checking) return true;",
            "lineNumber": 122
          },
          {
            "text": "\t\t\t\t\tconst canvasActive = this.getActiveCanvasView() != null;",
            "lineNumber": 123
          },
          {
            "text": "\t\t\t\t\tconst msg =",
            "lineNumber": 124
          },
          {
            "text": "\t\t\t\t\t\t\"Canvas active: \" +",
            "lineNumber": 125
          },
          {
            "text": "\t\t\t\t\t\t(canvasActive ? \"yes\" : \"no (focus a canvas first)\") +",
            "lineNumber": 126
          },
          {
            "text": "\t\t\t\t\t\t\". Node menu ever fired: \" +",
            "lineNumber": 127
          },
          {
            "text": "\t\t\t\t\t\t(debugNodeMenuFired ? \"yes\" : \"no (right-click a node to test).\");",
            "lineNumber": 128
          },
          {
            "text": "\t\t\t\t\tnew Notice(msg);",
            "lineNumber": 129
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 130
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 131
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 132
          },
          {
            "lineNumber": 133
          },
          {
            "text": "\t\t\t// Terminate kernel when a canvas is closed (one kernel per canvas)",
            "lineNumber": 134
          },
          {
            "text": "\t\t\tlet previousCanvasPaths = new Set&lt;string&gt;();",
            "lineNumber": 135
          },
          {
            "text": "\t\t\tthis.registerEvent(",
            "lineNumber": 136
          },
          {
            "text": "\t\t\t\tthis.app.workspace.on(\"layout-change\", () =&gt; {",
            "lineNumber": 137
          },
          {
            "text": "\t\t\t\t\tconst leaves = this.app.workspace.getLeavesOfType(\"canvas\");",
            "lineNumber": 138
          },
          {
            "text": "\t\t\t\t\tconst openPaths = new Set&lt;string&gt;();",
            "lineNumber": 139
          },
          {
            "text": "\t\t\t\t\tfor (const leaf of leaves) {",
            "lineNumber": 140
          },
          {
            "text": "\t\t\t\t\t\tconst v = leaf.view as { file?: { path: string } };",
            "lineNumber": 141
          },
          {
            "text": "\t\t\t\t\t\tif (v?.file?.path) openPaths.add(v.file.path);",
            "lineNumber": 142
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 143
          },
          {
            "text": "\t\t\t\t\tfor (const path of previousCanvasPaths) {",
            "lineNumber": 144
          },
          {
            "text": "\t\t\t\t\t\tif (!openPaths.has(path)) terminateKernel(path);",
            "lineNumber": 145
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 146
          },
          {
            "text": "\t\t\t\t\tpreviousCanvasPaths = openPaths;",
            "lineNumber": 147
          },
          {
            "text": "\t\t\t\t})",
            "lineNumber": 148
          },
          {
            "text": "\t\t\t);",
            "lineNumber": 149
          },
          {
            "lineNumber": 150
          },
          {
            "text": "\t\t\t// Floating role labels on canvas: sync when active leaf is a canvas, clear when not",
            "lineNumber": 151
          },
          {
            "text": "\t\t\tlet roleLabelsContainerEl: HTMLElement | null = null;",
            "lineNumber": 152
          },
          {
            "text": "\t\t\tlet roleLabelsIntervalId: number | null = null;",
            "lineNumber": 153
          },
          {
            "text": "\t\t\tconst runSyncLabels = (): void =&gt; {",
            "lineNumber": 154
          },
          {
            "text": "\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 155
          },
          {
            "text": ";",
            "lineNumber": 189
          },
          {
            "text": "\t}",
            "lineNumber": 196
          },
          {
            "text": "}",
            "lineNumber": 299,
            "isSignature": true
          }
        ]
      },
      "score": 0.349076509475708
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "column": 61
          },
          "endPosition": {
            "line": 24,
            "column": 108
          }
        },
        "contents": "import {DEFAULT_SETTINGS, ZettelPluginSettings, ZettelSettingTab} from \"./settings\";\nimport {ZettelControlsView, ZETTEL_CONTROLS_VIEW_TYPE} from \"./views/ZettelControlsView\";\nimport {dismissOutput as runnerDismissOutput, runChain as runnerRunChain, runNode as runnerRunNode} from \"./engine/runner\";\nimport {\n\tclearCanvasEdgeModeLabels,\n\tclearCanvasLegend,\n\tclearCanvasRoleLabels,\n\tsyncCanvasEdgeModeLabels,\n\tsyncCanvasRoleLabels,\n} from \"./canvas/canvasNodeLabels\";\nimport {getKernelForCanvas, terminateAllKernels, terminateKernel} from \"./engine/kernelManager\";\n\n/** Resolve canvas node id from context-menu payload (shape may vary by Obsidian version). */\nfunction resolveCanvasNodeId(node: unknown): string | undefined {\n\tif (!node || typeof node !== \"object\") return undefined;\n\tconst n = node as Record&lt;string, unknown&gt;;\n\tif (typeof n.id === \"string\") return n.id;\n\tconst inner = n.node as Record&lt;string, unknown&gt; | undefined;\n\tif (inner &amp;&amp; typeof inner.id === \"string\") return inner.id;\n\tconst data = typeof n.getData === \"function\" ? (n.getData as () =&gt; { id?: string })() : undefined;\n\treturn data?.id;\n}\n\n/** Debug: set to true when canvas:node-menu callback has fired at least once (proves event is received). */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "import {DEFAULT_SETTINGS, ZettelPluginSettings, ZettelSettingTab} from \"./settings\";",
            "lineNumber": 2
          },
          {
            "text": "import {ZettelControlsView, ZETTEL_CONTROLS_VIEW_TYPE} from \"./views/ZettelControlsView\";",
            "lineNumber": 3
          },
          {
            "text": "import {dismissOutput as runnerDismissOutput, runChain as runnerRunChain, runNode as runnerRunNode} from \"./engine/runner\";",
            "lineNumber": 4
          },
          {
            "text": "import {",
            "lineNumber": 5
          },
          {
            "text": "\tclearCanvasEdgeModeLabels,",
            "lineNumber": 6
          },
          {
            "text": "\tclearCanvasLegend,",
            "lineNumber": 7
          },
          {
            "text": "\tclearCanvasRoleLabels,",
            "lineNumber": 8
          },
          {
            "text": "\tsyncCanvasEdgeModeLabels,",
            "lineNumber": 9
          },
          {
            "text": "\tsyncCanvasRoleLabels,",
            "lineNumber": 10
          },
          {
            "text": "} from \"./canvas/canvasNodeLabels\";",
            "lineNumber": 11
          },
          {
            "text": "import {getKernelForCanvas, terminateAllKernels, terminateKernel} from \"./engine/kernelManager\";",
            "lineNumber": 12
          },
          {
            "lineNumber": 13
          },
          {
            "text": "/** Resolve canvas node id from context-menu payload (shape may vary by Obsidian version). */",
            "lineNumber": 14
          },
          {
            "text": "function resolveCanvasNodeId(node: unknown): string | undefined {",
            "lineNumber": 15,
            "isSignature": true
          },
          {
            "text": "\tif (!node || typeof node !== \"object\") return undefined;",
            "lineNumber": 16
          },
          {
            "text": "\tconst n = node as Record&lt;string, unknown&gt;;",
            "lineNumber": 17
          },
          {
            "text": "\tif (typeof n.id === \"string\") return n.id;",
            "lineNumber": 18
          },
          {
            "text": "\tconst inner = n.node as Record&lt;string, unknown&gt; | undefined;",
            "lineNumber": 19
          },
          {
            "text": "\tif (inner &amp;&amp; typeof inner.id === \"string\") return inner.id;",
            "lineNumber": 20
          },
          {
            "text": "\tconst data = typeof n.getData === \"function\" ? (n.getData as () =&gt; { id?: string })() : undefined;",
            "lineNumber": 21
          },
          {
            "text": "\treturn data?.id;",
            "lineNumber": 22
          },
          {
            "text": "}",
            "lineNumber": 23,
            "isSignature": true
          },
          {
            "lineNumber": 24
          },
          {
            "text": "/** Debug: set to true when canvas:node-menu callback has fired at least once (proves event is received). */",
            "lineNumber": 25
          }
        ]
      },
      "score": 0.33699071407318115
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 27
          },
          "endPosition": {
            "line": 298,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\nasync onload() {\n\n\t\t\tconst runSyncLabels = (): void =&gt; {\n\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\tif (!view) {\n\t\t\t\t\tif (roleLabelsIntervalId != null) {\n\t\t\t\t\t\tclearInterval(roleLabelsIntervalId);\n\t\t\t\t\t\troleLabelsIntervalId = null;\n\t\t\t\t\t\tdelete (this as unknown as Record&lt;string, unknown&gt;)._roleLabelsIntervalId;\n\t\t\t\t\t}\n\t\t\t\t\tif (roleLabelsContainerEl != null) {\n\t\t\t\t\t\tclearCanvasRoleLabels(roleLabelsContainerEl);\n\t\t\t\t\t\tclearCanvasLegend(roleLabelsContainerEl);\n\t\t\t\t\t\tclearCanvasEdgeModeLabels(roleLabelsContainerEl);\n\t\t\t\t\t\troleLabelsContainerEl = null;\n\t\t\t\t\t}\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tif (roleLabelsContainerEl != null &amp;&amp; roleLabelsContainerEl !== view.containerEl) {\n\t\t\t\t\tclearCanvasRoleLabels(roleLabelsContainerEl);\n\t\t\t\t\tclearCanvasLegend(roleLabelsContainerEl);\n\t\t\t\t\tclearCanvasEdgeModeLabels(roleLabelsContainerEl);\n\t\t\t\t}\n\t\t\t\troleLabelsContainerEl = view.containerEl;\n\t\t\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;\n\t\t\t\tsyncCanvasRoleLabels(this.app.vault, view.file.path, view.containerEl, this.settings, liveCanvas);\n\t\t\t\tsyncCanvasEdgeModeLabels(this.app.vault, view.file.path, view.containerEl, liveCanvas);\n\t\t\t\tif (roleLabelsIntervalId == null) {\n\t\t\t\t\troleLabelsIntervalId = window.setInterval(() =&gt; {\n\t\t\t\t\t\tconst v = this.getActiveCanvasView();\n\t\t\t\t\t\tif (v != null &amp;&amp; v.containerEl === roleLabelsContainerEl) {\n\t\t\t\t\t\t\tsyncCanvasRoleLabels(this.app.vault, v.file.path, v.containerEl, this.settings, v.canvas as import(\"./engine/canvasApi\").LiveCanvas);\n\t\t\t\t\t\t\tsyncCanvasEdgeModeLabels(this.app.vault, v.file.path, v.containerEl, v.canvas as import(\"./engine/canvasApi\").LiveCanvas);\n\t\t\t\t\t\t}\n\t\t\t\t\t}, 2000);\n\t\t\t\t\t(this as unknown as { _roleLabelsIntervalId: number })._roleLabelsIntervalId = roleLabelsIntervalId;\n\t\t\t\t}\n\t\t\t};\n\t\t\tthis.registerEvent(this.app.workspace.on(\"active-leaf-change\", runSyncLabels));\n\t\t\trunSyncLabels();\n\t\t} catch (e) {\n\t\t\tconsole.error(\"Zettel Thinking Board onload error:\", e);\n\t\t\tthrow e;\n\t\t}\n\t}\n\n\tonunload() {\n\t\tterminateAllKernels();\n\t\tconst id = (;\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 28,
                "column": 1
              },
              "endPosition": {
                "line": 28,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 28,
                "column": 16
              },
              "endPosition": {
                "line": 29,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 31,
                "column": 2
              },
              "endPosition": {
                "line": 32,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 28,
            "isSignature": true
          },
          {
            "text": "async onload() {",
            "lineNumber": 31
          },
          {
            "lineNumber": 153
          },
          {
            "text": "\t\t\tconst runSyncLabels = (): void =&gt; {",
            "lineNumber": 154
          },
          {
            "text": "\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 155
          },
          {
            "text": "\t\t\t\tif (!view) {",
            "lineNumber": 156
          },
          {
            "text": "\t\t\t\t\tif (roleLabelsIntervalId != null) {",
            "lineNumber": 157
          },
          {
            "text": "\t\t\t\t\t\tclearInterval(roleLabelsIntervalId);",
            "lineNumber": 158
          },
          {
            "text": "\t\t\t\t\t\troleLabelsIntervalId = null;",
            "lineNumber": 159
          },
          {
            "text": "\t\t\t\t\t\tdelete (this as unknown as Record&lt;string, unknown&gt;)._roleLabelsIntervalId;",
            "lineNumber": 160
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 161
          },
          {
            "text": "\t\t\t\t\tif (roleLabelsContainerEl != null) {",
            "lineNumber": 162
          },
          {
            "text": "\t\t\t\t\t\tclearCanvasRoleLabels(roleLabelsContainerEl);",
            "lineNumber": 163
          },
          {
            "text": "\t\t\t\t\t\tclearCanvasLegend(roleLabelsContainerEl);",
            "lineNumber": 164
          },
          {
            "text": "\t\t\t\t\t\tclearCanvasEdgeModeLabels(roleLabelsContainerEl);",
            "lineNumber": 165
          },
          {
            "text": "\t\t\t\t\t\troleLabelsContainerEl = null;",
            "lineNumber": 166
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 167
          },
          {
            "text": "\t\t\t\t\treturn;",
            "lineNumber": 168
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 169
          },
          {
            "text": "\t\t\t\tif (roleLabelsContainerEl != null &amp;&amp; roleLabelsContainerEl !== view.containerEl) {",
            "lineNumber": 170
          },
          {
            "text": "\t\t\t\t\tclearCanvasRoleLabels(roleLabelsContainerEl);",
            "lineNumber": 171
          },
          {
            "text": "\t\t\t\t\tclearCanvasLegend(roleLabelsContainerEl);",
            "lineNumber": 172
          },
          {
            "text": "\t\t\t\t\tclearCanvasEdgeModeLabels(roleLabelsContainerEl);",
            "lineNumber": 173
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 174
          },
          {
            "text": "\t\t\t\troleLabelsContainerEl = view.containerEl;",
            "lineNumber": 175
          },
          {
            "text": "\t\t\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;",
            "lineNumber": 176
          },
          {
            "text": "\t\t\t\tsyncCanvasRoleLabels(this.app.vault, view.file.path, view.containerEl, this.settings, liveCanvas);",
            "lineNumber": 177
          },
          {
            "text": "\t\t\t\tsyncCanvasEdgeModeLabels(this.app.vault, view.file.path, view.containerEl, liveCanvas);",
            "lineNumber": 178
          },
          {
            "text": "\t\t\t\tif (roleLabelsIntervalId == null) {",
            "lineNumber": 179
          },
          {
            "text": "\t\t\t\t\troleLabelsIntervalId = window.setInterval(() =&gt; {",
            "lineNumber": 180
          },
          {
            "text": "\t\t\t\t\t\tconst v = this.getActiveCanvasView();",
            "lineNumber": 181
          },
          {
            "text": "\t\t\t\t\t\tif (v != null &amp;&amp; v.containerEl === roleLabelsContainerEl) {",
            "lineNumber": 182
          },
          {
            "text": "\t\t\t\t\t\t\tsyncCanvasRoleLabels(this.app.vault, v.file.path, v.containerEl, this.settings, v.canvas as import(\"./engine/canvasApi\").LiveCanvas);",
            "lineNumber": 183
          },
          {
            "text": "\t\t\t\t\t\t\tsyncCanvasEdgeModeLabels(this.app.vault, v.file.path, v.containerEl, v.canvas as import(\"./engine/canvasApi\").LiveCanvas);",
            "lineNumber": 184
          },
          {
            "text": "\t\t\t\t\t\t}",
            "lineNumber": 185
          },
          {
            "text": "\t\t\t\t\t}, 2000);",
            "lineNumber": 186
          },
          {
            "text": "\t\t\t\t\t(this as unknown as { _roleLabelsIntervalId: number })._roleLabelsIntervalId = roleLabelsIntervalId;",
            "lineNumber": 187
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 188
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 189
          },
          {
            "text": "\t\t\tthis.registerEvent(this.app.workspace.on(\"active-leaf-change\", runSyncLabels));",
            "lineNumber": 190
          },
          {
            "text": "\t\t\trunSyncLabels();",
            "lineNumber": 191
          },
          {
            "text": "\t\t} catch (e) {",
            "lineNumber": 192
          },
          {
            "text": "\t\t\tconsole.error(\"Zettel Thinking Board onload error:\", e);",
            "lineNumber": 193
          },
          {
            "text": "\t\t\tthrow e;",
            "lineNumber": 194
          },
          {
            "text": "\t\t}",
            "lineNumber": 195
          },
          {
            "text": "\t}",
            "lineNumber": 196
          },
          {
            "lineNumber": 197
          },
          {
            "text": "\tonunload() {",
            "lineNumber": 198
          },
          {
            "text": "\t\tterminateAllKernels();",
            "lineNumber": 199
          },
          {
            "text": "\t\tconst id = (;",
            "lineNumber": 200
          },
          {
            "text": "\t}",
            "lineNumber": 202
          },
          {
            "text": "}",
            "lineNumber": 299,
            "isSignature": true
          }
        ]
      },
      "score": 0.2631204128265381
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 27
          },
          "endPosition": {
            "line": 298,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\n\n\n\t/** Run a single node (call from context menu with node id). */\n\tasync runNode(nodeId: string): Promise&lt;void&gt; {\n\t\tconst view = this.getActiveCanvasView();\n\t\tif (!view) return;\n\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;\n\t\tconst result = await runnerRunNode(this.app, this.settings, view.file.path, nodeId, liveCanvas);\n\t\tif (!result.ok) new Notice(result.message ?? \"Run node failed.\");\n\t}\n\n\t/** Run chain from roots to the given node (call from context menu with node id). */\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 28,
                "column": 1
              },
              "endPosition": {
                "line": 28,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 28,
                "column": 16
              },
              "endPosition": {
                "line": 29,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 28,
            "isSignature": true
          },
          {
            "lineNumber": 265
          },
          {
            "lineNumber": 266
          },
          {
            "text": "\t/** Run a single node (call from context menu with node id). */",
            "lineNumber": 267
          },
          {
            "text": "\tasync runNode(nodeId: string): Promise&lt;void&gt; {",
            "lineNumber": 268
          },
          {
            "text": "\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 269
          },
          {
            "text": "\t\tif (!view) return;",
            "lineNumber": 270
          },
          {
            "text": "\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;",
            "lineNumber": 271
          },
          {
            "text": "\t\tconst result = await runnerRunNode(this.app, this.settings, view.file.path, nodeId, liveCanvas);",
            "lineNumber": 272
          },
          {
            "text": "\t\tif (!result.ok) new Notice(result.message ?? \"Run node failed.\");",
            "lineNumber": 273
          },
          {
            "text": "\t}",
            "lineNumber": 274
          },
          {
            "lineNumber": 275
          },
          {
            "text": "\t/** Run chain from roots to the given node (call from context menu with node id). */",
            "lineNumber": 276
          },
          {
            "text": "}",
            "lineNumber": 299,
            "isSignature": true
          }
        ]
      },
      "score": 0.24031203985214233
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/types.ts",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 12,
            "column": 1
          }
        },
        "contents": "import type {App} from \"obsidian\";\nimport type {ZettelPluginSettings} from \"./settings\";\n\n/** Plugin interface used by views to avoid circular dependency on main. */\nexport interface IZettelThinkingBoardPlugin {\n\tapp: App;\n\tsettings: ZettelPluginSettings;\n\tsaveSettings(): Promise&lt;void&gt;;\n\tgetActiveCanvasView(): { canvas: unknown; file: { path: string } } | null;\n\tgetActiveOrFirstCanvasView(): { canvas: unknown; file: { path: string } } | null;\n\tgetKernelForActiveCanvas(): { onLog?: ((line: string) =&gt; void) | undefined; run(code: string, inputText: string): Promise&lt;string&gt;; terminate(): void } | null;\n\tregisterEvent(ref: unknown): void;\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "import type {App} from \"obsidian\";",
            "lineNumber": 1
          },
          {
            "text": "import type {ZettelPluginSettings} from \"./settings\";",
            "lineNumber": 2
          },
          {
            "lineNumber": 3
          },
          {
            "text": "/** Plugin interface used by views to avoid circular dependency on main. */",
            "lineNumber": 4
          },
          {
            "text": "export interface IZettelThinkingBoardPlugin {",
            "lineNumber": 5,
            "isSignature": true
          },
          {
            "text": "\tapp: App;",
            "lineNumber": 6
          },
          {
            "text": "\tsettings: ZettelPluginSettings;",
            "lineNumber": 7
          },
          {
            "text": "\tsaveSettings(): Promise&lt;void&gt;;",
            "lineNumber": 8
          },
          {
            "text": "\tgetActiveCanvasView(): { canvas: unknown; file: { path: string } } | null;",
            "lineNumber": 9
          },
          {
            "text": "\tgetActiveOrFirstCanvasView(): { canvas: unknown; file: { path: string } } | null;",
            "lineNumber": 10
          },
          {
            "text": "\tgetKernelForActiveCanvas(): { onLog?: ((line: string) =&gt; void) | undefined; run(code: string, inputText: string): Promise&lt;string&gt;; terminate(): void } | null;",
            "lineNumber": 11
          },
          {
            "text": "\tregisterEvent(ref: unknown): void;",
            "lineNumber": 12,
            "isSignature": true
          },
          {
            "text": "}",
            "lineNumber": 13,
            "isSignature": true
          }
        ]
      },
      "score": 0.23280160129070282
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/kernelManager.ts",
        "range": {
          "startPosition": {
            "column": 49
          },
          "endPosition": {
            "line": 21,
            "column": 1
          }
        },
        "contents": "import {createPythonKernel} from \"./pythonKernel\";\n\n/** One kernel per canvas (key = canvas file path). */\nconst kernels = new Map&lt;string, PythonKernel&gt;();\n\nexport function getKernelForCanvas(canvasKey: string, pythonPath: string): PythonKernel {\n\tlet k = kernels.get(canvasKey);\n\tif (!k) {\n\t\tk = createPythonKernel(pythonPath);\n\t\tkernels.set(canvasKey, k);\n\t}\n\treturn k;\n}\n\nexport function terminateKernel(canvasKey: string): void {\n\tconst k = kernels.get(canvasKey);\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "import {createPythonKernel} from \"./pythonKernel\";",
            "lineNumber": 2
          },
          {
            "lineNumber": 3
          },
          {
            "text": "/** One kernel per canvas (key = canvas file path). */",
            "lineNumber": 4
          },
          {
            "text": "const kernels = new Map&lt;string, PythonKernel&gt;();",
            "lineNumber": 5
          },
          {
            "lineNumber": 6
          },
          {
            "text": "export function getKernelForCanvas(canvasKey: string, pythonPath: string): PythonKernel {",
            "lineNumber": 7,
            "isSignature": true
          },
          {
            "text": "\tlet k = kernels.get(canvasKey);",
            "lineNumber": 8
          },
          {
            "text": "\tif (!k) {",
            "lineNumber": 9
          },
          {
            "text": "\t\tk = createPythonKernel(pythonPath);",
            "lineNumber": 10
          },
          {
            "text": "\t\tkernels.set(canvasKey, k);",
            "lineNumber": 11
          },
          {
            "text": "\t}",
            "lineNumber": 12
          },
          {
            "text": "\treturn k;",
            "lineNumber": 13
          },
          {
            "text": "}",
            "lineNumber": 14,
            "isSignature": true
          },
          {
            "lineNumber": 15
          },
          {
            "text": "export function terminateKernel(canvasKey: string): void {",
            "lineNumber": 16,
            "isSignature": true
          },
          {
            "text": "\tconst k = kernels.get(canvasKey);",
            "lineNumber": 17
          },
          {
            "text": "}",
            "lineNumber": 22,
            "isSignature": true
          }
        ]
      },
      "score": 0.21297000348567963
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 27
          },
          "endPosition": {
            "line": 298,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\n\n\n\t/**\n\t * Returns the active canvas view, or the first open canvas if the active leaf is not a canvas.\n\t * Use this when the user may be focused on the control panel (e.g. Restart kernel button).\n\t */\n\tgetActiveOrFirstCanvasView(): { canvas: unknown; file: { path: string }; containerEl: HTMLElement } | null {\n\t\tconst active = this.getActiveCanvasView();\n\t\tif (active) return active;\n\t\tconst leaves = this.app.workspace.getLeavesOfType(\"canvas\");\n\t\tconst leaf = leaves[0];\n\t\tif (!leaf?.view) return null;\n\t\tconst v = leaf.view as {\n\t\t\tgetViewType?: () =&gt; string;\n\t\t\tcanvas?: unknown;\n\t\t\tfile?: { path: string };\n\t\t\tcontainerEl?: HTMLElement;\n\t\t};\n\t\tif (v.getViewType?.() !== \"canvas\") return null;\n\t\tif (v.canvas == null || v.file == null || !v.containerEl) return null;\n\t\treturn { canvas: v.canvas, file: v.file, containerEl: v.containerEl };\n\t}\n\n\t/** Run a single node (call from context menu with node id). */\n\tasync runNode(nodeId: string): Promise&lt;void&gt; {\n\t\tconst view = this.getActiveCanvasView();\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 28,
                "column": 1
              },
              "endPosition": {
                "line": 28,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 28,
                "column": 16
              },
              "endPosition": {
                "line": 29,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 28,
            "isSignature": true
          },
          {
            "lineNumber": 244
          },
          {
            "lineNumber": 245
          },
          {
            "text": "\t/**",
            "lineNumber": 246
          },
          {
            "text": "\t * Returns the active canvas view, or the first open canvas if the active leaf is not a canvas.",
            "lineNumber": 247
          },
          {
            "text": "\t * Use this when the user may be focused on the control panel (e.g. Restart kernel button).",
            "lineNumber": 248
          },
          {
            "text": "\t */",
            "lineNumber": 249
          },
          {
            "text": "\tgetActiveOrFirstCanvasView(): { canvas: unknown; file: { path: string }; containerEl: HTMLElement } | null {",
            "lineNumber": 250
          },
          {
            "text": "\t\tconst active = this.getActiveCanvasView();",
            "lineNumber": 251
          },
          {
            "text": "\t\tif (active) return active;",
            "lineNumber": 252
          },
          {
            "text": "\t\tconst leaves = this.app.workspace.getLeavesOfType(\"canvas\");",
            "lineNumber": 253
          },
          {
            "text": "\t\tconst leaf = leaves[0];",
            "lineNumber": 254
          },
          {
            "text": "\t\tif (!leaf?.view) return null;",
            "lineNumber": 255
          },
          {
            "text": "\t\tconst v = leaf.view as {",
            "lineNumber": 256
          },
          {
            "text": "\t\t\tgetViewType?: () =&gt; string;",
            "lineNumber": 257
          },
          {
            "text": "\t\t\tcanvas?: unknown;",
            "lineNumber": 258
          },
          {
            "text": "\t\t\tfile?: { path: string };",
            "lineNumber": 259
          },
          {
            "text": "\t\t\tcontainerEl?: HTMLElement;",
            "lineNumber": 260
          },
          {
            "text": "\t\t};",
            "lineNumber": 261
          },
          {
            "text": "\t\tif (v.getViewType?.() !== \"canvas\") return null;",
            "lineNumber": 262
          },
          {
            "text": "\t\tif (v.canvas == null || v.file == null || !v.containerEl) return null;",
            "lineNumber": 263
          },
          {
            "text": "\t\treturn { canvas: v.canvas, file: v.file, containerEl: v.containerEl };",
            "lineNumber": 264
          },
          {
            "text": "\t}",
            "lineNumber": 265
          },
          {
            "lineNumber": 266
          },
          {
            "text": "\t/** Run a single node (call from context menu with node id). */",
            "lineNumber": 267
          },
          {
            "text": "\tasync runNode(nodeId: string): Promise&lt;void&gt; {",
            "lineNumber": 268
          },
          {
            "text": "\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 269
          },
          {
            "text": "\t}",
            "lineNumber": 274
          },
          {
            "text": "}",
            "lineNumber": 299,
            "isSignature": true
          }
        ]
      },
      "score": 0.21179279685020447
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/views/ZettelControlsView.ts",
        "range": {
          "startPosition": {
            "line": 9
          },
          "endPosition": {
            "line": 126,
            "column": 1
          }
        },
        "contents": "export class ZettelControlsView extends ItemView {\n\n\n\tasync onOpen(): Promise&lt;void&gt; {\n\t\tconst el = this.containerEl.createDiv({ cls: \"ztb-controls-container\" });\n\n\t\t// Model mapping (persisted; same as settings)\n\t\tel.createEl(\"h4\", { text: \"Model mapping\", cls: \"ztb-section-title\" });\n\t\tnew Setting(el)\n\t\t\t.setName(\"Model node (primary)\")\n\t\t\t.setDesc(\"Ollama model for primary model nodes\")\n\t\t\t.addText((text) =&gt;\n\t\t\t\ttext\n\t\t\t\t\t.setPlaceholder(\"e.g. llama2\")\n\t\t\t\t\t.setValue(this.plugin.settings.ollamaOrangeModel)\n\t\t\t\t\t.onChange(async (value) =&gt; {\n\t\t\t\t\t\tthis.plugin.settings.ollamaOrangeModel = value;\n\t\t\t\t\t\tawait this.plugin.saveSettings();\n\t\t\t\t\t})\n\t\t\t);\n\t\tnew Setting(el)\n\t\t\t.setName(\"Model node (secondary)\")\n\t\t\t.setDesc(\"Ollama model for secondary model nodes\")\n\t\t\t.addText((text) =&gt;\n\t\t\t\ttext\n\t\t\t\t\t.setPlaceholder(\"e.g. mistral\")\n\t\t\t\t\t.setValue(this.plugin.settings.ollamaPurpleModel)\n\t\t\t\t\t.onChange(async (value) =&gt; {\n\t\t\t\t\t\tthis.plugin.settings.ollamaPurpleModel = value;\n\t\t\t\t\t\tawait this.plugin.saveSettings();\n\t\t\t\t\t})\n\t\t\t);\n\n\t\t// Kernel controls\n\t\tel.createEl(\"h4\", { text: \"Kernel controls\", cls: \"ztb-section-title\" });\n\t\tnew Setting(el)\n\t\t\t.setName(\"Restart Python kernel\")\n\t\t\t.setDesc(\"Restart the kernel for the active canvas\")\n\t\t\t.addButton((btn) =&gt;\n\t\t\t\tbtn.setButtonText(\"Restart kernel\").onClick(() =&gt; {\n\t\t\t\t\tconst view = this.plugin.getActiveOrFirstCanvasView();\n\t\t\t\t\tif (!view) {\n\t\t\t\t\t\tnew Notice(\"Open a canvas first.\");\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tterminateKernel(view.file.path);\n\t\t\t\t\tnew Notice(\"Kernel restarted for this canvas.\");\n\t\t\t\t})\n\t\t\t);\n\n\t\t// Environment variables (in-memory only)\n\t\tel.createEl(\"h4\", { text: \"Environment variables\", cls: \"ztb-section-title\" });\n\t\tconst envDesc = el.createEl(\"p\", { cls: \"ztb-env-desc\" });\n\t\tenvDesc.setText(\"Key-value pairs for Python (not persisted).\");\n\t\tconst envList = el.createDiv({ cls: \"ztb-env-list\" });\n\t\tconst addEnvRow = (key = \"\", value = \"\") =&gt; {\n\t\t\tconst row = envList.createDiv({ cls: \"ztb-env-row\" });\n;\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 10,
                "column": 1
              },
              "endPosition": {
                "line": 10,
                "column": 8
              }
            },
            {
              "startPosition": {
                "line": 10,
                "column": 8
              },
              "endPosition": {
                "line": 11,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export class ZettelControlsView extends ItemView {",
            "lineNumber": 10,
            "isSignature": true
          },
          {
            "lineNumber": 25
          },
          {
            "lineNumber": 26
          },
          {
            "text": "\tasync onOpen(): Promise&lt;void&gt; {",
            "lineNumber": 27
          },
          {
            "text": "\t\tconst el = this.containerEl.createDiv({ cls: \"ztb-controls-container\" });",
            "lineNumber": 28
          },
          {
            "lineNumber": 29
          },
          {
            "text": "\t\t// Model mapping (persisted; same as settings)",
            "lineNumber": 30
          },
          {
            "text": "\t\tel.createEl(\"h4\", { text: \"Model mapping\", cls: \"ztb-section-title\" });",
            "lineNumber": 31
          },
          {
            "text": "\t\tnew Setting(el)",
            "lineNumber": 32
          },
          {
            "text": "\t\t\t.setName(\"Model node (primary)\")",
            "lineNumber": 33
          },
          {
            "text": "\t\t\t.setDesc(\"Ollama model for primary model nodes\")",
            "lineNumber": 34
          },
          {
            "text": "\t\t\t.addText((text) =&gt;",
            "lineNumber": 35
          },
          {
            "text": "\t\t\t\ttext",
            "lineNumber": 36
          },
          {
            "text": "\t\t\t\t\t.setPlaceholder(\"e.g. llama2\")",
            "lineNumber": 37
          },
          {
            "text": "\t\t\t\t\t.setValue(this.plugin.settings.ollamaOrangeModel)",
            "lineNumber": 38
          },
          {
            "text": "\t\t\t\t\t.onChange(async (value) =&gt; {",
            "lineNumber": 39
          },
          {
            "text": "\t\t\t\t\t\tthis.plugin.settings.ollamaOrangeModel = value;",
            "lineNumber": 40
          },
          {
            "text": "\t\t\t\t\t\tawait this.plugin.saveSettings();",
            "lineNumber": 41
          },
          {
            "text": "\t\t\t\t\t})",
            "lineNumber": 42
          },
          {
            "text": "\t\t\t);",
            "lineNumber": 43
          },
          {
            "text": "\t\tnew Setting(el)",
            "lineNumber": 44
          },
          {
            "text": "\t\t\t.setName(\"Model node (secondary)\")",
            "lineNumber": 45
          },
          {
            "text": "\t\t\t.setDesc(\"Ollama model for secondary model nodes\")",
            "lineNumber": 46
          },
          {
            "text": "\t\t\t.addText((text) =&gt;",
            "lineNumber": 47
          },
          {
            "text": "\t\t\t\ttext",
            "lineNumber": 48
          },
          {
            "text": "\t\t\t\t\t.setPlaceholder(\"e.g. mistral\")",
            "lineNumber": 49
          },
          {
            "text": "\t\t\t\t\t.setValue(this.plugin.settings.ollamaPurpleModel)",
            "lineNumber": 50
          },
          {
            "text": "\t\t\t\t\t.onChange(async (value) =&gt; {",
            "lineNumber": 51
          },
          {
            "text": "\t\t\t\t\t\tthis.plugin.settings.ollamaPurpleModel = value;",
            "lineNumber": 52
          },
          {
            "text": "\t\t\t\t\t\tawait this.plugin.saveSettings();",
            "lineNumber": 53
          },
          {
            "text": "\t\t\t\t\t})",
            "lineNumber": 54
          },
          {
            "text": "\t\t\t);",
            "lineNumber": 55
          },
          {
            "lineNumber": 56
          },
          {
            "text": "\t\t// Kernel controls",
            "lineNumber": 57
          },
          {
            "text": "\t\tel.createEl(\"h4\", { text: \"Kernel controls\", cls: \"ztb-section-title\" });",
            "lineNumber": 58
          },
          {
            "text": "\t\tnew Setting(el)",
            "lineNumber": 59
          },
          {
            "text": "\t\t\t.setName(\"Restart Python kernel\")",
            "lineNumber": 60
          },
          {
            "text": "\t\t\t.setDesc(\"Restart the kernel for the active canvas\")",
            "lineNumber": 61
          },
          {
            "text": "\t\t\t.addButton((btn) =&gt;",
            "lineNumber": 62
          },
          {
            "text": "\t\t\t\tbtn.setButtonText(\"Restart kernel\").onClick(() =&gt; {",
            "lineNumber": 63
          },
          {
            "text": "\t\t\t\t\tconst view = this.plugin.getActiveOrFirstCanvasView();",
            "lineNumber": 64
          },
          {
            "text": "\t\t\t\t\tif (!view) {",
            "lineNumber": 65
          },
          {
            "text": "\t\t\t\t\t\tnew Notice(\"Open a canvas first.\");",
            "lineNumber": 66
          },
          {
            "text": "\t\t\t\t\t\treturn;",
            "lineNumber": 67
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 68
          },
          {
            "text": "\t\t\t\t\tterminateKernel(view.file.path);",
            "lineNumber": 69
          },
          {
            "text": "\t\t\t\t\tnew Notice(\"Kernel restarted for this canvas.\");",
            "lineNumber": 70
          },
          {
            "text": "\t\t\t\t})",
            "lineNumber": 71
          },
          {
            "text": "\t\t\t);",
            "lineNumber": 72
          },
          {
            "lineNumber": 73
          },
          {
            "text": "\t\t// Environment variables (in-memory only)",
            "lineNumber": 74
          },
          {
            "text": "\t\tel.createEl(\"h4\", { text: \"Environment variables\", cls: \"ztb-section-title\" });",
            "lineNumber": 75
          },
          {
            "text": "\t\tconst envDesc = el.createEl(\"p\", { cls: \"ztb-env-desc\" });",
            "lineNumber": 76
          },
          {
            "text": "\t\tenvDesc.setText(\"Key-value pairs for Python (not persisted).\");",
            "lineNumber": 77
          },
          {
            "text": "\t\tconst envList = el.createDiv({ cls: \"ztb-env-list\" });",
            "lineNumber": 78
          },
          {
            "text": "\t\tconst addEnvRow = (key = \"\", value = \"\") =&gt; {",
            "lineNumber": 79
          },
          {
            "text": "\t\t\tconst row = envList.createDiv({ cls: \"ztb-env-row\" });",
            "lineNumber": 80
          },
          {
            "text": ";",
            "lineNumber": 98
          },
          {
            "text": "\t}",
            "lineNumber": 122
          },
          {
            "text": "}",
            "lineNumber": 127,
            "isSignature": true
          }
        ]
      },
      "score": 0.2109147012233734
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 27
          },
          "endPosition": {
            "line": 298,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\n\n\n\t/** Run chain from roots to the given node (call from context menu with node id). */\n\tasync runChain(nodeId: string): Promise&lt;void&gt; {\n\t\tconst view = this.getActiveCanvasView();\n\t\tif (!view) return;\n\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;\n\t\tconst result = await runnerRunChain(this.app, this.settings, view.file.path, nodeId, liveCanvas);\n\t\tif (!result.ok) new Notice(result.message ?? \"Run chain failed.\");\n\t}\n\n\t/** Dismiss the Green output node for the given source node (call from context menu with node id). */\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 28,
                "column": 1
              },
              "endPosition": {
                "line": 28,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 28,
                "column": 16
              },
              "endPosition": {
                "line": 29,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 28,
            "isSignature": true
          },
          {
            "lineNumber": 274
          },
          {
            "lineNumber": 275
          },
          {
            "text": "\t/** Run chain from roots to the given node (call from context menu with node id). */",
            "lineNumber": 276
          },
          {
            "text": "\tasync runChain(nodeId: string): Promise&lt;void&gt; {",
            "lineNumber": 277
          },
          {
            "text": "\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 278
          },
          {
            "text": "\t\tif (!view) return;",
            "lineNumber": 279
          },
          {
            "text": "\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;",
            "lineNumber": 280
          },
          {
            "text": "\t\tconst result = await runnerRunChain(this.app, this.settings, view.file.path, nodeId, liveCanvas);",
            "lineNumber": 281
          },
          {
            "text": "\t\tif (!result.ok) new Notice(result.message ?? \"Run chain failed.\");",
            "lineNumber": 282
          },
          {
            "text": "\t}",
            "lineNumber": 283
          },
          {
            "lineNumber": 284
          },
          {
            "text": "\t/** Dismiss the Green output node for the given source node (call from context menu with node id). */",
            "lineNumber": 285
          },
          {
            "text": "}",
            "lineNumber": 299,
            "isSignature": true
          }
        ]
      },
      "score": 0.20915040373802185
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 27
          },
          "endPosition": {
            "line": 298,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\n\n\n\t/** Returns the active canvas view if the active leaf is a canvas. */\n\tgetActiveCanvasView(): { canvas: unknown; file: { path: string }; containerEl: HTMLElement } | null {\n\t\tconst leaf = this.app.workspace.activeLeaf;\n\t\tif (!leaf?.view) return null;\n\t\tconst v = leaf.view as {\n\t\t\tgetViewType?: () =&gt; string;\n\t\t\tcanvas?: unknown;\n\t\t\tfile?: { path: string };\n\t\t\tcontainerEl?: HTMLElement;\n\t\t};\n\t\tif (v.getViewType?.() !== \"canvas\") return null;\n\t\tif (v.canvas == null || v.file == null || !v.containerEl) return null;\n\t\treturn { canvas: v.canvas, file: v.file, containerEl: v.containerEl };\n\t}\n\n\t/**\n\t * Returns the active canvas view, or the first open canvas if the active leaf is not a canvas.\n\t * Use this when the user may be focused on the control panel (e.g. Restart kernel button).\n\t */\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 28,
                "column": 1
              },
              "endPosition": {
                "line": 28,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 28,
                "column": 16
              },
              "endPosition": {
                "line": 29,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 28,
            "isSignature": true
          },
          {
            "lineNumber": 229
          },
          {
            "lineNumber": 230
          },
          {
            "text": "\t/** Returns the active canvas view if the active leaf is a canvas. */",
            "lineNumber": 231
          },
          {
            "text": "\tgetActiveCanvasView(): { canvas: unknown; file: { path: string }; containerEl: HTMLElement } | null {",
            "lineNumber": 232
          },
          {
            "text": "\t\tconst leaf = this.app.workspace.activeLeaf;",
            "lineNumber": 233
          },
          {
            "text": "\t\tif (!leaf?.view) return null;",
            "lineNumber": 234
          },
          {
            "text": "\t\tconst v = leaf.view as {",
            "lineNumber": 235
          },
          {
            "text": "\t\t\tgetViewType?: () =&gt; string;",
            "lineNumber": 236
          },
          {
            "text": "\t\t\tcanvas?: unknown;",
            "lineNumber": 237
          },
          {
            "text": "\t\t\tfile?: { path: string };",
            "lineNumber": 238
          },
          {
            "text": "\t\t\tcontainerEl?: HTMLElement;",
            "lineNumber": 239
          },
          {
            "text": "\t\t};",
            "lineNumber": 240
          },
          {
            "text": "\t\tif (v.getViewType?.() !== \"canvas\") return null;",
            "lineNumber": 241
          },
          {
            "text": "\t\tif (v.canvas == null || v.file == null || !v.containerEl) return null;",
            "lineNumber": 242
          },
          {
            "text": "\t\treturn { canvas: v.canvas, file: v.file, containerEl: v.containerEl };",
            "lineNumber": 243
          },
          {
            "text": "\t}",
            "lineNumber": 244
          },
          {
            "lineNumber": 245
          },
          {
            "text": "\t/**",
            "lineNumber": 246
          },
          {
            "text": "\t * Returns the active canvas view, or the first open canvas if the active leaf is not a canvas.",
            "lineNumber": 247
          },
          {
            "text": "\t * Use this when the user may be focused on the control panel (e.g. Restart kernel button).",
            "lineNumber": 248
          },
          {
            "text": "\t */",
            "lineNumber": 249
          },
          {
            "text": "}",
            "lineNumber": 299,
            "isSignature": true
          }
        ]
      },
      "score": 0.20580065250396729
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/views/ZettelControlsView.ts",
        "range": {
          "startPosition": {
            "line": 9
          },
          "endPosition": {
            "line": 126,
            "column": 1
          }
        },
        "contents": "export class ZettelControlsView extends ItemView {\nasync onOpen(): Promise&lt;void&gt; {\n\n\t\tconst addEnvRow = (key = \"\", value = \"\") =&gt; {\n\t\t\tconst row = envList.createDiv({ cls: \"ztb-env-row\" });\n\t\t\tconst keyInp = row.createEl(\"input\", { type: \"text\", cls: \"ztb-env-key\" });\n\t\t\tkeyInp.placeholder = \"KEY\";\n\t\t\tkeyInp.value = key;\n\t\t\tconst valInp = row.createEl(\"input\", { type: \"text\", cls: \"ztb-env-val\" });\n\t\t\tvalInp.placeholder = \"value\";\n\t\t\tvalInp.value = value;\n\t\t\tkeyInp.addEventListener(\"change\", () =&gt; {\n\t\t\t\tif (key) delete envVars[key];\n\t\t\t\tenvVars[keyInp.value.trim()] = valInp.value.trim();\n\t\t\t});\n\t\t\tvalInp.addEventListener(\"change\", () =&gt; {\n\t\t\t\tenvVars[keyInp.value.trim()] = valInp.value.trim();\n\t\t\t});\n\t\t\trow.createEl(\"button\", { text: \"Remove\", cls: \"ztb-env-remove\" }).addEventListener(\"click\", () =&gt; {\n\t\t\t\tdelete envVars[keyInp.value.trim()];\n\t\t\t\trow.remove();\n\t\t\t});\n\t\t};\n\t\tfor (const [k, v] of Object.entries(envVars)) addEnvRow(k, v);\n\t\tconst addBtn = el.createEl(\"button\", { text: \"Add variable\", cls: \"ztb-env-add\" });\n\t\taddBtn.addEventListener(\"click\", () =&gt; addEnvRow());\n\n\t\t// Console (obsidian_log output)\n\t\tel.createEl(\"h4\", { text: \"Console\", cls: \"ztb-section-title\" });\n\t\tconst consoleEl = el.createDiv({ cls: \"ztb-console\" });\n\t\tconst appendLog = (line: string) =&gt; {\n\t\t\tconst p = consoleEl.createEl(\"p\", { cls: \"ztb-console-line\" });\n\t\t\tp.setText(line);\n\t\t\tconsoleEl.scrollTop = consoleEl.scrollHeight;\n\t\t};\n\n\t\tconst wireKernelLog = () =&gt; {\n\t\t\tconst kernel = this.plugin.getKernelForActiveCanvas();\n\t\t\tif (kernel) kernel.onLog = (line: string) =&gt; {\n\t\t\t\tif (this.containerEl.isConnected) appendLog(line);\n\t\t\t};\n\t\t};\n\t\twireKernelLog();\n\t\tthis.plugin.registerEvent(\n\t\t\tthis.plugin.app.workspace.on(\"active-leaf-change\", wireKernelLog)\n\t\t);\n\t}\n\n\tasync onClose(): Promise&lt;void&gt; {\n\t\tthis.containerEl.empty();\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 10,
                "column": 1
              },
              "endPosition": {
                "line": 10,
                "column": 8
              }
            },
            {
              "startPosition": {
                "line": 10,
                "column": 8
              },
              "endPosition": {
                "line": 11,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 27,
                "column": 2
              },
              "endPosition": {
                "line": 28,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export class ZettelControlsView extends ItemView {",
            "lineNumber": 10,
            "isSignature": true
          },
          {
            "text": "async onOpen(): Promise&lt;void&gt; {",
            "lineNumber": 27
          },
          {
            "lineNumber": 78
          },
          {
            "text": "\t\tconst addEnvRow = (key = \"\", value = \"\") =&gt; {",
            "lineNumber": 79
          },
          {
            "text": "\t\t\tconst row = envList.createDiv({ cls: \"ztb-env-row\" });",
            "lineNumber": 80
          },
          {
            "text": "\t\t\tconst keyInp = row.createEl(\"input\", { type: \"text\", cls: \"ztb-env-key\" });",
            "lineNumber": 81
          },
          {
            "text": "\t\t\tkeyInp.placeholder = \"KEY\";",
            "lineNumber": 82
          },
          {
            "text": "\t\t\tkeyInp.value = key;",
            "lineNumber": 83
          },
          {
            "text": "\t\t\tconst valInp = row.createEl(\"input\", { type: \"text\", cls: \"ztb-env-val\" });",
            "lineNumber": 84
          },
          {
            "text": "\t\t\tvalInp.placeholder = \"value\";",
            "lineNumber": 85
          },
          {
            "text": "\t\t\tvalInp.value = value;",
            "lineNumber": 86
          },
          {
            "text": "\t\t\tkeyInp.addEventListener(\"change\", () =&gt; {",
            "lineNumber": 87
          },
          {
            "text": "\t\t\t\tif (key) delete envVars[key];",
            "lineNumber": 88
          },
          {
            "text": "\t\t\t\tenvVars[keyInp.value.trim()] = valInp.value.trim();",
            "lineNumber": 89
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 90
          },
          {
            "text": "\t\t\tvalInp.addEventListener(\"change\", () =&gt; {",
            "lineNumber": 91
          },
          {
            "text": "\t\t\t\tenvVars[keyInp.value.trim()] = valInp.value.trim();",
            "lineNumber": 92
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 93
          },
          {
            "text": "\t\t\trow.createEl(\"button\", { text: \"Remove\", cls: \"ztb-env-remove\" }).addEventListener(\"click\", () =&gt; {",
            "lineNumber": 94
          },
          {
            "text": "\t\t\t\tdelete envVars[keyInp.value.trim()];",
            "lineNumber": 95
          },
          {
            "text": "\t\t\t\trow.remove();",
            "lineNumber": 96
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 97
          },
          {
            "text": "\t\t};",
            "lineNumber": 98
          },
          {
            "text": "\t\tfor (const [k, v] of Object.entries(envVars)) addEnvRow(k, v);",
            "lineNumber": 99
          },
          {
            "text": "\t\tconst addBtn = el.createEl(\"button\", { text: \"Add variable\", cls: \"ztb-env-add\" });",
            "lineNumber": 100
          },
          {
            "text": "\t\taddBtn.addEventListener(\"click\", () =&gt; addEnvRow());",
            "lineNumber": 101
          },
          {
            "lineNumber": 102
          },
          {
            "text": "\t\t// Console (obsidian_log output)",
            "lineNumber": 103
          },
          {
            "text": "\t\tel.createEl(\"h4\", { text: \"Console\", cls: \"ztb-section-title\" });",
            "lineNumber": 104
          },
          {
            "text": "\t\tconst consoleEl = el.createDiv({ cls: \"ztb-console\" });",
            "lineNumber": 105
          },
          {
            "text": "\t\tconst appendLog = (line: string) =&gt; {",
            "lineNumber": 106
          },
          {
            "text": "\t\t\tconst p = consoleEl.createEl(\"p\", { cls: \"ztb-console-line\" });",
            "lineNumber": 107
          },
          {
            "text": "\t\t\tp.setText(line);",
            "lineNumber": 108
          },
          {
            "text": "\t\t\tconsoleEl.scrollTop = consoleEl.scrollHeight;",
            "lineNumber": 109
          },
          {
            "text": "\t\t};",
            "lineNumber": 110
          },
          {
            "lineNumber": 111
          },
          {
            "text": "\t\tconst wireKernelLog = () =&gt; {",
            "lineNumber": 112
          },
          {
            "text": "\t\t\tconst kernel = this.plugin.getKernelForActiveCanvas();",
            "lineNumber": 113
          },
          {
            "text": "\t\t\tif (kernel) kernel.onLog = (line: string) =&gt; {",
            "lineNumber": 114
          },
          {
            "text": "\t\t\t\tif (this.containerEl.isConnected) appendLog(line);",
            "lineNumber": 115
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 116
          },
          {
            "text": "\t\t};",
            "lineNumber": 117
          },
          {
            "text": "\t\twireKernelLog();",
            "lineNumber": 118
          },
          {
            "text": "\t\tthis.plugin.registerEvent(",
            "lineNumber": 119
          },
          {
            "text": "\t\t\tthis.plugin.app.workspace.on(\"active-leaf-change\", wireKernelLog)",
            "lineNumber": 120
          },
          {
            "text": "\t\t);",
            "lineNumber": 121
          },
          {
            "text": "\t}",
            "lineNumber": 122
          },
          {
            "lineNumber": 123
          },
          {
            "text": "\tasync onClose(): Promise&lt;void&gt; {",
            "lineNumber": 124
          },
          {
            "text": "\t\tthis.containerEl.empty();",
            "lineNumber": 125
          },
          {
            "text": "\t}",
            "lineNumber": 126
          },
          {
            "text": "}",
            "lineNumber": 127,
            "isSignature": true
          }
        ]
      },
      "score": 0.2043088972568512
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/settings.ts",
        "range": {
          "startPosition": {
            "line": 175
          },
          "endPosition": {
            "line": 312,
            "column": 1
          }
        },
        "contents": "export class ZettelSettingTab extends PluginSettingTab {\n\n\n\tdisplay(): void {\n\t\tconst {containerEl} = this;\n\t\tcontainerEl.empty();\n\t\tconst s = this.plugin.settings;\n\n\t\t// How to run: one-line hint (per UX suggestion)\n\t\tconst hint = containerEl.createDiv({ cls: \"ztb-settings-hint setting-item-description\" });\n\t\thint.setText(\"Right-click a node on the canvas and choose Run node or Run chain.\");\n\n\t\t// Execution: what runs (primary model, secondary model, Python path)\n\t\tconst executionSection = containerEl.createDiv({ cls: \"ztb-settings-section\" });\n\t\texecutionSection.createEl(\"h4\", { text: \"Execution\", cls: \"ztb-section-title\" });\n\t\tconst ollamaContainer = executionSection.createDiv({ cls: \"ztb-ollama-settings\" });\n\t\tconst loadingEl = ollamaContainer.createDiv({ cls: \"ztb-ollama-loading\" });\n\t\tloadingEl.setText(\"Loading Ollama models\");\n\t\t(async () =&gt; {\n\t\t\tconst models = await fetchOllamaModels();\n\t\t\tloadingEl.remove();\n\t\t\tif (models.length === 0) {\n\t\t\t\tconst fallback = ollamaContainer.createDiv({ cls: \"ztb-ollama-fallback\" });\n\t\t\t\tfallback.createEl(\"p\", { text: \"Ollama not reachable or no models. Enter model names manually.\" });\n\t\t\t\tnew Setting(ollamaContainer)\n\t\t\t\t\t.setName(\"Model node (primary)\")\n\t\t\t\t\t.setDesc(\"Ollama model used when you run a primary model node (e.g. llama2)\")\n\t\t\t\t\t.addText((text) =&gt; text\n\t\t\t\t\t\t.setPlaceholder(\"e.g. llama2\")\n\t\t\t\t\t\t.setValue(s.ollamaOrangeModel)\n\t\t\t\t\t\t.onChange(async (value) =&gt; {\n\t\t\t\t\t\t\tthis.plugin.settings.ollamaOrangeModel = value;\n\t\t\t\t\t\t\tawait this.plugin.saveSettings();\n\t\t\t\t\t\t}));\n\t\t\t\tnew Setting(ollamaContainer)\n\t\t\t\t\t.setName(\"Model node (secondary)\")\n\t\t\t\t\t.setDesc(\"Ollama model used when you run a secondary model node\")\n\t\t\t\t\t.addText((text) =&gt; text\n\t\t\t\t\t\t.setPlaceholder(\"e.g. mistral\")\n\t\t\t\t\t\t.setValue(s.ollamaPurpleModel)\n\t\t\t\t\t\t.onChange(async (value) =&gt; {\n\t\t\t\t\t\t\ts.ollamaPurpleModel = value;\n\t\t\t\t\t\t\tawait this.plugin.saveSettings();\n\t\t\t\t\t\t}));\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tnew Setting(ollamaContainer)\n\t\t\t\t.setName(\"Model node (primary)\")\n\t\t\t\t.setDesc\n\n\t\t}\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 176,
                "column": 1
              },
              "endPosition": {
                "line": 176,
                "column": 8
              }
            },
            {
              "startPosition": {
                "line": 176,
                "column": 8
              },
              "endPosition": {
                "line": 177,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export class ZettelSettingTab extends PluginSettingTab {",
            "lineNumber": 176,
            "isSignature": true
          },
          {
            "lineNumber": 182
          },
          {
            "lineNumber": 183
          },
          {
            "text": "\tdisplay(): void {",
            "lineNumber": 184
          },
          {
            "text": "\t\tconst {containerEl} = this;",
            "lineNumber": 185
          },
          {
            "text": "\t\tcontainerEl.empty();",
            "lineNumber": 186
          },
          {
            "text": "\t\tconst s = this.plugin.settings;",
            "lineNumber": 187
          },
          {
            "lineNumber": 188
          },
          {
            "text": "\t\t// How to run: one-line hint (per UX suggestion)",
            "lineNumber": 189
          },
          {
            "text": "\t\tconst hint = containerEl.createDiv({ cls: \"ztb-settings-hint setting-item-description\" });",
            "lineNumber": 190
          },
          {
            "text": "\t\thint.setText(\"Right-click a node on the canvas and choose Run node or Run chain.\");",
            "lineNumber": 191
          },
          {
            "lineNumber": 192
          },
          {
            "text": "\t\t// Execution: what runs (primary model, secondary model, Python path)",
            "lineNumber": 193
          },
          {
            "text": "\t\tconst executionSection = containerEl.createDiv({ cls: \"ztb-settings-section\" });",
            "lineNumber": 194
          },
          {
            "text": "\t\texecutionSection.createEl(\"h4\", { text: \"Execution\", cls: \"ztb-section-title\" });",
            "lineNumber": 195
          },
          {
            "text": "\t\tconst ollamaContainer = executionSection.createDiv({ cls: \"ztb-ollama-settings\" });",
            "lineNumber": 196
          },
          {
            "text": "\t\tconst loadingEl = ollamaContainer.createDiv({ cls: \"ztb-ollama-loading\" });",
            "lineNumber": 197
          },
          {
            "text": "\t\tloadingEl.setText(\"Loading Ollama models\");",
            "lineNumber": 198
          },
          {
            "text": "\t\t(async () =&gt; {",
            "lineNumber": 199
          },
          {
            "text": "\t\t\tconst models = await fetchOllamaModels();",
            "lineNumber": 200
          },
          {
            "text": "\t\t\tloadingEl.remove();",
            "lineNumber": 201
          },
          {
            "text": "\t\t\tif (models.length === 0) {",
            "lineNumber": 202
          },
          {
            "text": "\t\t\t\tconst fallback = ollamaContainer.createDiv({ cls: \"ztb-ollama-fallback\" });",
            "lineNumber": 203
          },
          {
            "text": "\t\t\t\tfallback.createEl(\"p\", { text: \"Ollama not reachable or no models. Enter model names manually.\" });",
            "lineNumber": 204
          },
          {
            "text": "\t\t\t\tnew Setting(ollamaContainer)",
            "lineNumber": 205
          },
          {
            "text": "\t\t\t\t\t.setName(\"Model node (primary)\")",
            "lineNumber": 206
          },
          {
            "text": "\t\t\t\t\t.setDesc(\"Ollama model used when you run a primary model node (e.g. llama2)\")",
            "lineNumber": 207
          },
          {
            "text": "\t\t\t\t\t.addText((text) =&gt; text",
            "lineNumber": 208
          },
          {
            "text": "\t\t\t\t\t\t.setPlaceholder(\"e.g. llama2\")",
            "lineNumber": 209
          },
          {
            "text": "\t\t\t\t\t\t.setValue(s.ollamaOrangeModel)",
            "lineNumber": 210
          },
          {
            "text": "\t\t\t\t\t\t.onChange(async (value) =&gt; {",
            "lineNumber": 211
          },
          {
            "text": "\t\t\t\t\t\t\tthis.plugin.settings.ollamaOrangeModel = value;",
            "lineNumber": 212
          },
          {
            "text": "\t\t\t\t\t\t\tawait this.plugin.saveSettings();",
            "lineNumber": 213
          },
          {
            "text": "\t\t\t\t\t\t}));",
            "lineNumber": 214
          },
          {
            "text": "\t\t\t\tnew Setting(ollamaContainer)",
            "lineNumber": 215
          },
          {
            "text": "\t\t\t\t\t.setName(\"Model node (secondary)\")",
            "lineNumber": 216
          },
          {
            "text": "\t\t\t\t\t.setDesc(\"Ollama model used when you run a secondary model node\")",
            "lineNumber": 217
          },
          {
            "text": "\t\t\t\t\t.addText((text) =&gt; text",
            "lineNumber": 218
          },
          {
            "text": "\t\t\t\t\t\t.setPlaceholder(\"e.g. mistral\")",
            "lineNumber": 219
          },
          {
            "text": "\t\t\t\t\t\t.setValue(s.ollamaPurpleModel)",
            "lineNumber": 220
          },
          {
            "text": "\t\t\t\t\t\t.onChange(async (value) =&gt; {",
            "lineNumber": 221
          },
          {
            "text": "\t\t\t\t\t\t\ts.ollamaPurpleModel = value;",
            "lineNumber": 222
          },
          {
            "text": "\t\t\t\t\t\t\tawait this.plugin.saveSettings();",
            "lineNumber": 223
          },
          {
            "text": "\t\t\t\t\t\t}));",
            "lineNumber": 224
          },
          {
            "text": "\t\t\t\treturn;",
            "lineNumber": 225
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 226
          },
          {
            "text": "\t\t\tnew Setting(ollamaContainer)",
            "lineNumber": 227
          },
          {
            "text": "\t\t\t\t.setName(\"Model node (primary)\")",
            "lineNumber": 228
          },
          {
            "text": "\t\t\t\t.setDesc",
            "lineNumber": 229
          },
          {
            "lineNumber": 238
          },
          {
            "text": "\t\t}",
            "lineNumber": 251
          },
          {
            "text": "\t}",
            "lineNumber": 312
          },
          {
            "text": "}",
            "lineNumber": 313,
            "isSignature": true
          }
        ]
      },
      "score": 0.19412344694137573
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/canvasNodeLabels.ts",
        "range": {
          "startPosition": {
            "line": 120
          },
          "endPosition": {
            "line": 165,
            "column": 1
          }
        },
        "contents": "function createLabelEl(text: string): HTMLElement {\n\n\tel.setAttribute(LABEL_DATA_ATTR, \"1\");\n\tel.textContent = text;\n\treturn el;\n}\n\n/**\n * Sync floating role labels for the active canvas: for each node whose color maps to a role,\n * add a small label above the node (e.g. \"Comment\", \"Python\"). Removes existing labels first.\n * Uses the live canvas node map to find each node's DOM element (.canvas-node).\n */\nexport async function syncCanvasRoleLabels(\n\tvault: Vault,\n\tcanvasFilePath: string,\n\tcontainerEl: HTMLElement,\n\tsettings: ZettelPluginSettings,\n\tcanvas: LiveCanvas | null\n): Promise&lt;void&gt; {\n\tif (!settings.showNodeRoleLabels) {\n\t\tclearCanvasRoleLabels(containerEl);\n\t\tclearCanvasLegend(containerEl);\n\t\treturn;\n\t}\n\tconst data = await loadCanvasData(vault, canvasFilePath);\n\tif (!data?.nodes) {\n\t\tclearCanvasRoleLabels(containerEl);\n\t\tclearCanvasLegend(containerEl);\n\t\treturn;\n\t}\n\tclearCanvasRoleLabels(containerEl);\n\tsyncCanvasLegend(containerEl, settings);\n\tfor (const node of data.nodes) {\n\t\tconst role = getNodeRole(node, settings);\n\t\tif (!role) continue;\n\t\tconst labelText = getRoleLabel(role, settings);\n\t\tconst nodeEl =\n\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, node.id)) ||\n\t\t\tfindNodeElementByDataId(containerEl, node.id);\n\t\tif (!nodeEl) continue;\n\t\tconst label = createLabelEl(labelText);\n\t\t// Append after .canvas-node-container so it matches Obsidian file node label position\n\t\tnodeEl.append(label);\n\t}\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "function createLabelEl(text: string): HTMLElement {",
            "lineNumber": 121,
            "isSignature": true
          },
          {
            "lineNumber": 123
          },
          {
            "text": "\tel.setAttribute(LABEL_DATA_ATTR, \"1\");",
            "lineNumber": 124
          },
          {
            "text": "\tel.textContent = text;",
            "lineNumber": 125
          },
          {
            "text": "\treturn el;",
            "lineNumber": 126
          },
          {
            "text": "}",
            "lineNumber": 127,
            "isSignature": true
          },
          {
            "lineNumber": 128
          },
          {
            "text": "/**",
            "lineNumber": 129
          },
          {
            "text": " * Sync floating role labels for the active canvas: for each node whose color maps to a role,",
            "lineNumber": 130
          },
          {
            "text": " * add a small label above the node (e.g. \"Comment\", \"Python\"). Removes existing labels first.",
            "lineNumber": 131
          },
          {
            "text": " * Uses the live canvas node map to find each node's DOM element (.canvas-node).",
            "lineNumber": 132
          },
          {
            "text": " */",
            "lineNumber": 133
          },
          {
            "text": "export async function syncCanvasRoleLabels(",
            "lineNumber": 134,
            "isSignature": true
          },
          {
            "text": "\tvault: Vault,",
            "lineNumber": 135,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 136,
            "isSignature": true
          },
          {
            "text": "\tcontainerEl: HTMLElement,",
            "lineNumber": 137,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 138,
            "isSignature": true
          },
          {
            "text": "\tcanvas: LiveCanvas | null",
            "lineNumber": 139,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;void&gt; {",
            "lineNumber": 140,
            "isSignature": true
          },
          {
            "text": "\tif (!settings.showNodeRoleLabels) {",
            "lineNumber": 141
          },
          {
            "text": "\t\tclearCanvasRoleLabels(containerEl);",
            "lineNumber": 142
          },
          {
            "text": "\t\tclearCanvasLegend(containerEl);",
            "lineNumber": 143
          },
          {
            "text": "\t\treturn;",
            "lineNumber": 144
          },
          {
            "text": "\t}",
            "lineNumber": 145
          },
          {
            "text": "\tconst data = await loadCanvasData(vault, canvasFilePath);",
            "lineNumber": 146
          },
          {
            "text": "\tif (!data?.nodes) {",
            "lineNumber": 147
          },
          {
            "text": "\t\tclearCanvasRoleLabels(containerEl);",
            "lineNumber": 148
          },
          {
            "text": "\t\tclearCanvasLegend(containerEl);",
            "lineNumber": 149
          },
          {
            "text": "\t\treturn;",
            "lineNumber": 150
          },
          {
            "text": "\t}",
            "lineNumber": 151
          },
          {
            "text": "\tclearCanvasRoleLabels(containerEl);",
            "lineNumber": 152
          },
          {
            "text": "\tsyncCanvasLegend(containerEl, settings);",
            "lineNumber": 153
          },
          {
            "text": "\tfor (const node of data.nodes) {",
            "lineNumber": 154
          },
          {
            "text": "\t\tconst role = getNodeRole(node, settings);",
            "lineNumber": 155
          },
          {
            "text": "\t\tif (!role) continue;",
            "lineNumber": 156
          },
          {
            "text": "\t\tconst labelText = getRoleLabel(role, settings);",
            "lineNumber": 157
          },
          {
            "text": "\t\tconst nodeEl =",
            "lineNumber": 158
          },
          {
            "text": "\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, node.id)) ||",
            "lineNumber": 159
          },
          {
            "text": "\t\t\tfindNodeElementByDataId(containerEl, node.id);",
            "lineNumber": 160
          },
          {
            "text": "\t\tif (!nodeEl) continue;",
            "lineNumber": 161
          },
          {
            "text": "\t\tconst label = createLabelEl(labelText);",
            "lineNumber": 162
          },
          {
            "text": "\t\t// Append after .canvas-node-container so it matches Obsidian file node label position",
            "lineNumber": 163
          },
          {
            "text": "\t\tnodeEl.append(label);",
            "lineNumber": 164
          },
          {
            "text": "\t}",
            "lineNumber": 165
          },
          {
            "text": "}",
            "lineNumber": 166,
            "isSignature": true
          }
        ]
      },
      "score": 0.19070029258728027
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 27
          },
          "endPosition": {
            "line": 298,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\n\n\n\t/** Dismiss the Green output node for the given source node (call from context menu with node id). */\n\tasync dismissOutput(nodeId: string): Promise&lt;void&gt; {\n\t\tconst view = this.getActiveCanvasView();\n\t\tif (!view) return;\n\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;\n\t\tawait runnerDismissOutput(this.app.vault, view.file.path, nodeId, this.settings, liveCanvas);\n\t}\n\n\t/** Get kernel for the active (or first open) canvas (for side panel to wire obsidian_log). */\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 28,
                "column": 1
              },
              "endPosition": {
                "line": 28,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 28,
                "column": 16
              },
              "endPosition": {
                "line": 29,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 28,
            "isSignature": true
          },
          {
            "lineNumber": 283
          },
          {
            "lineNumber": 284
          },
          {
            "text": "\t/** Dismiss the Green output node for the given source node (call from context menu with node id). */",
            "lineNumber": 285
          },
          {
            "text": "\tasync dismissOutput(nodeId: string): Promise&lt;void&gt; {",
            "lineNumber": 286
          },
          {
            "text": "\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 287
          },
          {
            "text": "\t\tif (!view) return;",
            "lineNumber": 288
          },
          {
            "text": "\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;",
            "lineNumber": 289
          },
          {
            "text": "\t\tawait runnerDismissOutput(this.app.vault, view.file.path, nodeId, this.settings, liveCanvas);",
            "lineNumber": 290
          },
          {
            "text": "\t}",
            "lineNumber": 291
          },
          {
            "lineNumber": 292
          },
          {
            "text": "\t/** Get kernel for the active (or first open) canvas (for side panel to wire obsidian_log). */",
            "lineNumber": 293
          },
          {
            "text": "}",
            "lineNumber": 299,
            "isSignature": true
          }
        ]
      },
      "score": 0.1799008995294571
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 27
          },
          "endPosition": {
            "line": 298,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\n\n\n\t/** Get kernel for the active (or first open) canvas (for side panel to wire obsidian_log). */\n\tgetKernelForActiveCanvas(): import(\"./engine/pythonKernel\").PythonKernel | null {\n\t\tconst view = this.getActiveOrFirstCanvasView();\n\t\tif (!view) return null;\n\t\treturn getKernelForCanvas(view.file.path, this.settings.pythonPath);\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 28,
                "column": 1
              },
              "endPosition": {
                "line": 28,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 28,
                "column": 16
              },
              "endPosition": {
                "line": 29,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 28,
            "isSignature": true
          },
          {
            "lineNumber": 291
          },
          {
            "lineNumber": 292
          },
          {
            "text": "\t/** Get kernel for the active (or first open) canvas (for side panel to wire obsidian_log). */",
            "lineNumber": 293
          },
          {
            "text": "\tgetKernelForActiveCanvas(): import(\"./engine/pythonKernel\").PythonKernel | null {",
            "lineNumber": 294
          },
          {
            "text": "\t\tconst view = this.getActiveOrFirstCanvasView();",
            "lineNumber": 295
          },
          {
            "text": "\t\tif (!view) return null;",
            "lineNumber": 296
          },
          {
            "text": "\t\treturn getKernelForCanvas(view.file.path, this.settings.pythonPath);",
            "lineNumber": 297
          },
          {
            "text": "\t}",
            "lineNumber": 298
          },
          {
            "text": "}",
            "lineNumber": 299,
            "isSignature": true
          }
        ]
      },
      "score": 0.17870719730854034
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/canvasApi.ts",
        "range": {
          "startPosition": {
            "column": 86
          },
          "endPosition": {
            "line": 15,
            "column": 1
          }
        },
        "contents": "export interface LiveCanvas {\n\tcreateTextNode(options: {\n\t\ttext: string;\n\t\tpos: { x: number; y: number };\n\t\tsize: { width: number; height: number };\n\t\tsave?: boolean;\n\t\tfocus?: boolean;\n\t}): { id: string; x: number; y: number; width: number; height: number; moveTo: (pos: { x: number; y: number }) =&gt; void; resize: (size: { width: number; height: number }) =&gt; void };\n\taddNode(node: unknown): void;\n\trequestSave?: () =&gt; void;\n\tremoveNode?(node: unknown): void;\n\tnodes?: Map&lt;string, unknown&gt; | Iterable&lt;unknown&gt;;\n\t/** If present, used to refresh canvas after edge label updates (Obsidian canvas view). */\n\tsetData?(data: unknown): void;\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "export interface LiveCanvas {",
            "lineNumber": 2,
            "isSignature": true
          },
          {
            "text": "\tcreateTextNode(options: {",
            "lineNumber": 3
          },
          {
            "text": "\t\ttext: string;",
            "lineNumber": 4
          },
          {
            "text": "\t\tpos: { x: number; y: number };",
            "lineNumber": 5
          },
          {
            "text": "\t\tsize: { width: number; height: number };",
            "lineNumber": 6
          },
          {
            "text": "\t\tsave?: boolean;",
            "lineNumber": 7
          },
          {
            "text": "\t\tfocus?: boolean;",
            "lineNumber": 8
          },
          {
            "text": "\t}): { id: string; x: number; y: number; width: number; height: number; moveTo: (pos: { x: number; y: number }) =&gt; void; resize: (size: { width: number; height: number }) =&gt; void };",
            "lineNumber": 9
          },
          {
            "text": "\taddNode(node: unknown): void;",
            "lineNumber": 10
          },
          {
            "text": "\trequestSave?: () =&gt; void;",
            "lineNumber": 11
          },
          {
            "text": "\tremoveNode?(node: unknown): void;",
            "lineNumber": 12
          },
          {
            "text": "\tnodes?: Map&lt;string, unknown&gt; | Iterable&lt;unknown&gt;;",
            "lineNumber": 13
          },
          {
            "text": "\t/** If present, used to refresh canvas after edge label updates (Obsidian canvas view). */",
            "lineNumber": 14
          },
          {
            "text": "\tsetData?(data: unknown): void;",
            "lineNumber": 15,
            "isSignature": true
          },
          {
            "text": "}",
            "lineNumber": 16,
            "isSignature": true
          }
        ]
      },
      "score": 0.17705869674682617
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/settings.ts",
        "range": {
          "startPosition": {
            "line": 175
          },
          "endPosition": {
            "line": 312,
            "column": 1
          }
        },
        "contents": "export class ZettelSettingTab extends PluginSettingTab {\ndisplay(): void {\n\n\n\t\t);\n\t\taddColorSetting(\n\t\t\tcolorsSection,\n\t\t\tthis.plugin,\n\t\t\t\"blue\",\n\t\t\t\"Python node\",\n\t\t\t\"Color for the Python node on the canvas\"\n\t\t);\n\t\taddColorSetting(\n\t\t\tcolorsSection,\n\t\t\tthis.plugin,\n\t\t\t\"yellow\",\n\t\t\t\"Comment node\",\n\t\t\t\"Color for the comment (pass-through) node on the canvas\"\n\t\t);\n\t\taddColorSetting(\n\t\t\tcolorsSection,\n\t\t\tthis.plugin,\n\t\t\t\"green\",\n\t\t\t\"Output node\",\n\t\t\t\"Color for auto-generated output nodes on the canvas\"\n\t\t);\n\n\t\tnew Setting(colorsSection)\n\t\t\t.setName(\"Show role labels on canvas\")\n\t\t\t.setDesc(\"Show a floating label above each node (e.g. Comment, Python) based on its color\")\n\t\t\t.addToggle((toggle) =&gt; toggle\n\t\t\t\t.setValue(s.showNodeRoleLabels)\n\t\t\t\t.onChange(async (value) =&gt; {\n\t\t\t\t\tthis.plugin.settings.showNodeRoleLabels = value;\n\t\t\t\t\tawait this.plugin.saveSettings();\n\t\t\t\t}));\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 176,
                "column": 1
              },
              "endPosition": {
                "line": 176,
                "column": 8
              }
            },
            {
              "startPosition": {
                "line": 176,
                "column": 8
              },
              "endPosition": {
                "line": 177,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 184,
                "column": 2
              },
              "endPosition": {
                "line": 185,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export class ZettelSettingTab extends PluginSettingTab {",
            "lineNumber": 176,
            "isSignature": true
          },
          {
            "text": "display(): void {",
            "lineNumber": 184
          },
          {
            "lineNumber": 274
          },
          {
            "lineNumber": 279
          },
          {
            "text": "\t\t);",
            "lineNumber": 280
          },
          {
            "text": "\t\taddColorSetting(",
            "lineNumber": 281
          },
          {
            "text": "\t\t\tcolorsSection,",
            "lineNumber": 282
          },
          {
            "text": "\t\t\tthis.plugin,",
            "lineNumber": 283
          },
          {
            "text": "\t\t\t\"blue\",",
            "lineNumber": 284
          },
          {
            "text": "\t\t\t\"Python node\",",
            "lineNumber": 285
          },
          {
            "text": "\t\t\t\"Color for the Python node on the canvas\"",
            "lineNumber": 286
          },
          {
            "text": "\t\t);",
            "lineNumber": 287
          },
          {
            "text": "\t\taddColorSetting(",
            "lineNumber": 288
          },
          {
            "text": "\t\t\tcolorsSection,",
            "lineNumber": 289
          },
          {
            "text": "\t\t\tthis.plugin,",
            "lineNumber": 290
          },
          {
            "text": "\t\t\t\"yellow\",",
            "lineNumber": 291
          },
          {
            "text": "\t\t\t\"Comment node\",",
            "lineNumber": 292
          },
          {
            "text": "\t\t\t\"Color for the comment (pass-through) node on the canvas\"",
            "lineNumber": 293
          },
          {
            "text": "\t\t);",
            "lineNumber": 294
          },
          {
            "text": "\t\taddColorSetting(",
            "lineNumber": 295
          },
          {
            "text": "\t\t\tcolorsSection,",
            "lineNumber": 296
          },
          {
            "text": "\t\t\tthis.plugin,",
            "lineNumber": 297
          },
          {
            "text": "\t\t\t\"green\",",
            "lineNumber": 298
          },
          {
            "text": "\t\t\t\"Output node\",",
            "lineNumber": 299
          },
          {
            "text": "\t\t\t\"Color for auto-generated output nodes on the canvas\"",
            "lineNumber": 300
          },
          {
            "text": "\t\t);",
            "lineNumber": 301
          },
          {
            "lineNumber": 302
          },
          {
            "text": "\t\tnew Setting(colorsSection)",
            "lineNumber": 303
          },
          {
            "text": "\t\t\t.setName(\"Show role labels on canvas\")",
            "lineNumber": 304
          },
          {
            "text": "\t\t\t.setDesc(\"Show a floating label above each node (e.g. Comment, Python) based on its color\")",
            "lineNumber": 305
          },
          {
            "text": "\t\t\t.addToggle((toggle) =&gt; toggle",
            "lineNumber": 306
          },
          {
            "text": "\t\t\t\t.setValue(s.showNodeRoleLabels)",
            "lineNumber": 307
          },
          {
            "text": "\t\t\t\t.onChange(async (value) =&gt; {",
            "lineNumber": 308
          },
          {
            "text": "\t\t\t\t\tthis.plugin.settings.showNodeRoleLabels = value;",
            "lineNumber": 309
          },
          {
            "text": "\t\t\t\t\tawait this.plugin.saveSettings();",
            "lineNumber": 310
          },
          {
            "text": "\t\t\t\t}));",
            "lineNumber": 311
          },
          {
            "text": "\t}",
            "lineNumber": 312
          },
          {
            "text": "}",
            "lineNumber": 313,
            "isSignature": true
          }
        ]
      },
      "score": 0.17078909277915955
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/state.ts",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 16,
            "column": 1
          }
        },
        "contents": "/** Per-canvas state: NodeID -&gt; last output result string. */\nconst canvasState = new Map&lt;string, Map&lt;string, string&gt;&gt;();\n\n/** Per-canvas edge mode: EdgeID -&gt; \"inject\" | \"concatenate\" (shown in floating label under edge). */\nconst edgeModeState = new Map&lt;string, Map&lt;string, \"inject\" | \"concatenate\"&gt;&gt;();\n\n/** Node currently running (waiting for AI/kernel) per canvas; used to show \"running\" on incoming edges. */\nconst runningNodeState = new Map&lt;string, string | null&gt;();\n\nfunction getCanvasState(canvasKey: string): Map&lt;string, string&gt; {\n\tlet map = canvasState.get(canvasKey);\n\tif (!map) {\n\t\tmap = new Map();\n\t\tcanvasState.set(canvasKey, map);\n\t}\n\treturn map;\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Per-canvas state: NodeID -&gt; last output result string. */",
            "lineNumber": 1
          },
          {
            "text": "const canvasState = new Map&lt;string, Map&lt;string, string&gt;&gt;();",
            "lineNumber": 2
          },
          {
            "lineNumber": 3
          },
          {
            "text": "/** Per-canvas edge mode: EdgeID -&gt; \"inject\" | \"concatenate\" (shown in floating label under edge). */",
            "lineNumber": 4
          },
          {
            "text": "const edgeModeState = new Map&lt;string, Map&lt;string, \"inject\" | \"concatenate\"&gt;&gt;();",
            "lineNumber": 5
          },
          {
            "lineNumber": 6
          },
          {
            "text": "/** Node currently running (waiting for AI/kernel) per canvas; used to show \"running\" on incoming edges. */",
            "lineNumber": 7
          },
          {
            "text": "const runningNodeState = new Map&lt;string, string | null&gt;();",
            "lineNumber": 8
          },
          {
            "lineNumber": 9
          },
          {
            "text": "function getCanvasState(canvasKey: string): Map&lt;string, string&gt; {",
            "lineNumber": 10,
            "isSignature": true
          },
          {
            "text": "\tlet map = canvasState.get(canvasKey);",
            "lineNumber": 11
          },
          {
            "text": "\tif (!map) {",
            "lineNumber": 12
          },
          {
            "text": "\t\tmap = new Map();",
            "lineNumber": 13
          },
          {
            "text": "\t\tcanvasState.set(canvasKey, map);",
            "lineNumber": 14
          },
          {
            "text": "\t}",
            "lineNumber": 15
          },
          {
            "text": "\treturn map;",
            "lineNumber": 16
          },
          {
            "text": "}",
            "lineNumber": 17,
            "isSignature": true
          }
        ]
      },
      "score": 0.1683109998703003
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/canvasNodeLabels.ts",
        "range": {
          "startPosition": {
            "line": 71
          },
          "endPosition": {
            "line": 117,
            "column": 1
          }
        },
        "contents": "function createLegendSwatch(color: CanvasColor): HTMLElement {\n\n\treturn swatch;\n}\n\n/** Build and append the color legend to the canvas container (vanilla DOM, no innerHTML). */\nfunction syncCanvasLegend(containerEl: HTMLElement, settings: ZettelPluginSettings): void {\n\tclearCanvasLegend(containerEl);\n\tif (!settings.showNodeRoleLabels) return;\n\tconst legend = document.createElement(\"div\");\n\tlegend.setAttribute(\"class\", LEGEND_CLASS);\n\tconst title = document.createElement(\"div\");\n\ttitle.setAttribute(\"class\", \"ztb-legend-title\");\n\ttitle.textContent = \"Colors\";\n\tlegend.appendChild(title);\n\tfor (const role of ROLES) {\n\t\tconst key = &#96;color${role.charAt(0).toUpperCase() + role.slice(1)}&#96; as keyof ZettelPluginSettings;\n\t\tconst color = (settings[key] as CanvasColor) ?? \"\";\n\t\tconst row = document.createElement(\"div\");\n\t\trow.setAttribute(\"class\", \"ztb-legend-row\");\n\t\trow.appendChild(createLegendSwatch(color));\n\t\tconst text = document.createElement(\"span\");\n\t\ttext.setAttribute(\"class\", \"ztb-legend-text\");\n\t\ttext.textContent = getRoleLabel(role, settings);\n\t\trow.appendChild(text);\n\t\tlegend.appendChild(row);\n\t}\n\tconst otherRow = document.createElement(\"div\");\n\totherRow.setAttribute(\"class\", \"ztb-legend-row\");\n\tconst otherSwatch = document.createElement(\"span\");\n\totherSwatch.setAttribute(\"class\", \"ztb-legend-swatch ztb-legend-swatch--other\");\n\totherSwatch.style.backgroundColor = \"var(--text-muted)\";\n\totherRow.appendChild(otherSwatch);\n\tconst otherText = document.createElement(\"span\");\n\totherText.setAttribute(\"class\", \"ztb-legend-text\");\n\totherText.textContent = \"Other colors = Comment\";\n\totherRow.appendChild(otherText);\n\tlegend.appendChild(otherRow);\n\tcontainerEl.appendChild(legend);\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "function createLegendSwatch(color: CanvasColor): HTMLElement {",
            "lineNumber": 72,
            "isSignature": true
          },
          {
            "lineNumber": 80
          },
          {
            "text": "\treturn swatch;",
            "lineNumber": 81
          },
          {
            "text": "}",
            "lineNumber": 82,
            "isSignature": true
          },
          {
            "lineNumber": 83
          },
          {
            "text": "/** Build and append the color legend to the canvas container (vanilla DOM, no innerHTML). */",
            "lineNumber": 84
          },
          {
            "text": "function syncCanvasLegend(containerEl: HTMLElement, settings: ZettelPluginSettings): void {",
            "lineNumber": 85,
            "isSignature": true
          },
          {
            "text": "\tclearCanvasLegend(containerEl);",
            "lineNumber": 86
          },
          {
            "text": "\tif (!settings.showNodeRoleLabels) return;",
            "lineNumber": 87
          },
          {
            "text": "\tconst legend = document.createElement(\"div\");",
            "lineNumber": 88
          },
          {
            "text": "\tlegend.setAttribute(\"class\", LEGEND_CLASS);",
            "lineNumber": 89
          },
          {
            "text": "\tconst title = document.createElement(\"div\");",
            "lineNumber": 90
          },
          {
            "text": "\ttitle.setAttribute(\"class\", \"ztb-legend-title\");",
            "lineNumber": 91
          },
          {
            "text": "\ttitle.textContent = \"Colors\";",
            "lineNumber": 92
          },
          {
            "text": "\tlegend.appendChild(title);",
            "lineNumber": 93
          },
          {
            "text": "\tfor (const role of ROLES) {",
            "lineNumber": 94
          },
          {
            "text": "\t\tconst key = &#96;color${role.charAt(0).toUpperCase() + role.slice(1)}&#96; as keyof ZettelPluginSettings;",
            "lineNumber": 95
          },
          {
            "text": "\t\tconst color = (settings[key] as CanvasColor) ?? \"\";",
            "lineNumber": 96
          },
          {
            "text": "\t\tconst row = document.createElement(\"div\");",
            "lineNumber": 97
          },
          {
            "text": "\t\trow.setAttribute(\"class\", \"ztb-legend-row\");",
            "lineNumber": 98
          },
          {
            "text": "\t\trow.appendChild(createLegendSwatch(color));",
            "lineNumber": 99
          },
          {
            "text": "\t\tconst text = document.createElement(\"span\");",
            "lineNumber": 100
          },
          {
            "text": "\t\ttext.setAttribute(\"class\", \"ztb-legend-text\");",
            "lineNumber": 101
          },
          {
            "text": "\t\ttext.textContent = getRoleLabel(role, settings);",
            "lineNumber": 102
          },
          {
            "text": "\t\trow.appendChild(text);",
            "lineNumber": 103
          },
          {
            "text": "\t\tlegend.appendChild(row);",
            "lineNumber": 104
          },
          {
            "text": "\t}",
            "lineNumber": 105
          },
          {
            "text": "\tconst otherRow = document.createElement(\"div\");",
            "lineNumber": 106
          },
          {
            "text": "\totherRow.setAttribute(\"class\", \"ztb-legend-row\");",
            "lineNumber": 107
          },
          {
            "text": "\tconst otherSwatch = document.createElement(\"span\");",
            "lineNumber": 108
          },
          {
            "text": "\totherSwatch.setAttribute(\"class\", \"ztb-legend-swatch ztb-legend-swatch--other\");",
            "lineNumber": 109
          },
          {
            "text": "\totherSwatch.style.backgroundColor = \"var(--text-muted)\";",
            "lineNumber": 110
          },
          {
            "text": "\totherRow.appendChild(otherSwatch);",
            "lineNumber": 111
          },
          {
            "text": "\tconst otherText = document.createElement(\"span\");",
            "lineNumber": 112
          },
          {
            "text": "\totherText.setAttribute(\"class\", \"ztb-legend-text\");",
            "lineNumber": 113
          },
          {
            "text": "\totherText.textContent = \"Other colors = Comment\";",
            "lineNumber": 114
          },
          {
            "text": "\totherRow.appendChild(otherText);",
            "lineNumber": 115
          },
          {
            "text": "\tlegend.appendChild(otherRow);",
            "lineNumber": 116
          },
          {
            "text": "\tcontainerEl.appendChild(legend);",
            "lineNumber": 117
          },
          {
            "text": "}",
            "lineNumber": 118,
            "isSignature": true
          }
        ]
      },
      "score": 0.1483048051595688
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/settings.ts",
        "range": {
          "startPosition": {
            "line": 94,
            "column": 1
          },
          "endPosition": {
            "line": 173,
            "column": 1
          }
        },
        "contents": "function addColorSetting(\n\tcontainerEl: HTMLElement,\n\tplugin: Plugin &amp; { settings: ZettelPluginSettings; saveSettings(): Promise&lt;void&gt; },\n\trole: NodeRole,\n\tlabel: string,\n\tdesc: string\n): void {\n\tconst key = &#96;color${role.charAt(0).toUpperCase() + role.slice(1)}&#96; as keyof ZettelPluginSettings;\n\tconst current = plugin.settings[key] as CanvasColor;\n\tconst isPreset = /^[1-6]$/.test(current);\n\tconst presetValue = isPreset ? current : \"1\";\n\tconst customValue = isPreset ? \"\" : current;\n\n\tconst row = containerEl.createDiv({ cls: \"setting-item\" });\n\tconst info = row.createDiv({ cls: \"setting-item-info\" });\n\tinfo.createEl(\"div\", { cls: \"setting-item-name\", text: label });\n\tinfo.createEl(\"div\", { cls: \"setting-item-description\", text: desc });\n\tconst control = row.createDiv({ cls: \"setting-item-control\" });\n\n\tconst swatchWrap = control.createSpan({ cls: \"ztb-color-swatch-wrap\" });\n\tconst swatch = swatchWrap.createSpan({ cls: \"ztb-color-swatch\" });\n\tif (isPreset) {\n\t\tsetSwatchToPreset(swatch, presetValue);\n\t\tswatch.setAttr(\"title\", PRESET_COLORS.find((p) =&gt; p.value === presetValue)?.label ?? \"Preset\");\n\t} else {\n\t\tsetSwatchToCustom(swatch, customValue || \"#888\");\n\t\tswatch.setAttr(\"title\", customValue || \"Custom\");\n\t}\n\n\tconst dropdown = control.createEl(\"select\", { cls: \"dropdown\" });\n\tPRESET_COLORS.forEach((p) =&gt; {\n\t\tconst opt = dropdown.createEl(\"option\", { text: p.label });\n\t\topt.value = p.value;\n\t\tif (p.value === presetValue) opt.selected = true;\n\t});\n\tconst customOpt = dropdown.createEl(\"option\", { text: \"Custom (hex)\" });\n\tcustomOpt.value = \"custom\";\n\tif (!isPreset) customOpt.selected = true;\n\tconst updateSwatch = () =&gt; {\n\t\tconst v = dropdown.value;\n\t\tif (v === \"custom\") {\n\t\t\tsetSwatchToCustom(swatch, customHex.value.trim() || \"#888\");\n\t\t\tswatch.setAttr(\"title\", customHex.value.trim() || \"Custom\");\n\t\t} else {\n\t\t\tsetSwatchToPreset(swatch, v);\n\t\t\tswatch.setAttr(\"title\", PRESET_COLORS.find((x) =&gt; x.value === v)?.label ?? \"Preset\");\n\t\t}\n\t};\n\tdropdown.addEventListener(\"change\", () =&gt; {\n\t\tconst v = dropdown.value;\n\t}\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "function addColorSetting(",
            "lineNumber": 97,
            "isSignature": true
          },
          {
            "text": "\tcontainerEl: HTMLElement,",
            "lineNumber": 98,
            "isSignature": true
          },
          {
            "text": "\tplugin: Plugin &amp; { settings: ZettelPluginSettings; saveSettings(): Promise&lt;void&gt; },",
            "lineNumber": 99,
            "isSignature": true
          },
          {
            "text": "\trole: NodeRole,",
            "lineNumber": 100,
            "isSignature": true
          },
          {
            "text": "\tlabel: string,",
            "lineNumber": 101,
            "isSignature": true
          },
          {
            "text": "\tdesc: string",
            "lineNumber": 102,
            "isSignature": true
          },
          {
            "text": "): void {",
            "lineNumber": 103,
            "isSignature": true
          },
          {
            "text": "\tconst key = &#96;color${role.charAt(0).toUpperCase() + role.slice(1)}&#96; as keyof ZettelPluginSettings;",
            "lineNumber": 104
          },
          {
            "text": "\tconst current = plugin.settings[key] as CanvasColor;",
            "lineNumber": 105
          },
          {
            "text": "\tconst isPreset = /^[1-6]$/.test(current);",
            "lineNumber": 106
          },
          {
            "text": "\tconst presetValue = isPreset ? current : \"1\";",
            "lineNumber": 107
          },
          {
            "text": "\tconst customValue = isPreset ? \"\" : current;",
            "lineNumber": 108
          },
          {
            "lineNumber": 109
          },
          {
            "text": "\tconst row = containerEl.createDiv({ cls: \"setting-item\" });",
            "lineNumber": 110
          },
          {
            "text": "\tconst info = row.createDiv({ cls: \"setting-item-info\" });",
            "lineNumber": 111
          },
          {
            "text": "\tinfo.createEl(\"div\", { cls: \"setting-item-name\", text: label });",
            "lineNumber": 112
          },
          {
            "text": "\tinfo.createEl(\"div\", { cls: \"setting-item-description\", text: desc });",
            "lineNumber": 113
          },
          {
            "text": "\tconst control = row.createDiv({ cls: \"setting-item-control\" });",
            "lineNumber": 114
          },
          {
            "lineNumber": 115
          },
          {
            "text": "\tconst swatchWrap = control.createSpan({ cls: \"ztb-color-swatch-wrap\" });",
            "lineNumber": 116
          },
          {
            "text": "\tconst swatch = swatchWrap.createSpan({ cls: \"ztb-color-swatch\" });",
            "lineNumber": 117
          },
          {
            "text": "\tif (isPreset) {",
            "lineNumber": 118
          },
          {
            "text": "\t\tsetSwatchToPreset(swatch, presetValue);",
            "lineNumber": 119
          },
          {
            "text": "\t\tswatch.setAttr(\"title\", PRESET_COLORS.find((p) =&gt; p.value === presetValue)?.label ?? \"Preset\");",
            "lineNumber": 120
          },
          {
            "text": "\t} else {",
            "lineNumber": 121
          },
          {
            "text": "\t\tsetSwatchToCustom(swatch, customValue || \"#888\");",
            "lineNumber": 122
          },
          {
            "text": "\t\tswatch.setAttr(\"title\", customValue || \"Custom\");",
            "lineNumber": 123
          },
          {
            "text": "\t}",
            "lineNumber": 124
          },
          {
            "lineNumber": 125
          },
          {
            "text": "\tconst dropdown = control.createEl(\"select\", { cls: \"dropdown\" });",
            "lineNumber": 126
          },
          {
            "text": "\tPRESET_COLORS.forEach((p) =&gt; {",
            "lineNumber": 127
          },
          {
            "text": "\t\tconst opt = dropdown.createEl(\"option\", { text: p.label });",
            "lineNumber": 128
          },
          {
            "text": "\t\topt.value = p.value;",
            "lineNumber": 129
          },
          {
            "text": "\t\tif (p.value === presetValue) opt.selected = true;",
            "lineNumber": 130
          },
          {
            "text": "\t});",
            "lineNumber": 131
          },
          {
            "text": "\tconst customOpt = dropdown.createEl(\"option\", { text: \"Custom (hex)\" });",
            "lineNumber": 132
          },
          {
            "text": "\tcustomOpt.value = \"custom\";",
            "lineNumber": 133
          },
          {
            "text": "\tif (!isPreset) customOpt.selected = true;",
            "lineNumber": 134
          },
          {
            "text": "\tconst updateSwatch = () =&gt; {",
            "lineNumber": 135
          },
          {
            "text": "\t\tconst v = dropdown.value;",
            "lineNumber": 136
          },
          {
            "text": "\t\tif (v === \"custom\") {",
            "lineNumber": 137
          },
          {
            "text": "\t\t\tsetSwatchToCustom(swatch, customHex.value.trim() || \"#888\");",
            "lineNumber": 138
          },
          {
            "text": "\t\t\tswatch.setAttr(\"title\", customHex.value.trim() || \"Custom\");",
            "lineNumber": 139
          },
          {
            "text": "\t\t} else {",
            "lineNumber": 140
          },
          {
            "text": "\t\t\tsetSwatchToPreset(swatch, v);",
            "lineNumber": 141
          },
          {
            "text": "\t\t\tswatch.setAttr(\"title\", PRESET_COLORS.find((x) =&gt; x.value === v)?.label ?? \"Preset\");",
            "lineNumber": 142
          },
          {
            "text": "\t\t}",
            "lineNumber": 143
          },
          {
            "text": "\t};",
            "lineNumber": 144
          },
          {
            "text": "\tdropdown.addEventListener(\"change\", () =&gt; {",
            "lineNumber": 145
          },
          {
            "text": "\t\tconst v = dropdown.value;",
            "lineNumber": 146
          },
          {
            "text": "\t}",
            "lineNumber": 155
          },
          {
            "text": "}",
            "lineNumber": 174,
            "isSignature": true
          }
        ]
      },
      "score": 0.14564509689807892
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/types.ts",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 18,
            "column": 1
          }
        },
        "contents": "import type {\n\tAllCanvasNodeData,\n\tCanvasData,\n\tCanvasEdgeData,\n\tCanvasFileData,\n\tCanvasNodeData,\n\tCanvasTextData,\n} from \"obsidian/canvas\";\nimport type {CanvasColor, NodeRole, ZettelPluginSettings} from \"../settings\";\n\nexport type {AllCanvasNodeData, CanvasData, CanvasEdgeData, CanvasFileData, CanvasNodeData, CanvasTextData};\n\n/** Normalize color for comparison (e.g. trim, lowercase hex). */\nexport function normalizeColor(c: CanvasColor | undefined): string {\n\tif (c == null || c === \"\") return \"\";\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "import type {",
            "lineNumber": 1
          },
          {
            "text": "\tAllCanvasNodeData,",
            "lineNumber": 2
          },
          {
            "text": "\tCanvasData,",
            "lineNumber": 3
          },
          {
            "text": "\tCanvasEdgeData,",
            "lineNumber": 4
          },
          {
            "text": "\tCanvasFileData,",
            "lineNumber": 5
          },
          {
            "text": "\tCanvasNodeData,",
            "lineNumber": 6
          },
          {
            "text": "\tCanvasTextData,",
            "lineNumber": 7
          },
          {
            "text": "} from \"obsidian/canvas\";",
            "lineNumber": 8
          },
          {
            "text": "import type {CanvasColor, NodeRole, ZettelPluginSettings} from \"../settings\";",
            "lineNumber": 9
          },
          {
            "lineNumber": 10
          },
          {
            "text": "export type {AllCanvasNodeData, CanvasData, CanvasEdgeData, CanvasFileData, CanvasNodeData, CanvasTextData};",
            "lineNumber": 11
          },
          {
            "lineNumber": 12
          },
          {
            "text": "/** Normalize color for comparison (e.g. trim, lowercase hex). */",
            "lineNumber": 13
          },
          {
            "text": "export function normalizeColor(c: CanvasColor | undefined): string {",
            "lineNumber": 14,
            "isSignature": true
          },
          {
            "text": "\tif (c == null || c === \"\") return \"\";",
            "lineNumber": 15
          },
          {
            "text": "}",
            "lineNumber": 19,
            "isSignature": true
          }
        ]
      },
      "score": 0.14504650235176086
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/canvasNodeLabels.ts",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 47,
            "column": 1
          }
        },
        "contents": "import type {Vault} from \"obsidian\";\nimport {loadCanvasData} from \"./nodes\";\nimport {getNodeRole, isOutputEdge} from \"./types\";\nimport type {CanvasColor, NodeRole, ZettelPluginSettings} from \"../settings\";\nimport {getPresetColor, getRoleLabel} from \"../settings\";\nimport type {LiveCanvas} from \"../engine/canvasApi\";\nimport {getCanvasKey, getEdgeMode, getRunningNodeId} from \"../engine/state\";\n\nconst LABEL_CLASS = \"ztb-node-role-label\";\nconst LABEL_DATA_ATTR = \"data-ztb-role-label\";\nconst LEGEND_CLASS = \"ztb-canvas-legend\";\nconst EDGE_MODE_LABEL_CLASS = \"ztb-edge-mode-label\";\nconst EDGE_MODE_DATA_ATTR = \"data-ztb-edge-id\";\nconst EDGE_MODE_STATE_ATTR = \"data-ztb-edge-state\";\nconst EDGE_MODE_ICON_CLASS = \"ztb-edge-mode-icon\";\ntype EdgeDisplayState = \"running\" | \"inject\" | \"concatenate\";\nconst ROLES: NodeRole[] = [\"orange\", \"purple\", \"blue\", \"yellow\", \"green\"];\n\n/** Try to get a canvas node's root DOM element from the live canvas (Obsidian uses .canvas-node, no data-id). */\nfunction getNodeElFromCanvas(canvas: LiveCanvas, nodeId: string): HTMLElement | null {\n\tconst nodes = canvas.nodes;\n\tif (!nodes) return null;\n\tlet view: {\n\t\tid?: string;\n\t\tnodeEl?: HTMLElement;\n\t\tel?: HTMLElement;\n\t\twrapperEl?: HTMLElement;\n\t\tcontainerEl?: HTMLElement;\n\t} | undefined;\n\tif (nodes instanceof Map) {\n\t\tview = nodes.get(nodeId) as typeof view;\n\t} else {\n\t\tfor (const n of nodes as Iterable&lt;typeof view&gt;) {\n\t\t\tif (n?.id === nodeId) {\n\t\t\t\tview = n;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\tif (!view) return null;\n\t// Obsidian canvas node view exposes the .canvas-node root via one of these\n\tif (view.nodeEl instanceof HTMLElement) return view.nodeEl;\n\tif (view.el instanceof HTMLElement) return view.el;\n\tif (view.wrapperEl instanceof HTMLElement) return view.wrapperEl;\n\tif (view.containerEl instanceof HTMLElement) return view.containerEl;\n\tif (view instanceof HTMLElement) return view;\n\treturn null;\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "import type {Vault} from \"obsidian\";",
            "lineNumber": 1
          },
          {
            "text": "import {loadCanvasData} from \"./nodes\";",
            "lineNumber": 2
          },
          {
            "text": "import {getNodeRole, isOutputEdge} from \"./types\";",
            "lineNumber": 3
          },
          {
            "text": "import type {CanvasColor, NodeRole, ZettelPluginSettings} from \"../settings\";",
            "lineNumber": 4
          },
          {
            "text": "import {getPresetColor, getRoleLabel} from \"../settings\";",
            "lineNumber": 5
          },
          {
            "text": "import type {LiveCanvas} from \"../engine/canvasApi\";",
            "lineNumber": 6
          },
          {
            "text": "import {getCanvasKey, getEdgeMode, getRunningNodeId} from \"../engine/state\";",
            "lineNumber": 7
          },
          {
            "lineNumber": 8
          },
          {
            "text": "const LABEL_CLASS = \"ztb-node-role-label\";",
            "lineNumber": 9
          },
          {
            "text": "const LABEL_DATA_ATTR = \"data-ztb-role-label\";",
            "lineNumber": 10
          },
          {
            "text": "const LEGEND_CLASS = \"ztb-canvas-legend\";",
            "lineNumber": 11
          },
          {
            "text": "const EDGE_MODE_LABEL_CLASS = \"ztb-edge-mode-label\";",
            "lineNumber": 12
          },
          {
            "text": "const EDGE_MODE_DATA_ATTR = \"data-ztb-edge-id\";",
            "lineNumber": 13
          },
          {
            "text": "const EDGE_MODE_STATE_ATTR = \"data-ztb-edge-state\";",
            "lineNumber": 14
          },
          {
            "text": "const EDGE_MODE_ICON_CLASS = \"ztb-edge-mode-icon\";",
            "lineNumber": 15
          },
          {
            "text": "type EdgeDisplayState = \"running\" | \"inject\" | \"concatenate\";",
            "lineNumber": 16,
            "isSignature": true
          },
          {
            "text": "const ROLES: NodeRole[] = [\"orange\", \"purple\", \"blue\", \"yellow\", \"green\"];",
            "lineNumber": 17
          },
          {
            "lineNumber": 18
          },
          {
            "text": "/** Try to get a canvas node's root DOM element from the live canvas (Obsidian uses .canvas-node, no data-id). */",
            "lineNumber": 19
          },
          {
            "text": "function getNodeElFromCanvas(canvas: LiveCanvas, nodeId: string): HTMLElement | null {",
            "lineNumber": 20,
            "isSignature": true
          },
          {
            "text": "\tconst nodes = canvas.nodes;",
            "lineNumber": 21
          },
          {
            "text": "\tif (!nodes) return null;",
            "lineNumber": 22
          },
          {
            "text": "\tlet view: {",
            "lineNumber": 23
          },
          {
            "text": "\t\tid?: string;",
            "lineNumber": 24
          },
          {
            "text": "\t\tnodeEl?: HTMLElement;",
            "lineNumber": 25
          },
          {
            "text": "\t\tel?: HTMLElement;",
            "lineNumber": 26
          },
          {
            "text": "\t\twrapperEl?: HTMLElement;",
            "lineNumber": 27
          },
          {
            "text": "\t\tcontainerEl?: HTMLElement;",
            "lineNumber": 28
          },
          {
            "text": "\t} | undefined;",
            "lineNumber": 29
          },
          {
            "text": "\tif (nodes instanceof Map) {",
            "lineNumber": 30
          },
          {
            "text": "\t\tview = nodes.get(nodeId) as typeof view;",
            "lineNumber": 31
          },
          {
            "text": "\t} else {",
            "lineNumber": 32
          },
          {
            "text": "\t\tfor (const n of nodes as Iterable&lt;typeof view&gt;) {",
            "lineNumber": 33
          },
          {
            "text": "\t\t\tif (n?.id === nodeId) {",
            "lineNumber": 34
          },
          {
            "text": "\t\t\t\tview = n;",
            "lineNumber": 35
          },
          {
            "text": "\t\t\t\tbreak;",
            "lineNumber": 36
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 37
          },
          {
            "text": "\t\t}",
            "lineNumber": 38
          },
          {
            "text": "\t}",
            "lineNumber": 39
          },
          {
            "text": "\tif (!view) return null;",
            "lineNumber": 40
          },
          {
            "text": "\t// Obsidian canvas node view exposes the .canvas-node root via one of these",
            "lineNumber": 41
          },
          {
            "text": "\tif (view.nodeEl instanceof HTMLElement) return view.nodeEl;",
            "lineNumber": 42
          },
          {
            "text": "\tif (view.el instanceof HTMLElement) return view.el;",
            "lineNumber": 43
          },
          {
            "text": "\tif (view.wrapperEl instanceof HTMLElement) return view.wrapperEl;",
            "lineNumber": 44
          },
          {
            "text": "\tif (view.containerEl instanceof HTMLElement) return view.containerEl;",
            "lineNumber": 45
          },
          {
            "text": "\tif (view instanceof HTMLElement) return view;",
            "lineNumber": 46
          },
          {
            "text": "\treturn null;",
            "lineNumber": 47
          },
          {
            "text": "}",
            "lineNumber": 48,
            "isSignature": true
          }
        ]
      },
      "score": 0.1428430676460266
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/canvasNodeLabels.ts",
        "range": {
          "startPosition": {
            "line": 168
          },
          "endPosition": {
            "line": 230,
            "column": 1
          }
        },
        "contents": "function getElCenter(el: HTMLElement): { x: number; y: number } {\n\n\treturn { x: r.left + r.width / 2, y: r.top + r.height / 2 };\n}\n\n/**\n * Sync floating edge mode labels: for each edge with a mode (inject/concatenate) or incoming to the running node,\n * show a small label with colored icon + text at the edge midpoint.\n */\nexport async function syncCanvasEdgeModeLabels(\n\tvault: Vault,\n\tcanvasFilePath: string,\n\tcontainerEl: HTMLElement,\n\tcanvas: LiveCanvas | null\n): Promise&lt;void&gt; {\n\tclearCanvasEdgeModeLabels(containerEl);\n\tconst data = await loadCanvasData(vault, canvasFilePath);\n\tif (!data?.edges) return;\n\tconst canvasKey = getCanvasKey(canvasFilePath);\n\tconst runningNodeId = getRunningNodeId(canvasKey);\n\tconst containerRect = containerEl.getBoundingClientRect();\n\tfor (const edge of data.edges) {\n\t\tif (isOutputEdge(edge)) continue;\n\t\tconst isRunning = runningNodeId != null &amp;&amp; edge.toNode === runningNodeId;\n\t\tconst mode = getEdgeMode(canvasKey, edge.id);\n\t\tconst state: EdgeDisplayState | null = isRunning\n\t\t\t? \"running\"\n\t\t\t: mode === \"inject\"\n\t\t\t\t? \"inject\"\n\t\t\t\t: mode === \"concatenate\"\n\t\t\t\t\t? \"concatenate\"\n\t\t\t\t\t: null;\n\t\tif (!state) continue;\n\t\tconst fromEl =\n\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, edge.fromNode)) ||\n\t\t\tfindNodeElementByDataId(containerEl, edge.fromNode);\n\t\tconst toEl =\n\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, edge.toNode)) ||\n\t\t\tfindNodeElementByDataId(containerEl, edge.toNode);\n\t\tif (!fromEl || !toEl) continue;\n\t\tconst fromCenter = getElCenter(fromEl);\n\t\tconst toCenter = getElCenter(toEl);\n\t\tconst midX = (fromCenter.x + toCenter.x) / 2 - containerRect.left + containerEl.scrollLeft;\n\t\tconst midY = (fromCenter.y + toCenter.y) / 2 - containerRect.top + containerEl.scrollTop;\n\t\tconst label = document.createElement(\"div\");\n\t\tlabel.setAttribute(\"class\", EDGE_MODE_LABEL_CLASS);\n\t\tlabel.setAttribute(EDGE_MODE_DATA_ATTR, edge.id);\n\t\tlabel.setAttribute(EDGE_MODE_STATE_ATTR, state);\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "function getElCenter(el: HTMLElement): { x: number; y: number } {",
            "lineNumber": 169,
            "isSignature": true
          },
          {
            "lineNumber": 170
          },
          {
            "text": "\treturn { x: r.left + r.width / 2, y: r.top + r.height / 2 };",
            "lineNumber": 171
          },
          {
            "text": "}",
            "lineNumber": 172,
            "isSignature": true
          },
          {
            "lineNumber": 173
          },
          {
            "text": "/**",
            "lineNumber": 174
          },
          {
            "text": " * Sync floating edge mode labels: for each edge with a mode (inject/concatenate) or incoming to the running node,",
            "lineNumber": 175
          },
          {
            "text": " * show a small label with colored icon + text at the edge midpoint.",
            "lineNumber": 176
          },
          {
            "text": " */",
            "lineNumber": 177
          },
          {
            "text": "export async function syncCanvasEdgeModeLabels(",
            "lineNumber": 178,
            "isSignature": true
          },
          {
            "text": "\tvault: Vault,",
            "lineNumber": 179,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 180,
            "isSignature": true
          },
          {
            "text": "\tcontainerEl: HTMLElement,",
            "lineNumber": 181,
            "isSignature": true
          },
          {
            "text": "\tcanvas: LiveCanvas | null",
            "lineNumber": 182,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;void&gt; {",
            "lineNumber": 183,
            "isSignature": true
          },
          {
            "text": "\tclearCanvasEdgeModeLabels(containerEl);",
            "lineNumber": 184
          },
          {
            "text": "\tconst data = await loadCanvasData(vault, canvasFilePath);",
            "lineNumber": 185
          },
          {
            "text": "\tif (!data?.edges) return;",
            "lineNumber": 186
          },
          {
            "text": "\tconst canvasKey = getCanvasKey(canvasFilePath);",
            "lineNumber": 187
          },
          {
            "text": "\tconst runningNodeId = getRunningNodeId(canvasKey);",
            "lineNumber": 188
          },
          {
            "text": "\tconst containerRect = containerEl.getBoundingClientRect();",
            "lineNumber": 189
          },
          {
            "text": "\tfor (const edge of data.edges) {",
            "lineNumber": 190
          },
          {
            "text": "\t\tif (isOutputEdge(edge)) continue;",
            "lineNumber": 191
          },
          {
            "text": "\t\tconst isRunning = runningNodeId != null &amp;&amp; edge.toNode === runningNodeId;",
            "lineNumber": 192
          },
          {
            "text": "\t\tconst mode = getEdgeMode(canvasKey, edge.id);",
            "lineNumber": 193
          },
          {
            "text": "\t\tconst state: EdgeDisplayState | null = isRunning",
            "lineNumber": 194
          },
          {
            "text": "\t\t\t? \"running\"",
            "lineNumber": 195
          },
          {
            "text": "\t\t\t: mode === \"inject\"",
            "lineNumber": 196
          },
          {
            "text": "\t\t\t\t? \"inject\"",
            "lineNumber": 197
          },
          {
            "text": "\t\t\t\t: mode === \"concatenate\"",
            "lineNumber": 198
          },
          {
            "text": "\t\t\t\t\t? \"concatenate\"",
            "lineNumber": 199
          },
          {
            "text": "\t\t\t\t\t: null;",
            "lineNumber": 200
          },
          {
            "text": "\t\tif (!state) continue;",
            "lineNumber": 201
          },
          {
            "text": "\t\tconst fromEl =",
            "lineNumber": 202
          },
          {
            "text": "\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, edge.fromNode)) ||",
            "lineNumber": 203
          },
          {
            "text": "\t\t\tfindNodeElementByDataId(containerEl, edge.fromNode);",
            "lineNumber": 204
          },
          {
            "text": "\t\tconst toEl =",
            "lineNumber": 205
          },
          {
            "text": "\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, edge.toNode)) ||",
            "lineNumber": 206
          },
          {
            "text": "\t\t\tfindNodeElementByDataId(containerEl, edge.toNode);",
            "lineNumber": 207
          },
          {
            "text": "\t\tif (!fromEl || !toEl) continue;",
            "lineNumber": 208
          },
          {
            "text": "\t\tconst fromCenter = getElCenter(fromEl);",
            "lineNumber": 209
          },
          {
            "text": "\t\tconst toCenter = getElCenter(toEl);",
            "lineNumber": 210
          },
          {
            "text": "\t\tconst midX = (fromCenter.x + toCenter.x) / 2 - containerRect.left + containerEl.scrollLeft;",
            "lineNumber": 211
          },
          {
            "text": "\t\tconst midY = (fromCenter.y + toCenter.y) / 2 - containerRect.top + containerEl.scrollTop;",
            "lineNumber": 212
          },
          {
            "text": "\t\tconst label = document.createElement(\"div\");",
            "lineNumber": 213
          },
          {
            "text": "\t\tlabel.setAttribute(\"class\", EDGE_MODE_LABEL_CLASS);",
            "lineNumber": 214
          },
          {
            "text": "\t\tlabel.setAttribute(EDGE_MODE_DATA_ATTR, edge.id);",
            "lineNumber": 215
          },
          {
            "text": "\t\tlabel.setAttribute(EDGE_MODE_STATE_ATTR, state);",
            "lineNumber": 216
          },
          {
            "text": "}",
            "lineNumber": 231,
            "isSignature": true
          }
        ]
      },
      "score": 0.14113736152648926
    }
  ]
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="semantic_search_full">
<details>
<summary>Tool use: **semantic_search_full**</summary>


Parameters:

```json
{
  "query": "Run entire canvas or run all nodes",
  "includePattern": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
  "topK": 10,
  "explanation": ""
}
```
Result:

```json
{
  "codeResults": [
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 231
          },
          "endPosition": {
            "line": 314,
            "column": 1
          }
        },
        "contents": "function ensureOutputNodeAndEdge(\n\tdata: CanvasData,\n\tsourceNode: AllCanvasNodeData,\n\ttext: string,\n\tsettings: ZettelPluginSettings\n): void {\n\n\n\t\tlabel: EDGE_LABEL_OUTPUT,\n\t});\n}\n\n/** Run a single node (for \"Run Node\" command). Returns result or error message. */\nexport async function runNode(\n\tapp: App,\n\tsettings: ZettelPluginSettings,\n\tcanvasFilePath: string,\n\tnodeId: string,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;{ ok: boolean; message?: string }&gt; {\n\tconst data = await loadCanvasData(app.vault, canvasFilePath);\n\tif (!data) return { ok: false, message: \"Could not load canvas data.\" };\n\tconst node = getNodeById(data, nodeId);\n\tif (!node) return { ok: false, message: \"Node not found.\" };\n\tconst role = getNodeRole(node, settings);\n\tif (!role) return { ok: false, message: \"Node color is not mapped to a role.\" };\n\tif (role === \"green\") return { ok: false, message: \"Green nodes are output-only.\" };\n\tconst parentIds = getParentIdsSortedByY(nodeId, data);\n\tfor (const pid of parentIds) {\n\t\tif (getNodeResult(getCanvasKey(canvasFilePath), pid) == null) {\n\t\t\treturn { ok: false, message: \"Parent node(s) have not been run yet. Run chain or run parents first.\" };\n\t\t}\n\t}\n\tconst canvasKey = getCanvasKey(canvasFilePath);\n\ttry {\n\t\tsetRunningNodeId(canvasKey, nodeId);\n\t\tawait runSingleNode(app, settings, canvasKey, canvasFilePath, data, nodeId, liveCanvas);\n\t\treturn { ok: true };\n\t} catch (e) {\n\t\treturn { ok: false, message: e instanceof Error ? e.message : String(e) };\n\t} finally {\n\t\tsetRunningNodeId(canvasKey, null);\n\t}\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "function ensureOutputNodeAndEdge(",
            "lineNumber": 232,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 233,
            "isSignature": true
          },
          {
            "text": "\tsourceNode: AllCanvasNodeData,",
            "lineNumber": 234,
            "isSignature": true
          },
          {
            "text": "\ttext: string,",
            "lineNumber": 235,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings",
            "lineNumber": 236,
            "isSignature": true
          },
          {
            "text": "): void {",
            "lineNumber": 237,
            "isSignature": true
          },
          {
            "lineNumber": 276
          },
          {
            "lineNumber": 279
          },
          {
            "text": "\t\tlabel: EDGE_LABEL_OUTPUT,",
            "lineNumber": 280
          },
          {
            "text": "\t});",
            "lineNumber": 281
          },
          {
            "text": "}",
            "lineNumber": 282,
            "isSignature": true
          },
          {
            "lineNumber": 283
          },
          {
            "text": "/** Run a single node (for \"Run Node\" command). Returns result or error message. */",
            "lineNumber": 284
          },
          {
            "text": "export async function runNode(",
            "lineNumber": 285,
            "isSignature": true
          },
          {
            "text": "\tapp: App,",
            "lineNumber": 286,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 287,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 288,
            "isSignature": true
          },
          {
            "text": "\tnodeId: string,",
            "lineNumber": 289,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 290,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;{ ok: boolean; message?: string }&gt; {",
            "lineNumber": 291,
            "isSignature": true
          },
          {
            "text": "\tconst data = await loadCanvasData(app.vault, canvasFilePath);",
            "lineNumber": 292
          },
          {
            "text": "\tif (!data) return { ok: false, message: \"Could not load canvas data.\" };",
            "lineNumber": 293
          },
          {
            "text": "\tconst node = getNodeById(data, nodeId);",
            "lineNumber": 294
          },
          {
            "text": "\tif (!node) return { ok: false, message: \"Node not found.\" };",
            "lineNumber": 295
          },
          {
            "text": "\tconst role = getNodeRole(node, settings);",
            "lineNumber": 296
          },
          {
            "text": "\tif (!role) return { ok: false, message: \"Node color is not mapped to a role.\" };",
            "lineNumber": 297
          },
          {
            "text": "\tif (role === \"green\") return { ok: false, message: \"Green nodes are output-only.\" };",
            "lineNumber": 298
          },
          {
            "text": "\tconst parentIds = getParentIdsSortedByY(nodeId, data);",
            "lineNumber": 299
          },
          {
            "text": "\tfor (const pid of parentIds) {",
            "lineNumber": 300
          },
          {
            "text": "\t\tif (getNodeResult(getCanvasKey(canvasFilePath), pid) == null) {",
            "lineNumber": 301
          },
          {
            "text": "\t\t\treturn { ok: false, message: \"Parent node(s) have not been run yet. Run chain or run parents first.\" };",
            "lineNumber": 302
          },
          {
            "text": "\t\t}",
            "lineNumber": 303
          },
          {
            "text": "\t}",
            "lineNumber": 304
          },
          {
            "text": "\tconst canvasKey = getCanvasKey(canvasFilePath);",
            "lineNumber": 305
          },
          {
            "text": "\ttry {",
            "lineNumber": 306
          },
          {
            "text": "\t\tsetRunningNodeId(canvasKey, nodeId);",
            "lineNumber": 307
          },
          {
            "text": "\t\tawait runSingleNode(app, settings, canvasKey, canvasFilePath, data, nodeId, liveCanvas);",
            "lineNumber": 308
          },
          {
            "text": "\t\treturn { ok: true };",
            "lineNumber": 309
          },
          {
            "text": "\t} catch (e) {",
            "lineNumber": 310
          },
          {
            "text": "\t\treturn { ok: false, message: e instanceof Error ? e.message : String(e) };",
            "lineNumber": 311
          },
          {
            "text": "\t} finally {",
            "lineNumber": 312
          },
          {
            "text": "\t\tsetRunningNodeId(canvasKey, null);",
            "lineNumber": 313
          },
          {
            "text": "\t}",
            "lineNumber": 314
          },
          {
            "text": "}",
            "lineNumber": 315,
            "isSignature": true
          }
        ]
      },
      "score": 0.4355663061141968
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 284
          },
          "endPosition": {
            "line": 344,
            "column": 1
          }
        },
        "contents": "export async function runNode(\n\tapp: App,\n\tsettings: ZettelPluginSettings,\n\tcanvasFilePath: string,\n\tnodeId: string,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;{ ok: boolean; message?: string }&gt; {\n\n\t} finally {\n\t\tsetRunningNodeId(canvasKey, null);\n\t}\n}\n\n/** Run chain from roots to the given node. */\nexport async function runChain(\n\tapp: App,\n\tsettings: ZettelPluginSettings,\n\tcanvasFilePath: string,\n\tnodeId: string,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;{ ok: boolean; message?: string }&gt; {\n\tconst data = await loadCanvasData(app.vault, canvasFilePath);\n\tif (!data) return { ok: false, message: \"Could not load canvas data.\" };\n\tconst roots = getRootIds(data);\n\tconst rootsReachingCurrent = roots.filter((r) =&gt; canReach(data, r, nodeId));\n\tif (rootsReachingCurrent.length === 0) return { ok: false, message: \"No root reaches this node.\" };\n\tconst order = topologicalOrderToTarget(data, nodeId);\n\tconst canvasKey = getCanvasKey(canvasFilePath);\n\ttry {\n\t\tfor (const nid of order) {\n\t\t\ttry {\n\t\t\t\tsetRunningNodeId(canvasKey, nid);\n\t\t\t\tawait runSingleNode(app, settings, canvasKey, canvasFilePath, data, nid, liveCanvas);\n\t\t\t} finally {\n\t\t\t\tsetRunningNodeId(canvasKey, null);\n\t\t\t}\n\t\t}\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "export async function runNode(",
            "lineNumber": 285,
            "isSignature": true
          },
          {
            "text": "\tapp: App,",
            "lineNumber": 286,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 287,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 288,
            "isSignature": true
          },
          {
            "text": "\tnodeId: string,",
            "lineNumber": 289,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 290,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;{ ok: boolean; message?: string }&gt; {",
            "lineNumber": 291,
            "isSignature": true
          },
          {
            "lineNumber": 311
          },
          {
            "text": "\t} finally {",
            "lineNumber": 312
          },
          {
            "text": "\t\tsetRunningNodeId(canvasKey, null);",
            "lineNumber": 313
          },
          {
            "text": "\t}",
            "lineNumber": 314
          },
          {
            "text": "}",
            "lineNumber": 315,
            "isSignature": true
          },
          {
            "lineNumber": 316
          },
          {
            "text": "/** Run chain from roots to the given node. */",
            "lineNumber": 317
          },
          {
            "text": "export async function runChain(",
            "lineNumber": 318,
            "isSignature": true
          },
          {
            "text": "\tapp: App,",
            "lineNumber": 319,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 320,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 321,
            "isSignature": true
          },
          {
            "text": "\tnodeId: string,",
            "lineNumber": 322,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 323,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;{ ok: boolean; message?: string }&gt; {",
            "lineNumber": 324,
            "isSignature": true
          },
          {
            "text": "\tconst data = await loadCanvasData(app.vault, canvasFilePath);",
            "lineNumber": 325
          },
          {
            "text": "\tif (!data) return { ok: false, message: \"Could not load canvas data.\" };",
            "lineNumber": 326
          },
          {
            "text": "\tconst roots = getRootIds(data);",
            "lineNumber": 327
          },
          {
            "text": "\tconst rootsReachingCurrent = roots.filter((r) =&gt; canReach(data, r, nodeId));",
            "lineNumber": 328
          },
          {
            "text": "\tif (rootsReachingCurrent.length === 0) return { ok: false, message: \"No root reaches this node.\" };",
            "lineNumber": 329
          },
          {
            "text": "\tconst order = topologicalOrderToTarget(data, nodeId);",
            "lineNumber": 330
          },
          {
            "text": "\tconst canvasKey = getCanvasKey(canvasFilePath);",
            "lineNumber": 331
          },
          {
            "text": "\ttry {",
            "lineNumber": 332
          },
          {
            "text": "\t\tfor (const nid of order) {",
            "lineNumber": 333
          },
          {
            "text": "\t\t\ttry {",
            "lineNumber": 334
          },
          {
            "text": "\t\t\t\tsetRunningNodeId(canvasKey, nid);",
            "lineNumber": 335
          },
          {
            "text": "\t\t\t\tawait runSingleNode(app, settings, canvasKey, canvasFilePath, data, nid, liveCanvas);",
            "lineNumber": 336
          },
          {
            "text": "\t\t\t} finally {",
            "lineNumber": 337
          },
          {
            "text": "\t\t\t\tsetRunningNodeId(canvasKey, null);",
            "lineNumber": 338
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 339
          },
          {
            "text": "\t\t}",
            "lineNumber": 340
          },
          {
            "text": "}",
            "lineNumber": 345,
            "isSignature": true
          }
        ]
      },
      "score": 0.41616129875183105
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 27
          },
          "endPosition": {
            "line": 298,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\n\n\n\t/** Run a single node (call from context menu with node id). */\n\tasync runNode(nodeId: string): Promise&lt;void&gt; {\n\t\tconst view = this.getActiveCanvasView();\n\t\tif (!view) return;\n\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;\n\t\tconst result = await runnerRunNode(this.app, this.settings, view.file.path, nodeId, liveCanvas);\n\t\tif (!result.ok) new Notice(result.message ?? \"Run node failed.\");\n\t}\n\n\t/** Run chain from roots to the given node (call from context menu with node id). */\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 28,
                "column": 1
              },
              "endPosition": {
                "line": 28,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 28,
                "column": 16
              },
              "endPosition": {
                "line": 29,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 28,
            "isSignature": true
          },
          {
            "lineNumber": 265
          },
          {
            "lineNumber": 266
          },
          {
            "text": "\t/** Run a single node (call from context menu with node id). */",
            "lineNumber": 267
          },
          {
            "text": "\tasync runNode(nodeId: string): Promise&lt;void&gt; {",
            "lineNumber": 268
          },
          {
            "text": "\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 269
          },
          {
            "text": "\t\tif (!view) return;",
            "lineNumber": 270
          },
          {
            "text": "\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;",
            "lineNumber": 271
          },
          {
            "text": "\t\tconst result = await runnerRunNode(this.app, this.settings, view.file.path, nodeId, liveCanvas);",
            "lineNumber": 272
          },
          {
            "text": "\t\tif (!result.ok) new Notice(result.message ?? \"Run node failed.\");",
            "lineNumber": 273
          },
          {
            "text": "\t}",
            "lineNumber": 274
          },
          {
            "lineNumber": 275
          },
          {
            "text": "\t/** Run chain from roots to the given node (call from context menu with node id). */",
            "lineNumber": 276
          },
          {
            "text": "}",
            "lineNumber": 299,
            "isSignature": true
          }
        ]
      },
      "score": 0.36793965101242065
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 134
          },
          "endPosition": {
            "line": 220,
            "column": 1
          }
        },
        "contents": "async function updateEdgeLabelsAndSave(\n\tvault: App[\"vault\"],\n\tcanvasFilePath: string,\n\tdata: CanvasData,\n\tnodeId: string,\n\tedgeModes: Map&lt;string, EdgeInputMode&gt;,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;void&gt; {\n\n}\n\n/** Run a single node: get input + parent context (concatenate or {{var:name}}), call LLM or Python, store result. */\nasync function runSingleNode(\n\tapp: App,\n\tsettings: ZettelPluginSettings,\n\tcanvasKey: string,\n\tcanvasFilePath: string,\n\tdata: CanvasData,\n\tnodeId: string,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;string&gt; {\n\tconst node = getNodeById(data, nodeId);\n\tif (!node) return \"\";\n\tconst role = getNodeRole(node, settings);\n\tif (!role || role === \"yellow\" || role === \"green\") {\n\t\t// Yellow: pass-through (use node content as result)\n\t\tif (role === \"yellow\") {\n\t\t\tconst content = await getNodeContent(node, app.vault);\n\t\t\tsetNodeResult(canvasKey, nodeId, content);\n\t\t\treturn content;\n\t\t}\n\t\treturn \"\";\n\t}\n\tconst incoming = getIncomingEdgesWithLabels(nodeId, data);\n\tconst nodeInput = await getNodeContent(node, app.vault);\n\tconst { concatenatedPart, template, edgeModes } = buildInputWithVariables(\n\t\tcanvasKey,\n\t\tnodeInput,\n\t\tincoming\n\t);\n\tconst fullPrompt =\n\t\tconcatenatedPart.length &gt; 0 ? &#96;${concatenatedPart}\\n\\n---\\n\\n${template}&#96; : template;\n\n\tif (role === \"orange\") {\n\t\tconst model = settings.ollamaOrangeModel || \"llama2\";\n\t\tconst result = await ollamaGenerate({ model, prompt: fullPrompt, stream: false });\n\t\tsetNodeResult(canvasKey, nodeId, result);\n\t\tensureOutputNodeAndEdge(data, node, result, settings);\n\t\tawait updateEdgeLabelsAndSave(app.vault, canvasFilePath, data, nodeId, edgeModes, liveCanvas);\n\t\treturn result;\n\t}\n\tif (role === \"purple\") {\n\t\tconst model = settings.ollamaPurpleModel || \"llama2\";\n\t\tconst result = await ollamaGenerate({ model, prompt: fullPrompt, stream: false });\n\t\tsetNodeResult(canvasKey, nodeId, result);\n\t\tensureOutputNodeAndEdge(data, node, result, settings);\n\t\tawait updateEdgeLabelsAndSave(app.vault, canvasFilePath, data, nodeId, edgeModes, liveCanvas);\n\t\treturn result;\n\t}\n\tif (role === \"blue\") {\n\t\tconst kernel = getKernelForCanvas;\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "async function updateEdgeLabelsAndSave(",
            "lineNumber": 135,
            "isSignature": true
          },
          {
            "text": "\tvault: App[\"vault\"],",
            "lineNumber": 136,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 137,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 138,
            "isSignature": true
          },
          {
            "text": "\tnodeId: string,",
            "lineNumber": 139,
            "isSignature": true
          },
          {
            "text": "\tedgeModes: Map&lt;string, EdgeInputMode&gt;,",
            "lineNumber": 140,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 141,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;void&gt; {",
            "lineNumber": 142,
            "isSignature": true
          },
          {
            "lineNumber": 161
          },
          {
            "text": "}",
            "lineNumber": 162,
            "isSignature": true
          },
          {
            "lineNumber": 163
          },
          {
            "text": "/** Run a single node: get input + parent context (concatenate or {{var:name}}), call LLM or Python, store result. */",
            "lineNumber": 164
          },
          {
            "text": "async function runSingleNode(",
            "lineNumber": 165,
            "isSignature": true
          },
          {
            "text": "\tapp: App,",
            "lineNumber": 166,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 167,
            "isSignature": true
          },
          {
            "text": "\tcanvasKey: string,",
            "lineNumber": 168,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 169,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 170,
            "isSignature": true
          },
          {
            "text": "\tnodeId: string,",
            "lineNumber": 171,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 172,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;string&gt; {",
            "lineNumber": 173,
            "isSignature": true
          },
          {
            "text": "\tconst node = getNodeById(data, nodeId);",
            "lineNumber": 174
          },
          {
            "text": "\tif (!node) return \"\";",
            "lineNumber": 175
          },
          {
            "text": "\tconst role = getNodeRole(node, settings);",
            "lineNumber": 176
          },
          {
            "text": "\tif (!role || role === \"yellow\" || role === \"green\") {",
            "lineNumber": 177
          },
          {
            "text": "\t\t// Yellow: pass-through (use node content as result)",
            "lineNumber": 178
          },
          {
            "text": "\t\tif (role === \"yellow\") {",
            "lineNumber": 179
          },
          {
            "text": "\t\t\tconst content = await getNodeContent(node, app.vault);",
            "lineNumber": 180
          },
          {
            "text": "\t\t\tsetNodeResult(canvasKey, nodeId, content);",
            "lineNumber": 181
          },
          {
            "text": "\t\t\treturn content;",
            "lineNumber": 182
          },
          {
            "text": "\t\t}",
            "lineNumber": 183
          },
          {
            "text": "\t\treturn \"\";",
            "lineNumber": 184
          },
          {
            "text": "\t}",
            "lineNumber": 185
          },
          {
            "text": "\tconst incoming = getIncomingEdgesWithLabels(nodeId, data);",
            "lineNumber": 186
          },
          {
            "text": "\tconst nodeInput = await getNodeContent(node, app.vault);",
            "lineNumber": 187
          },
          {
            "text": "\tconst { concatenatedPart, template, edgeModes } = buildInputWithVariables(",
            "lineNumber": 188
          },
          {
            "text": "\t\tcanvasKey,",
            "lineNumber": 189
          },
          {
            "text": "\t\tnodeInput,",
            "lineNumber": 190
          },
          {
            "text": "\t\tincoming",
            "lineNumber": 191
          },
          {
            "text": "\t);",
            "lineNumber": 192
          },
          {
            "text": "\tconst fullPrompt =",
            "lineNumber": 193
          },
          {
            "text": "\t\tconcatenatedPart.length &gt; 0 ? &#96;${concatenatedPart}\\n\\n---\\n\\n${template}&#96; : template;",
            "lineNumber": 194
          },
          {
            "lineNumber": 195
          },
          {
            "text": "\tif (role === \"orange\") {",
            "lineNumber": 196
          },
          {
            "text": "\t\tconst model = settings.ollamaOrangeModel || \"llama2\";",
            "lineNumber": 197
          },
          {
            "text": "\t\tconst result = await ollamaGenerate({ model, prompt: fullPrompt, stream: false });",
            "lineNumber": 198
          },
          {
            "text": "\t\tsetNodeResult(canvasKey, nodeId, result);",
            "lineNumber": 199
          },
          {
            "text": "\t\tensureOutputNodeAndEdge(data, node, result, settings);",
            "lineNumber": 200
          },
          {
            "text": "\t\tawait updateEdgeLabelsAndSave(app.vault, canvasFilePath, data, nodeId, edgeModes, liveCanvas);",
            "lineNumber": 201
          },
          {
            "text": "\t\treturn result;",
            "lineNumber": 202
          },
          {
            "text": "\t}",
            "lineNumber": 203
          },
          {
            "text": "\tif (role === \"purple\") {",
            "lineNumber": 204
          },
          {
            "text": "\t\tconst model = settings.ollamaPurpleModel || \"llama2\";",
            "lineNumber": 205
          },
          {
            "text": "\t\tconst result = await ollamaGenerate({ model, prompt: fullPrompt, stream: false });",
            "lineNumber": 206
          },
          {
            "text": "\t\tsetNodeResult(canvasKey, nodeId, result);",
            "lineNumber": 207
          },
          {
            "text": "\t\tensureOutputNodeAndEdge(data, node, result, settings);",
            "lineNumber": 208
          },
          {
            "text": "\t\tawait updateEdgeLabelsAndSave(app.vault, canvasFilePath, data, nodeId, edgeModes, liveCanvas);",
            "lineNumber": 209
          },
          {
            "text": "\t\treturn result;",
            "lineNumber": 210
          },
          {
            "text": "\t}",
            "lineNumber": 211
          },
          {
            "text": "\tif (role === \"blue\") {",
            "lineNumber": 212
          },
          {
            "text": "\t\tconst kernel = getKernelForCanvas;",
            "lineNumber": 213
          },
          {
            "text": "}",
            "lineNumber": 221,
            "isSignature": true
          }
        ]
      },
      "score": 0.33417999744415283
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 22,
            "column": 1
          },
          "endPosition": {
            "line": 298,
            "column": 1
          }
        },
        "contents": "/** Debug: set to true when canvas:node-menu callback has fired at least once (proves event is received). */\nlet debugNodeMenuFired = false;\n\nexport default class ZettelThinkingBoardPlugin extends Plugin {\n\tsettings: ZettelPluginSettings;\n\n\tasync onload() {\n\t\ttry {\n\t\t\tawait this.loadSettings();\n\t\t\tthis.addSettingTab(new ZettelSettingTab(this.app, this));\n\n\t\t\tthis.registerView(\n\t\t\t\tZETTEL_CONTROLS_VIEW_TYPE,\n\t\t\t\t(leaf: WorkspaceLeaf) =&gt; new ZettelControlsView(leaf, this)\n\t\t\t);\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"open-zettel-controls\",\n\t\t\t\tname: \"Open Zettel Controls\",\n\t\t\t\tcallback: () =&gt; this.activateZettelControls(),\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"run-node\",\n\t\t\t\tname: \"Run node\",\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\t\tif (!view) return false;\n\t\t\t\t\tif (checking) return true;\n\t\t\t\t\t// Command palette: no node selected; prompt user to use context menu\n\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Run node\\\" to run it.\");\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"run-chain\",\n\t\t\t\tname: \"Run chain\",\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\t\tif (!view) return false;\n\t\t\t\t\tif (checking) return true;\n\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Run chain\\\" to run from roots.\");\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"dismiss-output\",\n\t\t\t\tname: \"Dismiss output\",\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\t\tif (!view) return false;\n\t\t\t\t\tif (checking) return true;\n\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Dismiss output\\\" to remove its output.\");\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\t// Canvas node context menu (event name is undocumented; try workspace.on(\"canvas:node-menu\")).\n\t}\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Debug: set to true when canvas:node-menu callback has fired at least once (proves event is received). */",
            "lineNumber": 25
          },
          {
            "text": "let debugNodeMenuFired = false;",
            "lineNumber": 26
          },
          {
            "lineNumber": 27
          },
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 28,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings;",
            "lineNumber": 29
          },
          {
            "lineNumber": 30
          },
          {
            "text": "\tasync onload() {",
            "lineNumber": 31
          },
          {
            "text": "\t\ttry {",
            "lineNumber": 32
          },
          {
            "text": "\t\t\tawait this.loadSettings();",
            "lineNumber": 33
          },
          {
            "text": "\t\t\tthis.addSettingTab(new ZettelSettingTab(this.app, this));",
            "lineNumber": 34
          },
          {
            "lineNumber": 35
          },
          {
            "text": "\t\t\tthis.registerView(",
            "lineNumber": 36
          },
          {
            "text": "\t\t\t\tZETTEL_CONTROLS_VIEW_TYPE,",
            "lineNumber": 37
          },
          {
            "text": "\t\t\t\t(leaf: WorkspaceLeaf) =&gt; new ZettelControlsView(leaf, this)",
            "lineNumber": 38
          },
          {
            "text": "\t\t\t);",
            "lineNumber": 39
          },
          {
            "lineNumber": 40
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 41
          },
          {
            "text": "\t\t\t\tid: \"open-zettel-controls\",",
            "lineNumber": 42
          },
          {
            "text": "\t\t\t\tname: \"Open Zettel Controls\",",
            "lineNumber": 43
          },
          {
            "text": "\t\t\t\tcallback: () =&gt; this.activateZettelControls(),",
            "lineNumber": 44
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 45
          },
          {
            "lineNumber": 46
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 47
          },
          {
            "text": "\t\t\t\tid: \"run-node\",",
            "lineNumber": 48
          },
          {
            "text": "\t\t\t\tname: \"Run node\",",
            "lineNumber": 49
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 50
          },
          {
            "text": "\t\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 51
          },
          {
            "text": "\t\t\t\t\tif (!view) return false;",
            "lineNumber": 52
          },
          {
            "text": "\t\t\t\t\tif (checking) return true;",
            "lineNumber": 53
          },
          {
            "text": "\t\t\t\t\t// Command palette: no node selected; prompt user to use context menu",
            "lineNumber": 54
          },
          {
            "text": "\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Run node\\\" to run it.\");",
            "lineNumber": 55
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 56
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 57
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 58
          },
          {
            "lineNumber": 59
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 60
          },
          {
            "text": "\t\t\t\tid: \"run-chain\",",
            "lineNumber": 61
          },
          {
            "text": "\t\t\t\tname: \"Run chain\",",
            "lineNumber": 62
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 63
          },
          {
            "text": "\t\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 64
          },
          {
            "text": "\t\t\t\t\tif (!view) return false;",
            "lineNumber": 65
          },
          {
            "text": "\t\t\t\t\tif (checking) return true;",
            "lineNumber": 66
          },
          {
            "text": "\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Run chain\\\" to run from roots.\");",
            "lineNumber": 67
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 68
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 69
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 70
          },
          {
            "lineNumber": 71
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 72
          },
          {
            "text": "\t\t\t\tid: \"dismiss-output\",",
            "lineNumber": 73
          },
          {
            "text": "\t\t\t\tname: \"Dismiss output\",",
            "lineNumber": 74
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 75
          },
          {
            "text": "\t\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 76
          },
          {
            "text": "\t\t\t\t\tif (!view) return false;",
            "lineNumber": 77
          },
          {
            "text": "\t\t\t\t\tif (checking) return true;",
            "lineNumber": 78
          },
          {
            "text": "\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Dismiss output\\\" to remove its output.\");",
            "lineNumber": 79
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 80
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 81
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 82
          },
          {
            "lineNumber": 83
          },
          {
            "text": "\t\t\t// Canvas node context menu (event name is undocumented; try workspace.on(\"canvas:node-menu\")).",
            "lineNumber": 84
          },
          {
            "text": "\t}",
            "lineNumber": 196
          },
          {
            "text": "}",
            "lineNumber": 299,
            "isSignature": true
          }
        ]
      },
      "score": 0.32438260316848755
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 27
          },
          "endPosition": {
            "line": 298,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\n\n\n\t/** Run chain from roots to the given node (call from context menu with node id). */\n\tasync runChain(nodeId: string): Promise&lt;void&gt; {\n\t\tconst view = this.getActiveCanvasView();\n\t\tif (!view) return;\n\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;\n\t\tconst result = await runnerRunChain(this.app, this.settings, view.file.path, nodeId, liveCanvas);\n\t\tif (!result.ok) new Notice(result.message ?? \"Run chain failed.\");\n\t}\n\n\t/** Dismiss the Green output node for the given source node (call from context menu with node id). */\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 28,
                "column": 1
              },
              "endPosition": {
                "line": 28,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 28,
                "column": 16
              },
              "endPosition": {
                "line": 29,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 28,
            "isSignature": true
          },
          {
            "lineNumber": 274
          },
          {
            "lineNumber": 275
          },
          {
            "text": "\t/** Run chain from roots to the given node (call from context menu with node id). */",
            "lineNumber": 276
          },
          {
            "text": "\tasync runChain(nodeId: string): Promise&lt;void&gt; {",
            "lineNumber": 277
          },
          {
            "text": "\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 278
          },
          {
            "text": "\t\tif (!view) return;",
            "lineNumber": 279
          },
          {
            "text": "\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;",
            "lineNumber": 280
          },
          {
            "text": "\t\tconst result = await runnerRunChain(this.app, this.settings, view.file.path, nodeId, liveCanvas);",
            "lineNumber": 281
          },
          {
            "text": "\t\tif (!result.ok) new Notice(result.message ?? \"Run chain failed.\");",
            "lineNumber": 282
          },
          {
            "text": "\t}",
            "lineNumber": 283
          },
          {
            "lineNumber": 284
          },
          {
            "text": "\t/** Dismiss the Green output node for the given source node (call from context menu with node id). */",
            "lineNumber": 285
          },
          {
            "text": "}",
            "lineNumber": 299,
            "isSignature": true
          }
        ]
      },
      "score": 0.3192755877971649
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 27
          },
          "endPosition": {
            "line": 298,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\nasync onload() {\n\n\n\t\t\t// Canvas node context menu (event name is undocumented; try workspace.on(\"canvas:node-menu\")).\n\t\t\t// Defer registration so Obsidian canvas is ready (avoids \"reading '_'\" in app.js).\n\t\t\tconst addNodeMenuItems = (menu: Menu, node: unknown): void =&gt; {\n\t\t\t\tdebugNodeMenuFired = true;\n\t\t\t\tconst nodeId = resolveCanvasNodeId(node);\n\t\t\t\tif (!nodeId) return;\n\t\t\t\tmenu.addItem((item) =&gt;\n\t\t\t\t\titem.setTitle(\"Run node\").setIcon(\"play\").onClick(() =&gt; this.runNode(nodeId))\n\t\t\t\t);\n\t\t\t\tmenu.addItem((item) =&gt;\n\t\t\t\t\titem.setTitle(\"Run chain\").setIcon(\"forward\").onClick(() =&gt; this.runChain(nodeId))\n\t\t\t\t);\n\t\t\t\tmenu.addItem((item) =&gt;\n\t\t\t\t\titem.setTitle(\"Dismiss output\").setIcon(\"trash\").onClick(() =&gt; this.dismissOutput(nodeId))\n\t\t\t\t);\n\t\t\t};\n\t\t\tconst registerCanvasNodeMenu = () =&gt; {\n\t\t\t\ttry {\n\t\t\t\t\tconst on = this.app.workspace.on.bind(this.app.workspace) as (\n\t\t\t\t\t\tname: string,\n\t\t\t\t\t\tcallback: (menu: Menu, node: unknown) =&gt; void\n\t\t\t\t\t) =&gt; ReturnType&lt;typeof this.app.workspace.on&gt;;\n\t\t\t\t\t// Try documented-style event name first; some Obsidian builds use \"canvas:node-menu\".\n\t\t\t\t\tthis.registerEvent(on(\"canvas:node-menu\", addNodeMenuItems));\n\t\t\t\t\t// Fallback: try hyphenated name in case the app triggers a different event.\n\t\t\t\t\tthis.registerEvent(on(\"canvas-node-menu\", addNodeMenuItems));\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconsole.error(\"Zettel Thinking Board: could not register canvas node menu.\", e);\n\t\t\t\t}\n\t\t\t};\n\t\t\tconst timeoutId = window.setTimeout(registerCanvasNodeMenu, 0);\n\t\t\tthis.register(() =&gt; window.clearTimeout(timeoutId));\n\n\t\t\t// Debug: command to test if we can affect the canvas and if canvas:node-menu ever fires.\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 28,
                "column": 1
              },
              "endPosition": {
                "line": 28,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 28,
                "column": 16
              },
              "endPosition": {
                "line": 29,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 31,
                "column": 2
              },
              "endPosition": {
                "line": 32,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 28,
            "isSignature": true
          },
          {
            "text": "async onload() {",
            "lineNumber": 31
          },
          {
            "lineNumber": 82
          },
          {
            "lineNumber": 83
          },
          {
            "text": "\t\t\t// Canvas node context menu (event name is undocumented; try workspace.on(\"canvas:node-menu\")).",
            "lineNumber": 84
          },
          {
            "text": "\t\t\t// Defer registration so Obsidian canvas is ready (avoids \"reading '_'\" in app.js).",
            "lineNumber": 85
          },
          {
            "text": "\t\t\tconst addNodeMenuItems = (menu: Menu, node: unknown): void =&gt; {",
            "lineNumber": 86
          },
          {
            "text": "\t\t\t\tdebugNodeMenuFired = true;",
            "lineNumber": 87
          },
          {
            "text": "\t\t\t\tconst nodeId = resolveCanvasNodeId(node);",
            "lineNumber": 88
          },
          {
            "text": "\t\t\t\tif (!nodeId) return;",
            "lineNumber": 89
          },
          {
            "text": "\t\t\t\tmenu.addItem((item) =&gt;",
            "lineNumber": 90
          },
          {
            "text": "\t\t\t\t\titem.setTitle(\"Run node\").setIcon(\"play\").onClick(() =&gt; this.runNode(nodeId))",
            "lineNumber": 91
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 92
          },
          {
            "text": "\t\t\t\tmenu.addItem((item) =&gt;",
            "lineNumber": 93
          },
          {
            "text": "\t\t\t\t\titem.setTitle(\"Run chain\").setIcon(\"forward\").onClick(() =&gt; this.runChain(nodeId))",
            "lineNumber": 94
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 95
          },
          {
            "text": "\t\t\t\tmenu.addItem((item) =&gt;",
            "lineNumber": 96
          },
          {
            "text": "\t\t\t\t\titem.setTitle(\"Dismiss output\").setIcon(\"trash\").onClick(() =&gt; this.dismissOutput(nodeId))",
            "lineNumber": 97
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 98
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 99
          },
          {
            "text": "\t\t\tconst registerCanvasNodeMenu = () =&gt; {",
            "lineNumber": 100
          },
          {
            "text": "\t\t\t\ttry {",
            "lineNumber": 101
          },
          {
            "text": "\t\t\t\t\tconst on = this.app.workspace.on.bind(this.app.workspace) as (",
            "lineNumber": 102
          },
          {
            "text": "\t\t\t\t\t\tname: string,",
            "lineNumber": 103
          },
          {
            "text": "\t\t\t\t\t\tcallback: (menu: Menu, node: unknown) =&gt; void",
            "lineNumber": 104
          },
          {
            "text": "\t\t\t\t\t) =&gt; ReturnType&lt;typeof this.app.workspace.on&gt;;",
            "lineNumber": 105
          },
          {
            "text": "\t\t\t\t\t// Try documented-style event name first; some Obsidian builds use \"canvas:node-menu\".",
            "lineNumber": 106
          },
          {
            "text": "\t\t\t\t\tthis.registerEvent(on(\"canvas:node-menu\", addNodeMenuItems));",
            "lineNumber": 107
          },
          {
            "text": "\t\t\t\t\t// Fallback: try hyphenated name in case the app triggers a different event.",
            "lineNumber": 108
          },
          {
            "text": "\t\t\t\t\tthis.registerEvent(on(\"canvas-node-menu\", addNodeMenuItems));",
            "lineNumber": 109
          },
          {
            "text": "\t\t\t\t} catch (e) {",
            "lineNumber": 110
          },
          {
            "text": "\t\t\t\t\tconsole.error(\"Zettel Thinking Board: could not register canvas node menu.\", e);",
            "lineNumber": 111
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 112
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 113
          },
          {
            "text": "\t\t\tconst timeoutId = window.setTimeout(registerCanvasNodeMenu, 0);",
            "lineNumber": 114
          },
          {
            "text": "\t\t\tthis.register(() =&gt; window.clearTimeout(timeoutId));",
            "lineNumber": 115
          },
          {
            "lineNumber": 116
          },
          {
            "text": "\t\t\t// Debug: command to test if we can affect the canvas and if canvas:node-menu ever fires.",
            "lineNumber": 117
          },
          {
            "text": "\t}",
            "lineNumber": 196
          },
          {
            "text": "}",
            "lineNumber": 299,
            "isSignature": true
          }
        ]
      },
      "score": 0.3183453679084778
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 164
          },
          "endPosition": {
            "line": 228,
            "column": 1
          }
        },
        "contents": "async function runSingleNode(\n\tapp: App,\n\tsettings: ZettelPluginSettings,\n\tcanvasKey: string,\n\tcanvasFilePath: string,\n\tdata: CanvasData,\n\tnodeId: string,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;string&gt; {\n edgeModes, liveCanvas);\n\t\treturn result;\n\t}\n\tif (role === \"blue\") {\n\t\tconst kernel = getKernelForCanvas(canvasKey, settings.pythonPath);\n\t\tconst result = await kernel.run(template, concatenatedPart);\n\t\tsetNodeResult(canvasKey, nodeId, result);\n\t\tensureOutputNodeAndEdge(data, node, result, settings);\n\t\tawait updateEdgeLabelsAndSave(app.vault, canvasFilePath, data, nodeId, edgeModes, liveCanvas);\n\t\treturn result;\n\t}\n\treturn \"\";\n}\n\n/** Generate a unique id for new canvas nodes/edges. */\nfunction randomId(): string {\n\tif\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 164,
                "column": 1
              },
              "endPosition": {
                "line": 173,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "async function runSingleNode(",
            "lineNumber": 165,
            "isSignature": true
          },
          {
            "text": "\tapp: App,",
            "lineNumber": 166,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 167,
            "isSignature": true
          },
          {
            "text": "\tcanvasKey: string,",
            "lineNumber": 168,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 169,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 170,
            "isSignature": true
          },
          {
            "text": "\tnodeId: string,",
            "lineNumber": 171,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 172,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;string&gt; {",
            "lineNumber": 173,
            "isSignature": true
          },
          {
            "text": " edgeModes, liveCanvas);",
            "lineNumber": 209
          },
          {
            "text": "\t\treturn result;",
            "lineNumber": 210
          },
          {
            "text": "\t}",
            "lineNumber": 211
          },
          {
            "text": "\tif (role === \"blue\") {",
            "lineNumber": 212
          },
          {
            "text": "\t\tconst kernel = getKernelForCanvas(canvasKey, settings.pythonPath);",
            "lineNumber": 213
          },
          {
            "text": "\t\tconst result = await kernel.run(template, concatenatedPart);",
            "lineNumber": 214
          },
          {
            "text": "\t\tsetNodeResult(canvasKey, nodeId, result);",
            "lineNumber": 215
          },
          {
            "text": "\t\tensureOutputNodeAndEdge(data, node, result, settings);",
            "lineNumber": 216
          },
          {
            "text": "\t\tawait updateEdgeLabelsAndSave(app.vault, canvasFilePath, data, nodeId, edgeModes, liveCanvas);",
            "lineNumber": 217
          },
          {
            "text": "\t\treturn result;",
            "lineNumber": 218
          },
          {
            "text": "\t}",
            "lineNumber": 219
          },
          {
            "text": "\treturn \"\";",
            "lineNumber": 220
          },
          {
            "text": "}",
            "lineNumber": 221,
            "isSignature": true
          },
          {
            "lineNumber": 222
          },
          {
            "text": "/** Generate a unique id for new canvas nodes/edges. */",
            "lineNumber": 223
          },
          {
            "text": "function randomId(): string {",
            "lineNumber": 224,
            "isSignature": true
          },
          {
            "text": "\tif",
            "lineNumber": 225
          },
          {
            "text": "}",
            "lineNumber": 229,
            "isSignature": true
          }
        ]
      },
      "score": 0.293931245803833
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "column": 61
          },
          "endPosition": {
            "line": 24,
            "column": 108
          }
        },
        "contents": "import {DEFAULT_SETTINGS, ZettelPluginSettings, ZettelSettingTab} from \"./settings\";\nimport {ZettelControlsView, ZETTEL_CONTROLS_VIEW_TYPE} from \"./views/ZettelControlsView\";\nimport {dismissOutput as runnerDismissOutput, runChain as runnerRunChain, runNode as runnerRunNode} from \"./engine/runner\";\nimport {\n\tclearCanvasEdgeModeLabels,\n\tclearCanvasLegend,\n\tclearCanvasRoleLabels,\n\tsyncCanvasEdgeModeLabels,\n\tsyncCanvasRoleLabels,\n} from \"./canvas/canvasNodeLabels\";\nimport {getKernelForCanvas, terminateAllKernels, terminateKernel} from \"./engine/kernelManager\";\n\n/** Resolve canvas node id from context-menu payload (shape may vary by Obsidian version). */\nfunction resolveCanvasNodeId(node: unknown): string | undefined {\n\tif (!node || typeof node !== \"object\") return undefined;\n\tconst n = node as Record&lt;string, unknown&gt;;\n\tif (typeof n.id === \"string\") return n.id;\n\tconst inner = n.node as Record&lt;string, unknown&gt; | undefined;\n\tif (inner &amp;&amp; typeof inner.id === \"string\") return inner.id;\n\tconst data = typeof n.getData === \"function\" ? (n.getData as () =&gt; { id?: string })() : undefined;\n\treturn data?.id;\n}\n\n/** Debug: set to true when canvas:node-menu callback has fired at least once (proves event is received). */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "import {DEFAULT_SETTINGS, ZettelPluginSettings, ZettelSettingTab} from \"./settings\";",
            "lineNumber": 2
          },
          {
            "text": "import {ZettelControlsView, ZETTEL_CONTROLS_VIEW_TYPE} from \"./views/ZettelControlsView\";",
            "lineNumber": 3
          },
          {
            "text": "import {dismissOutput as runnerDismissOutput, runChain as runnerRunChain, runNode as runnerRunNode} from \"./engine/runner\";",
            "lineNumber": 4
          },
          {
            "text": "import {",
            "lineNumber": 5
          },
          {
            "text": "\tclearCanvasEdgeModeLabels,",
            "lineNumber": 6
          },
          {
            "text": "\tclearCanvasLegend,",
            "lineNumber": 7
          },
          {
            "text": "\tclearCanvasRoleLabels,",
            "lineNumber": 8
          },
          {
            "text": "\tsyncCanvasEdgeModeLabels,",
            "lineNumber": 9
          },
          {
            "text": "\tsyncCanvasRoleLabels,",
            "lineNumber": 10
          },
          {
            "text": "} from \"./canvas/canvasNodeLabels\";",
            "lineNumber": 11
          },
          {
            "text": "import {getKernelForCanvas, terminateAllKernels, terminateKernel} from \"./engine/kernelManager\";",
            "lineNumber": 12
          },
          {
            "lineNumber": 13
          },
          {
            "text": "/** Resolve canvas node id from context-menu payload (shape may vary by Obsidian version). */",
            "lineNumber": 14
          },
          {
            "text": "function resolveCanvasNodeId(node: unknown): string | undefined {",
            "lineNumber": 15,
            "isSignature": true
          },
          {
            "text": "\tif (!node || typeof node !== \"object\") return undefined;",
            "lineNumber": 16
          },
          {
            "text": "\tconst n = node as Record&lt;string, unknown&gt;;",
            "lineNumber": 17
          },
          {
            "text": "\tif (typeof n.id === \"string\") return n.id;",
            "lineNumber": 18
          },
          {
            "text": "\tconst inner = n.node as Record&lt;string, unknown&gt; | undefined;",
            "lineNumber": 19
          },
          {
            "text": "\tif (inner &amp;&amp; typeof inner.id === \"string\") return inner.id;",
            "lineNumber": 20
          },
          {
            "text": "\tconst data = typeof n.getData === \"function\" ? (n.getData as () =&gt; { id?: string })() : undefined;",
            "lineNumber": 21
          },
          {
            "text": "\treturn data?.id;",
            "lineNumber": 22
          },
          {
            "text": "}",
            "lineNumber": 23,
            "isSignature": true
          },
          {
            "lineNumber": 24
          },
          {
            "text": "/** Debug: set to true when canvas:node-menu callback has fired at least once (proves event is received). */",
            "lineNumber": 25
          }
        ]
      },
      "score": 0.2682618498802185
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 37,
            "column": 1
          }
        },
        "contents": "import type {App} from \"obsidian\";\nimport {\n\tEDGE_LABEL_OUTPUT,\n\tfindOutputNodeForSource,\n\tgetNodeById,\n\tgetNodeContent,\n\tgetNodeRole,\n\tgetIncomingEdgesWithLabels,\n\tgetParentIdsSortedByY,\n\tGREEN_NODE_PADDING,\n\tisOutputEdge,\n\tloadCanvasData,\n\tsaveCanvasData,\n} from \"../canvas/nodes\";\nimport type {AllCanvasNodeData, CanvasData, CanvasEdgeData, CanvasTextData} from \"../canvas/types\";\nimport { parseEdgeVariableName } from \"../canvas/types\";\nimport {isTextNode} from \"../canvas/types\";\nimport type {LiveCanvas} from \"./canvasApi\";\nimport {getKernelForCanvas} from \"./kernelManager\";\nimport {ollamaGenerate} from \"./ollama\";\nimport {\n\tgetCanvasKey,\n\tgetNodeResult,\n\tsetNodeResult,\n\tsetEdgeModes,\n\tsetRunningNodeId,\n} from \"./state\";\nimport type {ZettelPluginSettings} from \"../settings\";\n\ntype EdgeInputMode = \"inject\" | \"concatenate\";\n\n/** Get all root node ids (no incoming non-output edges). */\nfunction getRootIds(data: CanvasData): string[] {\n\tconst hasIncoming = new Set\n;\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "import type {App} from \"obsidian\";",
            "lineNumber": 1
          },
          {
            "text": "import {",
            "lineNumber": 2
          },
          {
            "text": "\tEDGE_LABEL_OUTPUT,",
            "lineNumber": 3
          },
          {
            "text": "\tfindOutputNodeForSource,",
            "lineNumber": 4
          },
          {
            "text": "\tgetNodeById,",
            "lineNumber": 5
          },
          {
            "text": "\tgetNodeContent,",
            "lineNumber": 6
          },
          {
            "text": "\tgetNodeRole,",
            "lineNumber": 7
          },
          {
            "text": "\tgetIncomingEdgesWithLabels,",
            "lineNumber": 8
          },
          {
            "text": "\tgetParentIdsSortedByY,",
            "lineNumber": 9
          },
          {
            "text": "\tGREEN_NODE_PADDING,",
            "lineNumber": 10
          },
          {
            "text": "\tisOutputEdge,",
            "lineNumber": 11
          },
          {
            "text": "\tloadCanvasData,",
            "lineNumber": 12
          },
          {
            "text": "\tsaveCanvasData,",
            "lineNumber": 13
          },
          {
            "text": "} from \"../canvas/nodes\";",
            "lineNumber": 14
          },
          {
            "text": "import type {AllCanvasNodeData, CanvasData, CanvasEdgeData, CanvasTextData} from \"../canvas/types\";",
            "lineNumber": 15
          },
          {
            "text": "import { parseEdgeVariableName } from \"../canvas/types\";",
            "lineNumber": 16
          },
          {
            "text": "import {isTextNode} from \"../canvas/types\";",
            "lineNumber": 17
          },
          {
            "text": "import type {LiveCanvas} from \"./canvasApi\";",
            "lineNumber": 18
          },
          {
            "text": "import {getKernelForCanvas} from \"./kernelManager\";",
            "lineNumber": 19
          },
          {
            "text": "import {ollamaGenerate} from \"./ollama\";",
            "lineNumber": 20
          },
          {
            "text": "import {",
            "lineNumber": 21
          },
          {
            "text": "\tgetCanvasKey,",
            "lineNumber": 22
          },
          {
            "text": "\tgetNodeResult,",
            "lineNumber": 23
          },
          {
            "text": "\tsetNodeResult,",
            "lineNumber": 24
          },
          {
            "text": "\tsetEdgeModes,",
            "lineNumber": 25
          },
          {
            "text": "\tsetRunningNodeId,",
            "lineNumber": 26
          },
          {
            "text": "} from \"./state\";",
            "lineNumber": 27
          },
          {
            "text": "import type {ZettelPluginSettings} from \"../settings\";",
            "lineNumber": 28
          },
          {
            "lineNumber": 29
          },
          {
            "text": "type EdgeInputMode = \"inject\" | \"concatenate\";",
            "lineNumber": 30,
            "isSignature": true
          },
          {
            "lineNumber": 31
          },
          {
            "text": "/** Get all root node ids (no incoming non-output edges). */",
            "lineNumber": 32
          },
          {
            "text": "function getRootIds(data: CanvasData): string[] {",
            "lineNumber": 33,
            "isSignature": true
          },
          {
            "text": "\tconst hasIncoming = new Set",
            "lineNumber": 34
          },
          {
            "text": ";",
            "lineNumber": 36
          },
          {
            "text": "}",
            "lineNumber": 38,
            "isSignature": true
          }
        ]
      },
      "score": 0.2579309344291687
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/settings.ts",
        "range": {
          "startPosition": {
            "line": 175
          },
          "endPosition": {
            "line": 312,
            "column": 1
          }
        },
        "contents": "export class ZettelSettingTab extends PluginSettingTab {\n\n\n\tdisplay(): void {\n\t\tconst {containerEl} = this;\n\t\tcontainerEl.empty();\n\t\tconst s = this.plugin.settings;\n\n\t\t// How to run: one-line hint (per UX suggestion)\n\t\tconst hint = containerEl.createDiv({ cls: \"ztb-settings-hint setting-item-description\" });\n\t\thint.setText(\"Right-click a node on the canvas and choose Run node or Run chain.\");\n\n\t\t// Execution: what runs (primary model, secondary model, Python path)\n\t\tconst executionSection = containerEl.createDiv({ cls: \"ztb-settings-section\" });\n\t\texecutionSection.createEl(\"h4\", { text: \"Execution\", cls: \"ztb-section-title\" });\n\t\tconst ollamaContainer = executionSection.createDiv({ cls: \"ztb-ollama-settings\" });\n\t\tconst loadingEl = ollamaContainer.createDiv({ cls: \"ztb-ollama-loading\" });\n\t\tloadingEl.setText(\"Loading Ollama models\");\n\t\t(async () =&gt; {\n\t\t\tconst models = await fetchOllamaModels();\n\t\t\tloadingEl.remove();\n\t\t\tif (models.length === 0) {\n\t\t\t\tconst fallback = ollamaContainer.createDiv({ cls: \"ztb-ollama-fallback\" });\n\t\t\t\tfallback.createEl(\"p\", { text: \"Ollama not reachable or no models. Enter model names manually.\" });\n\t\t\t\tnew Setting(ollamaContainer)\n\t\t\t\t\t.setName(\"Model node (primary)\")\n\t\t\t\t\t.setDesc(\"Ollama model used when you run a primary model node (e.g. llama2)\")\n\t\t\t\t\t.addText((text) =&gt; text\n\t\t\t\t\t\t.setPlaceholder(\"e.g. llama2\")\n\t\t\t\t\t\t.setValue(s.ollamaOrangeModel)\n\t\t\t\t\t\t.onChange(async (value) =&gt; {\n\t\t\t\t\t\t\tthis.plugin.settings.ollamaOrangeModel = value;\n\t\t\t\t\t\t\tawait this.plugin.saveSettings();\n\t\t\t\t\t\t}));\n\t\t\t\tnew Setting(ollamaContainer)\n\t\t\t\t\t.setName(\"Model node (secondary)\")\n\t\t\t\t\t.setDesc(\"Ollama model used when you run a secondary model node\")\n\t\t\t\t\t.addText((text) =&gt; text\n\t\t\t\t\t\t.setPlaceholder(\"e.g. mistral\")\n\t\t\t\t\t\t.setValue(s.ollamaPurpleModel)\n\t\t\t\t\t\t.onChange(async (value) =&gt; {\n\t\t\t\t\t\t\ts.ollamaPurpleModel = value;\n\t\t\t\t\t\t\tawait this.plugin.saveSettings();\n\t\t\t\t\t\t}));\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tnew Setting(ollamaContainer)\n\t\t\t\t.setName(\"Model node (primary)\")\n\t\t\t\t.setDesc\n\n\t\t}\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 176,
                "column": 1
              },
              "endPosition": {
                "line": 176,
                "column": 8
              }
            },
            {
              "startPosition": {
                "line": 176,
                "column": 8
              },
              "endPosition": {
                "line": 177,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export class ZettelSettingTab extends PluginSettingTab {",
            "lineNumber": 176,
            "isSignature": true
          },
          {
            "lineNumber": 182
          },
          {
            "lineNumber": 183
          },
          {
            "text": "\tdisplay(): void {",
            "lineNumber": 184
          },
          {
            "text": "\t\tconst {containerEl} = this;",
            "lineNumber": 185
          },
          {
            "text": "\t\tcontainerEl.empty();",
            "lineNumber": 186
          },
          {
            "text": "\t\tconst s = this.plugin.settings;",
            "lineNumber": 187
          },
          {
            "lineNumber": 188
          },
          {
            "text": "\t\t// How to run: one-line hint (per UX suggestion)",
            "lineNumber": 189
          },
          {
            "text": "\t\tconst hint = containerEl.createDiv({ cls: \"ztb-settings-hint setting-item-description\" });",
            "lineNumber": 190
          },
          {
            "text": "\t\thint.setText(\"Right-click a node on the canvas and choose Run node or Run chain.\");",
            "lineNumber": 191
          },
          {
            "lineNumber": 192
          },
          {
            "text": "\t\t// Execution: what runs (primary model, secondary model, Python path)",
            "lineNumber": 193
          },
          {
            "text": "\t\tconst executionSection = containerEl.createDiv({ cls: \"ztb-settings-section\" });",
            "lineNumber": 194
          },
          {
            "text": "\t\texecutionSection.createEl(\"h4\", { text: \"Execution\", cls: \"ztb-section-title\" });",
            "lineNumber": 195
          },
          {
            "text": "\t\tconst ollamaContainer = executionSection.createDiv({ cls: \"ztb-ollama-settings\" });",
            "lineNumber": 196
          },
          {
            "text": "\t\tconst loadingEl = ollamaContainer.createDiv({ cls: \"ztb-ollama-loading\" });",
            "lineNumber": 197
          },
          {
            "text": "\t\tloadingEl.setText(\"Loading Ollama models\");",
            "lineNumber": 198
          },
          {
            "text": "\t\t(async () =&gt; {",
            "lineNumber": 199
          },
          {
            "text": "\t\t\tconst models = await fetchOllamaModels();",
            "lineNumber": 200
          },
          {
            "text": "\t\t\tloadingEl.remove();",
            "lineNumber": 201
          },
          {
            "text": "\t\t\tif (models.length === 0) {",
            "lineNumber": 202
          },
          {
            "text": "\t\t\t\tconst fallback = ollamaContainer.createDiv({ cls: \"ztb-ollama-fallback\" });",
            "lineNumber": 203
          },
          {
            "text": "\t\t\t\tfallback.createEl(\"p\", { text: \"Ollama not reachable or no models. Enter model names manually.\" });",
            "lineNumber": 204
          },
          {
            "text": "\t\t\t\tnew Setting(ollamaContainer)",
            "lineNumber": 205
          },
          {
            "text": "\t\t\t\t\t.setName(\"Model node (primary)\")",
            "lineNumber": 206
          },
          {
            "text": "\t\t\t\t\t.setDesc(\"Ollama model used when you run a primary model node (e.g. llama2)\")",
            "lineNumber": 207
          },
          {
            "text": "\t\t\t\t\t.addText((text) =&gt; text",
            "lineNumber": 208
          },
          {
            "text": "\t\t\t\t\t\t.setPlaceholder(\"e.g. llama2\")",
            "lineNumber": 209
          },
          {
            "text": "\t\t\t\t\t\t.setValue(s.ollamaOrangeModel)",
            "lineNumber": 210
          },
          {
            "text": "\t\t\t\t\t\t.onChange(async (value) =&gt; {",
            "lineNumber": 211
          },
          {
            "text": "\t\t\t\t\t\t\tthis.plugin.settings.ollamaOrangeModel = value;",
            "lineNumber": 212
          },
          {
            "text": "\t\t\t\t\t\t\tawait this.plugin.saveSettings();",
            "lineNumber": 213
          },
          {
            "text": "\t\t\t\t\t\t}));",
            "lineNumber": 214
          },
          {
            "text": "\t\t\t\tnew Setting(ollamaContainer)",
            "lineNumber": 215
          },
          {
            "text": "\t\t\t\t\t.setName(\"Model node (secondary)\")",
            "lineNumber": 216
          },
          {
            "text": "\t\t\t\t\t.setDesc(\"Ollama model used when you run a secondary model node\")",
            "lineNumber": 217
          },
          {
            "text": "\t\t\t\t\t.addText((text) =&gt; text",
            "lineNumber": 218
          },
          {
            "text": "\t\t\t\t\t\t.setPlaceholder(\"e.g. mistral\")",
            "lineNumber": 219
          },
          {
            "text": "\t\t\t\t\t\t.setValue(s.ollamaPurpleModel)",
            "lineNumber": 220
          },
          {
            "text": "\t\t\t\t\t\t.onChange(async (value) =&gt; {",
            "lineNumber": 221
          },
          {
            "text": "\t\t\t\t\t\t\ts.ollamaPurpleModel = value;",
            "lineNumber": 222
          },
          {
            "text": "\t\t\t\t\t\t\tawait this.plugin.saveSettings();",
            "lineNumber": 223
          },
          {
            "text": "\t\t\t\t\t\t}));",
            "lineNumber": 224
          },
          {
            "text": "\t\t\t\treturn;",
            "lineNumber": 225
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 226
          },
          {
            "text": "\t\t\tnew Setting(ollamaContainer)",
            "lineNumber": 227
          },
          {
            "text": "\t\t\t\t.setName(\"Model node (primary)\")",
            "lineNumber": 228
          },
          {
            "text": "\t\t\t\t.setDesc",
            "lineNumber": 229
          },
          {
            "lineNumber": 238
          },
          {
            "text": "\t\t}",
            "lineNumber": 251
          },
          {
            "text": "\t}",
            "lineNumber": 312
          },
          {
            "text": "}",
            "lineNumber": 313,
            "isSignature": true
          }
        ]
      },
      "score": 0.25654980540275574
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 27,
            "column": 39
          },
          "endPosition": {
            "line": 53,
            "column": 1
          }
        },
        "contents": " \"../settings\";\n\ntype EdgeInputMode = \"inject\" | \"concatenate\";\n\n/** Get all root node ids (no incoming non-output edges). */\nfunction getRootIds(data: CanvasData): string[] {\n\tconst hasIncoming = new Set(\n\t\tdata.edges.filter((e) =&gt; !isOutputEdge(e)).map((e) =&gt; e.toNode)\n\t);\n\treturn data.nodes.filter((n) =&gt; !hasIncoming.has(n.id)).map((n) =&gt; n.id);\n}\n\n/** Check if there is a path from fromId to toId (ignoring output edges). */\nfunction canReach(data: CanvasData, fromId: string, toId: string): boolean {\n\tconst visited = new Set&lt;string&gt;();\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": " \"../settings\";",
            "lineNumber": 28
          },
          {
            "lineNumber": 29
          },
          {
            "text": "type EdgeInputMode = \"inject\" | \"concatenate\";",
            "lineNumber": 30,
            "isSignature": true
          },
          {
            "lineNumber": 31
          },
          {
            "text": "/** Get all root node ids (no incoming non-output edges). */",
            "lineNumber": 32
          },
          {
            "text": "function getRootIds(data: CanvasData): string[] {",
            "lineNumber": 33,
            "isSignature": true
          },
          {
            "text": "\tconst hasIncoming = new Set(",
            "lineNumber": 34
          },
          {
            "text": "\t\tdata.edges.filter((e) =&gt; !isOutputEdge(e)).map((e) =&gt; e.toNode)",
            "lineNumber": 35
          },
          {
            "text": "\t);",
            "lineNumber": 36
          },
          {
            "text": "\treturn data.nodes.filter((n) =&gt; !hasIncoming.has(n.id)).map((n) =&gt; n.id);",
            "lineNumber": 37
          },
          {
            "text": "}",
            "lineNumber": 38,
            "isSignature": true
          },
          {
            "lineNumber": 39
          },
          {
            "text": "/** Check if there is a path from fromId to toId (ignoring output edges). */",
            "lineNumber": 40
          },
          {
            "text": "function canReach(data: CanvasData, fromId: string, toId: string): boolean {",
            "lineNumber": 41,
            "isSignature": true
          },
          {
            "text": "\tconst visited = new Set&lt;string&gt;();",
            "lineNumber": 42
          },
          {
            "text": "}",
            "lineNumber": 54,
            "isSignature": true
          }
        ]
      },
      "score": 0.23468559980392456
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 27
          },
          "endPosition": {
            "line": 298,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\nasync onload() {\n\n\n\t\t\t// Debug: command to test if we can affect the canvas and if canvas:node-menu ever fires.\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"zettel-debug-canvas-hook\",\n\t\t\t\tname: \"Debug canvas hook\",\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tif (checking) return true;\n\t\t\t\t\tconst canvasActive = this.getActiveCanvasView() != null;\n\t\t\t\t\tconst msg =\n\t\t\t\t\t\t\"Canvas active: \" +\n\t\t\t\t\t\t(canvasActive ? \"yes\" : \"no (focus a canvas first)\") +\n\t\t\t\t\t\t\". Node menu ever fired: \" +\n\t\t\t\t\t\t(debugNodeMenuFired ? \"yes\" : \"no (right-click a node to test).\");\n\t\t\t\t\tnew Notice(msg);\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\t// Terminate kernel when a canvas is closed (one kernel per canvas)\n\t\t\tlet previousCanvasPaths = new Set&lt;string&gt;();\n\t\t\tthis.registerEvent(\n\t\t\t\tthis.app.workspace.on(\"layout-change\", () =&gt; {\n\t\t\t\t\tconst leaves = this.app.workspace.getLeavesOfType(\"canvas\");\n\t\t\t\t\tconst openPaths = new Set&lt;string&gt;();\n\t\t\t\t\tfor (const leaf of leaves) {\n\t\t\t\t\t\tconst v = leaf.view as { file?: { path: string } };\n\t\t\t\t\t\tif (v?.file?.path) openPaths.add(v.file.path);\n\t\t\t\t\t}\n\t\t\t\t\tfor (const path of previousCanvasPaths) {\n\t\t\t\t\t\tif (!openPaths.has(path)) terminateKernel(path);\n\t\t\t\t\t}\n\t\t\t\t\tpreviousCanvasPaths = openPaths;\n\t\t\t\t})\n\t\t\t);\n\n\t\t\t// Floating role labels on canvas: sync when active leaf is a canvas, clear when not\n\t\t\tlet roleLabelsContainerEl: HTMLElement | null = null;\n\t\t\tlet roleLabelsIntervalId: number | null = null;\n\t\t\tconst runSyncLabels = (): void =&gt; {\n\t\t\t\tconst view = this.getActiveCanvasView();\n;\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 28,
                "column": 1
              },
              "endPosition": {
                "line": 28,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 28,
                "column": 16
              },
              "endPosition": {
                "line": 29,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 31,
                "column": 2
              },
              "endPosition": {
                "line": 32,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 28,
            "isSignature": true
          },
          {
            "text": "async onload() {",
            "lineNumber": 31
          },
          {
            "lineNumber": 115
          },
          {
            "lineNumber": 116
          },
          {
            "text": "\t\t\t// Debug: command to test if we can affect the canvas and if canvas:node-menu ever fires.",
            "lineNumber": 117
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 118
          },
          {
            "text": "\t\t\t\tid: \"zettel-debug-canvas-hook\",",
            "lineNumber": 119
          },
          {
            "text": "\t\t\t\tname: \"Debug canvas hook\",",
            "lineNumber": 120
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 121
          },
          {
            "text": "\t\t\t\t\tif (checking) return true;",
            "lineNumber": 122
          },
          {
            "text": "\t\t\t\t\tconst canvasActive = this.getActiveCanvasView() != null;",
            "lineNumber": 123
          },
          {
            "text": "\t\t\t\t\tconst msg =",
            "lineNumber": 124
          },
          {
            "text": "\t\t\t\t\t\t\"Canvas active: \" +",
            "lineNumber": 125
          },
          {
            "text": "\t\t\t\t\t\t(canvasActive ? \"yes\" : \"no (focus a canvas first)\") +",
            "lineNumber": 126
          },
          {
            "text": "\t\t\t\t\t\t\". Node menu ever fired: \" +",
            "lineNumber": 127
          },
          {
            "text": "\t\t\t\t\t\t(debugNodeMenuFired ? \"yes\" : \"no (right-click a node to test).\");",
            "lineNumber": 128
          },
          {
            "text": "\t\t\t\t\tnew Notice(msg);",
            "lineNumber": 129
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 130
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 131
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 132
          },
          {
            "lineNumber": 133
          },
          {
            "text": "\t\t\t// Terminate kernel when a canvas is closed (one kernel per canvas)",
            "lineNumber": 134
          },
          {
            "text": "\t\t\tlet previousCanvasPaths = new Set&lt;string&gt;();",
            "lineNumber": 135
          },
          {
            "text": "\t\t\tthis.registerEvent(",
            "lineNumber": 136
          },
          {
            "text": "\t\t\t\tthis.app.workspace.on(\"layout-change\", () =&gt; {",
            "lineNumber": 137
          },
          {
            "text": "\t\t\t\t\tconst leaves = this.app.workspace.getLeavesOfType(\"canvas\");",
            "lineNumber": 138
          },
          {
            "text": "\t\t\t\t\tconst openPaths = new Set&lt;string&gt;();",
            "lineNumber": 139
          },
          {
            "text": "\t\t\t\t\tfor (const leaf of leaves) {",
            "lineNumber": 140
          },
          {
            "text": "\t\t\t\t\t\tconst v = leaf.view as { file?: { path: string } };",
            "lineNumber": 141
          },
          {
            "text": "\t\t\t\t\t\tif (v?.file?.path) openPaths.add(v.file.path);",
            "lineNumber": 142
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 143
          },
          {
            "text": "\t\t\t\t\tfor (const path of previousCanvasPaths) {",
            "lineNumber": 144
          },
          {
            "text": "\t\t\t\t\t\tif (!openPaths.has(path)) terminateKernel(path);",
            "lineNumber": 145
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 146
          },
          {
            "text": "\t\t\t\t\tpreviousCanvasPaths = openPaths;",
            "lineNumber": 147
          },
          {
            "text": "\t\t\t\t})",
            "lineNumber": 148
          },
          {
            "text": "\t\t\t);",
            "lineNumber": 149
          },
          {
            "lineNumber": 150
          },
          {
            "text": "\t\t\t// Floating role labels on canvas: sync when active leaf is a canvas, clear when not",
            "lineNumber": 151
          },
          {
            "text": "\t\t\tlet roleLabelsContainerEl: HTMLElement | null = null;",
            "lineNumber": 152
          },
          {
            "text": "\t\t\tlet roleLabelsIntervalId: number | null = null;",
            "lineNumber": 153
          },
          {
            "text": "\t\t\tconst runSyncLabels = (): void =&gt; {",
            "lineNumber": 154
          },
          {
            "text": "\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 155
          },
          {
            "text": ";",
            "lineNumber": 189
          },
          {
            "text": "\t}",
            "lineNumber": 196
          },
          {
            "text": "}",
            "lineNumber": 299,
            "isSignature": true
          }
        ]
      },
      "score": 0.22735393047332764
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 40
          },
          "endPosition": {
            "line": 95,
            "column": 93
          }
        },
        "contents": "function canReach(data: CanvasData, fromId: string, toId: string): boolean {\n\n\treturn false;\n}\n\n/** Topological order of node ids (only nodes that are ancestors of target; ignores output edges). */\nfunction topologicalOrderToTarget(data: CanvasData, targetId: string): string[] {\n\tconst execEdges = data.edges.filter((e) =&gt; !isOutputEdge(e));\n\tconst nodeIds = new Set&lt;string&gt;();\n\tconst stack = [targetId];\n\twhile (stack.length &gt; 0) {\n\t\tconst id = stack.pop()!;\n\t\tif (nodeIds.has(id)) continue;\n\t\tnodeIds.add(id);\n\t\tfor (const e of execEdges) {\n\t\t\tif (e.toNode === id) stack.push(e.fromNode);\n\t\t}\n\t}\n\tconst inDegree = new Map&lt;string, number&gt;();\n\tfor (const id of nodeIds) inDegree.set(id, 0);\n\tfor (const e of execEdges) {\n\t\tif (nodeIds.has(e.fromNode) &amp;&amp; nodeIds.has(e.toNode)) {\n\t\t\tinDegree.set(e.toNode, (inDegree.get(e.toNode) ?? 0) + 1);\n\t\t}\n\t}\n\tconst order: string[] = [];\n\tconst queue = [...nodeIds].filter((id) =&gt; inDegree.get(id) === 0).sort((a, b) =&gt; {\n\t\tconst na = getNodeById(data, a);\n\t\tconst nb = getNodeById(data, b);\n\t\treturn (na?.y ?? 0) - (nb?.y ?? 0);\n\t});\n\twhile (queue.length &gt; 0) {\n\t\tconst id = queue.shift()!;\n\t\torder.push(id);\n\t\tfor (const e of execEdges) {\n\t\t\tif (e.fromNode === id &amp;&amp; nodeIds.has(e.toNode)) {\n\t\t\t\tconst d = (inDegree.get(e.toNode) ?? 0) - 1;\n\t\t\t\tinDegree.set(e.toNode, d);\n\t\t\t\tif (d === 0) queue.push(e.toNode);\n\t\t\t}\n\t\t}\n\t}\n\treturn order;\n}\n\n/** Build concatenated context, template with {{var:name}} substituted, and per-edge mode. */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "function canReach(data: CanvasData, fromId: string, toId: string): boolean {",
            "lineNumber": 41,
            "isSignature": true
          },
          {
            "lineNumber": 52
          },
          {
            "text": "\treturn false;",
            "lineNumber": 53
          },
          {
            "text": "}",
            "lineNumber": 54,
            "isSignature": true
          },
          {
            "lineNumber": 55
          },
          {
            "text": "/** Topological order of node ids (only nodes that are ancestors of target; ignores output edges). */",
            "lineNumber": 56
          },
          {
            "text": "function topologicalOrderToTarget(data: CanvasData, targetId: string): string[] {",
            "lineNumber": 57,
            "isSignature": true
          },
          {
            "text": "\tconst execEdges = data.edges.filter((e) =&gt; !isOutputEdge(e));",
            "lineNumber": 58
          },
          {
            "text": "\tconst nodeIds = new Set&lt;string&gt;();",
            "lineNumber": 59
          },
          {
            "text": "\tconst stack = [targetId];",
            "lineNumber": 60
          },
          {
            "text": "\twhile (stack.length &gt; 0) {",
            "lineNumber": 61
          },
          {
            "text": "\t\tconst id = stack.pop()!;",
            "lineNumber": 62
          },
          {
            "text": "\t\tif (nodeIds.has(id)) continue;",
            "lineNumber": 63
          },
          {
            "text": "\t\tnodeIds.add(id);",
            "lineNumber": 64
          },
          {
            "text": "\t\tfor (const e of execEdges) {",
            "lineNumber": 65
          },
          {
            "text": "\t\t\tif (e.toNode === id) stack.push(e.fromNode);",
            "lineNumber": 66
          },
          {
            "text": "\t\t}",
            "lineNumber": 67
          },
          {
            "text": "\t}",
            "lineNumber": 68
          },
          {
            "text": "\tconst inDegree = new Map&lt;string, number&gt;();",
            "lineNumber": 69
          },
          {
            "text": "\tfor (const id of nodeIds) inDegree.set(id, 0);",
            "lineNumber": 70
          },
          {
            "text": "\tfor (const e of execEdges) {",
            "lineNumber": 71
          },
          {
            "text": "\t\tif (nodeIds.has(e.fromNode) &amp;&amp; nodeIds.has(e.toNode)) {",
            "lineNumber": 72
          },
          {
            "text": "\t\t\tinDegree.set(e.toNode, (inDegree.get(e.toNode) ?? 0) + 1);",
            "lineNumber": 73
          },
          {
            "text": "\t\t}",
            "lineNumber": 74
          },
          {
            "text": "\t}",
            "lineNumber": 75
          },
          {
            "text": "\tconst order: string[] = [];",
            "lineNumber": 76
          },
          {
            "text": "\tconst queue = [...nodeIds].filter((id) =&gt; inDegree.get(id) === 0).sort((a, b) =&gt; {",
            "lineNumber": 77
          },
          {
            "text": "\t\tconst na = getNodeById(data, a);",
            "lineNumber": 78
          },
          {
            "text": "\t\tconst nb = getNodeById(data, b);",
            "lineNumber": 79
          },
          {
            "text": "\t\treturn (na?.y ?? 0) - (nb?.y ?? 0);",
            "lineNumber": 80
          },
          {
            "text": "\t});",
            "lineNumber": 81
          },
          {
            "text": "\twhile (queue.length &gt; 0) {",
            "lineNumber": 82
          },
          {
            "text": "\t\tconst id = queue.shift()!;",
            "lineNumber": 83
          },
          {
            "text": "\t\torder.push(id);",
            "lineNumber": 84
          },
          {
            "text": "\t\tfor (const e of execEdges) {",
            "lineNumber": 85
          },
          {
            "text": "\t\t\tif (e.fromNode === id &amp;&amp; nodeIds.has(e.toNode)) {",
            "lineNumber": 86
          },
          {
            "text": "\t\t\t\tconst d = (inDegree.get(e.toNode) ?? 0) - 1;",
            "lineNumber": 87
          },
          {
            "text": "\t\t\t\tinDegree.set(e.toNode, d);",
            "lineNumber": 88
          },
          {
            "text": "\t\t\t\tif (d === 0) queue.push(e.toNode);",
            "lineNumber": 89
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 90
          },
          {
            "text": "\t\t}",
            "lineNumber": 91
          },
          {
            "text": "\t}",
            "lineNumber": 92
          },
          {
            "text": "\treturn order;",
            "lineNumber": 93
          },
          {
            "text": "}",
            "lineNumber": 94,
            "isSignature": true
          },
          {
            "lineNumber": 95
          },
          {
            "text": "/** Build concatenated context, template with {{var:name}} substituted, and per-edge mode. */",
            "lineNumber": 96
          }
        ]
      },
      "score": 0.21175989508628845
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 27
          },
          "endPosition": {
            "line": 298,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\nasync onload() {\n\n\t\t\tconst runSyncLabels = (): void =&gt; {\n\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\tif (!view) {\n\t\t\t\t\tif (roleLabelsIntervalId != null) {\n\t\t\t\t\t\tclearInterval(roleLabelsIntervalId);\n\t\t\t\t\t\troleLabelsIntervalId = null;\n\t\t\t\t\t\tdelete (this as unknown as Record&lt;string, unknown&gt;)._roleLabelsIntervalId;\n\t\t\t\t\t}\n\t\t\t\t\tif (roleLabelsContainerEl != null) {\n\t\t\t\t\t\tclearCanvasRoleLabels(roleLabelsContainerEl);\n\t\t\t\t\t\tclearCanvasLegend(roleLabelsContainerEl);\n\t\t\t\t\t\tclearCanvasEdgeModeLabels(roleLabelsContainerEl);\n\t\t\t\t\t\troleLabelsContainerEl = null;\n\t\t\t\t\t}\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tif (roleLabelsContainerEl != null &amp;&amp; roleLabelsContainerEl !== view.containerEl) {\n\t\t\t\t\tclearCanvasRoleLabels(roleLabelsContainerEl);\n\t\t\t\t\tclearCanvasLegend(roleLabelsContainerEl);\n\t\t\t\t\tclearCanvasEdgeModeLabels(roleLabelsContainerEl);\n\t\t\t\t}\n\t\t\t\troleLabelsContainerEl = view.containerEl;\n\t\t\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;\n\t\t\t\tsyncCanvasRoleLabels(this.app.vault, view.file.path, view.containerEl, this.settings, liveCanvas);\n\t\t\t\tsyncCanvasEdgeModeLabels(this.app.vault, view.file.path, view.containerEl, liveCanvas);\n\t\t\t\tif (roleLabelsIntervalId == null) {\n\t\t\t\t\troleLabelsIntervalId = window.setInterval(() =&gt; {\n\t\t\t\t\t\tconst v = this.getActiveCanvasView();\n\t\t\t\t\t\tif (v != null &amp;&amp; v.containerEl === roleLabelsContainerEl) {\n\t\t\t\t\t\t\tsyncCanvasRoleLabels(this.app.vault, v.file.path, v.containerEl, this.settings, v.canvas as import(\"./engine/canvasApi\").LiveCanvas);\n\t\t\t\t\t\t\tsyncCanvasEdgeModeLabels(this.app.vault, v.file.path, v.containerEl, v.canvas as import(\"./engine/canvasApi\").LiveCanvas);\n\t\t\t\t\t\t}\n\t\t\t\t\t}, 2000);\n\t\t\t\t\t(this as unknown as { _roleLabelsIntervalId: number })._roleLabelsIntervalId = roleLabelsIntervalId;\n\t\t\t\t}\n\t\t\t};\n\t\t\tthis.registerEvent(this.app.workspace.on(\"active-leaf-change\", runSyncLabels));\n\t\t\trunSyncLabels();\n\t\t} catch (e) {\n\t\t\tconsole.error(\"Zettel Thinking Board onload error:\", e);\n\t\t\tthrow e;\n\t\t}\n\t}\n\n\tonunload() {\n\t\tterminateAllKernels();\n\t\tconst id = (;\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 28,
                "column": 1
              },
              "endPosition": {
                "line": 28,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 28,
                "column": 16
              },
              "endPosition": {
                "line": 29,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 31,
                "column": 2
              },
              "endPosition": {
                "line": 32,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 28,
            "isSignature": true
          },
          {
            "text": "async onload() {",
            "lineNumber": 31
          },
          {
            "lineNumber": 153
          },
          {
            "text": "\t\t\tconst runSyncLabels = (): void =&gt; {",
            "lineNumber": 154
          },
          {
            "text": "\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 155
          },
          {
            "text": "\t\t\t\tif (!view) {",
            "lineNumber": 156
          },
          {
            "text": "\t\t\t\t\tif (roleLabelsIntervalId != null) {",
            "lineNumber": 157
          },
          {
            "text": "\t\t\t\t\t\tclearInterval(roleLabelsIntervalId);",
            "lineNumber": 158
          },
          {
            "text": "\t\t\t\t\t\troleLabelsIntervalId = null;",
            "lineNumber": 159
          },
          {
            "text": "\t\t\t\t\t\tdelete (this as unknown as Record&lt;string, unknown&gt;)._roleLabelsIntervalId;",
            "lineNumber": 160
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 161
          },
          {
            "text": "\t\t\t\t\tif (roleLabelsContainerEl != null) {",
            "lineNumber": 162
          },
          {
            "text": "\t\t\t\t\t\tclearCanvasRoleLabels(roleLabelsContainerEl);",
            "lineNumber": 163
          },
          {
            "text": "\t\t\t\t\t\tclearCanvasLegend(roleLabelsContainerEl);",
            "lineNumber": 164
          },
          {
            "text": "\t\t\t\t\t\tclearCanvasEdgeModeLabels(roleLabelsContainerEl);",
            "lineNumber": 165
          },
          {
            "text": "\t\t\t\t\t\troleLabelsContainerEl = null;",
            "lineNumber": 166
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 167
          },
          {
            "text": "\t\t\t\t\treturn;",
            "lineNumber": 168
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 169
          },
          {
            "text": "\t\t\t\tif (roleLabelsContainerEl != null &amp;&amp; roleLabelsContainerEl !== view.containerEl) {",
            "lineNumber": 170
          },
          {
            "text": "\t\t\t\t\tclearCanvasRoleLabels(roleLabelsContainerEl);",
            "lineNumber": 171
          },
          {
            "text": "\t\t\t\t\tclearCanvasLegend(roleLabelsContainerEl);",
            "lineNumber": 172
          },
          {
            "text": "\t\t\t\t\tclearCanvasEdgeModeLabels(roleLabelsContainerEl);",
            "lineNumber": 173
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 174
          },
          {
            "text": "\t\t\t\troleLabelsContainerEl = view.containerEl;",
            "lineNumber": 175
          },
          {
            "text": "\t\t\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;",
            "lineNumber": 176
          },
          {
            "text": "\t\t\t\tsyncCanvasRoleLabels(this.app.vault, view.file.path, view.containerEl, this.settings, liveCanvas);",
            "lineNumber": 177
          },
          {
            "text": "\t\t\t\tsyncCanvasEdgeModeLabels(this.app.vault, view.file.path, view.containerEl, liveCanvas);",
            "lineNumber": 178
          },
          {
            "text": "\t\t\t\tif (roleLabelsIntervalId == null) {",
            "lineNumber": 179
          },
          {
            "text": "\t\t\t\t\troleLabelsIntervalId = window.setInterval(() =&gt; {",
            "lineNumber": 180
          },
          {
            "text": "\t\t\t\t\t\tconst v = this.getActiveCanvasView();",
            "lineNumber": 181
          },
          {
            "text": "\t\t\t\t\t\tif (v != null &amp;&amp; v.containerEl === roleLabelsContainerEl) {",
            "lineNumber": 182
          },
          {
            "text": "\t\t\t\t\t\t\tsyncCanvasRoleLabels(this.app.vault, v.file.path, v.containerEl, this.settings, v.canvas as import(\"./engine/canvasApi\").LiveCanvas);",
            "lineNumber": 183
          },
          {
            "text": "\t\t\t\t\t\t\tsyncCanvasEdgeModeLabels(this.app.vault, v.file.path, v.containerEl, v.canvas as import(\"./engine/canvasApi\").LiveCanvas);",
            "lineNumber": 184
          },
          {
            "text": "\t\t\t\t\t\t}",
            "lineNumber": 185
          },
          {
            "text": "\t\t\t\t\t}, 2000);",
            "lineNumber": 186
          },
          {
            "text": "\t\t\t\t\t(this as unknown as { _roleLabelsIntervalId: number })._roleLabelsIntervalId = roleLabelsIntervalId;",
            "lineNumber": 187
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 188
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 189
          },
          {
            "text": "\t\t\tthis.registerEvent(this.app.workspace.on(\"active-leaf-change\", runSyncLabels));",
            "lineNumber": 190
          },
          {
            "text": "\t\t\trunSyncLabels();",
            "lineNumber": 191
          },
          {
            "text": "\t\t} catch (e) {",
            "lineNumber": 192
          },
          {
            "text": "\t\t\tconsole.error(\"Zettel Thinking Board onload error:\", e);",
            "lineNumber": 193
          },
          {
            "text": "\t\t\tthrow e;",
            "lineNumber": 194
          },
          {
            "text": "\t\t}",
            "lineNumber": 195
          },
          {
            "text": "\t}",
            "lineNumber": 196
          },
          {
            "lineNumber": 197
          },
          {
            "text": "\tonunload() {",
            "lineNumber": 198
          },
          {
            "text": "\t\tterminateAllKernels();",
            "lineNumber": 199
          },
          {
            "text": "\t\tconst id = (;",
            "lineNumber": 200
          },
          {
            "text": "\t}",
            "lineNumber": 202
          },
          {
            "text": "}",
            "lineNumber": 299,
            "isSignature": true
          }
        ]
      },
      "score": 0.20781870186328888
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 56
          },
          "endPosition": {
            "line": 133,
            "column": 107
          }
        },
        "contents": "function topologicalOrderToTarget(data: CanvasData, targetId: string): string[] {\n\n\treturn order;\n}\n\n/** Build concatenated context, template with {{var:name}} substituted, and per-edge mode. */\nfunction buildInputWithVariables(\n\tcanvasKey: string,\n\tnodeInput: string,\n\tincoming: { parentId: string; edge: CanvasEdgeData; variableName: string }[]\n): { concatenatedPart: string; template: string; edgeModes: Map&lt;string, EdgeInputMode&gt; } {\n\tconst edgeModes = new Map&lt;string, EdgeInputMode&gt;();\n\tconst parentResults = new Map&lt;string, string&gt;();\n\tfor (const { parentId } of incoming) {\n\t\tconst r = getNodeResult(canvasKey, parentId);\n\t\tif (r != null) parentResults.set(parentId, r);\n\t}\n\tlet concatenatedPart = \"\";\n\tconst varValues: Record&lt;string, string&gt; = {};\n\tfor (const { parentId, edge, variableName } of incoming) {\n\t\tconst result = parentResults.get(parentId);\n\t\tif (result == null) continue;\n\t\tconst usedAsVar =\n\t\t\tvariableName.length &gt; 0 &amp;&amp; nodeInput.includes(&#96;{{var:${variableName}}}&#96;);\n\t\tif (usedAsVar) {\n\t\t\tedgeModes.set(edge.id, \"inject\");\n\t\t\tvarValues[variableName] = result;\n\t\t} else {\n\t\t\tedgeModes.set(edge.id, \"concatenate\");\n\t\t\tconcatenatedPart += result + \"\\n\\n\";\n\t\t}\n\t}\n\tlet template = nodeInput;\n\tfor (const [name, value] of Object.entries(varValues)) {\n\t\ttemplate = template.split(&#96;{{var:${name}}}&#96;).join(value);\n\t}\n\treturn {\n\t\tconcatenatedPart: concatenatedPart.trim(),\n\t\ttemplate,\n\t\tedgeModes,\n\t};\n}\n\n/** Persist only base variable name in edge.label; store inject/concatenate in state for floating label. */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "function topologicalOrderToTarget(data: CanvasData, targetId: string): string[] {",
            "lineNumber": 57,
            "isSignature": true
          },
          {
            "lineNumber": 92
          },
          {
            "text": "\treturn order;",
            "lineNumber": 93
          },
          {
            "text": "}",
            "lineNumber": 94,
            "isSignature": true
          },
          {
            "lineNumber": 95
          },
          {
            "text": "/** Build concatenated context, template with {{var:name}} substituted, and per-edge mode. */",
            "lineNumber": 96
          },
          {
            "text": "function buildInputWithVariables(",
            "lineNumber": 97,
            "isSignature": true
          },
          {
            "text": "\tcanvasKey: string,",
            "lineNumber": 98,
            "isSignature": true
          },
          {
            "text": "\tnodeInput: string,",
            "lineNumber": 99,
            "isSignature": true
          },
          {
            "text": "\tincoming: { parentId: string; edge: CanvasEdgeData; variableName: string }[]",
            "lineNumber": 100,
            "isSignature": true
          },
          {
            "text": "): { concatenatedPart: string; template: string; edgeModes: Map&lt;string, EdgeInputMode&gt; } {",
            "lineNumber": 101,
            "isSignature": true
          },
          {
            "text": "\tconst edgeModes = new Map&lt;string, EdgeInputMode&gt;();",
            "lineNumber": 102
          },
          {
            "text": "\tconst parentResults = new Map&lt;string, string&gt;();",
            "lineNumber": 103
          },
          {
            "text": "\tfor (const { parentId } of incoming) {",
            "lineNumber": 104
          },
          {
            "text": "\t\tconst r = getNodeResult(canvasKey, parentId);",
            "lineNumber": 105
          },
          {
            "text": "\t\tif (r != null) parentResults.set(parentId, r);",
            "lineNumber": 106
          },
          {
            "text": "\t}",
            "lineNumber": 107
          },
          {
            "text": "\tlet concatenatedPart = \"\";",
            "lineNumber": 108
          },
          {
            "text": "\tconst varValues: Record&lt;string, string&gt; = {};",
            "lineNumber": 109
          },
          {
            "text": "\tfor (const { parentId, edge, variableName } of incoming) {",
            "lineNumber": 110
          },
          {
            "text": "\t\tconst result = parentResults.get(parentId);",
            "lineNumber": 111
          },
          {
            "text": "\t\tif (result == null) continue;",
            "lineNumber": 112
          },
          {
            "text": "\t\tconst usedAsVar =",
            "lineNumber": 113
          },
          {
            "text": "\t\t\tvariableName.length &gt; 0 &amp;&amp; nodeInput.includes(&#96;{{var:${variableName}}}&#96;);",
            "lineNumber": 114
          },
          {
            "text": "\t\tif (usedAsVar) {",
            "lineNumber": 115
          },
          {
            "text": "\t\t\tedgeModes.set(edge.id, \"inject\");",
            "lineNumber": 116
          },
          {
            "text": "\t\t\tvarValues[variableName] = result;",
            "lineNumber": 117
          },
          {
            "text": "\t\t} else {",
            "lineNumber": 118
          },
          {
            "text": "\t\t\tedgeModes.set(edge.id, \"concatenate\");",
            "lineNumber": 119
          },
          {
            "text": "\t\t\tconcatenatedPart += result + \"\\n\\n\";",
            "lineNumber": 120
          },
          {
            "text": "\t\t}",
            "lineNumber": 121
          },
          {
            "text": "\t}",
            "lineNumber": 122
          },
          {
            "text": "\tlet template = nodeInput;",
            "lineNumber": 123
          },
          {
            "text": "\tfor (const [name, value] of Object.entries(varValues)) {",
            "lineNumber": 124
          },
          {
            "text": "\t\ttemplate = template.split(&#96;{{var:${name}}}&#96;).join(value);",
            "lineNumber": 125
          },
          {
            "text": "\t}",
            "lineNumber": 126
          },
          {
            "text": "\treturn {",
            "lineNumber": 127
          },
          {
            "text": "\t\tconcatenatedPart: concatenatedPart.trim(),",
            "lineNumber": 128
          },
          {
            "text": "\t\ttemplate,",
            "lineNumber": 129
          },
          {
            "text": "\t\tedgeModes,",
            "lineNumber": 130
          },
          {
            "text": "\t};",
            "lineNumber": 131
          },
          {
            "text": "}",
            "lineNumber": 132,
            "isSignature": true
          },
          {
            "lineNumber": 133
          },
          {
            "text": "/** Persist only base variable name in edge.label; store inject/concatenate in state for floating label. */",
            "lineNumber": 134
          }
        ]
      },
      "score": 0.19835776090621948
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/canvasApi.ts",
        "range": {
          "startPosition": {
            "column": 86
          },
          "endPosition": {
            "line": 15,
            "column": 1
          }
        },
        "contents": "export interface LiveCanvas {\n\tcreateTextNode(options: {\n\t\ttext: string;\n\t\tpos: { x: number; y: number };\n\t\tsize: { width: number; height: number };\n\t\tsave?: boolean;\n\t\tfocus?: boolean;\n\t}): { id: string; x: number; y: number; width: number; height: number; moveTo: (pos: { x: number; y: number }) =&gt; void; resize: (size: { width: number; height: number }) =&gt; void };\n\taddNode(node: unknown): void;\n\trequestSave?: () =&gt; void;\n\tremoveNode?(node: unknown): void;\n\tnodes?: Map&lt;string, unknown&gt; | Iterable&lt;unknown&gt;;\n\t/** If present, used to refresh canvas after edge label updates (Obsidian canvas view). */\n\tsetData?(data: unknown): void;\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "export interface LiveCanvas {",
            "lineNumber": 2,
            "isSignature": true
          },
          {
            "text": "\tcreateTextNode(options: {",
            "lineNumber": 3
          },
          {
            "text": "\t\ttext: string;",
            "lineNumber": 4
          },
          {
            "text": "\t\tpos: { x: number; y: number };",
            "lineNumber": 5
          },
          {
            "text": "\t\tsize: { width: number; height: number };",
            "lineNumber": 6
          },
          {
            "text": "\t\tsave?: boolean;",
            "lineNumber": 7
          },
          {
            "text": "\t\tfocus?: boolean;",
            "lineNumber": 8
          },
          {
            "text": "\t}): { id: string; x: number; y: number; width: number; height: number; moveTo: (pos: { x: number; y: number }) =&gt; void; resize: (size: { width: number; height: number }) =&gt; void };",
            "lineNumber": 9
          },
          {
            "text": "\taddNode(node: unknown): void;",
            "lineNumber": 10
          },
          {
            "text": "\trequestSave?: () =&gt; void;",
            "lineNumber": 11
          },
          {
            "text": "\tremoveNode?(node: unknown): void;",
            "lineNumber": 12
          },
          {
            "text": "\tnodes?: Map&lt;string, unknown&gt; | Iterable&lt;unknown&gt;;",
            "lineNumber": 13
          },
          {
            "text": "\t/** If present, used to refresh canvas after edge label updates (Obsidian canvas view). */",
            "lineNumber": 14
          },
          {
            "text": "\tsetData?(data: unknown): void;",
            "lineNumber": 15,
            "isSignature": true
          },
          {
            "text": "}",
            "lineNumber": 16,
            "isSignature": true
          }
        ]
      },
      "score": 0.18787869811058044
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 317
          },
          "endPosition": {
            "line": 365,
            "column": 1
          }
        },
        "contents": "export async function runChain(\n\tapp: App,\n\tsettings: ZettelPluginSettings,\n\tcanvasFilePath: string,\n\tnodeId: string,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;{ ok: boolean; message?: string }&gt; {\n;\n\t\t\t} finally {\n\t\t\t\tsetRunningNodeId(canvasKey, null);\n\t\t\t}\n\t\t}\n\t\treturn { ok: true };\n\t} catch (e) {\n\t\treturn { ok: false, message: e instanceof Error ? e.message : String(e) };\n\t}\n}\n\n/** Remove the Green output node and its output edge for a given source node; mutates data and saves. */\nexport async function dismissOutput(\n\tvault: App[\"vault\"],\n\tcanvasFilePath: string,\n\tsourceNodeId: string,\n\tsettings: ZettelPluginSettings,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;void&gt; {\n\tconst data = await loadCanvasData(vault, canvasFilePath);\n\tif (!data) return;\n\tconst outId = findOutputNodeForSource(data, sourceNodeId, settings);\n\tif (!outId) return;\n\tdata.nodes = data.nodes.filter((n) =&gt; n.id !== outId);\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "export async function runChain(",
            "lineNumber": 318,
            "isSignature": true
          },
          {
            "text": "\tapp: App,",
            "lineNumber": 319,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 320,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 321,
            "isSignature": true
          },
          {
            "text": "\tnodeId: string,",
            "lineNumber": 322,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 323,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;{ ok: boolean; message?: string }&gt; {",
            "lineNumber": 324,
            "isSignature": true
          },
          {
            "text": ";",
            "lineNumber": 336
          },
          {
            "text": "\t\t\t} finally {",
            "lineNumber": 337
          },
          {
            "text": "\t\t\t\tsetRunningNodeId(canvasKey, null);",
            "lineNumber": 338
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 339
          },
          {
            "text": "\t\t}",
            "lineNumber": 340
          },
          {
            "text": "\t\treturn { ok: true };",
            "lineNumber": 341
          },
          {
            "text": "\t} catch (e) {",
            "lineNumber": 342
          },
          {
            "text": "\t\treturn { ok: false, message: e instanceof Error ? e.message : String(e) };",
            "lineNumber": 343
          },
          {
            "text": "\t}",
            "lineNumber": 344
          },
          {
            "text": "}",
            "lineNumber": 345,
            "isSignature": true
          },
          {
            "lineNumber": 346
          },
          {
            "text": "/** Remove the Green output node and its output edge for a given source node; mutates data and saves. */",
            "lineNumber": 347
          },
          {
            "text": "export async function dismissOutput(",
            "lineNumber": 348,
            "isSignature": true
          },
          {
            "text": "\tvault: App[\"vault\"],",
            "lineNumber": 349,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 350,
            "isSignature": true
          },
          {
            "text": "\tsourceNodeId: string,",
            "lineNumber": 351,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 352,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 353,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;void&gt; {",
            "lineNumber": 354,
            "isSignature": true
          },
          {
            "text": "\tconst data = await loadCanvasData(vault, canvasFilePath);",
            "lineNumber": 355
          },
          {
            "text": "\tif (!data) return;",
            "lineNumber": 356
          },
          {
            "text": "\tconst outId = findOutputNodeForSource(data, sourceNodeId, settings);",
            "lineNumber": 357
          },
          {
            "text": "\tif (!outId) return;",
            "lineNumber": 358
          },
          {
            "text": "\tdata.nodes = data.nodes.filter((n) =&gt; n.id !== outId);",
            "lineNumber": 359
          },
          {
            "text": "}",
            "lineNumber": 366,
            "isSignature": true
          }
        ]
      },
      "score": 0.18586963415145874
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/nodes.ts",
        "range": {
          "startPosition": {
            "line": 34,
            "column": 1
          },
          "endPosition": {
            "line": 71,
            "column": 1
          }
        },
        "contents": "/** Get input content for a node: text node content or full file content. */\nexport async function getNodeContent(\n\tnode: AllCanvasNodeData,\n\tvault: Vault\n): Promise&lt;string&gt; {\n\tif (isTextNode(node)) return getTextNodeContent(node as CanvasTextData);\n\tif (isFileNode(node)) {\n\t\tconst path = getFileNodePath(node as CanvasFileData);\n\t\tif (!path) return \"\";\n\t\tconst file = vault.getFileByPath(path);\n\t\tif (file) {\n\t\t\ttry {\n\t\t\t\treturn await vault.cachedRead(file);\n\t\t\t} catch {\n\t\t\t\t//\n\t\t\t}\n\t\t}\n\t\treturn \"\";\n\t}\n\treturn \"\";\n}\n\n// Re-export for callers\nexport {\n\tEDGE_LABEL_OUTPUT,\n\tfindOutputNodeForSource\n;",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Get input content for a node: text node content or full file content. */",
            "lineNumber": 37
          },
          {
            "text": "export async function getNodeContent(",
            "lineNumber": 38,
            "isSignature": true
          },
          {
            "text": "\tnode: AllCanvasNodeData,",
            "lineNumber": 39,
            "isSignature": true
          },
          {
            "text": "\tvault: Vault",
            "lineNumber": 40,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;string&gt; {",
            "lineNumber": 41,
            "isSignature": true
          },
          {
            "text": "\tif (isTextNode(node)) return getTextNodeContent(node as CanvasTextData);",
            "lineNumber": 42
          },
          {
            "text": "\tif (isFileNode(node)) {",
            "lineNumber": 43
          },
          {
            "text": "\t\tconst path = getFileNodePath(node as CanvasFileData);",
            "lineNumber": 44
          },
          {
            "text": "\t\tif (!path) return \"\";",
            "lineNumber": 45
          },
          {
            "text": "\t\tconst file = vault.getFileByPath(path);",
            "lineNumber": 46
          },
          {
            "text": "\t\tif (file) {",
            "lineNumber": 47
          },
          {
            "text": "\t\t\ttry {",
            "lineNumber": 48
          },
          {
            "text": "\t\t\t\treturn await vault.cachedRead(file);",
            "lineNumber": 49
          },
          {
            "text": "\t\t\t} catch {",
            "lineNumber": 50
          },
          {
            "text": "\t\t\t\t//",
            "lineNumber": 51
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 52
          },
          {
            "text": "\t\t}",
            "lineNumber": 53
          },
          {
            "text": "\t\treturn \"\";",
            "lineNumber": 54
          },
          {
            "text": "\t}",
            "lineNumber": 55
          },
          {
            "text": "\treturn \"\";",
            "lineNumber": 56
          },
          {
            "text": "}",
            "lineNumber": 57,
            "isSignature": true
          },
          {
            "lineNumber": 58
          },
          {
            "text": "// Re-export for callers",
            "lineNumber": 59
          },
          {
            "text": "export {",
            "lineNumber": 60
          },
          {
            "text": "\tEDGE_LABEL_OUTPUT,",
            "lineNumber": 61
          },
          {
            "text": "\tfindOutputNodeForSource",
            "lineNumber": 62
          },
          {
            "text": ";",
            "lineNumber": 72
          }
        ]
      },
      "score": 0.18253789842128754
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/nodes.ts",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 34,
            "column": 1
          }
        },
        "contents": "import type {Vault} from \"obsidian\";\nimport type {AllCanvasNodeData, CanvasData, CanvasFileData, CanvasTextData} from \"obsidian/canvas\";\nimport {\n\tgetFileNodePath,\n\tgetNodeById,\n\tgetNodeRole,\n\tgetParentIdsSortedByY,\n\tgetTextNodeContent,\n\tisFileNode,\n\tisTextNode,\n} from \"./types\";\nimport type {ZettelPluginSettings} from \"../settings\";\n\n/** Load canvas data from vault by reading the canvas file (JSON). */\nexport async function loadCanvasData(vault: Vault, filePath: string): Promise&lt;CanvasData | null&gt; {\n\ttry {\n\t\tconst raw = await vault.adapter.read(filePath);\n\t\tconst data = JSON.parse(raw) as CanvasData;\n\t\tif (data &amp;&amp; Array.isArray(data.nodes) &amp;&amp; Array.isArray(data.edges)) return data;\n\t} catch {\n\t\t// ignore\n\t}\n\treturn null;\n}\n\n/** Save canvas data to vault (writes the canvas file). */\nexport async function saveCanvasData(vault: Vault, filePath: string, data: CanvasData): Promise&lt;boolean&gt; {\n\t\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "import type {Vault} from \"obsidian\";",
            "lineNumber": 1
          },
          {
            "text": "import type {AllCanvasNodeData, CanvasData, CanvasFileData, CanvasTextData} from \"obsidian/canvas\";",
            "lineNumber": 2
          },
          {
            "text": "import {",
            "lineNumber": 3
          },
          {
            "text": "\tgetFileNodePath,",
            "lineNumber": 4
          },
          {
            "text": "\tgetNodeById,",
            "lineNumber": 5
          },
          {
            "text": "\tgetNodeRole,",
            "lineNumber": 6
          },
          {
            "text": "\tgetParentIdsSortedByY,",
            "lineNumber": 7
          },
          {
            "text": "\tgetTextNodeContent,",
            "lineNumber": 8
          },
          {
            "text": "\tisFileNode,",
            "lineNumber": 9
          },
          {
            "text": "\tisTextNode,",
            "lineNumber": 10
          },
          {
            "text": "} from \"./types\";",
            "lineNumber": 11
          },
          {
            "text": "import type {ZettelPluginSettings} from \"../settings\";",
            "lineNumber": 12
          },
          {
            "lineNumber": 13
          },
          {
            "text": "/** Load canvas data from vault by reading the canvas file (JSON). */",
            "lineNumber": 14
          },
          {
            "text": "export async function loadCanvasData(vault: Vault, filePath: string): Promise&lt;CanvasData | null&gt; {",
            "lineNumber": 15,
            "isSignature": true
          },
          {
            "text": "\ttry {",
            "lineNumber": 16
          },
          {
            "text": "\t\tconst raw = await vault.adapter.read(filePath);",
            "lineNumber": 17
          },
          {
            "text": "\t\tconst data = JSON.parse(raw) as CanvasData;",
            "lineNumber": 18
          },
          {
            "text": "\t\tif (data &amp;&amp; Array.isArray(data.nodes) &amp;&amp; Array.isArray(data.edges)) return data;",
            "lineNumber": 19
          },
          {
            "text": "\t} catch {",
            "lineNumber": 20
          },
          {
            "text": "\t\t// ignore",
            "lineNumber": 21
          },
          {
            "text": "\t}",
            "lineNumber": 22
          },
          {
            "text": "\treturn null;",
            "lineNumber": 23
          },
          {
            "text": "}",
            "lineNumber": 24,
            "isSignature": true
          },
          {
            "lineNumber": 25
          },
          {
            "text": "/** Save canvas data to vault (writes the canvas file). */",
            "lineNumber": 26
          },
          {
            "text": "export async function saveCanvasData(vault: Vault, filePath: string, data: CanvasData): Promise&lt;boolean&gt; {",
            "lineNumber": 27,
            "isSignature": true
          },
          {
            "text": "\t",
            "lineNumber": 28
          },
          {
            "text": "}",
            "lineNumber": 35,
            "isSignature": true
          }
        ]
      },
      "score": 0.18050545454025269
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 223
          },
          "endPosition": {
            "line": 283,
            "column": 83
          }
        },
        "contents": "function randomId(): string {\n \"output-\" + Date.now() + \"-\" + Math.random().toString(36).slice(2, 11);\n}\n\n/** Create or replace the Green output node and ensure an edge labeled \"output\" from source. Mutates data only. */\nfunction ensureOutputNodeAndEdge(\n\tdata: CanvasData,\n\tsourceNode: AllCanvasNodeData,\n\ttext: string,\n\tsettings: ZettelPluginSettings\n): void {\n\tconst outId = findOutputNodeForSource(data, sourceNode.id, settings);\n\tconst x = sourceNode.x;\n\tconst y = sourceNode.y + sourceNode.height + GREEN_NODE_PADDING;\n\tconst width = Math.max(200, sourceNode.width);\n\tconst height = 100;\n\tconst greenColor = settings.colorGreen;\n\n\tif (outId) {\n\t\tconst outNode = getNodeById(data, outId);\n\t\tif (outNode &amp;&amp; isTextNode(outNode)) {\n\t\t\t(outNode as CanvasTextData).text = text;\n\t\t}\n\t\tconst hasOutputEdge = data.edges.some(\n\t\t\t(e) =&gt; e.fromNode === sourceNode.id &amp;&amp; e.toNode === outId &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT\n\t\t);\n\t\tif (!hasOutputEdge) {\n\t\t\tdata.edges.push({\n\t\t\t\tid: randomId(),\n\t\t\t\tfromNode: sourceNode.id,\n\t\t\t\ttoNode: outId,\n\t\t\t\tlabel: EDGE_LABEL_OUTPUT,\n\t\t\t});\n\t\t}\n\t\treturn;\n\t}\n\n\tconst newNodeId = randomId();\n\tconst newTextNode: CanvasTextData = {\n\t\tid: newNodeId,\n\t\ttype: \"text\",\n\t\ttext,\n\t\tx,\n\t\ty,\n\t\twidth,\n\t\theight,\n\t\tcolor: greenColor,\n\t};\n\tdata.nodes.push(newTextNode);\n\tdata.edges.push({\n\t\tid: randomId(),\n\t\tfromNode: sourceNode.id,\n\t\ttoNode: newNodeId,\n\t\tlabel: EDGE_LABEL_OUTPUT,\n\t});\n}\n\n/** Run a single node (for \"Run Node\" command). Returns result or error message. */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "function randomId(): string {",
            "lineNumber": 224,
            "isSignature": true
          },
          {
            "text": " \"output-\" + Date.now() + \"-\" + Math.random().toString(36).slice(2, 11);",
            "lineNumber": 228
          },
          {
            "text": "}",
            "lineNumber": 229,
            "isSignature": true
          },
          {
            "lineNumber": 230
          },
          {
            "text": "/** Create or replace the Green output node and ensure an edge labeled \"output\" from source. Mutates data only. */",
            "lineNumber": 231
          },
          {
            "text": "function ensureOutputNodeAndEdge(",
            "lineNumber": 232,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 233,
            "isSignature": true
          },
          {
            "text": "\tsourceNode: AllCanvasNodeData,",
            "lineNumber": 234,
            "isSignature": true
          },
          {
            "text": "\ttext: string,",
            "lineNumber": 235,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings",
            "lineNumber": 236,
            "isSignature": true
          },
          {
            "text": "): void {",
            "lineNumber": 237,
            "isSignature": true
          },
          {
            "text": "\tconst outId = findOutputNodeForSource(data, sourceNode.id, settings);",
            "lineNumber": 238
          },
          {
            "text": "\tconst x = sourceNode.x;",
            "lineNumber": 239
          },
          {
            "text": "\tconst y = sourceNode.y + sourceNode.height + GREEN_NODE_PADDING;",
            "lineNumber": 240
          },
          {
            "text": "\tconst width = Math.max(200, sourceNode.width);",
            "lineNumber": 241
          },
          {
            "text": "\tconst height = 100;",
            "lineNumber": 242
          },
          {
            "text": "\tconst greenColor = settings.colorGreen;",
            "lineNumber": 243
          },
          {
            "lineNumber": 244
          },
          {
            "text": "\tif (outId) {",
            "lineNumber": 245
          },
          {
            "text": "\t\tconst outNode = getNodeById(data, outId);",
            "lineNumber": 246
          },
          {
            "text": "\t\tif (outNode &amp;&amp; isTextNode(outNode)) {",
            "lineNumber": 247
          },
          {
            "text": "\t\t\t(outNode as CanvasTextData).text = text;",
            "lineNumber": 248
          },
          {
            "text": "\t\t}",
            "lineNumber": 249
          },
          {
            "text": "\t\tconst hasOutputEdge = data.edges.some(",
            "lineNumber": 250
          },
          {
            "text": "\t\t\t(e) =&gt; e.fromNode === sourceNode.id &amp;&amp; e.toNode === outId &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT",
            "lineNumber": 251
          },
          {
            "text": "\t\t);",
            "lineNumber": 252
          },
          {
            "text": "\t\tif (!hasOutputEdge) {",
            "lineNumber": 253
          },
          {
            "text": "\t\t\tdata.edges.push({",
            "lineNumber": 254
          },
          {
            "text": "\t\t\t\tid: randomId(),",
            "lineNumber": 255
          },
          {
            "text": "\t\t\t\tfromNode: sourceNode.id,",
            "lineNumber": 256
          },
          {
            "text": "\t\t\t\ttoNode: outId,",
            "lineNumber": 257
          },
          {
            "text": "\t\t\t\tlabel: EDGE_LABEL_OUTPUT,",
            "lineNumber": 258
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 259
          },
          {
            "text": "\t\t}",
            "lineNumber": 260
          },
          {
            "text": "\t\treturn;",
            "lineNumber": 261
          },
          {
            "text": "\t}",
            "lineNumber": 262
          },
          {
            "lineNumber": 263
          },
          {
            "text": "\tconst newNodeId = randomId();",
            "lineNumber": 264
          },
          {
            "text": "\tconst newTextNode: CanvasTextData = {",
            "lineNumber": 265
          },
          {
            "text": "\t\tid: newNodeId,",
            "lineNumber": 266
          },
          {
            "text": "\t\ttype: \"text\",",
            "lineNumber": 267
          },
          {
            "text": "\t\ttext,",
            "lineNumber": 268
          },
          {
            "text": "\t\tx,",
            "lineNumber": 269
          },
          {
            "text": "\t\ty,",
            "lineNumber": 270
          },
          {
            "text": "\t\twidth,",
            "lineNumber": 271
          },
          {
            "text": "\t\theight,",
            "lineNumber": 272
          },
          {
            "text": "\t\tcolor: greenColor,",
            "lineNumber": 273
          },
          {
            "text": "\t};",
            "lineNumber": 274
          },
          {
            "text": "\tdata.nodes.push(newTextNode);",
            "lineNumber": 275
          },
          {
            "text": "\tdata.edges.push({",
            "lineNumber": 276
          },
          {
            "text": "\t\tid: randomId(),",
            "lineNumber": 277
          },
          {
            "text": "\t\tfromNode: sourceNode.id,",
            "lineNumber": 278
          },
          {
            "text": "\t\ttoNode: newNodeId,",
            "lineNumber": 279
          },
          {
            "text": "\t\tlabel: EDGE_LABEL_OUTPUT,",
            "lineNumber": 280
          },
          {
            "text": "\t});",
            "lineNumber": 281
          },
          {
            "text": "}",
            "lineNumber": 282,
            "isSignature": true
          },
          {
            "lineNumber": 283
          },
          {
            "text": "/** Run a single node (for \"Run Node\" command). Returns result or error message. */",
            "lineNumber": 284
          }
        ]
      },
      "score": 0.18041425943374634
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/kernelManager.ts",
        "range": {
          "startPosition": {
            "column": 49
          },
          "endPosition": {
            "line": 21,
            "column": 1
          }
        },
        "contents": "import {createPythonKernel} from \"./pythonKernel\";\n\n/** One kernel per canvas (key = canvas file path). */\nconst kernels = new Map&lt;string, PythonKernel&gt;();\n\nexport function getKernelForCanvas(canvasKey: string, pythonPath: string): PythonKernel {\n\tlet k = kernels.get(canvasKey);\n\tif (!k) {\n\t\tk = createPythonKernel(pythonPath);\n\t\tkernels.set(canvasKey, k);\n\t}\n\treturn k;\n}\n\nexport function terminateKernel(canvasKey: string): void {\n\tconst k = kernels.get(canvasKey);\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "import {createPythonKernel} from \"./pythonKernel\";",
            "lineNumber": 2
          },
          {
            "lineNumber": 3
          },
          {
            "text": "/** One kernel per canvas (key = canvas file path). */",
            "lineNumber": 4
          },
          {
            "text": "const kernels = new Map&lt;string, PythonKernel&gt;();",
            "lineNumber": 5
          },
          {
            "lineNumber": 6
          },
          {
            "text": "export function getKernelForCanvas(canvasKey: string, pythonPath: string): PythonKernel {",
            "lineNumber": 7,
            "isSignature": true
          },
          {
            "text": "\tlet k = kernels.get(canvasKey);",
            "lineNumber": 8
          },
          {
            "text": "\tif (!k) {",
            "lineNumber": 9
          },
          {
            "text": "\t\tk = createPythonKernel(pythonPath);",
            "lineNumber": 10
          },
          {
            "text": "\t\tkernels.set(canvasKey, k);",
            "lineNumber": 11
          },
          {
            "text": "\t}",
            "lineNumber": 12
          },
          {
            "text": "\treturn k;",
            "lineNumber": 13
          },
          {
            "text": "}",
            "lineNumber": 14,
            "isSignature": true
          },
          {
            "lineNumber": 15
          },
          {
            "text": "export function terminateKernel(canvasKey: string): void {",
            "lineNumber": 16,
            "isSignature": true
          },
          {
            "text": "\tconst k = kernels.get(canvasKey);",
            "lineNumber": 17
          },
          {
            "text": "}",
            "lineNumber": 22,
            "isSignature": true
          }
        ]
      },
      "score": 0.1781737059354782
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/state.ts",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 16,
            "column": 1
          }
        },
        "contents": "/** Per-canvas state: NodeID -&gt; last output result string. */\nconst canvasState = new Map&lt;string, Map&lt;string, string&gt;&gt;();\n\n/** Per-canvas edge mode: EdgeID -&gt; \"inject\" | \"concatenate\" (shown in floating label under edge). */\nconst edgeModeState = new Map&lt;string, Map&lt;string, \"inject\" | \"concatenate\"&gt;&gt;();\n\n/** Node currently running (waiting for AI/kernel) per canvas; used to show \"running\" on incoming edges. */\nconst runningNodeState = new Map&lt;string, string | null&gt;();\n\nfunction getCanvasState(canvasKey: string): Map&lt;string, string&gt; {\n\tlet map = canvasState.get(canvasKey);\n\tif (!map) {\n\t\tmap = new Map();\n\t\tcanvasState.set(canvasKey, map);\n\t}\n\treturn map;\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Per-canvas state: NodeID -&gt; last output result string. */",
            "lineNumber": 1
          },
          {
            "text": "const canvasState = new Map&lt;string, Map&lt;string, string&gt;&gt;();",
            "lineNumber": 2
          },
          {
            "lineNumber": 3
          },
          {
            "text": "/** Per-canvas edge mode: EdgeID -&gt; \"inject\" | \"concatenate\" (shown in floating label under edge). */",
            "lineNumber": 4
          },
          {
            "text": "const edgeModeState = new Map&lt;string, Map&lt;string, \"inject\" | \"concatenate\"&gt;&gt;();",
            "lineNumber": 5
          },
          {
            "lineNumber": 6
          },
          {
            "text": "/** Node currently running (waiting for AI/kernel) per canvas; used to show \"running\" on incoming edges. */",
            "lineNumber": 7
          },
          {
            "text": "const runningNodeState = new Map&lt;string, string | null&gt;();",
            "lineNumber": 8
          },
          {
            "lineNumber": 9
          },
          {
            "text": "function getCanvasState(canvasKey: string): Map&lt;string, string&gt; {",
            "lineNumber": 10,
            "isSignature": true
          },
          {
            "text": "\tlet map = canvasState.get(canvasKey);",
            "lineNumber": 11
          },
          {
            "text": "\tif (!map) {",
            "lineNumber": 12
          },
          {
            "text": "\t\tmap = new Map();",
            "lineNumber": 13
          },
          {
            "text": "\t\tcanvasState.set(canvasKey, map);",
            "lineNumber": 14
          },
          {
            "text": "\t}",
            "lineNumber": 15
          },
          {
            "text": "\treturn map;",
            "lineNumber": 16
          },
          {
            "text": "}",
            "lineNumber": 17,
            "isSignature": true
          }
        ]
      },
      "score": 0.17480123043060303
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/pythonKernel.ts",
        "range": {
          "startPosition": {
            "line": 16
          },
          "endPosition": {
            "line": 128,
            "column": 1
          }
        },
        "contents": "export function createPythonKernel(pythonPath: string): PythonKernel {\nfunction spawnProcess(): Promise&lt;void&gt; {\n(resolve, reject) =&gt; {\n catch (e) {\n\t\t\t\treject(e);\n\t\t\t}\n\t\t});\n\t}\n\n\tasync function run(code: string, inputText: string): Promise&lt;string&gt; {\n\t\tawait spawnProcess();\n\t\tif (!child?.stdin) throw new Error(\"Python process not running\");\n\t\tconst fullCode =\n\t\t\tOBSIDIAN_LOG_STUB +\n\t\t\t\"\\ninput = \" +\n\t\t\tJSON.stringify(inputText) +\n\t\t\t\"\\n\\n\" +\n\t\t\tcode +\n\t\t\t\"\\nprint(\" +\n\t\t\tJSON.stringify(END_MARKER) +\n\t\t\t\")\\n\";\n\t\t// Encode as base64 so we can send without escaping issues\n\t\tconst b64 = Buffer.from(fullCode, \"utf-8\").toString(\"base64\");\n\t\tconst payload = &#96;exec(__import__('base64').b64decode(\"${b64}\").decode())\\n&#96;;\n\t\tstdoutBuf = \"\";\n\t\treturn new Promise((resolve, reject) =&gt; {\n\t\t\tpendingResolve = resolve;\n\t\t\tpendingReject = reject;\n\t\t\tchild!.stdin!.write(payload, (err) =&gt; {\n\t\t\t\tif (err) {\n\t\t\t\t\tpendingReject?.(err);\n\t\t\t\t\tpendingResolve = null;\n\t\t\t\t\tpendingReject = null;\n\t\t\t\t}\n\t\t\t});\n\t\t\tsetTimeout(() =&gt; {\n\t\t\t\tif (pendingReject) {\n\t\t\t\t\tpendingReject(new Error(\"Python execution timeout (60s)\"));\n\t\t\t\t\tpendingResolve = null;\n\t\t\t\t\tpendingReject = null;\n\t\t\t\t}\n\t\t\t}, 60_000);\n\t\t});\n\t}\n\n\treturn {\n\t\tget onLog() {\n\t\t\treturn onLogCb;\n\t\t},\n\t\tset onLog(cb: ((line: string) =&gt; void) | undefined) {\n\t\t\tonLogCb = cb;\n\t\t},\n\t\trun,\n\t\tterminate() {\n\t\t\tif (child) {\n\t\t\t\tchild.kill();\n\t\t\t\tchild = null;\n\t\t\t}\n\t\t\tif (pendingReject) {\n\t\t\t\tpendingReject(new Error(\"Kernel terminated\"));\n\t\t\t\tpendingResolve = null;\n\t\t\t\tpendingReject = null;\n\t\t\t}\n\t\t},\n\t};\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 17,
                "column": 1
              },
              "endPosition": {
                "line": 17,
                "column": 8
              }
            },
            {
              "startPosition": {
                "line": 17,
                "column": 8
              },
              "endPosition": {
                "line": 18,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export function createPythonKernel(pythonPath: string): PythonKernel {",
            "lineNumber": 17,
            "isSignature": true
          },
          {
            "text": "function spawnProcess(): Promise&lt;void&gt; {",
            "lineNumber": 24
          },
          {
            "text": "(resolve, reject) =&gt; {",
            "lineNumber": 26
          },
          {
            "text": " catch (e) {",
            "lineNumber": 67
          },
          {
            "text": "\t\t\t\treject(e);",
            "lineNumber": 68
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 69
          },
          {
            "text": "\t\t});",
            "lineNumber": 70
          },
          {
            "text": "\t}",
            "lineNumber": 71
          },
          {
            "lineNumber": 72
          },
          {
            "text": "\tasync function run(code: string, inputText: string): Promise&lt;string&gt; {",
            "lineNumber": 73
          },
          {
            "text": "\t\tawait spawnProcess();",
            "lineNumber": 74
          },
          {
            "text": "\t\tif (!child?.stdin) throw new Error(\"Python process not running\");",
            "lineNumber": 75
          },
          {
            "text": "\t\tconst fullCode =",
            "lineNumber": 76
          },
          {
            "text": "\t\t\tOBSIDIAN_LOG_STUB +",
            "lineNumber": 77
          },
          {
            "text": "\t\t\t\"\\ninput = \" +",
            "lineNumber": 78
          },
          {
            "text": "\t\t\tJSON.stringify(inputText) +",
            "lineNumber": 79
          },
          {
            "text": "\t\t\t\"\\n\\n\" +",
            "lineNumber": 80
          },
          {
            "text": "\t\t\tcode +",
            "lineNumber": 81
          },
          {
            "text": "\t\t\t\"\\nprint(\" +",
            "lineNumber": 82
          },
          {
            "text": "\t\t\tJSON.stringify(END_MARKER) +",
            "lineNumber": 83
          },
          {
            "text": "\t\t\t\")\\n\";",
            "lineNumber": 84
          },
          {
            "text": "\t\t// Encode as base64 so we can send without escaping issues",
            "lineNumber": 85
          },
          {
            "text": "\t\tconst b64 = Buffer.from(fullCode, \"utf-8\").toString(\"base64\");",
            "lineNumber": 86
          },
          {
            "text": "\t\tconst payload = &#96;exec(__import__('base64').b64decode(\"${b64}\").decode())\\n&#96;;",
            "lineNumber": 87
          },
          {
            "text": "\t\tstdoutBuf = \"\";",
            "lineNumber": 88
          },
          {
            "text": "\t\treturn new Promise((resolve, reject) =&gt; {",
            "lineNumber": 89
          },
          {
            "text": "\t\t\tpendingResolve = resolve;",
            "lineNumber": 90
          },
          {
            "text": "\t\t\tpendingReject = reject;",
            "lineNumber": 91
          },
          {
            "text": "\t\t\tchild!.stdin!.write(payload, (err) =&gt; {",
            "lineNumber": 92
          },
          {
            "text": "\t\t\t\tif (err) {",
            "lineNumber": 93
          },
          {
            "text": "\t\t\t\t\tpendingReject?.(err);",
            "lineNumber": 94
          },
          {
            "text": "\t\t\t\t\tpendingResolve = null;",
            "lineNumber": 95
          },
          {
            "text": "\t\t\t\t\tpendingReject = null;",
            "lineNumber": 96
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 97
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 98
          },
          {
            "text": "\t\t\tsetTimeout(() =&gt; {",
            "lineNumber": 99
          },
          {
            "text": "\t\t\t\tif (pendingReject) {",
            "lineNumber": 100
          },
          {
            "text": "\t\t\t\t\tpendingReject(new Error(\"Python execution timeout (60s)\"));",
            "lineNumber": 101
          },
          {
            "text": "\t\t\t\t\tpendingResolve = null;",
            "lineNumber": 102
          },
          {
            "text": "\t\t\t\t\tpendingReject = null;",
            "lineNumber": 103
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 104
          },
          {
            "text": "\t\t\t}, 60_000);",
            "lineNumber": 105
          },
          {
            "text": "\t\t});",
            "lineNumber": 106
          },
          {
            "text": "\t}",
            "lineNumber": 107
          },
          {
            "lineNumber": 108
          },
          {
            "text": "\treturn {",
            "lineNumber": 109
          },
          {
            "text": "\t\tget onLog() {",
            "lineNumber": 110
          },
          {
            "text": "\t\t\treturn onLogCb;",
            "lineNumber": 111
          },
          {
            "text": "\t\t},",
            "lineNumber": 112
          },
          {
            "text": "\t\tset onLog(cb: ((line: string) =&gt; void) | undefined) {",
            "lineNumber": 113
          },
          {
            "text": "\t\t\tonLogCb = cb;",
            "lineNumber": 114
          },
          {
            "text": "\t\t},",
            "lineNumber": 115
          },
          {
            "text": "\t\trun,",
            "lineNumber": 116
          },
          {
            "text": "\t\tterminate() {",
            "lineNumber": 117
          },
          {
            "text": "\t\t\tif (child) {",
            "lineNumber": 118
          },
          {
            "text": "\t\t\t\tchild.kill();",
            "lineNumber": 119
          },
          {
            "text": "\t\t\t\tchild = null;",
            "lineNumber": 120
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 121
          },
          {
            "text": "\t\t\tif (pendingReject) {",
            "lineNumber": 122
          },
          {
            "text": "\t\t\t\tpendingReject(new Error(\"Kernel terminated\"));",
            "lineNumber": 123
          },
          {
            "text": "\t\t\t\tpendingResolve = null;",
            "lineNumber": 124
          },
          {
            "text": "\t\t\t\tpendingReject = null;",
            "lineNumber": 125
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 126
          },
          {
            "text": "\t\t},",
            "lineNumber": 127
          },
          {
            "text": "\t};",
            "lineNumber": 128
          },
          {
            "text": "}",
            "lineNumber": 129,
            "isSignature": true
          }
        ]
      },
      "score": 0.17152273654937744
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 32
          },
          "endPosition": {
            "line": 55,
            "column": 101
          }
        },
        "contents": "function getRootIds(data: CanvasData): string[] {\n\n\treturn data.nodes.filter((n) =&gt; !hasIncoming.has(n.id)).map((n) =&gt; n.id);\n}\n\n/** Check if there is a path from fromId to toId (ignoring output edges). */\nfunction canReach(data: CanvasData, fromId: string, toId: string): boolean {\n\tconst visited = new Set&lt;string&gt;();\n\tconst stack = [fromId];\n\twhile (stack.length &gt; 0) {\n\t\tconst id = stack.pop()!;\n\t\tif (id === toId) return true;\n\t\tif (visited.has(id)) continue;\n\t\tvisited.add(id);\n\t\tfor (const e of data.edges) {\n\t\t\tif (!isOutputEdge(e) &amp;&amp; e.fromNode === id) stack.push(e.toNode);\n\t\t}\n\t}\n\treturn false;\n}\n\n/** Topological order of node ids (only nodes that are ancestors of target; ignores output edges). */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "function getRootIds(data: CanvasData): string[] {",
            "lineNumber": 33,
            "isSignature": true
          },
          {
            "lineNumber": 36
          },
          {
            "text": "\treturn data.nodes.filter((n) =&gt; !hasIncoming.has(n.id)).map((n) =&gt; n.id);",
            "lineNumber": 37
          },
          {
            "text": "}",
            "lineNumber": 38,
            "isSignature": true
          },
          {
            "lineNumber": 39
          },
          {
            "text": "/** Check if there is a path from fromId to toId (ignoring output edges). */",
            "lineNumber": 40
          },
          {
            "text": "function canReach(data: CanvasData, fromId: string, toId: string): boolean {",
            "lineNumber": 41,
            "isSignature": true
          },
          {
            "text": "\tconst visited = new Set&lt;string&gt;();",
            "lineNumber": 42
          },
          {
            "text": "\tconst stack = [fromId];",
            "lineNumber": 43
          },
          {
            "text": "\twhile (stack.length &gt; 0) {",
            "lineNumber": 44
          },
          {
            "text": "\t\tconst id = stack.pop()!;",
            "lineNumber": 45
          },
          {
            "text": "\t\tif (id === toId) return true;",
            "lineNumber": 46
          },
          {
            "text": "\t\tif (visited.has(id)) continue;",
            "lineNumber": 47
          },
          {
            "text": "\t\tvisited.add(id);",
            "lineNumber": 48
          },
          {
            "text": "\t\tfor (const e of data.edges) {",
            "lineNumber": 49
          },
          {
            "text": "\t\t\tif (!isOutputEdge(e) &amp;&amp; e.fromNode === id) stack.push(e.toNode);",
            "lineNumber": 50
          },
          {
            "text": "\t\t}",
            "lineNumber": 51
          },
          {
            "text": "\t}",
            "lineNumber": 52
          },
          {
            "text": "\treturn false;",
            "lineNumber": 53
          },
          {
            "text": "}",
            "lineNumber": 54,
            "isSignature": true
          },
          {
            "lineNumber": 55
          },
          {
            "text": "/** Topological order of node ids (only nodes that are ancestors of target; ignores output edges). */",
            "lineNumber": 56
          }
        ]
      },
      "score": 0.1691361963748932
    }
  ]
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="semantic_search_full">
<details>
<summary>Tool use: **semantic_search_full**</summary>


Parameters:

```json
{
  "query": "Output box position or create node for result placement",
  "includePattern": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
  "topK": 10,
  "explanation": ""
}
```
Result:

```json
{
  "codeResults": [
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 223
          },
          "endPosition": {
            "line": 283,
            "column": 83
          }
        },
        "contents": "function randomId(): string {\n \"output-\" + Date.now() + \"-\" + Math.random().toString(36).slice(2, 11);\n}\n\n/** Create or replace the Green output node and ensure an edge labeled \"output\" from source. Mutates data only. */\nfunction ensureOutputNodeAndEdge(\n\tdata: CanvasData,\n\tsourceNode: AllCanvasNodeData,\n\ttext: string,\n\tsettings: ZettelPluginSettings\n): void {\n\tconst outId = findOutputNodeForSource(data, sourceNode.id, settings);\n\tconst x = sourceNode.x;\n\tconst y = sourceNode.y + sourceNode.height + GREEN_NODE_PADDING;\n\tconst width = Math.max(200, sourceNode.width);\n\tconst height = 100;\n\tconst greenColor = settings.colorGreen;\n\n\tif (outId) {\n\t\tconst outNode = getNodeById(data, outId);\n\t\tif (outNode &amp;&amp; isTextNode(outNode)) {\n\t\t\t(outNode as CanvasTextData).text = text;\n\t\t}\n\t\tconst hasOutputEdge = data.edges.some(\n\t\t\t(e) =&gt; e.fromNode === sourceNode.id &amp;&amp; e.toNode === outId &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT\n\t\t);\n\t\tif (!hasOutputEdge) {\n\t\t\tdata.edges.push({\n\t\t\t\tid: randomId(),\n\t\t\t\tfromNode: sourceNode.id,\n\t\t\t\ttoNode: outId,\n\t\t\t\tlabel: EDGE_LABEL_OUTPUT,\n\t\t\t});\n\t\t}\n\t\treturn;\n\t}\n\n\tconst newNodeId = randomId();\n\tconst newTextNode: CanvasTextData = {\n\t\tid: newNodeId,\n\t\ttype: \"text\",\n\t\ttext,\n\t\tx,\n\t\ty,\n\t\twidth,\n\t\theight,\n\t\tcolor: greenColor,\n\t};\n\tdata.nodes.push(newTextNode);\n\tdata.edges.push({\n\t\tid: randomId(),\n\t\tfromNode: sourceNode.id,\n\t\ttoNode: newNodeId,\n\t\tlabel: EDGE_LABEL_OUTPUT,\n\t});\n}\n\n/** Run a single node (for \"Run Node\" command). Returns result or error message. */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "function randomId(): string {",
            "lineNumber": 224,
            "isSignature": true
          },
          {
            "text": " \"output-\" + Date.now() + \"-\" + Math.random().toString(36).slice(2, 11);",
            "lineNumber": 228
          },
          {
            "text": "}",
            "lineNumber": 229,
            "isSignature": true
          },
          {
            "lineNumber": 230
          },
          {
            "text": "/** Create or replace the Green output node and ensure an edge labeled \"output\" from source. Mutates data only. */",
            "lineNumber": 231
          },
          {
            "text": "function ensureOutputNodeAndEdge(",
            "lineNumber": 232,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 233,
            "isSignature": true
          },
          {
            "text": "\tsourceNode: AllCanvasNodeData,",
            "lineNumber": 234,
            "isSignature": true
          },
          {
            "text": "\ttext: string,",
            "lineNumber": 235,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings",
            "lineNumber": 236,
            "isSignature": true
          },
          {
            "text": "): void {",
            "lineNumber": 237,
            "isSignature": true
          },
          {
            "text": "\tconst outId = findOutputNodeForSource(data, sourceNode.id, settings);",
            "lineNumber": 238
          },
          {
            "text": "\tconst x = sourceNode.x;",
            "lineNumber": 239
          },
          {
            "text": "\tconst y = sourceNode.y + sourceNode.height + GREEN_NODE_PADDING;",
            "lineNumber": 240
          },
          {
            "text": "\tconst width = Math.max(200, sourceNode.width);",
            "lineNumber": 241
          },
          {
            "text": "\tconst height = 100;",
            "lineNumber": 242
          },
          {
            "text": "\tconst greenColor = settings.colorGreen;",
            "lineNumber": 243
          },
          {
            "lineNumber": 244
          },
          {
            "text": "\tif (outId) {",
            "lineNumber": 245
          },
          {
            "text": "\t\tconst outNode = getNodeById(data, outId);",
            "lineNumber": 246
          },
          {
            "text": "\t\tif (outNode &amp;&amp; isTextNode(outNode)) {",
            "lineNumber": 247
          },
          {
            "text": "\t\t\t(outNode as CanvasTextData).text = text;",
            "lineNumber": 248
          },
          {
            "text": "\t\t}",
            "lineNumber": 249
          },
          {
            "text": "\t\tconst hasOutputEdge = data.edges.some(",
            "lineNumber": 250
          },
          {
            "text": "\t\t\t(e) =&gt; e.fromNode === sourceNode.id &amp;&amp; e.toNode === outId &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT",
            "lineNumber": 251
          },
          {
            "text": "\t\t);",
            "lineNumber": 252
          },
          {
            "text": "\t\tif (!hasOutputEdge) {",
            "lineNumber": 253
          },
          {
            "text": "\t\t\tdata.edges.push({",
            "lineNumber": 254
          },
          {
            "text": "\t\t\t\tid: randomId(),",
            "lineNumber": 255
          },
          {
            "text": "\t\t\t\tfromNode: sourceNode.id,",
            "lineNumber": 256
          },
          {
            "text": "\t\t\t\ttoNode: outId,",
            "lineNumber": 257
          },
          {
            "text": "\t\t\t\tlabel: EDGE_LABEL_OUTPUT,",
            "lineNumber": 258
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 259
          },
          {
            "text": "\t\t}",
            "lineNumber": 260
          },
          {
            "text": "\t\treturn;",
            "lineNumber": 261
          },
          {
            "text": "\t}",
            "lineNumber": 262
          },
          {
            "lineNumber": 263
          },
          {
            "text": "\tconst newNodeId = randomId();",
            "lineNumber": 264
          },
          {
            "text": "\tconst newTextNode: CanvasTextData = {",
            "lineNumber": 265
          },
          {
            "text": "\t\tid: newNodeId,",
            "lineNumber": 266
          },
          {
            "text": "\t\ttype: \"text\",",
            "lineNumber": 267
          },
          {
            "text": "\t\ttext,",
            "lineNumber": 268
          },
          {
            "text": "\t\tx,",
            "lineNumber": 269
          },
          {
            "text": "\t\ty,",
            "lineNumber": 270
          },
          {
            "text": "\t\twidth,",
            "lineNumber": 271
          },
          {
            "text": "\t\theight,",
            "lineNumber": 272
          },
          {
            "text": "\t\tcolor: greenColor,",
            "lineNumber": 273
          },
          {
            "text": "\t};",
            "lineNumber": 274
          },
          {
            "text": "\tdata.nodes.push(newTextNode);",
            "lineNumber": 275
          },
          {
            "text": "\tdata.edges.push({",
            "lineNumber": 276
          },
          {
            "text": "\t\tid: randomId(),",
            "lineNumber": 277
          },
          {
            "text": "\t\tfromNode: sourceNode.id,",
            "lineNumber": 278
          },
          {
            "text": "\t\ttoNode: newNodeId,",
            "lineNumber": 279
          },
          {
            "text": "\t\tlabel: EDGE_LABEL_OUTPUT,",
            "lineNumber": 280
          },
          {
            "text": "\t});",
            "lineNumber": 281
          },
          {
            "text": "}",
            "lineNumber": 282,
            "isSignature": true
          },
          {
            "lineNumber": 283
          },
          {
            "text": "/** Run a single node (for \"Run Node\" command). Returns result or error message. */",
            "lineNumber": 284
          }
        ]
      },
      "score": 0.33874309062957764
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/types.ts",
        "range": {
          "startPosition": {
            "line": 118,
            "column": 37
          },
          "endPosition": {
            "line": 145,
            "column": 1
          }
        },
        "contents": "/** Find the Green (output) node for a given source node. Edge-first (label \"output\"), then position fallback. */\nexport function findOutputNodeForSource(\n\tdata: CanvasData,\n\tsourceNodeId: string,\n\tsettings: ZettelPluginSettings\n): string | null {\n\tconst outputEdge = data.edges.find(\n\t\t(e) =&gt; e.fromNode === sourceNodeId &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT\n\t);\n\tif (outputEdge) return outputEdge.toNode;\n\tconst source = getNodeById(data, sourceNodeId);\n\tif (!source) return null;\n\tconst greenColor = normalizeColor(settings.colorGreen as CanvasColor | undefined);\n\tif (!greenColor) return null;\n\tconst expectedY = source.y + source.height + GREEN_NODE_PADDING;\n\tconst tolerance = 30; // allow small layout drift\n\tfor (const node of data.nodes) {\n\t\tif (node.id === sourceNodeId) continue;\n\t\tif (normalizeColor(node.color) !== greenColor) continue;\n\t\t// Same x (or close), and y at or near expected\n\t\tif (Math.abs(node.x - source.x) &gt; 50) continue;\n\t\tif (node.y &lt; expectedY - tolerance || node.y &gt; expectedY + tolerance) continue;\n\t\treturn node.id;\n\t}\n\treturn null;\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Find the Green (output) node for a given source node. Edge-first (label \"output\"), then position fallback. */",
            "lineNumber": 121
          },
          {
            "text": "export function findOutputNodeForSource(",
            "lineNumber": 122,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 123,
            "isSignature": true
          },
          {
            "text": "\tsourceNodeId: string,",
            "lineNumber": 124,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings",
            "lineNumber": 125,
            "isSignature": true
          },
          {
            "text": "): string | null {",
            "lineNumber": 126,
            "isSignature": true
          },
          {
            "text": "\tconst outputEdge = data.edges.find(",
            "lineNumber": 127
          },
          {
            "text": "\t\t(e) =&gt; e.fromNode === sourceNodeId &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT",
            "lineNumber": 128
          },
          {
            "text": "\t);",
            "lineNumber": 129
          },
          {
            "text": "\tif (outputEdge) return outputEdge.toNode;",
            "lineNumber": 130
          },
          {
            "text": "\tconst source = getNodeById(data, sourceNodeId);",
            "lineNumber": 131
          },
          {
            "text": "\tif (!source) return null;",
            "lineNumber": 132
          },
          {
            "text": "\tconst greenColor = normalizeColor(settings.colorGreen as CanvasColor | undefined);",
            "lineNumber": 133
          },
          {
            "text": "\tif (!greenColor) return null;",
            "lineNumber": 134
          },
          {
            "text": "\tconst expectedY = source.y + source.height + GREEN_NODE_PADDING;",
            "lineNumber": 135
          },
          {
            "text": "\tconst tolerance = 30; // allow small layout drift",
            "lineNumber": 136
          },
          {
            "text": "\tfor (const node of data.nodes) {",
            "lineNumber": 137
          },
          {
            "text": "\t\tif (node.id === sourceNodeId) continue;",
            "lineNumber": 138
          },
          {
            "text": "\t\tif (normalizeColor(node.color) !== greenColor) continue;",
            "lineNumber": 139
          },
          {
            "text": "\t\t// Same x (or close), and y at or near expected",
            "lineNumber": 140
          },
          {
            "text": "\t\tif (Math.abs(node.x - source.x) &gt; 50) continue;",
            "lineNumber": 141
          },
          {
            "text": "\t\tif (node.y &lt; expectedY - tolerance || node.y &gt; expectedY + tolerance) continue;",
            "lineNumber": 142
          },
          {
            "text": "\t\treturn node.id;",
            "lineNumber": 143
          },
          {
            "text": "\t}",
            "lineNumber": 144
          },
          {
            "text": "\treturn null;",
            "lineNumber": 145
          },
          {
            "text": "}",
            "lineNumber": 146,
            "isSignature": true
          }
        ]
      },
      "score": 0.3189707100391388
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 134
          },
          "endPosition": {
            "line": 220,
            "column": 1
          }
        },
        "contents": "async function updateEdgeLabelsAndSave(\n\tvault: App[\"vault\"],\n\tcanvasFilePath: string,\n\tdata: CanvasData,\n\tnodeId: string,\n\tedgeModes: Map&lt;string, EdgeInputMode&gt;,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;void&gt; {\n\n}\n\n/** Run a single node: get input + parent context (concatenate or {{var:name}}), call LLM or Python, store result. */\nasync function runSingleNode(\n\tapp: App,\n\tsettings: ZettelPluginSettings,\n\tcanvasKey: string,\n\tcanvasFilePath: string,\n\tdata: CanvasData,\n\tnodeId: string,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;string&gt; {\n\tconst node = getNodeById(data, nodeId);\n\tif (!node) return \"\";\n\tconst role = getNodeRole(node, settings);\n\tif (!role || role === \"yellow\" || role === \"green\") {\n\t\t// Yellow: pass-through (use node content as result)\n\t\tif (role === \"yellow\") {\n\t\t\tconst content = await getNodeContent(node, app.vault);\n\t\t\tsetNodeResult(canvasKey, nodeId, content);\n\t\t\treturn content;\n\t\t}\n\t\treturn \"\";\n\t}\n\tconst incoming = getIncomingEdgesWithLabels(nodeId, data);\n\tconst nodeInput = await getNodeContent(node, app.vault);\n\tconst { concatenatedPart, template, edgeModes } = buildInputWithVariables(\n\t\tcanvasKey,\n\t\tnodeInput,\n\t\tincoming\n\t);\n\tconst fullPrompt =\n\t\tconcatenatedPart.length &gt; 0 ? &#96;${concatenatedPart}\\n\\n---\\n\\n${template}&#96; : template;\n\n\tif (role === \"orange\") {\n\t\tconst model = settings.ollamaOrangeModel || \"llama2\";\n\t\tconst result = await ollamaGenerate({ model, prompt: fullPrompt, stream: false });\n\t\tsetNodeResult(canvasKey, nodeId, result);\n\t\tensureOutputNodeAndEdge(data, node, result, settings);\n\t\tawait updateEdgeLabelsAndSave(app.vault, canvasFilePath, data, nodeId, edgeModes, liveCanvas);\n\t\treturn result;\n\t}\n\tif (role === \"purple\") {\n\t\tconst model = settings.ollamaPurpleModel || \"llama2\";\n\t\tconst result = await ollamaGenerate({ model, prompt: fullPrompt, stream: false });\n\t\tsetNodeResult(canvasKey, nodeId, result);\n\t\tensureOutputNodeAndEdge(data, node, result, settings);\n\t\tawait updateEdgeLabelsAndSave(app.vault, canvasFilePath, data, nodeId, edgeModes, liveCanvas);\n\t\treturn result;\n\t}\n\tif (role === \"blue\") {\n\t\tconst kernel = getKernelForCanvas;\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "async function updateEdgeLabelsAndSave(",
            "lineNumber": 135,
            "isSignature": true
          },
          {
            "text": "\tvault: App[\"vault\"],",
            "lineNumber": 136,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 137,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 138,
            "isSignature": true
          },
          {
            "text": "\tnodeId: string,",
            "lineNumber": 139,
            "isSignature": true
          },
          {
            "text": "\tedgeModes: Map&lt;string, EdgeInputMode&gt;,",
            "lineNumber": 140,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 141,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;void&gt; {",
            "lineNumber": 142,
            "isSignature": true
          },
          {
            "lineNumber": 161
          },
          {
            "text": "}",
            "lineNumber": 162,
            "isSignature": true
          },
          {
            "lineNumber": 163
          },
          {
            "text": "/** Run a single node: get input + parent context (concatenate or {{var:name}}), call LLM or Python, store result. */",
            "lineNumber": 164
          },
          {
            "text": "async function runSingleNode(",
            "lineNumber": 165,
            "isSignature": true
          },
          {
            "text": "\tapp: App,",
            "lineNumber": 166,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 167,
            "isSignature": true
          },
          {
            "text": "\tcanvasKey: string,",
            "lineNumber": 168,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 169,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 170,
            "isSignature": true
          },
          {
            "text": "\tnodeId: string,",
            "lineNumber": 171,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 172,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;string&gt; {",
            "lineNumber": 173,
            "isSignature": true
          },
          {
            "text": "\tconst node = getNodeById(data, nodeId);",
            "lineNumber": 174
          },
          {
            "text": "\tif (!node) return \"\";",
            "lineNumber": 175
          },
          {
            "text": "\tconst role = getNodeRole(node, settings);",
            "lineNumber": 176
          },
          {
            "text": "\tif (!role || role === \"yellow\" || role === \"green\") {",
            "lineNumber": 177
          },
          {
            "text": "\t\t// Yellow: pass-through (use node content as result)",
            "lineNumber": 178
          },
          {
            "text": "\t\tif (role === \"yellow\") {",
            "lineNumber": 179
          },
          {
            "text": "\t\t\tconst content = await getNodeContent(node, app.vault);",
            "lineNumber": 180
          },
          {
            "text": "\t\t\tsetNodeResult(canvasKey, nodeId, content);",
            "lineNumber": 181
          },
          {
            "text": "\t\t\treturn content;",
            "lineNumber": 182
          },
          {
            "text": "\t\t}",
            "lineNumber": 183
          },
          {
            "text": "\t\treturn \"\";",
            "lineNumber": 184
          },
          {
            "text": "\t}",
            "lineNumber": 185
          },
          {
            "text": "\tconst incoming = getIncomingEdgesWithLabels(nodeId, data);",
            "lineNumber": 186
          },
          {
            "text": "\tconst nodeInput = await getNodeContent(node, app.vault);",
            "lineNumber": 187
          },
          {
            "text": "\tconst { concatenatedPart, template, edgeModes } = buildInputWithVariables(",
            "lineNumber": 188
          },
          {
            "text": "\t\tcanvasKey,",
            "lineNumber": 189
          },
          {
            "text": "\t\tnodeInput,",
            "lineNumber": 190
          },
          {
            "text": "\t\tincoming",
            "lineNumber": 191
          },
          {
            "text": "\t);",
            "lineNumber": 192
          },
          {
            "text": "\tconst fullPrompt =",
            "lineNumber": 193
          },
          {
            "text": "\t\tconcatenatedPart.length &gt; 0 ? &#96;${concatenatedPart}\\n\\n---\\n\\n${template}&#96; : template;",
            "lineNumber": 194
          },
          {
            "lineNumber": 195
          },
          {
            "text": "\tif (role === \"orange\") {",
            "lineNumber": 196
          },
          {
            "text": "\t\tconst model = settings.ollamaOrangeModel || \"llama2\";",
            "lineNumber": 197
          },
          {
            "text": "\t\tconst result = await ollamaGenerate({ model, prompt: fullPrompt, stream: false });",
            "lineNumber": 198
          },
          {
            "text": "\t\tsetNodeResult(canvasKey, nodeId, result);",
            "lineNumber": 199
          },
          {
            "text": "\t\tensureOutputNodeAndEdge(data, node, result, settings);",
            "lineNumber": 200
          },
          {
            "text": "\t\tawait updateEdgeLabelsAndSave(app.vault, canvasFilePath, data, nodeId, edgeModes, liveCanvas);",
            "lineNumber": 201
          },
          {
            "text": "\t\treturn result;",
            "lineNumber": 202
          },
          {
            "text": "\t}",
            "lineNumber": 203
          },
          {
            "text": "\tif (role === \"purple\") {",
            "lineNumber": 204
          },
          {
            "text": "\t\tconst model = settings.ollamaPurpleModel || \"llama2\";",
            "lineNumber": 205
          },
          {
            "text": "\t\tconst result = await ollamaGenerate({ model, prompt: fullPrompt, stream: false });",
            "lineNumber": 206
          },
          {
            "text": "\t\tsetNodeResult(canvasKey, nodeId, result);",
            "lineNumber": 207
          },
          {
            "text": "\t\tensureOutputNodeAndEdge(data, node, result, settings);",
            "lineNumber": 208
          },
          {
            "text": "\t\tawait updateEdgeLabelsAndSave(app.vault, canvasFilePath, data, nodeId, edgeModes, liveCanvas);",
            "lineNumber": 209
          },
          {
            "text": "\t\treturn result;",
            "lineNumber": 210
          },
          {
            "text": "\t}",
            "lineNumber": 211
          },
          {
            "text": "\tif (role === \"blue\") {",
            "lineNumber": 212
          },
          {
            "text": "\t\tconst kernel = getKernelForCanvas;",
            "lineNumber": 213
          },
          {
            "text": "}",
            "lineNumber": 221,
            "isSignature": true
          }
        ]
      },
      "score": 0.2627156972885132
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 164
          },
          "endPosition": {
            "line": 228,
            "column": 1
          }
        },
        "contents": "async function runSingleNode(\n\tapp: App,\n\tsettings: ZettelPluginSettings,\n\tcanvasKey: string,\n\tcanvasFilePath: string,\n\tdata: CanvasData,\n\tnodeId: string,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;string&gt; {\n edgeModes, liveCanvas);\n\t\treturn result;\n\t}\n\tif (role === \"blue\") {\n\t\tconst kernel = getKernelForCanvas(canvasKey, settings.pythonPath);\n\t\tconst result = await kernel.run(template, concatenatedPart);\n\t\tsetNodeResult(canvasKey, nodeId, result);\n\t\tensureOutputNodeAndEdge(data, node, result, settings);\n\t\tawait updateEdgeLabelsAndSave(app.vault, canvasFilePath, data, nodeId, edgeModes, liveCanvas);\n\t\treturn result;\n\t}\n\treturn \"\";\n}\n\n/** Generate a unique id for new canvas nodes/edges. */\nfunction randomId(): string {\n\tif\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 164,
                "column": 1
              },
              "endPosition": {
                "line": 173,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "async function runSingleNode(",
            "lineNumber": 165,
            "isSignature": true
          },
          {
            "text": "\tapp: App,",
            "lineNumber": 166,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 167,
            "isSignature": true
          },
          {
            "text": "\tcanvasKey: string,",
            "lineNumber": 168,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 169,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 170,
            "isSignature": true
          },
          {
            "text": "\tnodeId: string,",
            "lineNumber": 171,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 172,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;string&gt; {",
            "lineNumber": 173,
            "isSignature": true
          },
          {
            "text": " edgeModes, liveCanvas);",
            "lineNumber": 209
          },
          {
            "text": "\t\treturn result;",
            "lineNumber": 210
          },
          {
            "text": "\t}",
            "lineNumber": 211
          },
          {
            "text": "\tif (role === \"blue\") {",
            "lineNumber": 212
          },
          {
            "text": "\t\tconst kernel = getKernelForCanvas(canvasKey, settings.pythonPath);",
            "lineNumber": 213
          },
          {
            "text": "\t\tconst result = await kernel.run(template, concatenatedPart);",
            "lineNumber": 214
          },
          {
            "text": "\t\tsetNodeResult(canvasKey, nodeId, result);",
            "lineNumber": 215
          },
          {
            "text": "\t\tensureOutputNodeAndEdge(data, node, result, settings);",
            "lineNumber": 216
          },
          {
            "text": "\t\tawait updateEdgeLabelsAndSave(app.vault, canvasFilePath, data, nodeId, edgeModes, liveCanvas);",
            "lineNumber": 217
          },
          {
            "text": "\t\treturn result;",
            "lineNumber": 218
          },
          {
            "text": "\t}",
            "lineNumber": 219
          },
          {
            "text": "\treturn \"\";",
            "lineNumber": 220
          },
          {
            "text": "}",
            "lineNumber": 221,
            "isSignature": true
          },
          {
            "lineNumber": 222
          },
          {
            "text": "/** Generate a unique id for new canvas nodes/edges. */",
            "lineNumber": 223
          },
          {
            "text": "function randomId(): string {",
            "lineNumber": 224,
            "isSignature": true
          },
          {
            "text": "\tif",
            "lineNumber": 225
          },
          {
            "text": "}",
            "lineNumber": 229,
            "isSignature": true
          }
        ]
      },
      "score": 0.2178730070590973
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 231
          },
          "endPosition": {
            "line": 314,
            "column": 1
          }
        },
        "contents": "function ensureOutputNodeAndEdge(\n\tdata: CanvasData,\n\tsourceNode: AllCanvasNodeData,\n\ttext: string,\n\tsettings: ZettelPluginSettings\n): void {\n\n\n\t\tlabel: EDGE_LABEL_OUTPUT,\n\t});\n}\n\n/** Run a single node (for \"Run Node\" command). Returns result or error message. */\nexport async function runNode(\n\tapp: App,\n\tsettings: ZettelPluginSettings,\n\tcanvasFilePath: string,\n\tnodeId: string,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;{ ok: boolean; message?: string }&gt; {\n\tconst data = await loadCanvasData(app.vault, canvasFilePath);\n\tif (!data) return { ok: false, message: \"Could not load canvas data.\" };\n\tconst node = getNodeById(data, nodeId);\n\tif (!node) return { ok: false, message: \"Node not found.\" };\n\tconst role = getNodeRole(node, settings);\n\tif (!role) return { ok: false, message: \"Node color is not mapped to a role.\" };\n\tif (role === \"green\") return { ok: false, message: \"Green nodes are output-only.\" };\n\tconst parentIds = getParentIdsSortedByY(nodeId, data);\n\tfor (const pid of parentIds) {\n\t\tif (getNodeResult(getCanvasKey(canvasFilePath), pid) == null) {\n\t\t\treturn { ok: false, message: \"Parent node(s) have not been run yet. Run chain or run parents first.\" };\n\t\t}\n\t}\n\tconst canvasKey = getCanvasKey(canvasFilePath);\n\ttry {\n\t\tsetRunningNodeId(canvasKey, nodeId);\n\t\tawait runSingleNode(app, settings, canvasKey, canvasFilePath, data, nodeId, liveCanvas);\n\t\treturn { ok: true };\n\t} catch (e) {\n\t\treturn { ok: false, message: e instanceof Error ? e.message : String(e) };\n\t} finally {\n\t\tsetRunningNodeId(canvasKey, null);\n\t}\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "function ensureOutputNodeAndEdge(",
            "lineNumber": 232,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 233,
            "isSignature": true
          },
          {
            "text": "\tsourceNode: AllCanvasNodeData,",
            "lineNumber": 234,
            "isSignature": true
          },
          {
            "text": "\ttext: string,",
            "lineNumber": 235,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings",
            "lineNumber": 236,
            "isSignature": true
          },
          {
            "text": "): void {",
            "lineNumber": 237,
            "isSignature": true
          },
          {
            "lineNumber": 276
          },
          {
            "lineNumber": 279
          },
          {
            "text": "\t\tlabel: EDGE_LABEL_OUTPUT,",
            "lineNumber": 280
          },
          {
            "text": "\t});",
            "lineNumber": 281
          },
          {
            "text": "}",
            "lineNumber": 282,
            "isSignature": true
          },
          {
            "lineNumber": 283
          },
          {
            "text": "/** Run a single node (for \"Run Node\" command). Returns result or error message. */",
            "lineNumber": 284
          },
          {
            "text": "export async function runNode(",
            "lineNumber": 285,
            "isSignature": true
          },
          {
            "text": "\tapp: App,",
            "lineNumber": 286,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 287,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 288,
            "isSignature": true
          },
          {
            "text": "\tnodeId: string,",
            "lineNumber": 289,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 290,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;{ ok: boolean; message?: string }&gt; {",
            "lineNumber": 291,
            "isSignature": true
          },
          {
            "text": "\tconst data = await loadCanvasData(app.vault, canvasFilePath);",
            "lineNumber": 292
          },
          {
            "text": "\tif (!data) return { ok: false, message: \"Could not load canvas data.\" };",
            "lineNumber": 293
          },
          {
            "text": "\tconst node = getNodeById(data, nodeId);",
            "lineNumber": 294
          },
          {
            "text": "\tif (!node) return { ok: false, message: \"Node not found.\" };",
            "lineNumber": 295
          },
          {
            "text": "\tconst role = getNodeRole(node, settings);",
            "lineNumber": 296
          },
          {
            "text": "\tif (!role) return { ok: false, message: \"Node color is not mapped to a role.\" };",
            "lineNumber": 297
          },
          {
            "text": "\tif (role === \"green\") return { ok: false, message: \"Green nodes are output-only.\" };",
            "lineNumber": 298
          },
          {
            "text": "\tconst parentIds = getParentIdsSortedByY(nodeId, data);",
            "lineNumber": 299
          },
          {
            "text": "\tfor (const pid of parentIds) {",
            "lineNumber": 300
          },
          {
            "text": "\t\tif (getNodeResult(getCanvasKey(canvasFilePath), pid) == null) {",
            "lineNumber": 301
          },
          {
            "text": "\t\t\treturn { ok: false, message: \"Parent node(s) have not been run yet. Run chain or run parents first.\" };",
            "lineNumber": 302
          },
          {
            "text": "\t\t}",
            "lineNumber": 303
          },
          {
            "text": "\t}",
            "lineNumber": 304
          },
          {
            "text": "\tconst canvasKey = getCanvasKey(canvasFilePath);",
            "lineNumber": 305
          },
          {
            "text": "\ttry {",
            "lineNumber": 306
          },
          {
            "text": "\t\tsetRunningNodeId(canvasKey, nodeId);",
            "lineNumber": 307
          },
          {
            "text": "\t\tawait runSingleNode(app, settings, canvasKey, canvasFilePath, data, nodeId, liveCanvas);",
            "lineNumber": 308
          },
          {
            "text": "\t\treturn { ok: true };",
            "lineNumber": 309
          },
          {
            "text": "\t} catch (e) {",
            "lineNumber": 310
          },
          {
            "text": "\t\treturn { ok: false, message: e instanceof Error ? e.message : String(e) };",
            "lineNumber": 311
          },
          {
            "text": "\t} finally {",
            "lineNumber": 312
          },
          {
            "text": "\t\tsetRunningNodeId(canvasKey, null);",
            "lineNumber": 313
          },
          {
            "text": "\t}",
            "lineNumber": 314
          },
          {
            "text": "}",
            "lineNumber": 315,
            "isSignature": true
          }
        ]
      },
      "score": 0.2175525426864624
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/types.test.ts",
        "range": {
          "startPosition": {
            "line": 187,
            "column": 3
          },
          "endPosition": {
            "line": 233,
            "column": 1
          }
        },
        "contents": "describe(\"findOutputNodeForSource\", () =&gt; {\n\tconst settings = { ...DEFAULT_SETTINGS, colorGreen: \"5\" };\n\n\tit(\"returns null when source node not found\", () =&gt; {\n\t\tconst data: CanvasData = { nodes: [], edges: [] };\n\t\texpect(findOutputNodeForSource(data, \"missing\", settings)).toBeNull();\n\t});\n\tit(\"returns green node id when it sits below source within tolerance\", () =&gt; {\n\t\tconst sourceY = 100;\n\t\tconst greenY = sourceY + 50 + GREEN_NODE_PADDING; // 170\n\t\tconst data: CanvasData = {\n\t\t\tnodes: [\n\t\t\t\t{ id: \"src\", x: 10, y: sourceY, width: 200, height: 50, type: \"text\", text: \"\", color: \"1\" },\n\t\t\t\t{ id: \"out\", x: 10, y: greenY, width: 200, height: 100, type: \"text\", text: \"\", color: \"5\" },\n\t\t\t],\n\t\t\tedges: [],\n\t\t};\n\t\texpect(findOutputNodeForSource(data, \"src\", settings)).toBe(\"out\");\n\t});\n\tit(\"returns null when no green node in expected position\", () =&gt; {\n\t\tconst data: CanvasData = {\n\t\t\tnodes: [{ id: \"src\", x: 0, y: 0, width: 100, height: 50, type: \"text\", text: \"\", color: \"1\" }],\n\t\t\tedges: [],\n\t\t};\n\t\texpect(findOutputNodeForSource(data, \"src\", settings)).toBeNull();\n\t});\n\tit(\"returns toNode when edge from source has label output\", () =&gt; {\n\t\tconst data: CanvasData = {\n\t\t\tnodes: [\n\t\t\t\t{ id: \"src\", x: 0, y: 0, width: 100, height: 50, type: \"text\", text: \"\", color: \"1\" },\n\t\t\t\t{ id: \"out\", x: 0, y: 200, width: 100, height: 50, type: \"text\", text: \"\", color: \"5\" },\n\t\t\t],\n\t\t\tedges: [\n\t\t\t\t{ id: \"e1\", fromNode: \"src\", toNode: \"out\", label: EDGE_LABEL_OUTPUT },\n\t\t\t],\n\t\t};\n\t\texpect(findOutputNodeForSource(data, \"src\", settings)).toBe(\"out\");\n\t});\n});\n\ndescribe(\"GREEN_NODE_PADDING\", () =&gt; {\n\tit\n\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "describe(\"findOutputNodeForSource\", () =&gt; {",
            "lineNumber": 190
          },
          {
            "text": "\tconst settings = { ...DEFAULT_SETTINGS, colorGreen: \"5\" };",
            "lineNumber": 191
          },
          {
            "lineNumber": 192
          },
          {
            "text": "\tit(\"returns null when source node not found\", () =&gt; {",
            "lineNumber": 193
          },
          {
            "text": "\t\tconst data: CanvasData = { nodes: [], edges: [] };",
            "lineNumber": 194
          },
          {
            "text": "\t\texpect(findOutputNodeForSource(data, \"missing\", settings)).toBeNull();",
            "lineNumber": 195
          },
          {
            "text": "\t});",
            "lineNumber": 196
          },
          {
            "text": "\tit(\"returns green node id when it sits below source within tolerance\", () =&gt; {",
            "lineNumber": 197
          },
          {
            "text": "\t\tconst sourceY = 100;",
            "lineNumber": 198
          },
          {
            "text": "\t\tconst greenY = sourceY + 50 + GREEN_NODE_PADDING; // 170",
            "lineNumber": 199
          },
          {
            "text": "\t\tconst data: CanvasData = {",
            "lineNumber": 200
          },
          {
            "text": "\t\t\tnodes: [",
            "lineNumber": 201
          },
          {
            "text": "\t\t\t\t{ id: \"src\", x: 10, y: sourceY, width: 200, height: 50, type: \"text\", text: \"\", color: \"1\" },",
            "lineNumber": 202
          },
          {
            "text": "\t\t\t\t{ id: \"out\", x: 10, y: greenY, width: 200, height: 100, type: \"text\", text: \"\", color: \"5\" },",
            "lineNumber": 203
          },
          {
            "text": "\t\t\t],",
            "lineNumber": 204
          },
          {
            "text": "\t\t\tedges: [],",
            "lineNumber": 205
          },
          {
            "text": "\t\t};",
            "lineNumber": 206
          },
          {
            "text": "\t\texpect(findOutputNodeForSource(data, \"src\", settings)).toBe(\"out\");",
            "lineNumber": 207
          },
          {
            "text": "\t});",
            "lineNumber": 208
          },
          {
            "text": "\tit(\"returns null when no green node in expected position\", () =&gt; {",
            "lineNumber": 209
          },
          {
            "text": "\t\tconst data: CanvasData = {",
            "lineNumber": 210
          },
          {
            "text": "\t\t\tnodes: [{ id: \"src\", x: 0, y: 0, width: 100, height: 50, type: \"text\", text: \"\", color: \"1\" }],",
            "lineNumber": 211
          },
          {
            "text": "\t\t\tedges: [],",
            "lineNumber": 212
          },
          {
            "text": "\t\t};",
            "lineNumber": 213
          },
          {
            "text": "\t\texpect(findOutputNodeForSource(data, \"src\", settings)).toBeNull();",
            "lineNumber": 214
          },
          {
            "text": "\t});",
            "lineNumber": 215
          },
          {
            "text": "\tit(\"returns toNode when edge from source has label output\", () =&gt; {",
            "lineNumber": 216
          },
          {
            "text": "\t\tconst data: CanvasData = {",
            "lineNumber": 217
          },
          {
            "text": "\t\t\tnodes: [",
            "lineNumber": 218
          },
          {
            "text": "\t\t\t\t{ id: \"src\", x: 0, y: 0, width: 100, height: 50, type: \"text\", text: \"\", color: \"1\" },",
            "lineNumber": 219
          },
          {
            "text": "\t\t\t\t{ id: \"out\", x: 0, y: 200, width: 100, height: 50, type: \"text\", text: \"\", color: \"5\" },",
            "lineNumber": 220
          },
          {
            "text": "\t\t\t],",
            "lineNumber": 221
          },
          {
            "text": "\t\t\tedges: [",
            "lineNumber": 222
          },
          {
            "text": "\t\t\t\t{ id: \"e1\", fromNode: \"src\", toNode: \"out\", label: EDGE_LABEL_OUTPUT },",
            "lineNumber": 223
          },
          {
            "text": "\t\t\t],",
            "lineNumber": 224
          },
          {
            "text": "\t\t};",
            "lineNumber": 225
          },
          {
            "text": "\t\texpect(findOutputNodeForSource(data, \"src\", settings)).toBe(\"out\");",
            "lineNumber": 226
          },
          {
            "text": "\t});",
            "lineNumber": 227
          },
          {
            "text": "});",
            "lineNumber": 228
          },
          {
            "lineNumber": 229
          },
          {
            "text": "describe(\"GREEN_NODE_PADDING\", () =&gt; {",
            "lineNumber": 230
          },
          {
            "text": "\tit",
            "lineNumber": 231
          },
          {
            "lineNumber": 233
          },
          {
            "text": "}",
            "lineNumber": 234
          }
        ]
      },
      "score": 0.2131853699684143
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 22,
            "column": 1
          },
          "endPosition": {
            "line": 298,
            "column": 1
          }
        },
        "contents": "/** Debug: set to true when canvas:node-menu callback has fired at least once (proves event is received). */\nlet debugNodeMenuFired = false;\n\nexport default class ZettelThinkingBoardPlugin extends Plugin {\n\tsettings: ZettelPluginSettings;\n\n\tasync onload() {\n\t\ttry {\n\t\t\tawait this.loadSettings();\n\t\t\tthis.addSettingTab(new ZettelSettingTab(this.app, this));\n\n\t\t\tthis.registerView(\n\t\t\t\tZETTEL_CONTROLS_VIEW_TYPE,\n\t\t\t\t(leaf: WorkspaceLeaf) =&gt; new ZettelControlsView(leaf, this)\n\t\t\t);\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"open-zettel-controls\",\n\t\t\t\tname: \"Open Zettel Controls\",\n\t\t\t\tcallback: () =&gt; this.activateZettelControls(),\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"run-node\",\n\t\t\t\tname: \"Run node\",\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\t\tif (!view) return false;\n\t\t\t\t\tif (checking) return true;\n\t\t\t\t\t// Command palette: no node selected; prompt user to use context menu\n\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Run node\\\" to run it.\");\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"run-chain\",\n\t\t\t\tname: \"Run chain\",\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\t\tif (!view) return false;\n\t\t\t\t\tif (checking) return true;\n\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Run chain\\\" to run from roots.\");\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"dismiss-output\",\n\t\t\t\tname: \"Dismiss output\",\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\t\tif (!view) return false;\n\t\t\t\t\tif (checking) return true;\n\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Dismiss output\\\" to remove its output.\");\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\t// Canvas node context menu (event name is undocumented; try workspace.on(\"canvas:node-menu\")).\n\t}\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Debug: set to true when canvas:node-menu callback has fired at least once (proves event is received). */",
            "lineNumber": 25
          },
          {
            "text": "let debugNodeMenuFired = false;",
            "lineNumber": 26
          },
          {
            "lineNumber": 27
          },
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 28,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings;",
            "lineNumber": 29
          },
          {
            "lineNumber": 30
          },
          {
            "text": "\tasync onload() {",
            "lineNumber": 31
          },
          {
            "text": "\t\ttry {",
            "lineNumber": 32
          },
          {
            "text": "\t\t\tawait this.loadSettings();",
            "lineNumber": 33
          },
          {
            "text": "\t\t\tthis.addSettingTab(new ZettelSettingTab(this.app, this));",
            "lineNumber": 34
          },
          {
            "lineNumber": 35
          },
          {
            "text": "\t\t\tthis.registerView(",
            "lineNumber": 36
          },
          {
            "text": "\t\t\t\tZETTEL_CONTROLS_VIEW_TYPE,",
            "lineNumber": 37
          },
          {
            "text": "\t\t\t\t(leaf: WorkspaceLeaf) =&gt; new ZettelControlsView(leaf, this)",
            "lineNumber": 38
          },
          {
            "text": "\t\t\t);",
            "lineNumber": 39
          },
          {
            "lineNumber": 40
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 41
          },
          {
            "text": "\t\t\t\tid: \"open-zettel-controls\",",
            "lineNumber": 42
          },
          {
            "text": "\t\t\t\tname: \"Open Zettel Controls\",",
            "lineNumber": 43
          },
          {
            "text": "\t\t\t\tcallback: () =&gt; this.activateZettelControls(),",
            "lineNumber": 44
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 45
          },
          {
            "lineNumber": 46
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 47
          },
          {
            "text": "\t\t\t\tid: \"run-node\",",
            "lineNumber": 48
          },
          {
            "text": "\t\t\t\tname: \"Run node\",",
            "lineNumber": 49
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 50
          },
          {
            "text": "\t\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 51
          },
          {
            "text": "\t\t\t\t\tif (!view) return false;",
            "lineNumber": 52
          },
          {
            "text": "\t\t\t\t\tif (checking) return true;",
            "lineNumber": 53
          },
          {
            "text": "\t\t\t\t\t// Command palette: no node selected; prompt user to use context menu",
            "lineNumber": 54
          },
          {
            "text": "\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Run node\\\" to run it.\");",
            "lineNumber": 55
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 56
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 57
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 58
          },
          {
            "lineNumber": 59
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 60
          },
          {
            "text": "\t\t\t\tid: \"run-chain\",",
            "lineNumber": 61
          },
          {
            "text": "\t\t\t\tname: \"Run chain\",",
            "lineNumber": 62
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 63
          },
          {
            "text": "\t\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 64
          },
          {
            "text": "\t\t\t\t\tif (!view) return false;",
            "lineNumber": 65
          },
          {
            "text": "\t\t\t\t\tif (checking) return true;",
            "lineNumber": 66
          },
          {
            "text": "\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Run chain\\\" to run from roots.\");",
            "lineNumber": 67
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 68
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 69
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 70
          },
          {
            "lineNumber": 71
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 72
          },
          {
            "text": "\t\t\t\tid: \"dismiss-output\",",
            "lineNumber": 73
          },
          {
            "text": "\t\t\t\tname: \"Dismiss output\",",
            "lineNumber": 74
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 75
          },
          {
            "text": "\t\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 76
          },
          {
            "text": "\t\t\t\t\tif (!view) return false;",
            "lineNumber": 77
          },
          {
            "text": "\t\t\t\t\tif (checking) return true;",
            "lineNumber": 78
          },
          {
            "text": "\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Dismiss output\\\" to remove its output.\");",
            "lineNumber": 79
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 80
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 81
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 82
          },
          {
            "lineNumber": 83
          },
          {
            "text": "\t\t\t// Canvas node context menu (event name is undocumented; try workspace.on(\"canvas:node-menu\")).",
            "lineNumber": 84
          },
          {
            "text": "\t}",
            "lineNumber": 196
          },
          {
            "text": "}",
            "lineNumber": 299,
            "isSignature": true
          }
        ]
      },
      "score": 0.20742124319076538
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/canvasNodeLabels.ts",
        "range": {
          "startPosition": {
            "line": 168
          },
          "endPosition": {
            "line": 230,
            "column": 1
          }
        },
        "contents": "function getElCenter(el: HTMLElement): { x: number; y: number } {\n\n\treturn { x: r.left + r.width / 2, y: r.top + r.height / 2 };\n}\n\n/**\n * Sync floating edge mode labels: for each edge with a mode (inject/concatenate) or incoming to the running node,\n * show a small label with colored icon + text at the edge midpoint.\n */\nexport async function syncCanvasEdgeModeLabels(\n\tvault: Vault,\n\tcanvasFilePath: string,\n\tcontainerEl: HTMLElement,\n\tcanvas: LiveCanvas | null\n): Promise&lt;void&gt; {\n\tclearCanvasEdgeModeLabels(containerEl);\n\tconst data = await loadCanvasData(vault, canvasFilePath);\n\tif (!data?.edges) return;\n\tconst canvasKey = getCanvasKey(canvasFilePath);\n\tconst runningNodeId = getRunningNodeId(canvasKey);\n\tconst containerRect = containerEl.getBoundingClientRect();\n\tfor (const edge of data.edges) {\n\t\tif (isOutputEdge(edge)) continue;\n\t\tconst isRunning = runningNodeId != null &amp;&amp; edge.toNode === runningNodeId;\n\t\tconst mode = getEdgeMode(canvasKey, edge.id);\n\t\tconst state: EdgeDisplayState | null = isRunning\n\t\t\t? \"running\"\n\t\t\t: mode === \"inject\"\n\t\t\t\t? \"inject\"\n\t\t\t\t: mode === \"concatenate\"\n\t\t\t\t\t? \"concatenate\"\n\t\t\t\t\t: null;\n\t\tif (!state) continue;\n\t\tconst fromEl =\n\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, edge.fromNode)) ||\n\t\t\tfindNodeElementByDataId(containerEl, edge.fromNode);\n\t\tconst toEl =\n\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, edge.toNode)) ||\n\t\t\tfindNodeElementByDataId(containerEl, edge.toNode);\n\t\tif (!fromEl || !toEl) continue;\n\t\tconst fromCenter = getElCenter(fromEl);\n\t\tconst toCenter = getElCenter(toEl);\n\t\tconst midX = (fromCenter.x + toCenter.x) / 2 - containerRect.left + containerEl.scrollLeft;\n\t\tconst midY = (fromCenter.y + toCenter.y) / 2 - containerRect.top + containerEl.scrollTop;\n\t\tconst label = document.createElement(\"div\");\n\t\tlabel.setAttribute(\"class\", EDGE_MODE_LABEL_CLASS);\n\t\tlabel.setAttribute(EDGE_MODE_DATA_ATTR, edge.id);\n\t\tlabel.setAttribute(EDGE_MODE_STATE_ATTR, state);\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "function getElCenter(el: HTMLElement): { x: number; y: number } {",
            "lineNumber": 169,
            "isSignature": true
          },
          {
            "lineNumber": 170
          },
          {
            "text": "\treturn { x: r.left + r.width / 2, y: r.top + r.height / 2 };",
            "lineNumber": 171
          },
          {
            "text": "}",
            "lineNumber": 172,
            "isSignature": true
          },
          {
            "lineNumber": 173
          },
          {
            "text": "/**",
            "lineNumber": 174
          },
          {
            "text": " * Sync floating edge mode labels: for each edge with a mode (inject/concatenate) or incoming to the running node,",
            "lineNumber": 175
          },
          {
            "text": " * show a small label with colored icon + text at the edge midpoint.",
            "lineNumber": 176
          },
          {
            "text": " */",
            "lineNumber": 177
          },
          {
            "text": "export async function syncCanvasEdgeModeLabels(",
            "lineNumber": 178,
            "isSignature": true
          },
          {
            "text": "\tvault: Vault,",
            "lineNumber": 179,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 180,
            "isSignature": true
          },
          {
            "text": "\tcontainerEl: HTMLElement,",
            "lineNumber": 181,
            "isSignature": true
          },
          {
            "text": "\tcanvas: LiveCanvas | null",
            "lineNumber": 182,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;void&gt; {",
            "lineNumber": 183,
            "isSignature": true
          },
          {
            "text": "\tclearCanvasEdgeModeLabels(containerEl);",
            "lineNumber": 184
          },
          {
            "text": "\tconst data = await loadCanvasData(vault, canvasFilePath);",
            "lineNumber": 185
          },
          {
            "text": "\tif (!data?.edges) return;",
            "lineNumber": 186
          },
          {
            "text": "\tconst canvasKey = getCanvasKey(canvasFilePath);",
            "lineNumber": 187
          },
          {
            "text": "\tconst runningNodeId = getRunningNodeId(canvasKey);",
            "lineNumber": 188
          },
          {
            "text": "\tconst containerRect = containerEl.getBoundingClientRect();",
            "lineNumber": 189
          },
          {
            "text": "\tfor (const edge of data.edges) {",
            "lineNumber": 190
          },
          {
            "text": "\t\tif (isOutputEdge(edge)) continue;",
            "lineNumber": 191
          },
          {
            "text": "\t\tconst isRunning = runningNodeId != null &amp;&amp; edge.toNode === runningNodeId;",
            "lineNumber": 192
          },
          {
            "text": "\t\tconst mode = getEdgeMode(canvasKey, edge.id);",
            "lineNumber": 193
          },
          {
            "text": "\t\tconst state: EdgeDisplayState | null = isRunning",
            "lineNumber": 194
          },
          {
            "text": "\t\t\t? \"running\"",
            "lineNumber": 195
          },
          {
            "text": "\t\t\t: mode === \"inject\"",
            "lineNumber": 196
          },
          {
            "text": "\t\t\t\t? \"inject\"",
            "lineNumber": 197
          },
          {
            "text": "\t\t\t\t: mode === \"concatenate\"",
            "lineNumber": 198
          },
          {
            "text": "\t\t\t\t\t? \"concatenate\"",
            "lineNumber": 199
          },
          {
            "text": "\t\t\t\t\t: null;",
            "lineNumber": 200
          },
          {
            "text": "\t\tif (!state) continue;",
            "lineNumber": 201
          },
          {
            "text": "\t\tconst fromEl =",
            "lineNumber": 202
          },
          {
            "text": "\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, edge.fromNode)) ||",
            "lineNumber": 203
          },
          {
            "text": "\t\t\tfindNodeElementByDataId(containerEl, edge.fromNode);",
            "lineNumber": 204
          },
          {
            "text": "\t\tconst toEl =",
            "lineNumber": 205
          },
          {
            "text": "\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, edge.toNode)) ||",
            "lineNumber": 206
          },
          {
            "text": "\t\t\tfindNodeElementByDataId(containerEl, edge.toNode);",
            "lineNumber": 207
          },
          {
            "text": "\t\tif (!fromEl || !toEl) continue;",
            "lineNumber": 208
          },
          {
            "text": "\t\tconst fromCenter = getElCenter(fromEl);",
            "lineNumber": 209
          },
          {
            "text": "\t\tconst toCenter = getElCenter(toEl);",
            "lineNumber": 210
          },
          {
            "text": "\t\tconst midX = (fromCenter.x + toCenter.x) / 2 - containerRect.left + containerEl.scrollLeft;",
            "lineNumber": 211
          },
          {
            "text": "\t\tconst midY = (fromCenter.y + toCenter.y) / 2 - containerRect.top + containerEl.scrollTop;",
            "lineNumber": 212
          },
          {
            "text": "\t\tconst label = document.createElement(\"div\");",
            "lineNumber": 213
          },
          {
            "text": "\t\tlabel.setAttribute(\"class\", EDGE_MODE_LABEL_CLASS);",
            "lineNumber": 214
          },
          {
            "text": "\t\tlabel.setAttribute(EDGE_MODE_DATA_ATTR, edge.id);",
            "lineNumber": 215
          },
          {
            "text": "\t\tlabel.setAttribute(EDGE_MODE_STATE_ATTR, state);",
            "lineNumber": 216
          },
          {
            "text": "}",
            "lineNumber": 231,
            "isSignature": true
          }
        ]
      },
      "score": 0.18836340308189392
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/state.ts",
        "range": {
          "startPosition": {
            "line": 25,
            "column": 1
          },
          "endPosition": {
            "line": 33,
            "column": 1
          }
        },
        "contents": "export function getNodeResult(canvasKey: string, nodeId: string): string | undefined {\n\treturn getCanvasState(canvasKey).get(nodeId);\n}\n\nexport function setNodeResult(canvasKey: string, nodeId: string, result: string): void {\n\t\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "export function getNodeResult(canvasKey: string, nodeId: string): string | undefined {",
            "lineNumber": 28,
            "isSignature": true
          },
          {
            "text": "\treturn getCanvasState(canvasKey).get(nodeId);",
            "lineNumber": 29
          },
          {
            "text": "}",
            "lineNumber": 30,
            "isSignature": true
          },
          {
            "lineNumber": 31
          },
          {
            "text": "export function setNodeResult(canvasKey: string, nodeId: string, result: string): void {",
            "lineNumber": 32,
            "isSignature": true
          },
          {
            "text": "\t",
            "lineNumber": 33
          },
          {
            "text": "}",
            "lineNumber": 34,
            "isSignature": true
          }
        ]
      },
      "score": 0.18771684169769287
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/types.ts",
        "range": {
          "startPosition": {
            "line": 113
          },
          "endPosition": {
            "line": 120,
            "column": 113
          }
        },
        "contents": "export function getFileNodePath(node: CanvasFileData): string {\n\n}\n\n/** Fixed padding between source node and its Green output node (Part 1). */\nexport const GREEN_NODE_PADDING = 20;\n\n/** Find the Green (output) node for a given source node. Edge-first (label \"output\"), then position fallback. */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "export function getFileNodePath(node: CanvasFileData): string {",
            "lineNumber": 114,
            "isSignature": true
          },
          {
            "lineNumber": 115
          },
          {
            "text": "}",
            "lineNumber": 116,
            "isSignature": true
          },
          {
            "lineNumber": 117
          },
          {
            "text": "/** Fixed padding between source node and its Green output node (Part 1). */",
            "lineNumber": 118
          },
          {
            "text": "export const GREEN_NODE_PADDING = 20;",
            "lineNumber": 119
          },
          {
            "lineNumber": 120
          },
          {
            "text": "/** Find the Green (output) node for a given source node. Edge-first (label \"output\"), then position fallback. */",
            "lineNumber": 121
          }
        ]
      },
      "score": 0.18455339968204498
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 27
          },
          "endPosition": {
            "line": 298,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\nasync onload() {\n\n\n\t\t\t// Canvas node context menu (event name is undocumented; try workspace.on(\"canvas:node-menu\")).\n\t\t\t// Defer registration so Obsidian canvas is ready (avoids \"reading '_'\" in app.js).\n\t\t\tconst addNodeMenuItems = (menu: Menu, node: unknown): void =&gt; {\n\t\t\t\tdebugNodeMenuFired = true;\n\t\t\t\tconst nodeId = resolveCanvasNodeId(node);\n\t\t\t\tif (!nodeId) return;\n\t\t\t\tmenu.addItem((item) =&gt;\n\t\t\t\t\titem.setTitle(\"Run node\").setIcon(\"play\").onClick(() =&gt; this.runNode(nodeId))\n\t\t\t\t);\n\t\t\t\tmenu.addItem((item) =&gt;\n\t\t\t\t\titem.setTitle(\"Run chain\").setIcon(\"forward\").onClick(() =&gt; this.runChain(nodeId))\n\t\t\t\t);\n\t\t\t\tmenu.addItem((item) =&gt;\n\t\t\t\t\titem.setTitle(\"Dismiss output\").setIcon(\"trash\").onClick(() =&gt; this.dismissOutput(nodeId))\n\t\t\t\t);\n\t\t\t};\n\t\t\tconst registerCanvasNodeMenu = () =&gt; {\n\t\t\t\ttry {\n\t\t\t\t\tconst on = this.app.workspace.on.bind(this.app.workspace) as (\n\t\t\t\t\t\tname: string,\n\t\t\t\t\t\tcallback: (menu: Menu, node: unknown) =&gt; void\n\t\t\t\t\t) =&gt; ReturnType&lt;typeof this.app.workspace.on&gt;;\n\t\t\t\t\t// Try documented-style event name first; some Obsidian builds use \"canvas:node-menu\".\n\t\t\t\t\tthis.registerEvent(on(\"canvas:node-menu\", addNodeMenuItems));\n\t\t\t\t\t// Fallback: try hyphenated name in case the app triggers a different event.\n\t\t\t\t\tthis.registerEvent(on(\"canvas-node-menu\", addNodeMenuItems));\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconsole.error(\"Zettel Thinking Board: could not register canvas node menu.\", e);\n\t\t\t\t}\n\t\t\t};\n\t\t\tconst timeoutId = window.setTimeout(registerCanvasNodeMenu, 0);\n\t\t\tthis.register(() =&gt; window.clearTimeout(timeoutId));\n\n\t\t\t// Debug: command to test if we can affect the canvas and if canvas:node-menu ever fires.\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 28,
                "column": 1
              },
              "endPosition": {
                "line": 28,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 28,
                "column": 16
              },
              "endPosition": {
                "line": 29,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 31,
                "column": 2
              },
              "endPosition": {
                "line": 32,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 28,
            "isSignature": true
          },
          {
            "text": "async onload() {",
            "lineNumber": 31
          },
          {
            "lineNumber": 82
          },
          {
            "lineNumber": 83
          },
          {
            "text": "\t\t\t// Canvas node context menu (event name is undocumented; try workspace.on(\"canvas:node-menu\")).",
            "lineNumber": 84
          },
          {
            "text": "\t\t\t// Defer registration so Obsidian canvas is ready (avoids \"reading '_'\" in app.js).",
            "lineNumber": 85
          },
          {
            "text": "\t\t\tconst addNodeMenuItems = (menu: Menu, node: unknown): void =&gt; {",
            "lineNumber": 86
          },
          {
            "text": "\t\t\t\tdebugNodeMenuFired = true;",
            "lineNumber": 87
          },
          {
            "text": "\t\t\t\tconst nodeId = resolveCanvasNodeId(node);",
            "lineNumber": 88
          },
          {
            "text": "\t\t\t\tif (!nodeId) return;",
            "lineNumber": 89
          },
          {
            "text": "\t\t\t\tmenu.addItem((item) =&gt;",
            "lineNumber": 90
          },
          {
            "text": "\t\t\t\t\titem.setTitle(\"Run node\").setIcon(\"play\").onClick(() =&gt; this.runNode(nodeId))",
            "lineNumber": 91
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 92
          },
          {
            "text": "\t\t\t\tmenu.addItem((item) =&gt;",
            "lineNumber": 93
          },
          {
            "text": "\t\t\t\t\titem.setTitle(\"Run chain\").setIcon(\"forward\").onClick(() =&gt; this.runChain(nodeId))",
            "lineNumber": 94
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 95
          },
          {
            "text": "\t\t\t\tmenu.addItem((item) =&gt;",
            "lineNumber": 96
          },
          {
            "text": "\t\t\t\t\titem.setTitle(\"Dismiss output\").setIcon(\"trash\").onClick(() =&gt; this.dismissOutput(nodeId))",
            "lineNumber": 97
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 98
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 99
          },
          {
            "text": "\t\t\tconst registerCanvasNodeMenu = () =&gt; {",
            "lineNumber": 100
          },
          {
            "text": "\t\t\t\ttry {",
            "lineNumber": 101
          },
          {
            "text": "\t\t\t\t\tconst on = this.app.workspace.on.bind(this.app.workspace) as (",
            "lineNumber": 102
          },
          {
            "text": "\t\t\t\t\t\tname: string,",
            "lineNumber": 103
          },
          {
            "text": "\t\t\t\t\t\tcallback: (menu: Menu, node: unknown) =&gt; void",
            "lineNumber": 104
          },
          {
            "text": "\t\t\t\t\t) =&gt; ReturnType&lt;typeof this.app.workspace.on&gt;;",
            "lineNumber": 105
          },
          {
            "text": "\t\t\t\t\t// Try documented-style event name first; some Obsidian builds use \"canvas:node-menu\".",
            "lineNumber": 106
          },
          {
            "text": "\t\t\t\t\tthis.registerEvent(on(\"canvas:node-menu\", addNodeMenuItems));",
            "lineNumber": 107
          },
          {
            "text": "\t\t\t\t\t// Fallback: try hyphenated name in case the app triggers a different event.",
            "lineNumber": 108
          },
          {
            "text": "\t\t\t\t\tthis.registerEvent(on(\"canvas-node-menu\", addNodeMenuItems));",
            "lineNumber": 109
          },
          {
            "text": "\t\t\t\t} catch (e) {",
            "lineNumber": 110
          },
          {
            "text": "\t\t\t\t\tconsole.error(\"Zettel Thinking Board: could not register canvas node menu.\", e);",
            "lineNumber": 111
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 112
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 113
          },
          {
            "text": "\t\t\tconst timeoutId = window.setTimeout(registerCanvasNodeMenu, 0);",
            "lineNumber": 114
          },
          {
            "text": "\t\t\tthis.register(() =&gt; window.clearTimeout(timeoutId));",
            "lineNumber": 115
          },
          {
            "lineNumber": 116
          },
          {
            "text": "\t\t\t// Debug: command to test if we can affect the canvas and if canvas:node-menu ever fires.",
            "lineNumber": 117
          },
          {
            "text": "\t}",
            "lineNumber": 196
          },
          {
            "text": "}",
            "lineNumber": 299,
            "isSignature": true
          }
        ]
      },
      "score": 0.18255746364593506
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 37,
            "column": 1
          }
        },
        "contents": "import type {App} from \"obsidian\";\nimport {\n\tEDGE_LABEL_OUTPUT,\n\tfindOutputNodeForSource,\n\tgetNodeById,\n\tgetNodeContent,\n\tgetNodeRole,\n\tgetIncomingEdgesWithLabels,\n\tgetParentIdsSortedByY,\n\tGREEN_NODE_PADDING,\n\tisOutputEdge,\n\tloadCanvasData,\n\tsaveCanvasData,\n} from \"../canvas/nodes\";\nimport type {AllCanvasNodeData, CanvasData, CanvasEdgeData, CanvasTextData} from \"../canvas/types\";\nimport { parseEdgeVariableName } from \"../canvas/types\";\nimport {isTextNode} from \"../canvas/types\";\nimport type {LiveCanvas} from \"./canvasApi\";\nimport {getKernelForCanvas} from \"./kernelManager\";\nimport {ollamaGenerate} from \"./ollama\";\nimport {\n\tgetCanvasKey,\n\tgetNodeResult,\n\tsetNodeResult,\n\tsetEdgeModes,\n\tsetRunningNodeId,\n} from \"./state\";\nimport type {ZettelPluginSettings} from \"../settings\";\n\ntype EdgeInputMode = \"inject\" | \"concatenate\";\n\n/** Get all root node ids (no incoming non-output edges). */\nfunction getRootIds(data: CanvasData): string[] {\n\tconst hasIncoming = new Set\n;\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "import type {App} from \"obsidian\";",
            "lineNumber": 1
          },
          {
            "text": "import {",
            "lineNumber": 2
          },
          {
            "text": "\tEDGE_LABEL_OUTPUT,",
            "lineNumber": 3
          },
          {
            "text": "\tfindOutputNodeForSource,",
            "lineNumber": 4
          },
          {
            "text": "\tgetNodeById,",
            "lineNumber": 5
          },
          {
            "text": "\tgetNodeContent,",
            "lineNumber": 6
          },
          {
            "text": "\tgetNodeRole,",
            "lineNumber": 7
          },
          {
            "text": "\tgetIncomingEdgesWithLabels,",
            "lineNumber": 8
          },
          {
            "text": "\tgetParentIdsSortedByY,",
            "lineNumber": 9
          },
          {
            "text": "\tGREEN_NODE_PADDING,",
            "lineNumber": 10
          },
          {
            "text": "\tisOutputEdge,",
            "lineNumber": 11
          },
          {
            "text": "\tloadCanvasData,",
            "lineNumber": 12
          },
          {
            "text": "\tsaveCanvasData,",
            "lineNumber": 13
          },
          {
            "text": "} from \"../canvas/nodes\";",
            "lineNumber": 14
          },
          {
            "text": "import type {AllCanvasNodeData, CanvasData, CanvasEdgeData, CanvasTextData} from \"../canvas/types\";",
            "lineNumber": 15
          },
          {
            "text": "import { parseEdgeVariableName } from \"../canvas/types\";",
            "lineNumber": 16
          },
          {
            "text": "import {isTextNode} from \"../canvas/types\";",
            "lineNumber": 17
          },
          {
            "text": "import type {LiveCanvas} from \"./canvasApi\";",
            "lineNumber": 18
          },
          {
            "text": "import {getKernelForCanvas} from \"./kernelManager\";",
            "lineNumber": 19
          },
          {
            "text": "import {ollamaGenerate} from \"./ollama\";",
            "lineNumber": 20
          },
          {
            "text": "import {",
            "lineNumber": 21
          },
          {
            "text": "\tgetCanvasKey,",
            "lineNumber": 22
          },
          {
            "text": "\tgetNodeResult,",
            "lineNumber": 23
          },
          {
            "text": "\tsetNodeResult,",
            "lineNumber": 24
          },
          {
            "text": "\tsetEdgeModes,",
            "lineNumber": 25
          },
          {
            "text": "\tsetRunningNodeId,",
            "lineNumber": 26
          },
          {
            "text": "} from \"./state\";",
            "lineNumber": 27
          },
          {
            "text": "import type {ZettelPluginSettings} from \"../settings\";",
            "lineNumber": 28
          },
          {
            "lineNumber": 29
          },
          {
            "text": "type EdgeInputMode = \"inject\" | \"concatenate\";",
            "lineNumber": 30,
            "isSignature": true
          },
          {
            "lineNumber": 31
          },
          {
            "text": "/** Get all root node ids (no incoming non-output edges). */",
            "lineNumber": 32
          },
          {
            "text": "function getRootIds(data: CanvasData): string[] {",
            "lineNumber": 33,
            "isSignature": true
          },
          {
            "text": "\tconst hasIncoming = new Set",
            "lineNumber": 34
          },
          {
            "text": ";",
            "lineNumber": 36
          },
          {
            "text": "}",
            "lineNumber": 38,
            "isSignature": true
          }
        ]
      },
      "score": 0.17969879508018494
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 317
          },
          "endPosition": {
            "line": 365,
            "column": 1
          }
        },
        "contents": "export async function runChain(\n\tapp: App,\n\tsettings: ZettelPluginSettings,\n\tcanvasFilePath: string,\n\tnodeId: string,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;{ ok: boolean; message?: string }&gt; {\n;\n\t\t\t} finally {\n\t\t\t\tsetRunningNodeId(canvasKey, null);\n\t\t\t}\n\t\t}\n\t\treturn { ok: true };\n\t} catch (e) {\n\t\treturn { ok: false, message: e instanceof Error ? e.message : String(e) };\n\t}\n}\n\n/** Remove the Green output node and its output edge for a given source node; mutates data and saves. */\nexport async function dismissOutput(\n\tvault: App[\"vault\"],\n\tcanvasFilePath: string,\n\tsourceNodeId: string,\n\tsettings: ZettelPluginSettings,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;void&gt; {\n\tconst data = await loadCanvasData(vault, canvasFilePath);\n\tif (!data) return;\n\tconst outId = findOutputNodeForSource(data, sourceNodeId, settings);\n\tif (!outId) return;\n\tdata.nodes = data.nodes.filter((n) =&gt; n.id !== outId);\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "export async function runChain(",
            "lineNumber": 318,
            "isSignature": true
          },
          {
            "text": "\tapp: App,",
            "lineNumber": 319,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 320,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 321,
            "isSignature": true
          },
          {
            "text": "\tnodeId: string,",
            "lineNumber": 322,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 323,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;{ ok: boolean; message?: string }&gt; {",
            "lineNumber": 324,
            "isSignature": true
          },
          {
            "text": ";",
            "lineNumber": 336
          },
          {
            "text": "\t\t\t} finally {",
            "lineNumber": 337
          },
          {
            "text": "\t\t\t\tsetRunningNodeId(canvasKey, null);",
            "lineNumber": 338
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 339
          },
          {
            "text": "\t\t}",
            "lineNumber": 340
          },
          {
            "text": "\t\treturn { ok: true };",
            "lineNumber": 341
          },
          {
            "text": "\t} catch (e) {",
            "lineNumber": 342
          },
          {
            "text": "\t\treturn { ok: false, message: e instanceof Error ? e.message : String(e) };",
            "lineNumber": 343
          },
          {
            "text": "\t}",
            "lineNumber": 344
          },
          {
            "text": "}",
            "lineNumber": 345,
            "isSignature": true
          },
          {
            "lineNumber": 346
          },
          {
            "text": "/** Remove the Green output node and its output edge for a given source node; mutates data and saves. */",
            "lineNumber": 347
          },
          {
            "text": "export async function dismissOutput(",
            "lineNumber": 348,
            "isSignature": true
          },
          {
            "text": "\tvault: App[\"vault\"],",
            "lineNumber": 349,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 350,
            "isSignature": true
          },
          {
            "text": "\tsourceNodeId: string,",
            "lineNumber": 351,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 352,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 353,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;void&gt; {",
            "lineNumber": 354,
            "isSignature": true
          },
          {
            "text": "\tconst data = await loadCanvasData(vault, canvasFilePath);",
            "lineNumber": 355
          },
          {
            "text": "\tif (!data) return;",
            "lineNumber": 356
          },
          {
            "text": "\tconst outId = findOutputNodeForSource(data, sourceNodeId, settings);",
            "lineNumber": 357
          },
          {
            "text": "\tif (!outId) return;",
            "lineNumber": 358
          },
          {
            "text": "\tdata.nodes = data.nodes.filter((n) =&gt; n.id !== outId);",
            "lineNumber": 359
          },
          {
            "text": "}",
            "lineNumber": 366,
            "isSignature": true
          }
        ]
      },
      "score": 0.17456179857254028
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/types.ts",
        "range": {
          "startPosition": {
            "line": 75,
            "column": 1
          },
          "endPosition": {
            "line": 95,
            "column": 1
          }
        },
        "contents": "/** Get parent node IDs for a node, sorted by y (top to bottom). Excludes output edges. */\nexport function getParentIdsSortedByY(nodeId: string, data: CanvasData): string[] {\n\tconst edges = data.edges.filter((e) =&gt; e.toNode === nodeId &amp;&amp; !isOutputEdge(e));\n\tconst fromIds = [...new Set(edges.map((e) =&gt; e.fromNode))];\n\tconst nodeMap = new Map(data.nodes.map((n) =&gt; [n.id, n]));\n\tconst withY = fromIds\n\t\t.map((id) =&gt; {\n\t\t\tconst node = nodeMap.get(id);\n\t\t\treturn node ? { id, y: node.y } : null;\n\t\t})\n\t\t.filter((x): x is { id: string; y: number } =&gt; x != null);\n\twithY.sort((a, b) =&gt; a.y - b.y);\n\treturn withY.map((x) =&gt; x.id);\n}\n\n/** Get node by id from canvas data. */\nexport function getNodeById(data: CanvasData, id: string): AllCanvasNodeData | undefined {\n\t\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Get parent node IDs for a node, sorted by y (top to bottom). Excludes output edges. */",
            "lineNumber": 78
          },
          {
            "text": "export function getParentIdsSortedByY(nodeId: string, data: CanvasData): string[] {",
            "lineNumber": 79,
            "isSignature": true
          },
          {
            "text": "\tconst edges = data.edges.filter((e) =&gt; e.toNode === nodeId &amp;&amp; !isOutputEdge(e));",
            "lineNumber": 80
          },
          {
            "text": "\tconst fromIds = [...new Set(edges.map((e) =&gt; e.fromNode))];",
            "lineNumber": 81
          },
          {
            "text": "\tconst nodeMap = new Map(data.nodes.map((n) =&gt; [n.id, n]));",
            "lineNumber": 82
          },
          {
            "text": "\tconst withY = fromIds",
            "lineNumber": 83
          },
          {
            "text": "\t\t.map((id) =&gt; {",
            "lineNumber": 84
          },
          {
            "text": "\t\t\tconst node = nodeMap.get(id);",
            "lineNumber": 85
          },
          {
            "text": "\t\t\treturn node ? { id, y: node.y } : null;",
            "lineNumber": 86
          },
          {
            "text": "\t\t})",
            "lineNumber": 87
          },
          {
            "text": "\t\t.filter((x): x is { id: string; y: number } =&gt; x != null);",
            "lineNumber": 88
          },
          {
            "text": "\twithY.sort((a, b) =&gt; a.y - b.y);",
            "lineNumber": 89
          },
          {
            "text": "\treturn withY.map((x) =&gt; x.id);",
            "lineNumber": 90
          },
          {
            "text": "}",
            "lineNumber": 91,
            "isSignature": true
          },
          {
            "lineNumber": 92
          },
          {
            "text": "/** Get node by id from canvas data. */",
            "lineNumber": 93
          },
          {
            "text": "export function getNodeById(data: CanvasData, id: string): AllCanvasNodeData | undefined {",
            "lineNumber": 94,
            "isSignature": true
          },
          {
            "text": "\t",
            "lineNumber": 95
          },
          {
            "text": "}",
            "lineNumber": 96,
            "isSignature": true
          }
        ]
      },
      "score": 0.1739368438720703
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/state.ts",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 16,
            "column": 1
          }
        },
        "contents": "/** Per-canvas state: NodeID -&gt; last output result string. */\nconst canvasState = new Map&lt;string, Map&lt;string, string&gt;&gt;();\n\n/** Per-canvas edge mode: EdgeID -&gt; \"inject\" | \"concatenate\" (shown in floating label under edge). */\nconst edgeModeState = new Map&lt;string, Map&lt;string, \"inject\" | \"concatenate\"&gt;&gt;();\n\n/** Node currently running (waiting for AI/kernel) per canvas; used to show \"running\" on incoming edges. */\nconst runningNodeState = new Map&lt;string, string | null&gt;();\n\nfunction getCanvasState(canvasKey: string): Map&lt;string, string&gt; {\n\tlet map = canvasState.get(canvasKey);\n\tif (!map) {\n\t\tmap = new Map();\n\t\tcanvasState.set(canvasKey, map);\n\t}\n\treturn map;\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Per-canvas state: NodeID -&gt; last output result string. */",
            "lineNumber": 1
          },
          {
            "text": "const canvasState = new Map&lt;string, Map&lt;string, string&gt;&gt;();",
            "lineNumber": 2
          },
          {
            "lineNumber": 3
          },
          {
            "text": "/** Per-canvas edge mode: EdgeID -&gt; \"inject\" | \"concatenate\" (shown in floating label under edge). */",
            "lineNumber": 4
          },
          {
            "text": "const edgeModeState = new Map&lt;string, Map&lt;string, \"inject\" | \"concatenate\"&gt;&gt;();",
            "lineNumber": 5
          },
          {
            "lineNumber": 6
          },
          {
            "text": "/** Node currently running (waiting for AI/kernel) per canvas; used to show \"running\" on incoming edges. */",
            "lineNumber": 7
          },
          {
            "text": "const runningNodeState = new Map&lt;string, string | null&gt;();",
            "lineNumber": 8
          },
          {
            "lineNumber": 9
          },
          {
            "text": "function getCanvasState(canvasKey: string): Map&lt;string, string&gt; {",
            "lineNumber": 10,
            "isSignature": true
          },
          {
            "text": "\tlet map = canvasState.get(canvasKey);",
            "lineNumber": 11
          },
          {
            "text": "\tif (!map) {",
            "lineNumber": 12
          },
          {
            "text": "\t\tmap = new Map();",
            "lineNumber": 13
          },
          {
            "text": "\t\tcanvasState.set(canvasKey, map);",
            "lineNumber": 14
          },
          {
            "text": "\t}",
            "lineNumber": 15
          },
          {
            "text": "\treturn map;",
            "lineNumber": 16
          },
          {
            "text": "}",
            "lineNumber": 17,
            "isSignature": true
          }
        ]
      },
      "score": 0.16896450519561768
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/canvasNodeLabels.ts",
        "range": {
          "startPosition": {
            "line": 120
          },
          "endPosition": {
            "line": 165,
            "column": 1
          }
        },
        "contents": "function createLabelEl(text: string): HTMLElement {\n\n\tel.setAttribute(LABEL_DATA_ATTR, \"1\");\n\tel.textContent = text;\n\treturn el;\n}\n\n/**\n * Sync floating role labels for the active canvas: for each node whose color maps to a role,\n * add a small label above the node (e.g. \"Comment\", \"Python\"). Removes existing labels first.\n * Uses the live canvas node map to find each node's DOM element (.canvas-node).\n */\nexport async function syncCanvasRoleLabels(\n\tvault: Vault,\n\tcanvasFilePath: string,\n\tcontainerEl: HTMLElement,\n\tsettings: ZettelPluginSettings,\n\tcanvas: LiveCanvas | null\n): Promise&lt;void&gt; {\n\tif (!settings.showNodeRoleLabels) {\n\t\tclearCanvasRoleLabels(containerEl);\n\t\tclearCanvasLegend(containerEl);\n\t\treturn;\n\t}\n\tconst data = await loadCanvasData(vault, canvasFilePath);\n\tif (!data?.nodes) {\n\t\tclearCanvasRoleLabels(containerEl);\n\t\tclearCanvasLegend(containerEl);\n\t\treturn;\n\t}\n\tclearCanvasRoleLabels(containerEl);\n\tsyncCanvasLegend(containerEl, settings);\n\tfor (const node of data.nodes) {\n\t\tconst role = getNodeRole(node, settings);\n\t\tif (!role) continue;\n\t\tconst labelText = getRoleLabel(role, settings);\n\t\tconst nodeEl =\n\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, node.id)) ||\n\t\t\tfindNodeElementByDataId(containerEl, node.id);\n\t\tif (!nodeEl) continue;\n\t\tconst label = createLabelEl(labelText);\n\t\t// Append after .canvas-node-container so it matches Obsidian file node label position\n\t\tnodeEl.append(label);\n\t}\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "function createLabelEl(text: string): HTMLElement {",
            "lineNumber": 121,
            "isSignature": true
          },
          {
            "lineNumber": 123
          },
          {
            "text": "\tel.setAttribute(LABEL_DATA_ATTR, \"1\");",
            "lineNumber": 124
          },
          {
            "text": "\tel.textContent = text;",
            "lineNumber": 125
          },
          {
            "text": "\treturn el;",
            "lineNumber": 126
          },
          {
            "text": "}",
            "lineNumber": 127,
            "isSignature": true
          },
          {
            "lineNumber": 128
          },
          {
            "text": "/**",
            "lineNumber": 129
          },
          {
            "text": " * Sync floating role labels for the active canvas: for each node whose color maps to a role,",
            "lineNumber": 130
          },
          {
            "text": " * add a small label above the node (e.g. \"Comment\", \"Python\"). Removes existing labels first.",
            "lineNumber": 131
          },
          {
            "text": " * Uses the live canvas node map to find each node's DOM element (.canvas-node).",
            "lineNumber": 132
          },
          {
            "text": " */",
            "lineNumber": 133
          },
          {
            "text": "export async function syncCanvasRoleLabels(",
            "lineNumber": 134,
            "isSignature": true
          },
          {
            "text": "\tvault: Vault,",
            "lineNumber": 135,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 136,
            "isSignature": true
          },
          {
            "text": "\tcontainerEl: HTMLElement,",
            "lineNumber": 137,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 138,
            "isSignature": true
          },
          {
            "text": "\tcanvas: LiveCanvas | null",
            "lineNumber": 139,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;void&gt; {",
            "lineNumber": 140,
            "isSignature": true
          },
          {
            "text": "\tif (!settings.showNodeRoleLabels) {",
            "lineNumber": 141
          },
          {
            "text": "\t\tclearCanvasRoleLabels(containerEl);",
            "lineNumber": 142
          },
          {
            "text": "\t\tclearCanvasLegend(containerEl);",
            "lineNumber": 143
          },
          {
            "text": "\t\treturn;",
            "lineNumber": 144
          },
          {
            "text": "\t}",
            "lineNumber": 145
          },
          {
            "text": "\tconst data = await loadCanvasData(vault, canvasFilePath);",
            "lineNumber": 146
          },
          {
            "text": "\tif (!data?.nodes) {",
            "lineNumber": 147
          },
          {
            "text": "\t\tclearCanvasRoleLabels(containerEl);",
            "lineNumber": 148
          },
          {
            "text": "\t\tclearCanvasLegend(containerEl);",
            "lineNumber": 149
          },
          {
            "text": "\t\treturn;",
            "lineNumber": 150
          },
          {
            "text": "\t}",
            "lineNumber": 151
          },
          {
            "text": "\tclearCanvasRoleLabels(containerEl);",
            "lineNumber": 152
          },
          {
            "text": "\tsyncCanvasLegend(containerEl, settings);",
            "lineNumber": 153
          },
          {
            "text": "\tfor (const node of data.nodes) {",
            "lineNumber": 154
          },
          {
            "text": "\t\tconst role = getNodeRole(node, settings);",
            "lineNumber": 155
          },
          {
            "text": "\t\tif (!role) continue;",
            "lineNumber": 156
          },
          {
            "text": "\t\tconst labelText = getRoleLabel(role, settings);",
            "lineNumber": 157
          },
          {
            "text": "\t\tconst nodeEl =",
            "lineNumber": 158
          },
          {
            "text": "\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, node.id)) ||",
            "lineNumber": 159
          },
          {
            "text": "\t\t\tfindNodeElementByDataId(containerEl, node.id);",
            "lineNumber": 160
          },
          {
            "text": "\t\tif (!nodeEl) continue;",
            "lineNumber": 161
          },
          {
            "text": "\t\tconst label = createLabelEl(labelText);",
            "lineNumber": 162
          },
          {
            "text": "\t\t// Append after .canvas-node-container so it matches Obsidian file node label position",
            "lineNumber": 163
          },
          {
            "text": "\t\tnodeEl.append(label);",
            "lineNumber": 164
          },
          {
            "text": "\t}",
            "lineNumber": 165
          },
          {
            "text": "}",
            "lineNumber": 166,
            "isSignature": true
          }
        ]
      },
      "score": 0.1686728596687317
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/state.ts",
        "range": {
          "startPosition": {
            "line": 18
          },
          "endPosition": {
            "line": 29,
            "column": 1
          }
        },
        "contents": "function getEdgeModeState(canvasKey: string): Map&lt;string, \"inject\" | \"concatenate\"&gt; {\n {\n\t\tmap = new Map();\n\t\tedgeModeState.set(canvasKey, map);\n\t}\n\treturn map;\n}\n\nexport function getNodeResult(canvasKey: string, nodeId: string): string | undefined {\n\t\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "function getEdgeModeState(canvasKey: string): Map&lt;string, \"inject\" | \"concatenate\"&gt; {",
            "lineNumber": 19,
            "isSignature": true
          },
          {
            "text": " {",
            "lineNumber": 21
          },
          {
            "text": "\t\tmap = new Map();",
            "lineNumber": 22
          },
          {
            "text": "\t\tedgeModeState.set(canvasKey, map);",
            "lineNumber": 23
          },
          {
            "text": "\t}",
            "lineNumber": 24
          },
          {
            "text": "\treturn map;",
            "lineNumber": 25
          },
          {
            "text": "}",
            "lineNumber": 26,
            "isSignature": true
          },
          {
            "lineNumber": 27
          },
          {
            "text": "export function getNodeResult(canvasKey: string, nodeId: string): string | undefined {",
            "lineNumber": 28,
            "isSignature": true
          },
          {
            "text": "\t",
            "lineNumber": 29
          },
          {
            "text": "}",
            "lineNumber": 30,
            "isSignature": true
          }
        ]
      },
      "score": 0.16839975118637085
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "column": 61
          },
          "endPosition": {
            "line": 24,
            "column": 108
          }
        },
        "contents": "import {DEFAULT_SETTINGS, ZettelPluginSettings, ZettelSettingTab} from \"./settings\";\nimport {ZettelControlsView, ZETTEL_CONTROLS_VIEW_TYPE} from \"./views/ZettelControlsView\";\nimport {dismissOutput as runnerDismissOutput, runChain as runnerRunChain, runNode as runnerRunNode} from \"./engine/runner\";\nimport {\n\tclearCanvasEdgeModeLabels,\n\tclearCanvasLegend,\n\tclearCanvasRoleLabels,\n\tsyncCanvasEdgeModeLabels,\n\tsyncCanvasRoleLabels,\n} from \"./canvas/canvasNodeLabels\";\nimport {getKernelForCanvas, terminateAllKernels, terminateKernel} from \"./engine/kernelManager\";\n\n/** Resolve canvas node id from context-menu payload (shape may vary by Obsidian version). */\nfunction resolveCanvasNodeId(node: unknown): string | undefined {\n\tif (!node || typeof node !== \"object\") return undefined;\n\tconst n = node as Record&lt;string, unknown&gt;;\n\tif (typeof n.id === \"string\") return n.id;\n\tconst inner = n.node as Record&lt;string, unknown&gt; | undefined;\n\tif (inner &amp;&amp; typeof inner.id === \"string\") return inner.id;\n\tconst data = typeof n.getData === \"function\" ? (n.getData as () =&gt; { id?: string })() : undefined;\n\treturn data?.id;\n}\n\n/** Debug: set to true when canvas:node-menu callback has fired at least once (proves event is received). */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "import {DEFAULT_SETTINGS, ZettelPluginSettings, ZettelSettingTab} from \"./settings\";",
            "lineNumber": 2
          },
          {
            "text": "import {ZettelControlsView, ZETTEL_CONTROLS_VIEW_TYPE} from \"./views/ZettelControlsView\";",
            "lineNumber": 3
          },
          {
            "text": "import {dismissOutput as runnerDismissOutput, runChain as runnerRunChain, runNode as runnerRunNode} from \"./engine/runner\";",
            "lineNumber": 4
          },
          {
            "text": "import {",
            "lineNumber": 5
          },
          {
            "text": "\tclearCanvasEdgeModeLabels,",
            "lineNumber": 6
          },
          {
            "text": "\tclearCanvasLegend,",
            "lineNumber": 7
          },
          {
            "text": "\tclearCanvasRoleLabels,",
            "lineNumber": 8
          },
          {
            "text": "\tsyncCanvasEdgeModeLabels,",
            "lineNumber": 9
          },
          {
            "text": "\tsyncCanvasRoleLabels,",
            "lineNumber": 10
          },
          {
            "text": "} from \"./canvas/canvasNodeLabels\";",
            "lineNumber": 11
          },
          {
            "text": "import {getKernelForCanvas, terminateAllKernels, terminateKernel} from \"./engine/kernelManager\";",
            "lineNumber": 12
          },
          {
            "lineNumber": 13
          },
          {
            "text": "/** Resolve canvas node id from context-menu payload (shape may vary by Obsidian version). */",
            "lineNumber": 14
          },
          {
            "text": "function resolveCanvasNodeId(node: unknown): string | undefined {",
            "lineNumber": 15,
            "isSignature": true
          },
          {
            "text": "\tif (!node || typeof node !== \"object\") return undefined;",
            "lineNumber": 16
          },
          {
            "text": "\tconst n = node as Record&lt;string, unknown&gt;;",
            "lineNumber": 17
          },
          {
            "text": "\tif (typeof n.id === \"string\") return n.id;",
            "lineNumber": 18
          },
          {
            "text": "\tconst inner = n.node as Record&lt;string, unknown&gt; | undefined;",
            "lineNumber": 19
          },
          {
            "text": "\tif (inner &amp;&amp; typeof inner.id === \"string\") return inner.id;",
            "lineNumber": 20
          },
          {
            "text": "\tconst data = typeof n.getData === \"function\" ? (n.getData as () =&gt; { id?: string })() : undefined;",
            "lineNumber": 21
          },
          {
            "text": "\treturn data?.id;",
            "lineNumber": 22
          },
          {
            "text": "}",
            "lineNumber": 23,
            "isSignature": true
          },
          {
            "lineNumber": 24
          },
          {
            "text": "/** Debug: set to true when canvas:node-menu callback has fired at least once (proves event is received). */",
            "lineNumber": 25
          }
        ]
      },
      "score": 0.16624575853347778
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/settings.ts",
        "range": {
          "startPosition": {
            "line": 175
          },
          "endPosition": {
            "line": 312,
            "column": 1
          }
        },
        "contents": "export class ZettelSettingTab extends PluginSettingTab {\n\n\n\tdisplay(): void {\n\t\tconst {containerEl} = this;\n\t\tcontainerEl.empty();\n\t\tconst s = this.plugin.settings;\n\n\t\t// How to run: one-line hint (per UX suggestion)\n\t\tconst hint = containerEl.createDiv({ cls: \"ztb-settings-hint setting-item-description\" });\n\t\thint.setText(\"Right-click a node on the canvas and choose Run node or Run chain.\");\n\n\t\t// Execution: what runs (primary model, secondary model, Python path)\n\t\tconst executionSection = containerEl.createDiv({ cls: \"ztb-settings-section\" });\n\t\texecutionSection.createEl(\"h4\", { text: \"Execution\", cls: \"ztb-section-title\" });\n\t\tconst ollamaContainer = executionSection.createDiv({ cls: \"ztb-ollama-settings\" });\n\t\tconst loadingEl = ollamaContainer.createDiv({ cls: \"ztb-ollama-loading\" });\n\t\tloadingEl.setText(\"Loading Ollama models\");\n\t\t(async () =&gt; {\n\t\t\tconst models = await fetchOllamaModels();\n\t\t\tloadingEl.remove();\n\t\t\tif (models.length === 0) {\n\t\t\t\tconst fallback = ollamaContainer.createDiv({ cls: \"ztb-ollama-fallback\" });\n\t\t\t\tfallback.createEl(\"p\", { text: \"Ollama not reachable or no models. Enter model names manually.\" });\n\t\t\t\tnew Setting(ollamaContainer)\n\t\t\t\t\t.setName(\"Model node (primary)\")\n\t\t\t\t\t.setDesc(\"Ollama model used when you run a primary model node (e.g. llama2)\")\n\t\t\t\t\t.addText((text) =&gt; text\n\t\t\t\t\t\t.setPlaceholder(\"e.g. llama2\")\n\t\t\t\t\t\t.setValue(s.ollamaOrangeModel)\n\t\t\t\t\t\t.onChange(async (value) =&gt; {\n\t\t\t\t\t\t\tthis.plugin.settings.ollamaOrangeModel = value;\n\t\t\t\t\t\t\tawait this.plugin.saveSettings();\n\t\t\t\t\t\t}));\n\t\t\t\tnew Setting(ollamaContainer)\n\t\t\t\t\t.setName(\"Model node (secondary)\")\n\t\t\t\t\t.setDesc(\"Ollama model used when you run a secondary model node\")\n\t\t\t\t\t.addText((text) =&gt; text\n\t\t\t\t\t\t.setPlaceholder(\"e.g. mistral\")\n\t\t\t\t\t\t.setValue(s.ollamaPurpleModel)\n\t\t\t\t\t\t.onChange(async (value) =&gt; {\n\t\t\t\t\t\t\ts.ollamaPurpleModel = value;\n\t\t\t\t\t\t\tawait this.plugin.saveSettings();\n\t\t\t\t\t\t}));\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tnew Setting(ollamaContainer)\n\t\t\t\t.setName(\"Model node (primary)\")\n\t\t\t\t.setDesc\n\n\t\t}\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 176,
                "column": 1
              },
              "endPosition": {
                "line": 176,
                "column": 8
              }
            },
            {
              "startPosition": {
                "line": 176,
                "column": 8
              },
              "endPosition": {
                "line": 177,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export class ZettelSettingTab extends PluginSettingTab {",
            "lineNumber": 176,
            "isSignature": true
          },
          {
            "lineNumber": 182
          },
          {
            "lineNumber": 183
          },
          {
            "text": "\tdisplay(): void {",
            "lineNumber": 184
          },
          {
            "text": "\t\tconst {containerEl} = this;",
            "lineNumber": 185
          },
          {
            "text": "\t\tcontainerEl.empty();",
            "lineNumber": 186
          },
          {
            "text": "\t\tconst s = this.plugin.settings;",
            "lineNumber": 187
          },
          {
            "lineNumber": 188
          },
          {
            "text": "\t\t// How to run: one-line hint (per UX suggestion)",
            "lineNumber": 189
          },
          {
            "text": "\t\tconst hint = containerEl.createDiv({ cls: \"ztb-settings-hint setting-item-description\" });",
            "lineNumber": 190
          },
          {
            "text": "\t\thint.setText(\"Right-click a node on the canvas and choose Run node or Run chain.\");",
            "lineNumber": 191
          },
          {
            "lineNumber": 192
          },
          {
            "text": "\t\t// Execution: what runs (primary model, secondary model, Python path)",
            "lineNumber": 193
          },
          {
            "text": "\t\tconst executionSection = containerEl.createDiv({ cls: \"ztb-settings-section\" });",
            "lineNumber": 194
          },
          {
            "text": "\t\texecutionSection.createEl(\"h4\", { text: \"Execution\", cls: \"ztb-section-title\" });",
            "lineNumber": 195
          },
          {
            "text": "\t\tconst ollamaContainer = executionSection.createDiv({ cls: \"ztb-ollama-settings\" });",
            "lineNumber": 196
          },
          {
            "text": "\t\tconst loadingEl = ollamaContainer.createDiv({ cls: \"ztb-ollama-loading\" });",
            "lineNumber": 197
          },
          {
            "text": "\t\tloadingEl.setText(\"Loading Ollama models\");",
            "lineNumber": 198
          },
          {
            "text": "\t\t(async () =&gt; {",
            "lineNumber": 199
          },
          {
            "text": "\t\t\tconst models = await fetchOllamaModels();",
            "lineNumber": 200
          },
          {
            "text": "\t\t\tloadingEl.remove();",
            "lineNumber": 201
          },
          {
            "text": "\t\t\tif (models.length === 0) {",
            "lineNumber": 202
          },
          {
            "text": "\t\t\t\tconst fallback = ollamaContainer.createDiv({ cls: \"ztb-ollama-fallback\" });",
            "lineNumber": 203
          },
          {
            "text": "\t\t\t\tfallback.createEl(\"p\", { text: \"Ollama not reachable or no models. Enter model names manually.\" });",
            "lineNumber": 204
          },
          {
            "text": "\t\t\t\tnew Setting(ollamaContainer)",
            "lineNumber": 205
          },
          {
            "text": "\t\t\t\t\t.setName(\"Model node (primary)\")",
            "lineNumber": 206
          },
          {
            "text": "\t\t\t\t\t.setDesc(\"Ollama model used when you run a primary model node (e.g. llama2)\")",
            "lineNumber": 207
          },
          {
            "text": "\t\t\t\t\t.addText((text) =&gt; text",
            "lineNumber": 208
          },
          {
            "text": "\t\t\t\t\t\t.setPlaceholder(\"e.g. llama2\")",
            "lineNumber": 209
          },
          {
            "text": "\t\t\t\t\t\t.setValue(s.ollamaOrangeModel)",
            "lineNumber": 210
          },
          {
            "text": "\t\t\t\t\t\t.onChange(async (value) =&gt; {",
            "lineNumber": 211
          },
          {
            "text": "\t\t\t\t\t\t\tthis.plugin.settings.ollamaOrangeModel = value;",
            "lineNumber": 212
          },
          {
            "text": "\t\t\t\t\t\t\tawait this.plugin.saveSettings();",
            "lineNumber": 213
          },
          {
            "text": "\t\t\t\t\t\t}));",
            "lineNumber": 214
          },
          {
            "text": "\t\t\t\tnew Setting(ollamaContainer)",
            "lineNumber": 215
          },
          {
            "text": "\t\t\t\t\t.setName(\"Model node (secondary)\")",
            "lineNumber": 216
          },
          {
            "text": "\t\t\t\t\t.setDesc(\"Ollama model used when you run a secondary model node\")",
            "lineNumber": 217
          },
          {
            "text": "\t\t\t\t\t.addText((text) =&gt; text",
            "lineNumber": 218
          },
          {
            "text": "\t\t\t\t\t\t.setPlaceholder(\"e.g. mistral\")",
            "lineNumber": 219
          },
          {
            "text": "\t\t\t\t\t\t.setValue(s.ollamaPurpleModel)",
            "lineNumber": 220
          },
          {
            "text": "\t\t\t\t\t\t.onChange(async (value) =&gt; {",
            "lineNumber": 221
          },
          {
            "text": "\t\t\t\t\t\t\ts.ollamaPurpleModel = value;",
            "lineNumber": 222
          },
          {
            "text": "\t\t\t\t\t\t\tawait this.plugin.saveSettings();",
            "lineNumber": 223
          },
          {
            "text": "\t\t\t\t\t\t}));",
            "lineNumber": 224
          },
          {
            "text": "\t\t\t\treturn;",
            "lineNumber": 225
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 226
          },
          {
            "text": "\t\t\tnew Setting(ollamaContainer)",
            "lineNumber": 227
          },
          {
            "text": "\t\t\t\t.setName(\"Model node (primary)\")",
            "lineNumber": 228
          },
          {
            "text": "\t\t\t\t.setDesc",
            "lineNumber": 229
          },
          {
            "lineNumber": 238
          },
          {
            "text": "\t\t}",
            "lineNumber": 251
          },
          {
            "text": "\t}",
            "lineNumber": 312
          },
          {
            "text": "}",
            "lineNumber": 313,
            "isSignature": true
          }
        ]
      },
      "score": 0.16279560327529907
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 27
          },
          "endPosition": {
            "line": 298,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\n\n\n\t/** Dismiss the Green output node for the given source node (call from context menu with node id). */\n\tasync dismissOutput(nodeId: string): Promise&lt;void&gt; {\n\t\tconst view = this.getActiveCanvasView();\n\t\tif (!view) return;\n\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;\n\t\tawait runnerDismissOutput(this.app.vault, view.file.path, nodeId, this.settings, liveCanvas);\n\t}\n\n\t/** Get kernel for the active (or first open) canvas (for side panel to wire obsidian_log). */\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 28,
                "column": 1
              },
              "endPosition": {
                "line": 28,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 28,
                "column": 16
              },
              "endPosition": {
                "line": 29,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 28,
            "isSignature": true
          },
          {
            "lineNumber": 283
          },
          {
            "lineNumber": 284
          },
          {
            "text": "\t/** Dismiss the Green output node for the given source node (call from context menu with node id). */",
            "lineNumber": 285
          },
          {
            "text": "\tasync dismissOutput(nodeId: string): Promise&lt;void&gt; {",
            "lineNumber": 286
          },
          {
            "text": "\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 287
          },
          {
            "text": "\t\tif (!view) return;",
            "lineNumber": 288
          },
          {
            "text": "\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;",
            "lineNumber": 289
          },
          {
            "text": "\t\tawait runnerDismissOutput(this.app.vault, view.file.path, nodeId, this.settings, liveCanvas);",
            "lineNumber": 290
          },
          {
            "text": "\t}",
            "lineNumber": 291
          },
          {
            "lineNumber": 292
          },
          {
            "text": "\t/** Get kernel for the active (or first open) canvas (for side panel to wire obsidian_log). */",
            "lineNumber": 293
          },
          {
            "text": "}",
            "lineNumber": 299,
            "isSignature": true
          }
        ]
      },
      "score": 0.16226090490818024
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 27
          },
          "endPosition": {
            "line": 298,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\n\n\n\t/** Run a single node (call from context menu with node id). */\n\tasync runNode(nodeId: string): Promise&lt;void&gt; {\n\t\tconst view = this.getActiveCanvasView();\n\t\tif (!view) return;\n\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;\n\t\tconst result = await runnerRunNode(this.app, this.settings, view.file.path, nodeId, liveCanvas);\n\t\tif (!result.ok) new Notice(result.message ?? \"Run node failed.\");\n\t}\n\n\t/** Run chain from roots to the given node (call from context menu with node id). */\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 28,
                "column": 1
              },
              "endPosition": {
                "line": 28,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 28,
                "column": 16
              },
              "endPosition": {
                "line": 29,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 28,
            "isSignature": true
          },
          {
            "lineNumber": 265
          },
          {
            "lineNumber": 266
          },
          {
            "text": "\t/** Run a single node (call from context menu with node id). */",
            "lineNumber": 267
          },
          {
            "text": "\tasync runNode(nodeId: string): Promise&lt;void&gt; {",
            "lineNumber": 268
          },
          {
            "text": "\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 269
          },
          {
            "text": "\t\tif (!view) return;",
            "lineNumber": 270
          },
          {
            "text": "\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;",
            "lineNumber": 271
          },
          {
            "text": "\t\tconst result = await runnerRunNode(this.app, this.settings, view.file.path, nodeId, liveCanvas);",
            "lineNumber": 272
          },
          {
            "text": "\t\tif (!result.ok) new Notice(result.message ?? \"Run node failed.\");",
            "lineNumber": 273
          },
          {
            "text": "\t}",
            "lineNumber": 274
          },
          {
            "lineNumber": 275
          },
          {
            "text": "\t/** Run chain from roots to the given node (call from context menu with node id). */",
            "lineNumber": 276
          },
          {
            "text": "}",
            "lineNumber": 299,
            "isSignature": true
          }
        ]
      },
      "score": 0.16179439425468445
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/views/ZettelControlsView.ts",
        "range": {
          "startPosition": {
            "line": 9
          },
          "endPosition": {
            "line": 126,
            "column": 1
          }
        },
        "contents": "export class ZettelControlsView extends ItemView {\nasync onOpen(): Promise&lt;void&gt; {\n\n\t\tconst addEnvRow = (key = \"\", value = \"\") =&gt; {\n\t\t\tconst row = envList.createDiv({ cls: \"ztb-env-row\" });\n\t\t\tconst keyInp = row.createEl(\"input\", { type: \"text\", cls: \"ztb-env-key\" });\n\t\t\tkeyInp.placeholder = \"KEY\";\n\t\t\tkeyInp.value = key;\n\t\t\tconst valInp = row.createEl(\"input\", { type: \"text\", cls: \"ztb-env-val\" });\n\t\t\tvalInp.placeholder = \"value\";\n\t\t\tvalInp.value = value;\n\t\t\tkeyInp.addEventListener(\"change\", () =&gt; {\n\t\t\t\tif (key) delete envVars[key];\n\t\t\t\tenvVars[keyInp.value.trim()] = valInp.value.trim();\n\t\t\t});\n\t\t\tvalInp.addEventListener(\"change\", () =&gt; {\n\t\t\t\tenvVars[keyInp.value.trim()] = valInp.value.trim();\n\t\t\t});\n\t\t\trow.createEl(\"button\", { text: \"Remove\", cls: \"ztb-env-remove\" }).addEventListener(\"click\", () =&gt; {\n\t\t\t\tdelete envVars[keyInp.value.trim()];\n\t\t\t\trow.remove();\n\t\t\t});\n\t\t};\n\t\tfor (const [k, v] of Object.entries(envVars)) addEnvRow(k, v);\n\t\tconst addBtn = el.createEl(\"button\", { text: \"Add variable\", cls: \"ztb-env-add\" });\n\t\taddBtn.addEventListener(\"click\", () =&gt; addEnvRow());\n\n\t\t// Console (obsidian_log output)\n\t\tel.createEl(\"h4\", { text: \"Console\", cls: \"ztb-section-title\" });\n\t\tconst consoleEl = el.createDiv({ cls: \"ztb-console\" });\n\t\tconst appendLog = (line: string) =&gt; {\n\t\t\tconst p = consoleEl.createEl(\"p\", { cls: \"ztb-console-line\" });\n\t\t\tp.setText(line);\n\t\t\tconsoleEl.scrollTop = consoleEl.scrollHeight;\n\t\t};\n\n\t\tconst wireKernelLog = () =&gt; {\n\t\t\tconst kernel = this.plugin.getKernelForActiveCanvas();\n\t\t\tif (kernel) kernel.onLog = (line: string) =&gt; {\n\t\t\t\tif (this.containerEl.isConnected) appendLog(line);\n\t\t\t};\n\t\t};\n\t\twireKernelLog();\n\t\tthis.plugin.registerEvent(\n\t\t\tthis.plugin.app.workspace.on(\"active-leaf-change\", wireKernelLog)\n\t\t);\n\t}\n\n\tasync onClose(): Promise&lt;void&gt; {\n\t\tthis.containerEl.empty();\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 10,
                "column": 1
              },
              "endPosition": {
                "line": 10,
                "column": 8
              }
            },
            {
              "startPosition": {
                "line": 10,
                "column": 8
              },
              "endPosition": {
                "line": 11,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 27,
                "column": 2
              },
              "endPosition": {
                "line": 28,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export class ZettelControlsView extends ItemView {",
            "lineNumber": 10,
            "isSignature": true
          },
          {
            "text": "async onOpen(): Promise&lt;void&gt; {",
            "lineNumber": 27
          },
          {
            "lineNumber": 78
          },
          {
            "text": "\t\tconst addEnvRow = (key = \"\", value = \"\") =&gt; {",
            "lineNumber": 79
          },
          {
            "text": "\t\t\tconst row = envList.createDiv({ cls: \"ztb-env-row\" });",
            "lineNumber": 80
          },
          {
            "text": "\t\t\tconst keyInp = row.createEl(\"input\", { type: \"text\", cls: \"ztb-env-key\" });",
            "lineNumber": 81
          },
          {
            "text": "\t\t\tkeyInp.placeholder = \"KEY\";",
            "lineNumber": 82
          },
          {
            "text": "\t\t\tkeyInp.value = key;",
            "lineNumber": 83
          },
          {
            "text": "\t\t\tconst valInp = row.createEl(\"input\", { type: \"text\", cls: \"ztb-env-val\" });",
            "lineNumber": 84
          },
          {
            "text": "\t\t\tvalInp.placeholder = \"value\";",
            "lineNumber": 85
          },
          {
            "text": "\t\t\tvalInp.value = value;",
            "lineNumber": 86
          },
          {
            "text": "\t\t\tkeyInp.addEventListener(\"change\", () =&gt; {",
            "lineNumber": 87
          },
          {
            "text": "\t\t\t\tif (key) delete envVars[key];",
            "lineNumber": 88
          },
          {
            "text": "\t\t\t\tenvVars[keyInp.value.trim()] = valInp.value.trim();",
            "lineNumber": 89
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 90
          },
          {
            "text": "\t\t\tvalInp.addEventListener(\"change\", () =&gt; {",
            "lineNumber": 91
          },
          {
            "text": "\t\t\t\tenvVars[keyInp.value.trim()] = valInp.value.trim();",
            "lineNumber": 92
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 93
          },
          {
            "text": "\t\t\trow.createEl(\"button\", { text: \"Remove\", cls: \"ztb-env-remove\" }).addEventListener(\"click\", () =&gt; {",
            "lineNumber": 94
          },
          {
            "text": "\t\t\t\tdelete envVars[keyInp.value.trim()];",
            "lineNumber": 95
          },
          {
            "text": "\t\t\t\trow.remove();",
            "lineNumber": 96
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 97
          },
          {
            "text": "\t\t};",
            "lineNumber": 98
          },
          {
            "text": "\t\tfor (const [k, v] of Object.entries(envVars)) addEnvRow(k, v);",
            "lineNumber": 99
          },
          {
            "text": "\t\tconst addBtn = el.createEl(\"button\", { text: \"Add variable\", cls: \"ztb-env-add\" });",
            "lineNumber": 100
          },
          {
            "text": "\t\taddBtn.addEventListener(\"click\", () =&gt; addEnvRow());",
            "lineNumber": 101
          },
          {
            "lineNumber": 102
          },
          {
            "text": "\t\t// Console (obsidian_log output)",
            "lineNumber": 103
          },
          {
            "text": "\t\tel.createEl(\"h4\", { text: \"Console\", cls: \"ztb-section-title\" });",
            "lineNumber": 104
          },
          {
            "text": "\t\tconst consoleEl = el.createDiv({ cls: \"ztb-console\" });",
            "lineNumber": 105
          },
          {
            "text": "\t\tconst appendLog = (line: string) =&gt; {",
            "lineNumber": 106
          },
          {
            "text": "\t\t\tconst p = consoleEl.createEl(\"p\", { cls: \"ztb-console-line\" });",
            "lineNumber": 107
          },
          {
            "text": "\t\t\tp.setText(line);",
            "lineNumber": 108
          },
          {
            "text": "\t\t\tconsoleEl.scrollTop = consoleEl.scrollHeight;",
            "lineNumber": 109
          },
          {
            "text": "\t\t};",
            "lineNumber": 110
          },
          {
            "lineNumber": 111
          },
          {
            "text": "\t\tconst wireKernelLog = () =&gt; {",
            "lineNumber": 112
          },
          {
            "text": "\t\t\tconst kernel = this.plugin.getKernelForActiveCanvas();",
            "lineNumber": 113
          },
          {
            "text": "\t\t\tif (kernel) kernel.onLog = (line: string) =&gt; {",
            "lineNumber": 114
          },
          {
            "text": "\t\t\t\tif (this.containerEl.isConnected) appendLog(line);",
            "lineNumber": 115
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 116
          },
          {
            "text": "\t\t};",
            "lineNumber": 117
          },
          {
            "text": "\t\twireKernelLog();",
            "lineNumber": 118
          },
          {
            "text": "\t\tthis.plugin.registerEvent(",
            "lineNumber": 119
          },
          {
            "text": "\t\t\tthis.plugin.app.workspace.on(\"active-leaf-change\", wireKernelLog)",
            "lineNumber": 120
          },
          {
            "text": "\t\t);",
            "lineNumber": 121
          },
          {
            "text": "\t}",
            "lineNumber": 122
          },
          {
            "lineNumber": 123
          },
          {
            "text": "\tasync onClose(): Promise&lt;void&gt; {",
            "lineNumber": 124
          },
          {
            "text": "\t\tthis.containerEl.empty();",
            "lineNumber": 125
          },
          {
            "text": "\t}",
            "lineNumber": 126
          },
          {
            "text": "}",
            "lineNumber": 127,
            "isSignature": true
          }
        ]
      },
      "score": 0.15887390077114105
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/canvasApi.ts",
        "range": {
          "startPosition": {
            "column": 86
          },
          "endPosition": {
            "line": 15,
            "column": 1
          }
        },
        "contents": "export interface LiveCanvas {\n\tcreateTextNode(options: {\n\t\ttext: string;\n\t\tpos: { x: number; y: number };\n\t\tsize: { width: number; height: number };\n\t\tsave?: boolean;\n\t\tfocus?: boolean;\n\t}): { id: string; x: number; y: number; width: number; height: number; moveTo: (pos: { x: number; y: number }) =&gt; void; resize: (size: { width: number; height: number }) =&gt; void };\n\taddNode(node: unknown): void;\n\trequestSave?: () =&gt; void;\n\tremoveNode?(node: unknown): void;\n\tnodes?: Map&lt;string, unknown&gt; | Iterable&lt;unknown&gt;;\n\t/** If present, used to refresh canvas after edge label updates (Obsidian canvas view). */\n\tsetData?(data: unknown): void;\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "export interface LiveCanvas {",
            "lineNumber": 2,
            "isSignature": true
          },
          {
            "text": "\tcreateTextNode(options: {",
            "lineNumber": 3
          },
          {
            "text": "\t\ttext: string;",
            "lineNumber": 4
          },
          {
            "text": "\t\tpos: { x: number; y: number };",
            "lineNumber": 5
          },
          {
            "text": "\t\tsize: { width: number; height: number };",
            "lineNumber": 6
          },
          {
            "text": "\t\tsave?: boolean;",
            "lineNumber": 7
          },
          {
            "text": "\t\tfocus?: boolean;",
            "lineNumber": 8
          },
          {
            "text": "\t}): { id: string; x: number; y: number; width: number; height: number; moveTo: (pos: { x: number; y: number }) =&gt; void; resize: (size: { width: number; height: number }) =&gt; void };",
            "lineNumber": 9
          },
          {
            "text": "\taddNode(node: unknown): void;",
            "lineNumber": 10
          },
          {
            "text": "\trequestSave?: () =&gt; void;",
            "lineNumber": 11
          },
          {
            "text": "\tremoveNode?(node: unknown): void;",
            "lineNumber": 12
          },
          {
            "text": "\tnodes?: Map&lt;string, unknown&gt; | Iterable&lt;unknown&gt;;",
            "lineNumber": 13
          },
          {
            "text": "\t/** If present, used to refresh canvas after edge label updates (Obsidian canvas view). */",
            "lineNumber": 14
          },
          {
            "text": "\tsetData?(data: unknown): void;",
            "lineNumber": 15,
            "isSignature": true
          },
          {
            "text": "}",
            "lineNumber": 16,
            "isSignature": true
          }
        ]
      },
      "score": 0.1547536998987198
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 40
          },
          "endPosition": {
            "line": 95,
            "column": 93
          }
        },
        "contents": "function canReach(data: CanvasData, fromId: string, toId: string): boolean {\n\n\treturn false;\n}\n\n/** Topological order of node ids (only nodes that are ancestors of target; ignores output edges). */\nfunction topologicalOrderToTarget(data: CanvasData, targetId: string): string[] {\n\tconst execEdges = data.edges.filter((e) =&gt; !isOutputEdge(e));\n\tconst nodeIds = new Set&lt;string&gt;();\n\tconst stack = [targetId];\n\twhile (stack.length &gt; 0) {\n\t\tconst id = stack.pop()!;\n\t\tif (nodeIds.has(id)) continue;\n\t\tnodeIds.add(id);\n\t\tfor (const e of execEdges) {\n\t\t\tif (e.toNode === id) stack.push(e.fromNode);\n\t\t}\n\t}\n\tconst inDegree = new Map&lt;string, number&gt;();\n\tfor (const id of nodeIds) inDegree.set(id, 0);\n\tfor (const e of execEdges) {\n\t\tif (nodeIds.has(e.fromNode) &amp;&amp; nodeIds.has(e.toNode)) {\n\t\t\tinDegree.set(e.toNode, (inDegree.get(e.toNode) ?? 0) + 1);\n\t\t}\n\t}\n\tconst order: string[] = [];\n\tconst queue = [...nodeIds].filter((id) =&gt; inDegree.get(id) === 0).sort((a, b) =&gt; {\n\t\tconst na = getNodeById(data, a);\n\t\tconst nb = getNodeById(data, b);\n\t\treturn (na?.y ?? 0) - (nb?.y ?? 0);\n\t});\n\twhile (queue.length &gt; 0) {\n\t\tconst id = queue.shift()!;\n\t\torder.push(id);\n\t\tfor (const e of execEdges) {\n\t\t\tif (e.fromNode === id &amp;&amp; nodeIds.has(e.toNode)) {\n\t\t\t\tconst d = (inDegree.get(e.toNode) ?? 0) - 1;\n\t\t\t\tinDegree.set(e.toNode, d);\n\t\t\t\tif (d === 0) queue.push(e.toNode);\n\t\t\t}\n\t\t}\n\t}\n\treturn order;\n}\n\n/** Build concatenated context, template with {{var:name}} substituted, and per-edge mode. */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "function canReach(data: CanvasData, fromId: string, toId: string): boolean {",
            "lineNumber": 41,
            "isSignature": true
          },
          {
            "lineNumber": 52
          },
          {
            "text": "\treturn false;",
            "lineNumber": 53
          },
          {
            "text": "}",
            "lineNumber": 54,
            "isSignature": true
          },
          {
            "lineNumber": 55
          },
          {
            "text": "/** Topological order of node ids (only nodes that are ancestors of target; ignores output edges). */",
            "lineNumber": 56
          },
          {
            "text": "function topologicalOrderToTarget(data: CanvasData, targetId: string): string[] {",
            "lineNumber": 57,
            "isSignature": true
          },
          {
            "text": "\tconst execEdges = data.edges.filter((e) =&gt; !isOutputEdge(e));",
            "lineNumber": 58
          },
          {
            "text": "\tconst nodeIds = new Set&lt;string&gt;();",
            "lineNumber": 59
          },
          {
            "text": "\tconst stack = [targetId];",
            "lineNumber": 60
          },
          {
            "text": "\twhile (stack.length &gt; 0) {",
            "lineNumber": 61
          },
          {
            "text": "\t\tconst id = stack.pop()!;",
            "lineNumber": 62
          },
          {
            "text": "\t\tif (nodeIds.has(id)) continue;",
            "lineNumber": 63
          },
          {
            "text": "\t\tnodeIds.add(id);",
            "lineNumber": 64
          },
          {
            "text": "\t\tfor (const e of execEdges) {",
            "lineNumber": 65
          },
          {
            "text": "\t\t\tif (e.toNode === id) stack.push(e.fromNode);",
            "lineNumber": 66
          },
          {
            "text": "\t\t}",
            "lineNumber": 67
          },
          {
            "text": "\t}",
            "lineNumber": 68
          },
          {
            "text": "\tconst inDegree = new Map&lt;string, number&gt;();",
            "lineNumber": 69
          },
          {
            "text": "\tfor (const id of nodeIds) inDegree.set(id, 0);",
            "lineNumber": 70
          },
          {
            "text": "\tfor (const e of execEdges) {",
            "lineNumber": 71
          },
          {
            "text": "\t\tif (nodeIds.has(e.fromNode) &amp;&amp; nodeIds.has(e.toNode)) {",
            "lineNumber": 72
          },
          {
            "text": "\t\t\tinDegree.set(e.toNode, (inDegree.get(e.toNode) ?? 0) + 1);",
            "lineNumber": 73
          },
          {
            "text": "\t\t}",
            "lineNumber": 74
          },
          {
            "text": "\t}",
            "lineNumber": 75
          },
          {
            "text": "\tconst order: string[] = [];",
            "lineNumber": 76
          },
          {
            "text": "\tconst queue = [...nodeIds].filter((id) =&gt; inDegree.get(id) === 0).sort((a, b) =&gt; {",
            "lineNumber": 77
          },
          {
            "text": "\t\tconst na = getNodeById(data, a);",
            "lineNumber": 78
          },
          {
            "text": "\t\tconst nb = getNodeById(data, b);",
            "lineNumber": 79
          },
          {
            "text": "\t\treturn (na?.y ?? 0) - (nb?.y ?? 0);",
            "lineNumber": 80
          },
          {
            "text": "\t});",
            "lineNumber": 81
          },
          {
            "text": "\twhile (queue.length &gt; 0) {",
            "lineNumber": 82
          },
          {
            "text": "\t\tconst id = queue.shift()!;",
            "lineNumber": 83
          },
          {
            "text": "\t\torder.push(id);",
            "lineNumber": 84
          },
          {
            "text": "\t\tfor (const e of execEdges) {",
            "lineNumber": 85
          },
          {
            "text": "\t\t\tif (e.fromNode === id &amp;&amp; nodeIds.has(e.toNode)) {",
            "lineNumber": 86
          },
          {
            "text": "\t\t\t\tconst d = (inDegree.get(e.toNode) ?? 0) - 1;",
            "lineNumber": 87
          },
          {
            "text": "\t\t\t\tinDegree.set(e.toNode, d);",
            "lineNumber": 88
          },
          {
            "text": "\t\t\t\tif (d === 0) queue.push(e.toNode);",
            "lineNumber": 89
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 90
          },
          {
            "text": "\t\t}",
            "lineNumber": 91
          },
          {
            "text": "\t}",
            "lineNumber": 92
          },
          {
            "text": "\treturn order;",
            "lineNumber": 93
          },
          {
            "text": "}",
            "lineNumber": 94,
            "isSignature": true
          },
          {
            "lineNumber": 95
          },
          {
            "text": "/** Build concatenated context, template with {{var:name}} substituted, and per-edge mode. */",
            "lineNumber": 96
          }
        ]
      },
      "score": 0.15086080133914948
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/types.ts",
        "range": {
          "startPosition": {
            "line": 35,
            "column": 57
          },
          "endPosition": {
            "line": 40,
            "column": 83
          }
        },
        "contents": "/** Reserved edge label from run node to its green output note; not a variable name. */\nexport const EDGE_LABEL_OUTPUT = \"output\";\n\n/** Parse variable name from edge label; ignore anything in brackets at the end. */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Reserved edge label from run node to its green output note; not a variable name. */",
            "lineNumber": 38
          },
          {
            "text": "export const EDGE_LABEL_OUTPUT = \"output\";",
            "lineNumber": 39
          },
          {
            "lineNumber": 40
          },
          {
            "text": "/** Parse variable name from edge label; ignore anything in brackets at the end. */",
            "lineNumber": 41
          }
        ]
      },
      "score": 0.14945173263549805
    }
  ]
}
```
Status: **completed**


</details>
</tool-use>

---





---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "canvas:.*menu|context.*canvas|workspace\\.on",
  "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "canvas:.*menu|context.*canvas|workspace\\.on",
    "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board": {
        "content": {
          "matches": [
            {
              "file": "./src/main.ts",
              "matches": [
                {
                  "lineNumber": 25,
                  "content": "/** Debug: set to true when canvas:node-menu callback has fired at least once (proves event is received). */"
                },
                {
                  "lineNumber": 84,
                  "content": "\t\t\t// Canvas node context menu (event name is undocumented; try workspace.on(\"canvas:node-menu\"))."
                },
                {
                  "lineNumber": 102,
                  "content": "\t\t\t\t\tconst on = this.app.workspace.on.bind(this.app.workspace) as ("
                },
                {
                  "lineNumber": 105,
                  "content": "\t\t\t\t\t) =&gt; ReturnType&lt;typeof this.app.workspace.on&gt;;"
                },
                {
                  "lineNumber": 106,
                  "content": "\t\t\t\t\t// Try documented-style event name first; some Obsidian builds use \"canvas:node-menu\"."
                },
                {
                  "lineNumber": 107,
                  "content": "\t\t\t\t\tthis.registerEvent(on(\"canvas:node-menu\", addNodeMenuItems));"
                },
                {
                  "lineNumber": 117,
                  "content": "\t\t\t// Debug: command to test if we can affect the canvas and if canvas:node-menu ever fires."
                },
                {
                  "lineNumber": 137,
                  "content": "\t\t\t\tthis.app.workspace.on(\"layout-change\", () =&gt; {"
                },
                {
                  "lineNumber": 190,
                  "content": "\t\t\tthis.registerEvent(this.app.workspace.on(\"active-leaf-change\", runSyncLabels));"
                }
              ]
            },
            {
              "file": "./src/views/ZettelControlsView.ts",
              "matches": [
                {
                  "lineNumber": 120,
                  "content": "\t\t\tthis.plugin.app.workspace.on(\"active-leaf-change\", wireKernelLog)"
                }
              ]
            },
            {
              "file": "./AGENTS.md",
              "matches": [
                {
                  "lineNumber": 237,
                  "content": "this.registerEvent(this.app.workspace.on(\"file-open\", f =&gt; { /* ... */ }));"
                }
              ]
            }
          ],
          "totalLines": 11,
          "totalMatchedLines": 11
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/canvas/types.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts</summary>

</details>
</tool-use>

---


Checking for a canvas-background context menu in Obsidian and inspecting node shape/bounds and runner exports.


---

<tool-use data-tool-type="search" data-tool-name="web_search">
<details>
            <summary>Tool use: **web_search**  Searched web `undefined`  **1** results</summary>
        
| Title | URL | Chunk |
|-------|-----|-------|
| Web search results for query: Obsidian plugin canvas context menu right click empty area canvas:menu event |  | Links:<br/>1. [Context menus](https://docs.obsidian.md/Plugins/User+interface/Context+menus)<br/>2. [Interface: CanvasContextMenuEvent \| Reactodia](https://reactodia.github.io/docs/api/workspace/interfaces/CanvasContextMenuEvent)<br/>3. [Events - Developer Documentation](https://docs.obsidian.md/Plugins/Events)<br/>4. [Interface: CanvasEvents \| Reactodia](https://reactodia.github.io/docs/api/workspace/interfaces/CanvasEvents)<br/>5. [Canvas - Obsidian Help](https://help.obsidian.md/plugins/canvas)<br/><br/>The search results don't contain specific documentation about the `canvas:menu` event for Obsidian plugins. <br/><br/>However, based on the available information, Obsidian does support context menus for plugins [3], and the general pattern for handling events involves using the `registerEvent()` method [3]. For canvas-specific events, you would likely need to access the Canvas API through your plugin.<br/><br/>The results from Reactodia (a different library) show that canvas context menu events typically include:[2][4]<br/>- A `contextMenu` event that fires when right-clicking on the canvas<br/>- A `CanvasContextMenuEvent` with properties including `source` (the canvas), `sourceEvent` (the raw mouse event), and `target` (which is `undefined` for empty canvas space)<br/><br/>For Obsidian specifically, you would need to consult the official Obsidian plugin developer documentation or community resources, as the Obsidian docs pages referenced [1][3] appear to be incomplete or not publicly available. The Obsidian Canvas Help [5] documents the user-facing Canvas feature but not the plugin API. |

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/canvas/types.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "getRootIds|topologicalOrder|canReach",
  "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "getRootIds|topologicalOrder|canReach",
    "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board": {
        "content": {
          "matches": [
            {
              "file": "src/engine/runner.ts",
              "matches": [
                {
                  "lineNumber": 33,
                  "content": "function getRootIds(data: CanvasData): string[] {"
                },
                {
                  "lineNumber": 41,
                  "content": "function canReach(data: CanvasData, fromId: string, toId: string): boolean {"
                },
                {
                  "lineNumber": 57,
                  "content": "function topologicalOrderToTarget(data: CanvasData, targetId: string): string[] {"
                },
                {
                  "lineNumber": 327,
                  "content": "\tconst roots = getRootIds(data);"
                },
                {
                  "lineNumber": 328,
                  "content": "\tconst rootsReachingCurrent = roots.filter((r) =&gt; canReach(data, r, nodeId));"
                },
                {
                  "lineNumber": 330,
                  "content": "\tconst order = topologicalOrderToTarget(data, nodeId);"
                }
              ]
            }
          ],
          "totalLines": 6,
          "totalMatchedLines": 6
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---





---

<tool-use data-tool-type="unknown" data-tool-name="web_fetch">
<details>
<summary>Tool use: **web_fetch**</summary>


Parameters:

```json
{
  "url": "https://docs.obsidian.md/Plugins/Events"
}
```
Result:

```json
{
  "url": "https://docs.obsidian.md/Plugins/Events",
  "markdown": "Events - Developer Documentation\n[![](https://publish-01.obsidian.md/access/caa27d6312fe5c26ebc657cc609543be/Assets/obsidian-lockup-docs.svg)](https://docs.obsidian.md/Home)[Developer Documentation](https://docs.obsidian.md/Home)\nPlugins\nGetting started\nGuides\nUser interface\nEditor\nReleasing\n[Events](https://docs.obsidian.md/Plugins/Events)\n[Vault](https://docs.obsidian.md/Plugins/Vault)\nThemes\nReference\n[Developer policies](https://docs.obsidian.md/Developer+policies)\n[Home](https://docs.obsidian.md/Home)\n[![](https://publish-01.obsidian.md/access/caa27d6312fe5c26ebc657cc609543be/Assets/obsidian-lockup-docs.svg)](https://docs.obsidian.md/Home)[Developer Documentation](https://docs.obsidian.md/Home)\n# Events\nMany of the interfaces in the Obsidian lets you subscribe to events throughout the application, for example when the user makes changes to a file.\nAny registered event handlers need to be detached whenever the plugin unloads. The safest way to make sure this happens is to use the[registerEvent()](https://docs.obsidian.md/Reference/TypeScript+API/Component/registerEvent)method.\n&#96;&#96;&#96;\n&#96;import{Plugin}from'obsidian';exportdefaultclassExamplePluginextendsPlugin{asynconload(){this.registerEvent(this.app.vault.on('create',()=&amp;gt;{console.log('a new file has entered the arena')}));}}&#96;\n&#96;&#96;&#96;\n## Timing events\nIf you want to repeatedly call a function with a fixed delay, use the[&#96;window.setInterval()&#96;](https://developer.mozilla.org/en-US/docs/Web/API/setInterval)function with the[registerInterval()](https://docs.obsidian.md/Reference/TypeScript+API/Component/registerInterval)method.\nThe following example displays the current time in the status bar, updated every second:\n&#96;&#96;&#96;\n&#96;import{moment,Plugin}from'obsidian';exportdefaultclassExamplePluginextendsPlugin{statusBar:HTMLElement;asynconload(){this.statusBar=this.addStatusBarItem();this.updateStatusBar();this.registerInterval(window.setInterval(()=&amp;gt;this.updateStatusBar(),1000));}updateStatusBar(){this.statusBar.setText(moment().format('H:mm:ss'));}}&#96;\n&#96;&#96;&#96;\nDate and time\n[Moment](https://momentjs.com/)is a popular JavaScript library for working with dates and time. Obsidian uses Moment internally, so you don't need to install it yourself. You can import it from the Obsidian API instead:\n&#96;&#96;&#96;\n&#96;import{moment}from'obsidian';&#96;\n&#96;&#96;&#96;\nLinks to this page\n[Context menus](https://docs.obsidian.md/Plugins/User+interface/Context+menus)\nEvents\nNot found\nThis page does not exist\nInteractive graph\nOn this page\nTiming events\n[Powered by Obsidian Publish](https://publish.obsidian.md)"
}
```
User decision: **accepted**

Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "\\.x|\\.y|\\.width|\\.height",
  "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/canvas",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "\\.x|\\.y|\\.width|\\.height",
    "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/canvas",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board": {
        "content": {
          "matches": [
            {
              "file": "src/canvas/canvasNodeLabels.ts",
              "matches": [
                {
                  "lineNumber": 171,
                  "content": "\treturn { x: r.left + r.width / 2, y: r.top + r.height / 2 };"
                },
                {
                  "lineNumber": 211,
                  "content": "\t\tconst midX = (fromCenter.x + toCenter.x) / 2 - containerRect.left + containerEl.scrollLeft;"
                },
                {
                  "lineNumber": 212,
                  "content": "\t\tconst midY = (fromCenter.y + toCenter.y) / 2 - containerRect.top + containerEl.scrollTop;"
                }
              ]
            },
            {
              "file": "src/canvas/types.ts",
              "matches": [
                {
                  "lineNumber": 66,
                  "content": "\t\tconst y = parent?.y ?? 0;"
                },
                {
                  "lineNumber": 74,
                  "content": "\twithY.sort((a, b) =&gt; a.y - b.y);"
                },
                {
                  "lineNumber": 86,
                  "content": "\t\t\treturn node ? { id, y: node.y } : null;"
                },
                {
                  "lineNumber": 89,
                  "content": "\twithY.sort((a, b) =&gt; a.y - b.y);"
                },
                {
                  "lineNumber": 135,
                  "content": "\tconst expectedY = source.y + source.height + GREEN_NODE_PADDING;"
                },
                {
                  "lineNumber": 141,
                  "content": "\t\tif (Math.abs(node.x - source.x) &gt; 50) continue;"
                },
                {
                  "lineNumber": 142,
                  "content": "\t\tif (node.y &lt; expectedY - tolerance || node.y &gt; expectedY + tolerance) continue;"
                }
              ]
            }
          ],
          "totalLines": 10,
          "totalMatchedLines": 10
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---





---

<tool-use data-tool-type="search" data-tool-name="web_search">
<details>
            <summary>Tool use: **web_search**  Searched web `undefined`  **1** results</summary>
        
| Title | URL | Chunk |
|-------|-----|-------|
| Web search results for query: Obsidian workspace.on canvas menu event list |  | Links:<br/>1. [Context menus](https://docs.obsidian.md/Plugins/User+interface/Context+menus)<br/>2. [Events - Developer Documentation](https://docs.obsidian.md/Plugins/Events)<br/>3. [Interface: CanvasEvents \| Reactodia](https://reactodia.github.io/docs/api/workspace/interfaces/CanvasEvents)<br/>4. [Workspace.on('editor-change') - Developers: Plugin &amp; API - Obsidian Forum](https://forum.obsidian.md/t/workspace-on-editor-change/68617)<br/>5. [List of all events? - Developers: Plugin &amp; API - Obsidian Forum](https://forum.obsidian.md/t/list-of-all-events/93218)<br/><br/>Based on the search results provided, I cannot find specific information about `workspace.on('canvas')` menu events in Obsidian.<br/><br/>The available documentation [2] discusses general Obsidian events and how to subscribe to them using `registerEvent()`, but does not provide a comprehensive list of all available workspace events or specific canvas-related menu events.<br/><br/>The search results do show that Obsidian's plugin system supports event subscriptions [2], and there is mention of context menus in the documentation structure [1], but the actual content detailing canvas menu events is not included in these results.<br/><br/>To find the specific list of canvas menu events for `workspace.on()`, you would need to:<br/>- Check the Obsidian Plugin API reference directly<br/>- Review the Obsidian TypeScript API type definitions<br/>- Consult the full Obsidian developer documentation on the official site |

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/canvasApi.ts</summary>

</details>
</tool-use>

---





---

<tool-use data-tool-type="unknown" data-tool-name="web_fetch">
<details>
<summary>Tool use: **web_fetch**</summary>


Parameters:

```json
{
  "url": "https://docs.obsidian.md/Plugins/User+interface/Context+menus"
}
```
Result:

```json
{
  "url": "https://docs.obsidian.md/Plugins/User+interface/Context+menus",
  "markdown": "Context menus - Developer Documentation\n[![](https://publish-01.obsidian.md/access/caa27d6312fe5c26ebc657cc609543be/Assets/obsidian-lockup-docs.svg)](https://docs.obsidian.md/Home)[Developer Documentation](https://docs.obsidian.md/Home)\nPlugins\nThemes\nReference\n[Developer policies](https://docs.obsidian.md/Developer+policies)\n[Home](https://docs.obsidian.md/Home)\n[![](https://publish-01.obsidian.md/access/caa27d6312fe5c26ebc657cc609543be/Assets/obsidian-lockup-docs.svg)](https://docs.obsidian.md/Home)[Developer Documentation](https://docs.obsidian.md/Home)\n# Context menus\nContext menus\nNot found\nThis page does not exist\nInteractive graph\nOn this page\n[Powered by Obsidian Publish](https://publish.obsidian.md)"
}
```
User decision: **accepted**

Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "nodes\\.push|data\\.nodes",
  "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "nodes\\.push|data\\.nodes",
    "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board": {
        "content": {
          "matches": [
            {
              "file": "src/canvas/canvasNodeLabels.ts",
              "matches": [
                {
                  "lineNumber": 154,
                  "content": "\tfor (const node of data.nodes) {"
                }
              ]
            },
            {
              "file": "src/engine/runner.ts",
              "matches": [
                {
                  "lineNumber": 37,
                  "content": "\treturn data.nodes.filter((n) =&gt; !hasIncoming.has(n.id)).map((n) =&gt; n.id);"
                },
                {
                  "lineNumber": 275,
                  "content": "\tdata.nodes.push(newTextNode);"
                },
                {
                  "lineNumber": 359,
                  "content": "\tdata.nodes = data.nodes.filter((n) =&gt; n.id !== outId);"
                }
              ]
            },
            {
              "file": "src/canvas/nodes.ts",
              "matches": [
                {
                  "lineNumber": 19,
                  "content": "\t\tif (data &amp;&amp; Array.isArray(data.nodes) &amp;&amp; Array.isArray(data.edges)) return data;"
                }
              ]
            },
            {
              "file": "src/canvas/types.ts",
              "matches": [
                {
                  "lineNumber": 63,
                  "content": "\tconst nodeMap = new Map(data.nodes.map((n) =&gt; [n.id, n]));"
                },
                {
                  "lineNumber": 82,
                  "content": "\tconst nodeMap = new Map(data.nodes.map((n) =&gt; [n.id, n]));"
                },
                {
                  "lineNumber": 95,
                  "content": "\treturn data.nodes.find((n) =&gt; n.id === id);"
                },
                {
                  "lineNumber": 137,
                  "content": "\tfor (const node of data.nodes) {"
                }
              ]
            }
          ],
          "totalLines": 9,
          "totalMatchedLines": 9
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/canvas/nodes.ts</summary>

</details>
</tool-use>

---


Checking node bounds and whether the existing output node's position is updated:


---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "outNode\\.(x|y)|getNodeById.*outId",
  "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "outNode\\.(x|y)|getNodeById.*outId",
    "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board": {
        "content": {
          "matches": [
            {
              "file": "src/engine/runner.ts",
              "matches": [
                {
                  "lineNumber": 246,
                  "content": "\t\tconst outNode = getNodeById(data, outId);"
                }
              ]
            }
          ],
          "totalLines": 1,
          "totalMatchedLines": 1
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>
</tool-use>

---


Creating the plan.


---

<tool-use data-tool-type="unknown" data-tool-name="create_plan">
<details>
<summary>Tool use: **create_plan**</summary>


Parameters:

```json
{
  "plan": "# Run entire canvas + output box collision avoidance\n\n## 1. Run entire canvas from canvas right-click\n\n### 1.1 Canvas background context menu\n\n- The plugin already uses **node** context menu via &#96;workspace.on(\"canvas:node-menu\", ...)&#96; in [src/main.ts](src/main.ts) (lines 84114). Right-click on the **canvas background** (empty area) is a different event.\n- **Approach**: Register &#96;workspace.on(\"canvas:menu\", ...)&#96; (or the equivalent Obsidian uses for canvas background menu). The event name is not clearly documented; common patterns are &#96;canvas:menu&#96; or &#96;canvas-menu&#96; with signature &#96;(menu: Menu, canvas: unknown)&#96; or &#96;(menu: Menu)&#96;.\n- If the event does not exist or has a different name, **fallback**: use &#96;registerDomEvent&#96; on the canvas views &#96;containerEl&#96; for &#96;\"contextmenu\"&#96;, and only show our menu when the event target is the canvas background (e.g. the main canvas content element, not a node). Then build a &#96;Menu&#96; and add an item \"Run entire canvas\" that calls the new run-entire-canvas handler. This must play nicely with Obsidians own canvas menu (e.g. add our item without preventing the default menu, or use the workspace event so Obsidian merges items).\n\n**Implementation**:\n\n- In [src/main.ts](src/main.ts): Register a handler for the canvas background menu (try &#96;canvas:menu&#96; / &#96;canvas-node-menu&#96; style names; add fallback DOM listener if needed). In the handler, add a menu item \"Run entire canvas\" that calls &#96;this.runEntireCanvas()&#96;.\n- Add plugin method &#96;runEntireCanvas()&#96;: get active canvas view and file path, call a new runner API &#96;runEntireCanvas(app, settings, canvasFilePath, liveCanvas)&#96;, show Notice on failure.\n\n### 1.2 Run entire canvas in the engine\n\n- Today **run chain** in [src/engine/runner.ts](src/engine/runner.ts) runs from roots **to a given node** via &#96;runChain(..., nodeId, ...)&#96; using &#96;topologicalOrderToTarget(data, nodeId)&#96;.\n- **Run entire canvas** = run all nodes that are reachable from any root, in topological order.\n- **Implementation**:\n  - In [src/engine/runner.ts](src/engine/runner.ts): Add &#96;topologicalOrderFull(data: CanvasData): string[]&#96; that builds the set of all node ids reachable from any root (union over &#96;getRootIds(data)&#96; and forward reach), then returns a topological order of that set (reuse the same in-degree / sort logic as &#96;topologicalOrderToTarget&#96; but over this full set).\n  - Add &#96;runEntireCanvas(app, settings, canvasFilePath, liveCanvas)&#96; that loads canvas data, gets &#96;order = topologicalOrderFull(data)&#96;, then runs each node in order (same loop as &#96;runChain&#96;, but without filtering to a target). Skip nodes that are not runnable (e.g. green, or no role) in the same way as today (e.g. &#96;runSingleNode&#96; already skips yellow/green). Return &#96;{ ok, message }&#96; for Notices.\n- Export &#96;runEntireCanvas&#96; and use it from main.\n\n---\n\n## 2. Collision avoidance for the output box\n\n### 2.1 Where placement happens\n\n- The green output node is created/updated in [src/engine/runner.ts](src/engine/runner.ts) in &#96;ensureOutputNodeAndEdge&#96;. Placement is currently:\n  - &#96;x = sourceNode.x&#96;\n  - &#96;y = sourceNode.y + sourceNode.height + GREEN_NODE_PADDING&#96;\n  - &#96;width = Math.max(200, sourceNode.width)&#96;, &#96;height = 100&#96;\n- Collision avoidance should only shift **x** (left/right); **y** stays as above.\n\n### 2.2 Algorithm\n\n- **Inputs**: &#96;data&#96;, &#96;sourceNode&#96;, desired &#96;y&#96;, &#96;width&#96;, &#96;height&#96;, and a **max horizontal radius** (e.g. 300400 px). Optionally a **step** (e.g. 50 px or &#96;width + 20&#96;).\n- **Candidate x positions**: &#96;[defaultX, defaultX - step, defaultX + step, defaultX - 2*step, defaultX + 2*step, ...]&#96; until &#96;|offset|&#96; exceeds max radius. Default x = &#96;sourceNode.x&#96;.\n- **Overlap check**: For each candidate &#96;(x, y, width, height)&#96;, check against every other node in &#96;data.nodes&#96; (excluding &#96;sourceNode.id&#96; and, when updating, the existing output node id). Use axis-aligned rectangle overlap: &#96;!(node.x + node.width &lt; x || x + width &lt; node.x || node.y + node.height &lt; y || y + height &lt; node.y)&#96;.\n- **Choice**: Use the first candidate position that does not overlap any other node. If none, use the default x (allow overlap).\n- **Constants**: Define e.g. &#96;OUTPUT_COLLISION_MAX_RADIUS = 400&#96; and &#96;OUTPUT_COLLISION_STEP = 60&#96; in runner or in [src/canvas/types.ts](src/canvas/types.ts) (next to &#96;GREEN_NODE_PADDING&#96;).\n\n### 2.3 Code changes\n\n- **Helper** (in runner or in [src/canvas/types.ts](src/canvas/types.ts)): &#96;function rectanglesOverlap(a: {x,y,width,height}, b: {x,y,width,height}): boolean&#96;.\n- **Helper**: &#96;function chooseOutputPosition(data: CanvasData, sourceNodeId: string, outNodeId: string | null, defaultX: number, y: number, width: number, height: number, maxRadius: number, step: number): number&#96; that returns the chosen x.\n- In &#96;ensureOutputNodeAndEdge&#96;:\n  - Compute &#96;y&#96;, &#96;width&#96;, &#96;height&#96; as now.\n  - &#96;defaultX = sourceNode.x&#96;.\n  - &#96;chosenX = chooseOutputPosition(data, sourceNode.id, outId, defaultX, y, width, height, OUTPUT_COLLISION_MAX_RADIUS, OUTPUT_COLLISION_STEP)&#96;.\n  - **New node**: use &#96;chosenX&#96; for &#96;newTextNode.x&#96;.\n  - **Existing node** (&#96;outId&#96;): set &#96;(outNode as { x: number }).x = chosenX&#96; (and keep &#96;outNode.y = y&#96; if we want to keep y in sync), so that re-runs can reposition the box when layout has changed.\n\n### 2.4 Optional: settings\n\n- You could add settings for max radius and step (e.g. under [src/settings.ts](src/settings.ts)); the plan above uses constants to keep the first version simple. Can be extended later.\n\n---\n\n## 3. Files to touch\n\n| Area | File | Changes |\n|------|------|--------|\n| Canvas menu + run entire | [src/main.ts](src/main.ts) | Register canvas background menu (event or DOM fallback), add \"Run entire canvas\" item, add &#96;runEntireCanvas()&#96; and command if desired. |\n| Engine | [src/engine/runner.ts](src/engine/runner.ts) | Export &#96;runEntireCanvas&#96;; add &#96;topologicalOrderFull&#96;; add collision helpers and use chosen x in &#96;ensureOutputNodeAndEdge&#96; (new and existing output node). |\n| Types/constants | [src/canvas/types.ts](src/canvas/types.ts) | Optional: add &#96;OUTPUT_COLLISION_MAX_RADIUS&#96;, &#96;OUTPUT_COLLISION_STEP&#96; and &#96;rectanglesOverlap&#96; (or keep these in runner). |\n\n---\n\n## 4. Diagram (run entire vs run chain)\n\n&#96;&#96;&#96;mermaid\nflowchart LR\n  subgraph menu [Context menus]\n    NodeMenu[\"Node right-click\"]\n    CanvasMenu[\"Canvas background right-click\"]\n  end\n  NodeMenu --&gt; RunNode[\"Run node\"]\n  NodeMenu --&gt; RunChain[\"Run chain to this node\"]\n  CanvasMenu --&gt; RunEntire[\"Run entire canvas\"]\n  RunEntire --&gt; TopoFull[\"topologicalOrderFull\"]\n  RunChain --&gt; TopoToTarget[\"topologicalOrderToTarget(nodeId)\"]\n  TopoFull --&gt; RunLoop[\"Run each node in order\"]\n  TopoToTarget --&gt; RunLoop\n&#96;&#96;&#96;\n\n---\n\n## 5. Testing notes\n\n- **Run entire canvas**: Open a canvas with several roots and a DAG; right-click on empty area; choose \"Run entire canvas\"; all runnable nodes should run in topological order.\n- **Collision**: Place two source nodes one above the other with similar x; run both; the second output box should shift left or right so it does not overlap the first, within the max radius. If you pack many nodes so there is no free slot within the radius, the output should still be placed (overlap allowed).\n",
  "name": "Canvas run and collision avoidance",
  "overview": "Add a \"Run entire canvas\" option to the canvas right-click (background) context menu, and implement collision avoidance for the green output box by choosing an x position left/right within a limited radius to avoid overlapping other nodes, falling back to overlap if no space is found."
}
```
Additional data:

```json
{
  "reviewData": {
    "status": "Requested",
    "selectedOption": "none",
    "isShowingInput": false
  },
  "planUri": "file:///Users/caffae/.cursor/plans/canvas_run_and_collision_avoidance_6b16b8c7.plan.md",
  "hasOpenedEditor": true
}
```
Result:

```json
{
  "rejected": {}
}
```
Status: **completed**


</details>
</tool-use>

---

_**User**_

Also give me an option within the right click on the canvas menu, to dismiss all output.

If I try to run note without running chain, automatically run chain.

---

_**Agent (model default, mode Agent)**_


Updating the plan to add "Dismiss all output" to the canvas menu and to make "Run node" auto-run the chain when parents aren't run.


---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/.cursor/plans/canvas_run_and_collision_avoidance_6b16b8c7.plan.md</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "dismissOutput|findOutputNodeForSource",
  "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "dismissOutput|findOutputNodeForSource",
    "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board": {
        "content": {
          "matches": [
            {
              "file": "src/engine/runner.ts",
              "matches": [
                {
                  "lineNumber": 4,
                  "content": "\tfindOutputNodeForSource,"
                },
                {
                  "lineNumber": 238,
                  "content": "\tconst outId = findOutputNodeForSource(data, sourceNode.id, settings);"
                },
                {
                  "lineNumber": 348,
                  "content": "export async function dismissOutput("
                },
                {
                  "lineNumber": 357,
                  "content": "\tconst outId = findOutputNodeForSource(data, sourceNodeId, settings);"
                }
              ]
            },
            {
              "file": "src/main.ts",
              "matches": [
                {
                  "lineNumber": 4,
                  "content": "import {dismissOutput as runnerDismissOutput, runChain as runnerRunChain, runNode as runnerRunNode} from \"./engine/runner\";"
                },
                {
                  "lineNumber": 97,
                  "content": "\t\t\t\t\titem.setTitle(\"Dismiss output\").setIcon(\"trash\").onClick(() =&gt; this.dismissOutput(nodeId))"
                },
                {
                  "lineNumber": 286,
                  "content": "\tasync dismissOutput(nodeId: string): Promise&lt;void&gt; {"
                }
              ]
            },
            {
              "file": "src/canvas/types.test.ts",
              "matches": [
                {
                  "lineNumber": 8,
                  "content": "\tfindOutputNodeForSource,"
                },
                {
                  "lineNumber": 190,
                  "content": "describe(\"findOutputNodeForSource\", () =&gt; {"
                },
                {
                  "lineNumber": 195,
                  "content": "\t\texpect(findOutputNodeForSource(data, \"missing\", settings)).toBeNull();"
                },
                {
                  "lineNumber": 207,
                  "content": "\t\texpect(findOutputNodeForSource(data, \"src\", settings)).toBe(\"out\");"
                },
                {
                  "lineNumber": 214,
                  "content": "\t\texpect(findOutputNodeForSource(data, \"src\", settings)).toBeNull();"
                },
                {
                  "lineNumber": 226,
                  "content": "\t\texpect(findOutputNodeForSource(data, \"src\", settings)).toBe(\"out\");"
                }
              ]
            },
            {
              "file": "src/canvas/nodes.ts",
              "matches": [
                {
                  "lineNumber": 62,
                  "content": "\tfindOutputNodeForSource,"
                }
              ]
            },
            {
              "file": "src/canvas/types.ts",
              "matches": [
                {
                  "lineNumber": 122,
                  "content": "export function findOutputNodeForSource("
                }
              ]
            }
          ],
          "totalLines": 15,
          "totalMatchedLines": 15
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---


Checking how `dismissOutput` works so we can define "dismiss all":


---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>
</tool-use>

---


Updating the plan with both additions.


---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/.cursor/plans/canvas_run_and_collision_avoidance_6b16b8c7.plan.md</summary>

</details>

</tool-use>

---





---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/.cursor/plans/canvas_run_and_collision_avoidance_6b16b8c7.plan.md</summary>

</details>

</tool-use>

---





---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/.cursor/plans/canvas_run_and_collision_avoidance_6b16b8c7.plan.md</summary>

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/.cursor/plans/canvas_run_and_collision_avoidance_6b16b8c7.plan.md</summary>

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/.cursor/plans/canvas_run_and_collision_avoidance_6b16b8c7.plan.md</summary>

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/.cursor/plans/canvas_run_and_collision_avoidance_6b16b8c7.plan.md</summary>

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/.cursor/plans/canvas_run_and_collision_avoidance_6b16b8c7.plan.md</summary>

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/.cursor/plans/canvas_run_and_collision_avoidance_6b16b8c7.plan.md</summary>

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/.cursor/plans/canvas_run_and_collision_avoidance_6b16b8c7.plan.md</summary>

</details>

</tool-use>

---





---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/.cursor/plans/canvas_run_and_collision_avoidance_6b16b8c7.plan.md</summary>

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/.cursor/plans/canvas_run_and_collision_avoidance_6b16b8c7.plan.md</summary>

</details>

</tool-use>

---


Summary of what was added to the plan:

**1. Dismiss all output (canvas right-click menu)**  
- In the canvas background context menu, add a second item: **"Dismiss all output"**.  
- It will call a new runner API `dismissAllOutput(...)` that: loads the canvas, finds every node that is the target of an edge with label `"output"`, removes those nodes and all output edges, then saves and refreshes the live canvas.  
- No per-node "Dismiss output" on the canvas menuonly this global action from the background menu.

**2. Run node  auto-run chain**  
- When the user chooses **"Run node"** on a node whose parents havent been run, the runner will **call `runChain(nodeId)`** instead of returning the "Parent node(s) have not been run yet" error.  
- Because `runChain` already runs from roots up to and including the target node, "Run node" will either run just that node (if parents are already run) or run the whole chain to that node.  
- Change is entirely in [src/engine/runner.ts](src/engine/runner.ts) inside `runNode`: when a parent has no result, return `runChain(...)` instead of `{ ok: false, message: "..." }`. No change to the node context menu or main.ts for this behavior.

The plan file has been updated with these two items, renumbered sections (Dismiss all in 1.1/1.2, Run entire canvas in 1.3, Run node auto-chain as section 2, collision as section 3), an updated diagram and files-to-touch table, and extra testing notes for "Dismiss all output" and "Run node auto-chain".

---

_**User**_

Implement the plan as specified, it is attached for your reference. Do NOT edit the plan file itself.

To-do's from the plan have already been created. Do not create them again. Mark them as in_progress as you work, starting with the first one. Don't stop until you have completed all the to-dos.

---

_**Agent (model default, mode Agent)**_





---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write**  Todo List</summary>

- [-] Canvas background menu + Run entire canvas + Dismiss all output
- [ ] Run node: auto-run chain when parents not run
- [ ] Collision avoidance for output box placement

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>
</tool-use>

---


Implementing runner changes: adding `topologicalOrderFull`, `runEntireCanvas`, and `dismissAllOutput`.


---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>

</tool-use>

---





---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>

</tool-use>

---


Adding collision avoidance: constants and helpers, then updating `ensureOutputNodeAndEdge`.


---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>

</tool-use>

---


Fixing the collision position loop: trying defaultX first, then alternating left/right by step.


---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>

</tool-use>

---


Updating main.ts: adding canvas background menu and plugin methods.


---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts</summary>

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts</summary>

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts</summary>

</details>

</tool-use>

---





---

<tool-use data-tool-type="unknown" data-tool-name="read_lints">
<details>
<summary>Tool use: **read_lints**</summary>


Parameters:

```json
{
  "paths": [
    "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts",
    "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts"
  ]
}
```
Result:

```json
{
  "linterErrorsByFile": [
    {
      "relativeWorkspacePath": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts"
    },
    {
      "relativeWorkspacePath": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts"
    }
  ]
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_command_v2">
<details><summary>Tool use: **run_terminal_command_v2**  Run command: cd /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board && npm run build</summary>

```bash
cd /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board && npm run build
```

```

&gt; zettel-thinking-board@1.0.0 build
&gt; tsc -noEmit -skipLibCheck &amp;&amp; node esbuild.config.mjs production


```
</details>
</tool-use>

---





---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_command_v2">
<details><summary>Tool use: **run_terminal_command_v2**  Run command: cd /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board && npm test</summary>

```bash
cd /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board && npm test
```

```

&gt; zettel-thinking-board@1.0.0 test
&gt; vitest run


 RUN  v1.6.1 /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board

  src/engine/state.test.ts  (7 tests) 2ms
  src/canvas/types.test.ts  (27 tests) 5ms

 Test Files  2 passed (2)
      Tests  34 passed (34)
   Start at  16:06:32
   Duration  253ms (transform 60ms, setup 0ms, collect 82ms, tests 7ms, environment 0ms, prepare 97ms)


```
</details>
</tool-use>

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write**  Todo List</summary>

- [x] Canvas background menu + Run entire canvas + Dismiss all output
- [x] Run node: auto-run chain when parents not run
- [x] Collision avoidance for output box placement

</details>
</tool-use>

---


Summary of what was implemented:

### 1. Canvas background menu (right-click on empty area)

- **main.ts**: Registered `canvas:menu` and `canvas-menu` and added two items:
  - **Run entire canvas**  `runEntireCanvas()`
  - **Dismiss all output**  `dismissAllOutput()`
- **runner.ts**:
  - **`runEntireCanvas`**: Uses new `topologicalOrderFull(data)` (all nodes reachable from any root, topologically sorted) and runs each node in order.
  - **`dismissAllOutput`**: Collects all nodes that are targets of edges with label `"output"`, removes those nodes and all output edges, then saves.

### 2. Run node  auto-run chain

- **runner.ts** `runNode`: If any parent has no result, it calls and returns `runChain(..., nodeId, liveCanvas)` instead of returning the Parent node(s) have not been run yet error. So Run node either runs the node (if parents are run) or runs the chain to that node.

### 3. Collision avoidance for the output box

- **runner.ts**:
  - **Constants**: `OUTPUT_COLLISION_MAX_RADIUS = 400`, `OUTPUT_COLLISION_STEP = 60`.
  - **`rectanglesOverlap(a, b)`**: Axis-aligned rectangle overlap.
  - **`chooseOutputPosition(...)`**: Tries `defaultX`, then `defaultX  step`, `defaultX  2*step`,  up to `maxRadius`; returns the first x that doesnt overlap any other node (excluding source and existing output node); otherwise returns `defaultX`.
  - **`ensureOutputNodeAndEdge`**: Uses `chosenX` from `chooseOutputPosition` for both new and existing output nodes; also sets `outNode.y = y` when updating an existing node.

Build and tests (34 tests) pass. If your Obsidian version doesnt fire `canvas:menu` or `canvas-menu`, the canvas background menu wont show; in that case we can add a DOM fallback (e.g. `contextmenu` on the canvas container and detect background click).

---

_**User**_

Right now, right clicking on the canvas does not have these features added. See the image for a code snippet on how to do this.

For collision avoidance, I want to have a bigger output box that will automatically shift to the right instead of only becoming smaller to avoid overlapping with other boxes. It doesn't seem to be moving.



---

_**Agent (model default, mode Agent)**_


Checking how we register the canvas menu and how collision/placement is implemented:


---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "canvas:menu|canvas-menu|addCanvasMenuItems",
  "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "canvas:menu|canvas-menu|addCanvasMenuItems",
    "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board": {
        "content": {
          "matches": [
            {
              "file": "src/main.ts",
              "matches": [
                {
                  "lineNumber": 124,
                  "content": "\t\t\tconst addCanvasMenuItems = (menu: Menu): void =&gt; {"
                },
                {
                  "lineNumber": 137,
                  "content": "\t\t\t\tthis.registerEvent(onWorkspace(\"canvas:menu\", addCanvasMenuItems));"
                },
                {
                  "lineNumber": 138,
                  "content": "\t\t\t\tthis.registerEvent(onWorkspace(\"canvas-menu\", addCanvasMenuItems));"
                }
              ]
            }
          ],
          "totalLines": 3,
          "totalMatchedLines": 3
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="web_search">
<details>
            <summary>Tool use: **web_search**  Searched web `undefined`  **1** results</summary>
        
| Title | URL | Chunk |
|-------|-----|-------|
| Web search results for query: Obsidian plugin canvas context menu empty area background canvas:menu event name |  | Links:<br/>1. [Context menus](https://docs.obsidian.md/Plugins/User+interface/Context+menus)<br/>2. [Search code, repositories, users, issues, pull requests...](https://github.com/phibr0/obsidian-extended-context-menu)<br/>3. [Search code, repositories, users, issues, pull requests...](https://github.com/michaellw/obsidian-canvas-style-menu)<br/>4. [Events - Developer Documentation](https://docs.obsidian.md/Plugins/Events)<br/>5. [Search code, repositories, users, issues, pull requests...](https://github.com/borolgs/enchanted-canvas)<br/><br/>I was unable to find specific information about the "canvas:menu" event name for empty area background context menus in Obsidian plugins based on the provided search results.<br/><br/>The search results include references to context menu documentation[1] and events documentation[4], but these pages appear to be incomplete or not found in the results. While there are several GitHub repositories related to Obsidian canvas plugins[3][5], the search results don't contain the actual code or documentation that would specify the exact event name for triggering context menus on empty canvas backgrounds.<br/><br/>To find this information, you would need to:<br/>- Check the official Obsidian API documentation directly<br/>- Review the source code of existing canvas plugins like the ones referenced[3][5]<br/>- Consult the Obsidian plugin development community or forums |

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>
</tool-use>

---





---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "workspace\\.on\\(|registerEvent.*on\\(",
  "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts",
  "contextBefore": 0,
  "contextAfter": 1,
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "workspace\\.on\\(|registerEvent.*on\\(",
    "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board": {
        "content": {
          "matches": [
            {
              "file": "src/main.ts",
              "matches": [
                {
                  "lineNumber": 90,
                  "content": "\t\t\t// Canvas node context menu (event name is undocumented; try workspace.on(\"canvas:node-menu\"))."
                },
                {
                  "lineNumber": 91,
                  "content": "\t\t\t// Defer registration so Obsidian canvas is ready (avoids \"reading '_'\" in app.js).",
                  "isContextLine": true
                },
                {
                  "lineNumber": 113,
                  "content": "\t\t\t\t\tthis.registerEvent(on(\"canvas:node-menu\", addNodeMenuItems));"
                },
                {
                  "lineNumber": 114,
                  "content": "\t\t\t\t\t// Fallback: try hyphenated name in case the app triggers a different event.",
                  "isContextLine": true
                },
                {
                  "lineNumber": 115,
                  "content": "\t\t\t\t\tthis.registerEvent(on(\"canvas-node-menu\", addNodeMenuItems));"
                },
                {
                  "lineNumber": 116,
                  "content": "\t\t\t\t} catch (e) {",
                  "isContextLine": true
                },
                {
                  "lineNumber": 163,
                  "content": "\t\t\t\tthis.app.workspace.on(\"layout-change\", () =&gt; {"
                },
                {
                  "lineNumber": 164,
                  "content": "\t\t\t\t\tconst leaves = this.app.workspace.getLeavesOfType(\"canvas\");",
                  "isContextLine": true
                },
                {
                  "lineNumber": 218,
                  "content": "\t\t\tthis.registerEvent(this.app.workspace.on(\"active-leaf-change\", runSyncLabels));"
                },
                {
                  "lineNumber": 219,
                  "content": "\t\t\trunSyncLabels();",
                  "isContextLine": true
                }
              ]
            }
          ],
          "totalLines": 10,
          "totalMatchedLines": 5
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="web_search">
<details>
            <summary>Tool use: **web_search**  Searched web `undefined`  **1** results</summary>
        
| Title | URL | Chunk |
|-------|-----|-------|
| Web search results for query: Obsidian canvas right click empty space context menu plugin registerEvent |  | Links:<br/>1. [Context menus](https://docs.obsidian.md/Plugins/User+interface/Context+menus)<br/>2. [Events - Developer Documentation](https://docs.obsidian.md/Plugins/Events)<br/>3. [Search code, repositories, users, issues, pull requests...](https://github.com/borolgs/enchanted-canvas)<br/>4. [Search code, repositories, users, issues, pull requests...](https://github.com/kzhovn/obsidian-customizable-menu)<br/>5. [Search code, repositories, users, issues, pull requests...](https://github.com/phibr0/obsidian-extended-context-menu)<br/><br/>Based on the search results, here's what's relevant to your query:<br/><br/>## registerEvent() for Event Handling<br/><br/>The `registerEvent()` method is used in Obsidian plugins to safely subscribe to events and ensure they're properly cleaned up when the plugin unloads.[2] This is the recommended approach for event registration:<br/><br/>```typescript<br/>this.registerEvent(this.app.vault.on('create', () => \{<br/>  console.log('a new file has entered the arena')<br/>\}));<br/>```<br/><br/>## Canvas Context Menus<br/><br/>Unfortunately, the official Obsidian documentation page for context menus appears to be unavailable or non-existent.[1] However, there are community plugins that demonstrate context menu implementations:<br/><br/>- **enchanted-canvas**[3] extends canvas functionality for Obsidian<br/>- **obsidian-customizable-menu**[4] allows adding commands to right-click context menus<br/>- **obsidian-extended-context-menu**[5] (archived) provided an API for creating custom context menus in the editor<br/><br/>For implementing right-click context menu functionality on canvas empty space, you would likely need to use `registerEvent()` to listen for mouse events and then dynamically create a context menu, though the specific Canvas API documentation doesn't appear to be publicly available in these results. |

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts</summary>

</details>
</tool-use>

---





---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "Menu|showAtPosition|contextmenu",
  "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/node_modules/obsidian",
  "glob": "*.d.ts",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "Menu|showAtPosition|contextmenu",
    "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/node_modules/obsidian",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board": {
        "content": {
          "matches": [
            {
              "file": "node_modules/obsidian/obsidian.d.ts",
              "matches": [
                {
                  "lineNumber": 3885,
                  "content": "export class Menu extends Component implements CloseableComponent {"
                },
                {
                  "lineNumber": 3902,
                  "content": "    setUseNativeMenu(useNativeMenu: boolean): this;"
                },
                {
                  "lineNumber": 3908,
                  "content": "    addItem(cb: (item: MenuItem) =&gt; any): this;"
                },
                {
                  "lineNumber": 3924,
                  "content": "    showAtPosition(position: MenuPositionDef, doc?: Document): this;"
                },
                {
                  "lineNumber": 3940,
                  "content": "    static forEvent(evt: PointerEvent | MouseEvent): Menu;"
                },
                {
                  "lineNumber": 3946,
                  "content": "export class MenuItem {"
                },
                {
                  "lineNumber": 3949,
                  "content": "     * Private constructor. Use {@link Menu.addItem} instead."
                },
                {
                  "lineNumber": 3974,
                  "content": "     * If set to true the MenuItem's title and icon will become red. Or whatever colour is applied to the class 'is-warning' by a theme."
                },
                {
                  "lineNumber": 4004,
                  "content": "export interface MenuPositionDef {"
                },
                {
                  "lineNumber": 4021,
                  "content": "export class MenuSeparator {"
                },
                {
                  "lineNumber": 6490,
                  "content": "     * (Replaces the previously removed &#96;onHeaderMenu&#96; and &#96;onMoreOptionsMenu&#96;)"
                },
                {
                  "lineNumber": 6494,
                  "content": "    onPaneMenu(menu: Menu, source: 'more-options' | 'tab-header' | string): void;"
                },
                {
                  "lineNumber": 6861,
                  "content": "    handleLinkContextMenu(menu: Menu, linktext: string, sourcePath: string, leaf?: WorkspaceLeaf): boolean;"
                },
                {
                  "lineNumber": 6920,
                  "content": "    on(name: 'file-menu', callback: (menu: Menu, file: TAbstractFile, source: string, leaf?: WorkspaceLeaf) =&gt; any, ctx?: any): EventRef;"
                },
                {
                  "lineNumber": 6926,
                  "content": "    on(name: 'files-menu', callback: (menu: Menu, files: TAbstractFile[], source: string, leaf?: WorkspaceLeaf) =&gt; any, ctx?: any): EventRef;"
                },
                {
                  "lineNumber": 6933,
                  "content": "    on(name: 'url-menu', callback: (menu: Menu, url: string) =&gt; any, ctx?: any): EventRef;"
                },
                {
                  "lineNumber": 6939,
                  "content": "    on(name: 'editor-menu', callback: (menu: Menu, editor: Editor, info: MarkdownView | MarkdownFileInfo) =&gt; any, ctx?: any): EventRef;"
                }
              ]
            }
          ],
          "totalLines": 17,
          "totalMatchedLines": 17
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts</summary>

</details>
</tool-use>

---





---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "canvas|Canvas",
  "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/node_modules/obsidian/obsidian.d.ts",
  "contextBefore": 0,
  "contextAfter": 0,
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "canvas|Canvas",
    "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/node_modules/obsidian/obsidian.d.ts",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board": {
        "content": {}
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/node_modules/obsidian/obsidian.d.ts</summary>

</details>
</tool-use>

---





---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "forEvent|showAtMouseEvent",
  "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/node_modules/obsidian",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "forEvent|showAtMouseEvent",
    "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/node_modules/obsidian",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board": {
        "content": {
          "matches": [
            {
              "file": "node_modules/obsidian/obsidian.d.ts",
              "matches": [
                {
                  "lineNumber": 3919,
                  "content": "    showAtMouseEvent(evt: MouseEvent): this;"
                },
                {
                  "lineNumber": 3940,
                  "content": "    static forEvent(evt: PointerEvent | MouseEvent): Menu;"
                }
              ]
            }
          ],
          "totalLines": 2,
          "totalMatchedLines": 2
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="web_search">
<details>
            <summary>Tool use: **web_search**  Searched web `undefined`  **1** results</summary>
        
| Title | URL | Chunk |
|-------|-----|-------|
| Web search results for query: Obsidian canvas node class name DOM element |  | Links:<br/>1. [Search code, repositories, users, issues, pull requests...](https://github.com/Mara-Li/obsidian-canvas-css-class)<br/>2. [Search code, repositories, users, issues, pull requests...](https://github.com/obsidianmd/obsidian-api/blob/master/canvas.d.ts)<br/>3. [Search code, repositories, users, issues, pull requests...](https://github.com/shahriarkh/obsidian-canvas-snippets)<br/>4. [HTML elements](https://docs.obsidian.md/Plugins/User+interface/HTML+elements)<br/>5. [Search code, repositories, users, issues, pull requests...](https://github.com/robertttbs/obsidian-enhanced-canvas)<br/><br/># Obsidian Canvas Node Class Name DOM Element<br/><br/>The search results don't contain specific information about the exact DOM class name for Obsidian canvas nodes. However, the results point to relevant resources:<br/><br/>**Official API Reference**: The Obsidian API defines canvas nodes through TypeScript interfaces like `CanvasNodeData` and its subtypes (`CanvasFileData`, `CanvasTextData`, `CanvasLinkData`, `CanvasGroupData`), but these are data structures rather than DOM class names.[2]<br/><br/>**Plugin Development Resources**: There's a plugin called "obsidian-canvas-css-class" that specifically adds CSS classes to canvas elements for personalization purposes.[1] This suggests that canvas nodes can be targeted with CSS classes, though the specific default class names aren't detailed in the excerpts provided.<br/><br/>**General HTML Elements**: Obsidian's developer documentation explains that HTML elements in plugins use the `cls` property to set CSS classes when creating elements with `createEl()`.[4]<br/><br/>To find the exact DOM class name for canvas nodes, you would need to inspect the canvas element directly in the browser's developer tools or consult the Obsidian plugin development community forums, as this specific detail isn't covered in these search results. |

</details>
</tool-use>

---


Checking how the canvas view is structured in the codebase and implementing the DOM fallback.


---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "containerEl|canvas",
  "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/canvas",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "containerEl|canvas",
    "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/canvas",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board": {
        "content": {
          "matches": [
            {
              "file": "src/canvas/canvasNodeLabels.ts",
              "matches": [
                {
                  "lineNumber": 6,
                  "content": "import type {LiveCanvas} from \"../engine/canvasApi\";"
                },
                {
                  "lineNumber": 11,
                  "content": "const LEGEND_CLASS = \"ztb-canvas-legend\";"
                },
                {
                  "lineNumber": 19,
                  "content": "/** Try to get a canvas node's root DOM element from the live canvas (Obsidian uses .canvas-node, no data-id). */"
                },
                {
                  "lineNumber": 20,
                  "content": "function getNodeElFromCanvas(canvas: LiveCanvas, nodeId: string): HTMLElement | null {"
                },
                {
                  "lineNumber": 21,
                  "content": "\tconst nodes = canvas.nodes;"
                },
                {
                  "lineNumber": 28,
                  "content": "\t\tcontainerEl?: HTMLElement;"
                },
                {
                  "lineNumber": 41,
                  "content": "\t// Obsidian canvas node view exposes the .canvas-node root via one of these"
                },
                {
                  "lineNumber": 45,
                  "content": "\tif (view.containerEl instanceof HTMLElement) return view.containerEl;"
                },
                {
                  "lineNumber": 51,
                  "content": "function findNodeElementByDataId(containerEl: HTMLElement, nodeId: string): HTMLElement | null {"
                },
                {
                  "lineNumber": 52,
                  "content": "\tconst el = containerEl.querySelector(&#96;.canvas-node[data-id=\"${nodeId}\"], [data-id=\"${nodeId}\"]&#96;);"
                },
                {
                  "lineNumber": 57,
                  "content": "export function clearCanvasRoleLabels(containerEl: HTMLElement): void {"
                },
                {
                  "lineNumber": 58,
                  "content": "\tcontainerEl.querySelectorAll(&#96;.${LABEL_CLASS}&#96;).forEach((el) =&gt; el.remove());"
                },
                {
                  "lineNumber": 61,
                  "content": "/** Remove the canvas legend from the container. */"
                },
                {
                  "lineNumber": 62,
                  "content": "export function clearCanvasLegend(containerEl: HTMLElement): void {"
                },
                {
                  "lineNumber": 63,
                  "content": "\tcontainerEl.querySelectorAll(&#96;.${LEGEND_CLASS}&#96;).forEach((el) =&gt; el.remove());"
                },
                {
                  "lineNumber": 67,
                  "content": "export function clearCanvasEdgeModeLabels(containerEl: HTMLElement): void {"
                },
                {
                  "lineNumber": 68,
                  "content": "\tcontainerEl.querySelectorAll(&#96;.${EDGE_MODE_LABEL_CLASS}&#96;).forEach((el) =&gt; el.remove());"
                },
                {
                  "lineNumber": 84,
                  "content": "/** Build and append the color legend to the canvas container (vanilla DOM, no innerHTML). */"
                },
                {
                  "lineNumber": 85,
                  "content": "function syncCanvasLegend(containerEl: HTMLElement, settings: ZettelPluginSettings): void {"
                },
                {
                  "lineNumber": 86,
                  "content": "\tclearCanvasLegend(containerEl);"
                },
                {
                  "lineNumber": 117,
                  "content": "\tcontainerEl.appendChild(legend);"
                },
                {
                  "lineNumber": 120,
                  "content": "/** Create a label element using Obsidian's canvas-node-label class (same as file nodes). */"
                },
                {
                  "lineNumber": 123,
                  "content": "\tel.setAttribute(\"class\", &#96;${LABEL_CLASS} canvas-node-label&#96;);"
                },
                {
                  "lineNumber": 130,
                  "content": " * Sync floating role labels for the active canvas: for each node whose color maps to a role,"
                },
                {
                  "lineNumber": 132,
                  "content": " * Uses the live canvas node map to find each node's DOM element (.canvas-node)."
                },
                {
                  "lineNumber": 133,
                  "content": " * @param isStillActive - if provided, called after async load; when false we skip applying to avoid stale canvas"
                },
                {
                  "lineNumber": 137,
                  "content": "\tcanvasFilePath: string,"
                },
                {
                  "lineNumber": 138,
                  "content": "\tcontainerEl: HTMLElement,"
                },
                {
                  "lineNumber": 140,
                  "content": "\tcanvas: LiveCanvas | null,"
                },
                {
                  "lineNumber": 144,
                  "content": "\t\tclearCanvasRoleLabels(containerEl);"
                },
                {
                  "lineNumber": 145,
                  "content": "\t\tclearCanvasLegend(containerEl);"
                },
                {
                  "lineNumber": 148,
                  "content": "\tconst data = await loadCanvasData(vault, canvasFilePath);"
                },
                {
                  "lineNumber": 151,
                  "content": "\t\tclearCanvasRoleLabels(containerEl);"
                },
                {
                  "lineNumber": 152,
                  "content": "\t\tclearCanvasLegend(containerEl);"
                },
                {
                  "lineNumber": 155,
                  "content": "\tclearCanvasRoleLabels(containerEl);"
                },
                {
                  "lineNumber": 156,
                  "content": "\tsyncCanvasLegend(containerEl, settings);"
                },
                {
                  "lineNumber": 162,
                  "content": "\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, node.id)) ||"
                },
                {
                  "lineNumber": 163,
                  "content": "\t\t\tfindNodeElementByDataId(containerEl, node.id);"
                },
                {
                  "lineNumber": 166,
                  "content": "\t\t// Append after .canvas-node-container so it matches Obsidian file node label position"
                },
                {
                  "lineNumber": 180,
                  "content": " * Labels are appended to the source node so they move with the canvas when panning/zooming."
                },
                {
                  "lineNumber": 181,
                  "content": " * @param isStillActive - if provided, called after async load; when false we skip applying to avoid stale canvas"
                },
                {
                  "lineNumber": 185,
                  "content": "\tcanvasFilePath: string,"
                },
                {
                  "lineNumber": 186,
                  "content": "\tcontainerEl: HTMLElement,"
                },
                {
                  "lineNumber": 187,
                  "content": "\tcanvas: LiveCanvas | null,"
                },
                {
                  "lineNumber": 190,
                  "content": "\tclearCanvasEdgeModeLabels(containerEl);"
                },
                {
                  "lineNumber": 191,
                  "content": "\tconst data = await loadCanvasData(vault, canvasFilePath);"
                },
                {
                  "lineNumber": 194,
                  "content": "\tconst canvasKey = getCanvasKey(canvasFilePath);"
                },
                {
                  "lineNumber": 195,
                  "content": "\tconst runningNodeId = getRunningNodeId(canvasKey);"
                },
                {
                  "lineNumber": 199,
                  "content": "\t\tconst mode = getEdgeMode(canvasKey, edge.id);"
                },
                {
                  "lineNumber": 209,
                  "content": "\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, edge.fromNode)) ||"
                },
                {
                  "lineNumber": 210,
                  "content": "\t\t\tfindNodeElementByDataId(containerEl, edge.fromNode);"
                },
                {
                  "lineNumber": 212,
                  "content": "\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, edge.toNode)) ||"
                },
                {
                  "lineNumber": 213,
                  "content": "\t\t\tfindNodeElementByDataId(containerEl, edge.toNode);"
                },
                {
                  "lineNumber": 220,
                  "content": "\t\t// Position relative to the source node so the label moves with the canvas when panning/zooming"
                }
              ]
            },
            {
              "file": "src/canvas/nodes.ts",
              "matches": [
                {
                  "lineNumber": 2,
                  "content": "import type {AllCanvasNodeData, CanvasData, CanvasFileData, CanvasTextData} from \"obsidian/canvas\";"
                },
                {
                  "lineNumber": 14,
                  "content": "/** Load canvas data from vault by reading the canvas file (JSON). */"
                },
                {
                  "lineNumber": 26,
                  "content": "/** Save canvas data to vault (writes the canvas file). */"
                }
              ]
            },
            {
              "file": "src/canvas/types.ts",
              "matches": [
                {
                  "lineNumber": 8,
                  "content": "} from \"obsidian/canvas\";"
                },
                {
                  "lineNumber": 93,
                  "content": "/** Get node by id from canvas data. */"
                }
              ]
            }
          ],
          "totalLines": 59,
          "totalMatchedLines": 59
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---


Implementing both fixes: adding a DOM fallback for the canvas background menu (matching the image's pattern) and fixing collision avoidance (larger output box, try right first, ensure position is applied).


---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write**  Todo List</summary>

- [-] Canvas background menu DOM fallback (right-click empty area)
- [ ] Collision: bigger output box, prefer shift right, ensure position applied
- [x] Collision avoidance for output box placement

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/canvas/canvasNodeLabels.ts</summary>

</details>
</tool-use>

---





---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts</summary>

</details>

</tool-use>

---


Using Menu.forEvent(evt) so the menu shows at the cursor, and showing it after adding items.


---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts</summary>

</details>

</tool-use>

---


Implementing collision changes: larger output box and prefer shifting right.


---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>

</tool-use>

---


Forcing the canvas to pick up new positions by replacing the output node with a new object so the view detects the change:


---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>
</tool-use>

---


Replacing the existing output node with a new object so the canvas view detects the position change.


---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>

</tool-use>

---


Applying the larger size when updating an existing output node.


---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>

</tool-use>

---





---

<tool-use data-tool-type="unknown" data-tool-name="read_lints">
<details>
<summary>Tool use: **read_lints**</summary>


Parameters:

```json
{
  "paths": [
    "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts",
    "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts"
  ]
}
```
Result:

```json
{
  "linterErrorsByFile": [
    {
      "relativeWorkspacePath": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts"
    },
    {
      "relativeWorkspacePath": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts"
    }
  ]
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_command_v2">
<details><summary>Tool use: **run_terminal_command_v2**  Run command: cd /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board && npm run build && npm test</summary>

```bash
cd /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board && npm run build && npm test
```

```

&gt; zettel-thinking-board@1.0.0 build
&gt; tsc -noEmit -skipLibCheck &amp;&amp; node esbuild.config.mjs production


&gt; zettel-thinking-board@1.0.0 test
&gt; vitest run


 RUN  v1.6.1 /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board

  src/engine/state.test.ts  (7 tests) 2ms
  src/canvas/types.test.ts  (27 tests) 5ms

 Test Files  2 passed (2)
      Tests  34 passed (34)
   Start at  16:13:45
   Duration  274ms (transform 70ms, setup 0ms, collect 90ms, tests 7ms, environment 0ms, prepare 106ms)


```
</details>
</tool-use>

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write**  Todo List</summary>

- [x] Canvas background menu DOM fallback (right-click empty area)
- [x] Collision: bigger output box, prefer shift right, ensure position applied
- [x] Collision avoidance for output box placement

</details>
</tool-use>

---


Summary of what was implemented:

### 1. Canvas right-click menu (background)

Obsidian doesnt expose a documented event for the canvas background context menu, so a **DOM fallback** was added using the same pattern as in your image (`menu.addItem`, `setTitle`, `setIcon`, `onClick`):

- **`main.ts`**: A `contextmenu` listener is registered on `document`. When the active view is a canvas and the target is **not** inside an element with class `.canvas-node`, the handler:
  - Calls `evt.preventDefault()` so the default menu doesnt show.
  - Builds a menu with `Menu.forEvent(evt)`, adds Run entire canvas and Dismiss all output, then calls `menu.showAtMouseEvent(evt)`.

Right-clicking on empty canvas space (not on a node) now shows only these two items. Right-clicking on a node still uses the existing node menu (Run node, Run chain, Dismiss output).

### 2. Collision avoidance and output box behavior

- **Larger output box**: Default size is now **320180** (was 200100), with width at least `max(320, sourceNode.width)`.
- **Prefer shifting right**: Candidate order is now: default x, then **right** (`defaultX + step`), then left (`defaultX - step`), then `defaultX + 2*step`, etc., so the box moves right first when avoiding overlap.
- **Larger search radius**: Max offset is **500px** and step **80px** so a non-overlapping position is more likely to be found.
- **Position actually applied**: When updating an **existing** output node, the code now **replaces** that node in `data.nodes` with a new object that has the chosen `x`, `y`, `width`, and `height`. That forces the canvas to treat it as updated so the new position and size are applied; in-place mutation of `x`/`y` was likely being ignored by the view.

Build and tests pass. After reloading the plugin, right-click on empty canvas area to use Run entire canvas and Dismiss all output, and run nodes to see the larger, right-shifted output boxes when theres overlap.

---

_**User**_

You need to use canvas:edge-menu to expose the canvas background context menu.

Based on the code snippet and the context from the Obsidian Forum, here is the explanation of why this works.

### The Short Answer
This code works because it hooks into an **undocumented (internal) event** emitted by Obsidian's core Canvas plugin.

Even though TypeScript flags the code with a red error line (because the event isn't in the official API definitions), the underlying JavaScript engine in Obsidian successfully broadcasts and listens for the string `"canvas:edge-menu"`.

---

### Detailed Breakdown

Here is a line-by-line explanation of the mechanics:

**1. The "Magic" String: `"canvas:edge-menu"`**
*   **The Error:** You see a red squiggly line under `"canvas:edge-menu"` because the official Obsidian API type definitions (`obsidian.d.ts`) do not list this as a valid event. TypeScript thinks you are making a mistake.
*   **The Reality:** Obsidian's workspace relies on an event emitter system. When you right-click a connection line (an "edge") in a Canvas, the Obsidian app internally broadcasts an event named `"canvas:edge-menu"`.
*   **The Hook:** By passing that exact string to `this.app.workspace.on`, your plugin starts listening for that specific broadcast, regardless of whether TypeScript knows it exists.

**2. `this.registerEvent(...)`**
*   This is standard Obsidian plugin housekeeping. It ensures that when you disable or unload your plugin, this specific event listener is killed. If you didn't wrap it in this, the listener would keep running even after the plugin was turned off, leading to memory leaks and errors.

**3. `(menu: Menu, edge: any)`**
*   When the event fires, Obsidian passes two arguments to your function:
    *   **`menu`**: The actual popup context menu object. This allows you to append your own buttons to the list.
    *   **`edge`**: The data object representing the specific line/connection you clicked on. (It is typed as `any` here because, again, there is no official public type for a Canvas Edge yet).

**4. `menu.addItem(...)`**
*   This uses the standard public API to inject a new clickable option ("What ever you want to do") with an icon ("dice") into that menu.

### Summary
This code is essentially a "hack" that exploits how JavaScript works. It ignores the safety checks of TypeScript to listen for a signal that the developers of Obsidian created for their own internal use but haven't publicly documented yet.

**Note:** Because this uses an undocumented event, there is a risk that this code could stop working in a future update of Obsidian if the developers decide to rename that event string (e.g., to `"canvas:connection-menu"`).

---

_**Agent (model default, mode Agent)**_


Registering for the undocumented `canvas:edge-menu` and adding our items when it's a background click (edge is null). Checking the current registration and adding it.


---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts</summary>

</details>
</tool-use>

---


Registering the undocumented `canvas:edge-menu` and adding our items only when it's a background click (edge is null). Removing the DOM fallback so we don't double-handle.


---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts</summary>

</details>

</tool-use>

---


Verifying build and adding the DOM fallback so we still show the menu if `canvas:edge-menu` fires only for edges (edge never null):


---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_command_v2">
<details><summary>Tool use: **run_terminal_command_v2**  Run command: cd /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board && npm run build</summary>

```bash
cd /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board && npm run build
```

```

&gt; zettel-thinking-board@1.0.0 build
&gt; tsc -noEmit -skipLibCheck &amp;&amp; node esbuild.config.mjs production


```
</details>
</tool-use>

---


Summary of changes:

### Switched to undocumented `canvas:edge-menu`

- **Removed** the previous `canvas:menu` / `canvas-menu` registrations and the DOM `contextmenu` fallback.
- **Registered** the undocumented event **`canvas:edge-menu`** via `this.app.workspace.on("canvas:edge-menu", ...)` and wrapped it in `this.registerEvent(...)` so the listener is removed when the plugin unloads.
- **Callback** `(menu: Menu, edge: unknown) => { ... }`: when **`edge == null`** we treat it as a canvas background click and add our items with `menu.addItem(...)` (same pattern as in your snippet: `setTitle`, `setIcon`, `onClick`).
- **Typing**: The handler is typed as `(menu: Menu, edge: unknown) => void` so we dont rely on official types for this internal event.

So we only add Run entire canvas and Dismiss all output when the event is fired with no edge (background). If your Obsidian build fires `canvas:edge-menu` for background with a non-null value, we can change the condition (e.g. always add the items, or use a different check). Build completes successfully.

---

_**User**_

I am still unable to see the options when I right-click on the background. So how about we explore other ways to put a button onto the screen that I can click, like adding onto the existing canvas controls? 

---

_**Agent (model default, mode Agent)**_


Exploring how the canvas view is structured and where we can add buttons to the canvas controls.


---

<tool-use data-tool-type="unknown" data-tool-name="semantic_search_full">
<details>
<summary>Tool use: **semantic_search_full**</summary>


Parameters:

```json
{
  "query": "Where does the plugin add UI to the canvas view or container?",
  "includePattern": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
  "topK": 10,
  "explanation": ""
}
```
Result:

```json
{
  "codeResults": [
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 28,
            "column": 1
          },
          "endPosition": {
            "line": 347,
            "column": 1
          }
        },
        "contents": "/** Debug: set to true when canvas:node-menu callback has fired at least once (proves event is received). */\nlet debugNodeMenuFired = false;\n\nexport default class ZettelThinkingBoardPlugin extends Plugin {\n\tsettings: ZettelPluginSettings;\n\n\tasync onload() {\n\t\ttry {\n\t\t\tawait this.loadSettings();\n\t\t\tthis.addSettingTab(new ZettelSettingTab(this.app, this));\n\n\t\t\tthis.registerView(\n\t\t\t\tZETTEL_CONTROLS_VIEW_TYPE,\n\t\t\t\t(leaf: WorkspaceLeaf) =&gt; new ZettelControlsView(leaf, this)\n\t\t\t);\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"open-zettel-controls\",\n\t\t\t\tname: \"Open Zettel Controls\",\n\t\t\t\tcallback: () =&gt; this.activateZettelControls(),\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"run-node\",\n\t\t\t\tname: \"Run node\",\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\t\tif (!view) return false;\n\t\t\t\t\tif (checking) return true;\n\t\t\t\t\t// Command palette: no node selected; prompt user to use context menu\n\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Run node\\\" to run it.\");\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"run-chain\",\n\t\t\t\tname: \"Run chain\",\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\t\tif (!view) return false;\n\t\t\t\t\tif (checking) return true;\n\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Run chain\\\" to run from roots.\");\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"dismiss-output\",\n\t\t\t\tname: \"Dismiss output\",\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\t\tif (!view) return false;\n\t\t\t\t\tif (checking) return true;\n\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Dismiss output\\\" to remove its output.\");\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\t// Canvas node context menu (event name is undocumented; try workspace.on(\"canvas:node-menu\")).\n\t}\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Debug: set to true when canvas:node-menu callback has fired at least once (proves event is received). */",
            "lineNumber": 31
          },
          {
            "text": "let debugNodeMenuFired = false;",
            "lineNumber": 32
          },
          {
            "lineNumber": 33
          },
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 34,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings;",
            "lineNumber": 35
          },
          {
            "lineNumber": 36
          },
          {
            "text": "\tasync onload() {",
            "lineNumber": 37
          },
          {
            "text": "\t\ttry {",
            "lineNumber": 38
          },
          {
            "text": "\t\t\tawait this.loadSettings();",
            "lineNumber": 39
          },
          {
            "text": "\t\t\tthis.addSettingTab(new ZettelSettingTab(this.app, this));",
            "lineNumber": 40
          },
          {
            "lineNumber": 41
          },
          {
            "text": "\t\t\tthis.registerView(",
            "lineNumber": 42
          },
          {
            "text": "\t\t\t\tZETTEL_CONTROLS_VIEW_TYPE,",
            "lineNumber": 43
          },
          {
            "text": "\t\t\t\t(leaf: WorkspaceLeaf) =&gt; new ZettelControlsView(leaf, this)",
            "lineNumber": 44
          },
          {
            "text": "\t\t\t);",
            "lineNumber": 45
          },
          {
            "lineNumber": 46
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 47
          },
          {
            "text": "\t\t\t\tid: \"open-zettel-controls\",",
            "lineNumber": 48
          },
          {
            "text": "\t\t\t\tname: \"Open Zettel Controls\",",
            "lineNumber": 49
          },
          {
            "text": "\t\t\t\tcallback: () =&gt; this.activateZettelControls(),",
            "lineNumber": 50
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 51
          },
          {
            "lineNumber": 52
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 53
          },
          {
            "text": "\t\t\t\tid: \"run-node\",",
            "lineNumber": 54
          },
          {
            "text": "\t\t\t\tname: \"Run node\",",
            "lineNumber": 55
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 56
          },
          {
            "text": "\t\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 57
          },
          {
            "text": "\t\t\t\t\tif (!view) return false;",
            "lineNumber": 58
          },
          {
            "text": "\t\t\t\t\tif (checking) return true;",
            "lineNumber": 59
          },
          {
            "text": "\t\t\t\t\t// Command palette: no node selected; prompt user to use context menu",
            "lineNumber": 60
          },
          {
            "text": "\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Run node\\\" to run it.\");",
            "lineNumber": 61
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 62
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 63
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 64
          },
          {
            "lineNumber": 65
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 66
          },
          {
            "text": "\t\t\t\tid: \"run-chain\",",
            "lineNumber": 67
          },
          {
            "text": "\t\t\t\tname: \"Run chain\",",
            "lineNumber": 68
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 69
          },
          {
            "text": "\t\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 70
          },
          {
            "text": "\t\t\t\t\tif (!view) return false;",
            "lineNumber": 71
          },
          {
            "text": "\t\t\t\t\tif (checking) return true;",
            "lineNumber": 72
          },
          {
            "text": "\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Run chain\\\" to run from roots.\");",
            "lineNumber": 73
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 74
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 75
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 76
          },
          {
            "lineNumber": 77
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 78
          },
          {
            "text": "\t\t\t\tid: \"dismiss-output\",",
            "lineNumber": 79
          },
          {
            "text": "\t\t\t\tname: \"Dismiss output\",",
            "lineNumber": 80
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 81
          },
          {
            "text": "\t\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 82
          },
          {
            "text": "\t\t\t\t\tif (!view) return false;",
            "lineNumber": 83
          },
          {
            "text": "\t\t\t\t\tif (checking) return true;",
            "lineNumber": 84
          },
          {
            "text": "\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Dismiss output\\\" to remove its output.\");",
            "lineNumber": 85
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 86
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 87
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 88
          },
          {
            "lineNumber": 89
          },
          {
            "text": "\t\t\t// Canvas node context menu (event name is undocumented; try workspace.on(\"canvas:node-menu\")).",
            "lineNumber": 90
          },
          {
            "text": "\t}",
            "lineNumber": 228
          },
          {
            "text": "}",
            "lineNumber": 348,
            "isSignature": true
          }
        ]
      },
      "score": 0.41275715827941895
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 33
          },
          "endPosition": {
            "line": 347,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\nasync onload() {\n\n\t\t\ttry {\n\t\t\t\tconst onWorkspace = this.app.workspace.on.bind(this.app.workspace) as (\n\t\t\t\t\tname: string,\n\t\t\t\t\tcallback: (menu: Menu, edge: unknown) =&gt; void\n\t\t\t\t) =&gt; ReturnType&lt;typeof this.app.workspace.on&gt;;\n\t\t\t\tthis.registerEvent(\n\t\t\t\t\tonWorkspace(\"canvas:edge-menu\", (menu: Menu, edge: unknown) =&gt; {\n\t\t\t\t\t\tif (edge == null) addCanvasMenuItems(menu);\n\t\t\t\t\t})\n\t\t\t\t);\n\t\t\t} catch (e) {\n\t\t\t\tconsole.error(\"Zettel Thinking Board: could not register canvas background menu.\", e);\n\t\t\t}\n\n\t\t\t// Debug: command to test if we can affect the canvas and if canvas:node-menu ever fires.\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"zettel-debug-canvas-hook\",\n\t\t\t\tname: \"Debug canvas hook\",\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tif (checking) return true;\n\t\t\t\t\tconst canvasActive = this.getActiveCanvasView() != null;\n\t\t\t\t\tconst msg =\n\t\t\t\t\t\t\"Canvas active: \" +\n\t\t\t\t\t\t(canvasActive ? \"yes\" : \"no (focus a canvas first)\") +\n\t\t\t\t\t\t\". Node menu ever fired: \" +\n\t\t\t\t\t\t(debugNodeMenuFired ? \"yes\" : \"no (right-click a node to test).\");\n\t\t\t\t\tnew Notice(msg);\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\t// Terminate kernel when a canvas is closed (one kernel per canvas)\n\t\t\tlet previousCanvasPaths = new Set&lt;string&gt;();\n\t\t\tthis.registerEvent(\n\t\t\t\tthis.app.workspace.on(\"layout-change\", () =&gt; {\n\t\t\t\t\tconst leaves = this.app.workspace.getLeavesOfType(\"canvas\");\n\t\t\t\t\tconst openPaths = new Set&lt;string&gt;();\n\t\t\t\t\tfor (const leaf of leaves) {\n\t\t\t\t\t\tconst v = leaf.view as { file?: { path: string } };\n\t\t\t\t\t\tif (v?.file?.path) openPaths.add(v.file.path);\n\t\t\t\t\t}\n\t\t\t\t\tfor (const path of previousCanvasPaths) {\n\t\t\t\t\t\tif (!openPaths.has(path)) terminateKernel(path);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 34,
                "column": 1
              },
              "endPosition": {
                "line": 34,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 34,
                "column": 16
              },
              "endPosition": {
                "line": 35,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 37,
                "column": 2
              },
              "endPosition": {
                "line": 38,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 34,
            "isSignature": true
          },
          {
            "text": "async onload() {",
            "lineNumber": 37
          },
          {
            "lineNumber": 132
          },
          {
            "text": "\t\t\ttry {",
            "lineNumber": 133
          },
          {
            "text": "\t\t\t\tconst onWorkspace = this.app.workspace.on.bind(this.app.workspace) as (",
            "lineNumber": 134
          },
          {
            "text": "\t\t\t\t\tname: string,",
            "lineNumber": 135
          },
          {
            "text": "\t\t\t\t\tcallback: (menu: Menu, edge: unknown) =&gt; void",
            "lineNumber": 136
          },
          {
            "text": "\t\t\t\t) =&gt; ReturnType&lt;typeof this.app.workspace.on&gt;;",
            "lineNumber": 137
          },
          {
            "text": "\t\t\t\tthis.registerEvent(",
            "lineNumber": 138
          },
          {
            "text": "\t\t\t\t\tonWorkspace(\"canvas:edge-menu\", (menu: Menu, edge: unknown) =&gt; {",
            "lineNumber": 139
          },
          {
            "text": "\t\t\t\t\t\tif (edge == null) addCanvasMenuItems(menu);",
            "lineNumber": 140
          },
          {
            "text": "\t\t\t\t\t})",
            "lineNumber": 141
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 142
          },
          {
            "text": "\t\t\t} catch (e) {",
            "lineNumber": 143
          },
          {
            "text": "\t\t\t\tconsole.error(\"Zettel Thinking Board: could not register canvas background menu.\", e);",
            "lineNumber": 144
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 145
          },
          {
            "lineNumber": 146
          },
          {
            "text": "\t\t\t// Debug: command to test if we can affect the canvas and if canvas:node-menu ever fires.",
            "lineNumber": 147
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 148
          },
          {
            "text": "\t\t\t\tid: \"zettel-debug-canvas-hook\",",
            "lineNumber": 149
          },
          {
            "text": "\t\t\t\tname: \"Debug canvas hook\",",
            "lineNumber": 150
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 151
          },
          {
            "text": "\t\t\t\t\tif (checking) return true;",
            "lineNumber": 152
          },
          {
            "text": "\t\t\t\t\tconst canvasActive = this.getActiveCanvasView() != null;",
            "lineNumber": 153
          },
          {
            "text": "\t\t\t\t\tconst msg =",
            "lineNumber": 154
          },
          {
            "text": "\t\t\t\t\t\t\"Canvas active: \" +",
            "lineNumber": 155
          },
          {
            "text": "\t\t\t\t\t\t(canvasActive ? \"yes\" : \"no (focus a canvas first)\") +",
            "lineNumber": 156
          },
          {
            "text": "\t\t\t\t\t\t\". Node menu ever fired: \" +",
            "lineNumber": 157
          },
          {
            "text": "\t\t\t\t\t\t(debugNodeMenuFired ? \"yes\" : \"no (right-click a node to test).\");",
            "lineNumber": 158
          },
          {
            "text": "\t\t\t\t\tnew Notice(msg);",
            "lineNumber": 159
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 160
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 161
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 162
          },
          {
            "lineNumber": 163
          },
          {
            "text": "\t\t\t// Terminate kernel when a canvas is closed (one kernel per canvas)",
            "lineNumber": 164
          },
          {
            "text": "\t\t\tlet previousCanvasPaths = new Set&lt;string&gt;();",
            "lineNumber": 165
          },
          {
            "text": "\t\t\tthis.registerEvent(",
            "lineNumber": 166
          },
          {
            "text": "\t\t\t\tthis.app.workspace.on(\"layout-change\", () =&gt; {",
            "lineNumber": 167
          },
          {
            "text": "\t\t\t\t\tconst leaves = this.app.workspace.getLeavesOfType(\"canvas\");",
            "lineNumber": 168
          },
          {
            "text": "\t\t\t\t\tconst openPaths = new Set&lt;string&gt;();",
            "lineNumber": 169
          },
          {
            "text": "\t\t\t\t\tfor (const leaf of leaves) {",
            "lineNumber": 170
          },
          {
            "text": "\t\t\t\t\t\tconst v = leaf.view as { file?: { path: string } };",
            "lineNumber": 171
          },
          {
            "text": "\t\t\t\t\t\tif (v?.file?.path) openPaths.add(v.file.path);",
            "lineNumber": 172
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 173
          },
          {
            "text": "\t\t\t\t\tfor (const path of previousCanvasPaths) {",
            "lineNumber": 174
          },
          {
            "text": "\t\t\t\t\t\tif (!openPaths.has(path)) terminateKernel(path);",
            "lineNumber": 175
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 176
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 178
          },
          {
            "lineNumber": 179
          },
          {
            "text": "\t}",
            "lineNumber": 228
          },
          {
            "text": "}",
            "lineNumber": 348,
            "isSignature": true
          }
        ]
      },
      "score": 0.3986692428588867
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 33
          },
          "endPosition": {
            "line": 347,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\ngetActiveCanvasView(): { canvas: unknown; file: { path: string }; containerEl: HTMLElement } | null {\nconst v = \n\n\t\t\tfile?: { path: string };\n\t\t\tcontainerEl?: HTMLElement;\n\t\t};\n\t\tif (v.getViewType?.() !== \"canvas\") return null;\n\t\tif (v.canvas == null || v.file == null || !v.containerEl) return null;\n\t\treturn { canvas: v.canvas, file: v.file, containerEl: v.containerEl };\n\t}\n\n\t/**\n\t * Returns the active canvas view, or the first open canvas if the active leaf is not a canvas.\n\t * Use this when the user may be focused on the control panel (e.g. Restart kernel button).\n\t */\n\tgetActiveOrFirstCanvasView(): { canvas: unknown; file: { path: string }; containerEl: HTMLElement } | null {\n\t\tconst active = this.getActiveCanvasView();\n\t\tif (active) return active;\n\t\tconst leaves = this.app.workspace.getLeavesOfType(\"canvas\");\n\t\tconst leaf = leaves[0];\n\t\tif (!leaf?.view) return null;\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 34,
                "column": 1
              },
              "endPosition": {
                "line": 34,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 34,
                "column": 16
              },
              "endPosition": {
                "line": 35,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 34,
            "isSignature": true
          },
          {
            "text": "getActiveCanvasView(): { canvas: unknown; file: { path: string }; containerEl: HTMLElement } | null {",
            "lineNumber": 264
          },
          {
            "text": "const v = ",
            "lineNumber": 267
          },
          {
            "lineNumber": 269
          },
          {
            "text": "\t\t\tfile?: { path: string };",
            "lineNumber": 270
          },
          {
            "text": "\t\t\tcontainerEl?: HTMLElement;",
            "lineNumber": 271
          },
          {
            "text": "\t\t};",
            "lineNumber": 272
          },
          {
            "text": "\t\tif (v.getViewType?.() !== \"canvas\") return null;",
            "lineNumber": 273
          },
          {
            "text": "\t\tif (v.canvas == null || v.file == null || !v.containerEl) return null;",
            "lineNumber": 274
          },
          {
            "text": "\t\treturn { canvas: v.canvas, file: v.file, containerEl: v.containerEl };",
            "lineNumber": 275
          },
          {
            "text": "\t}",
            "lineNumber": 276
          },
          {
            "lineNumber": 277
          },
          {
            "text": "\t/**",
            "lineNumber": 278
          },
          {
            "text": "\t * Returns the active canvas view, or the first open canvas if the active leaf is not a canvas.",
            "lineNumber": 279
          },
          {
            "text": "\t * Use this when the user may be focused on the control panel (e.g. Restart kernel button).",
            "lineNumber": 280
          },
          {
            "text": "\t */",
            "lineNumber": 281
          },
          {
            "text": "\tgetActiveOrFirstCanvasView(): { canvas: unknown; file: { path: string }; containerEl: HTMLElement } | null {",
            "lineNumber": 282
          },
          {
            "text": "\t\tconst active = this.getActiveCanvasView();",
            "lineNumber": 283
          },
          {
            "text": "\t\tif (active) return active;",
            "lineNumber": 284
          },
          {
            "text": "\t\tconst leaves = this.app.workspace.getLeavesOfType(\"canvas\");",
            "lineNumber": 285
          },
          {
            "text": "\t\tconst leaf = leaves[0];",
            "lineNumber": 286
          },
          {
            "text": "\t\tif (!leaf?.view) return null;",
            "lineNumber": 287
          },
          {
            "text": "\t}",
            "lineNumber": 297
          },
          {
            "text": "}",
            "lineNumber": 348,
            "isSignature": true
          }
        ]
      },
      "score": 0.37630990147590637
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 33
          },
          "endPosition": {
            "line": 347,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\ngetActiveOrFirstCanvasView(): { canvas: unknown; file: { path: string }; containerEl: HTMLElement } | null {\n\n\t\tconst leaf = leaves[0];\n\t\tif (!leaf?.view) return null;\n\t\tconst v = leaf.view as {\n\t\t\tgetViewType?: () =&gt; string;\n\t\t\tcanvas?: unknown;\n\t\t\tfile?: { path: string };\n\t\t\tcontainerEl?: HTMLElement;\n\t\t};\n\t\tif (v.getViewType?.() !== \"canvas\") return null;\n\t\tif (v.canvas == null || v.file == null || !v.containerEl) return null;\n\t\treturn { canvas: v.canvas, file: v.file, containerEl: v.containerEl };\n\t}\n\n\t/** Run a single node (call from context menu with node id). */\n\tasync runNode(nodeId: string): Promise&lt;void&gt; {\n\t\tconst view = this.getActiveCanvasView();\n\t\tif (!view) return;\n\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;\n\t\tconst result = await runnerRunNode(this.app, this.settings, view.file.path, nodeId, liveCanvas);\n\t\tif (!result.ok) new Notice(result.message ?? \"Run node failed.\");\n\t}\n\n\t/** Run chain from roots to the given node (call from context menu with node id). */\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 34,
                "column": 1
              },
              "endPosition": {
                "line": 34,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 34,
                "column": 16
              },
              "endPosition": {
                "line": 35,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 34,
            "isSignature": true
          },
          {
            "text": "getActiveOrFirstCanvasView(): { canvas: unknown; file: { path: string }; containerEl: HTMLElement } | null {",
            "lineNumber": 282
          },
          {
            "lineNumber": 285
          },
          {
            "text": "\t\tconst leaf = leaves[0];",
            "lineNumber": 286
          },
          {
            "text": "\t\tif (!leaf?.view) return null;",
            "lineNumber": 287
          },
          {
            "text": "\t\tconst v = leaf.view as {",
            "lineNumber": 288
          },
          {
            "text": "\t\t\tgetViewType?: () =&gt; string;",
            "lineNumber": 289
          },
          {
            "text": "\t\t\tcanvas?: unknown;",
            "lineNumber": 290
          },
          {
            "text": "\t\t\tfile?: { path: string };",
            "lineNumber": 291
          },
          {
            "text": "\t\t\tcontainerEl?: HTMLElement;",
            "lineNumber": 292
          },
          {
            "text": "\t\t};",
            "lineNumber": 293
          },
          {
            "text": "\t\tif (v.getViewType?.() !== \"canvas\") return null;",
            "lineNumber": 294
          },
          {
            "text": "\t\tif (v.canvas == null || v.file == null || !v.containerEl) return null;",
            "lineNumber": 295
          },
          {
            "text": "\t\treturn { canvas: v.canvas, file: v.file, containerEl: v.containerEl };",
            "lineNumber": 296
          },
          {
            "text": "\t}",
            "lineNumber": 297
          },
          {
            "lineNumber": 298
          },
          {
            "text": "\t/** Run a single node (call from context menu with node id). */",
            "lineNumber": 299
          },
          {
            "text": "\tasync runNode(nodeId: string): Promise&lt;void&gt; {",
            "lineNumber": 300
          },
          {
            "text": "\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 301
          },
          {
            "text": "\t\tif (!view) return;",
            "lineNumber": 302
          },
          {
            "text": "\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;",
            "lineNumber": 303
          },
          {
            "text": "\t\tconst result = await runnerRunNode(this.app, this.settings, view.file.path, nodeId, liveCanvas);",
            "lineNumber": 304
          },
          {
            "text": "\t\tif (!result.ok) new Notice(result.message ?? \"Run node failed.\");",
            "lineNumber": 305
          },
          {
            "text": "\t}",
            "lineNumber": 306
          },
          {
            "lineNumber": 307
          },
          {
            "text": "\t/** Run chain from roots to the given node (call from context menu with node id). */",
            "lineNumber": 308
          },
          {
            "text": "}",
            "lineNumber": 348,
            "isSignature": true
          }
        ]
      },
      "score": 0.37115800380706787
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 33
          },
          "endPosition": {
            "line": 347,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\nasync onload() {\n\n() =&gt; {\n {\n\t\t\t\t\t\tif (!openPaths.has(path)) terminateKernel(path);\n\t\t\t\t\t}\n\t\t\t\t\tpreviousCanvasPaths = openPaths;\n\t\t\t\t})\n\t\t\t);\n\n\t\t\t// Floating role labels on canvas: sync when active leaf is a canvas, clear when not\n\t\t\tlet roleLabelsContainerEl: HTMLElement | null = null;\n\t\t\tlet roleLabelsIntervalId: number | null = null;\n\t\t\tconst runSyncLabels = (): void =&gt; {\n\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\tif (!view) {\n\t\t\t\t\tif (roleLabelsIntervalId != null) {\n\t\t\t\t\t\tclearInterval(roleLabelsIntervalId);\n\t\t\t\t\t\troleLabelsIntervalId = null;\n\t\t\t\t\t\tdelete (this as unknown as Record&lt;string, unknown&gt;)._roleLabelsIntervalId;\n\t\t\t\t\t}\n\t\t\t\t\tif (roleLabelsContainerEl != null) {\n\t\t\t\t\t\tclearCanvasRoleLabels(roleLabelsContainerEl);\n\t\t\t\t\t\tclearCanvasLegend(roleLabelsContainerEl);\n\t\t\t\t\t\tclearCanvasEdgeModeLabels(roleLabelsContainerEl);\n\t\t\t\t\t\troleLabelsContainerEl = null;\n\t\t\t\t\t}\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tif (roleLabelsContainerEl != null &amp;&amp; roleLabelsContainerEl !== view.containerEl) {\n\t\t\t\t\tclearCanvasRoleLabels(roleLabelsContainerEl);\n\t\t\t\t\tclearCanvasLegend(roleLabelsContainerEl);\n\t\t\t\t\tclearCanvasEdgeModeLabels(roleLabelsContainerEl);\n\t\t\t\t}\n\t\t\t\troleLabelsContainerEl = view.containerEl;\n\t\t\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;\n\t\t\t\tconst isStillActive = (): boolean =&gt; this.getActiveCanvasView()?.containerEl === roleLabelsContainerEl;\n\t\t\t\tsyncCanvasRoleLabels(this.app.vault, view.file.path, view.containerEl, this.settings, liveCanvas, isStillActive);\n\t\t\t\tsyncCanvasEdgeModeLabels(this.app.vault, view.file.path, view.containerEl, liveCanvas, isStillActive);\n\t\t\t\tif (roleLabelsIntervalId == null) {\n\t\t\t\t\troleLabelsIntervalId = window.setInterval(() =&gt; {\n\t\t\t\t\t\tconst v = this.getActiveCanvasView();\n\t\t\t\t\t\tif (v != null &amp;&amp; v.containerEl === roleLabelsContainerEl) {\n\t\t\t\t\t\t\tconst stillActive = (): boolean =&gt; this.getActiveCanvasView()?.containerEl === roleLabelsContainerEl;\n\t\t\t\t\t\t\tsyncCanvasRoleLabels(this.app.vault, v.file.path, v.containerEl, this.settings, v.canvas as import(\"./engine/canvasApi\").LiveCanvas, stillActive);\n\t\t\t\t\t\t\tsyncCanvasEdgeModeLabels(this.app.vault, v.file.path, v.containerEl, v.canvas as import(\"./engine/canvasApi\").LiveCanvas, stillActive);\n\t\t\t\t\t\t}\n\t\t\t\t\t}, 2000);\n\t\t\t\t\t(this as unknown as { _roleLabelsIntervalId: number })._roleLabelsIntervalId = roleLabelsIntervalId;\n\t\t\t\t}\n\t\t\t};\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 34,
                "column": 1
              },
              "endPosition": {
                "line": 34,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 34,
                "column": 16
              },
              "endPosition": {
                "line": 35,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 37,
                "column": 2
              },
              "endPosition": {
                "line": 38,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 34,
            "isSignature": true
          },
          {
            "text": "async onload() {",
            "lineNumber": 37
          },
          {
            "lineNumber": 166
          },
          {
            "text": "() =&gt; {",
            "lineNumber": 167
          },
          {
            "text": " {",
            "lineNumber": 174
          },
          {
            "text": "\t\t\t\t\t\tif (!openPaths.has(path)) terminateKernel(path);",
            "lineNumber": 175
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 176
          },
          {
            "text": "\t\t\t\t\tpreviousCanvasPaths = openPaths;",
            "lineNumber": 177
          },
          {
            "text": "\t\t\t\t})",
            "lineNumber": 178
          },
          {
            "text": "\t\t\t);",
            "lineNumber": 179
          },
          {
            "lineNumber": 180
          },
          {
            "text": "\t\t\t// Floating role labels on canvas: sync when active leaf is a canvas, clear when not",
            "lineNumber": 181
          },
          {
            "text": "\t\t\tlet roleLabelsContainerEl: HTMLElement | null = null;",
            "lineNumber": 182
          },
          {
            "text": "\t\t\tlet roleLabelsIntervalId: number | null = null;",
            "lineNumber": 183
          },
          {
            "text": "\t\t\tconst runSyncLabels = (): void =&gt; {",
            "lineNumber": 184
          },
          {
            "text": "\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 185
          },
          {
            "text": "\t\t\t\tif (!view) {",
            "lineNumber": 186
          },
          {
            "text": "\t\t\t\t\tif (roleLabelsIntervalId != null) {",
            "lineNumber": 187
          },
          {
            "text": "\t\t\t\t\t\tclearInterval(roleLabelsIntervalId);",
            "lineNumber": 188
          },
          {
            "text": "\t\t\t\t\t\troleLabelsIntervalId = null;",
            "lineNumber": 189
          },
          {
            "text": "\t\t\t\t\t\tdelete (this as unknown as Record&lt;string, unknown&gt;)._roleLabelsIntervalId;",
            "lineNumber": 190
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 191
          },
          {
            "text": "\t\t\t\t\tif (roleLabelsContainerEl != null) {",
            "lineNumber": 192
          },
          {
            "text": "\t\t\t\t\t\tclearCanvasRoleLabels(roleLabelsContainerEl);",
            "lineNumber": 193
          },
          {
            "text": "\t\t\t\t\t\tclearCanvasLegend(roleLabelsContainerEl);",
            "lineNumber": 194
          },
          {
            "text": "\t\t\t\t\t\tclearCanvasEdgeModeLabels(roleLabelsContainerEl);",
            "lineNumber": 195
          },
          {
            "text": "\t\t\t\t\t\troleLabelsContainerEl = null;",
            "lineNumber": 196
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 197
          },
          {
            "text": "\t\t\t\t\treturn;",
            "lineNumber": 198
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 199
          },
          {
            "text": "\t\t\t\tif (roleLabelsContainerEl != null &amp;&amp; roleLabelsContainerEl !== view.containerEl) {",
            "lineNumber": 200
          },
          {
            "text": "\t\t\t\t\tclearCanvasRoleLabels(roleLabelsContainerEl);",
            "lineNumber": 201
          },
          {
            "text": "\t\t\t\t\tclearCanvasLegend(roleLabelsContainerEl);",
            "lineNumber": 202
          },
          {
            "text": "\t\t\t\t\tclearCanvasEdgeModeLabels(roleLabelsContainerEl);",
            "lineNumber": 203
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 204
          },
          {
            "text": "\t\t\t\troleLabelsContainerEl = view.containerEl;",
            "lineNumber": 205
          },
          {
            "text": "\t\t\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;",
            "lineNumber": 206
          },
          {
            "text": "\t\t\t\tconst isStillActive = (): boolean =&gt; this.getActiveCanvasView()?.containerEl === roleLabelsContainerEl;",
            "lineNumber": 207
          },
          {
            "text": "\t\t\t\tsyncCanvasRoleLabels(this.app.vault, view.file.path, view.containerEl, this.settings, liveCanvas, isStillActive);",
            "lineNumber": 208
          },
          {
            "text": "\t\t\t\tsyncCanvasEdgeModeLabels(this.app.vault, view.file.path, view.containerEl, liveCanvas, isStillActive);",
            "lineNumber": 209
          },
          {
            "text": "\t\t\t\tif (roleLabelsIntervalId == null) {",
            "lineNumber": 210
          },
          {
            "text": "\t\t\t\t\troleLabelsIntervalId = window.setInterval(() =&gt; {",
            "lineNumber": 211
          },
          {
            "text": "\t\t\t\t\t\tconst v = this.getActiveCanvasView();",
            "lineNumber": 212
          },
          {
            "text": "\t\t\t\t\t\tif (v != null &amp;&amp; v.containerEl === roleLabelsContainerEl) {",
            "lineNumber": 213
          },
          {
            "text": "\t\t\t\t\t\t\tconst stillActive = (): boolean =&gt; this.getActiveCanvasView()?.containerEl === roleLabelsContainerEl;",
            "lineNumber": 214
          },
          {
            "text": "\t\t\t\t\t\t\tsyncCanvasRoleLabels(this.app.vault, v.file.path, v.containerEl, this.settings, v.canvas as import(\"./engine/canvasApi\").LiveCanvas, stillActive);",
            "lineNumber": 215
          },
          {
            "text": "\t\t\t\t\t\t\tsyncCanvasEdgeModeLabels(this.app.vault, v.file.path, v.containerEl, v.canvas as import(\"./engine/canvasApi\").LiveCanvas, stillActive);",
            "lineNumber": 216
          },
          {
            "text": "\t\t\t\t\t\t}",
            "lineNumber": 217
          },
          {
            "text": "\t\t\t\t\t}, 2000);",
            "lineNumber": 218
          },
          {
            "text": "\t\t\t\t\t(this as unknown as { _roleLabelsIntervalId: number })._roleLabelsIntervalId = roleLabelsIntervalId;",
            "lineNumber": 219
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 220
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 221
          },
          {
            "text": "\t}",
            "lineNumber": 228
          },
          {
            "text": "}",
            "lineNumber": 348,
            "isSignature": true
          }
        ]
      },
      "score": 0.32746419310569763
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 33
          },
          "endPosition": {
            "line": 347,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\nasync onload() {\n\n\n\t\t\t// Canvas node context menu (event name is undocumented; try workspace.on(\"canvas:node-menu\")).\n\t\t\t// Defer registration so Obsidian canvas is ready (avoids \"reading '_'\" in app.js).\n\t\t\tconst addNodeMenuItems = (menu: Menu, node: unknown): void =&gt; {\n\t\t\t\tdebugNodeMenuFired = true;\n\t\t\t\tconst nodeId = resolveCanvasNodeId(node);\n\t\t\t\tif (!nodeId) return;\n\t\t\t\tmenu.addItem((item) =&gt;\n\t\t\t\t\titem.setTitle(\"Run node\").setIcon(\"play\").onClick(() =&gt; this.runNode(nodeId))\n\t\t\t\t);\n\t\t\t\tmenu.addItem((item) =&gt;\n\t\t\t\t\titem.setTitle(\"Run chain\").setIcon(\"forward\").onClick(() =&gt; this.runChain(nodeId))\n\t\t\t\t);\n\t\t\t\tmenu.addItem((item) =&gt;\n\t\t\t\t\titem.setTitle(\"Dismiss output\").setIcon(\"trash\").onClick(() =&gt; this.dismissOutput(nodeId))\n\t\t\t\t);\n\t\t\t};\n\t\t\tconst registerCanvasNodeMenu = () =&gt; {\n\t\t\t\ttry {\n\t\t\t\t\tconst on = this.app.workspace.on.bind(this.app.workspace) as (\n\t\t\t\t\t\tname: string,\n\t\t\t\t\t\tcallback: (menu: Menu, node: unknown) =&gt; void\n\t\t\t\t\t) =&gt; ReturnType&lt;typeof this.app.workspace.on&gt;;\n\t\t\t\t\t// Try documented-style event name first; some Obsidian builds use \"canvas:node-menu\".\n\t\t\t\t\tthis.registerEvent(on(\"canvas:node-menu\", addNodeMenuItems));\n\t\t\t\t\t// Fallback: try hyphenated name in case the app triggers a different event.\n\t\t\t\t\tthis.registerEvent(on(\"canvas-node-menu\", addNodeMenuItems));\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconsole.error(\"Zettel Thinking Board: could not register canvas node menu.\", e);\n\t\t\t\t}\n\t\t\t};\n\t\t\tconst timeoutId = window.setTimeout(registerCanvasNodeMenu, 0);\n\t\t\tthis.register(() =&gt; window.clearTimeout(timeoutId));\n\n\t\t\t// Canvas background context menu: use undocumented \"canvas:edge-menu\" (Obsidian broadcasts it;\n\t\t\t// when right-click is on empty area, edge is null). Same pattern as canvas:node-menu: addItem with setTitle, setIcon, onClick.\n\t\t\tconst addCanvasMenuItems = (menu: Menu): void =&gt; {\n\t\t\t\tmenu.addItem((item) =&gt;\n\t\t\t\t\titem.setTitle(\"Run entire canvas\").setIcon(\"play\").onClick(() =&gt; this.runEntireCanvas())\n\t\t\t\t);\n\t\t\t\tmenu.addItem((item) =&gt;\n\t\t\t\t\titem.setTitle(\"Dismiss all output\").setIcon(\"trash\").onClick(() =&gt; this.dismissAllOutput())\n\t\t\t\t);\n\t\t\t};\n\t\t\ttry {\n\t\t\t\tconst onWorkspace = this.app.workspace.on.bind(this.app.workspace)\n;\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 34,
                "column": 1
              },
              "endPosition": {
                "line": 34,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 34,
                "column": 16
              },
              "endPosition": {
                "line": 35,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 37,
                "column": 2
              },
              "endPosition": {
                "line": 38,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 34,
            "isSignature": true
          },
          {
            "text": "async onload() {",
            "lineNumber": 37
          },
          {
            "lineNumber": 88
          },
          {
            "lineNumber": 89
          },
          {
            "text": "\t\t\t// Canvas node context menu (event name is undocumented; try workspace.on(\"canvas:node-menu\")).",
            "lineNumber": 90
          },
          {
            "text": "\t\t\t// Defer registration so Obsidian canvas is ready (avoids \"reading '_'\" in app.js).",
            "lineNumber": 91
          },
          {
            "text": "\t\t\tconst addNodeMenuItems = (menu: Menu, node: unknown): void =&gt; {",
            "lineNumber": 92
          },
          {
            "text": "\t\t\t\tdebugNodeMenuFired = true;",
            "lineNumber": 93
          },
          {
            "text": "\t\t\t\tconst nodeId = resolveCanvasNodeId(node);",
            "lineNumber": 94
          },
          {
            "text": "\t\t\t\tif (!nodeId) return;",
            "lineNumber": 95
          },
          {
            "text": "\t\t\t\tmenu.addItem((item) =&gt;",
            "lineNumber": 96
          },
          {
            "text": "\t\t\t\t\titem.setTitle(\"Run node\").setIcon(\"play\").onClick(() =&gt; this.runNode(nodeId))",
            "lineNumber": 97
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 98
          },
          {
            "text": "\t\t\t\tmenu.addItem((item) =&gt;",
            "lineNumber": 99
          },
          {
            "text": "\t\t\t\t\titem.setTitle(\"Run chain\").setIcon(\"forward\").onClick(() =&gt; this.runChain(nodeId))",
            "lineNumber": 100
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 101
          },
          {
            "text": "\t\t\t\tmenu.addItem((item) =&gt;",
            "lineNumber": 102
          },
          {
            "text": "\t\t\t\t\titem.setTitle(\"Dismiss output\").setIcon(\"trash\").onClick(() =&gt; this.dismissOutput(nodeId))",
            "lineNumber": 103
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 104
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 105
          },
          {
            "text": "\t\t\tconst registerCanvasNodeMenu = () =&gt; {",
            "lineNumber": 106
          },
          {
            "text": "\t\t\t\ttry {",
            "lineNumber": 107
          },
          {
            "text": "\t\t\t\t\tconst on = this.app.workspace.on.bind(this.app.workspace) as (",
            "lineNumber": 108
          },
          {
            "text": "\t\t\t\t\t\tname: string,",
            "lineNumber": 109
          },
          {
            "text": "\t\t\t\t\t\tcallback: (menu: Menu, node: unknown) =&gt; void",
            "lineNumber": 110
          },
          {
            "text": "\t\t\t\t\t) =&gt; ReturnType&lt;typeof this.app.workspace.on&gt;;",
            "lineNumber": 111
          },
          {
            "text": "\t\t\t\t\t// Try documented-style event name first; some Obsidian builds use \"canvas:node-menu\".",
            "lineNumber": 112
          },
          {
            "text": "\t\t\t\t\tthis.registerEvent(on(\"canvas:node-menu\", addNodeMenuItems));",
            "lineNumber": 113
          },
          {
            "text": "\t\t\t\t\t// Fallback: try hyphenated name in case the app triggers a different event.",
            "lineNumber": 114
          },
          {
            "text": "\t\t\t\t\tthis.registerEvent(on(\"canvas-node-menu\", addNodeMenuItems));",
            "lineNumber": 115
          },
          {
            "text": "\t\t\t\t} catch (e) {",
            "lineNumber": 116
          },
          {
            "text": "\t\t\t\t\tconsole.error(\"Zettel Thinking Board: could not register canvas node menu.\", e);",
            "lineNumber": 117
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 118
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 119
          },
          {
            "text": "\t\t\tconst timeoutId = window.setTimeout(registerCanvasNodeMenu, 0);",
            "lineNumber": 120
          },
          {
            "text": "\t\t\tthis.register(() =&gt; window.clearTimeout(timeoutId));",
            "lineNumber": 121
          },
          {
            "lineNumber": 122
          },
          {
            "text": "\t\t\t// Canvas background context menu: use undocumented \"canvas:edge-menu\" (Obsidian broadcasts it;",
            "lineNumber": 123
          },
          {
            "text": "\t\t\t// when right-click is on empty area, edge is null). Same pattern as canvas:node-menu: addItem with setTitle, setIcon, onClick.",
            "lineNumber": 124
          },
          {
            "text": "\t\t\tconst addCanvasMenuItems = (menu: Menu): void =&gt; {",
            "lineNumber": 125
          },
          {
            "text": "\t\t\t\tmenu.addItem((item) =&gt;",
            "lineNumber": 126
          },
          {
            "text": "\t\t\t\t\titem.setTitle(\"Run entire canvas\").setIcon(\"play\").onClick(() =&gt; this.runEntireCanvas())",
            "lineNumber": 127
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 128
          },
          {
            "text": "\t\t\t\tmenu.addItem((item) =&gt;",
            "lineNumber": 129
          },
          {
            "text": "\t\t\t\t\titem.setTitle(\"Dismiss all output\").setIcon(\"trash\").onClick(() =&gt; this.dismissAllOutput())",
            "lineNumber": 130
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 131
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 132
          },
          {
            "text": "\t\t\ttry {",
            "lineNumber": 133
          },
          {
            "text": "\t\t\t\tconst onWorkspace = this.app.workspace.on.bind(this.app.workspace)",
            "lineNumber": 134
          },
          {
            "text": ";",
            "lineNumber": 137
          },
          {
            "text": "\t}",
            "lineNumber": 228
          },
          {
            "text": "}",
            "lineNumber": 348,
            "isSignature": true
          }
        ]
      },
      "score": 0.3267727494239807
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/types.ts",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 12,
            "column": 1
          }
        },
        "contents": "import type {App} from \"obsidian\";\nimport type {ZettelPluginSettings} from \"./settings\";\n\n/** Plugin interface used by views to avoid circular dependency on main. */\nexport interface IZettelThinkingBoardPlugin {\n\tapp: App;\n\tsettings: ZettelPluginSettings;\n\tsaveSettings(): Promise&lt;void&gt;;\n\tgetActiveCanvasView(): { canvas: unknown; file: { path: string } } | null;\n\tgetActiveOrFirstCanvasView(): { canvas: unknown; file: { path: string } } | null;\n\tgetKernelForActiveCanvas(): { onLog?: ((line: string) =&gt; void) | undefined; run(code: string, inputText: string): Promise&lt;string&gt;; terminate(): void } | null;\n\tregisterEvent(ref: unknown): void;\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "import type {App} from \"obsidian\";",
            "lineNumber": 1
          },
          {
            "text": "import type {ZettelPluginSettings} from \"./settings\";",
            "lineNumber": 2
          },
          {
            "lineNumber": 3
          },
          {
            "text": "/** Plugin interface used by views to avoid circular dependency on main. */",
            "lineNumber": 4
          },
          {
            "text": "export interface IZettelThinkingBoardPlugin {",
            "lineNumber": 5,
            "isSignature": true
          },
          {
            "text": "\tapp: App;",
            "lineNumber": 6
          },
          {
            "text": "\tsettings: ZettelPluginSettings;",
            "lineNumber": 7
          },
          {
            "text": "\tsaveSettings(): Promise&lt;void&gt;;",
            "lineNumber": 8
          },
          {
            "text": "\tgetActiveCanvasView(): { canvas: unknown; file: { path: string } } | null;",
            "lineNumber": 9
          },
          {
            "text": "\tgetActiveOrFirstCanvasView(): { canvas: unknown; file: { path: string } } | null;",
            "lineNumber": 10
          },
          {
            "text": "\tgetKernelForActiveCanvas(): { onLog?: ((line: string) =&gt; void) | undefined; run(code: string, inputText: string): Promise&lt;string&gt;; terminate(): void } | null;",
            "lineNumber": 11
          },
          {
            "text": "\tregisterEvent(ref: unknown): void;",
            "lineNumber": 12,
            "isSignature": true
          },
          {
            "text": "}",
            "lineNumber": 13,
            "isSignature": true
          }
        ]
      },
      "score": 0.2943058907985687
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/views/ZettelControlsView.ts",
        "range": {
          "startPosition": {
            "line": 9
          },
          "endPosition": {
            "line": 126,
            "column": 1
          }
        },
        "contents": "export class ZettelControlsView extends ItemView {\nasync onOpen(): Promise&lt;void&gt; {\n\n\t\tconst addEnvRow = (key = \"\", value = \"\") =&gt; {\n\t\t\tconst row = envList.createDiv({ cls: \"ztb-env-row\" });\n\t\t\tconst keyInp = row.createEl(\"input\", { type: \"text\", cls: \"ztb-env-key\" });\n\t\t\tkeyInp.placeholder = \"KEY\";\n\t\t\tkeyInp.value = key;\n\t\t\tconst valInp = row.createEl(\"input\", { type: \"text\", cls: \"ztb-env-val\" });\n\t\t\tvalInp.placeholder = \"value\";\n\t\t\tvalInp.value = value;\n\t\t\tkeyInp.addEventListener(\"change\", () =&gt; {\n\t\t\t\tif (key) delete envVars[key];\n\t\t\t\tenvVars[keyInp.value.trim()] = valInp.value.trim();\n\t\t\t});\n\t\t\tvalInp.addEventListener(\"change\", () =&gt; {\n\t\t\t\tenvVars[keyInp.value.trim()] = valInp.value.trim();\n\t\t\t});\n\t\t\trow.createEl(\"button\", { text: \"Remove\", cls: \"ztb-env-remove\" }).addEventListener(\"click\", () =&gt; {\n\t\t\t\tdelete envVars[keyInp.value.trim()];\n\t\t\t\trow.remove();\n\t\t\t});\n\t\t};\n\t\tfor (const [k, v] of Object.entries(envVars)) addEnvRow(k, v);\n\t\tconst addBtn = el.createEl(\"button\", { text: \"Add variable\", cls: \"ztb-env-add\" });\n\t\taddBtn.addEventListener(\"click\", () =&gt; addEnvRow());\n\n\t\t// Console (obsidian_log output)\n\t\tel.createEl(\"h4\", { text: \"Console\", cls: \"ztb-section-title\" });\n\t\tconst consoleEl = el.createDiv({ cls: \"ztb-console\" });\n\t\tconst appendLog = (line: string) =&gt; {\n\t\t\tconst p = consoleEl.createEl(\"p\", { cls: \"ztb-console-line\" });\n\t\t\tp.setText(line);\n\t\t\tconsoleEl.scrollTop = consoleEl.scrollHeight;\n\t\t};\n\n\t\tconst wireKernelLog = () =&gt; {\n\t\t\tconst kernel = this.plugin.getKernelForActiveCanvas();\n\t\t\tif (kernel) kernel.onLog = (line: string) =&gt; {\n\t\t\t\tif (this.containerEl.isConnected) appendLog(line);\n\t\t\t};\n\t\t};\n\t\twireKernelLog();\n\t\tthis.plugin.registerEvent(\n\t\t\tthis.plugin.app.workspace.on(\"active-leaf-change\", wireKernelLog)\n\t\t);\n\t}\n\n\tasync onClose(): Promise&lt;void&gt; {\n\t\tthis.containerEl.empty();\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 10,
                "column": 1
              },
              "endPosition": {
                "line": 10,
                "column": 8
              }
            },
            {
              "startPosition": {
                "line": 10,
                "column": 8
              },
              "endPosition": {
                "line": 11,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 27,
                "column": 2
              },
              "endPosition": {
                "line": 28,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export class ZettelControlsView extends ItemView {",
            "lineNumber": 10,
            "isSignature": true
          },
          {
            "text": "async onOpen(): Promise&lt;void&gt; {",
            "lineNumber": 27
          },
          {
            "lineNumber": 78
          },
          {
            "text": "\t\tconst addEnvRow = (key = \"\", value = \"\") =&gt; {",
            "lineNumber": 79
          },
          {
            "text": "\t\t\tconst row = envList.createDiv({ cls: \"ztb-env-row\" });",
            "lineNumber": 80
          },
          {
            "text": "\t\t\tconst keyInp = row.createEl(\"input\", { type: \"text\", cls: \"ztb-env-key\" });",
            "lineNumber": 81
          },
          {
            "text": "\t\t\tkeyInp.placeholder = \"KEY\";",
            "lineNumber": 82
          },
          {
            "text": "\t\t\tkeyInp.value = key;",
            "lineNumber": 83
          },
          {
            "text": "\t\t\tconst valInp = row.createEl(\"input\", { type: \"text\", cls: \"ztb-env-val\" });",
            "lineNumber": 84
          },
          {
            "text": "\t\t\tvalInp.placeholder = \"value\";",
            "lineNumber": 85
          },
          {
            "text": "\t\t\tvalInp.value = value;",
            "lineNumber": 86
          },
          {
            "text": "\t\t\tkeyInp.addEventListener(\"change\", () =&gt; {",
            "lineNumber": 87
          },
          {
            "text": "\t\t\t\tif (key) delete envVars[key];",
            "lineNumber": 88
          },
          {
            "text": "\t\t\t\tenvVars[keyInp.value.trim()] = valInp.value.trim();",
            "lineNumber": 89
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 90
          },
          {
            "text": "\t\t\tvalInp.addEventListener(\"change\", () =&gt; {",
            "lineNumber": 91
          },
          {
            "text": "\t\t\t\tenvVars[keyInp.value.trim()] = valInp.value.trim();",
            "lineNumber": 92
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 93
          },
          {
            "text": "\t\t\trow.createEl(\"button\", { text: \"Remove\", cls: \"ztb-env-remove\" }).addEventListener(\"click\", () =&gt; {",
            "lineNumber": 94
          },
          {
            "text": "\t\t\t\tdelete envVars[keyInp.value.trim()];",
            "lineNumber": 95
          },
          {
            "text": "\t\t\t\trow.remove();",
            "lineNumber": 96
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 97
          },
          {
            "text": "\t\t};",
            "lineNumber": 98
          },
          {
            "text": "\t\tfor (const [k, v] of Object.entries(envVars)) addEnvRow(k, v);",
            "lineNumber": 99
          },
          {
            "text": "\t\tconst addBtn = el.createEl(\"button\", { text: \"Add variable\", cls: \"ztb-env-add\" });",
            "lineNumber": 100
          },
          {
            "text": "\t\taddBtn.addEventListener(\"click\", () =&gt; addEnvRow());",
            "lineNumber": 101
          },
          {
            "lineNumber": 102
          },
          {
            "text": "\t\t// Console (obsidian_log output)",
            "lineNumber": 103
          },
          {
            "text": "\t\tel.createEl(\"h4\", { text: \"Console\", cls: \"ztb-section-title\" });",
            "lineNumber": 104
          },
          {
            "text": "\t\tconst consoleEl = el.createDiv({ cls: \"ztb-console\" });",
            "lineNumber": 105
          },
          {
            "text": "\t\tconst appendLog = (line: string) =&gt; {",
            "lineNumber": 106
          },
          {
            "text": "\t\t\tconst p = consoleEl.createEl(\"p\", { cls: \"ztb-console-line\" });",
            "lineNumber": 107
          },
          {
            "text": "\t\t\tp.setText(line);",
            "lineNumber": 108
          },
          {
            "text": "\t\t\tconsoleEl.scrollTop = consoleEl.scrollHeight;",
            "lineNumber": 109
          },
          {
            "text": "\t\t};",
            "lineNumber": 110
          },
          {
            "lineNumber": 111
          },
          {
            "text": "\t\tconst wireKernelLog = () =&gt; {",
            "lineNumber": 112
          },
          {
            "text": "\t\t\tconst kernel = this.plugin.getKernelForActiveCanvas();",
            "lineNumber": 113
          },
          {
            "text": "\t\t\tif (kernel) kernel.onLog = (line: string) =&gt; {",
            "lineNumber": 114
          },
          {
            "text": "\t\t\t\tif (this.containerEl.isConnected) appendLog(line);",
            "lineNumber": 115
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 116
          },
          {
            "text": "\t\t};",
            "lineNumber": 117
          },
          {
            "text": "\t\twireKernelLog();",
            "lineNumber": 118
          },
          {
            "text": "\t\tthis.plugin.registerEvent(",
            "lineNumber": 119
          },
          {
            "text": "\t\t\tthis.plugin.app.workspace.on(\"active-leaf-change\", wireKernelLog)",
            "lineNumber": 120
          },
          {
            "text": "\t\t);",
            "lineNumber": 121
          },
          {
            "text": "\t}",
            "lineNumber": 122
          },
          {
            "lineNumber": 123
          },
          {
            "text": "\tasync onClose(): Promise&lt;void&gt; {",
            "lineNumber": 124
          },
          {
            "text": "\t\tthis.containerEl.empty();",
            "lineNumber": 125
          },
          {
            "text": "\t}",
            "lineNumber": 126
          },
          {
            "text": "}",
            "lineNumber": 127,
            "isSignature": true
          }
        ]
      },
      "score": 0.28876793384552
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/views/ZettelControlsView.ts",
        "range": {
          "startPosition": {
            "line": 9
          },
          "endPosition": {
            "line": 126,
            "column": 1
          }
        },
        "contents": "export class ZettelControlsView extends ItemView {\n\n\n\tasync onOpen(): Promise&lt;void&gt; {\n\t\tconst el = this.containerEl.createDiv({ cls: \"ztb-controls-container\" });\n\n\t\t// Model mapping (persisted; same as settings)\n\t\tel.createEl(\"h4\", { text: \"Model mapping\", cls: \"ztb-section-title\" });\n\t\tnew Setting(el)\n\t\t\t.setName(\"Model node (primary)\")\n\t\t\t.setDesc(\"Ollama model for primary model nodes\")\n\t\t\t.addText((text) =&gt;\n\t\t\t\ttext\n\t\t\t\t\t.setPlaceholder(\"e.g. llama2\")\n\t\t\t\t\t.setValue(this.plugin.settings.ollamaOrangeModel)\n\t\t\t\t\t.onChange(async (value) =&gt; {\n\t\t\t\t\t\tthis.plugin.settings.ollamaOrangeModel = value;\n\t\t\t\t\t\tawait this.plugin.saveSettings();\n\t\t\t\t\t})\n\t\t\t);\n\t\tnew Setting(el)\n\t\t\t.setName(\"Model node (secondary)\")\n\t\t\t.setDesc(\"Ollama model for secondary model nodes\")\n\t\t\t.addText((text) =&gt;\n\t\t\t\ttext\n\t\t\t\t\t.setPlaceholder(\"e.g. mistral\")\n\t\t\t\t\t.setValue(this.plugin.settings.ollamaPurpleModel)\n\t\t\t\t\t.onChange(async (value) =&gt; {\n\t\t\t\t\t\tthis.plugin.settings.ollamaPurpleModel = value;\n\t\t\t\t\t\tawait this.plugin.saveSettings();\n\t\t\t\t\t})\n\t\t\t);\n\n\t\t// Kernel controls\n\t\tel.createEl(\"h4\", { text: \"Kernel controls\", cls: \"ztb-section-title\" });\n\t\tnew Setting(el)\n\t\t\t.setName(\"Restart Python kernel\")\n\t\t\t.setDesc(\"Restart the kernel for the active canvas\")\n\t\t\t.addButton((btn) =&gt;\n\t\t\t\tbtn.setButtonText(\"Restart kernel\").onClick(() =&gt; {\n\t\t\t\t\tconst view = this.plugin.getActiveOrFirstCanvasView();\n\t\t\t\t\tif (!view) {\n\t\t\t\t\t\tnew Notice(\"Open a canvas first.\");\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tterminateKernel(view.file.path);\n\t\t\t\t\tnew Notice(\"Kernel restarted for this canvas.\");\n\t\t\t\t})\n\t\t\t);\n\n\t\t// Environment variables (in-memory only)\n\t\tel.createEl(\"h4\", { text: \"Environment variables\", cls: \"ztb-section-title\" });\n\t\tconst envDesc = el.createEl(\"p\", { cls: \"ztb-env-desc\" });\n\t\tenvDesc.setText(\"Key-value pairs for Python (not persisted).\");\n\t\tconst envList = el.createDiv({ cls: \"ztb-env-list\" });\n\t\tconst addEnvRow = (key = \"\", value = \"\") =&gt; {\n\t\t\tconst row = envList.createDiv({ cls: \"ztb-env-row\" });\n;\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 10,
                "column": 1
              },
              "endPosition": {
                "line": 10,
                "column": 8
              }
            },
            {
              "startPosition": {
                "line": 10,
                "column": 8
              },
              "endPosition": {
                "line": 11,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export class ZettelControlsView extends ItemView {",
            "lineNumber": 10,
            "isSignature": true
          },
          {
            "lineNumber": 25
          },
          {
            "lineNumber": 26
          },
          {
            "text": "\tasync onOpen(): Promise&lt;void&gt; {",
            "lineNumber": 27
          },
          {
            "text": "\t\tconst el = this.containerEl.createDiv({ cls: \"ztb-controls-container\" });",
            "lineNumber": 28
          },
          {
            "lineNumber": 29
          },
          {
            "text": "\t\t// Model mapping (persisted; same as settings)",
            "lineNumber": 30
          },
          {
            "text": "\t\tel.createEl(\"h4\", { text: \"Model mapping\", cls: \"ztb-section-title\" });",
            "lineNumber": 31
          },
          {
            "text": "\t\tnew Setting(el)",
            "lineNumber": 32
          },
          {
            "text": "\t\t\t.setName(\"Model node (primary)\")",
            "lineNumber": 33
          },
          {
            "text": "\t\t\t.setDesc(\"Ollama model for primary model nodes\")",
            "lineNumber": 34
          },
          {
            "text": "\t\t\t.addText((text) =&gt;",
            "lineNumber": 35
          },
          {
            "text": "\t\t\t\ttext",
            "lineNumber": 36
          },
          {
            "text": "\t\t\t\t\t.setPlaceholder(\"e.g. llama2\")",
            "lineNumber": 37
          },
          {
            "text": "\t\t\t\t\t.setValue(this.plugin.settings.ollamaOrangeModel)",
            "lineNumber": 38
          },
          {
            "text": "\t\t\t\t\t.onChange(async (value) =&gt; {",
            "lineNumber": 39
          },
          {
            "text": "\t\t\t\t\t\tthis.plugin.settings.ollamaOrangeModel = value;",
            "lineNumber": 40
          },
          {
            "text": "\t\t\t\t\t\tawait this.plugin.saveSettings();",
            "lineNumber": 41
          },
          {
            "text": "\t\t\t\t\t})",
            "lineNumber": 42
          },
          {
            "text": "\t\t\t);",
            "lineNumber": 43
          },
          {
            "text": "\t\tnew Setting(el)",
            "lineNumber": 44
          },
          {
            "text": "\t\t\t.setName(\"Model node (secondary)\")",
            "lineNumber": 45
          },
          {
            "text": "\t\t\t.setDesc(\"Ollama model for secondary model nodes\")",
            "lineNumber": 46
          },
          {
            "text": "\t\t\t.addText((text) =&gt;",
            "lineNumber": 47
          },
          {
            "text": "\t\t\t\ttext",
            "lineNumber": 48
          },
          {
            "text": "\t\t\t\t\t.setPlaceholder(\"e.g. mistral\")",
            "lineNumber": 49
          },
          {
            "text": "\t\t\t\t\t.setValue(this.plugin.settings.ollamaPurpleModel)",
            "lineNumber": 50
          },
          {
            "text": "\t\t\t\t\t.onChange(async (value) =&gt; {",
            "lineNumber": 51
          },
          {
            "text": "\t\t\t\t\t\tthis.plugin.settings.ollamaPurpleModel = value;",
            "lineNumber": 52
          },
          {
            "text": "\t\t\t\t\t\tawait this.plugin.saveSettings();",
            "lineNumber": 53
          },
          {
            "text": "\t\t\t\t\t})",
            "lineNumber": 54
          },
          {
            "text": "\t\t\t);",
            "lineNumber": 55
          },
          {
            "lineNumber": 56
          },
          {
            "text": "\t\t// Kernel controls",
            "lineNumber": 57
          },
          {
            "text": "\t\tel.createEl(\"h4\", { text: \"Kernel controls\", cls: \"ztb-section-title\" });",
            "lineNumber": 58
          },
          {
            "text": "\t\tnew Setting(el)",
            "lineNumber": 59
          },
          {
            "text": "\t\t\t.setName(\"Restart Python kernel\")",
            "lineNumber": 60
          },
          {
            "text": "\t\t\t.setDesc(\"Restart the kernel for the active canvas\")",
            "lineNumber": 61
          },
          {
            "text": "\t\t\t.addButton((btn) =&gt;",
            "lineNumber": 62
          },
          {
            "text": "\t\t\t\tbtn.setButtonText(\"Restart kernel\").onClick(() =&gt; {",
            "lineNumber": 63
          },
          {
            "text": "\t\t\t\t\tconst view = this.plugin.getActiveOrFirstCanvasView();",
            "lineNumber": 64
          },
          {
            "text": "\t\t\t\t\tif (!view) {",
            "lineNumber": 65
          },
          {
            "text": "\t\t\t\t\t\tnew Notice(\"Open a canvas first.\");",
            "lineNumber": 66
          },
          {
            "text": "\t\t\t\t\t\treturn;",
            "lineNumber": 67
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 68
          },
          {
            "text": "\t\t\t\t\tterminateKernel(view.file.path);",
            "lineNumber": 69
          },
          {
            "text": "\t\t\t\t\tnew Notice(\"Kernel restarted for this canvas.\");",
            "lineNumber": 70
          },
          {
            "text": "\t\t\t\t})",
            "lineNumber": 71
          },
          {
            "text": "\t\t\t);",
            "lineNumber": 72
          },
          {
            "lineNumber": 73
          },
          {
            "text": "\t\t// Environment variables (in-memory only)",
            "lineNumber": 74
          },
          {
            "text": "\t\tel.createEl(\"h4\", { text: \"Environment variables\", cls: \"ztb-section-title\" });",
            "lineNumber": 75
          },
          {
            "text": "\t\tconst envDesc = el.createEl(\"p\", { cls: \"ztb-env-desc\" });",
            "lineNumber": 76
          },
          {
            "text": "\t\tenvDesc.setText(\"Key-value pairs for Python (not persisted).\");",
            "lineNumber": 77
          },
          {
            "text": "\t\tconst envList = el.createDiv({ cls: \"ztb-env-list\" });",
            "lineNumber": 78
          },
          {
            "text": "\t\tconst addEnvRow = (key = \"\", value = \"\") =&gt; {",
            "lineNumber": 79
          },
          {
            "text": "\t\t\tconst row = envList.createDiv({ cls: \"ztb-env-row\" });",
            "lineNumber": 80
          },
          {
            "text": ";",
            "lineNumber": 98
          },
          {
            "text": "\t}",
            "lineNumber": 122
          },
          {
            "text": "}",
            "lineNumber": 127,
            "isSignature": true
          }
        ]
      },
      "score": 0.2841373682022095
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 33
          },
          "endPosition": {
            "line": 347,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\nasync onload() {\nconst runSyncLabels = \n\n 2000);\n\t\t\t\t\t(this as unknown as { _roleLabelsIntervalId: number })._roleLabelsIntervalId = roleLabelsIntervalId;\n\t\t\t\t}\n\t\t\t};\n\t\t\tthis.registerEvent(this.app.workspace.on(\"active-leaf-change\", runSyncLabels));\n\t\t\trunSyncLabels();\n\t\t} catch (e) {\n\t\t\tconsole.error(\"Zettel Thinking Board onload error:\", e);\n\t\t\tthrow e;\n\t\t}\n\t}\n\n\tonunload() {\n\t\tterminateAllKernels();\n\t\tconst id = (this as unknown as { _roleLabelsIntervalId?: number })._roleLabelsIntervalId;\n\t\tif (id != null) clearInterval(id);\n\t}\n\n\tasync loadSettings() {\n\t\tthis.settings = Object.assign(\n\t\t\t{},\n\t\t\tDEFAULT_SETTINGS,\n\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 34,
                "column": 1
              },
              "endPosition": {
                "line": 34,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 34,
                "column": 16
              },
              "endPosition": {
                "line": 35,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 37,
                "column": 2
              },
              "endPosition": {
                "line": 38,
                "column": 3
              }
            },
            {
              "startPosition": {
                "line": 193,
                "column": 4
              },
              "endPosition": {
                "line": 193,
                "column": 10
              }
            },
            {
              "startPosition": {
                "line": 193,
                "column": 10
              },
              "endPosition": {
                "line": 193,
                "column": 26
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 34,
            "isSignature": true
          },
          {
            "text": "async onload() {",
            "lineNumber": 37
          },
          {
            "text": "const runSyncLabels = ",
            "lineNumber": 184
          },
          {
            "lineNumber": 211
          },
          {
            "text": " 2000);",
            "lineNumber": 218
          },
          {
            "text": "\t\t\t\t\t(this as unknown as { _roleLabelsIntervalId: number })._roleLabelsIntervalId = roleLabelsIntervalId;",
            "lineNumber": 219
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 220
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 221
          },
          {
            "text": "\t\t\tthis.registerEvent(this.app.workspace.on(\"active-leaf-change\", runSyncLabels));",
            "lineNumber": 222
          },
          {
            "text": "\t\t\trunSyncLabels();",
            "lineNumber": 223
          },
          {
            "text": "\t\t} catch (e) {",
            "lineNumber": 224
          },
          {
            "text": "\t\t\tconsole.error(\"Zettel Thinking Board onload error:\", e);",
            "lineNumber": 225
          },
          {
            "text": "\t\t\tthrow e;",
            "lineNumber": 226
          },
          {
            "text": "\t\t}",
            "lineNumber": 227
          },
          {
            "text": "\t}",
            "lineNumber": 228
          },
          {
            "lineNumber": 229
          },
          {
            "text": "\tonunload() {",
            "lineNumber": 230
          },
          {
            "text": "\t\tterminateAllKernels();",
            "lineNumber": 231
          },
          {
            "text": "\t\tconst id = (this as unknown as { _roleLabelsIntervalId?: number })._roleLabelsIntervalId;",
            "lineNumber": 232
          },
          {
            "text": "\t\tif (id != null) clearInterval(id);",
            "lineNumber": 233
          },
          {
            "text": "\t}",
            "lineNumber": 234
          },
          {
            "lineNumber": 235
          },
          {
            "text": "\tasync loadSettings() {",
            "lineNumber": 236
          },
          {
            "text": "\t\tthis.settings = Object.assign(",
            "lineNumber": 237
          },
          {
            "text": "\t\t\t{},",
            "lineNumber": 238
          },
          {
            "text": "\t\t\tDEFAULT_SETTINGS,",
            "lineNumber": 239
          },
          {
            "lineNumber": 241
          },
          {
            "text": "\t}",
            "lineNumber": 242
          },
          {
            "text": "}",
            "lineNumber": 348,
            "isSignature": true
          }
        ]
      },
      "score": 0.27821075916290283
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "column": 61
          },
          "endPosition": {
            "line": 30,
            "column": 108
          }
        },
        "contents": "import {DEFAULT_SETTINGS, ZettelPluginSettings, ZettelSettingTab} from \"./settings\";\nimport {ZettelControlsView, ZETTEL_CONTROLS_VIEW_TYPE} from \"./views/ZettelControlsView\";\nimport {\n\tdismissAllOutput as runnerDismissAllOutput,\n\tdismissOutput as runnerDismissOutput,\n\trunChain as runnerRunChain,\n\trunEntireCanvas as runnerRunEntireCanvas,\n\trunNode as runnerRunNode,\n} from \"./engine/runner\";\nimport {\n\tclearCanvasEdgeModeLabels,\n\tclearCanvasLegend,\n\tclearCanvasRoleLabels,\n\tsyncCanvasEdgeModeLabels,\n\tsyncCanvasRoleLabels,\n} from \"./canvas/canvasNodeLabels\";\nimport {getKernelForCanvas, terminateAllKernels, terminateKernel} from \"./engine/kernelManager\";\n\n/** Resolve canvas node id from context-menu payload (shape may vary by Obsidian version). */\nfunction resolveCanvasNodeId(node: unknown): string | undefined {\n\tif (!node || typeof node !== \"object\") return undefined;\n\tconst n = node as Record&lt;string, unknown&gt;;\n\tif (typeof n.id === \"string\") return n.id;\n\tconst inner = n.node as Record&lt;string, unknown&gt; | undefined;\n\tif (inner &amp;&amp; typeof inner.id === \"string\") return inner.id;\n\tconst data = typeof n.getData === \"function\" ? (n.getData as () =&gt; { id?: string })() : undefined;\n\treturn data?.id;\n}\n\n/** Debug: set to true when canvas:node-menu callback has fired at least once (proves event is received). */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "import {DEFAULT_SETTINGS, ZettelPluginSettings, ZettelSettingTab} from \"./settings\";",
            "lineNumber": 2
          },
          {
            "text": "import {ZettelControlsView, ZETTEL_CONTROLS_VIEW_TYPE} from \"./views/ZettelControlsView\";",
            "lineNumber": 3
          },
          {
            "text": "import {",
            "lineNumber": 4
          },
          {
            "text": "\tdismissAllOutput as runnerDismissAllOutput,",
            "lineNumber": 5
          },
          {
            "text": "\tdismissOutput as runnerDismissOutput,",
            "lineNumber": 6
          },
          {
            "text": "\trunChain as runnerRunChain,",
            "lineNumber": 7
          },
          {
            "text": "\trunEntireCanvas as runnerRunEntireCanvas,",
            "lineNumber": 8
          },
          {
            "text": "\trunNode as runnerRunNode,",
            "lineNumber": 9
          },
          {
            "text": "} from \"./engine/runner\";",
            "lineNumber": 10
          },
          {
            "text": "import {",
            "lineNumber": 11
          },
          {
            "text": "\tclearCanvasEdgeModeLabels,",
            "lineNumber": 12
          },
          {
            "text": "\tclearCanvasLegend,",
            "lineNumber": 13
          },
          {
            "text": "\tclearCanvasRoleLabels,",
            "lineNumber": 14
          },
          {
            "text": "\tsyncCanvasEdgeModeLabels,",
            "lineNumber": 15
          },
          {
            "text": "\tsyncCanvasRoleLabels,",
            "lineNumber": 16
          },
          {
            "text": "} from \"./canvas/canvasNodeLabels\";",
            "lineNumber": 17
          },
          {
            "text": "import {getKernelForCanvas, terminateAllKernels, terminateKernel} from \"./engine/kernelManager\";",
            "lineNumber": 18
          },
          {
            "lineNumber": 19
          },
          {
            "text": "/** Resolve canvas node id from context-menu payload (shape may vary by Obsidian version). */",
            "lineNumber": 20
          },
          {
            "text": "function resolveCanvasNodeId(node: unknown): string | undefined {",
            "lineNumber": 21,
            "isSignature": true
          },
          {
            "text": "\tif (!node || typeof node !== \"object\") return undefined;",
            "lineNumber": 22
          },
          {
            "text": "\tconst n = node as Record&lt;string, unknown&gt;;",
            "lineNumber": 23
          },
          {
            "text": "\tif (typeof n.id === \"string\") return n.id;",
            "lineNumber": 24
          },
          {
            "text": "\tconst inner = n.node as Record&lt;string, unknown&gt; | undefined;",
            "lineNumber": 25
          },
          {
            "text": "\tif (inner &amp;&amp; typeof inner.id === \"string\") return inner.id;",
            "lineNumber": 26
          },
          {
            "text": "\tconst data = typeof n.getData === \"function\" ? (n.getData as () =&gt; { id?: string })() : undefined;",
            "lineNumber": 27
          },
          {
            "text": "\treturn data?.id;",
            "lineNumber": 28
          },
          {
            "text": "}",
            "lineNumber": 29,
            "isSignature": true
          },
          {
            "lineNumber": 30
          },
          {
            "text": "/** Debug: set to true when canvas:node-menu callback has fired at least once (proves event is received). */",
            "lineNumber": 31
          }
        ]
      },
      "score": 0.2729015350341797
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/canvasNodeLabels.ts",
        "range": {
          "startPosition": {
            "line": 129,
            "column": 1
          },
          "endPosition": {
            "line": 173,
            "column": 102
          }
        },
        "contents": "/**\n * Sync floating role labels for the active canvas: for each node whose color maps to a role,\n * add a small label above the node (e.g. \"Comment\", \"Python\"). Removes existing labels first.\n * Uses the live canvas node map to find each node's DOM element (.canvas-node).\n * @param isStillActive - if provided, called after async load; when false we skip applying to avoid stale canvas\n */\nexport async function syncCanvasRoleLabels(\n\tvault: Vault,\n\tcanvasFilePath: string,\n\tcontainerEl: HTMLElement,\n\tsettings: ZettelPluginSettings,\n\tcanvas: LiveCanvas | null,\n\tisStillActive?: () =&gt; boolean\n): Promise&lt;void&gt; {\n\tif (!settings.showNodeRoleLabels) {\n\t\tclearCanvasRoleLabels(containerEl);\n\t\tclearCanvasLegend(containerEl);\n\t\treturn;\n\t}\n\tconst data = await loadCanvasData(vault, canvasFilePath);\n\tif (isStillActive &amp;&amp; !isStillActive()) return;\n\tif (!data?.nodes) {\n\t\tclearCanvasRoleLabels(containerEl);\n\t\tclearCanvasLegend(containerEl);\n\t\treturn;\n\t}\n\tclearCanvasRoleLabels(containerEl);\n\tsyncCanvasLegend(containerEl, settings);\n\tfor (const node of data.nodes) {\n\t\tconst role = getNodeRole(node, settings);\n\t\tif (!role) continue;\n\t\tconst labelText = getRoleLabel(role, settings);\n\t\tconst nodeEl =\n\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, node.id)) ||\n\t\t\tfindNodeElementByDataId(containerEl, node.id);\n\t\tif (!nodeEl) continue;\n\t\tconst label = createLabelEl(labelText);\n\t\t// Append after .canvas-node-container so it matches Obsidian file node label position\n\t\tnodeEl.append(label);\n\t}\n}\n\n/** Get the midpoint of an SVG path in path coordinate system (for positioning label on the arrow). */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/**",
            "lineNumber": 132
          },
          {
            "text": " * Sync floating role labels for the active canvas: for each node whose color maps to a role,",
            "lineNumber": 133
          },
          {
            "text": " * add a small label above the node (e.g. \"Comment\", \"Python\"). Removes existing labels first.",
            "lineNumber": 134
          },
          {
            "text": " * Uses the live canvas node map to find each node's DOM element (.canvas-node).",
            "lineNumber": 135
          },
          {
            "text": " * @param isStillActive - if provided, called after async load; when false we skip applying to avoid stale canvas",
            "lineNumber": 136
          },
          {
            "text": " */",
            "lineNumber": 137
          },
          {
            "text": "export async function syncCanvasRoleLabels(",
            "lineNumber": 138,
            "isSignature": true
          },
          {
            "text": "\tvault: Vault,",
            "lineNumber": 139,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 140,
            "isSignature": true
          },
          {
            "text": "\tcontainerEl: HTMLElement,",
            "lineNumber": 141,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 142,
            "isSignature": true
          },
          {
            "text": "\tcanvas: LiveCanvas | null,",
            "lineNumber": 143,
            "isSignature": true
          },
          {
            "text": "\tisStillActive?: () =&gt; boolean",
            "lineNumber": 144,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;void&gt; {",
            "lineNumber": 145,
            "isSignature": true
          },
          {
            "text": "\tif (!settings.showNodeRoleLabels) {",
            "lineNumber": 146
          },
          {
            "text": "\t\tclearCanvasRoleLabels(containerEl);",
            "lineNumber": 147
          },
          {
            "text": "\t\tclearCanvasLegend(containerEl);",
            "lineNumber": 148
          },
          {
            "text": "\t\treturn;",
            "lineNumber": 149
          },
          {
            "text": "\t}",
            "lineNumber": 150
          },
          {
            "text": "\tconst data = await loadCanvasData(vault, canvasFilePath);",
            "lineNumber": 151
          },
          {
            "text": "\tif (isStillActive &amp;&amp; !isStillActive()) return;",
            "lineNumber": 152
          },
          {
            "text": "\tif (!data?.nodes) {",
            "lineNumber": 153
          },
          {
            "text": "\t\tclearCanvasRoleLabels(containerEl);",
            "lineNumber": 154
          },
          {
            "text": "\t\tclearCanvasLegend(containerEl);",
            "lineNumber": 155
          },
          {
            "text": "\t\treturn;",
            "lineNumber": 156
          },
          {
            "text": "\t}",
            "lineNumber": 157
          },
          {
            "text": "\tclearCanvasRoleLabels(containerEl);",
            "lineNumber": 158
          },
          {
            "text": "\tsyncCanvasLegend(containerEl, settings);",
            "lineNumber": 159
          },
          {
            "text": "\tfor (const node of data.nodes) {",
            "lineNumber": 160
          },
          {
            "text": "\t\tconst role = getNodeRole(node, settings);",
            "lineNumber": 161
          },
          {
            "text": "\t\tif (!role) continue;",
            "lineNumber": 162
          },
          {
            "text": "\t\tconst labelText = getRoleLabel(role, settings);",
            "lineNumber": 163
          },
          {
            "text": "\t\tconst nodeEl =",
            "lineNumber": 164
          },
          {
            "text": "\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, node.id)) ||",
            "lineNumber": 165
          },
          {
            "text": "\t\t\tfindNodeElementByDataId(containerEl, node.id);",
            "lineNumber": 166
          },
          {
            "text": "\t\tif (!nodeEl) continue;",
            "lineNumber": 167
          },
          {
            "text": "\t\tconst label = createLabelEl(labelText);",
            "lineNumber": 168
          },
          {
            "text": "\t\t// Append after .canvas-node-container so it matches Obsidian file node label position",
            "lineNumber": 169
          },
          {
            "text": "\t\tnodeEl.append(label);",
            "lineNumber": 170
          },
          {
            "text": "\t}",
            "lineNumber": 171
          },
          {
            "text": "}",
            "lineNumber": 172,
            "isSignature": true
          },
          {
            "lineNumber": 173
          },
          {
            "text": "/** Get the midpoint of an SVG path in path coordinate system (for positioning label on the arrow). */",
            "lineNumber": 174
          }
        ]
      },
      "score": 0.2585749924182892
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 33
          },
          "endPosition": {
            "line": 347,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\nasync activateZettelControls(): Promise&lt;void&gt; {\n\n\t\tconst leaf = workspace.getRightLeaf(false);\n\t\tif (leaf != null) {\n\t\t\tawait leaf.setViewState({ type: ZETTEL_CONTROLS_VIEW_TYPE });\n\t\t\tworkspace.revealLeaf(leaf);\n\t\t}\n\t}\n\n\t/** Returns the active canvas view if the active leaf is a canvas. */\n\tgetActiveCanvasView(): { canvas: unknown; file: { path: string }; containerEl: HTMLElement } | null {\n\t\tconst leaf = this.app.workspace.activeLeaf;\n\t\tif (!leaf?.view) return null;\n\t\tconst v = leaf.view as {\n\t\t\tgetViewType?: () =&gt; string;\n\t\t\tcanvas?: unknown;\n\t\t\tfile?: { path: string };\n\t\t\tcontainerEl?: HTMLElement;\n\t\t};\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 34,
                "column": 1
              },
              "endPosition": {
                "line": 34,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 34,
                "column": 16
              },
              "endPosition": {
                "line": 35,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 34,
            "isSignature": true
          },
          {
            "text": "async activateZettelControls(): Promise&lt;void&gt; {",
            "lineNumber": 248
          },
          {
            "lineNumber": 255
          },
          {
            "text": "\t\tconst leaf = workspace.getRightLeaf(false);",
            "lineNumber": 256
          },
          {
            "text": "\t\tif (leaf != null) {",
            "lineNumber": 257
          },
          {
            "text": "\t\t\tawait leaf.setViewState({ type: ZETTEL_CONTROLS_VIEW_TYPE });",
            "lineNumber": 258
          },
          {
            "text": "\t\t\tworkspace.revealLeaf(leaf);",
            "lineNumber": 259
          },
          {
            "text": "\t\t}",
            "lineNumber": 260
          },
          {
            "text": "\t}",
            "lineNumber": 261
          },
          {
            "lineNumber": 262
          },
          {
            "text": "\t/** Returns the active canvas view if the active leaf is a canvas. */",
            "lineNumber": 263
          },
          {
            "text": "\tgetActiveCanvasView(): { canvas: unknown; file: { path: string }; containerEl: HTMLElement } | null {",
            "lineNumber": 264
          },
          {
            "text": "\t\tconst leaf = this.app.workspace.activeLeaf;",
            "lineNumber": 265
          },
          {
            "text": "\t\tif (!leaf?.view) return null;",
            "lineNumber": 266
          },
          {
            "text": "\t\tconst v = leaf.view as {",
            "lineNumber": 267
          },
          {
            "text": "\t\t\tgetViewType?: () =&gt; string;",
            "lineNumber": 268
          },
          {
            "text": "\t\t\tcanvas?: unknown;",
            "lineNumber": 269
          },
          {
            "text": "\t\t\tfile?: { path: string };",
            "lineNumber": 270
          },
          {
            "text": "\t\t\tcontainerEl?: HTMLElement;",
            "lineNumber": 271
          },
          {
            "text": "\t\t};",
            "lineNumber": 272
          },
          {
            "text": "\t}",
            "lineNumber": 276
          },
          {
            "text": "}",
            "lineNumber": 348,
            "isSignature": true
          }
        ]
      },
      "score": 0.24460099637508392
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/canvasApi.ts",
        "range": {
          "startPosition": {
            "column": 86
          },
          "endPosition": {
            "line": 15,
            "column": 1
          }
        },
        "contents": "export interface LiveCanvas {\n\tcreateTextNode(options: {\n\t\ttext: string;\n\t\tpos: { x: number; y: number };\n\t\tsize: { width: number; height: number };\n\t\tsave?: boolean;\n\t\tfocus?: boolean;\n\t}): { id: string; x: number; y: number; width: number; height: number; moveTo: (pos: { x: number; y: number }) =&gt; void; resize: (size: { width: number; height: number }) =&gt; void };\n\taddNode(node: unknown): void;\n\trequestSave?: () =&gt; void;\n\tremoveNode?(node: unknown): void;\n\tnodes?: Map&lt;string, unknown&gt; | Iterable&lt;unknown&gt;;\n\t/** If present, used to refresh canvas after edge label updates (Obsidian canvas view). */\n\tsetData?(data: unknown): void;\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "export interface LiveCanvas {",
            "lineNumber": 2,
            "isSignature": true
          },
          {
            "text": "\tcreateTextNode(options: {",
            "lineNumber": 3
          },
          {
            "text": "\t\ttext: string;",
            "lineNumber": 4
          },
          {
            "text": "\t\tpos: { x: number; y: number };",
            "lineNumber": 5
          },
          {
            "text": "\t\tsize: { width: number; height: number };",
            "lineNumber": 6
          },
          {
            "text": "\t\tsave?: boolean;",
            "lineNumber": 7
          },
          {
            "text": "\t\tfocus?: boolean;",
            "lineNumber": 8
          },
          {
            "text": "\t}): { id: string; x: number; y: number; width: number; height: number; moveTo: (pos: { x: number; y: number }) =&gt; void; resize: (size: { width: number; height: number }) =&gt; void };",
            "lineNumber": 9
          },
          {
            "text": "\taddNode(node: unknown): void;",
            "lineNumber": 10
          },
          {
            "text": "\trequestSave?: () =&gt; void;",
            "lineNumber": 11
          },
          {
            "text": "\tremoveNode?(node: unknown): void;",
            "lineNumber": 12
          },
          {
            "text": "\tnodes?: Map&lt;string, unknown&gt; | Iterable&lt;unknown&gt;;",
            "lineNumber": 13
          },
          {
            "text": "\t/** If present, used to refresh canvas after edge label updates (Obsidian canvas view). */",
            "lineNumber": 14
          },
          {
            "text": "\tsetData?(data: unknown): void;",
            "lineNumber": 15,
            "isSignature": true
          },
          {
            "text": "}",
            "lineNumber": 16,
            "isSignature": true
          }
        ]
      },
      "score": 0.22915519773960114
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 33
          },
          "endPosition": {
            "line": 347,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\n\n\n\t/** Dismiss all output nodes on the canvas (call from canvas background context menu). */\n\tasync dismissAllOutput(): Promise&lt;void&gt; {\n\t\tconst view = this.getActiveCanvasView();\n\t\tif (!view) return;\n\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;\n\t\tawait runnerDismissAllOutput(this.app.vault, view.file.path, liveCanvas);\n\t}\n\n\t/** Get kernel for the active (or first open) canvas (for side panel to wire obsidian_log). */\n\tgetKernelForActiveCanvas(): import(\"./engine/pythonKernel\").PythonKernel | null {\n\t\t\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 34,
                "column": 1
              },
              "endPosition": {
                "line": 34,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 34,
                "column": 16
              },
              "endPosition": {
                "line": 35,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 34,
            "isSignature": true
          },
          {
            "lineNumber": 332
          },
          {
            "lineNumber": 333
          },
          {
            "text": "\t/** Dismiss all output nodes on the canvas (call from canvas background context menu). */",
            "lineNumber": 334
          },
          {
            "text": "\tasync dismissAllOutput(): Promise&lt;void&gt; {",
            "lineNumber": 335
          },
          {
            "text": "\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 336
          },
          {
            "text": "\t\tif (!view) return;",
            "lineNumber": 337
          },
          {
            "text": "\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;",
            "lineNumber": 338
          },
          {
            "text": "\t\tawait runnerDismissAllOutput(this.app.vault, view.file.path, liveCanvas);",
            "lineNumber": 339
          },
          {
            "text": "\t}",
            "lineNumber": 340
          },
          {
            "lineNumber": 341
          },
          {
            "text": "\t/** Get kernel for the active (or first open) canvas (for side panel to wire obsidian_log). */",
            "lineNumber": 342
          },
          {
            "text": "\tgetKernelForActiveCanvas(): import(\"./engine/pythonKernel\").PythonKernel | null {",
            "lineNumber": 343
          },
          {
            "text": "\t\t",
            "lineNumber": 344
          },
          {
            "text": "\t}",
            "lineNumber": 347
          },
          {
            "text": "}",
            "lineNumber": 348,
            "isSignature": true
          }
        ]
      },
      "score": 0.22442549467086792
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/settings.ts",
        "range": {
          "startPosition": {
            "line": 175
          },
          "endPosition": {
            "line": 312,
            "column": 1
          }
        },
        "contents": "export class ZettelSettingTab extends PluginSettingTab {\n\n\n\tdisplay(): void {\n\t\tconst {containerEl} = this;\n\t\tcontainerEl.empty();\n\t\tconst s = this.plugin.settings;\n\n\t\t// How to run: one-line hint (per UX suggestion)\n\t\tconst hint = containerEl.createDiv({ cls: \"ztb-settings-hint setting-item-description\" });\n\t\thint.setText(\"Right-click a node on the canvas and choose Run node or Run chain.\");\n\n\t\t// Execution: what runs (primary model, secondary model, Python path)\n\t\tconst executionSection = containerEl.createDiv({ cls: \"ztb-settings-section\" });\n\t\texecutionSection.createEl(\"h4\", { text: \"Execution\", cls: \"ztb-section-title\" });\n\t\tconst ollamaContainer = executionSection.createDiv({ cls: \"ztb-ollama-settings\" });\n\t\tconst loadingEl = ollamaContainer.createDiv({ cls: \"ztb-ollama-loading\" });\n\t\tloadingEl.setText(\"Loading Ollama models\");\n\t\t(async () =&gt; {\n\t\t\tconst models = await fetchOllamaModels();\n\t\t\tloadingEl.remove();\n\t\t\tif (models.length === 0) {\n\t\t\t\tconst fallback = ollamaContainer.createDiv({ cls: \"ztb-ollama-fallback\" });\n\t\t\t\tfallback.createEl(\"p\", { text: \"Ollama not reachable or no models. Enter model names manually.\" });\n\t\t\t\tnew Setting(ollamaContainer)\n\t\t\t\t\t.setName(\"Model node (primary)\")\n\t\t\t\t\t.setDesc(\"Ollama model used when you run a primary model node (e.g. llama2)\")\n\t\t\t\t\t.addText((text) =&gt; text\n\t\t\t\t\t\t.setPlaceholder(\"e.g. llama2\")\n\t\t\t\t\t\t.setValue(s.ollamaOrangeModel)\n\t\t\t\t\t\t.onChange(async (value) =&gt; {\n\t\t\t\t\t\t\tthis.plugin.settings.ollamaOrangeModel = value;\n\t\t\t\t\t\t\tawait this.plugin.saveSettings();\n\t\t\t\t\t\t}));\n\t\t\t\tnew Setting(ollamaContainer)\n\t\t\t\t\t.setName(\"Model node (secondary)\")\n\t\t\t\t\t.setDesc(\"Ollama model used when you run a secondary model node\")\n\t\t\t\t\t.addText((text) =&gt; text\n\t\t\t\t\t\t.setPlaceholder(\"e.g. mistral\")\n\t\t\t\t\t\t.setValue(s.ollamaPurpleModel)\n\t\t\t\t\t\t.onChange(async (value) =&gt; {\n\t\t\t\t\t\t\ts.ollamaPurpleModel = value;\n\t\t\t\t\t\t\tawait this.plugin.saveSettings();\n\t\t\t\t\t\t}));\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tnew Setting(ollamaContainer)\n\t\t\t\t.setName(\"Model node (primary)\")\n\t\t\t\t.setDesc\n\n\t\t}\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 176,
                "column": 1
              },
              "endPosition": {
                "line": 176,
                "column": 8
              }
            },
            {
              "startPosition": {
                "line": 176,
                "column": 8
              },
              "endPosition": {
                "line": 177,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export class ZettelSettingTab extends PluginSettingTab {",
            "lineNumber": 176,
            "isSignature": true
          },
          {
            "lineNumber": 182
          },
          {
            "lineNumber": 183
          },
          {
            "text": "\tdisplay(): void {",
            "lineNumber": 184
          },
          {
            "text": "\t\tconst {containerEl} = this;",
            "lineNumber": 185
          },
          {
            "text": "\t\tcontainerEl.empty();",
            "lineNumber": 186
          },
          {
            "text": "\t\tconst s = this.plugin.settings;",
            "lineNumber": 187
          },
          {
            "lineNumber": 188
          },
          {
            "text": "\t\t// How to run: one-line hint (per UX suggestion)",
            "lineNumber": 189
          },
          {
            "text": "\t\tconst hint = containerEl.createDiv({ cls: \"ztb-settings-hint setting-item-description\" });",
            "lineNumber": 190
          },
          {
            "text": "\t\thint.setText(\"Right-click a node on the canvas and choose Run node or Run chain.\");",
            "lineNumber": 191
          },
          {
            "lineNumber": 192
          },
          {
            "text": "\t\t// Execution: what runs (primary model, secondary model, Python path)",
            "lineNumber": 193
          },
          {
            "text": "\t\tconst executionSection = containerEl.createDiv({ cls: \"ztb-settings-section\" });",
            "lineNumber": 194
          },
          {
            "text": "\t\texecutionSection.createEl(\"h4\", { text: \"Execution\", cls: \"ztb-section-title\" });",
            "lineNumber": 195
          },
          {
            "text": "\t\tconst ollamaContainer = executionSection.createDiv({ cls: \"ztb-ollama-settings\" });",
            "lineNumber": 196
          },
          {
            "text": "\t\tconst loadingEl = ollamaContainer.createDiv({ cls: \"ztb-ollama-loading\" });",
            "lineNumber": 197
          },
          {
            "text": "\t\tloadingEl.setText(\"Loading Ollama models\");",
            "lineNumber": 198
          },
          {
            "text": "\t\t(async () =&gt; {",
            "lineNumber": 199
          },
          {
            "text": "\t\t\tconst models = await fetchOllamaModels();",
            "lineNumber": 200
          },
          {
            "text": "\t\t\tloadingEl.remove();",
            "lineNumber": 201
          },
          {
            "text": "\t\t\tif (models.length === 0) {",
            "lineNumber": 202
          },
          {
            "text": "\t\t\t\tconst fallback = ollamaContainer.createDiv({ cls: \"ztb-ollama-fallback\" });",
            "lineNumber": 203
          },
          {
            "text": "\t\t\t\tfallback.createEl(\"p\", { text: \"Ollama not reachable or no models. Enter model names manually.\" });",
            "lineNumber": 204
          },
          {
            "text": "\t\t\t\tnew Setting(ollamaContainer)",
            "lineNumber": 205
          },
          {
            "text": "\t\t\t\t\t.setName(\"Model node (primary)\")",
            "lineNumber": 206
          },
          {
            "text": "\t\t\t\t\t.setDesc(\"Ollama model used when you run a primary model node (e.g. llama2)\")",
            "lineNumber": 207
          },
          {
            "text": "\t\t\t\t\t.addText((text) =&gt; text",
            "lineNumber": 208
          },
          {
            "text": "\t\t\t\t\t\t.setPlaceholder(\"e.g. llama2\")",
            "lineNumber": 209
          },
          {
            "text": "\t\t\t\t\t\t.setValue(s.ollamaOrangeModel)",
            "lineNumber": 210
          },
          {
            "text": "\t\t\t\t\t\t.onChange(async (value) =&gt; {",
            "lineNumber": 211
          },
          {
            "text": "\t\t\t\t\t\t\tthis.plugin.settings.ollamaOrangeModel = value;",
            "lineNumber": 212
          },
          {
            "text": "\t\t\t\t\t\t\tawait this.plugin.saveSettings();",
            "lineNumber": 213
          },
          {
            "text": "\t\t\t\t\t\t}));",
            "lineNumber": 214
          },
          {
            "text": "\t\t\t\tnew Setting(ollamaContainer)",
            "lineNumber": 215
          },
          {
            "text": "\t\t\t\t\t.setName(\"Model node (secondary)\")",
            "lineNumber": 216
          },
          {
            "text": "\t\t\t\t\t.setDesc(\"Ollama model used when you run a secondary model node\")",
            "lineNumber": 217
          },
          {
            "text": "\t\t\t\t\t.addText((text) =&gt; text",
            "lineNumber": 218
          },
          {
            "text": "\t\t\t\t\t\t.setPlaceholder(\"e.g. mistral\")",
            "lineNumber": 219
          },
          {
            "text": "\t\t\t\t\t\t.setValue(s.ollamaPurpleModel)",
            "lineNumber": 220
          },
          {
            "text": "\t\t\t\t\t\t.onChange(async (value) =&gt; {",
            "lineNumber": 221
          },
          {
            "text": "\t\t\t\t\t\t\ts.ollamaPurpleModel = value;",
            "lineNumber": 222
          },
          {
            "text": "\t\t\t\t\t\t\tawait this.plugin.saveSettings();",
            "lineNumber": 223
          },
          {
            "text": "\t\t\t\t\t\t}));",
            "lineNumber": 224
          },
          {
            "text": "\t\t\t\treturn;",
            "lineNumber": 225
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 226
          },
          {
            "text": "\t\t\tnew Setting(ollamaContainer)",
            "lineNumber": 227
          },
          {
            "text": "\t\t\t\t.setName(\"Model node (primary)\")",
            "lineNumber": 228
          },
          {
            "text": "\t\t\t\t.setDesc",
            "lineNumber": 229
          },
          {
            "lineNumber": 238
          },
          {
            "text": "\t\t}",
            "lineNumber": 251
          },
          {
            "text": "\t}",
            "lineNumber": 312
          },
          {
            "text": "}",
            "lineNumber": 313,
            "isSignature": true
          }
        ]
      },
      "score": 0.22373104095458984
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 349,
            "column": 3
          },
          "endPosition": {
            "line": 357,
            "column": 2
          }
        },
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 34,
                "column": 1
              },
              "endPosition": {
                "line": 34,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 34,
                "column": 16
              },
              "endPosition": {
                "line": 35,
                "column": 2
              }
            }
          ]
        }
      },
      "score": 0.22290420532226562
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 33
          },
          "endPosition": {
            "line": 347,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\n\n\n\t/** Run chain from roots to the given node (call from context menu with node id). */\n\tasync runChain(nodeId: string): Promise&lt;void&gt; {\n\t\tconst view = this.getActiveCanvasView();\n\t\tif (!view) return;\n\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;\n\t\tconst result = await runnerRunChain(this.app, this.settings, view.file.path, nodeId, liveCanvas);\n\t\tif (!result.ok) new Notice(result.message ?? \"Run chain failed.\");\n\t}\n\n\t/** Dismiss the Green output node for the given source node (call from context menu with node id). */\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 34,
                "column": 1
              },
              "endPosition": {
                "line": 34,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 34,
                "column": 16
              },
              "endPosition": {
                "line": 35,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 34,
            "isSignature": true
          },
          {
            "lineNumber": 306
          },
          {
            "lineNumber": 307
          },
          {
            "text": "\t/** Run chain from roots to the given node (call from context menu with node id). */",
            "lineNumber": 308
          },
          {
            "text": "\tasync runChain(nodeId: string): Promise&lt;void&gt; {",
            "lineNumber": 309
          },
          {
            "text": "\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 310
          },
          {
            "text": "\t\tif (!view) return;",
            "lineNumber": 311
          },
          {
            "text": "\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;",
            "lineNumber": 312
          },
          {
            "text": "\t\tconst result = await runnerRunChain(this.app, this.settings, view.file.path, nodeId, liveCanvas);",
            "lineNumber": 313
          },
          {
            "text": "\t\tif (!result.ok) new Notice(result.message ?? \"Run chain failed.\");",
            "lineNumber": 314
          },
          {
            "text": "\t}",
            "lineNumber": 315
          },
          {
            "lineNumber": 316
          },
          {
            "text": "\t/** Dismiss the Green output node for the given source node (call from context menu with node id). */",
            "lineNumber": 317
          },
          {
            "text": "}",
            "lineNumber": 348,
            "isSignature": true
          }
        ]
      },
      "score": 0.22225899994373322
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/settings.ts",
        "range": {
          "startPosition": {
            "line": 175
          },
          "endPosition": {
            "line": 312,
            "column": 1
          }
        },
        "contents": "export class ZettelSettingTab extends PluginSettingTab {\ndisplay(): void {\n\n\n\t\t);\n\t\taddColorSetting(\n\t\t\tcolorsSection,\n\t\t\tthis.plugin,\n\t\t\t\"blue\",\n\t\t\t\"Python node\",\n\t\t\t\"Color for the Python node on the canvas\"\n\t\t);\n\t\taddColorSetting(\n\t\t\tcolorsSection,\n\t\t\tthis.plugin,\n\t\t\t\"yellow\",\n\t\t\t\"Comment node\",\n\t\t\t\"Color for the comment (pass-through) node on the canvas\"\n\t\t);\n\t\taddColorSetting(\n\t\t\tcolorsSection,\n\t\t\tthis.plugin,\n\t\t\t\"green\",\n\t\t\t\"Output node\",\n\t\t\t\"Color for auto-generated output nodes on the canvas\"\n\t\t);\n\n\t\tnew Setting(colorsSection)\n\t\t\t.setName(\"Show role labels on canvas\")\n\t\t\t.setDesc(\"Show a floating label above each node (e.g. Comment, Python) based on its color\")\n\t\t\t.addToggle((toggle) =&gt; toggle\n\t\t\t\t.setValue(s.showNodeRoleLabels)\n\t\t\t\t.onChange(async (value) =&gt; {\n\t\t\t\t\tthis.plugin.settings.showNodeRoleLabels = value;\n\t\t\t\t\tawait this.plugin.saveSettings();\n\t\t\t\t}));\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 176,
                "column": 1
              },
              "endPosition": {
                "line": 176,
                "column": 8
              }
            },
            {
              "startPosition": {
                "line": 176,
                "column": 8
              },
              "endPosition": {
                "line": 177,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 184,
                "column": 2
              },
              "endPosition": {
                "line": 185,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export class ZettelSettingTab extends PluginSettingTab {",
            "lineNumber": 176,
            "isSignature": true
          },
          {
            "text": "display(): void {",
            "lineNumber": 184
          },
          {
            "lineNumber": 274
          },
          {
            "lineNumber": 279
          },
          {
            "text": "\t\t);",
            "lineNumber": 280
          },
          {
            "text": "\t\taddColorSetting(",
            "lineNumber": 281
          },
          {
            "text": "\t\t\tcolorsSection,",
            "lineNumber": 282
          },
          {
            "text": "\t\t\tthis.plugin,",
            "lineNumber": 283
          },
          {
            "text": "\t\t\t\"blue\",",
            "lineNumber": 284
          },
          {
            "text": "\t\t\t\"Python node\",",
            "lineNumber": 285
          },
          {
            "text": "\t\t\t\"Color for the Python node on the canvas\"",
            "lineNumber": 286
          },
          {
            "text": "\t\t);",
            "lineNumber": 287
          },
          {
            "text": "\t\taddColorSetting(",
            "lineNumber": 288
          },
          {
            "text": "\t\t\tcolorsSection,",
            "lineNumber": 289
          },
          {
            "text": "\t\t\tthis.plugin,",
            "lineNumber": 290
          },
          {
            "text": "\t\t\t\"yellow\",",
            "lineNumber": 291
          },
          {
            "text": "\t\t\t\"Comment node\",",
            "lineNumber": 292
          },
          {
            "text": "\t\t\t\"Color for the comment (pass-through) node on the canvas\"",
            "lineNumber": 293
          },
          {
            "text": "\t\t);",
            "lineNumber": 294
          },
          {
            "text": "\t\taddColorSetting(",
            "lineNumber": 295
          },
          {
            "text": "\t\t\tcolorsSection,",
            "lineNumber": 296
          },
          {
            "text": "\t\t\tthis.plugin,",
            "lineNumber": 297
          },
          {
            "text": "\t\t\t\"green\",",
            "lineNumber": 298
          },
          {
            "text": "\t\t\t\"Output node\",",
            "lineNumber": 299
          },
          {
            "text": "\t\t\t\"Color for auto-generated output nodes on the canvas\"",
            "lineNumber": 300
          },
          {
            "text": "\t\t);",
            "lineNumber": 301
          },
          {
            "lineNumber": 302
          },
          {
            "text": "\t\tnew Setting(colorsSection)",
            "lineNumber": 303
          },
          {
            "text": "\t\t\t.setName(\"Show role labels on canvas\")",
            "lineNumber": 304
          },
          {
            "text": "\t\t\t.setDesc(\"Show a floating label above each node (e.g. Comment, Python) based on its color\")",
            "lineNumber": 305
          },
          {
            "text": "\t\t\t.addToggle((toggle) =&gt; toggle",
            "lineNumber": 306
          },
          {
            "text": "\t\t\t\t.setValue(s.showNodeRoleLabels)",
            "lineNumber": 307
          },
          {
            "text": "\t\t\t\t.onChange(async (value) =&gt; {",
            "lineNumber": 308
          },
          {
            "text": "\t\t\t\t\tthis.plugin.settings.showNodeRoleLabels = value;",
            "lineNumber": 309
          },
          {
            "text": "\t\t\t\t\tawait this.plugin.saveSettings();",
            "lineNumber": 310
          },
          {
            "text": "\t\t\t\t}));",
            "lineNumber": 311
          },
          {
            "text": "\t}",
            "lineNumber": 312
          },
          {
            "text": "}",
            "lineNumber": 313,
            "isSignature": true
          }
        ]
      },
      "score": 0.20863354206085205
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/views/ZettelControlsView.ts",
        "range": {
          "startPosition": {
            "line": 4,
            "column": 59
          },
          "endPosition": {
            "line": 126,
            "column": 1
          }
        },
        "contents": "/** In-memory env vars (not persisted). */\nconst envVars: Record&lt;string, string&gt; = {};\n\nexport class ZettelControlsView extends ItemView {\n\tconstructor(leaf: WorkspaceLeaf, public readonly plugin: IZettelThinkingBoardPlugin) {\n\t\tsuper(leaf);\n\t}\n\n\tgetViewType(): string {\n\t\treturn ZETTEL_CONTROLS_VIEW_TYPE;\n\t}\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** In-memory env vars (not persisted). */",
            "lineNumber": 7
          },
          {
            "text": "const envVars: Record&lt;string, string&gt; = {};",
            "lineNumber": 8
          },
          {
            "lineNumber": 9
          },
          {
            "text": "export class ZettelControlsView extends ItemView {",
            "lineNumber": 10,
            "isSignature": true
          },
          {
            "text": "\tconstructor(leaf: WorkspaceLeaf, public readonly plugin: IZettelThinkingBoardPlugin) {",
            "lineNumber": 11
          },
          {
            "text": "\t\tsuper(leaf);",
            "lineNumber": 12
          },
          {
            "text": "\t}",
            "lineNumber": 13
          },
          {
            "lineNumber": 14
          },
          {
            "text": "\tgetViewType(): string {",
            "lineNumber": 15
          },
          {
            "text": "\t\treturn ZETTEL_CONTROLS_VIEW_TYPE;",
            "lineNumber": 16
          },
          {
            "text": "\t}",
            "lineNumber": 17
          },
          {
            "text": "}",
            "lineNumber": 127,
            "isSignature": true
          }
        ]
      },
      "score": 0.20715489983558655
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/settings.ts",
        "range": {
          "startPosition": {
            "line": 94,
            "column": 1
          },
          "endPosition": {
            "line": 173,
            "column": 1
          }
        },
        "contents": "function addColorSetting(\n\tcontainerEl: HTMLElement,\n\tplugin: Plugin &amp; { settings: ZettelPluginSettings; saveSettings(): Promise&lt;void&gt; },\n\trole: NodeRole,\n\tlabel: string,\n\tdesc: string\n): void {\n\tconst key = &#96;color${role.charAt(0).toUpperCase() + role.slice(1)}&#96; as keyof ZettelPluginSettings;\n\tconst current = plugin.settings[key] as CanvasColor;\n\tconst isPreset = /^[1-6]$/.test(current);\n\tconst presetValue = isPreset ? current : \"1\";\n\tconst customValue = isPreset ? \"\" : current;\n\n\tconst row = containerEl.createDiv({ cls: \"setting-item\" });\n\tconst info = row.createDiv({ cls: \"setting-item-info\" });\n\tinfo.createEl(\"div\", { cls: \"setting-item-name\", text: label });\n\tinfo.createEl(\"div\", { cls: \"setting-item-description\", text: desc });\n\tconst control = row.createDiv({ cls: \"setting-item-control\" });\n\n\tconst swatchWrap = control.createSpan({ cls: \"ztb-color-swatch-wrap\" });\n\tconst swatch = swatchWrap.createSpan({ cls: \"ztb-color-swatch\" });\n\tif (isPreset) {\n\t\tsetSwatchToPreset(swatch, presetValue);\n\t\tswatch.setAttr(\"title\", PRESET_COLORS.find((p) =&gt; p.value === presetValue)?.label ?? \"Preset\");\n\t} else {\n\t\tsetSwatchToCustom(swatch, customValue || \"#888\");\n\t\tswatch.setAttr(\"title\", customValue || \"Custom\");\n\t}\n\n\tconst dropdown = control.createEl(\"select\", { cls: \"dropdown\" });\n\tPRESET_COLORS.forEach((p) =&gt; {\n\t\tconst opt = dropdown.createEl(\"option\", { text: p.label });\n\t\topt.value = p.value;\n\t\tif (p.value === presetValue) opt.selected = true;\n\t});\n\tconst customOpt = dropdown.createEl(\"option\", { text: \"Custom (hex)\" });\n\tcustomOpt.value = \"custom\";\n\tif (!isPreset) customOpt.selected = true;\n\tconst updateSwatch = () =&gt; {\n\t\tconst v = dropdown.value;\n\t\tif (v === \"custom\") {\n\t\t\tsetSwatchToCustom(swatch, customHex.value.trim() || \"#888\");\n\t\t\tswatch.setAttr(\"title\", customHex.value.trim() || \"Custom\");\n\t\t} else {\n\t\t\tsetSwatchToPreset(swatch, v);\n\t\t\tswatch.setAttr(\"title\", PRESET_COLORS.find((x) =&gt; x.value === v)?.label ?? \"Preset\");\n\t\t}\n\t};\n\tdropdown.addEventListener(\"change\", () =&gt; {\n\t\tconst v = dropdown.value;\n\t}\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "function addColorSetting(",
            "lineNumber": 97,
            "isSignature": true
          },
          {
            "text": "\tcontainerEl: HTMLElement,",
            "lineNumber": 98,
            "isSignature": true
          },
          {
            "text": "\tplugin: Plugin &amp; { settings: ZettelPluginSettings; saveSettings(): Promise&lt;void&gt; },",
            "lineNumber": 99,
            "isSignature": true
          },
          {
            "text": "\trole: NodeRole,",
            "lineNumber": 100,
            "isSignature": true
          },
          {
            "text": "\tlabel: string,",
            "lineNumber": 101,
            "isSignature": true
          },
          {
            "text": "\tdesc: string",
            "lineNumber": 102,
            "isSignature": true
          },
          {
            "text": "): void {",
            "lineNumber": 103,
            "isSignature": true
          },
          {
            "text": "\tconst key = &#96;color${role.charAt(0).toUpperCase() + role.slice(1)}&#96; as keyof ZettelPluginSettings;",
            "lineNumber": 104
          },
          {
            "text": "\tconst current = plugin.settings[key] as CanvasColor;",
            "lineNumber": 105
          },
          {
            "text": "\tconst isPreset = /^[1-6]$/.test(current);",
            "lineNumber": 106
          },
          {
            "text": "\tconst presetValue = isPreset ? current : \"1\";",
            "lineNumber": 107
          },
          {
            "text": "\tconst customValue = isPreset ? \"\" : current;",
            "lineNumber": 108
          },
          {
            "lineNumber": 109
          },
          {
            "text": "\tconst row = containerEl.createDiv({ cls: \"setting-item\" });",
            "lineNumber": 110
          },
          {
            "text": "\tconst info = row.createDiv({ cls: \"setting-item-info\" });",
            "lineNumber": 111
          },
          {
            "text": "\tinfo.createEl(\"div\", { cls: \"setting-item-name\", text: label });",
            "lineNumber": 112
          },
          {
            "text": "\tinfo.createEl(\"div\", { cls: \"setting-item-description\", text: desc });",
            "lineNumber": 113
          },
          {
            "text": "\tconst control = row.createDiv({ cls: \"setting-item-control\" });",
            "lineNumber": 114
          },
          {
            "lineNumber": 115
          },
          {
            "text": "\tconst swatchWrap = control.createSpan({ cls: \"ztb-color-swatch-wrap\" });",
            "lineNumber": 116
          },
          {
            "text": "\tconst swatch = swatchWrap.createSpan({ cls: \"ztb-color-swatch\" });",
            "lineNumber": 117
          },
          {
            "text": "\tif (isPreset) {",
            "lineNumber": 118
          },
          {
            "text": "\t\tsetSwatchToPreset(swatch, presetValue);",
            "lineNumber": 119
          },
          {
            "text": "\t\tswatch.setAttr(\"title\", PRESET_COLORS.find((p) =&gt; p.value === presetValue)?.label ?? \"Preset\");",
            "lineNumber": 120
          },
          {
            "text": "\t} else {",
            "lineNumber": 121
          },
          {
            "text": "\t\tsetSwatchToCustom(swatch, customValue || \"#888\");",
            "lineNumber": 122
          },
          {
            "text": "\t\tswatch.setAttr(\"title\", customValue || \"Custom\");",
            "lineNumber": 123
          },
          {
            "text": "\t}",
            "lineNumber": 124
          },
          {
            "lineNumber": 125
          },
          {
            "text": "\tconst dropdown = control.createEl(\"select\", { cls: \"dropdown\" });",
            "lineNumber": 126
          },
          {
            "text": "\tPRESET_COLORS.forEach((p) =&gt; {",
            "lineNumber": 127
          },
          {
            "text": "\t\tconst opt = dropdown.createEl(\"option\", { text: p.label });",
            "lineNumber": 128
          },
          {
            "text": "\t\topt.value = p.value;",
            "lineNumber": 129
          },
          {
            "text": "\t\tif (p.value === presetValue) opt.selected = true;",
            "lineNumber": 130
          },
          {
            "text": "\t});",
            "lineNumber": 131
          },
          {
            "text": "\tconst customOpt = dropdown.createEl(\"option\", { text: \"Custom (hex)\" });",
            "lineNumber": 132
          },
          {
            "text": "\tcustomOpt.value = \"custom\";",
            "lineNumber": 133
          },
          {
            "text": "\tif (!isPreset) customOpt.selected = true;",
            "lineNumber": 134
          },
          {
            "text": "\tconst updateSwatch = () =&gt; {",
            "lineNumber": 135
          },
          {
            "text": "\t\tconst v = dropdown.value;",
            "lineNumber": 136
          },
          {
            "text": "\t\tif (v === \"custom\") {",
            "lineNumber": 137
          },
          {
            "text": "\t\t\tsetSwatchToCustom(swatch, customHex.value.trim() || \"#888\");",
            "lineNumber": 138
          },
          {
            "text": "\t\t\tswatch.setAttr(\"title\", customHex.value.trim() || \"Custom\");",
            "lineNumber": 139
          },
          {
            "text": "\t\t} else {",
            "lineNumber": 140
          },
          {
            "text": "\t\t\tsetSwatchToPreset(swatch, v);",
            "lineNumber": 141
          },
          {
            "text": "\t\t\tswatch.setAttr(\"title\", PRESET_COLORS.find((x) =&gt; x.value === v)?.label ?? \"Preset\");",
            "lineNumber": 142
          },
          {
            "text": "\t\t}",
            "lineNumber": 143
          },
          {
            "text": "\t};",
            "lineNumber": 144
          },
          {
            "text": "\tdropdown.addEventListener(\"change\", () =&gt; {",
            "lineNumber": 145
          },
          {
            "text": "\t\tconst v = dropdown.value;",
            "lineNumber": 146
          },
          {
            "text": "\t}",
            "lineNumber": 155
          },
          {
            "text": "}",
            "lineNumber": 174,
            "isSignature": true
          }
        ]
      },
      "score": 0.2048102617263794
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 33
          },
          "endPosition": {
            "line": 347,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\n\n\n\t/** Dismiss the Green output node for the given source node (call from context menu with node id). */\n\tasync dismissOutput(nodeId: string): Promise&lt;void&gt; {\n\t\tconst view = this.getActiveCanvasView();\n\t\tif (!view) return;\n\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;\n\t\tawait runnerDismissOutput(this.app.vault, view.file.path, nodeId, this.settings, liveCanvas);\n\t}\n\n\t/** Run entire canvas (call from canvas background context menu). */\n\tasync runEntireCanvas(): Promise&lt;void&gt; {\n\t\tconst view = this.getActiveCanvasView();\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 34,
                "column": 1
              },
              "endPosition": {
                "line": 34,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 34,
                "column": 16
              },
              "endPosition": {
                "line": 35,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 34,
            "isSignature": true
          },
          {
            "lineNumber": 315
          },
          {
            "lineNumber": 316
          },
          {
            "text": "\t/** Dismiss the Green output node for the given source node (call from context menu with node id). */",
            "lineNumber": 317
          },
          {
            "text": "\tasync dismissOutput(nodeId: string): Promise&lt;void&gt; {",
            "lineNumber": 318
          },
          {
            "text": "\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 319
          },
          {
            "text": "\t\tif (!view) return;",
            "lineNumber": 320
          },
          {
            "text": "\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;",
            "lineNumber": 321
          },
          {
            "text": "\t\tawait runnerDismissOutput(this.app.vault, view.file.path, nodeId, this.settings, liveCanvas);",
            "lineNumber": 322
          },
          {
            "text": "\t}",
            "lineNumber": 323
          },
          {
            "lineNumber": 324
          },
          {
            "text": "\t/** Run entire canvas (call from canvas background context menu). */",
            "lineNumber": 325
          },
          {
            "text": "\tasync runEntireCanvas(): Promise&lt;void&gt; {",
            "lineNumber": 326
          },
          {
            "text": "\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 327
          },
          {
            "text": "\t}",
            "lineNumber": 332
          },
          {
            "text": "}",
            "lineNumber": 348,
            "isSignature": true
          }
        ]
      },
      "score": 0.19864743947982788
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/canvasNodeLabels.ts",
        "range": {
          "startPosition": {
            "line": 84,
            "column": 1
          },
          "endPosition": {
            "line": 122,
            "column": 92
          }
        },
        "contents": "/** Build and append the color legend to the canvas container (vanilla DOM, no innerHTML). */\nfunction syncCanvasLegend(containerEl: HTMLElement, settings: ZettelPluginSettings): void {\n\tclearCanvasLegend(containerEl);\n\tif (!settings.showNodeRoleLabels) return;\n\tconst legend = document.createElement(\"div\");\n\tlegend.setAttribute(\"class\", LEGEND_CLASS);\n\tconst title = document.createElement(\"div\");\n\ttitle.setAttribute(\"class\", \"ztb-legend-title\");\n\ttitle.textContent = \"Colors\";\n\tlegend.appendChild(title);\n\tfor (const role of ROLES) {\n\t\tconst key = &#96;color${role.charAt(0).toUpperCase() + role.slice(1)}&#96; as keyof ZettelPluginSettings;\n\t\tconst color = (settings[key] as CanvasColor) ?? \"\";\n\t\tconst row = document.createElement(\"div\");\n\t\trow.setAttribute(\"class\", \"ztb-legend-row\");\n\t\trow.appendChild(createLegendSwatch(color));\n\t\tconst text = document.createElement(\"span\");\n\t\ttext.setAttribute(\"class\", \"ztb-legend-text\");\n\t\ttext.textContent = getRoleLabel(role, settings);\n\t\trow.appendChild(text);\n\t\tlegend.appendChild(row);\n\t}\n\tconst otherRow = document.createElement(\"div\");\n\totherRow.setAttribute(\"class\", \"ztb-legend-row\");\n\tconst otherSwatch = document.createElement(\"span\");\n\totherSwatch.setAttribute(\"class\", \"ztb-legend-swatch ztb-legend-swatch--other\");\n\totherSwatch.style.backgroundColor = \"var(--text-muted)\";\n\totherRow.appendChild(otherSwatch);\n\tconst otherText = document.createElement(\"span\");\n\totherText.setAttribute(\"class\", \"ztb-legend-text\");\n\totherText.textContent = \"Other colors = Comment\";\n\totherRow.appendChild(otherText);\n\tlegend.appendChild(otherRow);\n\tcontainerEl.appendChild(legend);\n}\n\n/** Create a label element using Obsidian's canvas-node-label class (same as file nodes). */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Build and append the color legend to the canvas container (vanilla DOM, no innerHTML). */",
            "lineNumber": 87
          },
          {
            "text": "function syncCanvasLegend(containerEl: HTMLElement, settings: ZettelPluginSettings): void {",
            "lineNumber": 88,
            "isSignature": true
          },
          {
            "text": "\tclearCanvasLegend(containerEl);",
            "lineNumber": 89
          },
          {
            "text": "\tif (!settings.showNodeRoleLabels) return;",
            "lineNumber": 90
          },
          {
            "text": "\tconst legend = document.createElement(\"div\");",
            "lineNumber": 91
          },
          {
            "text": "\tlegend.setAttribute(\"class\", LEGEND_CLASS);",
            "lineNumber": 92
          },
          {
            "text": "\tconst title = document.createElement(\"div\");",
            "lineNumber": 93
          },
          {
            "text": "\ttitle.setAttribute(\"class\", \"ztb-legend-title\");",
            "lineNumber": 94
          },
          {
            "text": "\ttitle.textContent = \"Colors\";",
            "lineNumber": 95
          },
          {
            "text": "\tlegend.appendChild(title);",
            "lineNumber": 96
          },
          {
            "text": "\tfor (const role of ROLES) {",
            "lineNumber": 97
          },
          {
            "text": "\t\tconst key = &#96;color${role.charAt(0).toUpperCase() + role.slice(1)}&#96; as keyof ZettelPluginSettings;",
            "lineNumber": 98
          },
          {
            "text": "\t\tconst color = (settings[key] as CanvasColor) ?? \"\";",
            "lineNumber": 99
          },
          {
            "text": "\t\tconst row = document.createElement(\"div\");",
            "lineNumber": 100
          },
          {
            "text": "\t\trow.setAttribute(\"class\", \"ztb-legend-row\");",
            "lineNumber": 101
          },
          {
            "text": "\t\trow.appendChild(createLegendSwatch(color));",
            "lineNumber": 102
          },
          {
            "text": "\t\tconst text = document.createElement(\"span\");",
            "lineNumber": 103
          },
          {
            "text": "\t\ttext.setAttribute(\"class\", \"ztb-legend-text\");",
            "lineNumber": 104
          },
          {
            "text": "\t\ttext.textContent = getRoleLabel(role, settings);",
            "lineNumber": 105
          },
          {
            "text": "\t\trow.appendChild(text);",
            "lineNumber": 106
          },
          {
            "text": "\t\tlegend.appendChild(row);",
            "lineNumber": 107
          },
          {
            "text": "\t}",
            "lineNumber": 108
          },
          {
            "text": "\tconst otherRow = document.createElement(\"div\");",
            "lineNumber": 109
          },
          {
            "text": "\totherRow.setAttribute(\"class\", \"ztb-legend-row\");",
            "lineNumber": 110
          },
          {
            "text": "\tconst otherSwatch = document.createElement(\"span\");",
            "lineNumber": 111
          },
          {
            "text": "\totherSwatch.setAttribute(\"class\", \"ztb-legend-swatch ztb-legend-swatch--other\");",
            "lineNumber": 112
          },
          {
            "text": "\totherSwatch.style.backgroundColor = \"var(--text-muted)\";",
            "lineNumber": 113
          },
          {
            "text": "\totherRow.appendChild(otherSwatch);",
            "lineNumber": 114
          },
          {
            "text": "\tconst otherText = document.createElement(\"span\");",
            "lineNumber": 115
          },
          {
            "text": "\totherText.setAttribute(\"class\", \"ztb-legend-text\");",
            "lineNumber": 116
          },
          {
            "text": "\totherText.textContent = \"Other colors = Comment\";",
            "lineNumber": 117
          },
          {
            "text": "\totherRow.appendChild(otherText);",
            "lineNumber": 118
          },
          {
            "text": "\tlegend.appendChild(otherRow);",
            "lineNumber": 119
          },
          {
            "text": "\tcontainerEl.appendChild(legend);",
            "lineNumber": 120
          },
          {
            "text": "}",
            "lineNumber": 121,
            "isSignature": true
          },
          {
            "lineNumber": 122
          },
          {
            "text": "/** Create a label element using Obsidian's canvas-node-label class (same as file nodes). */",
            "lineNumber": 123
          }
        ]
      },
      "score": 0.1872638463973999
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/views/ZettelControlsView.ts",
        "range": {
          "startPosition": {
            "column": 66
          },
          "endPosition": {
            "line": 7,
            "column": 43
          }
        },
        "contents": "import type {IZettelThinkingBoardPlugin} from \"../types\";\nimport {terminateKernel} from \"../engine/kernelManager\";\n\nexport const ZETTEL_CONTROLS_VIEW_TYPE = \"zettel-controls\";\n\n/** In-memory env vars (not persisted). */\nconst envVars: Record&lt;string, string&gt; = {};",
        "signatures": {},
        "detailedLines": [
          {
            "text": "import type {IZettelThinkingBoardPlugin} from \"../types\";",
            "lineNumber": 2
          },
          {
            "text": "import {terminateKernel} from \"../engine/kernelManager\";",
            "lineNumber": 3
          },
          {
            "lineNumber": 4
          },
          {
            "text": "export const ZETTEL_CONTROLS_VIEW_TYPE = \"zettel-controls\";",
            "lineNumber": 5
          },
          {
            "lineNumber": 6
          },
          {
            "text": "/** In-memory env vars (not persisted). */",
            "lineNumber": 7
          },
          {
            "text": "const envVars: Record&lt;string, string&gt; = {};",
            "lineNumber": 8
          }
        ]
      },
      "score": 0.18635420501232147
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/canvasNodeLabels.ts",
        "range": {
          "startPosition": {
            "line": 15,
            "column": 61
          },
          "endPosition": {
            "line": 53,
            "column": 1
          }
        },
        "contents": "const ROLES: NodeRole[] = [\"orange\", \"purple\", \"blue\", \"yellow\", \"green\"];\n\n/** Try to get a canvas node's root DOM element from the live canvas (Obsidian uses .canvas-node, no data-id). */\nfunction getNodeElFromCanvas(canvas: LiveCanvas, nodeId: string): HTMLElement | null {\n\tconst nodes = canvas.nodes;\n\tif (!nodes) return null;\n\tlet view: {\n\t\tid?: string;\n\t\tnodeEl?: HTMLElement;\n\t\tel?: HTMLElement;\n\t\twrapperEl?: HTMLElement;\n\t\tcontainerEl?: HTMLElement;\n\t} | undefined;\n\tif (nodes instanceof Map) {\n\t\tview = nodes.get(nodeId) as typeof view;\n\t} else {\n\t\tfor (const n of nodes as Iterable&lt;typeof view&gt;) {\n\t\t\tif (n?.id === nodeId) {\n\t\t\t\tview = n;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\tif (!view) return null;\n\t// Obsidian canvas node view exposes the .canvas-node root via one of these\n\tif (view.nodeEl instanceof HTMLElement) return view.nodeEl;\n\tif (view.el instanceof HTMLElement) return view.el;\n\tif (view.wrapperEl instanceof HTMLElement) return view.wrapperEl;\n\tif (view.containerEl instanceof HTMLElement) return view.containerEl;\n\tif (view instanceof HTMLElement) return view;\n\treturn null;\n}\n\n/** Fallback: find node by data-id if present (some builds may use it). */\nfunction findNodeElementByDataId(containerEl: HTMLElement, nodeId: string): HTMLElement | null {\n\t\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "const ROLES: NodeRole[] = [\"orange\", \"purple\", \"blue\", \"yellow\", \"green\"];",
            "lineNumber": 17
          },
          {
            "lineNumber": 18
          },
          {
            "text": "/** Try to get a canvas node's root DOM element from the live canvas (Obsidian uses .canvas-node, no data-id). */",
            "lineNumber": 19
          },
          {
            "text": "function getNodeElFromCanvas(canvas: LiveCanvas, nodeId: string): HTMLElement | null {",
            "lineNumber": 20,
            "isSignature": true
          },
          {
            "text": "\tconst nodes = canvas.nodes;",
            "lineNumber": 21
          },
          {
            "text": "\tif (!nodes) return null;",
            "lineNumber": 22
          },
          {
            "text": "\tlet view: {",
            "lineNumber": 23
          },
          {
            "text": "\t\tid?: string;",
            "lineNumber": 24
          },
          {
            "text": "\t\tnodeEl?: HTMLElement;",
            "lineNumber": 25
          },
          {
            "text": "\t\tel?: HTMLElement;",
            "lineNumber": 26
          },
          {
            "text": "\t\twrapperEl?: HTMLElement;",
            "lineNumber": 27
          },
          {
            "text": "\t\tcontainerEl?: HTMLElement;",
            "lineNumber": 28
          },
          {
            "text": "\t} | undefined;",
            "lineNumber": 29
          },
          {
            "text": "\tif (nodes instanceof Map) {",
            "lineNumber": 30
          },
          {
            "text": "\t\tview = nodes.get(nodeId) as typeof view;",
            "lineNumber": 31
          },
          {
            "text": "\t} else {",
            "lineNumber": 32
          },
          {
            "text": "\t\tfor (const n of nodes as Iterable&lt;typeof view&gt;) {",
            "lineNumber": 33
          },
          {
            "text": "\t\t\tif (n?.id === nodeId) {",
            "lineNumber": 34
          },
          {
            "text": "\t\t\t\tview = n;",
            "lineNumber": 35
          },
          {
            "text": "\t\t\t\tbreak;",
            "lineNumber": 36
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 37
          },
          {
            "text": "\t\t}",
            "lineNumber": 38
          },
          {
            "text": "\t}",
            "lineNumber": 39
          },
          {
            "text": "\tif (!view) return null;",
            "lineNumber": 40
          },
          {
            "text": "\t// Obsidian canvas node view exposes the .canvas-node root via one of these",
            "lineNumber": 41
          },
          {
            "text": "\tif (view.nodeEl instanceof HTMLElement) return view.nodeEl;",
            "lineNumber": 42
          },
          {
            "text": "\tif (view.el instanceof HTMLElement) return view.el;",
            "lineNumber": 43
          },
          {
            "text": "\tif (view.wrapperEl instanceof HTMLElement) return view.wrapperEl;",
            "lineNumber": 44
          },
          {
            "text": "\tif (view.containerEl instanceof HTMLElement) return view.containerEl;",
            "lineNumber": 45
          },
          {
            "text": "\tif (view instanceof HTMLElement) return view;",
            "lineNumber": 46
          },
          {
            "text": "\treturn null;",
            "lineNumber": 47
          },
          {
            "text": "}",
            "lineNumber": 48,
            "isSignature": true
          },
          {
            "lineNumber": 49
          },
          {
            "text": "/** Fallback: find node by data-id if present (some builds may use it). */",
            "lineNumber": 50
          },
          {
            "text": "function findNodeElementByDataId(containerEl: HTMLElement, nodeId: string): HTMLElement | null {",
            "lineNumber": 51,
            "isSignature": true
          },
          {
            "text": "\t",
            "lineNumber": 52
          },
          {
            "text": "}",
            "lineNumber": 54,
            "isSignature": true
          }
        ]
      },
      "score": 0.18216049671173096
    }
  ]
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="web_search">
<details>
            <summary>Tool use: **web_search**  Searched web `undefined`  **1** results</summary>
        
| Title | URL | Chunk |
|-------|-----|-------|
| Web search results for query: Obsidian plugin add button to canvas view toolbar controls |  | Links:<br/>1. [Search code, repositories, users, issues, pull requests...](https://github.com/chrisgurney/obsidian-note-toolbar)<br/>2. [GitHub - racbac/obsidian-canvas-extras: Adds functionality to Obsidian's core Canvas plugin](https://github.com/racbac/obsidian-canvas-extras)<br/>3. [Canvas - Obsidian Help](https://help.obsidian.md/plugins/canvas)<br/>4. [Visualize your ideas.](https://obsidian.md/canvas)<br/>5. [Search code, repositories, users, issues, pull requests...](https://github.com/chrisgurney/obsidian-note-toolbar/wiki/Positioning-toolbars)<br/><br/># Adding a Button to Canvas View Toolbar in Obsidian<br/><br/>Based on the search results, here are the relevant approaches:<br/><br/>## Plugin Options<br/><br/>**Canvas Extras Plugin** [2] is a plugin designed to add functionality to Obsidian's core Canvas plugin. This would be the most direct approach if you're looking to extend canvas-specific toolbar functionality.<br/><br/>**Note Toolbar Plugin** [1] creates flexible, context-aware toolbars for notes and can be positioned in various locations. Importantly, it supports non-markdown files including canvases, PDFs, and videos [5]. This plugin allows you to add toolbars with custom buttons and position them in multiple ways, including:<br/>- Tab bar (next to Reading/Preview mode buttons)<br/>- Top (fixed position above the note)<br/>- Below properties<br/>- And other locations throughout the app<br/><br/>## Development Approach<br/><br/>If you're developing a custom plugin, you would need to work with Obsidian's plugin API. The Canvas Extras plugin [2] is open source and provides an example of a plugin specifically designed to extend Canvas functionality, which you could use as a reference for accessing and modifying canvas toolbar controls.<br/><br/>## Note<br/><br/>Canvas is extensible by design [4], and the Obsidian API is documented to make it "easy to create plugins that add new capabilities to Canvas," though the search results don't provide specific API documentation for toolbar button additions. |

</details>
</tool-use>

---





---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/canvas/canvasNodeLabels.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "containerEl|headerEl|actionBar|titleContainer",
  "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/node_modules/obsidian/obsidian.d.ts",
  "contextBefore": 0,
  "contextAfter": 0,
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "containerEl|headerEl|actionBar|titleContainer",
    "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/node_modules/obsidian/obsidian.d.ts",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board": {
        "content": {
          "matches": [
            {
              "file": "node_modules/obsidian/obsidian.d.ts",
              "matches": [
                {
                  "lineNumber": 957,
                  "content": " * @param containerEl - The container below the Bases toolbar where the view will be displayed."
                },
                {
                  "lineNumber": 961,
                  "content": "export type BasesViewFactory = (controller: QueryController, containerEl: HTMLElement) =&gt; BasesView;"
                },
                {
                  "lineNumber": 1049,
                  "content": "    constructor(containerEl: HTMLElement);"
                },
                {
                  "lineNumber": 1306,
                  "content": "    constructor(containerEl: HTMLElement);"
                },
                {
                  "lineNumber": 1836,
                  "content": "    constructor(containerEl: HTMLElement);"
                },
                {
                  "lineNumber": 2399,
                  "content": "    constructor(containerEl: HTMLElement);"
                },
                {
                  "lineNumber": 3652,
                  "content": "     * Use this to add a dependent child to the renderer such that if the containerEl"
                },
                {
                  "lineNumber": 3705,
                  "content": "    containerEl: HTMLElement;"
                },
                {
                  "lineNumber": 3746,
                  "content": "    containerEl: HTMLElement;"
                },
                {
                  "lineNumber": 3748,
                  "content": "     * @param containerEl - This HTMLElement will be used to test whether this component is still alive."
                },
                {
                  "lineNumber": 3754,
                  "content": "    constructor(containerEl: HTMLElement);"
                },
                {
                  "lineNumber": 4118,
                  "content": "    containerEl: HTMLElement;"
                },
                {
                  "lineNumber": 4269,
                  "content": "    containerEl: HTMLElement;"
                },
                {
                  "lineNumber": 4900,
                  "content": "    constructor(containerEl: HTMLElement);"
                },
                {
                  "lineNumber": 5202,
                  "content": "    constructor(containerEl: HTMLElement);"
                },
                {
                  "lineNumber": 5306,
                  "content": "    constructor(containerEl: HTMLElement);"
                },
                {
                  "lineNumber": 5424,
                  "content": "    containerEl: HTMLElement;"
                },
                {
                  "lineNumber": 5468,
                  "content": "    constructor(containerEl: HTMLElement);"
                },
                {
                  "lineNumber": 5794,
                  "content": "    constructor(containerEl: HTMLElement);"
                },
                {
                  "lineNumber": 5805,
                  "content": "    constructor(containerEl: HTMLElement);"
                },
                {
                  "lineNumber": 5959,
                  "content": "    constructor(containerEl: HTMLElement);"
                },
                {
                  "lineNumber": 6416,
                  "content": "    containerEl: HTMLElement;"
                },
                {
                  "lineNumber": 6605,
                  "content": "    containerEl: HTMLElement;"
                }
              ]
            }
          ],
          "totalLines": 23,
          "totalMatchedLines": 23
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---





---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "addAction|headerEl|View.*canvas",
  "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/node_modules/obsidian/obsidian.d.ts",
  "contextBefore": 0,
  "contextAfter": 1,
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "addAction|headerEl|View.*canvas",
    "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/node_modules/obsidian/obsidian.d.ts",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board": {
        "content": {
          "matches": [
            {
              "file": "node_modules/obsidian/obsidian.d.ts",
              "matches": [
                {
                  "lineNumber": 3244,
                  "content": "    addAction(icon: IconName, title: string, callback: (evt: MouseEvent) =&gt; any): HTMLElement;"
                },
                {
                  "lineNumber": 3245,
                  "isContextLine": true
                }
              ]
            }
          ],
          "totalLines": 2,
          "totalMatchedLines": 1
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/canvas/canvasNodeLabels.ts</summary>

</details>
</tool-use>

---





---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/node_modules/obsidian/obsidian.d.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/node_modules/obsidian/obsidian.d.ts</summary>

</details>
</tool-use>

---





---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/node_modules/obsidian/obsidian.d.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "addAction|TitleBar",
  "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/node_modules/obsidian/obsidian.d.ts",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "addAction|TitleBar",
    "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/node_modules/obsidian/obsidian.d.ts",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board": {
        "content": {
          "matches": [
            {
              "file": "node_modules/obsidian/obsidian.d.ts",
              "matches": [
                {
                  "lineNumber": 3244,
                  "content": "    addAction(icon: IconName, title: string, callback: (evt: MouseEvent) =&gt; any): HTMLElement;"
                }
              ]
            }
          ],
          "totalLines": 1,
          "totalMatchedLines": 1
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---





---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "canvas|Canvas",
  "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/node_modules/obsidian/obsidian.d.ts",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "canvas|Canvas",
    "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/node_modules/obsidian/obsidian.d.ts",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board": {
        "content": {}
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---


Checking how we get the canvas view and whether it exposes a leaf:


---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts</summary>

</details>
</tool-use>

---


Adding canvas toolbar buttons by calling ItemView's addAction when the canvas is active. Checking how to obtain the leaf from the view:


---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/node_modules/obsidian/obsidian.d.ts</summary>

</details>
</tool-use>

---


Implementing: add Run entire canvas and Dismiss all output to the canvas view's title bar via ItemView.addAction when the canvas is active.


---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts</summary>

</details>
</tool-use>

---





---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts</summary>

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts</summary>

</details>

</tool-use>

---


Removing the nonexistent `clearCanvasToolbarButtons` calls  we're adding actions to the view's title bar, not the container.


---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts</summary>

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts</summary>

</details>

</tool-use>

---


Adding a fallback: if the canvas view doesn't support `addAction`, inject a small toolbar into the canvas container (like the legend).


---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/canvas/canvasNodeLabels.ts</summary>

</details>
</tool-use>

---


Adding a fallback toolbar in the canvas container (when addAction isn't available) and implementing it.


---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts</summary>

</details>

</tool-use>

---





---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts</summary>

</details>

</tool-use>

---





---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts</summary>

</details>
</tool-use>

---





---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts</summary>

</details>

</tool-use>

---





---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/styles.css</summary>

</details>
</tool-use>

---





---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/styles.css</summary>

</details>

</tool-use>

---





---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_command_v2">
<details><summary>Tool use: **run_terminal_command_v2**  Run command: cd /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board && npm run build</summary>

```bash
cd /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board && npm run build
```

```

&gt; zettel-thinking-board@1.0.0 build
&gt; tsc -noEmit -skipLibCheck &amp;&amp; node esbuild.config.mjs production


```
</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="read_lints">
<details>
<summary>Tool use: **read_lints**</summary>


Parameters:

```json
{
  "paths": [
    "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts"
  ]
}
```
Result:

```json
{
  "linterErrorsByFile": [
    {
      "relativeWorkspacePath": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts"
    }
  ]
}
```
Status: **completed**


</details>
</tool-use>

---


Summary of what was implemented:

### 1. **Title bar (existing canvas controls)**  
When a canvas is the active tab, the plugin tries to add two actions to the views title bar via **`ItemView.addAction`** (the same API used by other Obsidian views):

- **Run entire canvas** (play icon)
- **Dismiss all output** (trash icon)

They appear in the tab/title row with the other canvas controls. We only add them once per canvas view (tracked with a `WeakSet`).

### 2. **Fallback toolbar in the canvas area**  
If the canvas view doesnt support `addAction` (e.g. its not an `ItemView`), the plugin adds a **small toolbar** inside the canvas container (top-right):

- Same two actions as **buttons**: Run entire canvas and Dismiss all output
- Styled with Obsidian CSS variables (`--background-primary`, `--text-normal`, etc.) so it fits the theme
- Removed when you switch to a non-canvas tab or when the canvas view is closed

So you always get at least one of:

- Two icon buttons in the **tab/title bar** (if the canvas view supports `addAction`), or  
- A **toolbar in the top-right** of the canvas with the two buttons.

Reload the plugin and open a canvas: you should see either the title-bar icons or the top-right toolbar (or both if the view supports `addAction` and the fallback still runs).

---

_**User**_

There is a bug, the plug adds two actions to the view's title bar, and this created multiple sets of these actions instead of only adding two. (this seems to be fixed if I reload and come back, but it returns if the plugin is hot reloaded.

The buttons do seem to be working. 

---

_**Agent (model default, mode Agent)**_


Checking how we're tracking added actions so we can fix duplicate additions on hot reload.


---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2**  Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts</summary>

</details>
</tool-use>

---


Using a property on the view object to mark that we've added actions. On hot reload the plugin gets a new WeakSet, so the view isn't in it and we add duplicate actions; the view object persists, so the property will prevent re-adding.


---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts</summary>

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2**  Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts</summary>

</details>

</tool-use>

---





---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_command_v2">
<details><summary>Tool use: **run_terminal_command_v2**  Run command: cd /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board && npm run build</summary>

```bash
cd /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board && npm run build
```

```

&gt; zettel-thinking-board@1.0.0 build
&gt; tsc -noEmit -skipLibCheck &amp;&amp; node esbuild.config.mjs production


```
</details>
</tool-use>

---


Summary of the fix:

**Cause:** On hot reload the plugin is recreated but the canvas view is not. The **WeakSet** that tracked views we already added actions to was new and empty, so the code treated the same view as untracked and added a second set of title bar actions.

**Change:** Tracking is now done on the **view instance** with a property `_ztbTitleBarActionsAdded` instead of a WeakSet:

1. **Before adding:** If `leaf.view._ztbTitleBarActionsAdded` is set, we consider actions already added and do nothing.
2. **After adding:** We set `itemView._ztbTitleBarActionsAdded = true`.

Because the view object survives hot reload, the flag stays set and we no longer add duplicate actions after a reload. The WeakSet was removed. Build succeeds.

---

