<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session 4cc763c6-0f41-4bf1-b283-3afad8774b3e (2026-02-03 13:16Z) -->

# Output node position bug (2026-02-03 13:16Z)

_**User**_

I have a bug. I don't seem to be able to move the output nodes position. 

---

_**Agent (model default, mode Agent)**_


Searching the codebase for how output nodes and their position/dragging are implemented.


---

<tool-use data-tool-type="unknown" data-tool-name="semantic_search_full">
<details>
<summary>Tool use: **semantic_search_full**</summary>


Parameters:

```json
{
  "query": "Where are output nodes defined and how is their position or dragging handled?",
  "includePattern": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
  "topK": 10,
  "explanation": ""
}
```
Result:

```json
{
  "codeResults": [
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 369,
            "column": 1
          },
          "endPosition": {
            "line": 415,
            "column": 1
          }
        },
        "contents": "/** Choose (x, y) for the output box to avoid overlapping other nodes. Tries default position, then shifts horizontally, then downward. */\nfunction chooseOutputPositionXY(\n\tdata: CanvasData,\n\tsourceNodeId: string,\n\toutNodeId: string | null,\n\tdefaultX: number,\n\tdefaultY: number,\n\twidth: number,\n\theight: number\n): { x: number; y: number } {\n\tconst excludeIds = new Set&lt;string&gt;([sourceNodeId]);\n\tif (outNodeId) excludeIds.add(outNodeId);\n\tconst box = { x: 0, y: 0, width, height };\n\tfunction tryPosition(x: number, y: number): boolean {\n\t\tbox.x = x;\n\t\tbox.y = y;\n\t\tfor (const node of data.nodes) {\n\t\t\tif (excludeIds.has(node.id)) continue;\n\t\t\t// Expand other node by buffer so we keep at least OUTPUT_COLLISION_BUFFER gap\n\t\t\tconst expanded = {\n\t\t\t\tx: node.x - OUTPUT_COLLISION_BUFFER,\n\t\t\t\ty: node.y - OUTPUT_COLLISION_BUFFER,\n\t\t\t\twidth: node.width + 2 * OUTPUT_COLLISION_BUFFER,\n\t\t\t\theight: node.height + 2 * OUTPUT_COLLISION_BUFFER,\n\t\t\t};\n\t\t\tif (rectanglesOverlap(box, expanded)) return false;\n\t\t}\n\t\treturn true;\n\t}\n\tfor (let dy = 0; dy &lt;= OUTPUT_COLLISION_MAX_VERTICAL; dy += OUTPUT_COLLISION_VERTICAL_STEP) {\n\t\tconst candidateY = defaultY + dy;\n\t\tfor (const dx of xOffsets()) {\n\t\t\tif (tryPosition(defaultX + dx, candidateY)) return { x: defaultX + dx, y: candidateY };\n\t\t}\n\t}\n\treturn { x: defaultX, y: defaultY };\n}\n\nfunction* xOffsets(): Generator&lt;number&gt; {\n\tyield 0;\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Choose (x, y) for the output box to avoid overlapping other nodes. Tries default position, then shifts horizontally, then downward. */",
            "lineNumber": 372
          },
          {
            "text": "function chooseOutputPositionXY(",
            "lineNumber": 373,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 374,
            "isSignature": true
          },
          {
            "text": "\tsourceNodeId: string,",
            "lineNumber": 375,
            "isSignature": true
          },
          {
            "text": "\toutNodeId: string | null,",
            "lineNumber": 376,
            "isSignature": true
          },
          {
            "text": "\tdefaultX: number,",
            "lineNumber": 377,
            "isSignature": true
          },
          {
            "text": "\tdefaultY: number,",
            "lineNumber": 378,
            "isSignature": true
          },
          {
            "text": "\twidth: number,",
            "lineNumber": 379,
            "isSignature": true
          },
          {
            "text": "\theight: number",
            "lineNumber": 380,
            "isSignature": true
          },
          {
            "text": "): { x: number; y: number } {",
            "lineNumber": 381,
            "isSignature": true
          },
          {
            "text": "\tconst excludeIds = new Set&lt;string&gt;([sourceNodeId]);",
            "lineNumber": 382
          },
          {
            "text": "\tif (outNodeId) excludeIds.add(outNodeId);",
            "lineNumber": 383
          },
          {
            "text": "\tconst box = { x: 0, y: 0, width, height };",
            "lineNumber": 384
          },
          {
            "text": "\tfunction tryPosition(x: number, y: number): boolean {",
            "lineNumber": 385,
            "isSignature": true
          },
          {
            "text": "\t\tbox.x = x;",
            "lineNumber": 386
          },
          {
            "text": "\t\tbox.y = y;",
            "lineNumber": 387
          },
          {
            "text": "\t\tfor (const node of data.nodes) {",
            "lineNumber": 388
          },
          {
            "text": "\t\t\tif (excludeIds.has(node.id)) continue;",
            "lineNumber": 389
          },
          {
            "text": "\t\t\t// Expand other node by buffer so we keep at least OUTPUT_COLLISION_BUFFER gap",
            "lineNumber": 390
          },
          {
            "text": "\t\t\tconst expanded = {",
            "lineNumber": 391
          },
          {
            "text": "\t\t\t\tx: node.x - OUTPUT_COLLISION_BUFFER,",
            "lineNumber": 392
          },
          {
            "text": "\t\t\t\ty: node.y - OUTPUT_COLLISION_BUFFER,",
            "lineNumber": 393
          },
          {
            "text": "\t\t\t\twidth: node.width + 2 * OUTPUT_COLLISION_BUFFER,",
            "lineNumber": 394
          },
          {
            "text": "\t\t\t\theight: node.height + 2 * OUTPUT_COLLISION_BUFFER,",
            "lineNumber": 395
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 396
          },
          {
            "text": "\t\t\tif (rectanglesOverlap(box, expanded)) return false;",
            "lineNumber": 397
          },
          {
            "text": "\t\t}",
            "lineNumber": 398
          },
          {
            "text": "\t\treturn true;",
            "lineNumber": 399
          },
          {
            "text": "\t}",
            "lineNumber": 400,
            "isSignature": true
          },
          {
            "text": "\tfor (let dy = 0; dy &lt;= OUTPUT_COLLISION_MAX_VERTICAL; dy += OUTPUT_COLLISION_VERTICAL_STEP) {",
            "lineNumber": 401
          },
          {
            "text": "\t\tconst candidateY = defaultY + dy;",
            "lineNumber": 402
          },
          {
            "text": "\t\tfor (const dx of xOffsets()) {",
            "lineNumber": 403
          },
          {
            "text": "\t\t\tif (tryPosition(defaultX + dx, candidateY)) return { x: defaultX + dx, y: candidateY };",
            "lineNumber": 404
          },
          {
            "text": "\t\t}",
            "lineNumber": 405
          },
          {
            "text": "\t}",
            "lineNumber": 406
          },
          {
            "text": "\treturn { x: defaultX, y: defaultY };",
            "lineNumber": 407
          },
          {
            "text": "}",
            "lineNumber": 408,
            "isSignature": true
          },
          {
            "lineNumber": 409
          },
          {
            "text": "function* xOffsets(): Generator&lt;number&gt; {",
            "lineNumber": 410,
            "isSignature": true
          },
          {
            "text": "\tyield 0;",
            "lineNumber": 411
          },
          {
            "text": "}",
            "lineNumber": 416,
            "isSignature": true
          }
        ]
      },
      "score": 0.42064356803894043
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 423,
            "column": 1
          },
          "endPosition": {
            "line": 499,
            "column": 107
          }
        },
        "contents": "/** Create or replace the Green output node and ensure an edge labeled \"output\" from source. Mutates data only. */\nfunction ensureOutputNodeAndEdge(\n\tdata: CanvasData,\n\tsourceNode: AllCanvasNodeData,\n\ttext: string,\n\tsettings: ZettelPluginSettings\n): void {\n\tconst outId = findOutputNodeForSource(data, sourceNode.id, settings);\n\tconst defaultY = sourceNode.y + sourceNode.height + GREEN_NODE_PADDING;\n\tconst width = Math.max(320, sourceNode.width);\n\tconst height = 180;\n\tconst defaultX = sourceNode.x;\n\tconst { x: chosenX, y: chosenY } = chooseOutputPositionXY(\n\t\tdata,\n\t\tsourceNode.id,\n\t\toutId,\n\t\tdefaultX,\n\t\tdefaultY,\n\t\twidth,\n\t\theight\n\t);\n\tconst greenColor = settings.colorGreen;\n\n\tif (outId) {\n\t\tconst outNode = getNodeById(data, outId);\n\t\tif (outNode &amp;&amp; isTextNode(outNode)) {\n\t\t\tconst updated = {\n\t\t\t\t...(outNode as CanvasTextData),\n\t\t\t\ttext,\n\t\t\t\tx: chosenX,\n\t\t\t\ty: chosenY,\n\t\t\t\twidth,\n\t\t\t\theight,\n\t\t\t};\n\t\t\tconst idx = data.nodes.findIndex((n) =&gt; n.id === outId);\n\t\t\tif (idx &gt;= 0) data.nodes[idx] = updated;\n\t\t} else if (outNode) {\n\t\t\t(outNode as { x: number; y: number }).x = chosenX;\n\t\t\t(outNode as { x: number; y: number }).y = chosenY;\n\t\t}\n\t\tconst hasOutputEdge = data.edges.some(\n\t\t\t(e) =&gt; e.fromNode === sourceNode.id &amp;&amp; e.toNode === outId &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT\n\t\t);\n\t\tif (!hasOutputEdge) {\n\t\t\tdata.edges.push({\n\t\t\t\tid: randomId(),\n\t\t\t\tfromNode: sourceNode.id,\n\t\t\t\ttoNode: outId,\n\t\t\t\tlabel: EDGE_LABEL_OUTPUT,\n\t\t\t});\n\t\t}\n\t\treturn;\n\t}\n\n\tconst newNodeId = randomId();\n\tconst newTextNode: CanvasTextData = {\n\t\tid: newNodeId,\n\t\ttype: \"text\",\n\t\ttext,\n\t\tx: chosenX,\n\t\ty: chosenY,\n\t\twidth,\n\t\theight,\n\t\tcolor: greenColor,\n\t};\n\tdata.nodes.push(newTextNode);\n\tdata.edges.push({\n\t\tid: randomId(),\n\t\tfromNode: sourceNode.id,\n\t\ttoNode: newNodeId,\n\t\tlabel: EDGE_LABEL_OUTPUT,\n\t});\n}\n\n/** Run a single node (for \"Run Node\" command). If parents are not run, runs chain to this node instead. */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Create or replace the Green output node and ensure an edge labeled \"output\" from source. Mutates data only. */",
            "lineNumber": 426
          },
          {
            "text": "function ensureOutputNodeAndEdge(",
            "lineNumber": 427,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 428,
            "isSignature": true
          },
          {
            "text": "\tsourceNode: AllCanvasNodeData,",
            "lineNumber": 429,
            "isSignature": true
          },
          {
            "text": "\ttext: string,",
            "lineNumber": 430,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings",
            "lineNumber": 431,
            "isSignature": true
          },
          {
            "text": "): void {",
            "lineNumber": 432,
            "isSignature": true
          },
          {
            "text": "\tconst outId = findOutputNodeForSource(data, sourceNode.id, settings);",
            "lineNumber": 433
          },
          {
            "text": "\tconst defaultY = sourceNode.y + sourceNode.height + GREEN_NODE_PADDING;",
            "lineNumber": 434
          },
          {
            "text": "\tconst width = Math.max(320, sourceNode.width);",
            "lineNumber": 435
          },
          {
            "text": "\tconst height = 180;",
            "lineNumber": 436
          },
          {
            "text": "\tconst defaultX = sourceNode.x;",
            "lineNumber": 437
          },
          {
            "text": "\tconst { x: chosenX, y: chosenY } = chooseOutputPositionXY(",
            "lineNumber": 438
          },
          {
            "text": "\t\tdata,",
            "lineNumber": 439
          },
          {
            "text": "\t\tsourceNode.id,",
            "lineNumber": 440
          },
          {
            "text": "\t\toutId,",
            "lineNumber": 441
          },
          {
            "text": "\t\tdefaultX,",
            "lineNumber": 442
          },
          {
            "text": "\t\tdefaultY,",
            "lineNumber": 443
          },
          {
            "text": "\t\twidth,",
            "lineNumber": 444
          },
          {
            "text": "\t\theight",
            "lineNumber": 445
          },
          {
            "text": "\t);",
            "lineNumber": 446
          },
          {
            "text": "\tconst greenColor = settings.colorGreen;",
            "lineNumber": 447
          },
          {
            "lineNumber": 448
          },
          {
            "text": "\tif (outId) {",
            "lineNumber": 449
          },
          {
            "text": "\t\tconst outNode = getNodeById(data, outId);",
            "lineNumber": 450
          },
          {
            "text": "\t\tif (outNode &amp;&amp; isTextNode(outNode)) {",
            "lineNumber": 451
          },
          {
            "text": "\t\t\tconst updated = {",
            "lineNumber": 452
          },
          {
            "text": "\t\t\t\t...(outNode as CanvasTextData),",
            "lineNumber": 453
          },
          {
            "text": "\t\t\t\ttext,",
            "lineNumber": 454
          },
          {
            "text": "\t\t\t\tx: chosenX,",
            "lineNumber": 455
          },
          {
            "text": "\t\t\t\ty: chosenY,",
            "lineNumber": 456
          },
          {
            "text": "\t\t\t\twidth,",
            "lineNumber": 457
          },
          {
            "text": "\t\t\t\theight,",
            "lineNumber": 458
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 459
          },
          {
            "text": "\t\t\tconst idx = data.nodes.findIndex((n) =&gt; n.id === outId);",
            "lineNumber": 460
          },
          {
            "text": "\t\t\tif (idx &gt;= 0) data.nodes[idx] = updated;",
            "lineNumber": 461
          },
          {
            "text": "\t\t} else if (outNode) {",
            "lineNumber": 462
          },
          {
            "text": "\t\t\t(outNode as { x: number; y: number }).x = chosenX;",
            "lineNumber": 463
          },
          {
            "text": "\t\t\t(outNode as { x: number; y: number }).y = chosenY;",
            "lineNumber": 464
          },
          {
            "text": "\t\t}",
            "lineNumber": 465
          },
          {
            "text": "\t\tconst hasOutputEdge = data.edges.some(",
            "lineNumber": 466
          },
          {
            "text": "\t\t\t(e) =&gt; e.fromNode === sourceNode.id &amp;&amp; e.toNode === outId &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT",
            "lineNumber": 467
          },
          {
            "text": "\t\t);",
            "lineNumber": 468
          },
          {
            "text": "\t\tif (!hasOutputEdge) {",
            "lineNumber": 469
          },
          {
            "text": "\t\t\tdata.edges.push({",
            "lineNumber": 470
          },
          {
            "text": "\t\t\t\tid: randomId(),",
            "lineNumber": 471
          },
          {
            "text": "\t\t\t\tfromNode: sourceNode.id,",
            "lineNumber": 472
          },
          {
            "text": "\t\t\t\ttoNode: outId,",
            "lineNumber": 473
          },
          {
            "text": "\t\t\t\tlabel: EDGE_LABEL_OUTPUT,",
            "lineNumber": 474
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 475
          },
          {
            "text": "\t\t}",
            "lineNumber": 476
          },
          {
            "text": "\t\treturn;",
            "lineNumber": 477
          },
          {
            "text": "\t}",
            "lineNumber": 478
          },
          {
            "lineNumber": 479
          },
          {
            "text": "\tconst newNodeId = randomId();",
            "lineNumber": 480
          },
          {
            "text": "\tconst newTextNode: CanvasTextData = {",
            "lineNumber": 481
          },
          {
            "text": "\t\tid: newNodeId,",
            "lineNumber": 482
          },
          {
            "text": "\t\ttype: \"text\",",
            "lineNumber": 483
          },
          {
            "text": "\t\ttext,",
            "lineNumber": 484
          },
          {
            "text": "\t\tx: chosenX,",
            "lineNumber": 485
          },
          {
            "text": "\t\ty: chosenY,",
            "lineNumber": 486
          },
          {
            "text": "\t\twidth,",
            "lineNumber": 487
          },
          {
            "text": "\t\theight,",
            "lineNumber": 488
          },
          {
            "text": "\t\tcolor: greenColor,",
            "lineNumber": 489
          },
          {
            "text": "\t};",
            "lineNumber": 490
          },
          {
            "text": "\tdata.nodes.push(newTextNode);",
            "lineNumber": 491
          },
          {
            "text": "\tdata.edges.push({",
            "lineNumber": 492
          },
          {
            "text": "\t\tid: randomId(),",
            "lineNumber": 493
          },
          {
            "text": "\t\tfromNode: sourceNode.id,",
            "lineNumber": 494
          },
          {
            "text": "\t\ttoNode: newNodeId,",
            "lineNumber": 495
          },
          {
            "text": "\t\tlabel: EDGE_LABEL_OUTPUT,",
            "lineNumber": 496
          },
          {
            "text": "\t});",
            "lineNumber": 497
          },
          {
            "text": "}",
            "lineNumber": 498,
            "isSignature": true
          },
          {
            "lineNumber": 499
          },
          {
            "text": "/** Run a single node (for \"Run Node\" command). If parents are not run, runs chain to this node instead. */",
            "lineNumber": 500
          }
        ]
      },
      "score": 0.4003705084323883
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/types.ts",
        "range": {
          "startPosition": {
            "line": 121,
            "column": 50
          },
          "endPosition": {
            "line": 156,
            "column": 84
          }
        },
        "contents": "/** Find the Green (output) node for a given source node. Edge-first (label \"output\"), then position fallback. */\nexport function findOutputNodeForSource(\n\tdata: CanvasData,\n\tsourceNodeId: string,\n\tsettings: ZettelPluginSettings\n): string | null {\n\tconst outputEdge = data.edges.find(\n\t\t(e) =&gt; e.fromNode === sourceNodeId &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT\n\t);\n\tif (outputEdge) return outputEdge.toNode;\n\tconst source = getNodeById(data, sourceNodeId);\n\tif (!source) return null;\n\tconst greenColor = normalizeColor(settings.colorGreen as CanvasColor | undefined);\n\tif (!greenColor) return null;\n\tconst expectedY = source.y + source.height + GREEN_NODE_PADDING;\n\tconst toleranceAbove = 30; // allow small layout drift above default\n\tconst candidates: { id: string; centerY: number }[] = [];\n\tfor (const node of data.nodes) {\n\t\tif (node.id === sourceNodeId) continue;\n\t\tif (normalizeColor(node.color) !== greenColor) continue;\n\t\tif (Math.abs(node.x - source.x) &gt; 50) continue;\n\t\tif (node.y &lt; expectedY - toleranceAbove || node.y &gt; expectedY + OUTPUT_POSITION_FALLBACK_MAX_Y) continue;\n\t\tconst centerY = node.y + (node.height ?? 0) / 2;\n\t\tcandidates.push({ id: node.id, centerY });\n\t}\n\tif (candidates.length === 0) return null;\n\t// Prefer the green whose center is closest to expectedY (avoids wrong match when sources are stacked)\n\tconst best = candidates.reduce((a, b) =&gt;\n\t\tMath.abs(a.centerY - expectedY) &lt;= Math.abs(b.centerY - expectedY) ? a : b\n\t);\n\treturn best.id;\n}\n\n/** Check if canvas has any output nodes (green nodes connected by output edges). */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Find the Green (output) node for a given source node. Edge-first (label \"output\"), then position fallback. */",
            "lineNumber": 124
          },
          {
            "text": "export function findOutputNodeForSource(",
            "lineNumber": 125,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 126,
            "isSignature": true
          },
          {
            "text": "\tsourceNodeId: string,",
            "lineNumber": 127,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings",
            "lineNumber": 128,
            "isSignature": true
          },
          {
            "text": "): string | null {",
            "lineNumber": 129,
            "isSignature": true
          },
          {
            "text": "\tconst outputEdge = data.edges.find(",
            "lineNumber": 130
          },
          {
            "text": "\t\t(e) =&gt; e.fromNode === sourceNodeId &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT",
            "lineNumber": 131
          },
          {
            "text": "\t);",
            "lineNumber": 132
          },
          {
            "text": "\tif (outputEdge) return outputEdge.toNode;",
            "lineNumber": 133
          },
          {
            "text": "\tconst source = getNodeById(data, sourceNodeId);",
            "lineNumber": 134
          },
          {
            "text": "\tif (!source) return null;",
            "lineNumber": 135
          },
          {
            "text": "\tconst greenColor = normalizeColor(settings.colorGreen as CanvasColor | undefined);",
            "lineNumber": 136
          },
          {
            "text": "\tif (!greenColor) return null;",
            "lineNumber": 137
          },
          {
            "text": "\tconst expectedY = source.y + source.height + GREEN_NODE_PADDING;",
            "lineNumber": 138
          },
          {
            "text": "\tconst toleranceAbove = 30; // allow small layout drift above default",
            "lineNumber": 139
          },
          {
            "text": "\tconst candidates: { id: string; centerY: number }[] = [];",
            "lineNumber": 140
          },
          {
            "text": "\tfor (const node of data.nodes) {",
            "lineNumber": 141
          },
          {
            "text": "\t\tif (node.id === sourceNodeId) continue;",
            "lineNumber": 142
          },
          {
            "text": "\t\tif (normalizeColor(node.color) !== greenColor) continue;",
            "lineNumber": 143
          },
          {
            "text": "\t\tif (Math.abs(node.x - source.x) &gt; 50) continue;",
            "lineNumber": 144
          },
          {
            "text": "\t\tif (node.y &lt; expectedY - toleranceAbove || node.y &gt; expectedY + OUTPUT_POSITION_FALLBACK_MAX_Y) continue;",
            "lineNumber": 145
          },
          {
            "text": "\t\tconst centerY = node.y + (node.height ?? 0) / 2;",
            "lineNumber": 146
          },
          {
            "text": "\t\tcandidates.push({ id: node.id, centerY });",
            "lineNumber": 147
          },
          {
            "text": "\t}",
            "lineNumber": 148
          },
          {
            "text": "\tif (candidates.length === 0) return null;",
            "lineNumber": 149
          },
          {
            "text": "\t// Prefer the green whose center is closest to expectedY (avoids wrong match when sources are stacked)",
            "lineNumber": 150
          },
          {
            "text": "\tconst best = candidates.reduce((a, b) =&gt;",
            "lineNumber": 151
          },
          {
            "text": "\t\tMath.abs(a.centerY - expectedY) &lt;= Math.abs(b.centerY - expectedY) ? a : b",
            "lineNumber": 152
          },
          {
            "text": "\t);",
            "lineNumber": 153
          },
          {
            "text": "\treturn best.id;",
            "lineNumber": 154
          },
          {
            "text": "}",
            "lineNumber": 155,
            "isSignature": true
          },
          {
            "lineNumber": 156
          },
          {
            "text": "/** Check if canvas has any output nodes (green nodes connected by output edges). */",
            "lineNumber": 157
          }
        ]
      },
      "score": 0.37873315811157227
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "column": 76
          },
          "endPosition": {
            "line": 43,
            "column": 99
          }
        },
        "contents": " from \"obsidian\";\nimport {DEFAULT_SETTINGS, ZettelPluginSettings, ZettelSettingTab} from \"./settings\";\nimport {ZettelControlsView, ZETTEL_CONTROLS_VIEW_TYPE} from \"./views/ZettelControlsView\";\nimport {CanvasTemplateModal} from \"./views/CanvasTemplateModal\";\nimport {duplicateCanvasTemplate, saveCanvasAsTemplate, isCanvasInTemplateFolder} from \"./canvas/canvasTemplates\";\nimport {\n\tdismissAllOutput as runnerDismissAllOutput,\n\tdismissOutput as runnerDismissOutput,\n\trunChain as runnerRunChain,\n\trunEntireCanvas as runnerRunEntireCanvas,\n\trunNode as runnerRunNode,\n} from \"./engine/runner\";\nimport {\n\tclearCanvasEdgeModeLabels,\n\tclearCanvasLegend,\n\tclearCanvasRoleLabels,\n\tsyncCanvasEdgeModeLabels,\n\tsyncCanvasRoleLabels,\n} from \"./canvas/canvasNodeLabels\";\nimport {hasOutputNodes, loadCanvasData, saveCanvasData} from \"./canvas/nodes\";\nimport type {CanvasData} from \"./canvas/types\";\nimport {EDGE_LABEL_OUTPUT} from \"./canvas/types\";\nimport {getKernelForCanvas, terminateAllKernels, terminateKernel} from \"./engine/kernelManager\";\nimport {getExample1CanvasData} from \"./tutorials/example1Data\";\nimport {getExample4CanvasData} from \"./tutorials/example4Data\";\n\n/** Layout constants: comment margins left/right, central lane for nodes, no overlap. */\nconst TUT_LEFT = 80;\nconst TUT_TOP = 50;\nconst TUT_WELCOME_W = 420;\nconst TUT_WELCOME_H = 118;\nconst TUT_WELCOME_BOTTOM_GAP = 70;\n/** Per-column: left comment margin | node lane | right comment margin. */\nconst TUT_COMMENT_W = 185;\nconst TUT_LANE_GAP = 22;\nconst TUT_NODE_LANE_W = 260;\nconst TUT_COL_TOTAL_W = TUT_COMMENT_W + TUT_LANE_GAP + TUT_NODE_LANE_W + TUT_LANE_GAP + TUT_COMMENT_W;\nconst TUT_COL_GAP = 85;\nconst TUT_NODE_H = 115;\nconst TUT_NODE_GAP = 58;\nconst TUT_LABEL_H = 88;\nconst TUT_GROUP_PAD = 18;\n\n/** Resolve role color from settings (fallback to default so tutorial always has a valid color). */",
        "signatures": {},
        "detailedLines": [
          {
            "text": " from \"obsidian\";",
            "lineNumber": 1
          },
          {
            "text": "import {DEFAULT_SETTINGS, ZettelPluginSettings, ZettelSettingTab} from \"./settings\";",
            "lineNumber": 2
          },
          {
            "text": "import {ZettelControlsView, ZETTEL_CONTROLS_VIEW_TYPE} from \"./views/ZettelControlsView\";",
            "lineNumber": 3
          },
          {
            "text": "import {CanvasTemplateModal} from \"./views/CanvasTemplateModal\";",
            "lineNumber": 4
          },
          {
            "text": "import {duplicateCanvasTemplate, saveCanvasAsTemplate, isCanvasInTemplateFolder} from \"./canvas/canvasTemplates\";",
            "lineNumber": 5
          },
          {
            "text": "import {",
            "lineNumber": 6
          },
          {
            "text": "\tdismissAllOutput as runnerDismissAllOutput,",
            "lineNumber": 7
          },
          {
            "text": "\tdismissOutput as runnerDismissOutput,",
            "lineNumber": 8
          },
          {
            "text": "\trunChain as runnerRunChain,",
            "lineNumber": 9
          },
          {
            "text": "\trunEntireCanvas as runnerRunEntireCanvas,",
            "lineNumber": 10
          },
          {
            "text": "\trunNode as runnerRunNode,",
            "lineNumber": 11
          },
          {
            "text": "} from \"./engine/runner\";",
            "lineNumber": 12
          },
          {
            "text": "import {",
            "lineNumber": 13
          },
          {
            "text": "\tclearCanvasEdgeModeLabels,",
            "lineNumber": 14
          },
          {
            "text": "\tclearCanvasLegend,",
            "lineNumber": 15
          },
          {
            "text": "\tclearCanvasRoleLabels,",
            "lineNumber": 16
          },
          {
            "text": "\tsyncCanvasEdgeModeLabels,",
            "lineNumber": 17
          },
          {
            "text": "\tsyncCanvasRoleLabels,",
            "lineNumber": 18
          },
          {
            "text": "} from \"./canvas/canvasNodeLabels\";",
            "lineNumber": 19
          },
          {
            "text": "import {hasOutputNodes, loadCanvasData, saveCanvasData} from \"./canvas/nodes\";",
            "lineNumber": 20
          },
          {
            "text": "import type {CanvasData} from \"./canvas/types\";",
            "lineNumber": 21
          },
          {
            "text": "import {EDGE_LABEL_OUTPUT} from \"./canvas/types\";",
            "lineNumber": 22
          },
          {
            "text": "import {getKernelForCanvas, terminateAllKernels, terminateKernel} from \"./engine/kernelManager\";",
            "lineNumber": 23
          },
          {
            "text": "import {getExample1CanvasData} from \"./tutorials/example1Data\";",
            "lineNumber": 24
          },
          {
            "text": "import {getExample4CanvasData} from \"./tutorials/example4Data\";",
            "lineNumber": 25
          },
          {
            "lineNumber": 26
          },
          {
            "text": "/** Layout constants: comment margins left/right, central lane for nodes, no overlap. */",
            "lineNumber": 27
          },
          {
            "text": "const TUT_LEFT = 80;",
            "lineNumber": 28
          },
          {
            "text": "const TUT_TOP = 50;",
            "lineNumber": 29
          },
          {
            "text": "const TUT_WELCOME_W = 420;",
            "lineNumber": 30
          },
          {
            "text": "const TUT_WELCOME_H = 118;",
            "lineNumber": 31
          },
          {
            "text": "const TUT_WELCOME_BOTTOM_GAP = 70;",
            "lineNumber": 32
          },
          {
            "text": "/** Per-column: left comment margin | node lane | right comment margin. */",
            "lineNumber": 33
          },
          {
            "text": "const TUT_COMMENT_W = 185;",
            "lineNumber": 34
          },
          {
            "text": "const TUT_LANE_GAP = 22;",
            "lineNumber": 35
          },
          {
            "text": "const TUT_NODE_LANE_W = 260;",
            "lineNumber": 36
          },
          {
            "text": "const TUT_COL_TOTAL_W = TUT_COMMENT_W + TUT_LANE_GAP + TUT_NODE_LANE_W + TUT_LANE_GAP + TUT_COMMENT_W;",
            "lineNumber": 37
          },
          {
            "text": "const TUT_COL_GAP = 85;",
            "lineNumber": 38
          },
          {
            "text": "const TUT_NODE_H = 115;",
            "lineNumber": 39
          },
          {
            "text": "const TUT_NODE_GAP = 58;",
            "lineNumber": 40
          },
          {
            "text": "const TUT_LABEL_H = 88;",
            "lineNumber": 41
          },
          {
            "text": "const TUT_GROUP_PAD = 18;",
            "lineNumber": 42
          },
          {
            "lineNumber": 43
          },
          {
            "text": "/** Resolve role color from settings (fallback to default so tutorial always has a valid color). */",
            "lineNumber": 44
          }
        ]
      },
      "score": 0.2964833080768585
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 346,
            "column": 1
          },
          "endPosition": {
            "line": 371,
            "column": 138
          }
        },
        "contents": "/** Max horizontal offset (px) for output box collision avoidance; beyond this we allow overlap. */\nconst OUTPUT_COLLISION_MAX_RADIUS = 500;\n/** Step (px) between candidate x positions when avoiding collisions. */\nconst OUTPUT_COLLISION_STEP = 80;\n/** Max vertical offset (px) below default placement when avoiding collisions. */\nconst OUTPUT_COLLISION_MAX_VERTICAL = 400;\n/** Step (px) between candidate y positions when avoiding vertical collisions. */\nconst OUTPUT_COLLISION_VERTICAL_STEP = 60;\n/** Min gap (px) between output box and other nodes; placement avoids coming within this distance. */\nconst OUTPUT_COLLISION_BUFFER = 24;\n\nfunction rectanglesOverlap(\n\ta: { x: number; y: number; width: number; height: number },\n\tb: { x: number; y: number; width: number; height: number }\n): boolean {\n\treturn !(\n\t\ta.x + a.width &lt;= b.x ||\n\t\tb.x + b.width &lt;= a.x ||\n\t\ta.y + a.height &lt;= b.y ||\n\t\tb.y + b.height &lt;= a.y\n\t);\n}\n\n/** Choose (x, y) for the output box to avoid overlapping other nodes. Tries default position, then shifts horizontally, then downward. */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Max horizontal offset (px) for output box collision avoidance; beyond this we allow overlap. */",
            "lineNumber": 349
          },
          {
            "text": "const OUTPUT_COLLISION_MAX_RADIUS = 500;",
            "lineNumber": 350
          },
          {
            "text": "/** Step (px) between candidate x positions when avoiding collisions. */",
            "lineNumber": 351
          },
          {
            "text": "const OUTPUT_COLLISION_STEP = 80;",
            "lineNumber": 352
          },
          {
            "text": "/** Max vertical offset (px) below default placement when avoiding collisions. */",
            "lineNumber": 353
          },
          {
            "text": "const OUTPUT_COLLISION_MAX_VERTICAL = 400;",
            "lineNumber": 354
          },
          {
            "text": "/** Step (px) between candidate y positions when avoiding vertical collisions. */",
            "lineNumber": 355
          },
          {
            "text": "const OUTPUT_COLLISION_VERTICAL_STEP = 60;",
            "lineNumber": 356
          },
          {
            "text": "/** Min gap (px) between output box and other nodes; placement avoids coming within this distance. */",
            "lineNumber": 357
          },
          {
            "text": "const OUTPUT_COLLISION_BUFFER = 24;",
            "lineNumber": 358
          },
          {
            "lineNumber": 359
          },
          {
            "text": "function rectanglesOverlap(",
            "lineNumber": 360,
            "isSignature": true
          },
          {
            "text": "\ta: { x: number; y: number; width: number; height: number },",
            "lineNumber": 361,
            "isSignature": true
          },
          {
            "text": "\tb: { x: number; y: number; width: number; height: number }",
            "lineNumber": 362,
            "isSignature": true
          },
          {
            "text": "): boolean {",
            "lineNumber": 363,
            "isSignature": true
          },
          {
            "text": "\treturn !(",
            "lineNumber": 364
          },
          {
            "text": "\t\ta.x + a.width &lt;= b.x ||",
            "lineNumber": 365
          },
          {
            "text": "\t\tb.x + b.width &lt;= a.x ||",
            "lineNumber": 366
          },
          {
            "text": "\t\ta.y + a.height &lt;= b.y ||",
            "lineNumber": 367
          },
          {
            "text": "\t\tb.y + b.height &lt;= a.y",
            "lineNumber": 368
          },
          {
            "text": "\t);",
            "lineNumber": 369
          },
          {
            "text": "}",
            "lineNumber": 370,
            "isSignature": true
          },
          {
            "lineNumber": 371
          },
          {
            "text": "/** Choose (x, y) for the output box to avoid overlapping other nodes. Tries default position, then shifts horizontally, then downward. */",
            "lineNumber": 372
          }
        ]
      },
      "score": 0.28813135623931885
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 97
          },
          "endPosition": {
            "line": 313,
            "column": 1
          }
        },
        "contents": "function getTutorialCanvasData(settings: ZettelPluginSettings): CanvasData {\n\n\n\tconst nodes: CanvasData[\"nodes\"] = [\n\t\t// Groups first (render behind)\n\t\tgroupWelcome,\n\t\tgroupCol1,\n\t\tgroupCol2,\n\t\tgroupCol3,\n\t\tgroupCol4,\n\t\tgroupCol5,\n\t\tgroupCol6,\n\t\t// Welcome: plain text (no color = no role; not connected, does not add to prompt)\n\t\tn(welcome, \"Welcome to Zettel Thinking Board. Each column is a separate showcase. Nodes run top to bottom. Right-click a card → Run node or Run chain. Uncolored or unused-color cards are not connected to any node and do not add to the prompt.\", TUT_LEFT, welcomeY, \"\", TUT_WELCOME_W, 132),\n\n\t\t// Column 1: label = plain text; nodes in lane have roles\n\t\tn(lab1, \"Primary model: sends prompt to Ollama. Set the model in Zettel Controls.\", commentLeftX(col1), orangeY, \"\", TUT_COMMENT_W, TUT_LABEL_H),\n\t\tn(orangeNode, \"What is 2+2? Reply in one sentence.\", laneNodeX(col1, 0), orangeY, cOrange, TUT_NODE_LANE_W, TUT_NODE_H),\n\t\tn(orangeOut, \"\", laneNodeX(col1, LANE_OFFSET), orangeOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),\n\n\t\t// Column 2\n\t\tn(lab2a, \"Secondary model (same idea, different model).\", commentLeftX(col2), purpleY, \"\", TUT_COMMENT_W, TUT_LABEL_H),\n\t\tn(purpleNode, \"Summarize in 5 words: The quick brown fox jumps.\", laneNodeX(col2, 0), purpleY, cPurple, TUT_NODE_LANE_W, TUT_NODE_H),\n\t\tn(purpleOut, \"\", laneNodeX(col2, LANE_OFFSET), purpleOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),\n\t\tn(lab2b, \"Text: input text; passed to next node as-is (pass-through).\", commentRightX(col2), yellowY, \"\", TUT_COMMENT_W, TUT_LABEL_H),\n\t\tn(yellowNode, \"I'm input text. My text is passed to the next node (concatenated).\", laneNodeX(col2, 0), yellowY, cYellow, TUT_NODE_LANE_W, TUT_NODE_H),\n\t\tn(lab2c, \"Python: runs code. Use variable input for parent text.\", commentLeftX(col2), blueY, \"\", TUT_COMMENT_W, TUT_LABEL_H),\n\t\tn(blueNode, \"print('Python says:', (input or '')[:80] or '(no input)')\\n# input = text from parent\", laneNodeX(col2, LANE_OFFSET), blueY, cBlue, TUT_NODE_LANE_W, TUT_NODE_H),\n\t\tn(blueOut, \"\", laneNodeX(col2, 0), blueOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),\n\n\t\t// Column 3\n\t\tn\n,\n\t];\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 98,
                "column": 1
              },
              "endPosition": {
                "line": 99,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "function getTutorialCanvasData(settings: ZettelPluginSettings): CanvasData {",
            "lineNumber": 98,
            "isSignature": true
          },
          {
            "lineNumber": 257
          },
          {
            "lineNumber": 258
          },
          {
            "text": "\tconst nodes: CanvasData[\"nodes\"] = [",
            "lineNumber": 259
          },
          {
            "text": "\t\t// Groups first (render behind)",
            "lineNumber": 260
          },
          {
            "text": "\t\tgroupWelcome,",
            "lineNumber": 261
          },
          {
            "text": "\t\tgroupCol1,",
            "lineNumber": 262
          },
          {
            "text": "\t\tgroupCol2,",
            "lineNumber": 263
          },
          {
            "text": "\t\tgroupCol3,",
            "lineNumber": 264
          },
          {
            "text": "\t\tgroupCol4,",
            "lineNumber": 265
          },
          {
            "text": "\t\tgroupCol5,",
            "lineNumber": 266
          },
          {
            "text": "\t\tgroupCol6,",
            "lineNumber": 267
          },
          {
            "text": "\t\t// Welcome: plain text (no color = no role; not connected, does not add to prompt)",
            "lineNumber": 268
          },
          {
            "text": "\t\tn(welcome, \"Welcome to Zettel Thinking Board. Each column is a separate showcase. Nodes run top to bottom. Right-click a card → Run node or Run chain. Uncolored or unused-color cards are not connected to any node and do not add to the prompt.\", TUT_LEFT, welcomeY, \"\", TUT_WELCOME_W, 132),",
            "lineNumber": 269
          },
          {
            "lineNumber": 270
          },
          {
            "text": "\t\t// Column 1: label = plain text; nodes in lane have roles",
            "lineNumber": 271
          },
          {
            "text": "\t\tn(lab1, \"Primary model: sends prompt to Ollama. Set the model in Zettel Controls.\", commentLeftX(col1), orangeY, \"\", TUT_COMMENT_W, TUT_LABEL_H),",
            "lineNumber": 272
          },
          {
            "text": "\t\tn(orangeNode, \"What is 2+2? Reply in one sentence.\", laneNodeX(col1, 0), orangeY, cOrange, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 273
          },
          {
            "text": "\t\tn(orangeOut, \"\", laneNodeX(col1, LANE_OFFSET), orangeOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 274
          },
          {
            "lineNumber": 275
          },
          {
            "text": "\t\t// Column 2",
            "lineNumber": 276
          },
          {
            "text": "\t\tn(lab2a, \"Secondary model (same idea, different model).\", commentLeftX(col2), purpleY, \"\", TUT_COMMENT_W, TUT_LABEL_H),",
            "lineNumber": 277
          },
          {
            "text": "\t\tn(purpleNode, \"Summarize in 5 words: The quick brown fox jumps.\", laneNodeX(col2, 0), purpleY, cPurple, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 278
          },
          {
            "text": "\t\tn(purpleOut, \"\", laneNodeX(col2, LANE_OFFSET), purpleOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 279
          },
          {
            "text": "\t\tn(lab2b, \"Text: input text; passed to next node as-is (pass-through).\", commentRightX(col2), yellowY, \"\", TUT_COMMENT_W, TUT_LABEL_H),",
            "lineNumber": 280
          },
          {
            "text": "\t\tn(yellowNode, \"I'm input text. My text is passed to the next node (concatenated).\", laneNodeX(col2, 0), yellowY, cYellow, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 281
          },
          {
            "text": "\t\tn(lab2c, \"Python: runs code. Use variable input for parent text.\", commentLeftX(col2), blueY, \"\", TUT_COMMENT_W, TUT_LABEL_H),",
            "lineNumber": 282
          },
          {
            "text": "\t\tn(blueNode, \"print('Python says:', (input or '')[:80] or '(no input)')\\n# input = text from parent\", laneNodeX(col2, LANE_OFFSET), blueY, cBlue, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 283
          },
          {
            "text": "\t\tn(blueOut, \"\", laneNodeX(col2, 0), blueOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 284
          },
          {
            "lineNumber": 285
          },
          {
            "text": "\t\t// Column 3",
            "lineNumber": 286
          },
          {
            "text": "\t\tn",
            "lineNumber": 287
          },
          {
            "text": ",",
            "lineNumber": 300
          },
          {
            "text": "\t];",
            "lineNumber": 301
          },
          {
            "text": "}",
            "lineNumber": 314,
            "isSignature": true
          }
        ]
      },
      "score": 0.267657995223999
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 97
          },
          "endPosition": {
            "line": 313,
            "column": 1
          }
        },
        "contents": "function getTutorialCanvasData(settings: ZettelPluginSettings): CanvasData {\n\n\tconst col1 = 1;\n\tconst lab1 = \"lab-primary\";\n\tconst orangeNode = \"orange-example\";\n\tconst orangeOut = \"orange-out\";\n\tlet y1 = TUT_TOP + TUT_WELCOME_H + TUT_WELCOME_BOTTOM_GAP;\n\tconst orangeY = y1;\n\ty1 += TUT_NODE_H + TUT_NODE_GAP;\n\tconst orangeOutY = y1;\n\n\t// —— Column 2: Purple, Yellow, Blue (comments in margins, nodes in lane) ——\n\tconst col2 = 2;\n\tconst lab2a = \"lab-purple\";\n\tconst purpleNode = \"purple-example\";\n\tconst purpleOut = \"purple-out\";\n\tconst lab2b = \"lab-yellow\";\n\tconst yellowNode = \"yellow-example\";\n\tconst lab2c = \"lab-blue\";\n\tconst blueNode = \"blue-example\";\n\tconst blueOut = \"blue-out\";\n\tlet y2 = TUT_TOP + TUT_WELCOME_H + TUT_WELCOME_BOTTOM_GAP;\n\tconst purpleY = y2;\n\ty2 += TUT_NODE_H + TUT_NODE_GAP;\n\tconst purpleOutY = y2;\n\ty2 += TUT_NODE_H + TUT_NODE_GAP + 20;\n\tconst yellowY = y2;\n\ty2 += TUT_NODE_H + TUT_NODE_GAP + 20;\n\tconst blueY = y2;\n\ty2 += TUT_NODE_H + TUT_NODE_GAP;\n\tconst blueOutY = y2;\n\n\t// —— Column 3: Concatenation ——\n\tconst col3 = 3;\n\tconst lab3 = \"lab-concat\";\n\tconst concatComment = \"concat-comment\";\n\tconst concatOrange = \"concat-orange\";\n\tconst concatOut = \"concat-out\";\n\tlet y3 = TUT_TOP + TUT_WELCOME_H + TUT_WELCOME_BOTTOM_GAP;\n\tconst concatCommentY = y3;\n\ty3 += TUT_NODE_H + TUT_NODE_GAP;\n\tconst concatOrangeY = y3;\n\ty3 += TUT_NODE_H + TUT_NODE_GAP;\n\tconst concatOutY = y3;\n\n\t// —— Column 4: Variable injection ——\n\tconst col4 = 4;\n\tconst lab4 = \"lab-inject\";\n\tconst injectFirst = \"inject-first\";\n\tconst injectSecond = \"inject-second\";\n\tconst injectOut = \"inject-out\";\n\tlet y4 = TUT_TOP + TUT_WELCOME_H + TUT_WELCOME_BOTTOM_GAP;\n\tconst injectFirstY = y4;\n\ty4 += TUT_NODE_H + TUT_NODE_GAP;\n\tconst injectSecondY = y4;\n\ty4 += TUT_NODE_H + TUT_NODE_GAP;\n\tconst injectOutY = y4;\n\n\t// —— Column 5 &amp; 6: Comments only (left margin + optional right), no nodes in lane ——\n\tconst col5 = 5;\n\tconst col6 = 6;\n\tconst lab5 = \"lab-commands\";\n\tconst lab6 = \"lab-sidebar\";\n\tconst y5 = TUT_TOP + TUT_WELCOME_H + TUT_WELCOME_BOTTOM_GAP;\n\tconst y6 = TUT_TOP + TUT_WELCOME_H + TUT_WELCOME_BOTTOM_GAP;\n\n\t// Group bounds (x, y, w, h) for each workflow block\n\tconst TUT_WELCOME_CARD_H = 132;\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 98,
                "column": 1
              },
              "endPosition": {
                "line": 99,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "function getTutorialCanvasData(settings: ZettelPluginSettings): CanvasData {",
            "lineNumber": 98,
            "isSignature": true
          },
          {
            "lineNumber": 135
          },
          {
            "text": "\tconst col1 = 1;",
            "lineNumber": 136
          },
          {
            "text": "\tconst lab1 = \"lab-primary\";",
            "lineNumber": 137
          },
          {
            "text": "\tconst orangeNode = \"orange-example\";",
            "lineNumber": 138
          },
          {
            "text": "\tconst orangeOut = \"orange-out\";",
            "lineNumber": 139
          },
          {
            "text": "\tlet y1 = TUT_TOP + TUT_WELCOME_H + TUT_WELCOME_BOTTOM_GAP;",
            "lineNumber": 140
          },
          {
            "text": "\tconst orangeY = y1;",
            "lineNumber": 141
          },
          {
            "text": "\ty1 += TUT_NODE_H + TUT_NODE_GAP;",
            "lineNumber": 142
          },
          {
            "text": "\tconst orangeOutY = y1;",
            "lineNumber": 143
          },
          {
            "lineNumber": 144
          },
          {
            "text": "\t// —— Column 2: Purple, Yellow, Blue (comments in margins, nodes in lane) ——",
            "lineNumber": 145
          },
          {
            "text": "\tconst col2 = 2;",
            "lineNumber": 146
          },
          {
            "text": "\tconst lab2a = \"lab-purple\";",
            "lineNumber": 147
          },
          {
            "text": "\tconst purpleNode = \"purple-example\";",
            "lineNumber": 148
          },
          {
            "text": "\tconst purpleOut = \"purple-out\";",
            "lineNumber": 149
          },
          {
            "text": "\tconst lab2b = \"lab-yellow\";",
            "lineNumber": 150
          },
          {
            "text": "\tconst yellowNode = \"yellow-example\";",
            "lineNumber": 151
          },
          {
            "text": "\tconst lab2c = \"lab-blue\";",
            "lineNumber": 152
          },
          {
            "text": "\tconst blueNode = \"blue-example\";",
            "lineNumber": 153
          },
          {
            "text": "\tconst blueOut = \"blue-out\";",
            "lineNumber": 154
          },
          {
            "text": "\tlet y2 = TUT_TOP + TUT_WELCOME_H + TUT_WELCOME_BOTTOM_GAP;",
            "lineNumber": 155
          },
          {
            "text": "\tconst purpleY = y2;",
            "lineNumber": 156
          },
          {
            "text": "\ty2 += TUT_NODE_H + TUT_NODE_GAP;",
            "lineNumber": 157
          },
          {
            "text": "\tconst purpleOutY = y2;",
            "lineNumber": 158
          },
          {
            "text": "\ty2 += TUT_NODE_H + TUT_NODE_GAP + 20;",
            "lineNumber": 159
          },
          {
            "text": "\tconst yellowY = y2;",
            "lineNumber": 160
          },
          {
            "text": "\ty2 += TUT_NODE_H + TUT_NODE_GAP + 20;",
            "lineNumber": 161
          },
          {
            "text": "\tconst blueY = y2;",
            "lineNumber": 162
          },
          {
            "text": "\ty2 += TUT_NODE_H + TUT_NODE_GAP;",
            "lineNumber": 163
          },
          {
            "text": "\tconst blueOutY = y2;",
            "lineNumber": 164
          },
          {
            "lineNumber": 165
          },
          {
            "text": "\t// —— Column 3: Concatenation ——",
            "lineNumber": 166
          },
          {
            "text": "\tconst col3 = 3;",
            "lineNumber": 167
          },
          {
            "text": "\tconst lab3 = \"lab-concat\";",
            "lineNumber": 168
          },
          {
            "text": "\tconst concatComment = \"concat-comment\";",
            "lineNumber": 169
          },
          {
            "text": "\tconst concatOrange = \"concat-orange\";",
            "lineNumber": 170
          },
          {
            "text": "\tconst concatOut = \"concat-out\";",
            "lineNumber": 171
          },
          {
            "text": "\tlet y3 = TUT_TOP + TUT_WELCOME_H + TUT_WELCOME_BOTTOM_GAP;",
            "lineNumber": 172
          },
          {
            "text": "\tconst concatCommentY = y3;",
            "lineNumber": 173
          },
          {
            "text": "\ty3 += TUT_NODE_H + TUT_NODE_GAP;",
            "lineNumber": 174
          },
          {
            "text": "\tconst concatOrangeY = y3;",
            "lineNumber": 175
          },
          {
            "text": "\ty3 += TUT_NODE_H + TUT_NODE_GAP;",
            "lineNumber": 176
          },
          {
            "text": "\tconst concatOutY = y3;",
            "lineNumber": 177
          },
          {
            "lineNumber": 178
          },
          {
            "text": "\t// —— Column 4: Variable injection ——",
            "lineNumber": 179
          },
          {
            "text": "\tconst col4 = 4;",
            "lineNumber": 180
          },
          {
            "text": "\tconst lab4 = \"lab-inject\";",
            "lineNumber": 181
          },
          {
            "text": "\tconst injectFirst = \"inject-first\";",
            "lineNumber": 182
          },
          {
            "text": "\tconst injectSecond = \"inject-second\";",
            "lineNumber": 183
          },
          {
            "text": "\tconst injectOut = \"inject-out\";",
            "lineNumber": 184
          },
          {
            "text": "\tlet y4 = TUT_TOP + TUT_WELCOME_H + TUT_WELCOME_BOTTOM_GAP;",
            "lineNumber": 185
          },
          {
            "text": "\tconst injectFirstY = y4;",
            "lineNumber": 186
          },
          {
            "text": "\ty4 += TUT_NODE_H + TUT_NODE_GAP;",
            "lineNumber": 187
          },
          {
            "text": "\tconst injectSecondY = y4;",
            "lineNumber": 188
          },
          {
            "text": "\ty4 += TUT_NODE_H + TUT_NODE_GAP;",
            "lineNumber": 189
          },
          {
            "text": "\tconst injectOutY = y4;",
            "lineNumber": 190
          },
          {
            "lineNumber": 191
          },
          {
            "text": "\t// —— Column 5 &amp; 6: Comments only (left margin + optional right), no nodes in lane ——",
            "lineNumber": 192
          },
          {
            "text": "\tconst col5 = 5;",
            "lineNumber": 193
          },
          {
            "text": "\tconst col6 = 6;",
            "lineNumber": 194
          },
          {
            "text": "\tconst lab5 = \"lab-commands\";",
            "lineNumber": 195
          },
          {
            "text": "\tconst lab6 = \"lab-sidebar\";",
            "lineNumber": 196
          },
          {
            "text": "\tconst y5 = TUT_TOP + TUT_WELCOME_H + TUT_WELCOME_BOTTOM_GAP;",
            "lineNumber": 197
          },
          {
            "text": "\tconst y6 = TUT_TOP + TUT_WELCOME_H + TUT_WELCOME_BOTTOM_GAP;",
            "lineNumber": 198
          },
          {
            "lineNumber": 199
          },
          {
            "text": "\t// Group bounds (x, y, w, h) for each workflow block",
            "lineNumber": 200
          },
          {
            "text": "\tconst TUT_WELCOME_CARD_H = 132;",
            "lineNumber": 201
          },
          {
            "text": "}",
            "lineNumber": 314,
            "isSignature": true
          }
        ]
      },
      "score": 0.2586897611618042
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/types.ts",
        "range": {
          "startPosition": {
            "line": 75,
            "column": 1
          },
          "endPosition": {
            "line": 95,
            "column": 1
          }
        },
        "contents": "/** Get parent node IDs for a node, sorted by y (top to bottom). Excludes output edges. */\nexport function getParentIdsSortedByY(nodeId: string, data: CanvasData): string[] {\n\tconst edges = data.edges.filter((e) =&gt; e.toNode === nodeId &amp;&amp; !isOutputEdge(e));\n\tconst fromIds = [...new Set(edges.map((e) =&gt; e.fromNode))];\n\tconst nodeMap = new Map(data.nodes.map((n) =&gt; [n.id, n]));\n\tconst withY = fromIds\n\t\t.map((id) =&gt; {\n\t\t\tconst node = nodeMap.get(id);\n\t\t\treturn node ? { id, y: node.y } : null;\n\t\t})\n\t\t.filter((x): x is { id: string; y: number } =&gt; x != null);\n\twithY.sort((a, b) =&gt; a.y - b.y);\n\treturn withY.map((x) =&gt; x.id);\n}\n\n/** Get node by id from canvas data. */\nexport function getNodeById(data: CanvasData, id: string): AllCanvasNodeData | undefined {\n\t\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Get parent node IDs for a node, sorted by y (top to bottom). Excludes output edges. */",
            "lineNumber": 78
          },
          {
            "text": "export function getParentIdsSortedByY(nodeId: string, data: CanvasData): string[] {",
            "lineNumber": 79,
            "isSignature": true
          },
          {
            "text": "\tconst edges = data.edges.filter((e) =&gt; e.toNode === nodeId &amp;&amp; !isOutputEdge(e));",
            "lineNumber": 80
          },
          {
            "text": "\tconst fromIds = [...new Set(edges.map((e) =&gt; e.fromNode))];",
            "lineNumber": 81
          },
          {
            "text": "\tconst nodeMap = new Map(data.nodes.map((n) =&gt; [n.id, n]));",
            "lineNumber": 82
          },
          {
            "text": "\tconst withY = fromIds",
            "lineNumber": 83
          },
          {
            "text": "\t\t.map((id) =&gt; {",
            "lineNumber": 84
          },
          {
            "text": "\t\t\tconst node = nodeMap.get(id);",
            "lineNumber": 85
          },
          {
            "text": "\t\t\treturn node ? { id, y: node.y } : null;",
            "lineNumber": 86
          },
          {
            "text": "\t\t})",
            "lineNumber": 87
          },
          {
            "text": "\t\t.filter((x): x is { id: string; y: number } =&gt; x != null);",
            "lineNumber": 88
          },
          {
            "text": "\twithY.sort((a, b) =&gt; a.y - b.y);",
            "lineNumber": 89
          },
          {
            "text": "\treturn withY.map((x) =&gt; x.id);",
            "lineNumber": 90
          },
          {
            "text": "}",
            "lineNumber": 91,
            "isSignature": true
          },
          {
            "lineNumber": 92
          },
          {
            "text": "/** Get node by id from canvas data. */",
            "lineNumber": 93
          },
          {
            "text": "export function getNodeById(data: CanvasData, id: string): AllCanvasNodeData | undefined {",
            "lineNumber": 94,
            "isSignature": true
          },
          {
            "text": "\t",
            "lineNumber": 95
          },
          {
            "text": "}",
            "lineNumber": 96,
            "isSignature": true
          }
        ]
      },
      "score": 0.2576040029525757
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 329
          },
          "endPosition": {
            "line": 877,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\nasync onload() {\n\n(checking: boolean) =&gt; {\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"run-chain\",\n\t\t\t\tname: \"Run chain\",\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\t\tif (!view) return false;\n\t\t\t\t\tif (checking) return true;\n\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Run chain\\\" to run from roots.\");\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"dismiss-output\",\n\t\t\t\tname: \"Dismiss output\",\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\t\tif (!view) return false;\n\t\t\t\t\tif (checking) return true;\n\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Dismiss output\\\" to remove its output.\");\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\t// Canvas node context menu (event name is undocumented; try workspace.on(\"canvas:node-menu\")).\n\t\t\t// Defer registration so Obsidian canvas is ready (avoids \"reading '_'\" in app.js).\n\t\t\tconst addNodeMenuItems = (menu: Menu, node: unknown): void =&gt; {\n\t\t\t\tdebugNodeMenuFired = true;\n\t\t\t\tconst nodeId = resolveCanvasNodeId(node);\n\t\t\t\tif (!nodeId) return;\n\t\t\t\tmenu.addItem((item) =&gt;\n\t\t\t\t\titem.setTitle(\"Run node\").setIcon(\"play\").onClick(() =&gt; this.runNode(nodeId))\n\t\t\t\t);\n\t\t\t\tmenu.addItem((item) =&gt;\n\t\t\t\t\titem.setTitle(\"Run chain\").setIcon(\"forward\").onClick(() =&gt; this.runChain(nodeId))\n\t\t\t\t);\n\t\t\t\tmenu.addItem((item) =&gt;\n\t\t\t\t\titem.setTitle(\"Dismiss output\").setIcon(\"trash\").onClick(() =&gt; this.dismissOutput(nodeId))\n\t\t\t\t);\n\t\t\t};\n\t\t\tconst registerCanvasNodeMenu = () =&gt; {\n\t\t\t\ttry {\n\t\t\t\t\tconst on = this.app.workspace.on.bind(this.app.workspace) as\n;\n;\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 330,
                "column": 1
              },
              "endPosition": {
                "line": 330,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 330,
                "column": 16
              },
              "endPosition": {
                "line": 331,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 333,
                "column": 2
              },
              "endPosition": {
                "line": 334,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 330,
            "isSignature": true
          },
          {
            "text": "async onload() {",
            "lineNumber": 333
          },
          {
            "lineNumber": 379
          },
          {
            "text": "(checking: boolean) =&gt; {",
            "lineNumber": 382
          },
          {
            "lineNumber": 387
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 388
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 389
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 390
          },
          {
            "lineNumber": 391
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 392
          },
          {
            "text": "\t\t\t\tid: \"run-chain\",",
            "lineNumber": 393
          },
          {
            "text": "\t\t\t\tname: \"Run chain\",",
            "lineNumber": 394
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 395
          },
          {
            "text": "\t\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 396
          },
          {
            "text": "\t\t\t\t\tif (!view) return false;",
            "lineNumber": 397
          },
          {
            "text": "\t\t\t\t\tif (checking) return true;",
            "lineNumber": 398
          },
          {
            "text": "\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Run chain\\\" to run from roots.\");",
            "lineNumber": 399
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 400
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 401
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 402
          },
          {
            "lineNumber": 403
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 404
          },
          {
            "text": "\t\t\t\tid: \"dismiss-output\",",
            "lineNumber": 405
          },
          {
            "text": "\t\t\t\tname: \"Dismiss output\",",
            "lineNumber": 406
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 407
          },
          {
            "text": "\t\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 408
          },
          {
            "text": "\t\t\t\t\tif (!view) return false;",
            "lineNumber": 409
          },
          {
            "text": "\t\t\t\t\tif (checking) return true;",
            "lineNumber": 410
          },
          {
            "text": "\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Dismiss output\\\" to remove its output.\");",
            "lineNumber": 411
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 412
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 413
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 414
          },
          {
            "lineNumber": 415
          },
          {
            "text": "\t\t\t// Canvas node context menu (event name is undocumented; try workspace.on(\"canvas:node-menu\")).",
            "lineNumber": 416
          },
          {
            "text": "\t\t\t// Defer registration so Obsidian canvas is ready (avoids \"reading '_'\" in app.js).",
            "lineNumber": 417
          },
          {
            "text": "\t\t\tconst addNodeMenuItems = (menu: Menu, node: unknown): void =&gt; {",
            "lineNumber": 418
          },
          {
            "text": "\t\t\t\tdebugNodeMenuFired = true;",
            "lineNumber": 419
          },
          {
            "text": "\t\t\t\tconst nodeId = resolveCanvasNodeId(node);",
            "lineNumber": 420
          },
          {
            "text": "\t\t\t\tif (!nodeId) return;",
            "lineNumber": 421
          },
          {
            "text": "\t\t\t\tmenu.addItem((item) =&gt;",
            "lineNumber": 422
          },
          {
            "text": "\t\t\t\t\titem.setTitle(\"Run node\").setIcon(\"play\").onClick(() =&gt; this.runNode(nodeId))",
            "lineNumber": 423
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 424
          },
          {
            "text": "\t\t\t\tmenu.addItem((item) =&gt;",
            "lineNumber": 425
          },
          {
            "text": "\t\t\t\t\titem.setTitle(\"Run chain\").setIcon(\"forward\").onClick(() =&gt; this.runChain(nodeId))",
            "lineNumber": 426
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 427
          },
          {
            "text": "\t\t\t\tmenu.addItem((item) =&gt;",
            "lineNumber": 428
          },
          {
            "text": "\t\t\t\t\titem.setTitle(\"Dismiss output\").setIcon(\"trash\").onClick(() =&gt; this.dismissOutput(nodeId))",
            "lineNumber": 429
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 430
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 431
          },
          {
            "text": "\t\t\tconst registerCanvasNodeMenu = () =&gt; {",
            "lineNumber": 432
          },
          {
            "text": "\t\t\t\ttry {",
            "lineNumber": 433
          },
          {
            "text": "\t\t\t\t\tconst on = this.app.workspace.on.bind(this.app.workspace) as",
            "lineNumber": 434
          },
          {
            "text": ";",
            "lineNumber": 437
          },
          {
            "text": ";",
            "lineNumber": 445
          },
          {
            "text": "\t}",
            "lineNumber": 595
          },
          {
            "text": "}",
            "lineNumber": 878,
            "isSignature": true
          }
        ]
      },
      "score": 0.2557013928890228
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/types.ts",
        "range": {
          "startPosition": {
            "line": 118,
            "column": 37
          },
          "endPosition": {
            "line": 123,
            "column": 113
          }
        },
        "contents": "/** Max vertical offset (px) below default placement when finding output by position; must match runner collision range. */\nexport const OUTPUT_POSITION_FALLBACK_MAX_Y = 450;\n\n/** Find the Green (output) node for a given source node. Edge-first (label \"output\"), then position fallback. */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Max vertical offset (px) below default placement when finding output by position; must match runner collision range. */",
            "lineNumber": 121
          },
          {
            "text": "export const OUTPUT_POSITION_FALLBACK_MAX_Y = 450;",
            "lineNumber": 122
          },
          {
            "lineNumber": 123
          },
          {
            "text": "/** Find the Green (output) node for a given source node. Edge-first (label \"output\"), then position fallback. */",
            "lineNumber": 124
          }
        ]
      },
      "score": 0.25289198756217957
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/types.test.ts",
        "range": {
          "startPosition": {
            "line": 188,
            "column": 3
          },
          "endPosition": {
            "line": 234,
            "column": 1
          }
        },
        "contents": "describe(\"findOutputNodeForSource\", () =&gt; {\n\tconst settings = { ...DEFAULT_SETTINGS, colorGreen: \"5\" };\n\n\tit(\"returns null when source node not found\", () =&gt; {\n\t\tconst data: CanvasData = { nodes: [], edges: [] };\n\t\texpect(findOutputNodeForSource(data, \"missing\", settings)).toBeNull();\n\t});\n\tit(\"returns green node id when it sits below source within tolerance\", () =&gt; {\n\t\tconst sourceY = 100;\n\t\tconst greenY = sourceY + 50 + GREEN_NODE_PADDING; // 170\n\t\tconst data: CanvasData = {\n\t\t\tnodes: [\n\t\t\t\t{ id: \"src\", x: 10, y: sourceY, width: 200, height: 50, type: \"text\", text: \"\", color: \"1\" },\n\t\t\t\t{ id: \"out\", x: 10, y: greenY, width: 200, height: 100, type: \"text\", text: \"\", color: \"5\" },\n\t\t\t],\n\t\t\tedges: [],\n\t\t};\n\t\texpect(findOutputNodeForSource(data, \"src\", settings)).toBe(\"out\");\n\t});\n\tit(\"returns null when no green node in expected position\", () =&gt; {\n\t\tconst data: CanvasData = {\n\t\t\tnodes: [{ id: \"src\", x: 0, y: 0, width: 100, height: 50, type: \"text\", text: \"\", color: \"1\" }],\n\t\t\tedges: [],\n\t\t};\n\t\texpect(findOutputNodeForSource(data, \"src\", settings)).toBeNull();\n\t});\n\tit(\"returns toNode when edge from source has label output\", () =&gt; {\n\t\tconst data: CanvasData = {\n\t\t\tnodes: [\n\t\t\t\t{ id: \"src\", x: 0, y: 0, width: 100, height: 50, type: \"text\", text: \"\", color: \"1\" },\n\t\t\t\t{ id: \"out\", x: 0, y: 200, width: 100, height: 50, type: \"text\", text: \"\", color: \"5\" },\n\t\t\t],\n\t\t\tedges: [\n\t\t\t\t{ id: \"e1\", fromNode: \"src\", toNode: \"out\", label: EDGE_LABEL_OUTPUT },\n\t\t\t],\n\t\t};\n\t\texpect(findOutputNodeForSource(data, \"src\", settings)).toBe(\"out\");\n\t});\n});\n\ndescribe(\"GREEN_NODE_PADDING\", () =&gt; {\n\tit\n\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "describe(\"findOutputNodeForSource\", () =&gt; {",
            "lineNumber": 191
          },
          {
            "text": "\tconst settings = { ...DEFAULT_SETTINGS, colorGreen: \"5\" };",
            "lineNumber": 192
          },
          {
            "lineNumber": 193
          },
          {
            "text": "\tit(\"returns null when source node not found\", () =&gt; {",
            "lineNumber": 194
          },
          {
            "text": "\t\tconst data: CanvasData = { nodes: [], edges: [] };",
            "lineNumber": 195
          },
          {
            "text": "\t\texpect(findOutputNodeForSource(data, \"missing\", settings)).toBeNull();",
            "lineNumber": 196
          },
          {
            "text": "\t});",
            "lineNumber": 197
          },
          {
            "text": "\tit(\"returns green node id when it sits below source within tolerance\", () =&gt; {",
            "lineNumber": 198
          },
          {
            "text": "\t\tconst sourceY = 100;",
            "lineNumber": 199
          },
          {
            "text": "\t\tconst greenY = sourceY + 50 + GREEN_NODE_PADDING; // 170",
            "lineNumber": 200
          },
          {
            "text": "\t\tconst data: CanvasData = {",
            "lineNumber": 201
          },
          {
            "text": "\t\t\tnodes: [",
            "lineNumber": 202
          },
          {
            "text": "\t\t\t\t{ id: \"src\", x: 10, y: sourceY, width: 200, height: 50, type: \"text\", text: \"\", color: \"1\" },",
            "lineNumber": 203
          },
          {
            "text": "\t\t\t\t{ id: \"out\", x: 10, y: greenY, width: 200, height: 100, type: \"text\", text: \"\", color: \"5\" },",
            "lineNumber": 204
          },
          {
            "text": "\t\t\t],",
            "lineNumber": 205
          },
          {
            "text": "\t\t\tedges: [],",
            "lineNumber": 206
          },
          {
            "text": "\t\t};",
            "lineNumber": 207
          },
          {
            "text": "\t\texpect(findOutputNodeForSource(data, \"src\", settings)).toBe(\"out\");",
            "lineNumber": 208
          },
          {
            "text": "\t});",
            "lineNumber": 209
          },
          {
            "text": "\tit(\"returns null when no green node in expected position\", () =&gt; {",
            "lineNumber": 210
          },
          {
            "text": "\t\tconst data: CanvasData = {",
            "lineNumber": 211
          },
          {
            "text": "\t\t\tnodes: [{ id: \"src\", x: 0, y: 0, width: 100, height: 50, type: \"text\", text: \"\", color: \"1\" }],",
            "lineNumber": 212
          },
          {
            "text": "\t\t\tedges: [],",
            "lineNumber": 213
          },
          {
            "text": "\t\t};",
            "lineNumber": 214
          },
          {
            "text": "\t\texpect(findOutputNodeForSource(data, \"src\", settings)).toBeNull();",
            "lineNumber": 215
          },
          {
            "text": "\t});",
            "lineNumber": 216
          },
          {
            "text": "\tit(\"returns toNode when edge from source has label output\", () =&gt; {",
            "lineNumber": 217
          },
          {
            "text": "\t\tconst data: CanvasData = {",
            "lineNumber": 218
          },
          {
            "text": "\t\t\tnodes: [",
            "lineNumber": 219
          },
          {
            "text": "\t\t\t\t{ id: \"src\", x: 0, y: 0, width: 100, height: 50, type: \"text\", text: \"\", color: \"1\" },",
            "lineNumber": 220
          },
          {
            "text": "\t\t\t\t{ id: \"out\", x: 0, y: 200, width: 100, height: 50, type: \"text\", text: \"\", color: \"5\" },",
            "lineNumber": 221
          },
          {
            "text": "\t\t\t],",
            "lineNumber": 222
          },
          {
            "text": "\t\t\tedges: [",
            "lineNumber": 223
          },
          {
            "text": "\t\t\t\t{ id: \"e1\", fromNode: \"src\", toNode: \"out\", label: EDGE_LABEL_OUTPUT },",
            "lineNumber": 224
          },
          {
            "text": "\t\t\t],",
            "lineNumber": 225
          },
          {
            "text": "\t\t};",
            "lineNumber": 226
          },
          {
            "text": "\t\texpect(findOutputNodeForSource(data, \"src\", settings)).toBe(\"out\");",
            "lineNumber": 227
          },
          {
            "text": "\t});",
            "lineNumber": 228
          },
          {
            "text": "});",
            "lineNumber": 229
          },
          {
            "lineNumber": 230
          },
          {
            "text": "describe(\"GREEN_NODE_PADDING\", () =&gt; {",
            "lineNumber": 231
          },
          {
            "text": "\tit",
            "lineNumber": 232
          },
          {
            "lineNumber": 234
          },
          {
            "text": "}",
            "lineNumber": 235
          }
        ]
      },
      "score": 0.24727004766464233
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/nodes.ts",
        "range": {
          "startPosition": {
            "line": 56,
            "column": 1
          },
          "endPosition": {
            "line": 73,
            "column": 77
          }
        },
        "contents": "// Re-export for callers\nexport {\n\tEDGE_LABEL_OUTPUT,\n\tfindOutputNodeForSource,\n\tgetNodeById,\n\tgetNodeRole,\n\tgetParentIdsSortedByY,\n\tgetIncomingEdgesWithLabels,\n\tGREEN_NODE_PADDING,\n\thasOutputNodes,\n\tisFileNode,\n\tisOutputEdge,\n\tisTextNode,\n\tparseEdgeVariableName,\n} from \"./types\";\nexport type {CanvasData, AllCanvasNodeData, IncomingEdgeInfo} from \"./types\";",
        "signatures": {},
        "detailedLines": [
          {
            "text": "// Re-export for callers",
            "lineNumber": 59
          },
          {
            "text": "export {",
            "lineNumber": 60
          },
          {
            "text": "\tEDGE_LABEL_OUTPUT,",
            "lineNumber": 61
          },
          {
            "text": "\tfindOutputNodeForSource,",
            "lineNumber": 62
          },
          {
            "text": "\tgetNodeById,",
            "lineNumber": 63
          },
          {
            "text": "\tgetNodeRole,",
            "lineNumber": 64
          },
          {
            "text": "\tgetParentIdsSortedByY,",
            "lineNumber": 65
          },
          {
            "text": "\tgetIncomingEdgesWithLabels,",
            "lineNumber": 66
          },
          {
            "text": "\tGREEN_NODE_PADDING,",
            "lineNumber": 67
          },
          {
            "text": "\thasOutputNodes,",
            "lineNumber": 68
          },
          {
            "text": "\tisFileNode,",
            "lineNumber": 69
          },
          {
            "text": "\tisOutputEdge,",
            "lineNumber": 70
          },
          {
            "text": "\tisTextNode,",
            "lineNumber": 71
          },
          {
            "text": "\tparseEdgeVariableName,",
            "lineNumber": 72
          },
          {
            "text": "} from \"./types\";",
            "lineNumber": 73
          },
          {
            "text": "export type {CanvasData, AllCanvasNodeData, IncomingEdgeInfo} from \"./types\";",
            "lineNumber": 74
          }
        ]
      },
      "score": 0.2406758964061737
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 97
          },
          "endPosition": {
            "line": 313,
            "column": 1
          }
        },
        "contents": "function getTutorialCanvasData(settings: ZettelPluginSettings): CanvasData {\nconst nodes: CanvasData[\"nodes\"] = [\n TUT_NODE_LANE_W, TUT_NODE_H),\n\t\tn(blueOut, \"\", laneNodeX(col2, 0), blueOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),\n\n\t\t// Column 3\n\t\tn(lab3, \"Concatenation: no edge label → parent output appended before your prompt (then \\\"---\\\", then this card).\", commentLeftX(col3), concatCommentY, \"\", TUT_COMMENT_W, TUT_LABEL_H + 12),\n\t\tn(concatComment, \"I'm input text. My full text is added to the next node's prompt.\", laneNodeX(col3, 0), concatCommentY, cYellow, TUT_NODE_LANE_W, TUT_NODE_H),\n\t\tn(concatOrange, \"Reply in one word: what did the previous card say?\", laneNodeX(col3, LANE_OFFSET), concatOrangeY, cOrange, TUT_NODE_LANE_W, TUT_NODE_H),\n\t\tn(concatOut, \"\", laneNodeX(col3, 0), concatOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),\n\n\t\t// Column 4\n\t\tn(lab4, \"Variable injection: put a name on the edge and use {{var:name}} in the prompt; that parent is injected there.\", commentLeftX(col4), injectFirstY, \"\", TUT_COMMENT_W, TUT_LABEL_H + 12),\n\t\tn(injectFirst, \"Say exactly: Hello world.\", laneNodeX(col4, 0), injectFirstY, cOrange, TUT_NODE_LANE_W, TUT_NODE_H),\n\t\tn(injectSecond, \"They said: {{var:reply}}. Confirm in 2 words.\", laneNodeX(col4, LANE_OFFSET), injectSecondY, cOrange, TUT_NODE_LANE_W, TUT_NODE_H),\n\t\tn(injectOut, \"\", laneNodeX(col4, 0), injectOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),\n\n\t\t// Column 5 &amp; 6: plain text labels only\n\t\tn(lab5, \"How to run: Right-click a node → Run node or Run chain. Right-click empty canvas → Run entire canvas or Dismiss all output. Title bar: ▶ Run entire canvas, 🗑 Dismiss all. Commands: Open Zettel Controls; Create tutorial canvas.\", commentLeftX(col5), y5, \"\", TUT_COMMENT_W + TUT_LANE_GAP + TUT_NODE_LANE_W, 195),\n\t\tn(lab6, \"Sidebar: Open Zettel Controls. There: pick Ollama models and Temperature; restart Python kernel; env vars; Console (obsidian_log in Python cards).\", commentLeftX(col6), y6, \"\", TUT_COMMENT_W + TUT_LANE_GAP + TUT_NODE_LANE_W, 145),\n\t];\n\n\tconst edges: CanvasData[\"edges\"] = [\n\t\te(\"e-orange-out\", orangeNode, orangeOut, EDGE_LABEL_OUTPUT)\n,\n\t];\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 98,
                "column": 1
              },
              "endPosition": {
                "line": 99,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 259,
                "column": 2
              },
              "endPosition": {
                "line": 259,
                "column": 8
              }
            },
            {
              "startPosition": {
                "line": 259,
                "column": 8
              },
              "endPosition": {
                "line": 260,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "function getTutorialCanvasData(settings: ZettelPluginSettings): CanvasData {",
            "lineNumber": 98,
            "isSignature": true
          },
          {
            "text": "const nodes: CanvasData[\"nodes\"] = [",
            "lineNumber": 259
          },
          {
            "text": " TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 283
          },
          {
            "text": "\t\tn(blueOut, \"\", laneNodeX(col2, 0), blueOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 284
          },
          {
            "lineNumber": 285
          },
          {
            "text": "\t\t// Column 3",
            "lineNumber": 286
          },
          {
            "text": "\t\tn(lab3, \"Concatenation: no edge label → parent output appended before your prompt (then \\\"---\\\", then this card).\", commentLeftX(col3), concatCommentY, \"\", TUT_COMMENT_W, TUT_LABEL_H + 12),",
            "lineNumber": 287
          },
          {
            "text": "\t\tn(concatComment, \"I'm input text. My full text is added to the next node's prompt.\", laneNodeX(col3, 0), concatCommentY, cYellow, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 288
          },
          {
            "text": "\t\tn(concatOrange, \"Reply in one word: what did the previous card say?\", laneNodeX(col3, LANE_OFFSET), concatOrangeY, cOrange, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 289
          },
          {
            "text": "\t\tn(concatOut, \"\", laneNodeX(col3, 0), concatOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 290
          },
          {
            "lineNumber": 291
          },
          {
            "text": "\t\t// Column 4",
            "lineNumber": 292
          },
          {
            "text": "\t\tn(lab4, \"Variable injection: put a name on the edge and use {{var:name}} in the prompt; that parent is injected there.\", commentLeftX(col4), injectFirstY, \"\", TUT_COMMENT_W, TUT_LABEL_H + 12),",
            "lineNumber": 293
          },
          {
            "text": "\t\tn(injectFirst, \"Say exactly: Hello world.\", laneNodeX(col4, 0), injectFirstY, cOrange, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 294
          },
          {
            "text": "\t\tn(injectSecond, \"They said: {{var:reply}}. Confirm in 2 words.\", laneNodeX(col4, LANE_OFFSET), injectSecondY, cOrange, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 295
          },
          {
            "text": "\t\tn(injectOut, \"\", laneNodeX(col4, 0), injectOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 296
          },
          {
            "lineNumber": 297
          },
          {
            "text": "\t\t// Column 5 &amp; 6: plain text labels only",
            "lineNumber": 298
          },
          {
            "text": "\t\tn(lab5, \"How to run: Right-click a node → Run node or Run chain. Right-click empty canvas → Run entire canvas or Dismiss all output. Title bar: ▶ Run entire canvas, 🗑 Dismiss all. Commands: Open Zettel Controls; Create tutorial canvas.\", commentLeftX(col5), y5, \"\", TUT_COMMENT_W + TUT_LANE_GAP + TUT_NODE_LANE_W, 195),",
            "lineNumber": 299
          },
          {
            "text": "\t\tn(lab6, \"Sidebar: Open Zettel Controls. There: pick Ollama models and Temperature; restart Python kernel; env vars; Console (obsidian_log in Python cards).\", commentLeftX(col6), y6, \"\", TUT_COMMENT_W + TUT_LANE_GAP + TUT_NODE_LANE_W, 145),",
            "lineNumber": 300
          },
          {
            "text": "\t];",
            "lineNumber": 301
          },
          {
            "lineNumber": 302
          },
          {
            "text": "\tconst edges: CanvasData[\"edges\"] = [",
            "lineNumber": 303
          },
          {
            "text": "\t\te(\"e-orange-out\", orangeNode, orangeOut, EDGE_LABEL_OUTPUT)",
            "lineNumber": 304
          },
          {
            "text": ",",
            "lineNumber": 310
          },
          {
            "text": "\t];",
            "lineNumber": 311
          },
          {
            "text": "}",
            "lineNumber": 314,
            "isSignature": true
          }
        ]
      },
      "score": 0.2333803027868271
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/canvasNodeLabels.ts",
        "range": {
          "startPosition": {
            "line": 228
          },
          "endPosition": {
            "line": 329,
            "column": 1
          }
        },
        "contents": "export async function syncCanvasEdgeModeLabels(\n\tvault: Vault,\n\tcanvasFilePath: string,\n\tcontainerEl: HTMLElement,\n\tcanvas: LiveCanvas | null,\n\tisStillActive?: () =&gt; boolean\n): Promise&lt;void&gt; {\n\n\t\tif (state === \"running\") {\n\t\t\tconst circle = document.createElementNS(SVG_NS, \"circle\");\n\t\t\tcircle.setAttribute(\"class\", EDGE_MODE_ICON_CLASS);\n\t\t\tcircle.setAttribute(\"cx\", String(DOT_R_RUNNING + 2));\n\t\t\tcircle.setAttribute(\"cy\", String(fontSize * 0.4));\n\t\t\tcircle.setAttribute(\"r\", String(DOT_R_RUNNING));\n\t\t\tlabelGroup.appendChild(circle);\n\t\t\ttextX = DOT_R_RUNNING * 2 + DOT_TEXT_GAP;\n\t\t}\n\t\tconst textEl = document.createElementNS(SVG_NS, \"text\");\n\t\ttextEl.setAttribute(\"class\", EDGE_MODE_LABEL_CLASS);\n\t\ttextEl.setAttribute(\"x\", String(textX));\n\t\ttextEl.setAttribute(\"y\", String(fontSize * 0.35));\n\t\ttextEl.setAttribute(\"font-size\", String(fontSize));\n\t\ttextEl.setAttribute(\"text-anchor\", \"start\");\n\t\ttextEl.setAttribute(\"dominant-baseline\", \"central\");\n\t\ttextEl.textContent = textContent;\n\t\tlabelGroup.appendChild(textEl);\n\t\tgroup.appendChild(labelGroup);\n\t}\n\t// Mark output edges so their label can be styled smaller/grayed\n\tfor (const edge of data.edges) {\n\t\tif (!isOutputEdge(edge)) continue;\n\t\tconst fromEl =\n\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, edge.fromNode)) ||\n\t\t\tfindNodeElementByDataId(containerEl, edge.fromNode);\n\t\tconst toEl =\n\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, edge.toNode)) ||\n\t\t\tfindNodeElementByDataId(containerEl, edge.toNode);\n\t\tif (!fromEl || !toEl) continue;\n\t\tconst fromCenter = getElCenter(fromEl);\n\t\tconst toCenter = getElCenter(toEl);\n\t\tconst targetViewportX = (fromCenter.x + toCenter.x) / 2;\n\t\tconst targetViewportY = (fromCenter.y + toCenter.y) / 2;\n\t\tconst pathEl = findPathForEdge(containerEl, targetViewportX, targetViewportY);\n\t\tif (!pathEl) continue;\n\t\tconst group = pathEl.closest(\"g\");\n\t\tif (group) group.classList.add(OUTPUT_EDGE_GROUP_CLASS);\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 229,
                "column": 1
              },
              "endPosition": {
                "line": 229,
                "column": 8
              }
            },
            {
              "startPosition": {
                "line": 229,
                "column": 8
              },
              "endPosition": {
                "line": 236,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export async function syncCanvasEdgeModeLabels(",
            "lineNumber": 229,
            "isSignature": true
          },
          {
            "text": "\tvault: Vault,",
            "lineNumber": 230,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 231,
            "isSignature": true
          },
          {
            "text": "\tcontainerEl: HTMLElement,",
            "lineNumber": 232,
            "isSignature": true
          },
          {
            "text": "\tcanvas: LiveCanvas | null,",
            "lineNumber": 233,
            "isSignature": true
          },
          {
            "text": "\tisStillActive?: () =&gt; boolean",
            "lineNumber": 234,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;void&gt; {",
            "lineNumber": 235,
            "isSignature": true
          },
          {
            "lineNumber": 290
          },
          {
            "text": "\t\tif (state === \"running\") {",
            "lineNumber": 291
          },
          {
            "text": "\t\t\tconst circle = document.createElementNS(SVG_NS, \"circle\");",
            "lineNumber": 292
          },
          {
            "text": "\t\t\tcircle.setAttribute(\"class\", EDGE_MODE_ICON_CLASS);",
            "lineNumber": 293
          },
          {
            "text": "\t\t\tcircle.setAttribute(\"cx\", String(DOT_R_RUNNING + 2));",
            "lineNumber": 294
          },
          {
            "text": "\t\t\tcircle.setAttribute(\"cy\", String(fontSize * 0.4));",
            "lineNumber": 295
          },
          {
            "text": "\t\t\tcircle.setAttribute(\"r\", String(DOT_R_RUNNING));",
            "lineNumber": 296
          },
          {
            "text": "\t\t\tlabelGroup.appendChild(circle);",
            "lineNumber": 297
          },
          {
            "text": "\t\t\ttextX = DOT_R_RUNNING * 2 + DOT_TEXT_GAP;",
            "lineNumber": 298
          },
          {
            "text": "\t\t}",
            "lineNumber": 299
          },
          {
            "text": "\t\tconst textEl = document.createElementNS(SVG_NS, \"text\");",
            "lineNumber": 300
          },
          {
            "text": "\t\ttextEl.setAttribute(\"class\", EDGE_MODE_LABEL_CLASS);",
            "lineNumber": 301
          },
          {
            "text": "\t\ttextEl.setAttribute(\"x\", String(textX));",
            "lineNumber": 302
          },
          {
            "text": "\t\ttextEl.setAttribute(\"y\", String(fontSize * 0.35));",
            "lineNumber": 303
          },
          {
            "text": "\t\ttextEl.setAttribute(\"font-size\", String(fontSize));",
            "lineNumber": 304
          },
          {
            "text": "\t\ttextEl.setAttribute(\"text-anchor\", \"start\");",
            "lineNumber": 305
          },
          {
            "text": "\t\ttextEl.setAttribute(\"dominant-baseline\", \"central\");",
            "lineNumber": 306
          },
          {
            "text": "\t\ttextEl.textContent = textContent;",
            "lineNumber": 307
          },
          {
            "text": "\t\tlabelGroup.appendChild(textEl);",
            "lineNumber": 308
          },
          {
            "text": "\t\tgroup.appendChild(labelGroup);",
            "lineNumber": 309
          },
          {
            "text": "\t}",
            "lineNumber": 310
          },
          {
            "text": "\t// Mark output edges so their label can be styled smaller/grayed",
            "lineNumber": 311
          },
          {
            "text": "\tfor (const edge of data.edges) {",
            "lineNumber": 312
          },
          {
            "text": "\t\tif (!isOutputEdge(edge)) continue;",
            "lineNumber": 313
          },
          {
            "text": "\t\tconst fromEl =",
            "lineNumber": 314
          },
          {
            "text": "\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, edge.fromNode)) ||",
            "lineNumber": 315
          },
          {
            "text": "\t\t\tfindNodeElementByDataId(containerEl, edge.fromNode);",
            "lineNumber": 316
          },
          {
            "text": "\t\tconst toEl =",
            "lineNumber": 317
          },
          {
            "text": "\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, edge.toNode)) ||",
            "lineNumber": 318
          },
          {
            "text": "\t\t\tfindNodeElementByDataId(containerEl, edge.toNode);",
            "lineNumber": 319
          },
          {
            "text": "\t\tif (!fromEl || !toEl) continue;",
            "lineNumber": 320
          },
          {
            "text": "\t\tconst fromCenter = getElCenter(fromEl);",
            "lineNumber": 321
          },
          {
            "text": "\t\tconst toCenter = getElCenter(toEl);",
            "lineNumber": 322
          },
          {
            "text": "\t\tconst targetViewportX = (fromCenter.x + toCenter.x) / 2;",
            "lineNumber": 323
          },
          {
            "text": "\t\tconst targetViewportY = (fromCenter.y + toCenter.y) / 2;",
            "lineNumber": 324
          },
          {
            "text": "\t\tconst pathEl = findPathForEdge(containerEl, targetViewportX, targetViewportY);",
            "lineNumber": 325
          },
          {
            "text": "\t\tif (!pathEl) continue;",
            "lineNumber": 326
          },
          {
            "text": "\t\tconst group = pathEl.closest(\"g\");",
            "lineNumber": 327
          },
          {
            "text": "\t\tif (group) group.classList.add(OUTPUT_EDGE_GROUP_CLASS);",
            "lineNumber": 328
          },
          {
            "text": "\t}",
            "lineNumber": 329
          },
          {
            "text": "}",
            "lineNumber": 330,
            "isSignature": true
          }
        ]
      },
      "score": 0.22223693132400513
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/canvasNodeLabels.ts",
        "range": {
          "startPosition": {
            "line": 228
          },
          "endPosition": {
            "line": 329,
            "column": 1
          }
        },
        "contents": "export async function syncCanvasEdgeModeLabels(\n\tvault: Vault,\n\tcanvasFilePath: string,\n\tcontainerEl: HTMLElement,\n\tcanvas: LiveCanvas | null,\n\tisStillActive?: () =&gt; boolean\n): Promise&lt;void&gt; {\n\n\tfor (const edge of data.edges) {\n\t\tif (isOutputEdge(edge)) continue;\n\t\tconst isRunning = runningNodeId != null &amp;&amp; edge.toNode === runningNodeId;\n\t\tconst mode = getEdgeMode(canvasKey, edge.id);\n\t\tconst state: EdgeDisplayState | null = isRunning\n\t\t\t? \"running\"\n\t\t\t: mode === \"inject\"\n\t\t\t\t? \"inject\"\n\t\t\t\t: mode === \"concatenate\"\n\t\t\t\t\t? \"concatenate\"\n\t\t\t\t\t: null;\n\t\tif (!state) continue;\n\t\tconst fromEl =\n\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, edge.fromNode)) ||\n\t\t\tfindNodeElementByDataId(containerEl, edge.fromNode);\n\t\tconst toEl =\n\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, edge.toNode)) ||\n\t\t\tfindNodeElementByDataId(containerEl, edge.toNode);\n\t\tif (!fromEl || !toEl) continue;\n\t\tconst fromCenter = getElCenter(fromEl);\n\t\tconst toCenter = getElCenter(toEl);\n\t\tconst targetViewportX = (fromCenter.x + toCenter.x) / 2;\n\t\tconst targetViewportY = (fromCenter.y + toCenter.y) / 2;\n\t\tconst pathEl = findPathForEdge(containerEl, targetViewportX, targetViewportY);\n\t\tif (!pathEl) continue;\n\t\tconst group = pathEl.closest(\"g\");\n\t\tif (!group) continue;\n\t\tconst mid = getPathMidpointSvg(pathEl);\n\t\tconst labelGroup = document.createElementNS(SVG_NS, \"g\");\n\t\tlabelGroup.setAttribute(\"class\", EDGE_MODE_SVG_LABEL_CLASS);\n\t\tlabelGroup.setAttribute(EDGE_MODE_DATA_ATTR, edge.id);\n\t\tlabelGroup.setAttribute(EDGE_MODE_STATE_ATTR, state);\n\t\tlabelGroup.setAttribute(\"transform\", &#96;translate(${mid.x}, ${mid.y + Y_OFFSET_BELOW_PATH})&#96;);\n\t\tlabelGroup.setAttribute(\"style\", \"z-index: 100; isolation: isolate;\");\n\t\tconst textContent =\n\t\t\tstate === \"running\" ? \"…\" : state === \"inject\" ? \"(injected)\" : \"(concatenated)\";\n\t\tlet textX = 0;\n\t\tconst fontSize = state === \"running\" ? FONT_SIZE_RUNNING : FONT_SIZE;\n\t\tif (state === \"running\") {\n\t\t\tconst circle = document.createElementNS(SVG_NS, \"circle\");\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 229,
                "column": 1
              },
              "endPosition": {
                "line": 229,
                "column": 8
              }
            },
            {
              "startPosition": {
                "line": 229,
                "column": 8
              },
              "endPosition": {
                "line": 236,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export async function syncCanvasEdgeModeLabels(",
            "lineNumber": 229,
            "isSignature": true
          },
          {
            "text": "\tvault: Vault,",
            "lineNumber": 230,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 231,
            "isSignature": true
          },
          {
            "text": "\tcontainerEl: HTMLElement,",
            "lineNumber": 232,
            "isSignature": true
          },
          {
            "text": "\tcanvas: LiveCanvas | null,",
            "lineNumber": 233,
            "isSignature": true
          },
          {
            "text": "\tisStillActive?: () =&gt; boolean",
            "lineNumber": 234,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;void&gt; {",
            "lineNumber": 235,
            "isSignature": true
          },
          {
            "lineNumber": 252
          },
          {
            "text": "\tfor (const edge of data.edges) {",
            "lineNumber": 253
          },
          {
            "text": "\t\tif (isOutputEdge(edge)) continue;",
            "lineNumber": 254
          },
          {
            "text": "\t\tconst isRunning = runningNodeId != null &amp;&amp; edge.toNode === runningNodeId;",
            "lineNumber": 255
          },
          {
            "text": "\t\tconst mode = getEdgeMode(canvasKey, edge.id);",
            "lineNumber": 256
          },
          {
            "text": "\t\tconst state: EdgeDisplayState | null = isRunning",
            "lineNumber": 257
          },
          {
            "text": "\t\t\t? \"running\"",
            "lineNumber": 258
          },
          {
            "text": "\t\t\t: mode === \"inject\"",
            "lineNumber": 259
          },
          {
            "text": "\t\t\t\t? \"inject\"",
            "lineNumber": 260
          },
          {
            "text": "\t\t\t\t: mode === \"concatenate\"",
            "lineNumber": 261
          },
          {
            "text": "\t\t\t\t\t? \"concatenate\"",
            "lineNumber": 262
          },
          {
            "text": "\t\t\t\t\t: null;",
            "lineNumber": 263
          },
          {
            "text": "\t\tif (!state) continue;",
            "lineNumber": 264
          },
          {
            "text": "\t\tconst fromEl =",
            "lineNumber": 265
          },
          {
            "text": "\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, edge.fromNode)) ||",
            "lineNumber": 266
          },
          {
            "text": "\t\t\tfindNodeElementByDataId(containerEl, edge.fromNode);",
            "lineNumber": 267
          },
          {
            "text": "\t\tconst toEl =",
            "lineNumber": 268
          },
          {
            "text": "\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, edge.toNode)) ||",
            "lineNumber": 269
          },
          {
            "text": "\t\t\tfindNodeElementByDataId(containerEl, edge.toNode);",
            "lineNumber": 270
          },
          {
            "text": "\t\tif (!fromEl || !toEl) continue;",
            "lineNumber": 271
          },
          {
            "text": "\t\tconst fromCenter = getElCenter(fromEl);",
            "lineNumber": 272
          },
          {
            "text": "\t\tconst toCenter = getElCenter(toEl);",
            "lineNumber": 273
          },
          {
            "text": "\t\tconst targetViewportX = (fromCenter.x + toCenter.x) / 2;",
            "lineNumber": 274
          },
          {
            "text": "\t\tconst targetViewportY = (fromCenter.y + toCenter.y) / 2;",
            "lineNumber": 275
          },
          {
            "text": "\t\tconst pathEl = findPathForEdge(containerEl, targetViewportX, targetViewportY);",
            "lineNumber": 276
          },
          {
            "text": "\t\tif (!pathEl) continue;",
            "lineNumber": 277
          },
          {
            "text": "\t\tconst group = pathEl.closest(\"g\");",
            "lineNumber": 278
          },
          {
            "text": "\t\tif (!group) continue;",
            "lineNumber": 279
          },
          {
            "text": "\t\tconst mid = getPathMidpointSvg(pathEl);",
            "lineNumber": 280
          },
          {
            "text": "\t\tconst labelGroup = document.createElementNS(SVG_NS, \"g\");",
            "lineNumber": 281
          },
          {
            "text": "\t\tlabelGroup.setAttribute(\"class\", EDGE_MODE_SVG_LABEL_CLASS);",
            "lineNumber": 282
          },
          {
            "text": "\t\tlabelGroup.setAttribute(EDGE_MODE_DATA_ATTR, edge.id);",
            "lineNumber": 283
          },
          {
            "text": "\t\tlabelGroup.setAttribute(EDGE_MODE_STATE_ATTR, state);",
            "lineNumber": 284
          },
          {
            "text": "\t\tlabelGroup.setAttribute(\"transform\", &#96;translate(${mid.x}, ${mid.y + Y_OFFSET_BELOW_PATH})&#96;);",
            "lineNumber": 285
          },
          {
            "text": "\t\tlabelGroup.setAttribute(\"style\", \"z-index: 100; isolation: isolate;\");",
            "lineNumber": 286
          },
          {
            "text": "\t\tconst textContent =",
            "lineNumber": 287
          },
          {
            "text": "\t\t\tstate === \"running\" ? \"…\" : state === \"inject\" ? \"(injected)\" : \"(concatenated)\";",
            "lineNumber": 288
          },
          {
            "text": "\t\tlet textX = 0;",
            "lineNumber": 289
          },
          {
            "text": "\t\tconst fontSize = state === \"running\" ? FONT_SIZE_RUNNING : FONT_SIZE;",
            "lineNumber": 290
          },
          {
            "text": "\t\tif (state === \"running\") {",
            "lineNumber": 291
          },
          {
            "text": "\t\t\tconst circle = document.createElementNS(SVG_NS, \"circle\");",
            "lineNumber": 292
          },
          {
            "text": "}",
            "lineNumber": 330,
            "isSignature": true
          }
        ]
      },
      "score": 0.21821250021457672
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 94,
            "column": 1
          },
          "endPosition": {
            "line": 313,
            "column": 1
          }
        },
        "contents": "/** Build tutorial canvas: columns with comment margins, node lane center, edges, groups. */\nfunction getTutorialCanvasData(settings: ZettelPluginSettings): CanvasData {\n\tconst cOrange = tutorialColor(settings, \"colorOrange\");\n\tconst cPurple = tutorialColor(settings, \"colorPurple\");\n\tconst cBlue = tutorialColor(settings, \"colorBlue\");\n\tconst cYellow = tutorialColor(settings, \"colorYellow\");\n\tconst cGreen = tutorialColor(settings, \"colorGreen\");\n\n\t/** Plain text node (no role): use for labels/instructions so they are not treated as comment nodes. */\n\tconst n = (id: string, text: string, x: number, y: number, color: string, w: number, h: number) =&gt;\n\t\t({ id, type: \"text\" as const, text, x, y, width: w, height: h, color });\n\tconst e = (id: string, from: string, to: string, label?: string) =&gt; ({\n\t\tid,\n\t\tfromNode: from,\n\t\ttoNode: to,\n\t\tfromSide: \"bottom\" as const,\n\t\ttoSide: \"top\" as const,\n\t\tlabel: label ?? \"\",\n\t});\n\t/** Group node to visually separate a workflow block. */\n\tconst g = (id: string, x: number, y: number, w: number, h: number, label: string) =&gt;\n\t\t({ id, type: \"group\" as const, x, y, width: w, height: h, label });\n\n\t/** Column 1..6: x of left comment margin (column 1 starts right after welcome). */\n\tconst colLeft = (index: number) =&gt;\n\t\tTUT_LEFT + TUT_WELCOME_W + TUT_COL_GAP + (index - 1) * (TUT_COL_TOTAL_W + TUT_COL_GAP);\n\tconst commentLeftX = (colIndex: number) =&gt; colLeft(colIndex);\n\t/** Node lane: center x; offsetPx shifts right so alternating nodes make arrows more visible. */\n\tconst laneNodeX = (colIndex: number, offsetPx: number = 0) =&gt;\n\t\tcolLeft(colIndex) + TUT_COMMENT_W + TUT_LANE_GAP + offsetPx;\n\tconst commentRightX = (colIndex: number) =&gt;\n\t\tcolLeft(colIndex) + TUT_COMMENT_W + TUT_LANE_GAP + TUT_NODE_LANE_W + TUT_LANE_GAP;\n\tconst LANE_OFFSET = 36;\n\n\t// —— Welcome: alone in first block, no overlap with column 1 ——\n\tconst welcome = \"welcome\";\n\tconst welcomeY = TUT_TOP;\n\n\t// —— Column 1: Primary (comment left, node → output in lane) ——\n\tconst col1 = 1;\n\tconst lab1 = \"lab-primary\";\n\tconst orangeNode = \"orange-example\";\n\tconst orangeOut = \"orange-out\";\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Build tutorial canvas: columns with comment margins, node lane center, edges, groups. */",
            "lineNumber": 97
          },
          {
            "text": "function getTutorialCanvasData(settings: ZettelPluginSettings): CanvasData {",
            "lineNumber": 98,
            "isSignature": true
          },
          {
            "text": "\tconst cOrange = tutorialColor(settings, \"colorOrange\");",
            "lineNumber": 99
          },
          {
            "text": "\tconst cPurple = tutorialColor(settings, \"colorPurple\");",
            "lineNumber": 100
          },
          {
            "text": "\tconst cBlue = tutorialColor(settings, \"colorBlue\");",
            "lineNumber": 101
          },
          {
            "text": "\tconst cYellow = tutorialColor(settings, \"colorYellow\");",
            "lineNumber": 102
          },
          {
            "text": "\tconst cGreen = tutorialColor(settings, \"colorGreen\");",
            "lineNumber": 103
          },
          {
            "lineNumber": 104
          },
          {
            "text": "\t/** Plain text node (no role): use for labels/instructions so they are not treated as comment nodes. */",
            "lineNumber": 105
          },
          {
            "text": "\tconst n = (id: string, text: string, x: number, y: number, color: string, w: number, h: number) =&gt;",
            "lineNumber": 106
          },
          {
            "text": "\t\t({ id, type: \"text\" as const, text, x, y, width: w, height: h, color });",
            "lineNumber": 107
          },
          {
            "text": "\tconst e = (id: string, from: string, to: string, label?: string) =&gt; ({",
            "lineNumber": 108
          },
          {
            "text": "\t\tid,",
            "lineNumber": 109
          },
          {
            "text": "\t\tfromNode: from,",
            "lineNumber": 110
          },
          {
            "text": "\t\ttoNode: to,",
            "lineNumber": 111
          },
          {
            "text": "\t\tfromSide: \"bottom\" as const,",
            "lineNumber": 112
          },
          {
            "text": "\t\ttoSide: \"top\" as const,",
            "lineNumber": 113
          },
          {
            "text": "\t\tlabel: label ?? \"\",",
            "lineNumber": 114
          },
          {
            "text": "\t});",
            "lineNumber": 115
          },
          {
            "text": "\t/** Group node to visually separate a workflow block. */",
            "lineNumber": 116
          },
          {
            "text": "\tconst g = (id: string, x: number, y: number, w: number, h: number, label: string) =&gt;",
            "lineNumber": 117
          },
          {
            "text": "\t\t({ id, type: \"group\" as const, x, y, width: w, height: h, label });",
            "lineNumber": 118
          },
          {
            "lineNumber": 119
          },
          {
            "text": "\t/** Column 1..6: x of left comment margin (column 1 starts right after welcome). */",
            "lineNumber": 120
          },
          {
            "text": "\tconst colLeft = (index: number) =&gt;",
            "lineNumber": 121
          },
          {
            "text": "\t\tTUT_LEFT + TUT_WELCOME_W + TUT_COL_GAP + (index - 1) * (TUT_COL_TOTAL_W + TUT_COL_GAP);",
            "lineNumber": 122
          },
          {
            "text": "\tconst commentLeftX = (colIndex: number) =&gt; colLeft(colIndex);",
            "lineNumber": 123
          },
          {
            "text": "\t/** Node lane: center x; offsetPx shifts right so alternating nodes make arrows more visible. */",
            "lineNumber": 124
          },
          {
            "text": "\tconst laneNodeX = (colIndex: number, offsetPx: number = 0) =&gt;",
            "lineNumber": 125
          },
          {
            "text": "\t\tcolLeft(colIndex) + TUT_COMMENT_W + TUT_LANE_GAP + offsetPx;",
            "lineNumber": 126
          },
          {
            "text": "\tconst commentRightX = (colIndex: number) =&gt;",
            "lineNumber": 127
          },
          {
            "text": "\t\tcolLeft(colIndex) + TUT_COMMENT_W + TUT_LANE_GAP + TUT_NODE_LANE_W + TUT_LANE_GAP;",
            "lineNumber": 128
          },
          {
            "text": "\tconst LANE_OFFSET = 36;",
            "lineNumber": 129
          },
          {
            "lineNumber": 130
          },
          {
            "text": "\t// —— Welcome: alone in first block, no overlap with column 1 ——",
            "lineNumber": 131
          },
          {
            "text": "\tconst welcome = \"welcome\";",
            "lineNumber": 132
          },
          {
            "text": "\tconst welcomeY = TUT_TOP;",
            "lineNumber": 133
          },
          {
            "lineNumber": 134
          },
          {
            "text": "\t// —— Column 1: Primary (comment left, node → output in lane) ——",
            "lineNumber": 135
          },
          {
            "text": "\tconst col1 = 1;",
            "lineNumber": 136
          },
          {
            "text": "\tconst lab1 = \"lab-primary\";",
            "lineNumber": 137
          },
          {
            "text": "\tconst orangeNode = \"orange-example\";",
            "lineNumber": 138
          },
          {
            "text": "\tconst orangeOut = \"orange-out\";",
            "lineNumber": 139
          },
          {
            "text": "}",
            "lineNumber": 314,
            "isSignature": true
          }
        ]
      },
      "score": 0.21789246797561646
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/canvasApi.ts",
        "range": {
          "startPosition": {
            "column": 86
          },
          "endPosition": {
            "line": 15,
            "column": 1
          }
        },
        "contents": "export interface LiveCanvas {\n\tcreateTextNode(options: {\n\t\ttext: string;\n\t\tpos: { x: number; y: number };\n\t\tsize: { width: number; height: number };\n\t\tsave?: boolean;\n\t\tfocus?: boolean;\n\t}): { id: string; x: number; y: number; width: number; height: number; moveTo: (pos: { x: number; y: number }) =&gt; void; resize: (size: { width: number; height: number }) =&gt; void };\n\taddNode(node: unknown): void;\n\trequestSave?: () =&gt; void;\n\tremoveNode?(node: unknown): void;\n\tnodes?: Map&lt;string, unknown&gt; | Iterable&lt;unknown&gt;;\n\t/** If present, used to refresh canvas after edge label updates (Obsidian canvas view). */\n\tsetData?(data: unknown): void;\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "export interface LiveCanvas {",
            "lineNumber": 2,
            "isSignature": true
          },
          {
            "text": "\tcreateTextNode(options: {",
            "lineNumber": 3
          },
          {
            "text": "\t\ttext: string;",
            "lineNumber": 4
          },
          {
            "text": "\t\tpos: { x: number; y: number };",
            "lineNumber": 5
          },
          {
            "text": "\t\tsize: { width: number; height: number };",
            "lineNumber": 6
          },
          {
            "text": "\t\tsave?: boolean;",
            "lineNumber": 7
          },
          {
            "text": "\t\tfocus?: boolean;",
            "lineNumber": 8
          },
          {
            "text": "\t}): { id: string; x: number; y: number; width: number; height: number; moveTo: (pos: { x: number; y: number }) =&gt; void; resize: (size: { width: number; height: number }) =&gt; void };",
            "lineNumber": 9
          },
          {
            "text": "\taddNode(node: unknown): void;",
            "lineNumber": 10
          },
          {
            "text": "\trequestSave?: () =&gt; void;",
            "lineNumber": 11
          },
          {
            "text": "\tremoveNode?(node: unknown): void;",
            "lineNumber": 12
          },
          {
            "text": "\tnodes?: Map&lt;string, unknown&gt; | Iterable&lt;unknown&gt;;",
            "lineNumber": 13
          },
          {
            "text": "\t/** If present, used to refresh canvas after edge label updates (Obsidian canvas view). */",
            "lineNumber": 14
          },
          {
            "text": "\tsetData?(data: unknown): void;",
            "lineNumber": 15,
            "isSignature": true
          },
          {
            "text": "}",
            "lineNumber": 16,
            "isSignature": true
          }
        ]
      },
      "score": 0.21276940405368805
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 251,
            "column": 1
          },
          "endPosition": {
            "line": 346,
            "column": 1
          }
        },
        "contents": "/** Run a single node: get input + parent context (concatenate or {{var:name}}), call LLM or Python, store result. */\nasync function runSingleNode(\n\tapp: App,\n\tsettings: ZettelPluginSettings,\n\tcanvasKey: string,\n\tcanvasFilePath: string,\n\tdata: CanvasData,\n\tnodeId: string,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;string&gt; {\n\tconst node = getNodeById(data, nodeId);\n\tif (!node) return \"\";\n\tconst role = getNodeRole(node, settings);\n\tif (!role || role === \"yellow\" || role === \"green\") {\n\t\t// Yellow = text (input pass-through): use node content as result\n\t\tif (role === \"yellow\") {\n\t\t\tconst content = await getNodeContent(node, app.vault);\n\t\t\tsetNodeResult(canvasKey, nodeId, content);\n\t\t\treturn content;\n\t\t}\n\t\treturn \"\";\n\t}\n\t// For Python (blue) text nodes, auto-wrap content in &#96;&#96;&#96;python ... &#96;&#96;&#96; so # comments render correctly\n\tif (role === \"blue\" &amp;&amp; isTextNode(node)) {\n\t\tconst raw = getTextNodeContent(node as CanvasTextData);\n\t\tif (!isPythonCodeFenced(raw)) {\n\t\t\t(node as CanvasTextData).text = ensurePythonCodeFence(raw);\n\t\t\tliveCanvas?.setData?.(data);\n\t\t\tawait saveCanvasData(app.vault, canvasFilePath, data);\n\t\t}\n\t}\n\tconst incoming = getIncomingEdgesWithLabels(nodeId, data);\n\tconst nodeInput = await getNodeContent(node, app.vault);\n\tconst { concatenatedPart, template, edgeModes } = buildInputWithVariables(\n\t\tcanvasKey,\n\t\tnodeInput,\n\t\tincoming\n\t);\n\tconst fullPrompt =\n\t\tconcatenatedPart.length &gt; 0 ? &#96;${concatenatedPart}\\n\\n---\\n\\n${template}&#96; : template;\n\n\tif (role === \"orange\") {\n\t\tconst model = settings.ollamaOrangeModel || \"llama2\";\n\t\tconst temperature = settings.ollamaOrangeTemperature ?? DEFAULT_SETTINGS.ollamaOrangeTemperature;\n\t\tconst result = await ollamaGenerate({\n\t\t\tmodel,\n\t\t\tprompt: fullPrompt,\n\t\t\tstream: false,\n\t\t\toptions: { temperature },\n\t\t});\n\t\tsetNodeResult(canvasKey, nodeId, result);\n\t\tensureOutputNodeAndEdge(data, node, result, settings);\n\t\tawait updateEdgeLabelsAndSave(app.vault, canvasFilePath, data, nodeId, edgeModes, liveCanvas);\n\t\treturn result;\n\t}\n\tif (role === \"purple\") {\n\t\tconst model = settings.ollamaPurpleModel || \"llama2\";\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Run a single node: get input + parent context (concatenate or {{var:name}}), call LLM or Python, store result. */",
            "lineNumber": 254
          },
          {
            "text": "async function runSingleNode(",
            "lineNumber": 255,
            "isSignature": true
          },
          {
            "text": "\tapp: App,",
            "lineNumber": 256,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 257,
            "isSignature": true
          },
          {
            "text": "\tcanvasKey: string,",
            "lineNumber": 258,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 259,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 260,
            "isSignature": true
          },
          {
            "text": "\tnodeId: string,",
            "lineNumber": 261,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 262,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;string&gt; {",
            "lineNumber": 263,
            "isSignature": true
          },
          {
            "text": "\tconst node = getNodeById(data, nodeId);",
            "lineNumber": 264
          },
          {
            "text": "\tif (!node) return \"\";",
            "lineNumber": 265
          },
          {
            "text": "\tconst role = getNodeRole(node, settings);",
            "lineNumber": 266
          },
          {
            "text": "\tif (!role || role === \"yellow\" || role === \"green\") {",
            "lineNumber": 267
          },
          {
            "text": "\t\t// Yellow = text (input pass-through): use node content as result",
            "lineNumber": 268
          },
          {
            "text": "\t\tif (role === \"yellow\") {",
            "lineNumber": 269
          },
          {
            "text": "\t\t\tconst content = await getNodeContent(node, app.vault);",
            "lineNumber": 270
          },
          {
            "text": "\t\t\tsetNodeResult(canvasKey, nodeId, content);",
            "lineNumber": 271
          },
          {
            "text": "\t\t\treturn content;",
            "lineNumber": 272
          },
          {
            "text": "\t\t}",
            "lineNumber": 273
          },
          {
            "text": "\t\treturn \"\";",
            "lineNumber": 274
          },
          {
            "text": "\t}",
            "lineNumber": 275
          },
          {
            "text": "\t// For Python (blue) text nodes, auto-wrap content in &#96;&#96;&#96;python ... &#96;&#96;&#96; so # comments render correctly",
            "lineNumber": 276
          },
          {
            "text": "\tif (role === \"blue\" &amp;&amp; isTextNode(node)) {",
            "lineNumber": 277
          },
          {
            "text": "\t\tconst raw = getTextNodeContent(node as CanvasTextData);",
            "lineNumber": 278
          },
          {
            "text": "\t\tif (!isPythonCodeFenced(raw)) {",
            "lineNumber": 279
          },
          {
            "text": "\t\t\t(node as CanvasTextData).text = ensurePythonCodeFence(raw);",
            "lineNumber": 280
          },
          {
            "text": "\t\t\tliveCanvas?.setData?.(data);",
            "lineNumber": 281
          },
          {
            "text": "\t\t\tawait saveCanvasData(app.vault, canvasFilePath, data);",
            "lineNumber": 282
          },
          {
            "text": "\t\t}",
            "lineNumber": 283
          },
          {
            "text": "\t}",
            "lineNumber": 284
          },
          {
            "text": "\tconst incoming = getIncomingEdgesWithLabels(nodeId, data);",
            "lineNumber": 285
          },
          {
            "text": "\tconst nodeInput = await getNodeContent(node, app.vault);",
            "lineNumber": 286
          },
          {
            "text": "\tconst { concatenatedPart, template, edgeModes } = buildInputWithVariables(",
            "lineNumber": 287
          },
          {
            "text": "\t\tcanvasKey,",
            "lineNumber": 288
          },
          {
            "text": "\t\tnodeInput,",
            "lineNumber": 289
          },
          {
            "text": "\t\tincoming",
            "lineNumber": 290
          },
          {
            "text": "\t);",
            "lineNumber": 291
          },
          {
            "text": "\tconst fullPrompt =",
            "lineNumber": 292
          },
          {
            "text": "\t\tconcatenatedPart.length &gt; 0 ? &#96;${concatenatedPart}\\n\\n---\\n\\n${template}&#96; : template;",
            "lineNumber": 293
          },
          {
            "lineNumber": 294
          },
          {
            "text": "\tif (role === \"orange\") {",
            "lineNumber": 295
          },
          {
            "text": "\t\tconst model = settings.ollamaOrangeModel || \"llama2\";",
            "lineNumber": 296
          },
          {
            "text": "\t\tconst temperature = settings.ollamaOrangeTemperature ?? DEFAULT_SETTINGS.ollamaOrangeTemperature;",
            "lineNumber": 297
          },
          {
            "text": "\t\tconst result = await ollamaGenerate({",
            "lineNumber": 298
          },
          {
            "text": "\t\t\tmodel,",
            "lineNumber": 299
          },
          {
            "text": "\t\t\tprompt: fullPrompt,",
            "lineNumber": 300
          },
          {
            "text": "\t\t\tstream: false,",
            "lineNumber": 301
          },
          {
            "text": "\t\t\toptions: { temperature },",
            "lineNumber": 302
          },
          {
            "text": "\t\t});",
            "lineNumber": 303
          },
          {
            "text": "\t\tsetNodeResult(canvasKey, nodeId, result);",
            "lineNumber": 304
          },
          {
            "text": "\t\tensureOutputNodeAndEdge(data, node, result, settings);",
            "lineNumber": 305
          },
          {
            "text": "\t\tawait updateEdgeLabelsAndSave(app.vault, canvasFilePath, data, nodeId, edgeModes, liveCanvas);",
            "lineNumber": 306
          },
          {
            "text": "\t\treturn result;",
            "lineNumber": 307
          },
          {
            "text": "\t}",
            "lineNumber": 308
          },
          {
            "text": "\tif (role === \"purple\") {",
            "lineNumber": 309
          },
          {
            "text": "\t\tconst model = settings.ollamaPurpleModel || \"llama2\";",
            "lineNumber": 310
          },
          {
            "text": "}",
            "lineNumber": 347,
            "isSignature": true
          }
        ]
      },
      "score": 0.2127210944890976
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/settings.ts",
        "range": {
          "startPosition": {
            "line": 512
          },
          "endPosition": {
            "line": 892,
            "column": 1
          }
        },
        "contents": "export class ZettelSettingTab extends PluginSettingTab {\ndisplay(): void {\n\n\n\t\tnew Setting(templatesSection)\n\t\t\t.setName(\"Output folder\")\n\t\t\t.setDesc(\"Folder where new canvases from templates will be created (e.g. Canvases). Leave empty to create in vault root.\")\n\t\t\t.addText((text) =&gt; text\n\t\t\t\t.setPlaceholder(\"Canvases\")\n\t\t\t\t.setValue(s.canvasOutputFolder)\n\t\t\t\t.onChange(async (value) =&gt; {\n\t\t\t\t\ts.canvasOutputFolder = value;\n\t\t\t\t\tawait this.plugin.saveSettings();\n\t\t\t\t}));\n\t}\n\n\tprivate addInstallationSection(containerEl: HTMLElement): void {\n\t\tconst installSection = containerEl.createDiv({ cls: \"ztb-settings-section\" });\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 513,
                "column": 1
              },
              "endPosition": {
                "line": 513,
                "column": 8
              }
            },
            {
              "startPosition": {
                "line": 513,
                "column": 8
              },
              "endPosition": {
                "line": 514,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 521,
                "column": 2
              },
              "endPosition": {
                "line": 522,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export class ZettelSettingTab extends PluginSettingTab {",
            "lineNumber": 513,
            "isSignature": true
          },
          {
            "text": "display(): void {",
            "lineNumber": 521
          },
          {
            "lineNumber": 645
          },
          {
            "lineNumber": 646
          },
          {
            "text": "\t\tnew Setting(templatesSection)",
            "lineNumber": 647
          },
          {
            "text": "\t\t\t.setName(\"Output folder\")",
            "lineNumber": 648
          },
          {
            "text": "\t\t\t.setDesc(\"Folder where new canvases from templates will be created (e.g. Canvases). Leave empty to create in vault root.\")",
            "lineNumber": 649
          },
          {
            "text": "\t\t\t.addText((text) =&gt; text",
            "lineNumber": 650
          },
          {
            "text": "\t\t\t\t.setPlaceholder(\"Canvases\")",
            "lineNumber": 651
          },
          {
            "text": "\t\t\t\t.setValue(s.canvasOutputFolder)",
            "lineNumber": 652
          },
          {
            "text": "\t\t\t\t.onChange(async (value) =&gt; {",
            "lineNumber": 653
          },
          {
            "text": "\t\t\t\t\ts.canvasOutputFolder = value;",
            "lineNumber": 654
          },
          {
            "text": "\t\t\t\t\tawait this.plugin.saveSettings();",
            "lineNumber": 655
          },
          {
            "text": "\t\t\t\t}));",
            "lineNumber": 656
          },
          {
            "text": "\t}",
            "lineNumber": 657
          },
          {
            "lineNumber": 658
          },
          {
            "text": "\tprivate addInstallationSection(containerEl: HTMLElement): void {",
            "lineNumber": 659
          },
          {
            "text": "\t\tconst installSection = containerEl.createDiv({ cls: \"ztb-settings-section\" });",
            "lineNumber": 660
          },
          {
            "text": "\t}",
            "lineNumber": 830
          },
          {
            "text": "}",
            "lineNumber": 893,
            "isSignature": true
          }
        ]
      },
      "score": 0.21135050058364868
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/types.ts",
        "range": {
          "startPosition": {
            "line": 35,
            "column": 57
          },
          "endPosition": {
            "line": 40,
            "column": 83
          }
        },
        "contents": "/** Reserved edge label from run node to its green output note; not a variable name. */\nexport const EDGE_LABEL_OUTPUT = \"output\";\n\n/** Parse variable name from edge label; ignore anything in brackets at the end. */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Reserved edge label from run node to its green output note; not a variable name. */",
            "lineNumber": 38
          },
          {
            "text": "export const EDGE_LABEL_OUTPUT = \"output\";",
            "lineNumber": 39
          },
          {
            "lineNumber": 40
          },
          {
            "text": "/** Parse variable name from edge label; ignore anything in brackets at the end. */",
            "lineNumber": 41
          }
        ]
      },
      "score": 0.2110249400138855
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/tutorials/example4Data.ts",
        "range": {
          "startPosition": {
            "column": 48
          },
          "endPosition": {
            "line": 138,
            "column": 1
          }
        },
        "contents": "/** Example 2 &amp; 3: Variable injection and Python state. */\nexport function getExample4CanvasData(): CanvasData {\n\treturn {\n\t\tnodes: [\n\t\t\t// Workflow 2: Variable Injection\n\t\t\t{\n\t\t\t\tid: \"group-inject\",\n\t\t\t\ttype: \"group\",\n\t\t\t\tx: 30,\n\t\t\t\ty: 30,\n\t\t\t\twidth: 720,\n\t\t\t\theight: 540,\n\t\t\t\tlabel: \"Workflow 2: Variable Injection (precise placement)\",\n\t\t\t},\n\t\t\t{\n\t\t\t\tid: \"yellow-concept\",\n\t\t\t\ttype: \"text\",\n\t\t\t\ttext: \"Evergreen notes\",\n\t\t\t\tx: 50,\n\t\t\t\ty: 100,\n\t\t\t\twidth: 200,\n\t\t\t\theight: 60,\n\t\t\t\tcolor: \"3\",\n\t\t\t},\n\t\t\t{\n\t\t\t\tid: \"orange-define\",\n\t\t\t\ttype: \"text\",\n\t\t\t\ttext: \"Define {{var:term}} in one sentence.\",\n\t\t\t\tx: 300,\n\t\t\t\ty: 100,\n\t\t\t\twidth: 250,\n\t\t\t\theight: 100,\n\t\t\t\tcolor: \"1\",\n\t\t\t},\n\t\t\t{\n\t\t\t\tid: \"purple-critique\",\n\t\t\t\ttype: \"text\",\n\t\t\t\ttext: \"Critique this definition:\\n\\n{{var:def}}\\n\\nProvide 2 improvements.\",\n\t\t\t\tx: 300,\n\t\t\t\ty: 260,\n\t\t\t\twidth: 300,\n\t\t\t\theight: 140,\n\t\t\t\tcolor: \"2\",\n\t\t\t},\n\t\t\t{\n\t\t\t\tid: \"note-inject-explanation\",\n\t\t\t\ttype: \"text\",\n\t\t\t\ttext: \"💡 How it works:\\n\\n1. Label the edge: 'term' (not concatenated)\\n2. In Orange: {{var:term}} inserts 'Evergreen notes'\\n3. Label next edge: 'def' \\n4. In Purple: {{var:def}} inserts the definition\\n\\nWithout {{var:name}}, the input would be concatenated at the top instead.\",\n\t\t\t\tx: 50,\n\t\t\t\ty: 430,\n\t\t\t\twidth: 650,\n\t\t\t\theight: 120,\n\t\t\t\tcolor: \"\",\n\t\t\t},\n\t\t\t// Workflow 3: Python State\n\t\t\t{\n\t\t\t\tid: \"group-python\",\n\t\t\t\ttype: \"group\",\n\t\t\t\tx: 30,\n\t\t\t\ty: 610,\n\t\t\t\twidth: 720,\n\t\t\t\theight: 520,\n\t\t\t\tlabel: \"Workflow 3: Python Persistent State\",\n\t\t\t},\n\t\t\t{\n\t\t\t\tid: \"yellow-note1\",\n\t\t\t\ttype: \"text\",\n\t\t\t\ttext: \"Topic: Atomic notes\",\n\t\t\t\tx: 50,\n\t\t\t\ty: 680,\n\t\t\t\twidth: 200,\n\t\t\t\theight: 60,\n\t\t\t\tcolor: \"3\",\n\t\t\t},\n\t\t\t{\n\t\t\t\tid: \"blue-store1\",\n\t\t\t\ttype: \"text\",\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Example 2 &amp; 3: Variable injection and Python state. */",
            "lineNumber": 3
          },
          {
            "text": "export function getExample4CanvasData(): CanvasData {",
            "lineNumber": 4,
            "isSignature": true
          },
          {
            "text": "\treturn {",
            "lineNumber": 5
          },
          {
            "text": "\t\tnodes: [",
            "lineNumber": 6
          },
          {
            "text": "\t\t\t// Workflow 2: Variable Injection",
            "lineNumber": 7
          },
          {
            "text": "\t\t\t{",
            "lineNumber": 8
          },
          {
            "text": "\t\t\t\tid: \"group-inject\",",
            "lineNumber": 9
          },
          {
            "text": "\t\t\t\ttype: \"group\",",
            "lineNumber": 10
          },
          {
            "text": "\t\t\t\tx: 30,",
            "lineNumber": 11
          },
          {
            "text": "\t\t\t\ty: 30,",
            "lineNumber": 12
          },
          {
            "text": "\t\t\t\twidth: 720,",
            "lineNumber": 13
          },
          {
            "text": "\t\t\t\theight: 540,",
            "lineNumber": 14
          },
          {
            "text": "\t\t\t\tlabel: \"Workflow 2: Variable Injection (precise placement)\",",
            "lineNumber": 15
          },
          {
            "text": "\t\t\t},",
            "lineNumber": 16
          },
          {
            "text": "\t\t\t{",
            "lineNumber": 17
          },
          {
            "text": "\t\t\t\tid: \"yellow-concept\",",
            "lineNumber": 18
          },
          {
            "text": "\t\t\t\ttype: \"text\",",
            "lineNumber": 19
          },
          {
            "text": "\t\t\t\ttext: \"Evergreen notes\",",
            "lineNumber": 20
          },
          {
            "text": "\t\t\t\tx: 50,",
            "lineNumber": 21
          },
          {
            "text": "\t\t\t\ty: 100,",
            "lineNumber": 22
          },
          {
            "text": "\t\t\t\twidth: 200,",
            "lineNumber": 23
          },
          {
            "text": "\t\t\t\theight: 60,",
            "lineNumber": 24
          },
          {
            "text": "\t\t\t\tcolor: \"3\",",
            "lineNumber": 25
          },
          {
            "text": "\t\t\t},",
            "lineNumber": 26
          },
          {
            "text": "\t\t\t{",
            "lineNumber": 27
          },
          {
            "text": "\t\t\t\tid: \"orange-define\",",
            "lineNumber": 28
          },
          {
            "text": "\t\t\t\ttype: \"text\",",
            "lineNumber": 29
          },
          {
            "text": "\t\t\t\ttext: \"Define {{var:term}} in one sentence.\",",
            "lineNumber": 30
          },
          {
            "text": "\t\t\t\tx: 300,",
            "lineNumber": 31
          },
          {
            "text": "\t\t\t\ty: 100,",
            "lineNumber": 32
          },
          {
            "text": "\t\t\t\twidth: 250,",
            "lineNumber": 33
          },
          {
            "text": "\t\t\t\theight: 100,",
            "lineNumber": 34
          },
          {
            "text": "\t\t\t\tcolor: \"1\",",
            "lineNumber": 35
          },
          {
            "text": "\t\t\t},",
            "lineNumber": 36
          },
          {
            "text": "\t\t\t{",
            "lineNumber": 37
          },
          {
            "text": "\t\t\t\tid: \"purple-critique\",",
            "lineNumber": 38
          },
          {
            "text": "\t\t\t\ttype: \"text\",",
            "lineNumber": 39
          },
          {
            "text": "\t\t\t\ttext: \"Critique this definition:\\n\\n{{var:def}}\\n\\nProvide 2 improvements.\",",
            "lineNumber": 40
          },
          {
            "text": "\t\t\t\tx: 300,",
            "lineNumber": 41
          },
          {
            "text": "\t\t\t\ty: 260,",
            "lineNumber": 42
          },
          {
            "text": "\t\t\t\twidth: 300,",
            "lineNumber": 43
          },
          {
            "text": "\t\t\t\theight: 140,",
            "lineNumber": 44
          },
          {
            "text": "\t\t\t\tcolor: \"2\",",
            "lineNumber": 45
          },
          {
            "text": "\t\t\t},",
            "lineNumber": 46
          },
          {
            "text": "\t\t\t{",
            "lineNumber": 47
          },
          {
            "text": "\t\t\t\tid: \"note-inject-explanation\",",
            "lineNumber": 48
          },
          {
            "text": "\t\t\t\ttype: \"text\",",
            "lineNumber": 49
          },
          {
            "text": "\t\t\t\ttext: \"💡 How it works:\\n\\n1. Label the edge: 'term' (not concatenated)\\n2. In Orange: {{var:term}} inserts 'Evergreen notes'\\n3. Label next edge: 'def' \\n4. In Purple: {{var:def}} inserts the definition\\n\\nWithout {{var:name}}, the input would be concatenated at the top instead.\",",
            "lineNumber": 50
          },
          {
            "text": "\t\t\t\tx: 50,",
            "lineNumber": 51
          },
          {
            "text": "\t\t\t\ty: 430,",
            "lineNumber": 52
          },
          {
            "text": "\t\t\t\twidth: 650,",
            "lineNumber": 53
          },
          {
            "text": "\t\t\t\theight: 120,",
            "lineNumber": 54
          },
          {
            "text": "\t\t\t\tcolor: \"\",",
            "lineNumber": 55
          },
          {
            "text": "\t\t\t},",
            "lineNumber": 56
          },
          {
            "text": "\t\t\t// Workflow 3: Python State",
            "lineNumber": 57
          },
          {
            "text": "\t\t\t{",
            "lineNumber": 58
          },
          {
            "text": "\t\t\t\tid: \"group-python\",",
            "lineNumber": 59
          },
          {
            "text": "\t\t\t\ttype: \"group\",",
            "lineNumber": 60
          },
          {
            "text": "\t\t\t\tx: 30,",
            "lineNumber": 61
          },
          {
            "text": "\t\t\t\ty: 610,",
            "lineNumber": 62
          },
          {
            "text": "\t\t\t\twidth: 720,",
            "lineNumber": 63
          },
          {
            "text": "\t\t\t\theight: 520,",
            "lineNumber": 64
          },
          {
            "text": "\t\t\t\tlabel: \"Workflow 3: Python Persistent State\",",
            "lineNumber": 65
          },
          {
            "text": "\t\t\t},",
            "lineNumber": 66
          },
          {
            "text": "\t\t\t{",
            "lineNumber": 67
          },
          {
            "text": "\t\t\t\tid: \"yellow-note1\",",
            "lineNumber": 68
          },
          {
            "text": "\t\t\t\ttype: \"text\",",
            "lineNumber": 69
          },
          {
            "text": "\t\t\t\ttext: \"Topic: Atomic notes\",",
            "lineNumber": 70
          },
          {
            "text": "\t\t\t\tx: 50,",
            "lineNumber": 71
          },
          {
            "text": "\t\t\t\ty: 680,",
            "lineNumber": 72
          },
          {
            "text": "\t\t\t\twidth: 200,",
            "lineNumber": 73
          },
          {
            "text": "\t\t\t\theight: 60,",
            "lineNumber": 74
          },
          {
            "text": "\t\t\t\tcolor: \"3\",",
            "lineNumber": 75
          },
          {
            "text": "\t\t\t},",
            "lineNumber": 76
          },
          {
            "text": "\t\t\t{",
            "lineNumber": 77
          },
          {
            "text": "\t\t\t\tid: \"blue-store1\",",
            "lineNumber": 78
          },
          {
            "text": "\t\t\t\ttype: \"text\",",
            "lineNumber": 79
          },
          {
            "text": "}",
            "lineNumber": 139,
            "isSignature": true
          }
        ]
      },
      "score": 0.20836913585662842
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 32,
            "column": 109
          }
        },
        "contents": "import type {App} from \"obsidian\";\nimport {Notice} from \"obsidian\";\nimport {\n\tEDGE_LABEL_OUTPUT,\n\tfindOutputNodeForSource,\n\tgetNodeById,\n\tgetNodeContent,\n\tgetNodeRole,\n\tgetIncomingEdgesWithLabels,\n\tgetParentIdsSortedByY,\n\tGREEN_NODE_PADDING,\n\tisOutputEdge,\n\tloadCanvasData,\n\tsaveCanvasData,\n} from \"../canvas/nodes\";\nimport type {AllCanvasNodeData, CanvasData, CanvasEdgeData, CanvasTextData} from \"../canvas/types\";\nimport { getTextNodeContent, parseEdgeVariableName } from \"../canvas/types\";\nimport {isTextNode} from \"../canvas/types\";\nimport type {LiveCanvas} from \"./canvasApi\";\nimport {getKernelForCanvas} from \"./kernelManager\";\nimport {ollamaGenerate} from \"./ollama\";\nimport {\n\tgetCanvasKey,\n\tgetNodeResult,\n\tsetNodeResult,\n\tsetEdgeModes,\n\tsetRunningNodeId,\n} from \"./state\";\nimport {DEFAULT_SETTINGS, type NodeRole, type ZettelPluginSettings} from \"../settings\";\n\ntype EdgeInputMode = \"inject\" | \"concatenate\";\n\n/** True if the role is non-AI (Python or text pass-through); prefer running these first for early output. */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "import type {App} from \"obsidian\";",
            "lineNumber": 1
          },
          {
            "text": "import {Notice} from \"obsidian\";",
            "lineNumber": 2
          },
          {
            "text": "import {",
            "lineNumber": 3
          },
          {
            "text": "\tEDGE_LABEL_OUTPUT,",
            "lineNumber": 4
          },
          {
            "text": "\tfindOutputNodeForSource,",
            "lineNumber": 5
          },
          {
            "text": "\tgetNodeById,",
            "lineNumber": 6
          },
          {
            "text": "\tgetNodeContent,",
            "lineNumber": 7
          },
          {
            "text": "\tgetNodeRole,",
            "lineNumber": 8
          },
          {
            "text": "\tgetIncomingEdgesWithLabels,",
            "lineNumber": 9
          },
          {
            "text": "\tgetParentIdsSortedByY,",
            "lineNumber": 10
          },
          {
            "text": "\tGREEN_NODE_PADDING,",
            "lineNumber": 11
          },
          {
            "text": "\tisOutputEdge,",
            "lineNumber": 12
          },
          {
            "text": "\tloadCanvasData,",
            "lineNumber": 13
          },
          {
            "text": "\tsaveCanvasData,",
            "lineNumber": 14
          },
          {
            "text": "} from \"../canvas/nodes\";",
            "lineNumber": 15
          },
          {
            "text": "import type {AllCanvasNodeData, CanvasData, CanvasEdgeData, CanvasTextData} from \"../canvas/types\";",
            "lineNumber": 16
          },
          {
            "text": "import { getTextNodeContent, parseEdgeVariableName } from \"../canvas/types\";",
            "lineNumber": 17
          },
          {
            "text": "import {isTextNode} from \"../canvas/types\";",
            "lineNumber": 18
          },
          {
            "text": "import type {LiveCanvas} from \"./canvasApi\";",
            "lineNumber": 19
          },
          {
            "text": "import {getKernelForCanvas} from \"./kernelManager\";",
            "lineNumber": 20
          },
          {
            "text": "import {ollamaGenerate} from \"./ollama\";",
            "lineNumber": 21
          },
          {
            "text": "import {",
            "lineNumber": 22
          },
          {
            "text": "\tgetCanvasKey,",
            "lineNumber": 23
          },
          {
            "text": "\tgetNodeResult,",
            "lineNumber": 24
          },
          {
            "text": "\tsetNodeResult,",
            "lineNumber": 25
          },
          {
            "text": "\tsetEdgeModes,",
            "lineNumber": 26
          },
          {
            "text": "\tsetRunningNodeId,",
            "lineNumber": 27
          },
          {
            "text": "} from \"./state\";",
            "lineNumber": 28
          },
          {
            "text": "import {DEFAULT_SETTINGS, type NodeRole, type ZettelPluginSettings} from \"../settings\";",
            "lineNumber": 29
          },
          {
            "lineNumber": 30
          },
          {
            "text": "type EdgeInputMode = \"inject\" | \"concatenate\";",
            "lineNumber": 31,
            "isSignature": true
          },
          {
            "lineNumber": 32
          },
          {
            "text": "/** True if the role is non-AI (Python or text pass-through); prefer running these first for early output. */",
            "lineNumber": 33
          }
        ]
      },
      "score": 0.20637786388397217
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 97
          },
          "endPosition": {
            "line": 315,
            "column": 93
          }
        },
        "contents": "function getTutorialCanvasData(settings: ZettelPluginSettings): CanvasData {\nconst nodes: CanvasData[\"nodes\"] = [\n 145),\n\t];\n\n\tconst edges: CanvasData[\"edges\"] = [\n\t\te(\"e-orange-out\", orangeNode, orangeOut, EDGE_LABEL_OUTPUT),\n\t\te(\"e-purple-out\", purpleNode, purpleOut, EDGE_LABEL_OUTPUT),\n\t\te(\"e-blue-out\", blueNode, blueOut, EDGE_LABEL_OUTPUT),\n\t\te(\"e-concat-comment-orange\", concatComment, concatOrange),\n\t\te(\"e-concat-out\", concatOrange, concatOut, EDGE_LABEL_OUTPUT),\n\t\te(\"e-inject-first-second\", injectFirst, injectSecond, \"reply\"),\n\t\te(\"e-inject-out\", injectSecond, injectOut, EDGE_LABEL_OUTPUT),\n\t];\n\n\treturn { nodes, edges };\n}\n\n/** Resolve canvas node id from context-menu payload (shape may vary by Obsidian version). */",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 98,
                "column": 1
              },
              "endPosition": {
                "line": 99,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "function getTutorialCanvasData(settings: ZettelPluginSettings): CanvasData {",
            "lineNumber": 98,
            "isSignature": true
          },
          {
            "text": "const nodes: CanvasData[\"nodes\"] = [",
            "lineNumber": 259
          },
          {
            "text": " 145),",
            "lineNumber": 300
          },
          {
            "text": "\t];",
            "lineNumber": 301
          },
          {
            "lineNumber": 302
          },
          {
            "text": "\tconst edges: CanvasData[\"edges\"] = [",
            "lineNumber": 303
          },
          {
            "text": "\t\te(\"e-orange-out\", orangeNode, orangeOut, EDGE_LABEL_OUTPUT),",
            "lineNumber": 304
          },
          {
            "text": "\t\te(\"e-purple-out\", purpleNode, purpleOut, EDGE_LABEL_OUTPUT),",
            "lineNumber": 305
          },
          {
            "text": "\t\te(\"e-blue-out\", blueNode, blueOut, EDGE_LABEL_OUTPUT),",
            "lineNumber": 306
          },
          {
            "text": "\t\te(\"e-concat-comment-orange\", concatComment, concatOrange),",
            "lineNumber": 307
          },
          {
            "text": "\t\te(\"e-concat-out\", concatOrange, concatOut, EDGE_LABEL_OUTPUT),",
            "lineNumber": 308
          },
          {
            "text": "\t\te(\"e-inject-first-second\", injectFirst, injectSecond, \"reply\"),",
            "lineNumber": 309
          },
          {
            "text": "\t\te(\"e-inject-out\", injectSecond, injectOut, EDGE_LABEL_OUTPUT),",
            "lineNumber": 310
          },
          {
            "text": "\t];",
            "lineNumber": 311
          },
          {
            "lineNumber": 312
          },
          {
            "text": "\treturn { nodes, edges };",
            "lineNumber": 313
          },
          {
            "text": "}",
            "lineNumber": 314,
            "isSignature": true
          },
          {
            "lineNumber": 315
          },
          {
            "text": "/** Resolve canvas node id from context-menu payload (shape may vary by Obsidian version). */",
            "lineNumber": 316
          }
        ]
      },
      "score": 0.20581020414829254
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/settings.ts",
        "range": {
          "startPosition": {
            "line": 512
          },
          "endPosition": {
            "line": 892,
            "column": 1
          }
        },
        "contents": "export class ZettelSettingTab extends PluginSettingTab {\ndisplay(): void {\n\");\n\n\t\tnew Setting(displaySection)\n\t\t\t.setName(\"Show role labels on canvas\")\n\t\t\t.setDesc(\"Show a floating label above each node (e.g. Model: llama2, Text, Python) based on its color\")\n\t\t\t.addToggle((toggle) =&gt; toggle\n\t\t\t\t.setValue(s.showNodeRoleLabels)\n\t\t\t\t.onChange(async (value) =&gt; {\n\t\t\t\t\tthis.plugin.settings.showNodeRoleLabels = value;\n\t\t\t\t\tawait this.plugin.saveSettings();\n\t\t\t\t}));\n\n\t\taddColorSetting(\n\t\t\tdisplaySection,\n\t\t\tthis.plugin,\n\t\t\t\"blue\",\n\t\t\t\"Python node color\",\n\t\t\t\"Color for Python execution nodes on the canvas\",\n\t\t\twarningCallback\n\t\t);\n\t\taddColorSetting(\n\t\t\tdisplaySection,\n\t\t\tthis.plugin,\n\t\t\t\"yellow\",\n\t\t\t\"Text node color\",\n\t\t\t\"Color for text (input) nodes: pass-through text, no AI processing\",\n\t\t\twarningCallback\n\t\t);\n\t\taddColorSetting(\n\t\t\tdisplaySection,\n\t\t\tthis.plugin,\n\t\t\t\"green\",\n\t\t\t\"Output node color\",\n\t\t\t\"Color for auto-generated output nodes on the canvas\",\n\t\t\twarningCallback\n\t\t);\n\n\t\t// Canvas Templates section\n\t\tconst templatesSection = containerEl.createDiv({ cls: \"ztb-settings-section\" });\n\t\ttemplatesSection.createEl(\"h4\", { text: \"Canvas Templates\", cls: \"ztb-section-title\" });\n\t\tconst templatesHint = templatesSection.createDiv({ cls: \"ztb-settings-hint setting-item-description\" });\n\t\ttemplatesHint.setText(\"Define folders for canvas templates and where new canvases from templates should be created. Use the \\\"Duplicate canvas template\\\" command to create a new canvas from a template.\");\n\n\t\tnew Setting(templatesSection)\n\t\t\t.setName(\"Template folder\")\n\t\t\t.setDesc(\"Folder containing canvas templates (e.g. Templates/Canvases). Leave empty to disable template feature.\")\n\t\t\t.addText((text) =&gt; text\n\t\t\t\t.setPlaceholder(\"Templates/Canvases\")\n\t\t\t\t.setValue(s.canvasTemplateFolder)\n\t\t\t\t.onChange(async (value) =&gt; {\n\t\t\t\t\ts.canvasTemplateFolder = value;\n\t\t\t\t\tawait this.plugin.saveSettings();\n\t\t\t\t}));\n\n\t\tnew Setting(templatesSection)\n\t\t\t.setName(\"Output folder\")\n\t\t\t.setDesc\n\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 513,
                "column": 1
              },
              "endPosition": {
                "line": 513,
                "column": 8
              }
            },
            {
              "startPosition": {
                "line": 513,
                "column": 8
              },
              "endPosition": {
                "line": 514,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 521,
                "column": 2
              },
              "endPosition": {
                "line": 522,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export class ZettelSettingTab extends PluginSettingTab {",
            "lineNumber": 513,
            "isSignature": true
          },
          {
            "text": "display(): void {",
            "lineNumber": 521
          },
          {
            "text": "\");",
            "lineNumber": 593
          },
          {
            "lineNumber": 594
          },
          {
            "text": "\t\tnew Setting(displaySection)",
            "lineNumber": 595
          },
          {
            "text": "\t\t\t.setName(\"Show role labels on canvas\")",
            "lineNumber": 596
          },
          {
            "text": "\t\t\t.setDesc(\"Show a floating label above each node (e.g. Model: llama2, Text, Python) based on its color\")",
            "lineNumber": 597
          },
          {
            "text": "\t\t\t.addToggle((toggle) =&gt; toggle",
            "lineNumber": 598
          },
          {
            "text": "\t\t\t\t.setValue(s.showNodeRoleLabels)",
            "lineNumber": 599
          },
          {
            "text": "\t\t\t\t.onChange(async (value) =&gt; {",
            "lineNumber": 600
          },
          {
            "text": "\t\t\t\t\tthis.plugin.settings.showNodeRoleLabels = value;",
            "lineNumber": 601
          },
          {
            "text": "\t\t\t\t\tawait this.plugin.saveSettings();",
            "lineNumber": 602
          },
          {
            "text": "\t\t\t\t}));",
            "lineNumber": 603
          },
          {
            "lineNumber": 604
          },
          {
            "text": "\t\taddColorSetting(",
            "lineNumber": 605
          },
          {
            "text": "\t\t\tdisplaySection,",
            "lineNumber": 606
          },
          {
            "text": "\t\t\tthis.plugin,",
            "lineNumber": 607
          },
          {
            "text": "\t\t\t\"blue\",",
            "lineNumber": 608
          },
          {
            "text": "\t\t\t\"Python node color\",",
            "lineNumber": 609
          },
          {
            "text": "\t\t\t\"Color for Python execution nodes on the canvas\",",
            "lineNumber": 610
          },
          {
            "text": "\t\t\twarningCallback",
            "lineNumber": 611
          },
          {
            "text": "\t\t);",
            "lineNumber": 612
          },
          {
            "text": "\t\taddColorSetting(",
            "lineNumber": 613
          },
          {
            "text": "\t\t\tdisplaySection,",
            "lineNumber": 614
          },
          {
            "text": "\t\t\tthis.plugin,",
            "lineNumber": 615
          },
          {
            "text": "\t\t\t\"yellow\",",
            "lineNumber": 616
          },
          {
            "text": "\t\t\t\"Text node color\",",
            "lineNumber": 617
          },
          {
            "text": "\t\t\t\"Color for text (input) nodes: pass-through text, no AI processing\",",
            "lineNumber": 618
          },
          {
            "text": "\t\t\twarningCallback",
            "lineNumber": 619
          },
          {
            "text": "\t\t);",
            "lineNumber": 620
          },
          {
            "text": "\t\taddColorSetting(",
            "lineNumber": 621
          },
          {
            "text": "\t\t\tdisplaySection,",
            "lineNumber": 622
          },
          {
            "text": "\t\t\tthis.plugin,",
            "lineNumber": 623
          },
          {
            "text": "\t\t\t\"green\",",
            "lineNumber": 624
          },
          {
            "text": "\t\t\t\"Output node color\",",
            "lineNumber": 625
          },
          {
            "text": "\t\t\t\"Color for auto-generated output nodes on the canvas\",",
            "lineNumber": 626
          },
          {
            "text": "\t\t\twarningCallback",
            "lineNumber": 627
          },
          {
            "text": "\t\t);",
            "lineNumber": 628
          },
          {
            "lineNumber": 629
          },
          {
            "text": "\t\t// Canvas Templates section",
            "lineNumber": 630
          },
          {
            "text": "\t\tconst templatesSection = containerEl.createDiv({ cls: \"ztb-settings-section\" });",
            "lineNumber": 631
          },
          {
            "text": "\t\ttemplatesSection.createEl(\"h4\", { text: \"Canvas Templates\", cls: \"ztb-section-title\" });",
            "lineNumber": 632
          },
          {
            "text": "\t\tconst templatesHint = templatesSection.createDiv({ cls: \"ztb-settings-hint setting-item-description\" });",
            "lineNumber": 633
          },
          {
            "text": "\t\ttemplatesHint.setText(\"Define folders for canvas templates and where new canvases from templates should be created. Use the \\\"Duplicate canvas template\\\" command to create a new canvas from a template.\");",
            "lineNumber": 634
          },
          {
            "lineNumber": 635
          },
          {
            "text": "\t\tnew Setting(templatesSection)",
            "lineNumber": 636
          },
          {
            "text": "\t\t\t.setName(\"Template folder\")",
            "lineNumber": 637
          },
          {
            "text": "\t\t\t.setDesc(\"Folder containing canvas templates (e.g. Templates/Canvases). Leave empty to disable template feature.\")",
            "lineNumber": 638
          },
          {
            "text": "\t\t\t.addText((text) =&gt; text",
            "lineNumber": 639
          },
          {
            "text": "\t\t\t\t.setPlaceholder(\"Templates/Canvases\")",
            "lineNumber": 640
          },
          {
            "text": "\t\t\t\t.setValue(s.canvasTemplateFolder)",
            "lineNumber": 641
          },
          {
            "text": "\t\t\t\t.onChange(async (value) =&gt; {",
            "lineNumber": 642
          },
          {
            "text": "\t\t\t\t\ts.canvasTemplateFolder = value;",
            "lineNumber": 643
          },
          {
            "text": "\t\t\t\t\tawait this.plugin.saveSettings();",
            "lineNumber": 644
          },
          {
            "text": "\t\t\t\t}));",
            "lineNumber": 645
          },
          {
            "lineNumber": 646
          },
          {
            "text": "\t\tnew Setting(templatesSection)",
            "lineNumber": 647
          },
          {
            "text": "\t\t\t.setName(\"Output folder\")",
            "lineNumber": 648
          },
          {
            "text": "\t\t\t.setDesc",
            "lineNumber": 649
          },
          {
            "lineNumber": 656
          },
          {
            "text": "\t}",
            "lineNumber": 657
          },
          {
            "text": "}",
            "lineNumber": 893,
            "isSignature": true
          }
        ]
      },
      "score": 0.20333099365234375
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 497,
            "column": 1
          },
          "endPosition": {
            "line": 532,
            "column": 93
          }
        },
        "contents": "/** Run a single node (for \"Run Node\" command). If parents are not run, runs chain to this node instead. */\nexport async function runNode(\n\tapp: App,\n\tsettings: ZettelPluginSettings,\n\tcanvasFilePath: string,\n\tnodeId: string,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;{ ok: boolean; message?: string }&gt; {\n\tconst data = await loadCanvasData(app.vault, canvasFilePath);\n\tif (!data) return { ok: false, message: \"Could not load canvas data.\" };\n\tconst node = getNodeById(data, nodeId);\n\tif (!node) return { ok: false, message: \"Node not found.\" };\n\tconst role = getNodeRole(node, settings);\n\tif (!role) return { ok: false, message: \"Node color is not mapped to a role.\" };\n\tif (role === \"green\") return { ok: false, message: \"Green nodes are output-only.\" };\n\tconst parentIds = getParentIdsSortedByY(nodeId, data);\n\tconst canvasKey = getCanvasKey(canvasFilePath);\n\tfor (const pid of parentIds) {\n\t\tif (getNodeResult(canvasKey, pid) == null) {\n\t\t\treturn runChain(app, settings, canvasFilePath, nodeId, liveCanvas);\n\t\t}\n\t}\n\ttry {\n\t\tsetRunningNodeId(canvasKey, nodeId);\n\t\tawait runSingleNode(app, settings, canvasKey, canvasFilePath, data, nodeId, liveCanvas);\n\t\treturn { ok: true };\n\t} catch (e) {\n\t\treturn { ok: false, message: e instanceof Error ? e.message : String(e) };\n\t} finally {\n\t\tsetRunningNodeId(canvasKey, null);\n\t}\n}\n\nconst CYCLE_ERROR_MESSAGE = \"Execution graph contains a cycle; fix connections and try again.\";",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Run a single node (for \"Run Node\" command). If parents are not run, runs chain to this node instead. */",
            "lineNumber": 500
          },
          {
            "text": "export async function runNode(",
            "lineNumber": 501,
            "isSignature": true
          },
          {
            "text": "\tapp: App,",
            "lineNumber": 502,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 503,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 504,
            "isSignature": true
          },
          {
            "text": "\tnodeId: string,",
            "lineNumber": 505,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 506,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;{ ok: boolean; message?: string }&gt; {",
            "lineNumber": 507,
            "isSignature": true
          },
          {
            "text": "\tconst data = await loadCanvasData(app.vault, canvasFilePath);",
            "lineNumber": 508
          },
          {
            "text": "\tif (!data) return { ok: false, message: \"Could not load canvas data.\" };",
            "lineNumber": 509
          },
          {
            "text": "\tconst node = getNodeById(data, nodeId);",
            "lineNumber": 510
          },
          {
            "text": "\tif (!node) return { ok: false, message: \"Node not found.\" };",
            "lineNumber": 511
          },
          {
            "text": "\tconst role = getNodeRole(node, settings);",
            "lineNumber": 512
          },
          {
            "text": "\tif (!role) return { ok: false, message: \"Node color is not mapped to a role.\" };",
            "lineNumber": 513
          },
          {
            "text": "\tif (role === \"green\") return { ok: false, message: \"Green nodes are output-only.\" };",
            "lineNumber": 514
          },
          {
            "text": "\tconst parentIds = getParentIdsSortedByY(nodeId, data);",
            "lineNumber": 515
          },
          {
            "text": "\tconst canvasKey = getCanvasKey(canvasFilePath);",
            "lineNumber": 516
          },
          {
            "text": "\tfor (const pid of parentIds) {",
            "lineNumber": 517
          },
          {
            "text": "\t\tif (getNodeResult(canvasKey, pid) == null) {",
            "lineNumber": 518
          },
          {
            "text": "\t\t\treturn runChain(app, settings, canvasFilePath, nodeId, liveCanvas);",
            "lineNumber": 519
          },
          {
            "text": "\t\t}",
            "lineNumber": 520
          },
          {
            "text": "\t}",
            "lineNumber": 521
          },
          {
            "text": "\ttry {",
            "lineNumber": 522
          },
          {
            "text": "\t\tsetRunningNodeId(canvasKey, nodeId);",
            "lineNumber": 523
          },
          {
            "text": "\t\tawait runSingleNode(app, settings, canvasKey, canvasFilePath, data, nodeId, liveCanvas);",
            "lineNumber": 524
          },
          {
            "text": "\t\treturn { ok: true };",
            "lineNumber": 525
          },
          {
            "text": "\t} catch (e) {",
            "lineNumber": 526
          },
          {
            "text": "\t\treturn { ok: false, message: e instanceof Error ? e.message : String(e) };",
            "lineNumber": 527
          },
          {
            "text": "\t} finally {",
            "lineNumber": 528
          },
          {
            "text": "\t\tsetRunningNodeId(canvasKey, null);",
            "lineNumber": 529
          },
          {
            "text": "\t}",
            "lineNumber": 530
          },
          {
            "text": "}",
            "lineNumber": 531,
            "isSignature": true
          },
          {
            "lineNumber": 532
          },
          {
            "text": "const CYCLE_ERROR_MESSAGE = \"Execution graph contains a cycle; fix connections and try again.\";",
            "lineNumber": 533
          }
        ]
      },
      "score": 0.20330774784088135
    }
  ]
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "output.*node|outputNode",
  "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board",
  "caseInsensitive": true
}
```
Result:

```json
{
  "success": {
    "pattern": "output.*node|outputNode",
    "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board": {
        "content": {
          "matches": [
            {
              "file": "./src/settings.ts",
              "matches": [
                {
                  "lineNumber": 45,
                  "content": "\tgreen: \"Output node\","
                },
                {
                  "lineNumber": 625,
                  "content": "\t\t\t\"Output node color\","
                },
                {
                  "lineNumber": 626,
                  "content": "\t\t\t\"Color for auto-generated output nodes on the canvas\","
                }
              ]
            },
            {
              "file": "./styles.css",
              "matches": [
                {
                  "lineNumber": 367,
                  "content": "/* Output edge (run node → green node): smaller, grayed label vs variable edges */"
                }
              ]
            },
            {
              "file": "./zettel-thinking-board/styles.css",
              "matches": [
                {
                  "lineNumber": 367,
                  "content": "/* Output edge (run node → green node): smaller, grayed label vs variable edges */"
                }
              ]
            },
            {
              "file": "./src/main.ts",
              "matches": [
                {
                  "lineNumber": 20,
                  "content": "import {hasOutputNodes, loadCanvasData, saveCanvasData} from \"./canvas/nodes\";"
                },
                {
                  "lineNumber": 299,
                  "content": "\t\tn(lab5, \"How to run: Right-click a node → Run node or Run chain. Right-click empty canvas → Run entire canvas or Dismiss all output. Title bar: ▶ Run entire canvas, 🗑 Dismiss all. Commands: Open Zettel Controls; Create tutorial canvas.\", commentLeftX(col5), y5, \"\", TUT_COMMENT_W + TUT_LANE_GAP + TUT_NODE_LANE_W, 195),"
                },
                {
                  "lineNumber": 429,
                  "content": "\t\t\t\t\titem.setTitle(\"Dismiss output\").setIcon(\"trash\").onClick(() =&gt; this.dismissOutput(nodeId))"
                },
                {
                  "lineNumber": 491,
                  "content": "\t\t\t// Also check for output nodes and remind user to dismiss them"
                },
                {
                  "lineNumber": 504,
                  "content": "\t\t\t\t\t\t\t// Canvas is being closed - check for output nodes"
                },
                {
                  "lineNumber": 507,
                  "content": "\t\t\t\t\t\t\t\tif (data &amp;&amp; hasOutputNodes(data)) {"
                },
                {
                  "lineNumber": 508,
                  "content": "\t\t\t\t\t\t\t\t\t// Show reminder about output nodes"
                },
                {
                  "lineNumber": 509,
                  "content": "\t\t\t\t\t\t\t\t\tnew Notice(\"Canvas has output nodes. Remember to use \\\"Dismiss all output\\\" if you want to clean up before closing.\", 5000);"
                },
                {
                  "lineNumber": 847,
                  "content": "\t/** Dismiss the Green output node for the given source node (call from context menu with node id). */"
                },
                {
                  "lineNumber": 848,
                  "content": "\tasync dismissOutput(nodeId: string): Promise&lt;void&gt; {"
                },
                {
                  "lineNumber": 852,
                  "content": "\t\tawait runnerDismissOutput(this.app.vault, view.file.path, nodeId, this.settings, liveCanvas);"
                },
                {
                  "lineNumber": 864,
                  "content": "\t/** Dismiss all output nodes on the canvas (call from canvas background context menu). */"
                }
              ]
            },
            {
              "file": "./src/engine/runner.ts",
              "matches": [
                {
                  "lineNumber": 5,
                  "content": "\tfindOutputNodeForSource,"
                },
                {
                  "lineNumber": 41,
                  "content": "\t\tdata.edges.filter((e) =&gt; !isOutputEdge(e)).map((e) =&gt; e.toNode)"
                },
                {
                  "lineNumber": 56,
                  "content": "\t\t\tif (!isOutputEdge(e) &amp;&amp; e.fromNode === id) stack.push(e.toNode);"
                },
                {
                  "lineNumber": 248,
                  "content": "\t// Always persist so output node/edge mutations from ensureOutputNodeAndEdge are saved"
                },
                {
                  "lineNumber": 305,
                  "content": "\t\tensureOutputNodeAndEdge(data, node, result, settings);"
                },
                {
                  "lineNumber": 319,
                  "content": "\t\tensureOutputNodeAndEdge(data, node, result, settings);"
                },
                {
                  "lineNumber": 333,
                  "content": "\t\tensureOutputNodeAndEdge(data, node, result, settings);"
                },
                {
                  "lineNumber": 342,
                  "content": "\t\tensureOutputNodeAndEdge(data, node, result, settings);"
                },
                {
                  "lineNumber": 357,
                  "content": "/** Min gap (px) between output box and other nodes; placement avoids coming within this distance. */"
                },
                {
                  "lineNumber": 372,
                  "content": "/** Choose (x, y) for the output box to avoid overlapping other nodes. Tries default position, then shifts horizontally, then downward. */"
                },
                {
                  "lineNumber": 426,
                  "content": "/** Create or replace the Green output node and ensure an edge labeled \"output\" from source. Mutates data only. */"
                },
                {
                  "lineNumber": 427,
                  "content": "function ensureOutputNodeAndEdge("
                },
                {
                  "lineNumber": 433,
                  "content": "\tconst outId = findOutputNodeForSource(data, sourceNode.id, settings);"
                },
                {
                  "lineNumber": 595,
                  "content": "/** Remove the Green output node and its output edge for a given source node; mutates data and saves. */"
                },
                {
                  "lineNumber": 605,
                  "content": "\tconst outId = findOutputNodeForSource(data, sourceNodeId, settings);"
                },
                {
                  "lineNumber": 617,
                  "content": "/** Remove all Green output nodes and their output edges on the canvas; mutates data and saves. */"
                },
                {
                  "lineNumber": 625,
                  "content": "\tconst outputNodeIds = new Set("
                },
                {
                  "lineNumber": 630,
                  "content": "\tdata.nodes = data.nodes.filter((n) =&gt; !outputNodeIds.has(n.id));"
                }
              ]
            },
            {
              "file": "./README.md",
              "matches": [
                {
                  "lineNumber": 9,
                  "content": "Unlike other canvas tools where the output sits *between* nodes, Zettel Thinking Board keeps your logic clean."
                },
                {
                  "lineNumber": 13,
                  "content": "*   **The Flow:** Data passes invisibly from parent to child. The Green Note is just for you to read; the Code node reads the raw data directly from the Prompt node. The &#96;output&#96; edge is reserved—Run Node and Run Chain ignore it (green notes are not part of the execution graph)."
                },
                {
                  "lineNumber": 24,
                  "content": "*   **Edge variable injection:** Put a **variable name** on an edge (edit the edge label). In the target note, use &#96;{{var:variableName}}&#96; to inject that parent's output at that spot instead of concatenating it. Edges update after run to show \"(injected)\" or \"(concatenated)\". The label **&#96;output&#96;** is reserved for the run node → green output note and is not a variable name; Run Node / Run Chain ignore output edges."
                },
                {
                  "lineNumber": 232,
                  "content": "- **Execution first, then display:** Settings are ordered as: what runs (models + Python path), then how it looks (colors for Python / Text / Output nodes and the \"Show role labels\" toggle)."
                },
                {
                  "lineNumber": 253,
                  "content": "*   **Output placement:** Green (output) nodes are placed below the source node with simple collision avoidance. In very dense layouts, the output note may still overlap existing nodes if no free slot is found in the search area."
                },
                {
                  "lineNumber": 264,
                  "content": "6. **Dismiss output** — Canvas with several Green output nodes; context menu \"Dismiss output\" and/or toolbar \"Dismiss all output\" (before/after). Use for README or settings/UX."
                }
              ]
            },
            {
              "file": "./PRD.md",
              "matches": [
                {
                  "lineNumber": 12,
                  "content": "*   **Logic over Layout:** Connections define the data flow (e.g., Prompt -&gt; Code). Visual outputs (Green nodes) are artifacts, not dependencies."
                },
                {
                  "lineNumber": 13,
                  "content": "*   **Invisible Data Passing:** Node A passes its result to Node B internally in memory, regardless of whether a visual output node exists."
                },
                {
                  "lineNumber": 31,
                  "content": "    *   **Connectivity:** An edge runs from the run node to the green output note, labeled **&#96;output&#96;**. This label is **reserved** (not a variable name). **Run Node** and **Run Chain** ignore edges labeled &#96;output&#96; when building the execution graph—green notes are not children and do not affect traversal."
                },
                {
                  "lineNumber": 34,
                  "content": "*   **Default behavior:** Parent outputs are concatenated in order, then &#96;---&#96; and the current node's content (or, for Blue nodes, parent context as system/input and node content as code)."
                },
                {
                  "lineNumber": 35,
                  "content": "*   **Variable name on edge:** The user may put a **variable name** on an edge (the edge's label in the canvas). This names the parent's output for the target node."
                },
                {
                  "lineNumber": 78,
                  "content": "*   **Context Menu:** Right-click on node -&gt; \"Run Node\", \"Run Chain\", \"Dismiss Output\" (Deletes the attached Green node)."
                }
              ]
            },
            {
              "file": "./src/canvas/nodes.ts",
              "matches": [
                {
                  "lineNumber": 62,
                  "content": "\tfindOutputNodeForSource,"
                },
                {
                  "lineNumber": 68,
                  "content": "\thasOutputNodes,"
                }
              ]
            },
            {
              "file": "./src/canvas/types.ts",
              "matches": [
                {
                  "lineNumber": 48,
                  "content": "/** True if edge is the reserved output edge (run node → green output note); ignored by execution. */"
                },
                {
                  "lineNumber": 118,
                  "content": "/** Fixed padding between source node and its Green output node (Part 1). */"
                },
                {
                  "lineNumber": 124,
                  "content": "/** Find the Green (output) node for a given source node. Edge-first (label \"output\"), then position fallback. */"
                },
                {
                  "lineNumber": 125,
                  "content": "export function findOutputNodeForSource("
                },
                {
                  "lineNumber": 133,
                  "content": "\tif (outputEdge) return outputEdge.toNode;"
                },
                {
                  "lineNumber": 157,
                  "content": "/** Check if canvas has any output nodes (green nodes connected by output edges). */"
                },
                {
                  "lineNumber": 158,
                  "content": "export function hasOutputNodes(data: CanvasData): boolean {"
                }
              ]
            },
            {
              "file": "./src/canvas/types.test.ts",
              "matches": [
                {
                  "lineNumber": 8,
                  "content": "\tfindOutputNodeForSource,"
                },
                {
                  "lineNumber": 78,
                  "content": "\t\texpect(isOutputEdge({ id: \"e\", fromNode: \"a\", toNode: \"b\", label: EDGE_LABEL_OUTPUT })).toBe(true);"
                },
                {
                  "lineNumber": 79,
                  "content": "\t\texpect(isOutputEdge({ id: \"e\", fromNode: \"a\", toNode: \"b\", label: \"  output  \" })).toBe(true);"
                },
                {
                  "lineNumber": 82,
                  "content": "\t\texpect(isOutputEdge({ id: \"e\", fromNode: \"a\", toNode: \"b\", label: \"age\" })).toBe(false);"
                },
                {
                  "lineNumber": 83,
                  "content": "\t\texpect(isOutputEdge({ id: \"e\", fromNode: \"a\", toNode: \"b\", label: \"summary (injected)\" })).toBe(false);"
                },
                {
                  "lineNumber": 86,
                  "content": "\t\texpect(isOutputEdge({ id: \"e\", fromNode: \"a\", toNode: \"b\" })).toBe(false);"
                },
                {
                  "lineNumber": 87,
                  "content": "\t\texpect(isOutputEdge({ id: \"e\", fromNode: \"a\", toNode: \"b\", label: \"\" })).toBe(false);"
                },
                {
                  "lineNumber": 191,
                  "content": "describe(\"findOutputNodeForSource\", () =&gt; {"
                },
                {
                  "lineNumber": 196,
                  "content": "\t\texpect(findOutputNodeForSource(data, \"missing\", settings)).toBeNull();"
                },
                {
                  "lineNumber": 208,
                  "content": "\t\texpect(findOutputNodeForSource(data, \"src\", settings)).toBe(\"out\");"
                },
                {
                  "lineNumber": 215,
                  "content": "\t\texpect(findOutputNodeForSource(data, \"src\", settings)).toBeNull();"
                },
                {
                  "lineNumber": 227,
                  "content": "\t\texpect(findOutputNodeForSource(data, \"src\", settings)).toBe(\"out\");"
                }
              ]
            }
          ],
          "totalLines": 68,
          "totalMatchedLines": 68
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "node.*position|setPosition|move.*node",
  "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board",
  "caseInsensitive": true
}
```
Result:

```json
{
  "success": {
    "pattern": "node.*position|setPosition|move.*node",
    "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board": {
        "content": {
          "matches": [
            {
              "file": "./src/canvas/canvasNodeLabels.ts",
              "matches": [
                {
                  "lineNumber": 172,
                  "content": "\t\t// Append after .canvas-node-container so it matches Obsidian file node label position"
                }
              ]
            },
            {
              "file": "./src/engine/runner.ts",
              "matches": [
                {
                  "lineNumber": 372,
                  "content": "/** Choose (x, y) for the output box to avoid overlapping other nodes. Tries default position, then shifts horizontally, then downward. */"
                },
                {
                  "lineNumber": 595,
                  "content": "/** Remove the Green output node and its output edge for a given source node; mutates data and saves. */"
                },
                {
                  "lineNumber": 617,
                  "content": "/** Remove all Green output nodes and their output edges on the canvas; mutates data and saves. */"
                }
              ]
            },
            {
              "file": "./src/canvas/types.ts",
              "matches": [
                {
                  "lineNumber": 124,
                  "content": "/** Find the Green (output) node for a given source node. Edge-first (label \"output\"), then position fallback. */"
                },
                {
                  "lineNumber": 145,
                  "content": "\t\tif (node.y &lt; expectedY - toleranceAbove || node.y &gt; expectedY + OUTPUT_POSITION_FALLBACK_MAX_Y) continue;"
                }
              ]
            },
            {
              "file": "./src/canvas/types.test.ts",
              "matches": [
                {
                  "lineNumber": 210,
                  "content": "\tit(\"returns null when no green node in expected position\", () =&gt; {"
                }
              ]
            },
            {
              "file": "./src/engine/state.test.ts",
              "matches": [
                {
                  "lineNumber": 43,
                  "content": "\tit(\"removes all node results for that canvas\", () =&gt; {"
                }
              ]
            },
            {
              "file": "./src/engine/canvasApi.ts",
              "matches": [
                {
                  "lineNumber": 1,
                  "content": "/** Minimal interface for live canvas mutations (add text node, remove node, save). */"
                },
                {
                  "lineNumber": 12,
                  "content": "\tremoveNode?(node: unknown): void;"
                }
              ]
            }
          ],
          "totalLines": 10,
          "totalMatchedLines": 10
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---





---

<tool-use data-tool-type="unknown" data-tool-name="semantic_search_full">
<details>
<summary>Tool use: **semantic_search_full**</summary>


Parameters:

```json
{
  "query": "Where does the canvas save node position after user drag or move?",
  "includePattern": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
  "topK": 10,
  "explanation": ""
}
```
Result:

```json
{
  "codeResults": [
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/canvasApi.ts",
        "range": {
          "startPosition": {
            "column": 86
          },
          "endPosition": {
            "line": 15,
            "column": 1
          }
        },
        "contents": "export interface LiveCanvas {\n\tcreateTextNode(options: {\n\t\ttext: string;\n\t\tpos: { x: number; y: number };\n\t\tsize: { width: number; height: number };\n\t\tsave?: boolean;\n\t\tfocus?: boolean;\n\t}): { id: string; x: number; y: number; width: number; height: number; moveTo: (pos: { x: number; y: number }) =&gt; void; resize: (size: { width: number; height: number }) =&gt; void };\n\taddNode(node: unknown): void;\n\trequestSave?: () =&gt; void;\n\tremoveNode?(node: unknown): void;\n\tnodes?: Map&lt;string, unknown&gt; | Iterable&lt;unknown&gt;;\n\t/** If present, used to refresh canvas after edge label updates (Obsidian canvas view). */\n\tsetData?(data: unknown): void;\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "export interface LiveCanvas {",
            "lineNumber": 2,
            "isSignature": true
          },
          {
            "text": "\tcreateTextNode(options: {",
            "lineNumber": 3
          },
          {
            "text": "\t\ttext: string;",
            "lineNumber": 4
          },
          {
            "text": "\t\tpos: { x: number; y: number };",
            "lineNumber": 5
          },
          {
            "text": "\t\tsize: { width: number; height: number };",
            "lineNumber": 6
          },
          {
            "text": "\t\tsave?: boolean;",
            "lineNumber": 7
          },
          {
            "text": "\t\tfocus?: boolean;",
            "lineNumber": 8
          },
          {
            "text": "\t}): { id: string; x: number; y: number; width: number; height: number; moveTo: (pos: { x: number; y: number }) =&gt; void; resize: (size: { width: number; height: number }) =&gt; void };",
            "lineNumber": 9
          },
          {
            "text": "\taddNode(node: unknown): void;",
            "lineNumber": 10
          },
          {
            "text": "\trequestSave?: () =&gt; void;",
            "lineNumber": 11
          },
          {
            "text": "\tremoveNode?(node: unknown): void;",
            "lineNumber": 12
          },
          {
            "text": "\tnodes?: Map&lt;string, unknown&gt; | Iterable&lt;unknown&gt;;",
            "lineNumber": 13
          },
          {
            "text": "\t/** If present, used to refresh canvas after edge label updates (Obsidian canvas view). */",
            "lineNumber": 14
          },
          {
            "text": "\tsetData?(data: unknown): void;",
            "lineNumber": 15,
            "isSignature": true
          },
          {
            "text": "}",
            "lineNumber": 16,
            "isSignature": true
          }
        ]
      },
      "score": 0.35972076654434204
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/nodes.ts",
        "range": {
          "startPosition": {
            "line": 23,
            "column": 1
          },
          "endPosition": {
            "line": 56,
            "column": 1
          }
        },
        "contents": "/** Save canvas data to vault (writes the canvas file). */\nexport async function saveCanvasData(vault: Vault, filePath: string, data: CanvasData): Promise&lt;boolean&gt; {\n\ttry {\n\t\tconst raw = JSON.stringify(data);\n\t\tawait vault.adapter.write(filePath, raw);\n\t\treturn true;\n\t} catch {\n\t\treturn false;\n\t}\n}\n\n/** Get input content for a node: text node content or full file content. */\nexport async function getNodeContent(\n\tnode: AllCanvasNodeData,\n\tvault: Vault\n): Promise&lt;string&gt; {\n\t\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Save canvas data to vault (writes the canvas file). */",
            "lineNumber": 26
          },
          {
            "text": "export async function saveCanvasData(vault: Vault, filePath: string, data: CanvasData): Promise&lt;boolean&gt; {",
            "lineNumber": 27,
            "isSignature": true
          },
          {
            "text": "\ttry {",
            "lineNumber": 28
          },
          {
            "text": "\t\tconst raw = JSON.stringify(data);",
            "lineNumber": 29
          },
          {
            "text": "\t\tawait vault.adapter.write(filePath, raw);",
            "lineNumber": 30
          },
          {
            "text": "\t\treturn true;",
            "lineNumber": 31
          },
          {
            "text": "\t} catch {",
            "lineNumber": 32
          },
          {
            "text": "\t\treturn false;",
            "lineNumber": 33
          },
          {
            "text": "\t}",
            "lineNumber": 34
          },
          {
            "text": "}",
            "lineNumber": 35,
            "isSignature": true
          },
          {
            "lineNumber": 36
          },
          {
            "text": "/** Get input content for a node: text node content or full file content. */",
            "lineNumber": 37
          },
          {
            "text": "export async function getNodeContent(",
            "lineNumber": 38,
            "isSignature": true
          },
          {
            "text": "\tnode: AllCanvasNodeData,",
            "lineNumber": 39,
            "isSignature": true
          },
          {
            "text": "\tvault: Vault",
            "lineNumber": 40,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;string&gt; {",
            "lineNumber": 41,
            "isSignature": true
          },
          {
            "text": "\t",
            "lineNumber": 42
          },
          {
            "text": "}",
            "lineNumber": 57,
            "isSignature": true
          }
        ]
      },
      "score": 0.32229459285736084
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 220,
            "column": 1
          },
          "endPosition": {
            "line": 253,
            "column": 117
          }
        },
        "contents": "/** Persist only base variable name in edge.label; store inject/concatenate in state for floating label. */\nasync function updateEdgeLabelsAndSave(\n\tvault: App[\"vault\"],\n\tcanvasFilePath: string,\n\tdata: CanvasData,\n\tnodeId: string,\n\tedgeModes: Map&lt;string, EdgeInputMode&gt;,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;void&gt; {\n\tconst canvasKey = getCanvasKey(canvasFilePath);\n\tsetEdgeModes(canvasKey, edgeModes);\n\tlet changed = false;\n\tfor (const edge of data.edges) {\n\t\tif (edge.toNode !== nodeId) continue;\n\t\tif (isOutputEdge(edge)) continue;\n\t\tconst mode = edgeModes.get(edge.id);\n\t\tif (mode == null) continue;\n\t\tconst baseName = parseEdgeVariableName(edge.label);\n\t\tif (baseName.length === 0) continue;\n\t\t// Keep only the variable name in the stored label so the user can edit it without touching (injected)/(concatenated)\n\t\tif (edge.label !== baseName) {\n\t\t\tedge.label = baseName;\n\t\t\tchanged = true;\n\t\t}\n\t}\n\t// Always persist so output node/edge mutations from ensureOutputNodeAndEdge are saved\n\tliveCanvas?.setData?.(data);\n\tconst saved = await saveCanvasData(vault, canvasFilePath, data);\n\tif (!saved) new Notice(\"Failed to save canvas.\");\n}\n\n/** Run a single node: get input + parent context (concatenate or {{var:name}}), call LLM or Python, store result. */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Persist only base variable name in edge.label; store inject/concatenate in state for floating label. */",
            "lineNumber": 223
          },
          {
            "text": "async function updateEdgeLabelsAndSave(",
            "lineNumber": 224,
            "isSignature": true
          },
          {
            "text": "\tvault: App[\"vault\"],",
            "lineNumber": 225,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 226,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 227,
            "isSignature": true
          },
          {
            "text": "\tnodeId: string,",
            "lineNumber": 228,
            "isSignature": true
          },
          {
            "text": "\tedgeModes: Map&lt;string, EdgeInputMode&gt;,",
            "lineNumber": 229,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 230,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;void&gt; {",
            "lineNumber": 231,
            "isSignature": true
          },
          {
            "text": "\tconst canvasKey = getCanvasKey(canvasFilePath);",
            "lineNumber": 232
          },
          {
            "text": "\tsetEdgeModes(canvasKey, edgeModes);",
            "lineNumber": 233
          },
          {
            "text": "\tlet changed = false;",
            "lineNumber": 234
          },
          {
            "text": "\tfor (const edge of data.edges) {",
            "lineNumber": 235
          },
          {
            "text": "\t\tif (edge.toNode !== nodeId) continue;",
            "lineNumber": 236
          },
          {
            "text": "\t\tif (isOutputEdge(edge)) continue;",
            "lineNumber": 237
          },
          {
            "text": "\t\tconst mode = edgeModes.get(edge.id);",
            "lineNumber": 238
          },
          {
            "text": "\t\tif (mode == null) continue;",
            "lineNumber": 239
          },
          {
            "text": "\t\tconst baseName = parseEdgeVariableName(edge.label);",
            "lineNumber": 240
          },
          {
            "text": "\t\tif (baseName.length === 0) continue;",
            "lineNumber": 241
          },
          {
            "text": "\t\t// Keep only the variable name in the stored label so the user can edit it without touching (injected)/(concatenated)",
            "lineNumber": 242
          },
          {
            "text": "\t\tif (edge.label !== baseName) {",
            "lineNumber": 243
          },
          {
            "text": "\t\t\tedge.label = baseName;",
            "lineNumber": 244
          },
          {
            "text": "\t\t\tchanged = true;",
            "lineNumber": 245
          },
          {
            "text": "\t\t}",
            "lineNumber": 246
          },
          {
            "text": "\t}",
            "lineNumber": 247
          },
          {
            "text": "\t// Always persist so output node/edge mutations from ensureOutputNodeAndEdge are saved",
            "lineNumber": 248
          },
          {
            "text": "\tliveCanvas?.setData?.(data);",
            "lineNumber": 249
          },
          {
            "text": "\tconst saved = await saveCanvasData(vault, canvasFilePath, data);",
            "lineNumber": 250
          },
          {
            "text": "\tif (!saved) new Notice(\"Failed to save canvas.\");",
            "lineNumber": 251
          },
          {
            "text": "}",
            "lineNumber": 252,
            "isSignature": true
          },
          {
            "lineNumber": 253
          },
          {
            "text": "/** Run a single node: get input + parent context (concatenate or {{var:name}}), call LLM or Python, store result. */",
            "lineNumber": 254
          }
        ]
      },
      "score": 0.2940365970134735
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 497,
            "column": 1
          },
          "endPosition": {
            "line": 532,
            "column": 93
          }
        },
        "contents": "/** Run a single node (for \"Run Node\" command). If parents are not run, runs chain to this node instead. */\nexport async function runNode(\n\tapp: App,\n\tsettings: ZettelPluginSettings,\n\tcanvasFilePath: string,\n\tnodeId: string,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;{ ok: boolean; message?: string }&gt; {\n\tconst data = await loadCanvasData(app.vault, canvasFilePath);\n\tif (!data) return { ok: false, message: \"Could not load canvas data.\" };\n\tconst node = getNodeById(data, nodeId);\n\tif (!node) return { ok: false, message: \"Node not found.\" };\n\tconst role = getNodeRole(node, settings);\n\tif (!role) return { ok: false, message: \"Node color is not mapped to a role.\" };\n\tif (role === \"green\") return { ok: false, message: \"Green nodes are output-only.\" };\n\tconst parentIds = getParentIdsSortedByY(nodeId, data);\n\tconst canvasKey = getCanvasKey(canvasFilePath);\n\tfor (const pid of parentIds) {\n\t\tif (getNodeResult(canvasKey, pid) == null) {\n\t\t\treturn runChain(app, settings, canvasFilePath, nodeId, liveCanvas);\n\t\t}\n\t}\n\ttry {\n\t\tsetRunningNodeId(canvasKey, nodeId);\n\t\tawait runSingleNode(app, settings, canvasKey, canvasFilePath, data, nodeId, liveCanvas);\n\t\treturn { ok: true };\n\t} catch (e) {\n\t\treturn { ok: false, message: e instanceof Error ? e.message : String(e) };\n\t} finally {\n\t\tsetRunningNodeId(canvasKey, null);\n\t}\n}\n\nconst CYCLE_ERROR_MESSAGE = \"Execution graph contains a cycle; fix connections and try again.\";",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Run a single node (for \"Run Node\" command). If parents are not run, runs chain to this node instead. */",
            "lineNumber": 500
          },
          {
            "text": "export async function runNode(",
            "lineNumber": 501,
            "isSignature": true
          },
          {
            "text": "\tapp: App,",
            "lineNumber": 502,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 503,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 504,
            "isSignature": true
          },
          {
            "text": "\tnodeId: string,",
            "lineNumber": 505,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 506,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;{ ok: boolean; message?: string }&gt; {",
            "lineNumber": 507,
            "isSignature": true
          },
          {
            "text": "\tconst data = await loadCanvasData(app.vault, canvasFilePath);",
            "lineNumber": 508
          },
          {
            "text": "\tif (!data) return { ok: false, message: \"Could not load canvas data.\" };",
            "lineNumber": 509
          },
          {
            "text": "\tconst node = getNodeById(data, nodeId);",
            "lineNumber": 510
          },
          {
            "text": "\tif (!node) return { ok: false, message: \"Node not found.\" };",
            "lineNumber": 511
          },
          {
            "text": "\tconst role = getNodeRole(node, settings);",
            "lineNumber": 512
          },
          {
            "text": "\tif (!role) return { ok: false, message: \"Node color is not mapped to a role.\" };",
            "lineNumber": 513
          },
          {
            "text": "\tif (role === \"green\") return { ok: false, message: \"Green nodes are output-only.\" };",
            "lineNumber": 514
          },
          {
            "text": "\tconst parentIds = getParentIdsSortedByY(nodeId, data);",
            "lineNumber": 515
          },
          {
            "text": "\tconst canvasKey = getCanvasKey(canvasFilePath);",
            "lineNumber": 516
          },
          {
            "text": "\tfor (const pid of parentIds) {",
            "lineNumber": 517
          },
          {
            "text": "\t\tif (getNodeResult(canvasKey, pid) == null) {",
            "lineNumber": 518
          },
          {
            "text": "\t\t\treturn runChain(app, settings, canvasFilePath, nodeId, liveCanvas);",
            "lineNumber": 519
          },
          {
            "text": "\t\t}",
            "lineNumber": 520
          },
          {
            "text": "\t}",
            "lineNumber": 521
          },
          {
            "text": "\ttry {",
            "lineNumber": 522
          },
          {
            "text": "\t\tsetRunningNodeId(canvasKey, nodeId);",
            "lineNumber": 523
          },
          {
            "text": "\t\tawait runSingleNode(app, settings, canvasKey, canvasFilePath, data, nodeId, liveCanvas);",
            "lineNumber": 524
          },
          {
            "text": "\t\treturn { ok: true };",
            "lineNumber": 525
          },
          {
            "text": "\t} catch (e) {",
            "lineNumber": 526
          },
          {
            "text": "\t\treturn { ok: false, message: e instanceof Error ? e.message : String(e) };",
            "lineNumber": 527
          },
          {
            "text": "\t} finally {",
            "lineNumber": 528
          },
          {
            "text": "\t\tsetRunningNodeId(canvasKey, null);",
            "lineNumber": 529
          },
          {
            "text": "\t}",
            "lineNumber": 530
          },
          {
            "text": "}",
            "lineNumber": 531,
            "isSignature": true
          },
          {
            "lineNumber": 532
          },
          {
            "text": "const CYCLE_ERROR_MESSAGE = \"Execution graph contains a cycle; fix connections and try again.\";",
            "lineNumber": 533
          }
        ]
      },
      "score": 0.28833436965942383
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/canvasNodeLabels.ts",
        "range": {
          "startPosition": {
            "line": 131,
            "column": 1
          },
          "endPosition": {
            "line": 180,
            "column": 1
          }
        },
        "contents": "/**\n * Sync floating role labels for the active canvas: for each node whose color maps to a role,\n * add a small label above the node (e.g. \"Text\", \"Python\"). Removes existing labels first.\n * Uses the live canvas node map to find each node's DOM element (.canvas-node).\n * @param isStillActive - if provided, called after async load; when false we skip applying to avoid stale canvas\n */\nexport async function syncCanvasRoleLabels(\n\tvault: Vault,\n\tcanvasFilePath: string,\n\tcontainerEl: HTMLElement,\n\tsettings: ZettelPluginSettings,\n\tcanvas: LiveCanvas | null,\n\tisStillActive?: () =&gt; boolean\n): Promise&lt;void&gt; {\n\tif (!settings.showNodeRoleLabels) {\n\t\tclearCanvasRoleLabels(containerEl);\n\t\tclearCanvasLegend(containerEl);\n\t\treturn;\n\t}\n\tconst data = await loadCanvasData(vault, canvasFilePath);\n\tif (isStillActive &amp;&amp; !isStillActive()) return;\n\tif (!data?.nodes) {\n\t\tclearCanvasRoleLabels(containerEl);\n\t\tclearCanvasLegend(containerEl);\n\t\treturn;\n\t}\n\t// Clear only after we have data so we never paint a frame with labels removed and nothing to show (avoids flicker).\n\tclearCanvasRoleLabels(containerEl);\n\tsyncCanvasLegend(containerEl, settings);\n\tfor (const node of data.nodes) {\n\t\tconst role = getNodeRole(node, settings);\n\t\tif (!role) continue;\n\t\tconst labelText = getRoleLabel(role, settings);\n\t\tconst nodeEl =\n\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, node.id)) ||\n\t\t\tfindNodeElementByDataId(containerEl, node.id);\n\t\tif (!nodeEl) continue;\n\t\tconst label = createLabelEl(labelText);\n\t\t// Append after .canvas-node-container so it matches Obsidian file node label position\n\t\tnodeEl.append(label);\n\t}\n}\n\n/** Get center of an element in viewport coordinates. */\nfunction getElCenter(el: HTMLElement): { x: number; y: number } {\n\tconst r = el.getBoundingClientRect();\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/**",
            "lineNumber": 134
          },
          {
            "text": " * Sync floating role labels for the active canvas: for each node whose color maps to a role,",
            "lineNumber": 135
          },
          {
            "text": " * add a small label above the node (e.g. \"Text\", \"Python\"). Removes existing labels first.",
            "lineNumber": 136
          },
          {
            "text": " * Uses the live canvas node map to find each node's DOM element (.canvas-node).",
            "lineNumber": 137
          },
          {
            "text": " * @param isStillActive - if provided, called after async load; when false we skip applying to avoid stale canvas",
            "lineNumber": 138
          },
          {
            "text": " */",
            "lineNumber": 139
          },
          {
            "text": "export async function syncCanvasRoleLabels(",
            "lineNumber": 140,
            "isSignature": true
          },
          {
            "text": "\tvault: Vault,",
            "lineNumber": 141,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 142,
            "isSignature": true
          },
          {
            "text": "\tcontainerEl: HTMLElement,",
            "lineNumber": 143,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 144,
            "isSignature": true
          },
          {
            "text": "\tcanvas: LiveCanvas | null,",
            "lineNumber": 145,
            "isSignature": true
          },
          {
            "text": "\tisStillActive?: () =&gt; boolean",
            "lineNumber": 146,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;void&gt; {",
            "lineNumber": 147,
            "isSignature": true
          },
          {
            "text": "\tif (!settings.showNodeRoleLabels) {",
            "lineNumber": 148
          },
          {
            "text": "\t\tclearCanvasRoleLabels(containerEl);",
            "lineNumber": 149
          },
          {
            "text": "\t\tclearCanvasLegend(containerEl);",
            "lineNumber": 150
          },
          {
            "text": "\t\treturn;",
            "lineNumber": 151
          },
          {
            "text": "\t}",
            "lineNumber": 152
          },
          {
            "text": "\tconst data = await loadCanvasData(vault, canvasFilePath);",
            "lineNumber": 153
          },
          {
            "text": "\tif (isStillActive &amp;&amp; !isStillActive()) return;",
            "lineNumber": 154
          },
          {
            "text": "\tif (!data?.nodes) {",
            "lineNumber": 155
          },
          {
            "text": "\t\tclearCanvasRoleLabels(containerEl);",
            "lineNumber": 156
          },
          {
            "text": "\t\tclearCanvasLegend(containerEl);",
            "lineNumber": 157
          },
          {
            "text": "\t\treturn;",
            "lineNumber": 158
          },
          {
            "text": "\t}",
            "lineNumber": 159
          },
          {
            "text": "\t// Clear only after we have data so we never paint a frame with labels removed and nothing to show (avoids flicker).",
            "lineNumber": 160
          },
          {
            "text": "\tclearCanvasRoleLabels(containerEl);",
            "lineNumber": 161
          },
          {
            "text": "\tsyncCanvasLegend(containerEl, settings);",
            "lineNumber": 162
          },
          {
            "text": "\tfor (const node of data.nodes) {",
            "lineNumber": 163
          },
          {
            "text": "\t\tconst role = getNodeRole(node, settings);",
            "lineNumber": 164
          },
          {
            "text": "\t\tif (!role) continue;",
            "lineNumber": 165
          },
          {
            "text": "\t\tconst labelText = getRoleLabel(role, settings);",
            "lineNumber": 166
          },
          {
            "text": "\t\tconst nodeEl =",
            "lineNumber": 167
          },
          {
            "text": "\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, node.id)) ||",
            "lineNumber": 168
          },
          {
            "text": "\t\t\tfindNodeElementByDataId(containerEl, node.id);",
            "lineNumber": 169
          },
          {
            "text": "\t\tif (!nodeEl) continue;",
            "lineNumber": 170
          },
          {
            "text": "\t\tconst label = createLabelEl(labelText);",
            "lineNumber": 171
          },
          {
            "text": "\t\t// Append after .canvas-node-container so it matches Obsidian file node label position",
            "lineNumber": 172
          },
          {
            "text": "\t\tnodeEl.append(label);",
            "lineNumber": 173
          },
          {
            "text": "\t}",
            "lineNumber": 174
          },
          {
            "text": "}",
            "lineNumber": 175,
            "isSignature": true
          },
          {
            "lineNumber": 176
          },
          {
            "text": "/** Get center of an element in viewport coordinates. */",
            "lineNumber": 177
          },
          {
            "text": "function getElCenter(el: HTMLElement): { x: number; y: number } {",
            "lineNumber": 178,
            "isSignature": true
          },
          {
            "text": "\tconst r = el.getBoundingClientRect();",
            "lineNumber": 179
          },
          {
            "text": "}",
            "lineNumber": 181,
            "isSignature": true
          }
        ]
      },
      "score": 0.28073275089263916
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 369,
            "column": 1
          },
          "endPosition": {
            "line": 415,
            "column": 1
          }
        },
        "contents": "/** Choose (x, y) for the output box to avoid overlapping other nodes. Tries default position, then shifts horizontally, then downward. */\nfunction chooseOutputPositionXY(\n\tdata: CanvasData,\n\tsourceNodeId: string,\n\toutNodeId: string | null,\n\tdefaultX: number,\n\tdefaultY: number,\n\twidth: number,\n\theight: number\n): { x: number; y: number } {\n\tconst excludeIds = new Set&lt;string&gt;([sourceNodeId]);\n\tif (outNodeId) excludeIds.add(outNodeId);\n\tconst box = { x: 0, y: 0, width, height };\n\tfunction tryPosition(x: number, y: number): boolean {\n\t\tbox.x = x;\n\t\tbox.y = y;\n\t\tfor (const node of data.nodes) {\n\t\t\tif (excludeIds.has(node.id)) continue;\n\t\t\t// Expand other node by buffer so we keep at least OUTPUT_COLLISION_BUFFER gap\n\t\t\tconst expanded = {\n\t\t\t\tx: node.x - OUTPUT_COLLISION_BUFFER,\n\t\t\t\ty: node.y - OUTPUT_COLLISION_BUFFER,\n\t\t\t\twidth: node.width + 2 * OUTPUT_COLLISION_BUFFER,\n\t\t\t\theight: node.height + 2 * OUTPUT_COLLISION_BUFFER,\n\t\t\t};\n\t\t\tif (rectanglesOverlap(box, expanded)) return false;\n\t\t}\n\t\treturn true;\n\t}\n\tfor (let dy = 0; dy &lt;= OUTPUT_COLLISION_MAX_VERTICAL; dy += OUTPUT_COLLISION_VERTICAL_STEP) {\n\t\tconst candidateY = defaultY + dy;\n\t\tfor (const dx of xOffsets()) {\n\t\t\tif (tryPosition(defaultX + dx, candidateY)) return { x: defaultX + dx, y: candidateY };\n\t\t}\n\t}\n\treturn { x: defaultX, y: defaultY };\n}\n\nfunction* xOffsets(): Generator&lt;number&gt; {\n\tyield 0;\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Choose (x, y) for the output box to avoid overlapping other nodes. Tries default position, then shifts horizontally, then downward. */",
            "lineNumber": 372
          },
          {
            "text": "function chooseOutputPositionXY(",
            "lineNumber": 373,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 374,
            "isSignature": true
          },
          {
            "text": "\tsourceNodeId: string,",
            "lineNumber": 375,
            "isSignature": true
          },
          {
            "text": "\toutNodeId: string | null,",
            "lineNumber": 376,
            "isSignature": true
          },
          {
            "text": "\tdefaultX: number,",
            "lineNumber": 377,
            "isSignature": true
          },
          {
            "text": "\tdefaultY: number,",
            "lineNumber": 378,
            "isSignature": true
          },
          {
            "text": "\twidth: number,",
            "lineNumber": 379,
            "isSignature": true
          },
          {
            "text": "\theight: number",
            "lineNumber": 380,
            "isSignature": true
          },
          {
            "text": "): { x: number; y: number } {",
            "lineNumber": 381,
            "isSignature": true
          },
          {
            "text": "\tconst excludeIds = new Set&lt;string&gt;([sourceNodeId]);",
            "lineNumber": 382
          },
          {
            "text": "\tif (outNodeId) excludeIds.add(outNodeId);",
            "lineNumber": 383
          },
          {
            "text": "\tconst box = { x: 0, y: 0, width, height };",
            "lineNumber": 384
          },
          {
            "text": "\tfunction tryPosition(x: number, y: number): boolean {",
            "lineNumber": 385,
            "isSignature": true
          },
          {
            "text": "\t\tbox.x = x;",
            "lineNumber": 386
          },
          {
            "text": "\t\tbox.y = y;",
            "lineNumber": 387
          },
          {
            "text": "\t\tfor (const node of data.nodes) {",
            "lineNumber": 388
          },
          {
            "text": "\t\t\tif (excludeIds.has(node.id)) continue;",
            "lineNumber": 389
          },
          {
            "text": "\t\t\t// Expand other node by buffer so we keep at least OUTPUT_COLLISION_BUFFER gap",
            "lineNumber": 390
          },
          {
            "text": "\t\t\tconst expanded = {",
            "lineNumber": 391
          },
          {
            "text": "\t\t\t\tx: node.x - OUTPUT_COLLISION_BUFFER,",
            "lineNumber": 392
          },
          {
            "text": "\t\t\t\ty: node.y - OUTPUT_COLLISION_BUFFER,",
            "lineNumber": 393
          },
          {
            "text": "\t\t\t\twidth: node.width + 2 * OUTPUT_COLLISION_BUFFER,",
            "lineNumber": 394
          },
          {
            "text": "\t\t\t\theight: node.height + 2 * OUTPUT_COLLISION_BUFFER,",
            "lineNumber": 395
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 396
          },
          {
            "text": "\t\t\tif (rectanglesOverlap(box, expanded)) return false;",
            "lineNumber": 397
          },
          {
            "text": "\t\t}",
            "lineNumber": 398
          },
          {
            "text": "\t\treturn true;",
            "lineNumber": 399
          },
          {
            "text": "\t}",
            "lineNumber": 400,
            "isSignature": true
          },
          {
            "text": "\tfor (let dy = 0; dy &lt;= OUTPUT_COLLISION_MAX_VERTICAL; dy += OUTPUT_COLLISION_VERTICAL_STEP) {",
            "lineNumber": 401
          },
          {
            "text": "\t\tconst candidateY = defaultY + dy;",
            "lineNumber": 402
          },
          {
            "text": "\t\tfor (const dx of xOffsets()) {",
            "lineNumber": 403
          },
          {
            "text": "\t\t\tif (tryPosition(defaultX + dx, candidateY)) return { x: defaultX + dx, y: candidateY };",
            "lineNumber": 404
          },
          {
            "text": "\t\t}",
            "lineNumber": 405
          },
          {
            "text": "\t}",
            "lineNumber": 406
          },
          {
            "text": "\treturn { x: defaultX, y: defaultY };",
            "lineNumber": 407
          },
          {
            "text": "}",
            "lineNumber": 408,
            "isSignature": true
          },
          {
            "lineNumber": 409
          },
          {
            "text": "function* xOffsets(): Generator&lt;number&gt; {",
            "lineNumber": 410,
            "isSignature": true
          },
          {
            "text": "\tyield 0;",
            "lineNumber": 411
          },
          {
            "text": "}",
            "lineNumber": 416,
            "isSignature": true
          }
        ]
      },
      "score": 0.28056836128234863
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/nodes.ts",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 34,
            "column": 1
          }
        },
        "contents": "import type {Vault} from \"obsidian\";\nimport type {AllCanvasNodeData, CanvasData, CanvasFileData, CanvasTextData} from \"obsidian/canvas\";\nimport {\n\tgetFileNodePath,\n\tgetNodeById,\n\tgetNodeRole,\n\tgetParentIdsSortedByY,\n\tgetTextNodeContent,\n\tisFileNode,\n\tisTextNode,\n} from \"./types\";\nimport type {ZettelPluginSettings} from \"../settings\";\n\n/** Load canvas data from vault by reading the canvas file (JSON). */\nexport async function loadCanvasData(vault: Vault, filePath: string): Promise&lt;CanvasData | null&gt; {\n\ttry {\n\t\tconst raw = await vault.adapter.read(filePath);\n\t\tconst data = JSON.parse(raw) as CanvasData;\n\t\tif (data &amp;&amp; Array.isArray(data.nodes) &amp;&amp; Array.isArray(data.edges)) return data;\n\t} catch {\n\t\t// ignore\n\t}\n\treturn null;\n}\n\n/** Save canvas data to vault (writes the canvas file). */\nexport async function saveCanvasData(vault: Vault, filePath: string, data: CanvasData): Promise&lt;boolean&gt; {\n\t\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "import type {Vault} from \"obsidian\";",
            "lineNumber": 1
          },
          {
            "text": "import type {AllCanvasNodeData, CanvasData, CanvasFileData, CanvasTextData} from \"obsidian/canvas\";",
            "lineNumber": 2
          },
          {
            "text": "import {",
            "lineNumber": 3
          },
          {
            "text": "\tgetFileNodePath,",
            "lineNumber": 4
          },
          {
            "text": "\tgetNodeById,",
            "lineNumber": 5
          },
          {
            "text": "\tgetNodeRole,",
            "lineNumber": 6
          },
          {
            "text": "\tgetParentIdsSortedByY,",
            "lineNumber": 7
          },
          {
            "text": "\tgetTextNodeContent,",
            "lineNumber": 8
          },
          {
            "text": "\tisFileNode,",
            "lineNumber": 9
          },
          {
            "text": "\tisTextNode,",
            "lineNumber": 10
          },
          {
            "text": "} from \"./types\";",
            "lineNumber": 11
          },
          {
            "text": "import type {ZettelPluginSettings} from \"../settings\";",
            "lineNumber": 12
          },
          {
            "lineNumber": 13
          },
          {
            "text": "/** Load canvas data from vault by reading the canvas file (JSON). */",
            "lineNumber": 14
          },
          {
            "text": "export async function loadCanvasData(vault: Vault, filePath: string): Promise&lt;CanvasData | null&gt; {",
            "lineNumber": 15,
            "isSignature": true
          },
          {
            "text": "\ttry {",
            "lineNumber": 16
          },
          {
            "text": "\t\tconst raw = await vault.adapter.read(filePath);",
            "lineNumber": 17
          },
          {
            "text": "\t\tconst data = JSON.parse(raw) as CanvasData;",
            "lineNumber": 18
          },
          {
            "text": "\t\tif (data &amp;&amp; Array.isArray(data.nodes) &amp;&amp; Array.isArray(data.edges)) return data;",
            "lineNumber": 19
          },
          {
            "text": "\t} catch {",
            "lineNumber": 20
          },
          {
            "text": "\t\t// ignore",
            "lineNumber": 21
          },
          {
            "text": "\t}",
            "lineNumber": 22
          },
          {
            "text": "\treturn null;",
            "lineNumber": 23
          },
          {
            "text": "}",
            "lineNumber": 24,
            "isSignature": true
          },
          {
            "lineNumber": 25
          },
          {
            "text": "/** Save canvas data to vault (writes the canvas file). */",
            "lineNumber": 26
          },
          {
            "text": "export async function saveCanvasData(vault: Vault, filePath: string, data: CanvasData): Promise&lt;boolean&gt; {",
            "lineNumber": 27,
            "isSignature": true
          },
          {
            "text": "\t",
            "lineNumber": 28
          },
          {
            "text": "}",
            "lineNumber": 35,
            "isSignature": true
          }
        ]
      },
      "score": 0.2757878303527832
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 329
          },
          "endPosition": {
            "line": 877,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\nasync onload() {\n // Track which paths we've warned about\n\t\t\tthis.registerEvent(\n\t\t\t\tthis.app.workspace.on(\"layout-change\", async () =&gt; {\n\t\t\t\t\tconst leaves = this.app.workspace.getLeavesOfType(\"canvas\");\n\t\t\t\t\tconst openPaths = new Set&lt;string&gt;();\n\t\t\t\t\tfor (const leaf of leaves) {\n\t\t\t\t\t\tconst v = leaf.view as { file?: { path: string } };\n\t\t\t\t\t\tif (v?.file?.path) openPaths.add(v.file.path);\n\t\t\t\t\t}\n\t\t\t\t\tfor (const path of previousCanvasPaths) {\n\t\t\t\t\t\tif (!openPaths.has(path)) {\n\t\t\t\t\t\t\t// Canvas is being closed - check for output nodes\n\t\t\t\t\t\t\tif (!hasShownOutputWarningForPath.has(path)) {\n\t\t\t\t\t\t\t\tconst data = await loadCanvasData(this.app.vault, path);\n\t\t\t\t\t\t\t\tif (data &amp;&amp; hasOutputNodes(data)) {\n\t\t\t\t\t\t\t\t\t// Show reminder about output nodes\n\t\t\t\t\t\t\t\t\tnew Notice(\"Canvas has output nodes. Remember to use \\\"Dismiss all output\\\" if you want to clean up before closing.\", 5000);\n\t\t\t\t\t\t\t\t\thasShownOutputWarningForPath.add(path);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t// Terminate kernel\n\t\t\t\t\t\t\tterminateKernel(path);\n\t\t\t\t\t\t\t// Clear warning flag after a delay (canvas might be reopened)\n\t\t\t\t\t\t\tsetTimeout(() =&gt; {\n\t\t\t\t\t\t\t\thasShownOutputWarningForPath.delete(path);\n\t\t\t\t\t\t\t}, 60000); // Clear after 1 minute\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tpreviousCanvasPaths = openPaths;\n\t\t\t\t})\n\t\t\t);\n\n\t\t\t// Floating role labels on canvas: sync when active leaf is a canvas, clear when not\n\t\t\tlet roleLabelsContainerEl: HTMLElement | null = null;\n\t\t\tlet roleLabelsIntervalId: number | null = null;\n\t\t\tconst runSyncLabels = (): void =&gt; {\n\t\t\t\tconst view = this.getActiveCanvasView();\n;\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 330,
                "column": 1
              },
              "endPosition": {
                "line": 330,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 330,
                "column": 16
              },
              "endPosition": {
                "line": 331,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 333,
                "column": 2
              },
              "endPosition": {
                "line": 334,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 330,
            "isSignature": true
          },
          {
            "text": "async onload() {",
            "lineNumber": 333
          },
          {
            "text": " // Track which paths we've warned about",
            "lineNumber": 493
          },
          {
            "text": "\t\t\tthis.registerEvent(",
            "lineNumber": 494
          },
          {
            "text": "\t\t\t\tthis.app.workspace.on(\"layout-change\", async () =&gt; {",
            "lineNumber": 495
          },
          {
            "text": "\t\t\t\t\tconst leaves = this.app.workspace.getLeavesOfType(\"canvas\");",
            "lineNumber": 496
          },
          {
            "text": "\t\t\t\t\tconst openPaths = new Set&lt;string&gt;();",
            "lineNumber": 497
          },
          {
            "text": "\t\t\t\t\tfor (const leaf of leaves) {",
            "lineNumber": 498
          },
          {
            "text": "\t\t\t\t\t\tconst v = leaf.view as { file?: { path: string } };",
            "lineNumber": 499
          },
          {
            "text": "\t\t\t\t\t\tif (v?.file?.path) openPaths.add(v.file.path);",
            "lineNumber": 500
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 501
          },
          {
            "text": "\t\t\t\t\tfor (const path of previousCanvasPaths) {",
            "lineNumber": 502
          },
          {
            "text": "\t\t\t\t\t\tif (!openPaths.has(path)) {",
            "lineNumber": 503
          },
          {
            "text": "\t\t\t\t\t\t\t// Canvas is being closed - check for output nodes",
            "lineNumber": 504
          },
          {
            "text": "\t\t\t\t\t\t\tif (!hasShownOutputWarningForPath.has(path)) {",
            "lineNumber": 505
          },
          {
            "text": "\t\t\t\t\t\t\t\tconst data = await loadCanvasData(this.app.vault, path);",
            "lineNumber": 506
          },
          {
            "text": "\t\t\t\t\t\t\t\tif (data &amp;&amp; hasOutputNodes(data)) {",
            "lineNumber": 507
          },
          {
            "text": "\t\t\t\t\t\t\t\t\t// Show reminder about output nodes",
            "lineNumber": 508
          },
          {
            "text": "\t\t\t\t\t\t\t\t\tnew Notice(\"Canvas has output nodes. Remember to use \\\"Dismiss all output\\\" if you want to clean up before closing.\", 5000);",
            "lineNumber": 509
          },
          {
            "text": "\t\t\t\t\t\t\t\t\thasShownOutputWarningForPath.add(path);",
            "lineNumber": 510
          },
          {
            "text": "\t\t\t\t\t\t\t\t}",
            "lineNumber": 511
          },
          {
            "text": "\t\t\t\t\t\t\t}",
            "lineNumber": 512
          },
          {
            "text": "\t\t\t\t\t\t\t// Terminate kernel",
            "lineNumber": 513
          },
          {
            "text": "\t\t\t\t\t\t\tterminateKernel(path);",
            "lineNumber": 514
          },
          {
            "text": "\t\t\t\t\t\t\t// Clear warning flag after a delay (canvas might be reopened)",
            "lineNumber": 515
          },
          {
            "text": "\t\t\t\t\t\t\tsetTimeout(() =&gt; {",
            "lineNumber": 516
          },
          {
            "text": "\t\t\t\t\t\t\t\thasShownOutputWarningForPath.delete(path);",
            "lineNumber": 517
          },
          {
            "text": "\t\t\t\t\t\t\t}, 60000); // Clear after 1 minute",
            "lineNumber": 518
          },
          {
            "text": "\t\t\t\t\t\t}",
            "lineNumber": 519
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 520
          },
          {
            "text": "\t\t\t\t\tpreviousCanvasPaths = openPaths;",
            "lineNumber": 521
          },
          {
            "text": "\t\t\t\t})",
            "lineNumber": 522
          },
          {
            "text": "\t\t\t);",
            "lineNumber": 523
          },
          {
            "lineNumber": 524
          },
          {
            "text": "\t\t\t// Floating role labels on canvas: sync when active leaf is a canvas, clear when not",
            "lineNumber": 525
          },
          {
            "text": "\t\t\tlet roleLabelsContainerEl: HTMLElement | null = null;",
            "lineNumber": 526
          },
          {
            "text": "\t\t\tlet roleLabelsIntervalId: number | null = null;",
            "lineNumber": 527
          },
          {
            "text": "\t\t\tconst runSyncLabels = (): void =&gt; {",
            "lineNumber": 528
          },
          {
            "text": "\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 529
          },
          {
            "text": ";",
            "lineNumber": 588
          },
          {
            "text": "\t}",
            "lineNumber": 595
          },
          {
            "text": "}",
            "lineNumber": 878,
            "isSignature": true
          }
        ]
      },
      "score": 0.27296561002731323
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/canvasTemplates.ts",
        "range": {
          "startPosition": {
            "line": 46,
            "column": 1
          },
          "endPosition": {
            "line": 118,
            "column": 3
          }
        },
        "contents": "/**\n * Duplicate a canvas to a target folder.\n * Creates a new canvas file with a unique name and copies all nodes and edges.\n * Returns the path of the new canvas file, or null if failed.\n */\nasync function duplicateCanvasToFolder(\n\tvault: Vault,\n\tsourcePath: string,\n\ttargetFolder: string,\n\tbaseName?: string\n): Promise&lt;string | null&gt; {\n\t// Load the source canvas data\n\tconst sourceData = await loadCanvasData(vault, sourcePath);\n\tif (!sourceData) return null;\n\n\t// Determine the base name for the new canvas\n\tconst sourceFile = vault.getAbstractFileByPath(sourcePath);\n\tif (!sourceFile || !(sourceFile instanceof TFile)) return null;\n\n\tconst nameBase = baseName || sourceFile.basename;\n\n\t// Determine the output path\n\tconst targetFolderNormalized = targetFolder ? normalizePath(targetFolder) : \"\";\n\tlet outputPath: string;\n\tlet counter = 0;\n\n\t// Find a unique name\n\twhile (true) {\n\t\tconst fileName = counter === 0 ? &#96;${nameBase}.canvas&#96; : &#96;${nameBase} ${counter}.canvas&#96;;\n\t\toutputPath = targetFolderNormalized\n\t\t\t? normalizePath(&#96;${targetFolderNormalized}/${fileName}&#96;)\n\t\t\t: normalizePath(fileName);\n\n\t\tif (!vault.getAbstractFileByPath(outputPath)) break;\n\t\tcounter += 1;\n\n\t\t// Safety: prevent infinite loop\n\t\tif (counter &gt; 1000) return null;\n\t}\n\n\t// Ensure the target folder exists\n\tif (targetFolderNormalized) {\n\t\tconst folder = vault.getAbstractFileByPath(targetFolderNormalized);\n\t\tif (!folder) {\n\t\t\ttry {\n\t\t\t\tawait vault.createFolder(targetFolderNormalized);\n\t\t\t} catch (e) {\n\t\t\t\tconsole.error(\"Failed to create target folder:\", e);\n\t\t\t\treturn null;\n\t\t\t}\n\t\t}\n\t}\n\n\t// Create a deep copy of the canvas data to avoid mutation\n\tconst newCanvasData: CanvasData = {\n\t\tnodes: sourceData.nodes.map((node) =&gt; ({ ...node })),\n\t\tedges: sourceData.edges.map((edge) =&gt; ({ ...edge })),\n\t};\n\n\t// Save the new canvas\n\tconst success = await saveCanvasData(vault, outputPath, newCanvasData);\n\tif (!success) return null;\n\n\treturn outputPath;\n}\n\n/**\n * Duplicate a canvas template to the output folder.\n * Creates a new canvas file with a unique name and copies all nodes and edges.\n * Returns the path of the new canvas file, or null if failed.\n */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/**",
            "lineNumber": 49
          },
          {
            "text": " * Duplicate a canvas to a target folder.",
            "lineNumber": 50
          },
          {
            "text": " * Creates a new canvas file with a unique name and copies all nodes and edges.",
            "lineNumber": 51
          },
          {
            "text": " * Returns the path of the new canvas file, or null if failed.",
            "lineNumber": 52
          },
          {
            "text": " */",
            "lineNumber": 53
          },
          {
            "text": "async function duplicateCanvasToFolder(",
            "lineNumber": 54,
            "isSignature": true
          },
          {
            "text": "\tvault: Vault,",
            "lineNumber": 55,
            "isSignature": true
          },
          {
            "text": "\tsourcePath: string,",
            "lineNumber": 56,
            "isSignature": true
          },
          {
            "text": "\ttargetFolder: string,",
            "lineNumber": 57,
            "isSignature": true
          },
          {
            "text": "\tbaseName?: string",
            "lineNumber": 58,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;string | null&gt; {",
            "lineNumber": 59,
            "isSignature": true
          },
          {
            "text": "\t// Load the source canvas data",
            "lineNumber": 60
          },
          {
            "text": "\tconst sourceData = await loadCanvasData(vault, sourcePath);",
            "lineNumber": 61
          },
          {
            "text": "\tif (!sourceData) return null;",
            "lineNumber": 62
          },
          {
            "lineNumber": 63
          },
          {
            "text": "\t// Determine the base name for the new canvas",
            "lineNumber": 64
          },
          {
            "text": "\tconst sourceFile = vault.getAbstractFileByPath(sourcePath);",
            "lineNumber": 65
          },
          {
            "text": "\tif (!sourceFile || !(sourceFile instanceof TFile)) return null;",
            "lineNumber": 66
          },
          {
            "lineNumber": 67
          },
          {
            "text": "\tconst nameBase = baseName || sourceFile.basename;",
            "lineNumber": 68
          },
          {
            "lineNumber": 69
          },
          {
            "text": "\t// Determine the output path",
            "lineNumber": 70
          },
          {
            "text": "\tconst targetFolderNormalized = targetFolder ? normalizePath(targetFolder) : \"\";",
            "lineNumber": 71
          },
          {
            "text": "\tlet outputPath: string;",
            "lineNumber": 72
          },
          {
            "text": "\tlet counter = 0;",
            "lineNumber": 73
          },
          {
            "lineNumber": 74
          },
          {
            "text": "\t// Find a unique name",
            "lineNumber": 75
          },
          {
            "text": "\twhile (true) {",
            "lineNumber": 76
          },
          {
            "text": "\t\tconst fileName = counter === 0 ? &#96;${nameBase}.canvas&#96; : &#96;${nameBase} ${counter}.canvas&#96;;",
            "lineNumber": 77
          },
          {
            "text": "\t\toutputPath = targetFolderNormalized",
            "lineNumber": 78
          },
          {
            "text": "\t\t\t? normalizePath(&#96;${targetFolderNormalized}/${fileName}&#96;)",
            "lineNumber": 79
          },
          {
            "text": "\t\t\t: normalizePath(fileName);",
            "lineNumber": 80
          },
          {
            "lineNumber": 81
          },
          {
            "text": "\t\tif (!vault.getAbstractFileByPath(outputPath)) break;",
            "lineNumber": 82
          },
          {
            "text": "\t\tcounter += 1;",
            "lineNumber": 83
          },
          {
            "lineNumber": 84
          },
          {
            "text": "\t\t// Safety: prevent infinite loop",
            "lineNumber": 85
          },
          {
            "text": "\t\tif (counter &gt; 1000) return null;",
            "lineNumber": 86
          },
          {
            "text": "\t}",
            "lineNumber": 87
          },
          {
            "lineNumber": 88
          },
          {
            "text": "\t// Ensure the target folder exists",
            "lineNumber": 89
          },
          {
            "text": "\tif (targetFolderNormalized) {",
            "lineNumber": 90
          },
          {
            "text": "\t\tconst folder = vault.getAbstractFileByPath(targetFolderNormalized);",
            "lineNumber": 91
          },
          {
            "text": "\t\tif (!folder) {",
            "lineNumber": 92
          },
          {
            "text": "\t\t\ttry {",
            "lineNumber": 93
          },
          {
            "text": "\t\t\t\tawait vault.createFolder(targetFolderNormalized);",
            "lineNumber": 94
          },
          {
            "text": "\t\t\t} catch (e) {",
            "lineNumber": 95
          },
          {
            "text": "\t\t\t\tconsole.error(\"Failed to create target folder:\", e);",
            "lineNumber": 96
          },
          {
            "text": "\t\t\t\treturn null;",
            "lineNumber": 97
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 98
          },
          {
            "text": "\t\t}",
            "lineNumber": 99
          },
          {
            "text": "\t}",
            "lineNumber": 100
          },
          {
            "lineNumber": 101
          },
          {
            "text": "\t// Create a deep copy of the canvas data to avoid mutation",
            "lineNumber": 102
          },
          {
            "text": "\tconst newCanvasData: CanvasData = {",
            "lineNumber": 103
          },
          {
            "text": "\t\tnodes: sourceData.nodes.map((node) =&gt; ({ ...node })),",
            "lineNumber": 104
          },
          {
            "text": "\t\tedges: sourceData.edges.map((edge) =&gt; ({ ...edge })),",
            "lineNumber": 105
          },
          {
            "text": "\t};",
            "lineNumber": 106
          },
          {
            "lineNumber": 107
          },
          {
            "text": "\t// Save the new canvas",
            "lineNumber": 108
          },
          {
            "text": "\tconst success = await saveCanvasData(vault, outputPath, newCanvasData);",
            "lineNumber": 109
          },
          {
            "text": "\tif (!success) return null;",
            "lineNumber": 110
          },
          {
            "lineNumber": 111
          },
          {
            "text": "\treturn outputPath;",
            "lineNumber": 112
          },
          {
            "text": "}",
            "lineNumber": 113,
            "isSignature": true
          },
          {
            "lineNumber": 114
          },
          {
            "text": "/**",
            "lineNumber": 115
          },
          {
            "text": " * Duplicate a canvas template to the output folder.",
            "lineNumber": 116
          },
          {
            "text": " * Creates a new canvas file with a unique name and copies all nodes and edges.",
            "lineNumber": 117
          },
          {
            "text": " * Returns the path of the new canvas file, or null if failed.",
            "lineNumber": 118
          },
          {
            "text": " */",
            "lineNumber": 119
          }
        ]
      },
      "score": 0.26613783836364746
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 423,
            "column": 1
          },
          "endPosition": {
            "line": 499,
            "column": 107
          }
        },
        "contents": "/** Create or replace the Green output node and ensure an edge labeled \"output\" from source. Mutates data only. */\nfunction ensureOutputNodeAndEdge(\n\tdata: CanvasData,\n\tsourceNode: AllCanvasNodeData,\n\ttext: string,\n\tsettings: ZettelPluginSettings\n): void {\n\tconst outId = findOutputNodeForSource(data, sourceNode.id, settings);\n\tconst defaultY = sourceNode.y + sourceNode.height + GREEN_NODE_PADDING;\n\tconst width = Math.max(320, sourceNode.width);\n\tconst height = 180;\n\tconst defaultX = sourceNode.x;\n\tconst { x: chosenX, y: chosenY } = chooseOutputPositionXY(\n\t\tdata,\n\t\tsourceNode.id,\n\t\toutId,\n\t\tdefaultX,\n\t\tdefaultY,\n\t\twidth,\n\t\theight\n\t);\n\tconst greenColor = settings.colorGreen;\n\n\tif (outId) {\n\t\tconst outNode = getNodeById(data, outId);\n\t\tif (outNode &amp;&amp; isTextNode(outNode)) {\n\t\t\tconst updated = {\n\t\t\t\t...(outNode as CanvasTextData),\n\t\t\t\ttext,\n\t\t\t\tx: chosenX,\n\t\t\t\ty: chosenY,\n\t\t\t\twidth,\n\t\t\t\theight,\n\t\t\t};\n\t\t\tconst idx = data.nodes.findIndex((n) =&gt; n.id === outId);\n\t\t\tif (idx &gt;= 0) data.nodes[idx] = updated;\n\t\t} else if (outNode) {\n\t\t\t(outNode as { x: number; y: number }).x = chosenX;\n\t\t\t(outNode as { x: number; y: number }).y = chosenY;\n\t\t}\n\t\tconst hasOutputEdge = data.edges.some(\n\t\t\t(e) =&gt; e.fromNode === sourceNode.id &amp;&amp; e.toNode === outId &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT\n\t\t);\n\t\tif (!hasOutputEdge) {\n\t\t\tdata.edges.push({\n\t\t\t\tid: randomId(),\n\t\t\t\tfromNode: sourceNode.id,\n\t\t\t\ttoNode: outId,\n\t\t\t\tlabel: EDGE_LABEL_OUTPUT,\n\t\t\t});\n\t\t}\n\t\treturn;\n\t}\n\n\tconst newNodeId = randomId();\n\tconst newTextNode: CanvasTextData = {\n\t\tid: newNodeId,\n\t\ttype: \"text\",\n\t\ttext,\n\t\tx: chosenX,\n\t\ty: chosenY,\n\t\twidth,\n\t\theight,\n\t\tcolor: greenColor,\n\t};\n\tdata.nodes.push(newTextNode);\n\tdata.edges.push({\n\t\tid: randomId(),\n\t\tfromNode: sourceNode.id,\n\t\ttoNode: newNodeId,\n\t\tlabel: EDGE_LABEL_OUTPUT,\n\t});\n}\n\n/** Run a single node (for \"Run Node\" command). If parents are not run, runs chain to this node instead. */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Create or replace the Green output node and ensure an edge labeled \"output\" from source. Mutates data only. */",
            "lineNumber": 426
          },
          {
            "text": "function ensureOutputNodeAndEdge(",
            "lineNumber": 427,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 428,
            "isSignature": true
          },
          {
            "text": "\tsourceNode: AllCanvasNodeData,",
            "lineNumber": 429,
            "isSignature": true
          },
          {
            "text": "\ttext: string,",
            "lineNumber": 430,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings",
            "lineNumber": 431,
            "isSignature": true
          },
          {
            "text": "): void {",
            "lineNumber": 432,
            "isSignature": true
          },
          {
            "text": "\tconst outId = findOutputNodeForSource(data, sourceNode.id, settings);",
            "lineNumber": 433
          },
          {
            "text": "\tconst defaultY = sourceNode.y + sourceNode.height + GREEN_NODE_PADDING;",
            "lineNumber": 434
          },
          {
            "text": "\tconst width = Math.max(320, sourceNode.width);",
            "lineNumber": 435
          },
          {
            "text": "\tconst height = 180;",
            "lineNumber": 436
          },
          {
            "text": "\tconst defaultX = sourceNode.x;",
            "lineNumber": 437
          },
          {
            "text": "\tconst { x: chosenX, y: chosenY } = chooseOutputPositionXY(",
            "lineNumber": 438
          },
          {
            "text": "\t\tdata,",
            "lineNumber": 439
          },
          {
            "text": "\t\tsourceNode.id,",
            "lineNumber": 440
          },
          {
            "text": "\t\toutId,",
            "lineNumber": 441
          },
          {
            "text": "\t\tdefaultX,",
            "lineNumber": 442
          },
          {
            "text": "\t\tdefaultY,",
            "lineNumber": 443
          },
          {
            "text": "\t\twidth,",
            "lineNumber": 444
          },
          {
            "text": "\t\theight",
            "lineNumber": 445
          },
          {
            "text": "\t);",
            "lineNumber": 446
          },
          {
            "text": "\tconst greenColor = settings.colorGreen;",
            "lineNumber": 447
          },
          {
            "lineNumber": 448
          },
          {
            "text": "\tif (outId) {",
            "lineNumber": 449
          },
          {
            "text": "\t\tconst outNode = getNodeById(data, outId);",
            "lineNumber": 450
          },
          {
            "text": "\t\tif (outNode &amp;&amp; isTextNode(outNode)) {",
            "lineNumber": 451
          },
          {
            "text": "\t\t\tconst updated = {",
            "lineNumber": 452
          },
          {
            "text": "\t\t\t\t...(outNode as CanvasTextData),",
            "lineNumber": 453
          },
          {
            "text": "\t\t\t\ttext,",
            "lineNumber": 454
          },
          {
            "text": "\t\t\t\tx: chosenX,",
            "lineNumber": 455
          },
          {
            "text": "\t\t\t\ty: chosenY,",
            "lineNumber": 456
          },
          {
            "text": "\t\t\t\twidth,",
            "lineNumber": 457
          },
          {
            "text": "\t\t\t\theight,",
            "lineNumber": 458
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 459
          },
          {
            "text": "\t\t\tconst idx = data.nodes.findIndex((n) =&gt; n.id === outId);",
            "lineNumber": 460
          },
          {
            "text": "\t\t\tif (idx &gt;= 0) data.nodes[idx] = updated;",
            "lineNumber": 461
          },
          {
            "text": "\t\t} else if (outNode) {",
            "lineNumber": 462
          },
          {
            "text": "\t\t\t(outNode as { x: number; y: number }).x = chosenX;",
            "lineNumber": 463
          },
          {
            "text": "\t\t\t(outNode as { x: number; y: number }).y = chosenY;",
            "lineNumber": 464
          },
          {
            "text": "\t\t}",
            "lineNumber": 465
          },
          {
            "text": "\t\tconst hasOutputEdge = data.edges.some(",
            "lineNumber": 466
          },
          {
            "text": "\t\t\t(e) =&gt; e.fromNode === sourceNode.id &amp;&amp; e.toNode === outId &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT",
            "lineNumber": 467
          },
          {
            "text": "\t\t);",
            "lineNumber": 468
          },
          {
            "text": "\t\tif (!hasOutputEdge) {",
            "lineNumber": 469
          },
          {
            "text": "\t\t\tdata.edges.push({",
            "lineNumber": 470
          },
          {
            "text": "\t\t\t\tid: randomId(),",
            "lineNumber": 471
          },
          {
            "text": "\t\t\t\tfromNode: sourceNode.id,",
            "lineNumber": 472
          },
          {
            "text": "\t\t\t\ttoNode: outId,",
            "lineNumber": 473
          },
          {
            "text": "\t\t\t\tlabel: EDGE_LABEL_OUTPUT,",
            "lineNumber": 474
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 475
          },
          {
            "text": "\t\t}",
            "lineNumber": 476
          },
          {
            "text": "\t\treturn;",
            "lineNumber": 477
          },
          {
            "text": "\t}",
            "lineNumber": 478
          },
          {
            "lineNumber": 479
          },
          {
            "text": "\tconst newNodeId = randomId();",
            "lineNumber": 480
          },
          {
            "text": "\tconst newTextNode: CanvasTextData = {",
            "lineNumber": 481
          },
          {
            "text": "\t\tid: newNodeId,",
            "lineNumber": 482
          },
          {
            "text": "\t\ttype: \"text\",",
            "lineNumber": 483
          },
          {
            "text": "\t\ttext,",
            "lineNumber": 484
          },
          {
            "text": "\t\tx: chosenX,",
            "lineNumber": 485
          },
          {
            "text": "\t\ty: chosenY,",
            "lineNumber": 486
          },
          {
            "text": "\t\twidth,",
            "lineNumber": 487
          },
          {
            "text": "\t\theight,",
            "lineNumber": 488
          },
          {
            "text": "\t\tcolor: greenColor,",
            "lineNumber": 489
          },
          {
            "text": "\t};",
            "lineNumber": 490
          },
          {
            "text": "\tdata.nodes.push(newTextNode);",
            "lineNumber": 491
          },
          {
            "text": "\tdata.edges.push({",
            "lineNumber": 492
          },
          {
            "text": "\t\tid: randomId(),",
            "lineNumber": 493
          },
          {
            "text": "\t\tfromNode: sourceNode.id,",
            "lineNumber": 494
          },
          {
            "text": "\t\ttoNode: newNodeId,",
            "lineNumber": 495
          },
          {
            "text": "\t\tlabel: EDGE_LABEL_OUTPUT,",
            "lineNumber": 496
          },
          {
            "text": "\t});",
            "lineNumber": 497
          },
          {
            "text": "}",
            "lineNumber": 498,
            "isSignature": true
          },
          {
            "lineNumber": 499
          },
          {
            "text": "/** Run a single node (for \"Run Node\" command). If parents are not run, runs chain to this node instead. */",
            "lineNumber": 500
          }
        ]
      },
      "score": 0.2635970115661621
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/types.ts",
        "range": {
          "startPosition": {
            "line": 121,
            "column": 50
          },
          "endPosition": {
            "line": 156,
            "column": 84
          }
        },
        "contents": "/** Find the Green (output) node for a given source node. Edge-first (label \"output\"), then position fallback. */\nexport function findOutputNodeForSource(\n\tdata: CanvasData,\n\tsourceNodeId: string,\n\tsettings: ZettelPluginSettings\n): string | null {\n\tconst outputEdge = data.edges.find(\n\t\t(e) =&gt; e.fromNode === sourceNodeId &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT\n\t);\n\tif (outputEdge) return outputEdge.toNode;\n\tconst source = getNodeById(data, sourceNodeId);\n\tif (!source) return null;\n\tconst greenColor = normalizeColor(settings.colorGreen as CanvasColor | undefined);\n\tif (!greenColor) return null;\n\tconst expectedY = source.y + source.height + GREEN_NODE_PADDING;\n\tconst toleranceAbove = 30; // allow small layout drift above default\n\tconst candidates: { id: string; centerY: number }[] = [];\n\tfor (const node of data.nodes) {\n\t\tif (node.id === sourceNodeId) continue;\n\t\tif (normalizeColor(node.color) !== greenColor) continue;\n\t\tif (Math.abs(node.x - source.x) &gt; 50) continue;\n\t\tif (node.y &lt; expectedY - toleranceAbove || node.y &gt; expectedY + OUTPUT_POSITION_FALLBACK_MAX_Y) continue;\n\t\tconst centerY = node.y + (node.height ?? 0) / 2;\n\t\tcandidates.push({ id: node.id, centerY });\n\t}\n\tif (candidates.length === 0) return null;\n\t// Prefer the green whose center is closest to expectedY (avoids wrong match when sources are stacked)\n\tconst best = candidates.reduce((a, b) =&gt;\n\t\tMath.abs(a.centerY - expectedY) &lt;= Math.abs(b.centerY - expectedY) ? a : b\n\t);\n\treturn best.id;\n}\n\n/** Check if canvas has any output nodes (green nodes connected by output edges). */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Find the Green (output) node for a given source node. Edge-first (label \"output\"), then position fallback. */",
            "lineNumber": 124
          },
          {
            "text": "export function findOutputNodeForSource(",
            "lineNumber": 125,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 126,
            "isSignature": true
          },
          {
            "text": "\tsourceNodeId: string,",
            "lineNumber": 127,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings",
            "lineNumber": 128,
            "isSignature": true
          },
          {
            "text": "): string | null {",
            "lineNumber": 129,
            "isSignature": true
          },
          {
            "text": "\tconst outputEdge = data.edges.find(",
            "lineNumber": 130
          },
          {
            "text": "\t\t(e) =&gt; e.fromNode === sourceNodeId &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT",
            "lineNumber": 131
          },
          {
            "text": "\t);",
            "lineNumber": 132
          },
          {
            "text": "\tif (outputEdge) return outputEdge.toNode;",
            "lineNumber": 133
          },
          {
            "text": "\tconst source = getNodeById(data, sourceNodeId);",
            "lineNumber": 134
          },
          {
            "text": "\tif (!source) return null;",
            "lineNumber": 135
          },
          {
            "text": "\tconst greenColor = normalizeColor(settings.colorGreen as CanvasColor | undefined);",
            "lineNumber": 136
          },
          {
            "text": "\tif (!greenColor) return null;",
            "lineNumber": 137
          },
          {
            "text": "\tconst expectedY = source.y + source.height + GREEN_NODE_PADDING;",
            "lineNumber": 138
          },
          {
            "text": "\tconst toleranceAbove = 30; // allow small layout drift above default",
            "lineNumber": 139
          },
          {
            "text": "\tconst candidates: { id: string; centerY: number }[] = [];",
            "lineNumber": 140
          },
          {
            "text": "\tfor (const node of data.nodes) {",
            "lineNumber": 141
          },
          {
            "text": "\t\tif (node.id === sourceNodeId) continue;",
            "lineNumber": 142
          },
          {
            "text": "\t\tif (normalizeColor(node.color) !== greenColor) continue;",
            "lineNumber": 143
          },
          {
            "text": "\t\tif (Math.abs(node.x - source.x) &gt; 50) continue;",
            "lineNumber": 144
          },
          {
            "text": "\t\tif (node.y &lt; expectedY - toleranceAbove || node.y &gt; expectedY + OUTPUT_POSITION_FALLBACK_MAX_Y) continue;",
            "lineNumber": 145
          },
          {
            "text": "\t\tconst centerY = node.y + (node.height ?? 0) / 2;",
            "lineNumber": 146
          },
          {
            "text": "\t\tcandidates.push({ id: node.id, centerY });",
            "lineNumber": 147
          },
          {
            "text": "\t}",
            "lineNumber": 148
          },
          {
            "text": "\tif (candidates.length === 0) return null;",
            "lineNumber": 149
          },
          {
            "text": "\t// Prefer the green whose center is closest to expectedY (avoids wrong match when sources are stacked)",
            "lineNumber": 150
          },
          {
            "text": "\tconst best = candidates.reduce((a, b) =&gt;",
            "lineNumber": 151
          },
          {
            "text": "\t\tMath.abs(a.centerY - expectedY) &lt;= Math.abs(b.centerY - expectedY) ? a : b",
            "lineNumber": 152
          },
          {
            "text": "\t);",
            "lineNumber": 153
          },
          {
            "text": "\treturn best.id;",
            "lineNumber": 154
          },
          {
            "text": "}",
            "lineNumber": 155,
            "isSignature": true
          },
          {
            "lineNumber": 156
          },
          {
            "text": "/** Check if canvas has any output nodes (green nodes connected by output edges). */",
            "lineNumber": 157
          }
        ]
      },
      "score": 0.2593477964401245
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/state.ts",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 25,
            "column": 1
          }
        },
        "contents": "/** Per-canvas state: NodeID -&gt; last output result string. */\nconst canvasState = new Map&lt;string, Map&lt;string, string&gt;&gt;();\n\n/** Per-canvas edge mode: EdgeID -&gt; \"inject\" | \"concatenate\" (shown in floating label under edge). */\nconst edgeModeState = new Map&lt;string, Map&lt;string, \"inject\" | \"concatenate\"&gt;&gt;();\n\n/** Node currently running (waiting for AI/kernel) per canvas; used to show \"running\" on incoming edges. */\nconst runningNodeState = new Map&lt;string, string | null&gt;();\n\nfunction getCanvasState(canvasKey: string): Map&lt;string, string&gt; {\n\tlet map = canvasState.get(canvasKey);\n\tif (!map) {\n\t\tmap = new Map();\n\t\tcanvasState.set(canvasKey, map);\n\t}\n\treturn map;\n}\n\nfunction getEdgeModeState(canvasKey: string): Map&lt;string, \"inject\" | \"concatenate\"&gt; {\n\t\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Per-canvas state: NodeID -&gt; last output result string. */",
            "lineNumber": 1
          },
          {
            "text": "const canvasState = new Map&lt;string, Map&lt;string, string&gt;&gt;();",
            "lineNumber": 2
          },
          {
            "lineNumber": 3
          },
          {
            "text": "/** Per-canvas edge mode: EdgeID -&gt; \"inject\" | \"concatenate\" (shown in floating label under edge). */",
            "lineNumber": 4
          },
          {
            "text": "const edgeModeState = new Map&lt;string, Map&lt;string, \"inject\" | \"concatenate\"&gt;&gt;();",
            "lineNumber": 5
          },
          {
            "lineNumber": 6
          },
          {
            "text": "/** Node currently running (waiting for AI/kernel) per canvas; used to show \"running\" on incoming edges. */",
            "lineNumber": 7
          },
          {
            "text": "const runningNodeState = new Map&lt;string, string | null&gt;();",
            "lineNumber": 8
          },
          {
            "lineNumber": 9
          },
          {
            "text": "function getCanvasState(canvasKey: string): Map&lt;string, string&gt; {",
            "lineNumber": 10,
            "isSignature": true
          },
          {
            "text": "\tlet map = canvasState.get(canvasKey);",
            "lineNumber": 11
          },
          {
            "text": "\tif (!map) {",
            "lineNumber": 12
          },
          {
            "text": "\t\tmap = new Map();",
            "lineNumber": 13
          },
          {
            "text": "\t\tcanvasState.set(canvasKey, map);",
            "lineNumber": 14
          },
          {
            "text": "\t}",
            "lineNumber": 15
          },
          {
            "text": "\treturn map;",
            "lineNumber": 16
          },
          {
            "text": "}",
            "lineNumber": 17,
            "isSignature": true
          },
          {
            "lineNumber": 18
          },
          {
            "text": "function getEdgeModeState(canvasKey: string): Map&lt;string, \"inject\" | \"concatenate\"&gt; {",
            "lineNumber": 19,
            "isSignature": true
          },
          {
            "text": "\t",
            "lineNumber": 20
          },
          {
            "text": "}",
            "lineNumber": 26,
            "isSignature": true
          }
        ]
      },
      "score": 0.25868460536003113
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 324,
            "column": 1
          },
          "endPosition": {
            "line": 877,
            "column": 1
          }
        },
        "contents": "/** Debug: set to true when canvas:node-menu callback has fired at least once (proves event is received). */\nlet debugNodeMenuFired = false;\n\nexport default class ZettelThinkingBoardPlugin extends Plugin {\n\tsettings: ZettelPluginSettings;\n\n\tasync onload() {\n\t\ttry {\n\t\t\tawait this.loadSettings();\n\t\t\tthis.addSettingTab(new ZettelSettingTab(this.app, this));\n\n\t\t\tthis.registerView(\n\t\t\t\tZETTEL_CONTROLS_VIEW_TYPE,\n\t\t\t\t(leaf: WorkspaceLeaf) =&gt; new ZettelControlsView(leaf, this)\n\t\t\t);\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"open-zettel-controls\",\n\t\t\t\tname: \"Open Zettel Controls\",\n\t\t\t\tcallback: () =&gt; this.activateZettelControls(),\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"create-tutorial-canvas\",\n\t\t\t\tname: \"Create tutorial canvas\",\n\t\t\t\tcallback: () =&gt; this.createTutorialCanvas(),\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"duplicate-canvas-template\",\n\t\t\t\tname: \"Duplicate canvas template\",\n\t\t\t\tcallback: () =&gt; this.duplicateCanvasTemplate(),\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"save-canvas-as-template\",\n\t\t\t\tname: \"Save canvas as template\",\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\t\tif (!view) return false;\n\t\t\t\t\tif (checking) return true;\n\t\t\t\t\tthis.saveCanvasAsTemplate();\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"edit-canvas-template\",\n\t\t\t\tname: \"Edit canvas template\",\n\t\t\t\tcallback: () =&gt; this.editCanvasTemplate(),\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"run-node\",\n\t\t\t\tname: \"Run node\",\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\t\tif (!view) return false;\n\t\t\t\t\tif (checking) return true;\n\t\t\t\t\t// Command palette: no node selected; prompt user to use context menu\n\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Run node\\\" to run it.\");\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tthis.addCommand\n\n\t}\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Debug: set to true when canvas:node-menu callback has fired at least once (proves event is received). */",
            "lineNumber": 327
          },
          {
            "text": "let debugNodeMenuFired = false;",
            "lineNumber": 328
          },
          {
            "lineNumber": 329
          },
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 330,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings;",
            "lineNumber": 331
          },
          {
            "lineNumber": 332
          },
          {
            "text": "\tasync onload() {",
            "lineNumber": 333
          },
          {
            "text": "\t\ttry {",
            "lineNumber": 334
          },
          {
            "text": "\t\t\tawait this.loadSettings();",
            "lineNumber": 335
          },
          {
            "text": "\t\t\tthis.addSettingTab(new ZettelSettingTab(this.app, this));",
            "lineNumber": 336
          },
          {
            "lineNumber": 337
          },
          {
            "text": "\t\t\tthis.registerView(",
            "lineNumber": 338
          },
          {
            "text": "\t\t\t\tZETTEL_CONTROLS_VIEW_TYPE,",
            "lineNumber": 339
          },
          {
            "text": "\t\t\t\t(leaf: WorkspaceLeaf) =&gt; new ZettelControlsView(leaf, this)",
            "lineNumber": 340
          },
          {
            "text": "\t\t\t);",
            "lineNumber": 341
          },
          {
            "lineNumber": 342
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 343
          },
          {
            "text": "\t\t\t\tid: \"open-zettel-controls\",",
            "lineNumber": 344
          },
          {
            "text": "\t\t\t\tname: \"Open Zettel Controls\",",
            "lineNumber": 345
          },
          {
            "text": "\t\t\t\tcallback: () =&gt; this.activateZettelControls(),",
            "lineNumber": 346
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 347
          },
          {
            "lineNumber": 348
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 349
          },
          {
            "text": "\t\t\t\tid: \"create-tutorial-canvas\",",
            "lineNumber": 350
          },
          {
            "text": "\t\t\t\tname: \"Create tutorial canvas\",",
            "lineNumber": 351
          },
          {
            "text": "\t\t\t\tcallback: () =&gt; this.createTutorialCanvas(),",
            "lineNumber": 352
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 353
          },
          {
            "lineNumber": 354
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 355
          },
          {
            "text": "\t\t\t\tid: \"duplicate-canvas-template\",",
            "lineNumber": 356
          },
          {
            "text": "\t\t\t\tname: \"Duplicate canvas template\",",
            "lineNumber": 357
          },
          {
            "text": "\t\t\t\tcallback: () =&gt; this.duplicateCanvasTemplate(),",
            "lineNumber": 358
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 359
          },
          {
            "lineNumber": 360
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 361
          },
          {
            "text": "\t\t\t\tid: \"save-canvas-as-template\",",
            "lineNumber": 362
          },
          {
            "text": "\t\t\t\tname: \"Save canvas as template\",",
            "lineNumber": 363
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 364
          },
          {
            "text": "\t\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 365
          },
          {
            "text": "\t\t\t\t\tif (!view) return false;",
            "lineNumber": 366
          },
          {
            "text": "\t\t\t\t\tif (checking) return true;",
            "lineNumber": 367
          },
          {
            "text": "\t\t\t\t\tthis.saveCanvasAsTemplate();",
            "lineNumber": 368
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 369
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 370
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 371
          },
          {
            "lineNumber": 372
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 373
          },
          {
            "text": "\t\t\t\tid: \"edit-canvas-template\",",
            "lineNumber": 374
          },
          {
            "text": "\t\t\t\tname: \"Edit canvas template\",",
            "lineNumber": 375
          },
          {
            "text": "\t\t\t\tcallback: () =&gt; this.editCanvasTemplate(),",
            "lineNumber": 376
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 377
          },
          {
            "lineNumber": 378
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 379
          },
          {
            "text": "\t\t\t\tid: \"run-node\",",
            "lineNumber": 380
          },
          {
            "text": "\t\t\t\tname: \"Run node\",",
            "lineNumber": 381
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 382
          },
          {
            "text": "\t\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 383
          },
          {
            "text": "\t\t\t\t\tif (!view) return false;",
            "lineNumber": 384
          },
          {
            "text": "\t\t\t\t\tif (checking) return true;",
            "lineNumber": 385
          },
          {
            "text": "\t\t\t\t\t// Command palette: no node selected; prompt user to use context menu",
            "lineNumber": 386
          },
          {
            "text": "\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Run node\\\" to run it.\");",
            "lineNumber": 387
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 388
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 389
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 390
          },
          {
            "lineNumber": 391
          },
          {
            "text": "\t\t\tthis.addCommand",
            "lineNumber": 392
          },
          {
            "lineNumber": 402
          },
          {
            "text": "\t}",
            "lineNumber": 595
          },
          {
            "text": "}",
            "lineNumber": 878,
            "isSignature": true
          }
        ]
      },
      "score": 0.2572062015533447
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "column": 76
          },
          "endPosition": {
            "line": 43,
            "column": 99
          }
        },
        "contents": " from \"obsidian\";\nimport {DEFAULT_SETTINGS, ZettelPluginSettings, ZettelSettingTab} from \"./settings\";\nimport {ZettelControlsView, ZETTEL_CONTROLS_VIEW_TYPE} from \"./views/ZettelControlsView\";\nimport {CanvasTemplateModal} from \"./views/CanvasTemplateModal\";\nimport {duplicateCanvasTemplate, saveCanvasAsTemplate, isCanvasInTemplateFolder} from \"./canvas/canvasTemplates\";\nimport {\n\tdismissAllOutput as runnerDismissAllOutput,\n\tdismissOutput as runnerDismissOutput,\n\trunChain as runnerRunChain,\n\trunEntireCanvas as runnerRunEntireCanvas,\n\trunNode as runnerRunNode,\n} from \"./engine/runner\";\nimport {\n\tclearCanvasEdgeModeLabels,\n\tclearCanvasLegend,\n\tclearCanvasRoleLabels,\n\tsyncCanvasEdgeModeLabels,\n\tsyncCanvasRoleLabels,\n} from \"./canvas/canvasNodeLabels\";\nimport {hasOutputNodes, loadCanvasData, saveCanvasData} from \"./canvas/nodes\";\nimport type {CanvasData} from \"./canvas/types\";\nimport {EDGE_LABEL_OUTPUT} from \"./canvas/types\";\nimport {getKernelForCanvas, terminateAllKernels, terminateKernel} from \"./engine/kernelManager\";\nimport {getExample1CanvasData} from \"./tutorials/example1Data\";\nimport {getExample4CanvasData} from \"./tutorials/example4Data\";\n\n/** Layout constants: comment margins left/right, central lane for nodes, no overlap. */\nconst TUT_LEFT = 80;\nconst TUT_TOP = 50;\nconst TUT_WELCOME_W = 420;\nconst TUT_WELCOME_H = 118;\nconst TUT_WELCOME_BOTTOM_GAP = 70;\n/** Per-column: left comment margin | node lane | right comment margin. */\nconst TUT_COMMENT_W = 185;\nconst TUT_LANE_GAP = 22;\nconst TUT_NODE_LANE_W = 260;\nconst TUT_COL_TOTAL_W = TUT_COMMENT_W + TUT_LANE_GAP + TUT_NODE_LANE_W + TUT_LANE_GAP + TUT_COMMENT_W;\nconst TUT_COL_GAP = 85;\nconst TUT_NODE_H = 115;\nconst TUT_NODE_GAP = 58;\nconst TUT_LABEL_H = 88;\nconst TUT_GROUP_PAD = 18;\n\n/** Resolve role color from settings (fallback to default so tutorial always has a valid color). */",
        "signatures": {},
        "detailedLines": [
          {
            "text": " from \"obsidian\";",
            "lineNumber": 1
          },
          {
            "text": "import {DEFAULT_SETTINGS, ZettelPluginSettings, ZettelSettingTab} from \"./settings\";",
            "lineNumber": 2
          },
          {
            "text": "import {ZettelControlsView, ZETTEL_CONTROLS_VIEW_TYPE} from \"./views/ZettelControlsView\";",
            "lineNumber": 3
          },
          {
            "text": "import {CanvasTemplateModal} from \"./views/CanvasTemplateModal\";",
            "lineNumber": 4
          },
          {
            "text": "import {duplicateCanvasTemplate, saveCanvasAsTemplate, isCanvasInTemplateFolder} from \"./canvas/canvasTemplates\";",
            "lineNumber": 5
          },
          {
            "text": "import {",
            "lineNumber": 6
          },
          {
            "text": "\tdismissAllOutput as runnerDismissAllOutput,",
            "lineNumber": 7
          },
          {
            "text": "\tdismissOutput as runnerDismissOutput,",
            "lineNumber": 8
          },
          {
            "text": "\trunChain as runnerRunChain,",
            "lineNumber": 9
          },
          {
            "text": "\trunEntireCanvas as runnerRunEntireCanvas,",
            "lineNumber": 10
          },
          {
            "text": "\trunNode as runnerRunNode,",
            "lineNumber": 11
          },
          {
            "text": "} from \"./engine/runner\";",
            "lineNumber": 12
          },
          {
            "text": "import {",
            "lineNumber": 13
          },
          {
            "text": "\tclearCanvasEdgeModeLabels,",
            "lineNumber": 14
          },
          {
            "text": "\tclearCanvasLegend,",
            "lineNumber": 15
          },
          {
            "text": "\tclearCanvasRoleLabels,",
            "lineNumber": 16
          },
          {
            "text": "\tsyncCanvasEdgeModeLabels,",
            "lineNumber": 17
          },
          {
            "text": "\tsyncCanvasRoleLabels,",
            "lineNumber": 18
          },
          {
            "text": "} from \"./canvas/canvasNodeLabels\";",
            "lineNumber": 19
          },
          {
            "text": "import {hasOutputNodes, loadCanvasData, saveCanvasData} from \"./canvas/nodes\";",
            "lineNumber": 20
          },
          {
            "text": "import type {CanvasData} from \"./canvas/types\";",
            "lineNumber": 21
          },
          {
            "text": "import {EDGE_LABEL_OUTPUT} from \"./canvas/types\";",
            "lineNumber": 22
          },
          {
            "text": "import {getKernelForCanvas, terminateAllKernels, terminateKernel} from \"./engine/kernelManager\";",
            "lineNumber": 23
          },
          {
            "text": "import {getExample1CanvasData} from \"./tutorials/example1Data\";",
            "lineNumber": 24
          },
          {
            "text": "import {getExample4CanvasData} from \"./tutorials/example4Data\";",
            "lineNumber": 25
          },
          {
            "lineNumber": 26
          },
          {
            "text": "/** Layout constants: comment margins left/right, central lane for nodes, no overlap. */",
            "lineNumber": 27
          },
          {
            "text": "const TUT_LEFT = 80;",
            "lineNumber": 28
          },
          {
            "text": "const TUT_TOP = 50;",
            "lineNumber": 29
          },
          {
            "text": "const TUT_WELCOME_W = 420;",
            "lineNumber": 30
          },
          {
            "text": "const TUT_WELCOME_H = 118;",
            "lineNumber": 31
          },
          {
            "text": "const TUT_WELCOME_BOTTOM_GAP = 70;",
            "lineNumber": 32
          },
          {
            "text": "/** Per-column: left comment margin | node lane | right comment margin. */",
            "lineNumber": 33
          },
          {
            "text": "const TUT_COMMENT_W = 185;",
            "lineNumber": 34
          },
          {
            "text": "const TUT_LANE_GAP = 22;",
            "lineNumber": 35
          },
          {
            "text": "const TUT_NODE_LANE_W = 260;",
            "lineNumber": 36
          },
          {
            "text": "const TUT_COL_TOTAL_W = TUT_COMMENT_W + TUT_LANE_GAP + TUT_NODE_LANE_W + TUT_LANE_GAP + TUT_COMMENT_W;",
            "lineNumber": 37
          },
          {
            "text": "const TUT_COL_GAP = 85;",
            "lineNumber": 38
          },
          {
            "text": "const TUT_NODE_H = 115;",
            "lineNumber": 39
          },
          {
            "text": "const TUT_NODE_GAP = 58;",
            "lineNumber": 40
          },
          {
            "text": "const TUT_LABEL_H = 88;",
            "lineNumber": 41
          },
          {
            "text": "const TUT_GROUP_PAD = 18;",
            "lineNumber": 42
          },
          {
            "lineNumber": 43
          },
          {
            "text": "/** Resolve role color from settings (fallback to default so tutorial always has a valid color). */",
            "lineNumber": 44
          }
        ]
      },
      "score": 0.25292110443115234
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 560,
            "column": 1
          },
          "endPosition": {
            "line": 594,
            "column": 104
          }
        },
        "contents": "/** Run chain from roots to the given node. */\nexport async function runChain(\n\tapp: App,\n\tsettings: ZettelPluginSettings,\n\tcanvasFilePath: string,\n\tnodeId: string,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;{ ok: boolean; message?: string }&gt; {\n\tconst data = await loadCanvasData(app.vault, canvasFilePath);\n\tif (!data) return { ok: false, message: \"Could not load canvas data.\" };\n\tconst roots = getRootIds(data);\n\tconst rootsReachingCurrent = roots.filter((r) =&gt; canReach(data, r, nodeId));\n\tif (rootsReachingCurrent.length === 0) return { ok: false, message: \"No root reaches this node.\" };\n\tconst topo = topologicalOrderToTarget(data, nodeId, settings);\n\tif (\"cycle\" in topo) return { ok: false, message: CYCLE_ERROR_MESSAGE };\n\tconst order = topo.order;\n\tconst canvasKey = getCanvasKey(canvasFilePath);\n\ttry {\n\t\tfor (const nid of order) {\n\t\t\ttry {\n\t\t\t\tsetRunningNodeId(canvasKey, nid);\n\t\t\t\tawait runSingleNode(app, settings, canvasKey, canvasFilePath, data, nid, liveCanvas);\n\t\t\t} finally {\n\t\t\t\tsetRunningNodeId(canvasKey, null);\n\t\t\t}\n\t\t}\n\t\treturn { ok: true };\n\t} catch (e) {\n\t\treturn { ok: false, message: e instanceof Error ? e.message : String(e) };\n\t}\n}\n\n/** Remove the Green output node and its output edge for a given source node; mutates data and saves. */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Run chain from roots to the given node. */",
            "lineNumber": 563
          },
          {
            "text": "export async function runChain(",
            "lineNumber": 564,
            "isSignature": true
          },
          {
            "text": "\tapp: App,",
            "lineNumber": 565,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 566,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 567,
            "isSignature": true
          },
          {
            "text": "\tnodeId: string,",
            "lineNumber": 568,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 569,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;{ ok: boolean; message?: string }&gt; {",
            "lineNumber": 570,
            "isSignature": true
          },
          {
            "text": "\tconst data = await loadCanvasData(app.vault, canvasFilePath);",
            "lineNumber": 571
          },
          {
            "text": "\tif (!data) return { ok: false, message: \"Could not load canvas data.\" };",
            "lineNumber": 572
          },
          {
            "text": "\tconst roots = getRootIds(data);",
            "lineNumber": 573
          },
          {
            "text": "\tconst rootsReachingCurrent = roots.filter((r) =&gt; canReach(data, r, nodeId));",
            "lineNumber": 574
          },
          {
            "text": "\tif (rootsReachingCurrent.length === 0) return { ok: false, message: \"No root reaches this node.\" };",
            "lineNumber": 575
          },
          {
            "text": "\tconst topo = topologicalOrderToTarget(data, nodeId, settings);",
            "lineNumber": 576
          },
          {
            "text": "\tif (\"cycle\" in topo) return { ok: false, message: CYCLE_ERROR_MESSAGE };",
            "lineNumber": 577
          },
          {
            "text": "\tconst order = topo.order;",
            "lineNumber": 578
          },
          {
            "text": "\tconst canvasKey = getCanvasKey(canvasFilePath);",
            "lineNumber": 579
          },
          {
            "text": "\ttry {",
            "lineNumber": 580
          },
          {
            "text": "\t\tfor (const nid of order) {",
            "lineNumber": 581
          },
          {
            "text": "\t\t\ttry {",
            "lineNumber": 582
          },
          {
            "text": "\t\t\t\tsetRunningNodeId(canvasKey, nid);",
            "lineNumber": 583
          },
          {
            "text": "\t\t\t\tawait runSingleNode(app, settings, canvasKey, canvasFilePath, data, nid, liveCanvas);",
            "lineNumber": 584
          },
          {
            "text": "\t\t\t} finally {",
            "lineNumber": 585
          },
          {
            "text": "\t\t\t\tsetRunningNodeId(canvasKey, null);",
            "lineNumber": 586
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 587
          },
          {
            "text": "\t\t}",
            "lineNumber": 588
          },
          {
            "text": "\t\treturn { ok: true };",
            "lineNumber": 589
          },
          {
            "text": "\t} catch (e) {",
            "lineNumber": 590
          },
          {
            "text": "\t\treturn { ok: false, message: e instanceof Error ? e.message : String(e) };",
            "lineNumber": 591
          },
          {
            "text": "\t}",
            "lineNumber": 592
          },
          {
            "text": "}",
            "lineNumber": 593,
            "isSignature": true
          },
          {
            "lineNumber": 594
          },
          {
            "text": "/** Remove the Green output node and its output edge for a given source node; mutates data and saves. */",
            "lineNumber": 595
          }
        ]
      },
      "score": 0.25110891461372375
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 329
          },
          "endPosition": {
            "line": 877,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\nasync onload() {\nconst runSyncLabels = \n\n\t\t\t\tif (leaf?.view) {\n\t\t\t\t\tconst itemView = leaf.view as ViewWithFlag;\n\t\t\t\t\tif (itemView._ztbTitleBarActionsAdded) {\n\t\t\t\t\t\taddedToTitleBar = true;\n\t\t\t\t\t} else if (typeof itemView.addAction === \"function\") {\n\t\t\t\t\t\titemView.addAction(\"play\", \"Run entire canvas\", () =&gt; this.runEntireCanvas());\n\t\t\t\t\t\titemView.addAction(\"trash\", \"Dismiss all output\", () =&gt; this.dismissAllOutput());\n\t\t\t\t\t\titemView._ztbTitleBarActionsAdded = true;\n\t\t\t\t\t\taddedToTitleBar = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (!addedToTitleBar) this.addCanvasToolbarToContainer(view.containerEl);\n\t\t\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;\n\t\t\t\tconst isStillActive = (): boolean =&gt; this.getActiveCanvasView()?.containerEl === roleLabelsContainerEl;\n\t\t\t\tsyncCanvasRoleLabels(this.app.vault, view.file.path, view.containerEl, this.settings, liveCanvas, isStillActive);\n\t\t\t\tsyncCanvasEdgeModeLabels(this.app.vault, view.file.path, view.containerEl, liveCanvas, isStillActive);\n\t\t\t\tif (roleLabelsIntervalId == null) {\n\t\t\t\t\troleLabelsIntervalId = window.setInterval(() =&gt; {\n\t\t\t\t\t\tconst v = this.getActiveCanvasView();\n\t\t\t\t\t\tif (v != null &amp;&amp; v.containerEl === roleLabelsContainerEl) {\n\t\t\t\t\t\t\tconst stillActive = (): boolean =&gt; this.getActiveCanvasView()?.containerEl === roleLabelsContainerEl;\n\t\t\t\t\t\t\tsyncCanvasRoleLabels(this.app.vault, v.file.path, v.containerEl, this.settings, v.canvas as import(\"./engine/canvasApi\").LiveCanvas, stillActive);\n\t\t\t\t\t\t\tsyncCanvasEdgeModeLabels(this.app.vault, v.file.path, v.containerEl, v.canvas as import(\"./engine/canvasApi\").LiveCanvas, stillActive);\n\t\t\t\t\t\t}\n\t\t\t\t\t}, 2000);\n\t\t\t\t\t(this as unknown as { _roleLabelsIntervalId: number })._roleLabelsIntervalId = roleLabelsIntervalId;\n\t\t\t\t}\n\t\t\t};\n\t\t\tthis.registerEvent(this.app.workspace.on(\"active-leaf-change\", runSyncLabels));\n\t\t\trunSyncLabels();\n\t\t} catch (e) {\n\t\t\tconsole.error(\"Zettel Thinking Board onload error:\", e);\n\t\t\tthrow e;\n\t\t}\n\t}\n\n\tonunload() {\n\t\tterminateAllKernels();\n\t\tconst id = (;\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 330,
                "column": 1
              },
              "endPosition": {
                "line": 330,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 330,
                "column": 16
              },
              "endPosition": {
                "line": 331,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 333,
                "column": 2
              },
              "endPosition": {
                "line": 334,
                "column": 3
              }
            },
            {
              "startPosition": {
                "line": 528,
                "column": 4
              },
              "endPosition": {
                "line": 528,
                "column": 10
              }
            },
            {
              "startPosition": {
                "line": 528,
                "column": 10
              },
              "endPosition": {
                "line": 528,
                "column": 26
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 330,
            "isSignature": true
          },
          {
            "text": "async onload() {",
            "lineNumber": 333
          },
          {
            "text": "const runSyncLabels = ",
            "lineNumber": 528
          },
          {
            "lineNumber": 560
          },
          {
            "text": "\t\t\t\tif (leaf?.view) {",
            "lineNumber": 561
          },
          {
            "text": "\t\t\t\t\tconst itemView = leaf.view as ViewWithFlag;",
            "lineNumber": 562
          },
          {
            "text": "\t\t\t\t\tif (itemView._ztbTitleBarActionsAdded) {",
            "lineNumber": 563
          },
          {
            "text": "\t\t\t\t\t\taddedToTitleBar = true;",
            "lineNumber": 564
          },
          {
            "text": "\t\t\t\t\t} else if (typeof itemView.addAction === \"function\") {",
            "lineNumber": 565
          },
          {
            "text": "\t\t\t\t\t\titemView.addAction(\"play\", \"Run entire canvas\", () =&gt; this.runEntireCanvas());",
            "lineNumber": 566
          },
          {
            "text": "\t\t\t\t\t\titemView.addAction(\"trash\", \"Dismiss all output\", () =&gt; this.dismissAllOutput());",
            "lineNumber": 567
          },
          {
            "text": "\t\t\t\t\t\titemView._ztbTitleBarActionsAdded = true;",
            "lineNumber": 568
          },
          {
            "text": "\t\t\t\t\t\taddedToTitleBar = true;",
            "lineNumber": 569
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 570
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 571
          },
          {
            "text": "\t\t\t\tif (!addedToTitleBar) this.addCanvasToolbarToContainer(view.containerEl);",
            "lineNumber": 572
          },
          {
            "text": "\t\t\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;",
            "lineNumber": 573
          },
          {
            "text": "\t\t\t\tconst isStillActive = (): boolean =&gt; this.getActiveCanvasView()?.containerEl === roleLabelsContainerEl;",
            "lineNumber": 574
          },
          {
            "text": "\t\t\t\tsyncCanvasRoleLabels(this.app.vault, view.file.path, view.containerEl, this.settings, liveCanvas, isStillActive);",
            "lineNumber": 575
          },
          {
            "text": "\t\t\t\tsyncCanvasEdgeModeLabels(this.app.vault, view.file.path, view.containerEl, liveCanvas, isStillActive);",
            "lineNumber": 576
          },
          {
            "text": "\t\t\t\tif (roleLabelsIntervalId == null) {",
            "lineNumber": 577
          },
          {
            "text": "\t\t\t\t\troleLabelsIntervalId = window.setInterval(() =&gt; {",
            "lineNumber": 578
          },
          {
            "text": "\t\t\t\t\t\tconst v = this.getActiveCanvasView();",
            "lineNumber": 579
          },
          {
            "text": "\t\t\t\t\t\tif (v != null &amp;&amp; v.containerEl === roleLabelsContainerEl) {",
            "lineNumber": 580
          },
          {
            "text": "\t\t\t\t\t\t\tconst stillActive = (): boolean =&gt; this.getActiveCanvasView()?.containerEl === roleLabelsContainerEl;",
            "lineNumber": 581
          },
          {
            "text": "\t\t\t\t\t\t\tsyncCanvasRoleLabels(this.app.vault, v.file.path, v.containerEl, this.settings, v.canvas as import(\"./engine/canvasApi\").LiveCanvas, stillActive);",
            "lineNumber": 582
          },
          {
            "text": "\t\t\t\t\t\t\tsyncCanvasEdgeModeLabels(this.app.vault, v.file.path, v.containerEl, v.canvas as import(\"./engine/canvasApi\").LiveCanvas, stillActive);",
            "lineNumber": 583
          },
          {
            "text": "\t\t\t\t\t\t}",
            "lineNumber": 584
          },
          {
            "text": "\t\t\t\t\t}, 2000);",
            "lineNumber": 585
          },
          {
            "text": "\t\t\t\t\t(this as unknown as { _roleLabelsIntervalId: number })._roleLabelsIntervalId = roleLabelsIntervalId;",
            "lineNumber": 586
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 587
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 588
          },
          {
            "text": "\t\t\tthis.registerEvent(this.app.workspace.on(\"active-leaf-change\", runSyncLabels));",
            "lineNumber": 589
          },
          {
            "text": "\t\t\trunSyncLabels();",
            "lineNumber": 590
          },
          {
            "text": "\t\t} catch (e) {",
            "lineNumber": 591
          },
          {
            "text": "\t\t\tconsole.error(\"Zettel Thinking Board onload error:\", e);",
            "lineNumber": 592
          },
          {
            "text": "\t\t\tthrow e;",
            "lineNumber": 593
          },
          {
            "text": "\t\t}",
            "lineNumber": 594
          },
          {
            "text": "\t}",
            "lineNumber": 595
          },
          {
            "lineNumber": 596
          },
          {
            "text": "\tonunload() {",
            "lineNumber": 597
          },
          {
            "text": "\t\tterminateAllKernels();",
            "lineNumber": 598
          },
          {
            "text": "\t\tconst id = (;",
            "lineNumber": 599
          },
          {
            "text": "\t}",
            "lineNumber": 601
          },
          {
            "text": "}",
            "lineNumber": 878,
            "isSignature": true
          }
        ]
      },
      "score": 0.25030064582824707
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/state.ts",
        "range": {
          "startPosition": {
            "line": 29,
            "column": 1
          },
          "endPosition": {
            "line": 37,
            "column": 1
          }
        },
        "contents": "export function setNodeResult(canvasKey: string, nodeId: string, result: string): void {\n\tgetCanvasState(canvasKey).set(nodeId, result);\n}\n\nexport function getEdgeMode(canvasKey: string, edgeId: string): \"inject\" | \"concatenate\" | undefined {\n\t\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "export function setNodeResult(canvasKey: string, nodeId: string, result: string): void {",
            "lineNumber": 32,
            "isSignature": true
          },
          {
            "text": "\tgetCanvasState(canvasKey).set(nodeId, result);",
            "lineNumber": 33
          },
          {
            "text": "}",
            "lineNumber": 34,
            "isSignature": true
          },
          {
            "lineNumber": 35
          },
          {
            "text": "export function getEdgeMode(canvasKey: string, edgeId: string): \"inject\" | \"concatenate\" | undefined {",
            "lineNumber": 36,
            "isSignature": true
          },
          {
            "text": "\t",
            "lineNumber": 37
          },
          {
            "text": "}",
            "lineNumber": 38,
            "isSignature": true
          }
        ]
      },
      "score": 0.24708400666713715
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 530,
            "column": 1
          },
          "endPosition": {
            "line": 592,
            "column": 1
          }
        },
        "contents": "const CYCLE_ERROR_MESSAGE = \"Execution graph contains a cycle; fix connections and try again.\";\n\n/** Run all nodes reachable from any root, in topological order. */\nexport async function runEntireCanvas(\n\tapp: App,\n\tsettings: ZettelPluginSettings,\n\tcanvasFilePath: string,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;{ ok: boolean; message?: string }&gt; {\n\tconst data = await loadCanvasData(app.vault, canvasFilePath);\n\tif (!data) return { ok: false, message: \"Could not load canvas data.\" };\n\tconst topo = topologicalOrderFull(data, settings);\n\tif (\"cycle\" in topo) return { ok: false, message: CYCLE_ERROR_MESSAGE };\n\tconst order = topo.order;\n\tconst canvasKey = getCanvasKey(canvasFilePath);\n\ttry {\n\t\tfor (const nid of order) {\n\t\t\ttry {\n\t\t\t\tsetRunningNodeId(canvasKey, nid);\n\t\t\t\tawait runSingleNode(app, settings, canvasKey, canvasFilePath, data, nid, liveCanvas);\n\t\t\t} finally {\n\t\t\t\tsetRunningNodeId(canvasKey, null);\n\t\t\t}\n\t\t}\n\t\treturn { ok: true };\n\t} catch (e) {\n\t\treturn { ok: false, message: e instanceof Error ? e.message : String(e) };\n\t}\n}\n\n/** Run chain from roots to the given node. */\nexport async function runChain(\n\tapp: App,\n\tsettings: ZettelPluginSettings,\n\tcanvasFilePath: string,\n\tnodeId: string,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;{ ok: boolean; message?: string }&gt; {\n\t\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "const CYCLE_ERROR_MESSAGE = \"Execution graph contains a cycle; fix connections and try again.\";",
            "lineNumber": 533
          },
          {
            "lineNumber": 534
          },
          {
            "text": "/** Run all nodes reachable from any root, in topological order. */",
            "lineNumber": 535
          },
          {
            "text": "export async function runEntireCanvas(",
            "lineNumber": 536,
            "isSignature": true
          },
          {
            "text": "\tapp: App,",
            "lineNumber": 537,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 538,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 539,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 540,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;{ ok: boolean; message?: string }&gt; {",
            "lineNumber": 541,
            "isSignature": true
          },
          {
            "text": "\tconst data = await loadCanvasData(app.vault, canvasFilePath);",
            "lineNumber": 542
          },
          {
            "text": "\tif (!data) return { ok: false, message: \"Could not load canvas data.\" };",
            "lineNumber": 543
          },
          {
            "text": "\tconst topo = topologicalOrderFull(data, settings);",
            "lineNumber": 544
          },
          {
            "text": "\tif (\"cycle\" in topo) return { ok: false, message: CYCLE_ERROR_MESSAGE };",
            "lineNumber": 545
          },
          {
            "text": "\tconst order = topo.order;",
            "lineNumber": 546
          },
          {
            "text": "\tconst canvasKey = getCanvasKey(canvasFilePath);",
            "lineNumber": 547
          },
          {
            "text": "\ttry {",
            "lineNumber": 548
          },
          {
            "text": "\t\tfor (const nid of order) {",
            "lineNumber": 549
          },
          {
            "text": "\t\t\ttry {",
            "lineNumber": 550
          },
          {
            "text": "\t\t\t\tsetRunningNodeId(canvasKey, nid);",
            "lineNumber": 551
          },
          {
            "text": "\t\t\t\tawait runSingleNode(app, settings, canvasKey, canvasFilePath, data, nid, liveCanvas);",
            "lineNumber": 552
          },
          {
            "text": "\t\t\t} finally {",
            "lineNumber": 553
          },
          {
            "text": "\t\t\t\tsetRunningNodeId(canvasKey, null);",
            "lineNumber": 554
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 555
          },
          {
            "text": "\t\t}",
            "lineNumber": 556
          },
          {
            "text": "\t\treturn { ok: true };",
            "lineNumber": 557
          },
          {
            "text": "\t} catch (e) {",
            "lineNumber": 558
          },
          {
            "text": "\t\treturn { ok: false, message: e instanceof Error ? e.message : String(e) };",
            "lineNumber": 559
          },
          {
            "text": "\t}",
            "lineNumber": 560
          },
          {
            "text": "}",
            "lineNumber": 561,
            "isSignature": true
          },
          {
            "lineNumber": 562
          },
          {
            "text": "/** Run chain from roots to the given node. */",
            "lineNumber": 563
          },
          {
            "text": "export async function runChain(",
            "lineNumber": 564,
            "isSignature": true
          },
          {
            "text": "\tapp: App,",
            "lineNumber": 565,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 566,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 567,
            "isSignature": true
          },
          {
            "text": "\tnodeId: string,",
            "lineNumber": 568,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 569,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;{ ok: boolean; message?: string }&gt; {",
            "lineNumber": 570,
            "isSignature": true
          },
          {
            "text": "\t",
            "lineNumber": 571
          },
          {
            "text": "}",
            "lineNumber": 593,
            "isSignature": true
          }
        ]
      },
      "score": 0.2440517544746399
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 592,
            "column": 1
          },
          "endPosition": {
            "line": 616,
            "column": 98
          }
        },
        "contents": "/** Remove the Green output node and its output edge for a given source node; mutates data and saves. */\nexport async function dismissOutput(\n\tvault: App[\"vault\"],\n\tcanvasFilePath: string,\n\tsourceNodeId: string,\n\tsettings: ZettelPluginSettings,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;void&gt; {\n\tconst data = await loadCanvasData(vault, canvasFilePath);\n\tif (!data) return;\n\tconst outId = findOutputNodeForSource(data, sourceNodeId, settings);\n\tif (!outId) return;\n\tdata.nodes = data.nodes.filter((n) =&gt; n.id !== outId);\n\tdata.edges = data.edges.filter(\n\t\t(e) =&gt; !(e.fromNode === sourceNodeId &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT)\n\t);\n\tliveCanvas?.setData?.(data);\n\tif (liveCanvas?.requestSave) liveCanvas.requestSave();\n\tconst saved = await saveCanvasData(vault, canvasFilePath, data);\n\tif (!saved) new Notice(\"Failed to save canvas.\");\n}\n\n/** Remove all Green output nodes and their output edges on the canvas; mutates data and saves. */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Remove the Green output node and its output edge for a given source node; mutates data and saves. */",
            "lineNumber": 595
          },
          {
            "text": "export async function dismissOutput(",
            "lineNumber": 596,
            "isSignature": true
          },
          {
            "text": "\tvault: App[\"vault\"],",
            "lineNumber": 597,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 598,
            "isSignature": true
          },
          {
            "text": "\tsourceNodeId: string,",
            "lineNumber": 599,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 600,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 601,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;void&gt; {",
            "lineNumber": 602,
            "isSignature": true
          },
          {
            "text": "\tconst data = await loadCanvasData(vault, canvasFilePath);",
            "lineNumber": 603
          },
          {
            "text": "\tif (!data) return;",
            "lineNumber": 604
          },
          {
            "text": "\tconst outId = findOutputNodeForSource(data, sourceNodeId, settings);",
            "lineNumber": 605
          },
          {
            "text": "\tif (!outId) return;",
            "lineNumber": 606
          },
          {
            "text": "\tdata.nodes = data.nodes.filter((n) =&gt; n.id !== outId);",
            "lineNumber": 607
          },
          {
            "text": "\tdata.edges = data.edges.filter(",
            "lineNumber": 608
          },
          {
            "text": "\t\t(e) =&gt; !(e.fromNode === sourceNodeId &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT)",
            "lineNumber": 609
          },
          {
            "text": "\t);",
            "lineNumber": 610
          },
          {
            "text": "\tliveCanvas?.setData?.(data);",
            "lineNumber": 611
          },
          {
            "text": "\tif (liveCanvas?.requestSave) liveCanvas.requestSave();",
            "lineNumber": 612
          },
          {
            "text": "\tconst saved = await saveCanvasData(vault, canvasFilePath, data);",
            "lineNumber": 613
          },
          {
            "text": "\tif (!saved) new Notice(\"Failed to save canvas.\");",
            "lineNumber": 614
          },
          {
            "text": "}",
            "lineNumber": 615,
            "isSignature": true
          },
          {
            "lineNumber": 616
          },
          {
            "text": "/** Remove all Green output nodes and their output edges on the canvas; mutates data and saves. */",
            "lineNumber": 617
          }
        ]
      },
      "score": 0.2427884340286255
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/types.ts",
        "range": {
          "startPosition": {
            "line": 75,
            "column": 1
          },
          "endPosition": {
            "line": 95,
            "column": 1
          }
        },
        "contents": "/** Get parent node IDs for a node, sorted by y (top to bottom). Excludes output edges. */\nexport function getParentIdsSortedByY(nodeId: string, data: CanvasData): string[] {\n\tconst edges = data.edges.filter((e) =&gt; e.toNode === nodeId &amp;&amp; !isOutputEdge(e));\n\tconst fromIds = [...new Set(edges.map((e) =&gt; e.fromNode))];\n\tconst nodeMap = new Map(data.nodes.map((n) =&gt; [n.id, n]));\n\tconst withY = fromIds\n\t\t.map((id) =&gt; {\n\t\t\tconst node = nodeMap.get(id);\n\t\t\treturn node ? { id, y: node.y } : null;\n\t\t})\n\t\t.filter((x): x is { id: string; y: number } =&gt; x != null);\n\twithY.sort((a, b) =&gt; a.y - b.y);\n\treturn withY.map((x) =&gt; x.id);\n}\n\n/** Get node by id from canvas data. */\nexport function getNodeById(data: CanvasData, id: string): AllCanvasNodeData | undefined {\n\t\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Get parent node IDs for a node, sorted by y (top to bottom). Excludes output edges. */",
            "lineNumber": 78
          },
          {
            "text": "export function getParentIdsSortedByY(nodeId: string, data: CanvasData): string[] {",
            "lineNumber": 79,
            "isSignature": true
          },
          {
            "text": "\tconst edges = data.edges.filter((e) =&gt; e.toNode === nodeId &amp;&amp; !isOutputEdge(e));",
            "lineNumber": 80
          },
          {
            "text": "\tconst fromIds = [...new Set(edges.map((e) =&gt; e.fromNode))];",
            "lineNumber": 81
          },
          {
            "text": "\tconst nodeMap = new Map(data.nodes.map((n) =&gt; [n.id, n]));",
            "lineNumber": 82
          },
          {
            "text": "\tconst withY = fromIds",
            "lineNumber": 83
          },
          {
            "text": "\t\t.map((id) =&gt; {",
            "lineNumber": 84
          },
          {
            "text": "\t\t\tconst node = nodeMap.get(id);",
            "lineNumber": 85
          },
          {
            "text": "\t\t\treturn node ? { id, y: node.y } : null;",
            "lineNumber": 86
          },
          {
            "text": "\t\t})",
            "lineNumber": 87
          },
          {
            "text": "\t\t.filter((x): x is { id: string; y: number } =&gt; x != null);",
            "lineNumber": 88
          },
          {
            "text": "\twithY.sort((a, b) =&gt; a.y - b.y);",
            "lineNumber": 89
          },
          {
            "text": "\treturn withY.map((x) =&gt; x.id);",
            "lineNumber": 90
          },
          {
            "text": "}",
            "lineNumber": 91,
            "isSignature": true
          },
          {
            "lineNumber": 92
          },
          {
            "text": "/** Get node by id from canvas data. */",
            "lineNumber": 93
          },
          {
            "text": "export function getNodeById(data: CanvasData, id: string): AllCanvasNodeData | undefined {",
            "lineNumber": 94,
            "isSignature": true
          },
          {
            "text": "\t",
            "lineNumber": 95
          },
          {
            "text": "}",
            "lineNumber": 96,
            "isSignature": true
          }
        ]
      },
      "score": 0.23884207010269165
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 251,
            "column": 1
          },
          "endPosition": {
            "line": 346,
            "column": 1
          }
        },
        "contents": "/** Run a single node: get input + parent context (concatenate or {{var:name}}), call LLM or Python, store result. */\nasync function runSingleNode(\n\tapp: App,\n\tsettings: ZettelPluginSettings,\n\tcanvasKey: string,\n\tcanvasFilePath: string,\n\tdata: CanvasData,\n\tnodeId: string,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;string&gt; {\n\tconst node = getNodeById(data, nodeId);\n\tif (!node) return \"\";\n\tconst role = getNodeRole(node, settings);\n\tif (!role || role === \"yellow\" || role === \"green\") {\n\t\t// Yellow = text (input pass-through): use node content as result\n\t\tif (role === \"yellow\") {\n\t\t\tconst content = await getNodeContent(node, app.vault);\n\t\t\tsetNodeResult(canvasKey, nodeId, content);\n\t\t\treturn content;\n\t\t}\n\t\treturn \"\";\n\t}\n\t// For Python (blue) text nodes, auto-wrap content in &#96;&#96;&#96;python ... &#96;&#96;&#96; so # comments render correctly\n\tif (role === \"blue\" &amp;&amp; isTextNode(node)) {\n\t\tconst raw = getTextNodeContent(node as CanvasTextData);\n\t\tif (!isPythonCodeFenced(raw)) {\n\t\t\t(node as CanvasTextData).text = ensurePythonCodeFence(raw);\n\t\t\tliveCanvas?.setData?.(data);\n\t\t\tawait saveCanvasData(app.vault, canvasFilePath, data);\n\t\t}\n\t}\n\tconst incoming = getIncomingEdgesWithLabels(nodeId, data);\n\tconst nodeInput = await getNodeContent(node, app.vault);\n\tconst { concatenatedPart, template, edgeModes } = buildInputWithVariables(\n\t\tcanvasKey,\n\t\tnodeInput,\n\t\tincoming\n\t);\n\tconst fullPrompt =\n\t\tconcatenatedPart.length &gt; 0 ? &#96;${concatenatedPart}\\n\\n---\\n\\n${template}&#96; : template;\n\n\tif (role === \"orange\") {\n\t\tconst model = settings.ollamaOrangeModel || \"llama2\";\n\t\tconst temperature = settings.ollamaOrangeTemperature ?? DEFAULT_SETTINGS.ollamaOrangeTemperature;\n\t\tconst result = await ollamaGenerate({\n\t\t\tmodel,\n\t\t\tprompt: fullPrompt,\n\t\t\tstream: false,\n\t\t\toptions: { temperature },\n\t\t});\n\t\tsetNodeResult(canvasKey, nodeId, result);\n\t\tensureOutputNodeAndEdge(data, node, result, settings);\n\t\tawait updateEdgeLabelsAndSave(app.vault, canvasFilePath, data, nodeId, edgeModes, liveCanvas);\n\t\treturn result;\n\t}\n\tif (role === \"purple\") {\n\t\tconst model = settings.ollamaPurpleModel || \"llama2\";\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Run a single node: get input + parent context (concatenate or {{var:name}}), call LLM or Python, store result. */",
            "lineNumber": 254
          },
          {
            "text": "async function runSingleNode(",
            "lineNumber": 255,
            "isSignature": true
          },
          {
            "text": "\tapp: App,",
            "lineNumber": 256,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 257,
            "isSignature": true
          },
          {
            "text": "\tcanvasKey: string,",
            "lineNumber": 258,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 259,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 260,
            "isSignature": true
          },
          {
            "text": "\tnodeId: string,",
            "lineNumber": 261,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 262,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;string&gt; {",
            "lineNumber": 263,
            "isSignature": true
          },
          {
            "text": "\tconst node = getNodeById(data, nodeId);",
            "lineNumber": 264
          },
          {
            "text": "\tif (!node) return \"\";",
            "lineNumber": 265
          },
          {
            "text": "\tconst role = getNodeRole(node, settings);",
            "lineNumber": 266
          },
          {
            "text": "\tif (!role || role === \"yellow\" || role === \"green\") {",
            "lineNumber": 267
          },
          {
            "text": "\t\t// Yellow = text (input pass-through): use node content as result",
            "lineNumber": 268
          },
          {
            "text": "\t\tif (role === \"yellow\") {",
            "lineNumber": 269
          },
          {
            "text": "\t\t\tconst content = await getNodeContent(node, app.vault);",
            "lineNumber": 270
          },
          {
            "text": "\t\t\tsetNodeResult(canvasKey, nodeId, content);",
            "lineNumber": 271
          },
          {
            "text": "\t\t\treturn content;",
            "lineNumber": 272
          },
          {
            "text": "\t\t}",
            "lineNumber": 273
          },
          {
            "text": "\t\treturn \"\";",
            "lineNumber": 274
          },
          {
            "text": "\t}",
            "lineNumber": 275
          },
          {
            "text": "\t// For Python (blue) text nodes, auto-wrap content in &#96;&#96;&#96;python ... &#96;&#96;&#96; so # comments render correctly",
            "lineNumber": 276
          },
          {
            "text": "\tif (role === \"blue\" &amp;&amp; isTextNode(node)) {",
            "lineNumber": 277
          },
          {
            "text": "\t\tconst raw = getTextNodeContent(node as CanvasTextData);",
            "lineNumber": 278
          },
          {
            "text": "\t\tif (!isPythonCodeFenced(raw)) {",
            "lineNumber": 279
          },
          {
            "text": "\t\t\t(node as CanvasTextData).text = ensurePythonCodeFence(raw);",
            "lineNumber": 280
          },
          {
            "text": "\t\t\tliveCanvas?.setData?.(data);",
            "lineNumber": 281
          },
          {
            "text": "\t\t\tawait saveCanvasData(app.vault, canvasFilePath, data);",
            "lineNumber": 282
          },
          {
            "text": "\t\t}",
            "lineNumber": 283
          },
          {
            "text": "\t}",
            "lineNumber": 284
          },
          {
            "text": "\tconst incoming = getIncomingEdgesWithLabels(nodeId, data);",
            "lineNumber": 285
          },
          {
            "text": "\tconst nodeInput = await getNodeContent(node, app.vault);",
            "lineNumber": 286
          },
          {
            "text": "\tconst { concatenatedPart, template, edgeModes } = buildInputWithVariables(",
            "lineNumber": 287
          },
          {
            "text": "\t\tcanvasKey,",
            "lineNumber": 288
          },
          {
            "text": "\t\tnodeInput,",
            "lineNumber": 289
          },
          {
            "text": "\t\tincoming",
            "lineNumber": 290
          },
          {
            "text": "\t);",
            "lineNumber": 291
          },
          {
            "text": "\tconst fullPrompt =",
            "lineNumber": 292
          },
          {
            "text": "\t\tconcatenatedPart.length &gt; 0 ? &#96;${concatenatedPart}\\n\\n---\\n\\n${template}&#96; : template;",
            "lineNumber": 293
          },
          {
            "lineNumber": 294
          },
          {
            "text": "\tif (role === \"orange\") {",
            "lineNumber": 295
          },
          {
            "text": "\t\tconst model = settings.ollamaOrangeModel || \"llama2\";",
            "lineNumber": 296
          },
          {
            "text": "\t\tconst temperature = settings.ollamaOrangeTemperature ?? DEFAULT_SETTINGS.ollamaOrangeTemperature;",
            "lineNumber": 297
          },
          {
            "text": "\t\tconst result = await ollamaGenerate({",
            "lineNumber": 298
          },
          {
            "text": "\t\t\tmodel,",
            "lineNumber": 299
          },
          {
            "text": "\t\t\tprompt: fullPrompt,",
            "lineNumber": 300
          },
          {
            "text": "\t\t\tstream: false,",
            "lineNumber": 301
          },
          {
            "text": "\t\t\toptions: { temperature },",
            "lineNumber": 302
          },
          {
            "text": "\t\t});",
            "lineNumber": 303
          },
          {
            "text": "\t\tsetNodeResult(canvasKey, nodeId, result);",
            "lineNumber": 304
          },
          {
            "text": "\t\tensureOutputNodeAndEdge(data, node, result, settings);",
            "lineNumber": 305
          },
          {
            "text": "\t\tawait updateEdgeLabelsAndSave(app.vault, canvasFilePath, data, nodeId, edgeModes, liveCanvas);",
            "lineNumber": 306
          },
          {
            "text": "\t\treturn result;",
            "lineNumber": 307
          },
          {
            "text": "\t}",
            "lineNumber": 308
          },
          {
            "text": "\tif (role === \"purple\") {",
            "lineNumber": 309
          },
          {
            "text": "\t\tconst model = settings.ollamaPurpleModel || \"llama2\";",
            "lineNumber": 310
          },
          {
            "text": "}",
            "lineNumber": 347,
            "isSignature": true
          }
        ]
      },
      "score": 0.23833686113357544
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 313,
            "column": 1
          },
          "endPosition": {
            "line": 326,
            "column": 108
          }
        },
        "contents": "/** Resolve canvas node id from context-menu payload (shape may vary by Obsidian version). */\nfunction resolveCanvasNodeId(node: unknown): string | undefined {\n\tif (!node || typeof node !== \"object\") return undefined;\n\tconst n = node as Record&lt;string, unknown&gt;;\n\tif (typeof n.id === \"string\") return n.id;\n\tconst inner = n.node as Record&lt;string, unknown&gt; | undefined;\n\tif (inner &amp;&amp; typeof inner.id === \"string\") return inner.id;\n\tconst data = typeof n.getData === \"function\" ? (n.getData as () =&gt; { id?: string })() : undefined;\n\treturn data?.id;\n}\n\n/** Debug: set to true when canvas:node-menu callback has fired at least once (proves event is received). */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Resolve canvas node id from context-menu payload (shape may vary by Obsidian version). */",
            "lineNumber": 316
          },
          {
            "text": "function resolveCanvasNodeId(node: unknown): string | undefined {",
            "lineNumber": 317,
            "isSignature": true
          },
          {
            "text": "\tif (!node || typeof node !== \"object\") return undefined;",
            "lineNumber": 318
          },
          {
            "text": "\tconst n = node as Record&lt;string, unknown&gt;;",
            "lineNumber": 319
          },
          {
            "text": "\tif (typeof n.id === \"string\") return n.id;",
            "lineNumber": 320
          },
          {
            "text": "\tconst inner = n.node as Record&lt;string, unknown&gt; | undefined;",
            "lineNumber": 321
          },
          {
            "text": "\tif (inner &amp;&amp; typeof inner.id === \"string\") return inner.id;",
            "lineNumber": 322
          },
          {
            "text": "\tconst data = typeof n.getData === \"function\" ? (n.getData as () =&gt; { id?: string })() : undefined;",
            "lineNumber": 323
          },
          {
            "text": "\treturn data?.id;",
            "lineNumber": 324
          },
          {
            "text": "}",
            "lineNumber": 325,
            "isSignature": true
          },
          {
            "lineNumber": 326
          },
          {
            "text": "/** Debug: set to true when canvas:node-menu callback has fired at least once (proves event is received). */",
            "lineNumber": 327
          }
        ]
      },
      "score": 0.2330683469772339
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 32,
            "column": 109
          }
        },
        "contents": "import type {App} from \"obsidian\";\nimport {Notice} from \"obsidian\";\nimport {\n\tEDGE_LABEL_OUTPUT,\n\tfindOutputNodeForSource,\n\tgetNodeById,\n\tgetNodeContent,\n\tgetNodeRole,\n\tgetIncomingEdgesWithLabels,\n\tgetParentIdsSortedByY,\n\tGREEN_NODE_PADDING,\n\tisOutputEdge,\n\tloadCanvasData,\n\tsaveCanvasData,\n} from \"../canvas/nodes\";\nimport type {AllCanvasNodeData, CanvasData, CanvasEdgeData, CanvasTextData} from \"../canvas/types\";\nimport { getTextNodeContent, parseEdgeVariableName } from \"../canvas/types\";\nimport {isTextNode} from \"../canvas/types\";\nimport type {LiveCanvas} from \"./canvasApi\";\nimport {getKernelForCanvas} from \"./kernelManager\";\nimport {ollamaGenerate} from \"./ollama\";\nimport {\n\tgetCanvasKey,\n\tgetNodeResult,\n\tsetNodeResult,\n\tsetEdgeModes,\n\tsetRunningNodeId,\n} from \"./state\";\nimport {DEFAULT_SETTINGS, type NodeRole, type ZettelPluginSettings} from \"../settings\";\n\ntype EdgeInputMode = \"inject\" | \"concatenate\";\n\n/** True if the role is non-AI (Python or text pass-through); prefer running these first for early output. */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "import type {App} from \"obsidian\";",
            "lineNumber": 1
          },
          {
            "text": "import {Notice} from \"obsidian\";",
            "lineNumber": 2
          },
          {
            "text": "import {",
            "lineNumber": 3
          },
          {
            "text": "\tEDGE_LABEL_OUTPUT,",
            "lineNumber": 4
          },
          {
            "text": "\tfindOutputNodeForSource,",
            "lineNumber": 5
          },
          {
            "text": "\tgetNodeById,",
            "lineNumber": 6
          },
          {
            "text": "\tgetNodeContent,",
            "lineNumber": 7
          },
          {
            "text": "\tgetNodeRole,",
            "lineNumber": 8
          },
          {
            "text": "\tgetIncomingEdgesWithLabels,",
            "lineNumber": 9
          },
          {
            "text": "\tgetParentIdsSortedByY,",
            "lineNumber": 10
          },
          {
            "text": "\tGREEN_NODE_PADDING,",
            "lineNumber": 11
          },
          {
            "text": "\tisOutputEdge,",
            "lineNumber": 12
          },
          {
            "text": "\tloadCanvasData,",
            "lineNumber": 13
          },
          {
            "text": "\tsaveCanvasData,",
            "lineNumber": 14
          },
          {
            "text": "} from \"../canvas/nodes\";",
            "lineNumber": 15
          },
          {
            "text": "import type {AllCanvasNodeData, CanvasData, CanvasEdgeData, CanvasTextData} from \"../canvas/types\";",
            "lineNumber": 16
          },
          {
            "text": "import { getTextNodeContent, parseEdgeVariableName } from \"../canvas/types\";",
            "lineNumber": 17
          },
          {
            "text": "import {isTextNode} from \"../canvas/types\";",
            "lineNumber": 18
          },
          {
            "text": "import type {LiveCanvas} from \"./canvasApi\";",
            "lineNumber": 19
          },
          {
            "text": "import {getKernelForCanvas} from \"./kernelManager\";",
            "lineNumber": 20
          },
          {
            "text": "import {ollamaGenerate} from \"./ollama\";",
            "lineNumber": 21
          },
          {
            "text": "import {",
            "lineNumber": 22
          },
          {
            "text": "\tgetCanvasKey,",
            "lineNumber": 23
          },
          {
            "text": "\tgetNodeResult,",
            "lineNumber": 24
          },
          {
            "text": "\tsetNodeResult,",
            "lineNumber": 25
          },
          {
            "text": "\tsetEdgeModes,",
            "lineNumber": 26
          },
          {
            "text": "\tsetRunningNodeId,",
            "lineNumber": 27
          },
          {
            "text": "} from \"./state\";",
            "lineNumber": 28
          },
          {
            "text": "import {DEFAULT_SETTINGS, type NodeRole, type ZettelPluginSettings} from \"../settings\";",
            "lineNumber": 29
          },
          {
            "lineNumber": 30
          },
          {
            "text": "type EdgeInputMode = \"inject\" | \"concatenate\";",
            "lineNumber": 31,
            "isSignature": true
          },
          {
            "lineNumber": 32
          },
          {
            "text": "/** True if the role is non-AI (Python or text pass-through); prefer running these first for early output. */",
            "lineNumber": 33
          }
        ]
      },
      "score": 0.23015369474887848
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 614,
            "column": 1
          },
          "endPosition": {
            "line": 635,
            "column": 1
          }
        },
        "contents": "/** Remove all Green output nodes and their output edges on the canvas; mutates data and saves. */\nexport async function dismissAllOutput(\n\tvault: App[\"vault\"],\n\tcanvasFilePath: string,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;void&gt; {\n\tconst data = await loadCanvasData(vault, canvasFilePath);\n\tif (!data) return;\n\tconst outputNodeIds = new Set(\n\t\tdata.edges\n\t\t\t.filter((e) =&gt; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT)\n\t\t\t.map((e) =&gt; e.toNode)\n\t);\n\tdata.nodes = data.nodes.filter((n) =&gt; !outputNodeIds.has(n.id));\n\tdata.edges = data.edges.filter((e) =&gt; parseEdgeVariableName(e.label) !== EDGE_LABEL_OUTPUT);\n\tliveCanvas?.setData?.(data);\n\tif (liveCanvas?.requestSave) liveCanvas.requestSave();\n\tconst saved = await saveCanvasData(vault, canvasFilePath, data);\n\tif (!saved) new Notice(\"Failed to save canvas.\");\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Remove all Green output nodes and their output edges on the canvas; mutates data and saves. */",
            "lineNumber": 617
          },
          {
            "text": "export async function dismissAllOutput(",
            "lineNumber": 618,
            "isSignature": true
          },
          {
            "text": "\tvault: App[\"vault\"],",
            "lineNumber": 619,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 620,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 621,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;void&gt; {",
            "lineNumber": 622,
            "isSignature": true
          },
          {
            "text": "\tconst data = await loadCanvasData(vault, canvasFilePath);",
            "lineNumber": 623
          },
          {
            "text": "\tif (!data) return;",
            "lineNumber": 624
          },
          {
            "text": "\tconst outputNodeIds = new Set(",
            "lineNumber": 625
          },
          {
            "text": "\t\tdata.edges",
            "lineNumber": 626
          },
          {
            "text": "\t\t\t.filter((e) =&gt; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT)",
            "lineNumber": 627
          },
          {
            "text": "\t\t\t.map((e) =&gt; e.toNode)",
            "lineNumber": 628
          },
          {
            "text": "\t);",
            "lineNumber": 629
          },
          {
            "text": "\tdata.nodes = data.nodes.filter((n) =&gt; !outputNodeIds.has(n.id));",
            "lineNumber": 630
          },
          {
            "text": "\tdata.edges = data.edges.filter((e) =&gt; parseEdgeVariableName(e.label) !== EDGE_LABEL_OUTPUT);",
            "lineNumber": 631
          },
          {
            "text": "\tliveCanvas?.setData?.(data);",
            "lineNumber": 632
          },
          {
            "text": "\tif (liveCanvas?.requestSave) liveCanvas.requestSave();",
            "lineNumber": 633
          },
          {
            "text": "\tconst saved = await saveCanvasData(vault, canvasFilePath, data);",
            "lineNumber": 634
          },
          {
            "text": "\tif (!saved) new Notice(\"Failed to save canvas.\");",
            "lineNumber": 635
          },
          {
            "text": "}",
            "lineNumber": 636,
            "isSignature": true
          }
        ]
      },
      "score": 0.22484445571899414
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 329
          },
          "endPosition": {
            "line": 877,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\n\n\n\t/** Run a single node (call from context menu with node id). */\n\tasync runNode(nodeId: string): Promise&lt;void&gt; {\n\t\tconst view = this.getActiveCanvasView();\n\t\tif (!view) return;\n\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;\n\t\tconst result = await runnerRunNode(this.app, this.settings, view.file.path, nodeId, liveCanvas);\n\t\tif (!result.ok) new Notice(result.message ?? \"Run node failed.\");\n\t}\n\n\t/** Run chain from roots to the given node (call from context menu with node id). */\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 330,
                "column": 1
              },
              "endPosition": {
                "line": 330,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 330,
                "column": 16
              },
              "endPosition": {
                "line": 331,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 330,
            "isSignature": true
          },
          {
            "lineNumber": 827
          },
          {
            "lineNumber": 828
          },
          {
            "text": "\t/** Run a single node (call from context menu with node id). */",
            "lineNumber": 829
          },
          {
            "text": "\tasync runNode(nodeId: string): Promise&lt;void&gt; {",
            "lineNumber": 830
          },
          {
            "text": "\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 831
          },
          {
            "text": "\t\tif (!view) return;",
            "lineNumber": 832
          },
          {
            "text": "\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;",
            "lineNumber": 833
          },
          {
            "text": "\t\tconst result = await runnerRunNode(this.app, this.settings, view.file.path, nodeId, liveCanvas);",
            "lineNumber": 834
          },
          {
            "text": "\t\tif (!result.ok) new Notice(result.message ?? \"Run node failed.\");",
            "lineNumber": 835
          },
          {
            "text": "\t}",
            "lineNumber": 836
          },
          {
            "lineNumber": 837
          },
          {
            "text": "\t/** Run chain from roots to the given node (call from context menu with node id). */",
            "lineNumber": 838
          },
          {
            "text": "}",
            "lineNumber": 878,
            "isSignature": true
          }
        ]
      },
      "score": 0.2244914025068283
    }
  ]
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "saveCanvasData|save.*canvas|canvas.*save",
  "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "saveCanvasData|save.*canvas|canvas.*save",
    "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board": {
        "content": {
          "matches": [
            {
              "file": "src/main.ts",
              "matches": [
                {
                  "lineNumber": 5,
                  "content": "import {duplicateCanvasTemplate, saveCanvasAsTemplate, isCanvasInTemplateFolder} from \"./canvas/canvasTemplates\";"
                },
                {
                  "lineNumber": 20,
                  "content": "import {hasOutputNodes, loadCanvasData, saveCanvasData} from \"./canvas/nodes\";"
                },
                {
                  "lineNumber": 362,
                  "content": "\t\t\t\tid: \"save-canvas-as-template\","
                },
                {
                  "lineNumber": 641,
                  "content": "\t\tconst saved = await saveCanvasData(vault, path, data);"
                },
                {
                  "lineNumber": 715,
                  "content": "\t\t\tnew Notice(\"Failed to save canvas as template.\");"
                }
              ]
            },
            {
              "file": "src/engine/runner.ts",
              "matches": [
                {
                  "lineNumber": 14,
                  "content": "\tsaveCanvasData,"
                },
                {
                  "lineNumber": 250,
                  "content": "\tconst saved = await saveCanvasData(vault, canvasFilePath, data);"
                },
                {
                  "lineNumber": 251,
                  "content": "\tif (!saved) new Notice(\"Failed to save canvas.\");"
                },
                {
                  "lineNumber": 282,
                  "content": "\t\t\tawait saveCanvasData(app.vault, canvasFilePath, data);"
                },
                {
                  "lineNumber": 613,
                  "content": "\tconst saved = await saveCanvasData(vault, canvasFilePath, data);"
                },
                {
                  "lineNumber": 614,
                  "content": "\tif (!saved) new Notice(\"Failed to save canvas.\");"
                },
                {
                  "lineNumber": 617,
                  "content": "/** Remove all Green output nodes and their output edges on the canvas; mutates data and saves. */"
                },
                {
                  "lineNumber": 634,
                  "content": "\tconst saved = await saveCanvasData(vault, canvasFilePath, data);"
                },
                {
                  "lineNumber": 635,
                  "content": "\tif (!saved) new Notice(\"Failed to save canvas.\");"
                }
              ]
            },
            {
              "file": "src/canvas/nodes.ts",
              "matches": [
                {
                  "lineNumber": 27,
                  "content": "export async function saveCanvasData(vault: Vault, filePath: string, data: CanvasData): Promise&lt;boolean&gt; {"
                }
              ]
            },
            {
              "file": "src/canvas/canvasTemplates.ts",
              "matches": [
                {
                  "lineNumber": 3,
                  "content": "import {loadCanvasData, saveCanvasData} from \"./nodes\";"
                },
                {
                  "lineNumber": 109,
                  "content": "\tconst success = await saveCanvasData(vault, outputPath, newCanvasData);"
                }
              ]
            },
            {
              "file": "src/engine/canvasApi.ts",
              "matches": [
                {
                  "lineNumber": 1,
                  "content": "/** Minimal interface for live canvas mutations (add text node, remove node, save). */"
                }
              ]
            }
          ],
          "totalLines": 18,
          "totalMatchedLines": 18
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>
</tool-use>

---


Checking the full `ensureOutputNodeAndEdge` logic and where canvas data is loaded vs written:


---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "setData|loadCanvasData",
  "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "setData|loadCanvasData",
    "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board": {
        "content": {
          "matches": [
            {
              "file": "src/canvas/canvasNodeLabels.ts",
              "matches": [
                {
                  "lineNumber": 2,
                  "content": "import {loadCanvasData} from \"./nodes\";"
                },
                {
                  "lineNumber": 153,
                  "content": "\tconst data = await loadCanvasData(vault, canvasFilePath);"
                },
                {
                  "lineNumber": 236,
                  "content": "\tconst data = await loadCanvasData(vault, canvasFilePath);"
                }
              ]
            },
            {
              "file": "src/main.ts",
              "matches": [
                {
                  "lineNumber": 20,
                  "content": "import {hasOutputNodes, loadCanvasData, saveCanvasData} from \"./canvas/nodes\";"
                },
                {
                  "lineNumber": 506,
                  "content": "\t\t\t\t\t\t\t\tconst data = await loadCanvasData(this.app.vault, path);"
                }
              ]
            },
            {
              "file": "src/engine/runner.ts",
              "matches": [
                {
                  "lineNumber": 13,
                  "content": "\tloadCanvasData,"
                },
                {
                  "lineNumber": 249,
                  "content": "\tliveCanvas?.setData?.(data);"
                },
                {
                  "lineNumber": 281,
                  "content": "\t\t\tliveCanvas?.setData?.(data);"
                },
                {
                  "lineNumber": 508,
                  "content": "\tconst data = await loadCanvasData(app.vault, canvasFilePath);"
                },
                {
                  "lineNumber": 542,
                  "content": "\tconst data = await loadCanvasData(app.vault, canvasFilePath);"
                },
                {
                  "lineNumber": 571,
                  "content": "\tconst data = await loadCanvasData(app.vault, canvasFilePath);"
                },
                {
                  "lineNumber": 603,
                  "content": "\tconst data = await loadCanvasData(vault, canvasFilePath);"
                },
                {
                  "lineNumber": 611,
                  "content": "\tliveCanvas?.setData?.(data);"
                },
                {
                  "lineNumber": 623,
                  "content": "\tconst data = await loadCanvasData(vault, canvasFilePath);"
                },
                {
                  "lineNumber": 632,
                  "content": "\tliveCanvas?.setData?.(data);"
                }
              ]
            },
            {
              "file": "src/canvas/nodes.ts",
              "matches": [
                {
                  "lineNumber": 15,
                  "content": "export async function loadCanvasData(vault: Vault, filePath: string): Promise&lt;CanvasData | null&gt; {"
                }
              ]
            },
            {
              "file": "src/canvas/canvasTemplates.ts",
              "matches": [
                {
                  "lineNumber": 3,
                  "content": "import {loadCanvasData, saveCanvasData} from \"./nodes\";"
                },
                {
                  "lineNumber": 61,
                  "content": "\tconst sourceData = await loadCanvasData(vault, sourcePath);"
                }
              ]
            },
            {
              "file": "src/engine/canvasApi.ts",
              "matches": [
                {
                  "lineNumber": 15,
                  "content": "\tsetData?(data: unknown): void;"
                }
              ]
            }
          ],
          "totalLines": 19,
          "totalMatchedLines": 19
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---


Checking for code that could block dragging (e.g. pointer-events or green-node handling):


---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "green|pointer-events|canvas-node|\\.canvas",
  "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board",
  "glob": "*.css",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "green|pointer-events|canvas-node|\\.canvas",
    "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board": {
        "content": {
          "matches": [
            {
              "file": "./styles.css",
              "matches": [
                {
                  "lineNumber": 275,
                  "content": "/* Role label on canvas nodes: uses Obsidian's .canvas-node-label (same as file nodes) */"
                },
                {
                  "lineNumber": 276,
                  "content": ".ztb-node-role-label.canvas-node-label {"
                },
                {
                  "lineNumber": 277,
                  "content": "\tpointer-events: none;"
                },
                {
                  "lineNumber": 292,
                  "content": "\tpointer-events: none;"
                },
                {
                  "lineNumber": 324,
                  "content": "\tpointer-events: none;"
                },
                {
                  "lineNumber": 336,
                  "content": "/* Concatenated: green */"
                },
                {
                  "lineNumber": 338,
                  "content": "\tfill: var(--color-green, #22c55e);"
                },
                {
                  "lineNumber": 352,
                  "content": "\tpointer-events: none;"
                },
                {
                  "lineNumber": 367,
                  "content": "/* Output edge (run node → green node): smaller, grayed label vs variable edges */"
                },
                {
                  "lineNumber": 492,
                  "content": "\tpointer-events: none;"
                }
              ]
            },
            {
              "file": "./zettel-thinking-board/styles.css",
              "matches": [
                {
                  "lineNumber": 275,
                  "content": "/* Role label on canvas nodes: uses Obsidian's .canvas-node-label (same as file nodes) */"
                },
                {
                  "lineNumber": 276,
                  "content": ".ztb-node-role-label.canvas-node-label {"
                },
                {
                  "lineNumber": 277,
                  "content": "\tpointer-events: none;"
                },
                {
                  "lineNumber": 292,
                  "content": "\tpointer-events: none;"
                },
                {
                  "lineNumber": 324,
                  "content": "\tpointer-events: none;"
                },
                {
                  "lineNumber": 336,
                  "content": "/* Concatenated: green */"
                },
                {
                  "lineNumber": 338,
                  "content": "\tfill: var(--color-green, #22c55e);"
                },
                {
                  "lineNumber": 352,
                  "content": "\tpointer-events: none;"
                },
                {
                  "lineNumber": 367,
                  "content": "/* Output edge (run node → green node): smaller, grayed label vs variable edges */"
                },
                {
                  "lineNumber": 492,
                  "content": "\tpointer-events: none;"
                }
              ]
            }
          ],
          "totalLines": 20,
          "totalMatchedLines": 20
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>
</tool-use>

---


Forming hypotheses and adding instrumentation to verify them.


---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [-] Add debug logs to test hypotheses for output node position not moving
- [ ] User reproduces bug; analyze logs and fix with evidence
- [ ] Verify fix with post-fix logs; remove instrumentation after confirmation

</details>
</tool-use>

---


Listing hypotheses and adding instrumentation:

- H1 — Overwrite on run: When an output node already exists, `ensureOutputNodeAndEdge` always sets `x: chosenX`, `y: chosenY`, overwriting the node's current position (from file or UI) every time Run Node/Run Chain runs.
- H2 — Load has user position: Data loaded from file contains the output node's user-moved position, but we overwrite it in memory before saving.
- H3 — New vs existing: New output nodes get chosen position; existing nodes should keep their current position but we overwrite them.
- H4 — setData overwrites: After run we call `setData(data)`, pushing the overwritten position to the live canvas and discarding any in-memory drag that hadn't been saved.
- H5 — Drag not persisted: Obsidian never persists output node position (e.g. save not triggered or we overwrite before Obsidian saves). Less likely if other nodes move.

Adding focused instrumentation in `ensureOutputNodeAndEdge` and at run start (after load) to log existing vs chosen positions and branch (new vs existing).


---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** • Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** • Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>

</tool-use>

---


Adding a log after loading canvas data to record output nodes' positions when loaded from file:


---

The string to replace was not found in the file.

---





---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** • Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>

</tool-use>

---





---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "parseEdgeVariableName",
  "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "parseEdgeVariableName",
    "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board": {
        "content": {
          "matches": [
            {
              "file": "src/engine/runner.ts",
              "matches": [
                {
                  "lineNumber": 17,
                  "content": "import { getTextNodeContent, parseEdgeVariableName } from \"../canvas/types\";"
                },
                {
                  "lineNumber": 240,
                  "content": "\t\tconst baseName = parseEdgeVariableName(edge.label);"
                },
                {
                  "lineNumber": 485,
                  "content": "\t\t\t(e) =&gt; e.fromNode === sourceNode.id &amp;&amp; e.toNode === outId &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT"
                },
                {
                  "lineNumber": 544,
                  "content": "\t\t.filter((n) =&gt; data.edges.some((e) =&gt; e.toNode === n.id &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT))"
                },
                {
                  "lineNumber": 658,
                  "content": "\t\t(e) =&gt; !(e.fromNode === sourceNodeId &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT)"
                },
                {
                  "lineNumber": 676,
                  "content": "\t\t\t.filter((e) =&gt; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT)"
                },
                {
                  "lineNumber": 680,
                  "content": "\tdata.edges = data.edges.filter((e) =&gt; parseEdgeVariableName(e.label) !== EDGE_LABEL_OUTPUT);"
                }
              ]
            }
          ],
          "totalLines": 7,
          "totalMatchedLines": 7
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="read_lints">
<details>
<summary>Tool use: **read_lints**</summary>


Parameters:

```json
{
  "paths": [
    "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts"
  ]
}
```
Result:

```json
{
  "linterErrorsByFile": [
    {
      "relativeWorkspacePath": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts"
    }
  ]
}
```
Status: **completed**


</details>
</tool-use>

---





---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "EDGE_LABEL_OUTPUT",
  "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "EDGE_LABEL_OUTPUT",
    "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board": {
        "content": {
          "matches": [
            {
              "file": "src/engine/runner.ts",
              "matches": [
                {
                  "lineNumber": 4,
                  "content": "\tEDGE_LABEL_OUTPUT,"
                },
                {
                  "lineNumber": 485,
                  "content": "\t\t\t(e) =&gt; e.fromNode === sourceNode.id &amp;&amp; e.toNode === outId &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT"
                },
                {
                  "lineNumber": 492,
                  "content": "\t\t\t\tlabel: EDGE_LABEL_OUTPUT,"
                },
                {
                  "lineNumber": 528,
                  "content": "\t\tlabel: EDGE_LABEL_OUTPUT,"
                },
                {
                  "lineNumber": 544,
                  "content": "\t\t.filter((n) =&gt; data.edges.some((e) =&gt; e.toNode === n.id &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT))"
                },
                {
                  "lineNumber": 658,
                  "content": "\t\t(e) =&gt; !(e.fromNode === sourceNodeId &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT)"
                },
                {
                  "lineNumber": 676,
                  "content": "\t\t\t.filter((e) =&gt; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT)"
                },
                {
                  "lineNumber": 680,
                  "content": "\tdata.edges = data.edges.filter((e) =&gt; parseEdgeVariableName(e.label) !== EDGE_LABEL_OUTPUT);"
                }
              ]
            }
          ],
          "totalLines": 8,
          "totalMatchedLines": 8
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---


Clearing the log file and preparing reproduction steps.


---

File not found: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/.cursor/debug.log

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Add debug logs to test hypotheses for output node position not moving
- [-] User reproduces bug; analyze logs and fix with evidence
- [ ] Verify fix with post-fix logs; remove instrumentation after confirmation

</details>
</tool-use>

---


Instrumentation is in place to test why the output node position doesn’t stick. Here’s what was added and what to do next.

**Hypotheses being tested**

1. **H1**: When an output node already exists, `ensureOutputNodeAndEdge` overwrites its `x`/`y` with the auto-chosen position on every Run Node/Run Chain, so a user-moved position is lost.
2. **H2**: The data loaded from the canvas file does contain the output node’s current (moved) position, but we overwrite it in memory and then save.
3. **H3**: New output nodes correctly get the chosen position; the bug is only that we overwrite existing output nodes’ positions.

**What was instrumented**

- **runner.ts**  
  - When updating an **existing** output node: log `existingX`, `existingY`, `chosenX`, `chosenY`, and that we overwrite (H1).  
  - When creating a **new** output node: log `chosenX`, `chosenY` (H3).  
  - In **runNode**, right after loading canvas data: log all output nodes’ positions as loaded from file (H2).

**What you need to do**

1. Rebuild the plugin: run `npm run build` in the plugin folder.
2. Restart or reload Obsidian so the new build is loaded.
3. Open a canvas that has at least one runnable node (e.g. Prompt) and an existing green output node (from a previous run).
4. Move the green output node to a new position (drag it).
5. Run the node again (e.g. right‑click the source node → “Run node”, or use the command that runs that node).
6. Check whether the output node jumps back to its old position (bug) or stays where you put it.
7. Click **Proceed** in the debug UI so the next step can run with your reproduction.

After you do this, the logs will show whether we’re overwriting the output node’s position on run (H1), whether the file had the moved position (H2), and that the overwrite only happens for existing nodes (H3). I’ll use that to apply a fix and then we’ll verify with a second run before removing the logs.

<reproduction_steps>
1. Run `npm run build` in the plugin directory.
2. Reload Obsidian (or restart it) so the updated plugin is loaded.
3. Open a canvas that has a runnable node (e.g. Prompt) and an existing green output node.
4. Drag the green output node to a different position.
5. Run the node again (e.g. right‑click the source node → “Run node”).
6. Observe whether the output node snaps back to its previous position.
7. Click **Proceed** in the debug UI when done.
</reproduction_steps>

---

_**User**_

It seems like I can move the green output notes if the plugin is not enabled. But if I click run everything and the green output notes are produced by the plugin, I am unable to move them at all. 

---

_**Agent (model default, mode Agent)**_


Investigating why green output nodes created by the plugin aren't draggable (no movement at all), while the same nodes are draggable when the plugin is disabled. Searching for what the plugin does that could block dragging:


---

<tool-use data-tool-type="unknown" data-tool-name="semantic_search_full">
<details>
<summary>Tool use: **semantic_search_full**</summary>


Parameters:

```json
{
  "query": "Where does the plugin append or add elements to canvas nodes that could block pointer or drag?",
  "includePattern": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
  "topK": 10,
  "explanation": ""
}
```
Result:

```json
{
  "codeResults": [
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/canvasNodeLabels.ts",
        "range": {
          "startPosition": {
            "line": 131,
            "column": 1
          },
          "endPosition": {
            "line": 180,
            "column": 1
          }
        },
        "contents": "/**\n * Sync floating role labels for the active canvas: for each node whose color maps to a role,\n * add a small label above the node (e.g. \"Text\", \"Python\"). Removes existing labels first.\n * Uses the live canvas node map to find each node's DOM element (.canvas-node).\n * @param isStillActive - if provided, called after async load; when false we skip applying to avoid stale canvas\n */\nexport async function syncCanvasRoleLabels(\n\tvault: Vault,\n\tcanvasFilePath: string,\n\tcontainerEl: HTMLElement,\n\tsettings: ZettelPluginSettings,\n\tcanvas: LiveCanvas | null,\n\tisStillActive?: () =&gt; boolean\n): Promise&lt;void&gt; {\n\tif (!settings.showNodeRoleLabels) {\n\t\tclearCanvasRoleLabels(containerEl);\n\t\tclearCanvasLegend(containerEl);\n\t\treturn;\n\t}\n\tconst data = await loadCanvasData(vault, canvasFilePath);\n\tif (isStillActive &amp;&amp; !isStillActive()) return;\n\tif (!data?.nodes) {\n\t\tclearCanvasRoleLabels(containerEl);\n\t\tclearCanvasLegend(containerEl);\n\t\treturn;\n\t}\n\t// Clear only after we have data so we never paint a frame with labels removed and nothing to show (avoids flicker).\n\tclearCanvasRoleLabels(containerEl);\n\tsyncCanvasLegend(containerEl, settings);\n\tfor (const node of data.nodes) {\n\t\tconst role = getNodeRole(node, settings);\n\t\tif (!role) continue;\n\t\tconst labelText = getRoleLabel(role, settings);\n\t\tconst nodeEl =\n\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, node.id)) ||\n\t\t\tfindNodeElementByDataId(containerEl, node.id);\n\t\tif (!nodeEl) continue;\n\t\tconst label = createLabelEl(labelText);\n\t\t// Append after .canvas-node-container so it matches Obsidian file node label position\n\t\tnodeEl.append(label);\n\t}\n}\n\n/** Get center of an element in viewport coordinates. */\nfunction getElCenter(el: HTMLElement): { x: number; y: number } {\n\tconst r = el.getBoundingClientRect();\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/**",
            "lineNumber": 134
          },
          {
            "text": " * Sync floating role labels for the active canvas: for each node whose color maps to a role,",
            "lineNumber": 135
          },
          {
            "text": " * add a small label above the node (e.g. \"Text\", \"Python\"). Removes existing labels first.",
            "lineNumber": 136
          },
          {
            "text": " * Uses the live canvas node map to find each node's DOM element (.canvas-node).",
            "lineNumber": 137
          },
          {
            "text": " * @param isStillActive - if provided, called after async load; when false we skip applying to avoid stale canvas",
            "lineNumber": 138
          },
          {
            "text": " */",
            "lineNumber": 139
          },
          {
            "text": "export async function syncCanvasRoleLabels(",
            "lineNumber": 140,
            "isSignature": true
          },
          {
            "text": "\tvault: Vault,",
            "lineNumber": 141,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 142,
            "isSignature": true
          },
          {
            "text": "\tcontainerEl: HTMLElement,",
            "lineNumber": 143,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 144,
            "isSignature": true
          },
          {
            "text": "\tcanvas: LiveCanvas | null,",
            "lineNumber": 145,
            "isSignature": true
          },
          {
            "text": "\tisStillActive?: () =&gt; boolean",
            "lineNumber": 146,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;void&gt; {",
            "lineNumber": 147,
            "isSignature": true
          },
          {
            "text": "\tif (!settings.showNodeRoleLabels) {",
            "lineNumber": 148
          },
          {
            "text": "\t\tclearCanvasRoleLabels(containerEl);",
            "lineNumber": 149
          },
          {
            "text": "\t\tclearCanvasLegend(containerEl);",
            "lineNumber": 150
          },
          {
            "text": "\t\treturn;",
            "lineNumber": 151
          },
          {
            "text": "\t}",
            "lineNumber": 152
          },
          {
            "text": "\tconst data = await loadCanvasData(vault, canvasFilePath);",
            "lineNumber": 153
          },
          {
            "text": "\tif (isStillActive &amp;&amp; !isStillActive()) return;",
            "lineNumber": 154
          },
          {
            "text": "\tif (!data?.nodes) {",
            "lineNumber": 155
          },
          {
            "text": "\t\tclearCanvasRoleLabels(containerEl);",
            "lineNumber": 156
          },
          {
            "text": "\t\tclearCanvasLegend(containerEl);",
            "lineNumber": 157
          },
          {
            "text": "\t\treturn;",
            "lineNumber": 158
          },
          {
            "text": "\t}",
            "lineNumber": 159
          },
          {
            "text": "\t// Clear only after we have data so we never paint a frame with labels removed and nothing to show (avoids flicker).",
            "lineNumber": 160
          },
          {
            "text": "\tclearCanvasRoleLabels(containerEl);",
            "lineNumber": 161
          },
          {
            "text": "\tsyncCanvasLegend(containerEl, settings);",
            "lineNumber": 162
          },
          {
            "text": "\tfor (const node of data.nodes) {",
            "lineNumber": 163
          },
          {
            "text": "\t\tconst role = getNodeRole(node, settings);",
            "lineNumber": 164
          },
          {
            "text": "\t\tif (!role) continue;",
            "lineNumber": 165
          },
          {
            "text": "\t\tconst labelText = getRoleLabel(role, settings);",
            "lineNumber": 166
          },
          {
            "text": "\t\tconst nodeEl =",
            "lineNumber": 167
          },
          {
            "text": "\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, node.id)) ||",
            "lineNumber": 168
          },
          {
            "text": "\t\t\tfindNodeElementByDataId(containerEl, node.id);",
            "lineNumber": 169
          },
          {
            "text": "\t\tif (!nodeEl) continue;",
            "lineNumber": 170
          },
          {
            "text": "\t\tconst label = createLabelEl(labelText);",
            "lineNumber": 171
          },
          {
            "text": "\t\t// Append after .canvas-node-container so it matches Obsidian file node label position",
            "lineNumber": 172
          },
          {
            "text": "\t\tnodeEl.append(label);",
            "lineNumber": 173
          },
          {
            "text": "\t}",
            "lineNumber": 174
          },
          {
            "text": "}",
            "lineNumber": 175,
            "isSignature": true
          },
          {
            "lineNumber": 176
          },
          {
            "text": "/** Get center of an element in viewport coordinates. */",
            "lineNumber": 177
          },
          {
            "text": "function getElCenter(el: HTMLElement): { x: number; y: number } {",
            "lineNumber": 178,
            "isSignature": true
          },
          {
            "text": "\tconst r = el.getBoundingClientRect();",
            "lineNumber": 179
          },
          {
            "text": "}",
            "lineNumber": 181,
            "isSignature": true
          }
        ]
      },
      "score": 0.29741525650024414
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 329
          },
          "endPosition": {
            "line": 877,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\nasync onload() {\nconst runSyncLabels = \n\n\t\t\t\tif (leaf?.view) {\n\t\t\t\t\tconst itemView = leaf.view as ViewWithFlag;\n\t\t\t\t\tif (itemView._ztbTitleBarActionsAdded) {\n\t\t\t\t\t\taddedToTitleBar = true;\n\t\t\t\t\t} else if (typeof itemView.addAction === \"function\") {\n\t\t\t\t\t\titemView.addAction(\"play\", \"Run entire canvas\", () =&gt; this.runEntireCanvas());\n\t\t\t\t\t\titemView.addAction(\"trash\", \"Dismiss all output\", () =&gt; this.dismissAllOutput());\n\t\t\t\t\t\titemView._ztbTitleBarActionsAdded = true;\n\t\t\t\t\t\taddedToTitleBar = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (!addedToTitleBar) this.addCanvasToolbarToContainer(view.containerEl);\n\t\t\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;\n\t\t\t\tconst isStillActive = (): boolean =&gt; this.getActiveCanvasView()?.containerEl === roleLabelsContainerEl;\n\t\t\t\tsyncCanvasRoleLabels(this.app.vault, view.file.path, view.containerEl, this.settings, liveCanvas, isStillActive);\n\t\t\t\tsyncCanvasEdgeModeLabels(this.app.vault, view.file.path, view.containerEl, liveCanvas, isStillActive);\n\t\t\t\tif (roleLabelsIntervalId == null) {\n\t\t\t\t\troleLabelsIntervalId = window.setInterval(() =&gt; {\n\t\t\t\t\t\tconst v = this.getActiveCanvasView();\n\t\t\t\t\t\tif (v != null &amp;&amp; v.containerEl === roleLabelsContainerEl) {\n\t\t\t\t\t\t\tconst stillActive = (): boolean =&gt; this.getActiveCanvasView()?.containerEl === roleLabelsContainerEl;\n\t\t\t\t\t\t\tsyncCanvasRoleLabels(this.app.vault, v.file.path, v.containerEl, this.settings, v.canvas as import(\"./engine/canvasApi\").LiveCanvas, stillActive);\n\t\t\t\t\t\t\tsyncCanvasEdgeModeLabels(this.app.vault, v.file.path, v.containerEl, v.canvas as import(\"./engine/canvasApi\").LiveCanvas, stillActive);\n\t\t\t\t\t\t}\n\t\t\t\t\t}, 2000);\n\t\t\t\t\t(this as unknown as { _roleLabelsIntervalId: number })._roleLabelsIntervalId = roleLabelsIntervalId;\n\t\t\t\t}\n\t\t\t};\n\t\t\tthis.registerEvent(this.app.workspace.on(\"active-leaf-change\", runSyncLabels));\n\t\t\trunSyncLabels();\n\t\t} catch (e) {\n\t\t\tconsole.error(\"Zettel Thinking Board onload error:\", e);\n\t\t\tthrow e;\n\t\t}\n\t}\n\n\tonunload() {\n\t\tterminateAllKernels();\n\t\tconst id = (;\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 330,
                "column": 1
              },
              "endPosition": {
                "line": 330,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 330,
                "column": 16
              },
              "endPosition": {
                "line": 331,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 333,
                "column": 2
              },
              "endPosition": {
                "line": 334,
                "column": 3
              }
            },
            {
              "startPosition": {
                "line": 528,
                "column": 4
              },
              "endPosition": {
                "line": 528,
                "column": 10
              }
            },
            {
              "startPosition": {
                "line": 528,
                "column": 10
              },
              "endPosition": {
                "line": 528,
                "column": 26
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 330,
            "isSignature": true
          },
          {
            "text": "async onload() {",
            "lineNumber": 333
          },
          {
            "text": "const runSyncLabels = ",
            "lineNumber": 528
          },
          {
            "lineNumber": 560
          },
          {
            "text": "\t\t\t\tif (leaf?.view) {",
            "lineNumber": 561
          },
          {
            "text": "\t\t\t\t\tconst itemView = leaf.view as ViewWithFlag;",
            "lineNumber": 562
          },
          {
            "text": "\t\t\t\t\tif (itemView._ztbTitleBarActionsAdded) {",
            "lineNumber": 563
          },
          {
            "text": "\t\t\t\t\t\taddedToTitleBar = true;",
            "lineNumber": 564
          },
          {
            "text": "\t\t\t\t\t} else if (typeof itemView.addAction === \"function\") {",
            "lineNumber": 565
          },
          {
            "text": "\t\t\t\t\t\titemView.addAction(\"play\", \"Run entire canvas\", () =&gt; this.runEntireCanvas());",
            "lineNumber": 566
          },
          {
            "text": "\t\t\t\t\t\titemView.addAction(\"trash\", \"Dismiss all output\", () =&gt; this.dismissAllOutput());",
            "lineNumber": 567
          },
          {
            "text": "\t\t\t\t\t\titemView._ztbTitleBarActionsAdded = true;",
            "lineNumber": 568
          },
          {
            "text": "\t\t\t\t\t\taddedToTitleBar = true;",
            "lineNumber": 569
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 570
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 571
          },
          {
            "text": "\t\t\t\tif (!addedToTitleBar) this.addCanvasToolbarToContainer(view.containerEl);",
            "lineNumber": 572
          },
          {
            "text": "\t\t\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;",
            "lineNumber": 573
          },
          {
            "text": "\t\t\t\tconst isStillActive = (): boolean =&gt; this.getActiveCanvasView()?.containerEl === roleLabelsContainerEl;",
            "lineNumber": 574
          },
          {
            "text": "\t\t\t\tsyncCanvasRoleLabels(this.app.vault, view.file.path, view.containerEl, this.settings, liveCanvas, isStillActive);",
            "lineNumber": 575
          },
          {
            "text": "\t\t\t\tsyncCanvasEdgeModeLabels(this.app.vault, view.file.path, view.containerEl, liveCanvas, isStillActive);",
            "lineNumber": 576
          },
          {
            "text": "\t\t\t\tif (roleLabelsIntervalId == null) {",
            "lineNumber": 577
          },
          {
            "text": "\t\t\t\t\troleLabelsIntervalId = window.setInterval(() =&gt; {",
            "lineNumber": 578
          },
          {
            "text": "\t\t\t\t\t\tconst v = this.getActiveCanvasView();",
            "lineNumber": 579
          },
          {
            "text": "\t\t\t\t\t\tif (v != null &amp;&amp; v.containerEl === roleLabelsContainerEl) {",
            "lineNumber": 580
          },
          {
            "text": "\t\t\t\t\t\t\tconst stillActive = (): boolean =&gt; this.getActiveCanvasView()?.containerEl === roleLabelsContainerEl;",
            "lineNumber": 581
          },
          {
            "text": "\t\t\t\t\t\t\tsyncCanvasRoleLabels(this.app.vault, v.file.path, v.containerEl, this.settings, v.canvas as import(\"./engine/canvasApi\").LiveCanvas, stillActive);",
            "lineNumber": 582
          },
          {
            "text": "\t\t\t\t\t\t\tsyncCanvasEdgeModeLabels(this.app.vault, v.file.path, v.containerEl, v.canvas as import(\"./engine/canvasApi\").LiveCanvas, stillActive);",
            "lineNumber": 583
          },
          {
            "text": "\t\t\t\t\t\t}",
            "lineNumber": 584
          },
          {
            "text": "\t\t\t\t\t}, 2000);",
            "lineNumber": 585
          },
          {
            "text": "\t\t\t\t\t(this as unknown as { _roleLabelsIntervalId: number })._roleLabelsIntervalId = roleLabelsIntervalId;",
            "lineNumber": 586
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 587
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 588
          },
          {
            "text": "\t\t\tthis.registerEvent(this.app.workspace.on(\"active-leaf-change\", runSyncLabels));",
            "lineNumber": 589
          },
          {
            "text": "\t\t\trunSyncLabels();",
            "lineNumber": 590
          },
          {
            "text": "\t\t} catch (e) {",
            "lineNumber": 591
          },
          {
            "text": "\t\t\tconsole.error(\"Zettel Thinking Board onload error:\", e);",
            "lineNumber": 592
          },
          {
            "text": "\t\t\tthrow e;",
            "lineNumber": 593
          },
          {
            "text": "\t\t}",
            "lineNumber": 594
          },
          {
            "text": "\t}",
            "lineNumber": 595
          },
          {
            "lineNumber": 596
          },
          {
            "text": "\tonunload() {",
            "lineNumber": 597
          },
          {
            "text": "\t\tterminateAllKernels();",
            "lineNumber": 598
          },
          {
            "text": "\t\tconst id = (;",
            "lineNumber": 599
          },
          {
            "text": "\t}",
            "lineNumber": 601
          },
          {
            "text": "}",
            "lineNumber": 878,
            "isSignature": true
          }
        ]
      },
      "score": 0.28435784578323364
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 329
          },
          "endPosition": {
            "line": 877,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\nasync onload() {\n\n\t\t\tconst registerCanvasNodeMenu = () =&gt; {\n\t\t\t\ttry {\n\t\t\t\t\tconst on = this.app.workspace.on.bind(this.app.workspace) as (\n\t\t\t\t\t\tname: string,\n\t\t\t\t\t\tcallback: (menu: Menu, node: unknown) =&gt; void\n\t\t\t\t\t) =&gt; ReturnType&lt;typeof this.app.workspace.on&gt;;\n\t\t\t\t\t// Try documented-style event name first; some Obsidian builds use \"canvas:node-menu\".\n\t\t\t\t\tthis.registerEvent(on(\"canvas:node-menu\", addNodeMenuItems));\n\t\t\t\t\t// Fallback: try hyphenated name in case the app triggers a different event.\n\t\t\t\t\tthis.registerEvent(on(\"canvas-node-menu\", addNodeMenuItems));\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconsole.error(\"Zettel Thinking Board: could not register canvas node menu.\", e);\n\t\t\t\t}\n\t\t\t};\n\t\t\tconst timeoutId = window.setTimeout(registerCanvasNodeMenu, 0);\n\t\t\tthis.register(() =&gt; window.clearTimeout(timeoutId));\n\n\t\t\t// Canvas background context menu: use undocumented \"canvas:edge-menu\" (Obsidian broadcasts it;\n\t\t\t// when right-click is on empty area, edge is null). Same pattern as canvas:node-menu: addItem with setTitle, setIcon, onClick.\n\t\t\tconst addCanvasMenuItems = (menu: Menu): void =&gt; {\n\t\t\t\tmenu.addItem((item) =&gt;\n\t\t\t\t\titem.setTitle(\"Run entire canvas\").setIcon(\"play\").onClick(() =&gt; this.runEntireCanvas())\n\t\t\t\t);\n\t\t\t\tmenu.addItem((item) =&gt;\n\t\t\t\t\titem.setTitle(\"Dismiss all output\").setIcon(\"trash\").onClick(() =&gt; this.dismissAllOutput())\n\t\t\t\t);\n\t\t\t};\n\t\t\ttry {\n\t\t\t\tconst onWorkspace = this.app.workspace.on.bind(this.app.workspace) as (\n\t\t\t\t\tname: string,\n\t\t\t\t\tcallback: (menu: Menu, edge: unknown) =&gt; void\n\t\t\t\t) =&gt; ReturnType&lt;typeof this.app.workspace.on&gt;;\n\t\t\t\tthis.registerEvent(\n\t\t\t\t\tonWorkspace(\"canvas:edge-menu\", (menu: Menu, edge: unknown) =&gt; {\n\t\t\t\t\t\tif (edge == null) addCanvasMenuItems(menu);\n\t\t\t\t\t})\n\t\t\t\t);\n\t\t\t} catch (e) {\n\t\t\t\tconsole.error(\"Zettel Thinking Board: could not register canvas background menu.\", e);\n\t\t\t}\n\n\t\t\t// Debug: command to test if we can affect the canvas and if canvas:node-menu ever fires.\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 330,
                "column": 1
              },
              "endPosition": {
                "line": 330,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 330,
                "column": 16
              },
              "endPosition": {
                "line": 331,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 333,
                "column": 2
              },
              "endPosition": {
                "line": 334,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 330,
            "isSignature": true
          },
          {
            "text": "async onload() {",
            "lineNumber": 333
          },
          {
            "lineNumber": 431
          },
          {
            "text": "\t\t\tconst registerCanvasNodeMenu = () =&gt; {",
            "lineNumber": 432
          },
          {
            "text": "\t\t\t\ttry {",
            "lineNumber": 433
          },
          {
            "text": "\t\t\t\t\tconst on = this.app.workspace.on.bind(this.app.workspace) as (",
            "lineNumber": 434
          },
          {
            "text": "\t\t\t\t\t\tname: string,",
            "lineNumber": 435
          },
          {
            "text": "\t\t\t\t\t\tcallback: (menu: Menu, node: unknown) =&gt; void",
            "lineNumber": 436
          },
          {
            "text": "\t\t\t\t\t) =&gt; ReturnType&lt;typeof this.app.workspace.on&gt;;",
            "lineNumber": 437
          },
          {
            "text": "\t\t\t\t\t// Try documented-style event name first; some Obsidian builds use \"canvas:node-menu\".",
            "lineNumber": 438
          },
          {
            "text": "\t\t\t\t\tthis.registerEvent(on(\"canvas:node-menu\", addNodeMenuItems));",
            "lineNumber": 439
          },
          {
            "text": "\t\t\t\t\t// Fallback: try hyphenated name in case the app triggers a different event.",
            "lineNumber": 440
          },
          {
            "text": "\t\t\t\t\tthis.registerEvent(on(\"canvas-node-menu\", addNodeMenuItems));",
            "lineNumber": 441
          },
          {
            "text": "\t\t\t\t} catch (e) {",
            "lineNumber": 442
          },
          {
            "text": "\t\t\t\t\tconsole.error(\"Zettel Thinking Board: could not register canvas node menu.\", e);",
            "lineNumber": 443
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 444
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 445
          },
          {
            "text": "\t\t\tconst timeoutId = window.setTimeout(registerCanvasNodeMenu, 0);",
            "lineNumber": 446
          },
          {
            "text": "\t\t\tthis.register(() =&gt; window.clearTimeout(timeoutId));",
            "lineNumber": 447
          },
          {
            "lineNumber": 448
          },
          {
            "text": "\t\t\t// Canvas background context menu: use undocumented \"canvas:edge-menu\" (Obsidian broadcasts it;",
            "lineNumber": 449
          },
          {
            "text": "\t\t\t// when right-click is on empty area, edge is null). Same pattern as canvas:node-menu: addItem with setTitle, setIcon, onClick.",
            "lineNumber": 450
          },
          {
            "text": "\t\t\tconst addCanvasMenuItems = (menu: Menu): void =&gt; {",
            "lineNumber": 451
          },
          {
            "text": "\t\t\t\tmenu.addItem((item) =&gt;",
            "lineNumber": 452
          },
          {
            "text": "\t\t\t\t\titem.setTitle(\"Run entire canvas\").setIcon(\"play\").onClick(() =&gt; this.runEntireCanvas())",
            "lineNumber": 453
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 454
          },
          {
            "text": "\t\t\t\tmenu.addItem((item) =&gt;",
            "lineNumber": 455
          },
          {
            "text": "\t\t\t\t\titem.setTitle(\"Dismiss all output\").setIcon(\"trash\").onClick(() =&gt; this.dismissAllOutput())",
            "lineNumber": 456
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 457
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 458
          },
          {
            "text": "\t\t\ttry {",
            "lineNumber": 459
          },
          {
            "text": "\t\t\t\tconst onWorkspace = this.app.workspace.on.bind(this.app.workspace) as (",
            "lineNumber": 460
          },
          {
            "text": "\t\t\t\t\tname: string,",
            "lineNumber": 461
          },
          {
            "text": "\t\t\t\t\tcallback: (menu: Menu, edge: unknown) =&gt; void",
            "lineNumber": 462
          },
          {
            "text": "\t\t\t\t) =&gt; ReturnType&lt;typeof this.app.workspace.on&gt;;",
            "lineNumber": 463
          },
          {
            "text": "\t\t\t\tthis.registerEvent(",
            "lineNumber": 464
          },
          {
            "text": "\t\t\t\t\tonWorkspace(\"canvas:edge-menu\", (menu: Menu, edge: unknown) =&gt; {",
            "lineNumber": 465
          },
          {
            "text": "\t\t\t\t\t\tif (edge == null) addCanvasMenuItems(menu);",
            "lineNumber": 466
          },
          {
            "text": "\t\t\t\t\t})",
            "lineNumber": 467
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 468
          },
          {
            "text": "\t\t\t} catch (e) {",
            "lineNumber": 469
          },
          {
            "text": "\t\t\t\tconsole.error(\"Zettel Thinking Board: could not register canvas background menu.\", e);",
            "lineNumber": 470
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 471
          },
          {
            "lineNumber": 472
          },
          {
            "text": "\t\t\t// Debug: command to test if we can affect the canvas and if canvas:node-menu ever fires.",
            "lineNumber": 473
          },
          {
            "text": "\t}",
            "lineNumber": 595
          },
          {
            "text": "}",
            "lineNumber": 878,
            "isSignature": true
          }
        ]
      },
      "score": 0.27750909328460693
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/views/ZettelControlsView.ts",
        "range": {
          "startPosition": {
            "line": 25
          },
          "endPosition": {
            "line": 215,
            "column": 1
          }
        },
        "contents": "export class ZettelControlsView extends ItemView {\nasync onOpen(): Promise&lt;void&gt; {\n\n\t\tconst guideDetails = el.createEl(\"details\", { cls: \"ztb-guide-details\" });\n\t\tguideDetails.createEl(\"summary\", { cls: \"ztb-guide-summary\", text: \"How to use the canvas\" });\n\t\tconst guideList = guideDetails.createEl(\"ul\", { cls: \"ztb-guide-list\" });\n\t\tconst tips = [\n\t\t\t\"Each color is a different way to work with text: one color might ask an AI a question, another might run a short Python snippet, and the green card is where the result shows up.\",\n\t\t\t\"Text (yellow) nodes are input pass-through: their content is sent to the next node. Uncolored or unused-color cards are not connected and do not add to any prompt.\",\n\t\t\t\"An arrow from one card to another sends its text as input. You can change how it's combined by clicking the arrow's label.\",\n\t\t\t\"Right-click a card and choose Run node to run just that card, or Run chain to run it and every card that feeds into it.\",\n\t\t\t\"The green card is where answers and results appear. It gets created or updated when you run an AI or Python card.\",\n\t\t\t\"You can plug text from one card into another by using {{var:name}} in the card text and giving the edge that variable name as its label.\",\n\t\t\t\"Python (blue) cards are auto-wrapped in a code block so # comments render as comments; the plugin adds the fence when you run the node if needed.\",\n\t\t\t\"Use the command \\\"Create tutorial canvas\\\" for a full showcase: every node type, concat vs variable injection, Run buttons, and this sidebar.\",\n\t\t];\n\t\tfor (const tip of tips) {\n\t\t\tconst li = guideList.createEl(\"li\");\n\t\t\tli.setText(tip);\n\t\t}\n\t}\n\n\tasync onClose(): Promise&lt;void&gt; {\n\t\tthis.containerEl.removeClass(\"ztb-controls-view\");\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 26,
                "column": 1
              },
              "endPosition": {
                "line": 26,
                "column": 8
              }
            },
            {
              "startPosition": {
                "line": 26,
                "column": 8
              },
              "endPosition": {
                "line": 27,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 43,
                "column": 2
              },
              "endPosition": {
                "line": 44,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export class ZettelControlsView extends ItemView {",
            "lineNumber": 26,
            "isSignature": true
          },
          {
            "text": "async onOpen(): Promise&lt;void&gt; {",
            "lineNumber": 43
          },
          {
            "lineNumber": 192
          },
          {
            "text": "\t\tconst guideDetails = el.createEl(\"details\", { cls: \"ztb-guide-details\" });",
            "lineNumber": 193
          },
          {
            "text": "\t\tguideDetails.createEl(\"summary\", { cls: \"ztb-guide-summary\", text: \"How to use the canvas\" });",
            "lineNumber": 194
          },
          {
            "text": "\t\tconst guideList = guideDetails.createEl(\"ul\", { cls: \"ztb-guide-list\" });",
            "lineNumber": 195
          },
          {
            "text": "\t\tconst tips = [",
            "lineNumber": 196
          },
          {
            "text": "\t\t\t\"Each color is a different way to work with text: one color might ask an AI a question, another might run a short Python snippet, and the green card is where the result shows up.\",",
            "lineNumber": 197
          },
          {
            "text": "\t\t\t\"Text (yellow) nodes are input pass-through: their content is sent to the next node. Uncolored or unused-color cards are not connected and do not add to any prompt.\",",
            "lineNumber": 198
          },
          {
            "text": "\t\t\t\"An arrow from one card to another sends its text as input. You can change how it's combined by clicking the arrow's label.\",",
            "lineNumber": 199
          },
          {
            "text": "\t\t\t\"Right-click a card and choose Run node to run just that card, or Run chain to run it and every card that feeds into it.\",",
            "lineNumber": 200
          },
          {
            "text": "\t\t\t\"The green card is where answers and results appear. It gets created or updated when you run an AI or Python card.\",",
            "lineNumber": 201
          },
          {
            "text": "\t\t\t\"You can plug text from one card into another by using {{var:name}} in the card text and giving the edge that variable name as its label.\",",
            "lineNumber": 202
          },
          {
            "text": "\t\t\t\"Python (blue) cards are auto-wrapped in a code block so # comments render as comments; the plugin adds the fence when you run the node if needed.\",",
            "lineNumber": 203
          },
          {
            "text": "\t\t\t\"Use the command \\\"Create tutorial canvas\\\" for a full showcase: every node type, concat vs variable injection, Run buttons, and this sidebar.\",",
            "lineNumber": 204
          },
          {
            "text": "\t\t];",
            "lineNumber": 205
          },
          {
            "text": "\t\tfor (const tip of tips) {",
            "lineNumber": 206
          },
          {
            "text": "\t\t\tconst li = guideList.createEl(\"li\");",
            "lineNumber": 207
          },
          {
            "text": "\t\t\tli.setText(tip);",
            "lineNumber": 208
          },
          {
            "text": "\t\t}",
            "lineNumber": 209
          },
          {
            "text": "\t}",
            "lineNumber": 210
          },
          {
            "lineNumber": 211
          },
          {
            "text": "\tasync onClose(): Promise&lt;void&gt; {",
            "lineNumber": 212
          },
          {
            "text": "\t\tthis.containerEl.removeClass(\"ztb-controls-view\");",
            "lineNumber": 213
          },
          {
            "text": "\t}",
            "lineNumber": 215
          },
          {
            "text": "}",
            "lineNumber": 216,
            "isSignature": true
          }
        ]
      },
      "score": 0.27136048674583435
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 329
          },
          "endPosition": {
            "line": 877,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\nasync onload() {\n\n(checking: boolean) =&gt; {\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"run-chain\",\n\t\t\t\tname: \"Run chain\",\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\t\tif (!view) return false;\n\t\t\t\t\tif (checking) return true;\n\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Run chain\\\" to run from roots.\");\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"dismiss-output\",\n\t\t\t\tname: \"Dismiss output\",\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\t\tif (!view) return false;\n\t\t\t\t\tif (checking) return true;\n\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Dismiss output\\\" to remove its output.\");\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\t// Canvas node context menu (event name is undocumented; try workspace.on(\"canvas:node-menu\")).\n\t\t\t// Defer registration so Obsidian canvas is ready (avoids \"reading '_'\" in app.js).\n\t\t\tconst addNodeMenuItems = (menu: Menu, node: unknown): void =&gt; {\n\t\t\t\tdebugNodeMenuFired = true;\n\t\t\t\tconst nodeId = resolveCanvasNodeId(node);\n\t\t\t\tif (!nodeId) return;\n\t\t\t\tmenu.addItem((item) =&gt;\n\t\t\t\t\titem.setTitle(\"Run node\").setIcon(\"play\").onClick(() =&gt; this.runNode(nodeId))\n\t\t\t\t);\n\t\t\t\tmenu.addItem((item) =&gt;\n\t\t\t\t\titem.setTitle(\"Run chain\").setIcon(\"forward\").onClick(() =&gt; this.runChain(nodeId))\n\t\t\t\t);\n\t\t\t\tmenu.addItem((item) =&gt;\n\t\t\t\t\titem.setTitle(\"Dismiss output\").setIcon(\"trash\").onClick(() =&gt; this.dismissOutput(nodeId))\n\t\t\t\t);\n\t\t\t};\n\t\t\tconst registerCanvasNodeMenu = () =&gt; {\n\t\t\t\ttry {\n\t\t\t\t\tconst on = this.app.workspace.on.bind(this.app.workspace) as\n;\n;\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 330,
                "column": 1
              },
              "endPosition": {
                "line": 330,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 330,
                "column": 16
              },
              "endPosition": {
                "line": 331,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 333,
                "column": 2
              },
              "endPosition": {
                "line": 334,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 330,
            "isSignature": true
          },
          {
            "text": "async onload() {",
            "lineNumber": 333
          },
          {
            "lineNumber": 379
          },
          {
            "text": "(checking: boolean) =&gt; {",
            "lineNumber": 382
          },
          {
            "lineNumber": 387
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 388
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 389
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 390
          },
          {
            "lineNumber": 391
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 392
          },
          {
            "text": "\t\t\t\tid: \"run-chain\",",
            "lineNumber": 393
          },
          {
            "text": "\t\t\t\tname: \"Run chain\",",
            "lineNumber": 394
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 395
          },
          {
            "text": "\t\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 396
          },
          {
            "text": "\t\t\t\t\tif (!view) return false;",
            "lineNumber": 397
          },
          {
            "text": "\t\t\t\t\tif (checking) return true;",
            "lineNumber": 398
          },
          {
            "text": "\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Run chain\\\" to run from roots.\");",
            "lineNumber": 399
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 400
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 401
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 402
          },
          {
            "lineNumber": 403
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 404
          },
          {
            "text": "\t\t\t\tid: \"dismiss-output\",",
            "lineNumber": 405
          },
          {
            "text": "\t\t\t\tname: \"Dismiss output\",",
            "lineNumber": 406
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 407
          },
          {
            "text": "\t\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 408
          },
          {
            "text": "\t\t\t\t\tif (!view) return false;",
            "lineNumber": 409
          },
          {
            "text": "\t\t\t\t\tif (checking) return true;",
            "lineNumber": 410
          },
          {
            "text": "\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Dismiss output\\\" to remove its output.\");",
            "lineNumber": 411
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 412
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 413
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 414
          },
          {
            "lineNumber": 415
          },
          {
            "text": "\t\t\t// Canvas node context menu (event name is undocumented; try workspace.on(\"canvas:node-menu\")).",
            "lineNumber": 416
          },
          {
            "text": "\t\t\t// Defer registration so Obsidian canvas is ready (avoids \"reading '_'\" in app.js).",
            "lineNumber": 417
          },
          {
            "text": "\t\t\tconst addNodeMenuItems = (menu: Menu, node: unknown): void =&gt; {",
            "lineNumber": 418
          },
          {
            "text": "\t\t\t\tdebugNodeMenuFired = true;",
            "lineNumber": 419
          },
          {
            "text": "\t\t\t\tconst nodeId = resolveCanvasNodeId(node);",
            "lineNumber": 420
          },
          {
            "text": "\t\t\t\tif (!nodeId) return;",
            "lineNumber": 421
          },
          {
            "text": "\t\t\t\tmenu.addItem((item) =&gt;",
            "lineNumber": 422
          },
          {
            "text": "\t\t\t\t\titem.setTitle(\"Run node\").setIcon(\"play\").onClick(() =&gt; this.runNode(nodeId))",
            "lineNumber": 423
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 424
          },
          {
            "text": "\t\t\t\tmenu.addItem((item) =&gt;",
            "lineNumber": 425
          },
          {
            "text": "\t\t\t\t\titem.setTitle(\"Run chain\").setIcon(\"forward\").onClick(() =&gt; this.runChain(nodeId))",
            "lineNumber": 426
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 427
          },
          {
            "text": "\t\t\t\tmenu.addItem((item) =&gt;",
            "lineNumber": 428
          },
          {
            "text": "\t\t\t\t\titem.setTitle(\"Dismiss output\").setIcon(\"trash\").onClick(() =&gt; this.dismissOutput(nodeId))",
            "lineNumber": 429
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 430
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 431
          },
          {
            "text": "\t\t\tconst registerCanvasNodeMenu = () =&gt; {",
            "lineNumber": 432
          },
          {
            "text": "\t\t\t\ttry {",
            "lineNumber": 433
          },
          {
            "text": "\t\t\t\t\tconst on = this.app.workspace.on.bind(this.app.workspace) as",
            "lineNumber": 434
          },
          {
            "text": ";",
            "lineNumber": 437
          },
          {
            "text": ";",
            "lineNumber": 445
          },
          {
            "text": "\t}",
            "lineNumber": 595
          },
          {
            "text": "}",
            "lineNumber": 878,
            "isSignature": true
          }
        ]
      },
      "score": 0.2641105651855469
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/canvasApi.ts",
        "range": {
          "startPosition": {
            "column": 86
          },
          "endPosition": {
            "line": 15,
            "column": 1
          }
        },
        "contents": "export interface LiveCanvas {\n\tcreateTextNode(options: {\n\t\ttext: string;\n\t\tpos: { x: number; y: number };\n\t\tsize: { width: number; height: number };\n\t\tsave?: boolean;\n\t\tfocus?: boolean;\n\t}): { id: string; x: number; y: number; width: number; height: number; moveTo: (pos: { x: number; y: number }) =&gt; void; resize: (size: { width: number; height: number }) =&gt; void };\n\taddNode(node: unknown): void;\n\trequestSave?: () =&gt; void;\n\tremoveNode?(node: unknown): void;\n\tnodes?: Map&lt;string, unknown&gt; | Iterable&lt;unknown&gt;;\n\t/** If present, used to refresh canvas after edge label updates (Obsidian canvas view). */\n\tsetData?(data: unknown): void;\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "export interface LiveCanvas {",
            "lineNumber": 2,
            "isSignature": true
          },
          {
            "text": "\tcreateTextNode(options: {",
            "lineNumber": 3
          },
          {
            "text": "\t\ttext: string;",
            "lineNumber": 4
          },
          {
            "text": "\t\tpos: { x: number; y: number };",
            "lineNumber": 5
          },
          {
            "text": "\t\tsize: { width: number; height: number };",
            "lineNumber": 6
          },
          {
            "text": "\t\tsave?: boolean;",
            "lineNumber": 7
          },
          {
            "text": "\t\tfocus?: boolean;",
            "lineNumber": 8
          },
          {
            "text": "\t}): { id: string; x: number; y: number; width: number; height: number; moveTo: (pos: { x: number; y: number }) =&gt; void; resize: (size: { width: number; height: number }) =&gt; void };",
            "lineNumber": 9
          },
          {
            "text": "\taddNode(node: unknown): void;",
            "lineNumber": 10
          },
          {
            "text": "\trequestSave?: () =&gt; void;",
            "lineNumber": 11
          },
          {
            "text": "\tremoveNode?(node: unknown): void;",
            "lineNumber": 12
          },
          {
            "text": "\tnodes?: Map&lt;string, unknown&gt; | Iterable&lt;unknown&gt;;",
            "lineNumber": 13
          },
          {
            "text": "\t/** If present, used to refresh canvas after edge label updates (Obsidian canvas view). */",
            "lineNumber": 14
          },
          {
            "text": "\tsetData?(data: unknown): void;",
            "lineNumber": 15,
            "isSignature": true
          },
          {
            "text": "}",
            "lineNumber": 16,
            "isSignature": true
          }
        ]
      },
      "score": 0.2635507583618164
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 324,
            "column": 1
          },
          "endPosition": {
            "line": 877,
            "column": 1
          }
        },
        "contents": "/** Debug: set to true when canvas:node-menu callback has fired at least once (proves event is received). */\nlet debugNodeMenuFired = false;\n\nexport default class ZettelThinkingBoardPlugin extends Plugin {\n\tsettings: ZettelPluginSettings;\n\n\tasync onload() {\n\t\ttry {\n\t\t\tawait this.loadSettings();\n\t\t\tthis.addSettingTab(new ZettelSettingTab(this.app, this));\n\n\t\t\tthis.registerView(\n\t\t\t\tZETTEL_CONTROLS_VIEW_TYPE,\n\t\t\t\t(leaf: WorkspaceLeaf) =&gt; new ZettelControlsView(leaf, this)\n\t\t\t);\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"open-zettel-controls\",\n\t\t\t\tname: \"Open Zettel Controls\",\n\t\t\t\tcallback: () =&gt; this.activateZettelControls(),\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"create-tutorial-canvas\",\n\t\t\t\tname: \"Create tutorial canvas\",\n\t\t\t\tcallback: () =&gt; this.createTutorialCanvas(),\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"duplicate-canvas-template\",\n\t\t\t\tname: \"Duplicate canvas template\",\n\t\t\t\tcallback: () =&gt; this.duplicateCanvasTemplate(),\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"save-canvas-as-template\",\n\t\t\t\tname: \"Save canvas as template\",\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\t\tif (!view) return false;\n\t\t\t\t\tif (checking) return true;\n\t\t\t\t\tthis.saveCanvasAsTemplate();\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"edit-canvas-template\",\n\t\t\t\tname: \"Edit canvas template\",\n\t\t\t\tcallback: () =&gt; this.editCanvasTemplate(),\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"run-node\",\n\t\t\t\tname: \"Run node\",\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\t\tif (!view) return false;\n\t\t\t\t\tif (checking) return true;\n\t\t\t\t\t// Command palette: no node selected; prompt user to use context menu\n\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Run node\\\" to run it.\");\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tthis.addCommand\n\n\t}\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Debug: set to true when canvas:node-menu callback has fired at least once (proves event is received). */",
            "lineNumber": 327
          },
          {
            "text": "let debugNodeMenuFired = false;",
            "lineNumber": 328
          },
          {
            "lineNumber": 329
          },
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 330,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings;",
            "lineNumber": 331
          },
          {
            "lineNumber": 332
          },
          {
            "text": "\tasync onload() {",
            "lineNumber": 333
          },
          {
            "text": "\t\ttry {",
            "lineNumber": 334
          },
          {
            "text": "\t\t\tawait this.loadSettings();",
            "lineNumber": 335
          },
          {
            "text": "\t\t\tthis.addSettingTab(new ZettelSettingTab(this.app, this));",
            "lineNumber": 336
          },
          {
            "lineNumber": 337
          },
          {
            "text": "\t\t\tthis.registerView(",
            "lineNumber": 338
          },
          {
            "text": "\t\t\t\tZETTEL_CONTROLS_VIEW_TYPE,",
            "lineNumber": 339
          },
          {
            "text": "\t\t\t\t(leaf: WorkspaceLeaf) =&gt; new ZettelControlsView(leaf, this)",
            "lineNumber": 340
          },
          {
            "text": "\t\t\t);",
            "lineNumber": 341
          },
          {
            "lineNumber": 342
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 343
          },
          {
            "text": "\t\t\t\tid: \"open-zettel-controls\",",
            "lineNumber": 344
          },
          {
            "text": "\t\t\t\tname: \"Open Zettel Controls\",",
            "lineNumber": 345
          },
          {
            "text": "\t\t\t\tcallback: () =&gt; this.activateZettelControls(),",
            "lineNumber": 346
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 347
          },
          {
            "lineNumber": 348
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 349
          },
          {
            "text": "\t\t\t\tid: \"create-tutorial-canvas\",",
            "lineNumber": 350
          },
          {
            "text": "\t\t\t\tname: \"Create tutorial canvas\",",
            "lineNumber": 351
          },
          {
            "text": "\t\t\t\tcallback: () =&gt; this.createTutorialCanvas(),",
            "lineNumber": 352
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 353
          },
          {
            "lineNumber": 354
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 355
          },
          {
            "text": "\t\t\t\tid: \"duplicate-canvas-template\",",
            "lineNumber": 356
          },
          {
            "text": "\t\t\t\tname: \"Duplicate canvas template\",",
            "lineNumber": 357
          },
          {
            "text": "\t\t\t\tcallback: () =&gt; this.duplicateCanvasTemplate(),",
            "lineNumber": 358
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 359
          },
          {
            "lineNumber": 360
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 361
          },
          {
            "text": "\t\t\t\tid: \"save-canvas-as-template\",",
            "lineNumber": 362
          },
          {
            "text": "\t\t\t\tname: \"Save canvas as template\",",
            "lineNumber": 363
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 364
          },
          {
            "text": "\t\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 365
          },
          {
            "text": "\t\t\t\t\tif (!view) return false;",
            "lineNumber": 366
          },
          {
            "text": "\t\t\t\t\tif (checking) return true;",
            "lineNumber": 367
          },
          {
            "text": "\t\t\t\t\tthis.saveCanvasAsTemplate();",
            "lineNumber": 368
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 369
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 370
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 371
          },
          {
            "lineNumber": 372
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 373
          },
          {
            "text": "\t\t\t\tid: \"edit-canvas-template\",",
            "lineNumber": 374
          },
          {
            "text": "\t\t\t\tname: \"Edit canvas template\",",
            "lineNumber": 375
          },
          {
            "text": "\t\t\t\tcallback: () =&gt; this.editCanvasTemplate(),",
            "lineNumber": 376
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 377
          },
          {
            "lineNumber": 378
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 379
          },
          {
            "text": "\t\t\t\tid: \"run-node\",",
            "lineNumber": 380
          },
          {
            "text": "\t\t\t\tname: \"Run node\",",
            "lineNumber": 381
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 382
          },
          {
            "text": "\t\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 383
          },
          {
            "text": "\t\t\t\t\tif (!view) return false;",
            "lineNumber": 384
          },
          {
            "text": "\t\t\t\t\tif (checking) return true;",
            "lineNumber": 385
          },
          {
            "text": "\t\t\t\t\t// Command palette: no node selected; prompt user to use context menu",
            "lineNumber": 386
          },
          {
            "text": "\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Run node\\\" to run it.\");",
            "lineNumber": 387
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 388
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 389
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 390
          },
          {
            "lineNumber": 391
          },
          {
            "text": "\t\t\tthis.addCommand",
            "lineNumber": 392
          },
          {
            "lineNumber": 402
          },
          {
            "text": "\t}",
            "lineNumber": 595
          },
          {
            "text": "}",
            "lineNumber": 878,
            "isSignature": true
          }
        ]
      },
      "score": 0.26210546493530273
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 329
          },
          "endPosition": {
            "line": 877,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\n\n\n\t/** Add \"Run entire canvas\" and \"Dismiss all output\" buttons into the canvas container (fallback when view has no addAction). */\n\taddCanvasToolbarToContainer(containerEl: HTMLElement): void {\n\t\tif (containerEl.querySelector(&#96;.${ZettelThinkingBoardPlugin.ZTB_TOOLBAR_CLASS}&#96;)) return;\n\t\tconst bar = containerEl.createDiv({ cls: ZettelThinkingBoardPlugin.ZTB_TOOLBAR_CLASS });\n\t\tconst runBtn = bar.createEl(\"button\", { cls: \"ztb-toolbar-btn\" });\n\t\trunBtn.setAttribute(\"aria-label\", \"Run entire canvas\");\n\t\trunBtn.createSpan({ cls: \"ztb-toolbar-icon\", text: \"▶\" });\n\t\trunBtn.createSpan({ cls: \"ztb-toolbar-label\", text: \"Run entire canvas\" });\n\t\trunBtn.addEventListener(\"click\", () =&gt; this.runEntireCanvas());\n\t\tconst dismissBtn = bar.createEl(\"button\", { cls: \"ztb-toolbar-btn\" });\n\t\tdismissBtn.setAttribute(\"aria-label\", \"Dismiss all output\");\n\t\tdismissBtn.createSpan({ cls: \"ztb-toolbar-icon\", text: \"🗑\" });\n\t\tdismissBtn.createSpan({ cls: \"ztb-toolbar-label\", text: \"Dismiss all output\" });\n\t\tdismissBtn.addEventListener(\"click\", () =&gt; this.dismissAllOutput());\n\t}\n\n\t/** Remove the template banner from the canvas container. */\n\tclearTemplateBanner(containerEl: HTMLElement): void {\n\t\tcontainerEl.querySelectorAll\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 330,
                "column": 1
              },
              "endPosition": {
                "line": 330,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 330,
                "column": 16
              },
              "endPosition": {
                "line": 331,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 330,
            "isSignature": true
          },
          {
            "lineNumber": 788
          },
          {
            "lineNumber": 789
          },
          {
            "text": "\t/** Add \"Run entire canvas\" and \"Dismiss all output\" buttons into the canvas container (fallback when view has no addAction). */",
            "lineNumber": 790
          },
          {
            "text": "\taddCanvasToolbarToContainer(containerEl: HTMLElement): void {",
            "lineNumber": 791
          },
          {
            "text": "\t\tif (containerEl.querySelector(&#96;.${ZettelThinkingBoardPlugin.ZTB_TOOLBAR_CLASS}&#96;)) return;",
            "lineNumber": 792
          },
          {
            "text": "\t\tconst bar = containerEl.createDiv({ cls: ZettelThinkingBoardPlugin.ZTB_TOOLBAR_CLASS });",
            "lineNumber": 793
          },
          {
            "text": "\t\tconst runBtn = bar.createEl(\"button\", { cls: \"ztb-toolbar-btn\" });",
            "lineNumber": 794
          },
          {
            "text": "\t\trunBtn.setAttribute(\"aria-label\", \"Run entire canvas\");",
            "lineNumber": 795
          },
          {
            "text": "\t\trunBtn.createSpan({ cls: \"ztb-toolbar-icon\", text: \"▶\" });",
            "lineNumber": 796
          },
          {
            "text": "\t\trunBtn.createSpan({ cls: \"ztb-toolbar-label\", text: \"Run entire canvas\" });",
            "lineNumber": 797
          },
          {
            "text": "\t\trunBtn.addEventListener(\"click\", () =&gt; this.runEntireCanvas());",
            "lineNumber": 798
          },
          {
            "text": "\t\tconst dismissBtn = bar.createEl(\"button\", { cls: \"ztb-toolbar-btn\" });",
            "lineNumber": 799
          },
          {
            "text": "\t\tdismissBtn.setAttribute(\"aria-label\", \"Dismiss all output\");",
            "lineNumber": 800
          },
          {
            "text": "\t\tdismissBtn.createSpan({ cls: \"ztb-toolbar-icon\", text: \"🗑\" });",
            "lineNumber": 801
          },
          {
            "text": "\t\tdismissBtn.createSpan({ cls: \"ztb-toolbar-label\", text: \"Dismiss all output\" });",
            "lineNumber": 802
          },
          {
            "text": "\t\tdismissBtn.addEventListener(\"click\", () =&gt; this.dismissAllOutput());",
            "lineNumber": 803
          },
          {
            "text": "\t}",
            "lineNumber": 804
          },
          {
            "lineNumber": 805
          },
          {
            "text": "\t/** Remove the template banner from the canvas container. */",
            "lineNumber": 806
          },
          {
            "text": "\tclearTemplateBanner(containerEl: HTMLElement): void {",
            "lineNumber": 807
          },
          {
            "text": "\t\tcontainerEl.querySelectorAll",
            "lineNumber": 808
          },
          {
            "text": "\t}",
            "lineNumber": 809
          },
          {
            "text": "}",
            "lineNumber": 878,
            "isSignature": true
          }
        ]
      },
      "score": 0.2567625939846039
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/settings.ts",
        "range": {
          "startPosition": {
            "line": 357
          },
          "endPosition": {
            "line": 510,
            "column": 1
          }
        },
        "contents": "function addColorSetting(\n\tcontainerEl: HTMLElement,\n\tplugin: Plugin &amp; { settings: ZettelPluginSettings; saveSettings(): Promise&lt;void&gt; },\n\trole: NodeRole,\n\tlabel: string,\n\tdesc: string,\n\twarningCallback?: (message: string | null) =&gt; void\n): void {\n\n\tcustomOption.addEventListener(\"click\", () =&gt; {\n\t\tcurrentValue = \"custom\";\n\t\tcustomHex.style.display = \"inline-block\";\n\t\tconst hex = customHex.value.trim() || \"#000000\";\n\t\t(plugin.settings as unknown as Record&lt;string, CanvasColor&gt;)[key] = hex;\n\t\tdropdownMenu.querySelectorAll(\".ztb-custom-dropdown-option\").forEach(el =&gt; el.removeClass(\"ztb-selected\"));\n\t\tcustomOption.addClass(\"ztb-selected\");\n\t\tupdateDropdownButton();\n\t\tsetSwatchToCustom(swatch, hex);\n\t\tswatch.setAttr(\"title\", hex);\n\t\tcheckColorConflict(hex);\n\t\tdropdownMenu.style.display = \"none\";\n\t\tplugin.saveSettings();\n\t});\n\n\t// Toggle dropdown on button click\n\tdropdownButton.addEventListener(\"click\", (e) =&gt; {\n\t\te.stopPropagation();\n\t\tconst isVisible = dropdownMenu.style.display !== \"none\";\n\t\tdropdownMenu.style.display = isVisible ? \"none\" : \"block\";\n\t});\n\n\t// Close dropdown when clicking outside\n\tdocument.addEventListener(\"click\", () =&gt; {\n\t\tdropdownMenu.style.display = \"none\";\n\t});\n\n\tdropdownMenu.addEventListener(\"click\", (e) =&gt; {\n\t\te.stopPropagation();\n\t});\n\n\tupdateDropdownButton();\n\n\tfunction checkColorConflict(newColorValue: string): void {\n\t\tconst other = getOtherRoleWithColor(plugin.settings, newColorValue, role);\n\t\tif (other &amp;&amp; warningCallback) {\n\t\t\tconst otherName = ROLE_DISPLAY_NAMES[other];\n\t\t\twarningCallback(&#96;⚠ This color is already used by \"${otherName}\". Each node type should have a unique color so nodes are easy to tell apart on the canvas.&#96;);\n\t\t} else if (!other &amp;&amp; warningCallback) {\n\t\t\twarningCallback(null);\n\t\t}\n\t}\n\n\tconst customHex = control.createEl(\"input\", {\n\t\ttype: \"text\",\n\t\tcls: \"ztb-color-hex\",\n\t\tattr: { placeholder: \"#RRGGBB\" },\n\t});\n\tcustomHex.value = customValue;\n\tcustomHex.style.display = isPreset ? \"none\" : \"inline-block\";\n\tcustomHex.style.width = \"6em\";\n\tcustomHex.style.marginLeft = \"6px\";\n\tcustomHex.addEventListener(\"input\", () =&gt; {\n\t\tconst hex = customHex.value.trim();\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 358,
                "column": 1
              },
              "endPosition": {
                "line": 366,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "function addColorSetting(",
            "lineNumber": 358,
            "isSignature": true
          },
          {
            "text": "\tcontainerEl: HTMLElement,",
            "lineNumber": 359,
            "isSignature": true
          },
          {
            "text": "\tplugin: Plugin &amp; { settings: ZettelPluginSettings; saveSettings(): Promise&lt;void&gt; },",
            "lineNumber": 360,
            "isSignature": true
          },
          {
            "text": "\trole: NodeRole,",
            "lineNumber": 361,
            "isSignature": true
          },
          {
            "text": "\tlabel: string,",
            "lineNumber": 362,
            "isSignature": true
          },
          {
            "text": "\tdesc: string,",
            "lineNumber": 363,
            "isSignature": true
          },
          {
            "text": "\twarningCallback?: (message: string | null) =&gt; void",
            "lineNumber": 364,
            "isSignature": true
          },
          {
            "text": "): void {",
            "lineNumber": 365,
            "isSignature": true
          },
          {
            "lineNumber": 449
          },
          {
            "text": "\tcustomOption.addEventListener(\"click\", () =&gt; {",
            "lineNumber": 450
          },
          {
            "text": "\t\tcurrentValue = \"custom\";",
            "lineNumber": 451
          },
          {
            "text": "\t\tcustomHex.style.display = \"inline-block\";",
            "lineNumber": 452
          },
          {
            "text": "\t\tconst hex = customHex.value.trim() || \"#000000\";",
            "lineNumber": 453
          },
          {
            "text": "\t\t(plugin.settings as unknown as Record&lt;string, CanvasColor&gt;)[key] = hex;",
            "lineNumber": 454
          },
          {
            "text": "\t\tdropdownMenu.querySelectorAll(\".ztb-custom-dropdown-option\").forEach(el =&gt; el.removeClass(\"ztb-selected\"));",
            "lineNumber": 455
          },
          {
            "text": "\t\tcustomOption.addClass(\"ztb-selected\");",
            "lineNumber": 456
          },
          {
            "text": "\t\tupdateDropdownButton();",
            "lineNumber": 457
          },
          {
            "text": "\t\tsetSwatchToCustom(swatch, hex);",
            "lineNumber": 458
          },
          {
            "text": "\t\tswatch.setAttr(\"title\", hex);",
            "lineNumber": 459
          },
          {
            "text": "\t\tcheckColorConflict(hex);",
            "lineNumber": 460
          },
          {
            "text": "\t\tdropdownMenu.style.display = \"none\";",
            "lineNumber": 461
          },
          {
            "text": "\t\tplugin.saveSettings();",
            "lineNumber": 462
          },
          {
            "text": "\t});",
            "lineNumber": 463
          },
          {
            "lineNumber": 464
          },
          {
            "text": "\t// Toggle dropdown on button click",
            "lineNumber": 465
          },
          {
            "text": "\tdropdownButton.addEventListener(\"click\", (e) =&gt; {",
            "lineNumber": 466
          },
          {
            "text": "\t\te.stopPropagation();",
            "lineNumber": 467
          },
          {
            "text": "\t\tconst isVisible = dropdownMenu.style.display !== \"none\";",
            "lineNumber": 468
          },
          {
            "text": "\t\tdropdownMenu.style.display = isVisible ? \"none\" : \"block\";",
            "lineNumber": 469
          },
          {
            "text": "\t});",
            "lineNumber": 470
          },
          {
            "lineNumber": 471
          },
          {
            "text": "\t// Close dropdown when clicking outside",
            "lineNumber": 472
          },
          {
            "text": "\tdocument.addEventListener(\"click\", () =&gt; {",
            "lineNumber": 473
          },
          {
            "text": "\t\tdropdownMenu.style.display = \"none\";",
            "lineNumber": 474
          },
          {
            "text": "\t});",
            "lineNumber": 475
          },
          {
            "lineNumber": 476
          },
          {
            "text": "\tdropdownMenu.addEventListener(\"click\", (e) =&gt; {",
            "lineNumber": 477
          },
          {
            "text": "\t\te.stopPropagation();",
            "lineNumber": 478
          },
          {
            "text": "\t});",
            "lineNumber": 479
          },
          {
            "lineNumber": 480
          },
          {
            "text": "\tupdateDropdownButton();",
            "lineNumber": 481
          },
          {
            "lineNumber": 482
          },
          {
            "text": "\tfunction checkColorConflict(newColorValue: string): void {",
            "lineNumber": 483,
            "isSignature": true
          },
          {
            "text": "\t\tconst other = getOtherRoleWithColor(plugin.settings, newColorValue, role);",
            "lineNumber": 484
          },
          {
            "text": "\t\tif (other &amp;&amp; warningCallback) {",
            "lineNumber": 485
          },
          {
            "text": "\t\t\tconst otherName = ROLE_DISPLAY_NAMES[other];",
            "lineNumber": 486
          },
          {
            "text": "\t\t\twarningCallback(&#96;⚠ This color is already used by \"${otherName}\". Each node type should have a unique color so nodes are easy to tell apart on the canvas.&#96;);",
            "lineNumber": 487
          },
          {
            "text": "\t\t} else if (!other &amp;&amp; warningCallback) {",
            "lineNumber": 488
          },
          {
            "text": "\t\t\twarningCallback(null);",
            "lineNumber": 489
          },
          {
            "text": "\t\t}",
            "lineNumber": 490
          },
          {
            "text": "\t}",
            "lineNumber": 491,
            "isSignature": true
          },
          {
            "lineNumber": 492
          },
          {
            "text": "\tconst customHex = control.createEl(\"input\", {",
            "lineNumber": 493
          },
          {
            "text": "\t\ttype: \"text\",",
            "lineNumber": 494
          },
          {
            "text": "\t\tcls: \"ztb-color-hex\",",
            "lineNumber": 495
          },
          {
            "text": "\t\tattr: { placeholder: \"#RRGGBB\" },",
            "lineNumber": 496
          },
          {
            "text": "\t});",
            "lineNumber": 497
          },
          {
            "text": "\tcustomHex.value = customValue;",
            "lineNumber": 498
          },
          {
            "text": "\tcustomHex.style.display = isPreset ? \"none\" : \"inline-block\";",
            "lineNumber": 499
          },
          {
            "text": "\tcustomHex.style.width = \"6em\";",
            "lineNumber": 500
          },
          {
            "text": "\tcustomHex.style.marginLeft = \"6px\";",
            "lineNumber": 501
          },
          {
            "text": "\tcustomHex.addEventListener(\"input\", () =&gt; {",
            "lineNumber": 502
          },
          {
            "text": "\t\tconst hex = customHex.value.trim();",
            "lineNumber": 503
          },
          {
            "text": "\t}",
            "lineNumber": 510
          },
          {
            "text": "}",
            "lineNumber": 511,
            "isSignature": true
          }
        ]
      },
      "score": 0.2453813999891281
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 423,
            "column": 1
          },
          "endPosition": {
            "line": 529,
            "column": 1
          }
        },
        "contents": "/** Create or replace the Green output node and ensure an edge labeled \"output\" from source. Mutates data only. */\nfunction ensureOutputNodeAndEdge(\n\tdata: CanvasData,\n\tsourceNode: AllCanvasNodeData,\n\ttext: string,\n\tsettings: ZettelPluginSettings\n): void {\n\tconst outId = findOutputNodeForSource(data, sourceNode.id, settings);\n\tconst defaultY = sourceNode.y + sourceNode.height + GREEN_NODE_PADDING;\n\tconst width = Math.max(320, sourceNode.width);\n\tconst height = 180;\n\tconst defaultX = sourceNode.x;\n\tconst { x: chosenX, y: chosenY } = chooseOutputPositionXY(\n\t\tdata,\n\t\tsourceNode.id,\n\t\toutId,\n\t\tdefaultX,\n\t\tdefaultY,\n\t\twidth,\n\t\theight\n\t);\n\tconst greenColor = settings.colorGreen;\n\n\tif (outId) {\n\t\tconst outNode = getNodeById(data, outId);\n\t\tif (outNode) {\n\t\t\t// #region agent log\n\t\t\tconst existingX = (outNode as { x?: number }).x;\n\t\t\tconst existingY = (outNode as { y?: number }).y;\n\t\t\tfetch(\"http://127.0.0.1:7243/ingest/453147b6-6b57-40b4-a769-82c9dd3c5ee7\", {\n\t\t\t\tmethod: \"POST\",\n\t\t\t\theaders: { \"Content-Type\": \"application/json\" },\n\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\tlocation: \"runner.ts:ensureOutputNodeAndEdge(existing)\",\n\t\t\t\t\tmessage: \"Output node exists; position before overwrite\",\n\t\t\t\t\tdata: { outId, existingX, existingY, chosenX, chosenY, willOverwrite: true },\n\t\t\t\t\ttimestamp: Date.now(),\n\t\t\t\t\tsessionId: \"debug-session\",\n\t\t\t\t\thypothesisId: \"H1\",\n\t\t\t\t}),\n\t\t\t}).catch(() =&gt; {});\n\t\t\t// #endregion\n\t\t}\n\t\tif (outNode &amp;&amp; isTextNode(outNode)) {\n\t\t\tconst updated = {\n\t\t\t\t...(outNode as CanvasTextData),\n\t\t\t\ttext,\n\t\t\t\tx: chosenX,\n\t\t\t\ty: chosenY,\n\t\t\t\twidth,\n\t\t\t\theight,\n\t\t\t};\n\t\t\tconst idx = data.nodes.findIndex((n) =&gt; n.id === outId);\n\t\t\tif (idx &gt;= 0) data.nodes[idx] = updated;\n\t\t} else if (outNode) {\n\t\t\t(outNode as { x: number; y: number }).x = chosenX;\n\t\t\t(outNode as { x: number; y: number }).y = chosenY;\n\t\t}\n\t\tconst hasOutputEdge = data.edges.some(\n\t\t\t(e) =&gt; e.fromNode === sourceNode.id &amp;&amp; e.toNode === outId &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT\n\t\t);\n\t\tif (!hasOutputEdge) {\n\t\t\tdata.edges.push({\n\t\t\t\tid: randomId(),\n\t\t\t\tfromNode: sourceNode.id,\n\t\t\t\ttoNode: outId,\n\t\t\t\tlabel: EDGE_LABEL_OUTPUT,\n\t\t\t});\n\t\t}\n\t\treturn;\n\t}\n\n\t// #region agent log\n\tfetch(\"http://127.0.0.1:7243/ingest/453147b6-6b57-40b4-a769-82c9dd3c5ee7\", {\n\t\tmethod: \"POST\",\n\t\theaders: { \"Content-Type\": \"application/json\" },\n\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Create or replace the Green output node and ensure an edge labeled \"output\" from source. Mutates data only. */",
            "lineNumber": 426
          },
          {
            "text": "function ensureOutputNodeAndEdge(",
            "lineNumber": 427,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 428,
            "isSignature": true
          },
          {
            "text": "\tsourceNode: AllCanvasNodeData,",
            "lineNumber": 429,
            "isSignature": true
          },
          {
            "text": "\ttext: string,",
            "lineNumber": 430,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings",
            "lineNumber": 431,
            "isSignature": true
          },
          {
            "text": "): void {",
            "lineNumber": 432,
            "isSignature": true
          },
          {
            "text": "\tconst outId = findOutputNodeForSource(data, sourceNode.id, settings);",
            "lineNumber": 433
          },
          {
            "text": "\tconst defaultY = sourceNode.y + sourceNode.height + GREEN_NODE_PADDING;",
            "lineNumber": 434
          },
          {
            "text": "\tconst width = Math.max(320, sourceNode.width);",
            "lineNumber": 435
          },
          {
            "text": "\tconst height = 180;",
            "lineNumber": 436
          },
          {
            "text": "\tconst defaultX = sourceNode.x;",
            "lineNumber": 437
          },
          {
            "text": "\tconst { x: chosenX, y: chosenY } = chooseOutputPositionXY(",
            "lineNumber": 438
          },
          {
            "text": "\t\tdata,",
            "lineNumber": 439
          },
          {
            "text": "\t\tsourceNode.id,",
            "lineNumber": 440
          },
          {
            "text": "\t\toutId,",
            "lineNumber": 441
          },
          {
            "text": "\t\tdefaultX,",
            "lineNumber": 442
          },
          {
            "text": "\t\tdefaultY,",
            "lineNumber": 443
          },
          {
            "text": "\t\twidth,",
            "lineNumber": 444
          },
          {
            "text": "\t\theight",
            "lineNumber": 445
          },
          {
            "text": "\t);",
            "lineNumber": 446
          },
          {
            "text": "\tconst greenColor = settings.colorGreen;",
            "lineNumber": 447
          },
          {
            "lineNumber": 448
          },
          {
            "text": "\tif (outId) {",
            "lineNumber": 449
          },
          {
            "text": "\t\tconst outNode = getNodeById(data, outId);",
            "lineNumber": 450
          },
          {
            "text": "\t\tif (outNode) {",
            "lineNumber": 451
          },
          {
            "text": "\t\t\t// #region agent log",
            "lineNumber": 452
          },
          {
            "text": "\t\t\tconst existingX = (outNode as { x?: number }).x;",
            "lineNumber": 453
          },
          {
            "text": "\t\t\tconst existingY = (outNode as { y?: number }).y;",
            "lineNumber": 454
          },
          {
            "text": "\t\t\tfetch(\"http://127.0.0.1:7243/ingest/453147b6-6b57-40b4-a769-82c9dd3c5ee7\", {",
            "lineNumber": 455
          },
          {
            "text": "\t\t\t\tmethod: \"POST\",",
            "lineNumber": 456
          },
          {
            "text": "\t\t\t\theaders: { \"Content-Type\": \"application/json\" },",
            "lineNumber": 457
          },
          {
            "text": "\t\t\t\tbody: JSON.stringify({",
            "lineNumber": 458
          },
          {
            "text": "\t\t\t\t\tlocation: \"runner.ts:ensureOutputNodeAndEdge(existing)\",",
            "lineNumber": 459
          },
          {
            "text": "\t\t\t\t\tmessage: \"Output node exists; position before overwrite\",",
            "lineNumber": 460
          },
          {
            "text": "\t\t\t\t\tdata: { outId, existingX, existingY, chosenX, chosenY, willOverwrite: true },",
            "lineNumber": 461
          },
          {
            "text": "\t\t\t\t\ttimestamp: Date.now(),",
            "lineNumber": 462
          },
          {
            "text": "\t\t\t\t\tsessionId: \"debug-session\",",
            "lineNumber": 463
          },
          {
            "text": "\t\t\t\t\thypothesisId: \"H1\",",
            "lineNumber": 464
          },
          {
            "text": "\t\t\t\t}),",
            "lineNumber": 465
          },
          {
            "text": "\t\t\t}).catch(() =&gt; {});",
            "lineNumber": 466
          },
          {
            "text": "\t\t\t// #endregion",
            "lineNumber": 467
          },
          {
            "text": "\t\t}",
            "lineNumber": 468
          },
          {
            "text": "\t\tif (outNode &amp;&amp; isTextNode(outNode)) {",
            "lineNumber": 469
          },
          {
            "text": "\t\t\tconst updated = {",
            "lineNumber": 470
          },
          {
            "text": "\t\t\t\t...(outNode as CanvasTextData),",
            "lineNumber": 471
          },
          {
            "text": "\t\t\t\ttext,",
            "lineNumber": 472
          },
          {
            "text": "\t\t\t\tx: chosenX,",
            "lineNumber": 473
          },
          {
            "text": "\t\t\t\ty: chosenY,",
            "lineNumber": 474
          },
          {
            "text": "\t\t\t\twidth,",
            "lineNumber": 475
          },
          {
            "text": "\t\t\t\theight,",
            "lineNumber": 476
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 477
          },
          {
            "text": "\t\t\tconst idx = data.nodes.findIndex((n) =&gt; n.id === outId);",
            "lineNumber": 478
          },
          {
            "text": "\t\t\tif (idx &gt;= 0) data.nodes[idx] = updated;",
            "lineNumber": 479
          },
          {
            "text": "\t\t} else if (outNode) {",
            "lineNumber": 480
          },
          {
            "text": "\t\t\t(outNode as { x: number; y: number }).x = chosenX;",
            "lineNumber": 481
          },
          {
            "text": "\t\t\t(outNode as { x: number; y: number }).y = chosenY;",
            "lineNumber": 482
          },
          {
            "text": "\t\t}",
            "lineNumber": 483
          },
          {
            "text": "\t\tconst hasOutputEdge = data.edges.some(",
            "lineNumber": 484
          },
          {
            "text": "\t\t\t(e) =&gt; e.fromNode === sourceNode.id &amp;&amp; e.toNode === outId &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT",
            "lineNumber": 485
          },
          {
            "text": "\t\t);",
            "lineNumber": 486
          },
          {
            "text": "\t\tif (!hasOutputEdge) {",
            "lineNumber": 487
          },
          {
            "text": "\t\t\tdata.edges.push({",
            "lineNumber": 488
          },
          {
            "text": "\t\t\t\tid: randomId(),",
            "lineNumber": 489
          },
          {
            "text": "\t\t\t\tfromNode: sourceNode.id,",
            "lineNumber": 490
          },
          {
            "text": "\t\t\t\ttoNode: outId,",
            "lineNumber": 491
          },
          {
            "text": "\t\t\t\tlabel: EDGE_LABEL_OUTPUT,",
            "lineNumber": 492
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 493
          },
          {
            "text": "\t\t}",
            "lineNumber": 494
          },
          {
            "text": "\t\treturn;",
            "lineNumber": 495
          },
          {
            "text": "\t}",
            "lineNumber": 496
          },
          {
            "lineNumber": 497
          },
          {
            "text": "\t// #region agent log",
            "lineNumber": 498
          },
          {
            "text": "\tfetch(\"http://127.0.0.1:7243/ingest/453147b6-6b57-40b4-a769-82c9dd3c5ee7\", {",
            "lineNumber": 499
          },
          {
            "text": "\t\tmethod: \"POST\",",
            "lineNumber": 500
          },
          {
            "text": "\t\theaders: { \"Content-Type\": \"application/json\" },",
            "lineNumber": 501
          },
          {
            "lineNumber": 510
          },
          {
            "text": "}",
            "lineNumber": 530,
            "isSignature": true
          }
        ]
      },
      "score": 0.24466675519943237
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 329
          },
          "endPosition": {
            "line": 877,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\nasync onload() {\n\n\t\t\tconst runSyncLabels = (): void =&gt; {\n\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\tif (!view) {\n\t\t\t\t\tif (roleLabelsIntervalId != null) {\n\t\t\t\t\t\tclearInterval(roleLabelsIntervalId);\n\t\t\t\t\t\troleLabelsIntervalId = null;\n\t\t\t\t\t\tdelete (this as unknown as Record&lt;string, unknown&gt;)._roleLabelsIntervalId;\n\t\t\t\t\t}\n\t\t\t\t\tif (roleLabelsContainerEl != null) {\n\t\t\t\t\t\tclearCanvasRoleLabels(roleLabelsContainerEl);\n\t\t\t\t\t\tclearCanvasLegend(roleLabelsContainerEl);\n\t\t\t\t\t\tclearCanvasEdgeModeLabels(roleLabelsContainerEl);\n\t\t\t\t\t\tthis.clearCanvasToolbar(roleLabelsContainerEl);\n\t\t\t\t\t\tthis.clearTemplateBanner(roleLabelsContainerEl);\n\t\t\t\t\t\troleLabelsContainerEl = null;\n\t\t\t\t\t}\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tif (roleLabelsContainerEl != null &amp;&amp; roleLabelsContainerEl !== view.containerEl) {\n\t\t\t\t\tclearCanvasRoleLabels(roleLabelsContainerEl);\n\t\t\t\t\tclearCanvasLegend(roleLabelsContainerEl);\n\t\t\t\t\tclearCanvasEdgeModeLabels(roleLabelsContainerEl);\n\t\t\t\t\tthis.clearCanvasToolbar(roleLabelsContainerEl);\n\t\t\t\t\tthis.clearTemplateBanner(roleLabelsContainerEl);\n\t\t\t\t}\n\t\t\t\troleLabelsContainerEl = view.containerEl;\n\t\t\t\t// Show template banner if this canvas is in the template folder\n\t\t\t\tthis.syncTemplateBanner(view.containerEl, view.file.path);\n\t\t\t\t// Add \"Run entire canvas\" and \"Dismiss all output\" to the canvas (title bar if supported, else toolbar in container).\n\t\t\t\t// Use a property on the view so we only add once even after plugin hot-reload (WeakSet would be cleared on reload).\n\t\t\t\tconst leaf = this.app.workspace.activeLeaf;\n\t\t\t\tlet addedToTitleBar = false;\n\t\t\t\ttype ViewWithFlag = ItemView &amp; { addAction?: (icon: string, title: string, callback: (evt: MouseEvent) =&gt; void) =&gt; HTMLElement; _ztbTitleBarActionsAdded?: boolean };\n\t\t\t\tif (leaf?.view) {\n\t\t\t\t\tconst itemView = leaf.view as ViewWithFlag;\n;\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 330,
                "column": 1
              },
              "endPosition": {
                "line": 330,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 330,
                "column": 16
              },
              "endPosition": {
                "line": 331,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 333,
                "column": 2
              },
              "endPosition": {
                "line": 334,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 330,
            "isSignature": true
          },
          {
            "text": "async onload() {",
            "lineNumber": 333
          },
          {
            "lineNumber": 527
          },
          {
            "text": "\t\t\tconst runSyncLabels = (): void =&gt; {",
            "lineNumber": 528
          },
          {
            "text": "\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 529
          },
          {
            "text": "\t\t\t\tif (!view) {",
            "lineNumber": 530
          },
          {
            "text": "\t\t\t\t\tif (roleLabelsIntervalId != null) {",
            "lineNumber": 531
          },
          {
            "text": "\t\t\t\t\t\tclearInterval(roleLabelsIntervalId);",
            "lineNumber": 532
          },
          {
            "text": "\t\t\t\t\t\troleLabelsIntervalId = null;",
            "lineNumber": 533
          },
          {
            "text": "\t\t\t\t\t\tdelete (this as unknown as Record&lt;string, unknown&gt;)._roleLabelsIntervalId;",
            "lineNumber": 534
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 535
          },
          {
            "text": "\t\t\t\t\tif (roleLabelsContainerEl != null) {",
            "lineNumber": 536
          },
          {
            "text": "\t\t\t\t\t\tclearCanvasRoleLabels(roleLabelsContainerEl);",
            "lineNumber": 537
          },
          {
            "text": "\t\t\t\t\t\tclearCanvasLegend(roleLabelsContainerEl);",
            "lineNumber": 538
          },
          {
            "text": "\t\t\t\t\t\tclearCanvasEdgeModeLabels(roleLabelsContainerEl);",
            "lineNumber": 539
          },
          {
            "text": "\t\t\t\t\t\tthis.clearCanvasToolbar(roleLabelsContainerEl);",
            "lineNumber": 540
          },
          {
            "text": "\t\t\t\t\t\tthis.clearTemplateBanner(roleLabelsContainerEl);",
            "lineNumber": 541
          },
          {
            "text": "\t\t\t\t\t\troleLabelsContainerEl = null;",
            "lineNumber": 542
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 543
          },
          {
            "text": "\t\t\t\t\treturn;",
            "lineNumber": 544
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 545
          },
          {
            "text": "\t\t\t\tif (roleLabelsContainerEl != null &amp;&amp; roleLabelsContainerEl !== view.containerEl) {",
            "lineNumber": 546
          },
          {
            "text": "\t\t\t\t\tclearCanvasRoleLabels(roleLabelsContainerEl);",
            "lineNumber": 547
          },
          {
            "text": "\t\t\t\t\tclearCanvasLegend(roleLabelsContainerEl);",
            "lineNumber": 548
          },
          {
            "text": "\t\t\t\t\tclearCanvasEdgeModeLabels(roleLabelsContainerEl);",
            "lineNumber": 549
          },
          {
            "text": "\t\t\t\t\tthis.clearCanvasToolbar(roleLabelsContainerEl);",
            "lineNumber": 550
          },
          {
            "text": "\t\t\t\t\tthis.clearTemplateBanner(roleLabelsContainerEl);",
            "lineNumber": 551
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 552
          },
          {
            "text": "\t\t\t\troleLabelsContainerEl = view.containerEl;",
            "lineNumber": 553
          },
          {
            "text": "\t\t\t\t// Show template banner if this canvas is in the template folder",
            "lineNumber": 554
          },
          {
            "text": "\t\t\t\tthis.syncTemplateBanner(view.containerEl, view.file.path);",
            "lineNumber": 555
          },
          {
            "text": "\t\t\t\t// Add \"Run entire canvas\" and \"Dismiss all output\" to the canvas (title bar if supported, else toolbar in container).",
            "lineNumber": 556
          },
          {
            "text": "\t\t\t\t// Use a property on the view so we only add once even after plugin hot-reload (WeakSet would be cleared on reload).",
            "lineNumber": 557
          },
          {
            "text": "\t\t\t\tconst leaf = this.app.workspace.activeLeaf;",
            "lineNumber": 558
          },
          {
            "text": "\t\t\t\tlet addedToTitleBar = false;",
            "lineNumber": 559
          },
          {
            "text": "\t\t\t\ttype ViewWithFlag = ItemView &amp; { addAction?: (icon: string, title: string, callback: (evt: MouseEvent) =&gt; void) =&gt; HTMLElement; _ztbTitleBarActionsAdded?: boolean };",
            "lineNumber": 560
          },
          {
            "text": "\t\t\t\tif (leaf?.view) {",
            "lineNumber": 561
          },
          {
            "text": "\t\t\t\t\tconst itemView = leaf.view as ViewWithFlag;",
            "lineNumber": 562
          },
          {
            "text": ";",
            "lineNumber": 588
          },
          {
            "text": "\t}",
            "lineNumber": 595
          },
          {
            "text": "}",
            "lineNumber": 878,
            "isSignature": true
          }
        ]
      },
      "score": 0.24227559566497803
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 97
          },
          "endPosition": {
            "line": 313,
            "column": 1
          }
        },
        "contents": "function getTutorialCanvasData(settings: ZettelPluginSettings): CanvasData {\n\n\n\tconst nodes: CanvasData[\"nodes\"] = [\n\t\t// Groups first (render behind)\n\t\tgroupWelcome,\n\t\tgroupCol1,\n\t\tgroupCol2,\n\t\tgroupCol3,\n\t\tgroupCol4,\n\t\tgroupCol5,\n\t\tgroupCol6,\n\t\t// Welcome: plain text (no color = no role; not connected, does not add to prompt)\n\t\tn(welcome, \"Welcome to Zettel Thinking Board. Each column is a separate showcase. Nodes run top to bottom. Right-click a card → Run node or Run chain. Uncolored or unused-color cards are not connected to any node and do not add to the prompt.\", TUT_LEFT, welcomeY, \"\", TUT_WELCOME_W, 132),\n\n\t\t// Column 1: label = plain text; nodes in lane have roles\n\t\tn(lab1, \"Primary model: sends prompt to Ollama. Set the model in Zettel Controls.\", commentLeftX(col1), orangeY, \"\", TUT_COMMENT_W, TUT_LABEL_H),\n\t\tn(orangeNode, \"What is 2+2? Reply in one sentence.\", laneNodeX(col1, 0), orangeY, cOrange, TUT_NODE_LANE_W, TUT_NODE_H),\n\t\tn(orangeOut, \"\", laneNodeX(col1, LANE_OFFSET), orangeOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),\n\n\t\t// Column 2\n\t\tn(lab2a, \"Secondary model (same idea, different model).\", commentLeftX(col2), purpleY, \"\", TUT_COMMENT_W, TUT_LABEL_H),\n\t\tn(purpleNode, \"Summarize in 5 words: The quick brown fox jumps.\", laneNodeX(col2, 0), purpleY, cPurple, TUT_NODE_LANE_W, TUT_NODE_H),\n\t\tn(purpleOut, \"\", laneNodeX(col2, LANE_OFFSET), purpleOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),\n\t\tn(lab2b, \"Text: input text; passed to next node as-is (pass-through).\", commentRightX(col2), yellowY, \"\", TUT_COMMENT_W, TUT_LABEL_H),\n\t\tn(yellowNode, \"I'm input text. My text is passed to the next node (concatenated).\", laneNodeX(col2, 0), yellowY, cYellow, TUT_NODE_LANE_W, TUT_NODE_H),\n\t\tn(lab2c, \"Python: runs code. Use variable input for parent text.\", commentLeftX(col2), blueY, \"\", TUT_COMMENT_W, TUT_LABEL_H),\n\t\tn(blueNode, \"print('Python says:', (input or '')[:80] or '(no input)')\\n# input = text from parent\", laneNodeX(col2, LANE_OFFSET), blueY, cBlue, TUT_NODE_LANE_W, TUT_NODE_H),\n\t\tn(blueOut, \"\", laneNodeX(col2, 0), blueOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),\n\n\t\t// Column 3\n\t\tn\n,\n\t];\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 98,
                "column": 1
              },
              "endPosition": {
                "line": 99,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "function getTutorialCanvasData(settings: ZettelPluginSettings): CanvasData {",
            "lineNumber": 98,
            "isSignature": true
          },
          {
            "lineNumber": 257
          },
          {
            "lineNumber": 258
          },
          {
            "text": "\tconst nodes: CanvasData[\"nodes\"] = [",
            "lineNumber": 259
          },
          {
            "text": "\t\t// Groups first (render behind)",
            "lineNumber": 260
          },
          {
            "text": "\t\tgroupWelcome,",
            "lineNumber": 261
          },
          {
            "text": "\t\tgroupCol1,",
            "lineNumber": 262
          },
          {
            "text": "\t\tgroupCol2,",
            "lineNumber": 263
          },
          {
            "text": "\t\tgroupCol3,",
            "lineNumber": 264
          },
          {
            "text": "\t\tgroupCol4,",
            "lineNumber": 265
          },
          {
            "text": "\t\tgroupCol5,",
            "lineNumber": 266
          },
          {
            "text": "\t\tgroupCol6,",
            "lineNumber": 267
          },
          {
            "text": "\t\t// Welcome: plain text (no color = no role; not connected, does not add to prompt)",
            "lineNumber": 268
          },
          {
            "text": "\t\tn(welcome, \"Welcome to Zettel Thinking Board. Each column is a separate showcase. Nodes run top to bottom. Right-click a card → Run node or Run chain. Uncolored or unused-color cards are not connected to any node and do not add to the prompt.\", TUT_LEFT, welcomeY, \"\", TUT_WELCOME_W, 132),",
            "lineNumber": 269
          },
          {
            "lineNumber": 270
          },
          {
            "text": "\t\t// Column 1: label = plain text; nodes in lane have roles",
            "lineNumber": 271
          },
          {
            "text": "\t\tn(lab1, \"Primary model: sends prompt to Ollama. Set the model in Zettel Controls.\", commentLeftX(col1), orangeY, \"\", TUT_COMMENT_W, TUT_LABEL_H),",
            "lineNumber": 272
          },
          {
            "text": "\t\tn(orangeNode, \"What is 2+2? Reply in one sentence.\", laneNodeX(col1, 0), orangeY, cOrange, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 273
          },
          {
            "text": "\t\tn(orangeOut, \"\", laneNodeX(col1, LANE_OFFSET), orangeOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 274
          },
          {
            "lineNumber": 275
          },
          {
            "text": "\t\t// Column 2",
            "lineNumber": 276
          },
          {
            "text": "\t\tn(lab2a, \"Secondary model (same idea, different model).\", commentLeftX(col2), purpleY, \"\", TUT_COMMENT_W, TUT_LABEL_H),",
            "lineNumber": 277
          },
          {
            "text": "\t\tn(purpleNode, \"Summarize in 5 words: The quick brown fox jumps.\", laneNodeX(col2, 0), purpleY, cPurple, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 278
          },
          {
            "text": "\t\tn(purpleOut, \"\", laneNodeX(col2, LANE_OFFSET), purpleOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 279
          },
          {
            "text": "\t\tn(lab2b, \"Text: input text; passed to next node as-is (pass-through).\", commentRightX(col2), yellowY, \"\", TUT_COMMENT_W, TUT_LABEL_H),",
            "lineNumber": 280
          },
          {
            "text": "\t\tn(yellowNode, \"I'm input text. My text is passed to the next node (concatenated).\", laneNodeX(col2, 0), yellowY, cYellow, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 281
          },
          {
            "text": "\t\tn(lab2c, \"Python: runs code. Use variable input for parent text.\", commentLeftX(col2), blueY, \"\", TUT_COMMENT_W, TUT_LABEL_H),",
            "lineNumber": 282
          },
          {
            "text": "\t\tn(blueNode, \"print('Python says:', (input or '')[:80] or '(no input)')\\n# input = text from parent\", laneNodeX(col2, LANE_OFFSET), blueY, cBlue, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 283
          },
          {
            "text": "\t\tn(blueOut, \"\", laneNodeX(col2, 0), blueOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 284
          },
          {
            "lineNumber": 285
          },
          {
            "text": "\t\t// Column 3",
            "lineNumber": 286
          },
          {
            "text": "\t\tn",
            "lineNumber": 287
          },
          {
            "text": ",",
            "lineNumber": 300
          },
          {
            "text": "\t];",
            "lineNumber": 301
          },
          {
            "text": "}",
            "lineNumber": 314,
            "isSignature": true
          }
        ]
      },
      "score": 0.23664569854736328
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 329
          },
          "endPosition": {
            "line": 877,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\nasync onload() {\n // Track which paths we've warned about\n\t\t\tthis.registerEvent(\n\t\t\t\tthis.app.workspace.on(\"layout-change\", async () =&gt; {\n\t\t\t\t\tconst leaves = this.app.workspace.getLeavesOfType(\"canvas\");\n\t\t\t\t\tconst openPaths = new Set&lt;string&gt;();\n\t\t\t\t\tfor (const leaf of leaves) {\n\t\t\t\t\t\tconst v = leaf.view as { file?: { path: string } };\n\t\t\t\t\t\tif (v?.file?.path) openPaths.add(v.file.path);\n\t\t\t\t\t}\n\t\t\t\t\tfor (const path of previousCanvasPaths) {\n\t\t\t\t\t\tif (!openPaths.has(path)) {\n\t\t\t\t\t\t\t// Canvas is being closed - check for output nodes\n\t\t\t\t\t\t\tif (!hasShownOutputWarningForPath.has(path)) {\n\t\t\t\t\t\t\t\tconst data = await loadCanvasData(this.app.vault, path);\n\t\t\t\t\t\t\t\tif (data &amp;&amp; hasOutputNodes(data)) {\n\t\t\t\t\t\t\t\t\t// Show reminder about output nodes\n\t\t\t\t\t\t\t\t\tnew Notice(\"Canvas has output nodes. Remember to use \\\"Dismiss all output\\\" if you want to clean up before closing.\", 5000);\n\t\t\t\t\t\t\t\t\thasShownOutputWarningForPath.add(path);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t// Terminate kernel\n\t\t\t\t\t\t\tterminateKernel(path);\n\t\t\t\t\t\t\t// Clear warning flag after a delay (canvas might be reopened)\n\t\t\t\t\t\t\tsetTimeout(() =&gt; {\n\t\t\t\t\t\t\t\thasShownOutputWarningForPath.delete(path);\n\t\t\t\t\t\t\t}, 60000); // Clear after 1 minute\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tpreviousCanvasPaths = openPaths;\n\t\t\t\t})\n\t\t\t);\n\n\t\t\t// Floating role labels on canvas: sync when active leaf is a canvas, clear when not\n\t\t\tlet roleLabelsContainerEl: HTMLElement | null = null;\n\t\t\tlet roleLabelsIntervalId: number | null = null;\n\t\t\tconst runSyncLabels = (): void =&gt; {\n\t\t\t\tconst view = this.getActiveCanvasView();\n;\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 330,
                "column": 1
              },
              "endPosition": {
                "line": 330,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 330,
                "column": 16
              },
              "endPosition": {
                "line": 331,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 333,
                "column": 2
              },
              "endPosition": {
                "line": 334,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 330,
            "isSignature": true
          },
          {
            "text": "async onload() {",
            "lineNumber": 333
          },
          {
            "text": " // Track which paths we've warned about",
            "lineNumber": 493
          },
          {
            "text": "\t\t\tthis.registerEvent(",
            "lineNumber": 494
          },
          {
            "text": "\t\t\t\tthis.app.workspace.on(\"layout-change\", async () =&gt; {",
            "lineNumber": 495
          },
          {
            "text": "\t\t\t\t\tconst leaves = this.app.workspace.getLeavesOfType(\"canvas\");",
            "lineNumber": 496
          },
          {
            "text": "\t\t\t\t\tconst openPaths = new Set&lt;string&gt;();",
            "lineNumber": 497
          },
          {
            "text": "\t\t\t\t\tfor (const leaf of leaves) {",
            "lineNumber": 498
          },
          {
            "text": "\t\t\t\t\t\tconst v = leaf.view as { file?: { path: string } };",
            "lineNumber": 499
          },
          {
            "text": "\t\t\t\t\t\tif (v?.file?.path) openPaths.add(v.file.path);",
            "lineNumber": 500
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 501
          },
          {
            "text": "\t\t\t\t\tfor (const path of previousCanvasPaths) {",
            "lineNumber": 502
          },
          {
            "text": "\t\t\t\t\t\tif (!openPaths.has(path)) {",
            "lineNumber": 503
          },
          {
            "text": "\t\t\t\t\t\t\t// Canvas is being closed - check for output nodes",
            "lineNumber": 504
          },
          {
            "text": "\t\t\t\t\t\t\tif (!hasShownOutputWarningForPath.has(path)) {",
            "lineNumber": 505
          },
          {
            "text": "\t\t\t\t\t\t\t\tconst data = await loadCanvasData(this.app.vault, path);",
            "lineNumber": 506
          },
          {
            "text": "\t\t\t\t\t\t\t\tif (data &amp;&amp; hasOutputNodes(data)) {",
            "lineNumber": 507
          },
          {
            "text": "\t\t\t\t\t\t\t\t\t// Show reminder about output nodes",
            "lineNumber": 508
          },
          {
            "text": "\t\t\t\t\t\t\t\t\tnew Notice(\"Canvas has output nodes. Remember to use \\\"Dismiss all output\\\" if you want to clean up before closing.\", 5000);",
            "lineNumber": 509
          },
          {
            "text": "\t\t\t\t\t\t\t\t\thasShownOutputWarningForPath.add(path);",
            "lineNumber": 510
          },
          {
            "text": "\t\t\t\t\t\t\t\t}",
            "lineNumber": 511
          },
          {
            "text": "\t\t\t\t\t\t\t}",
            "lineNumber": 512
          },
          {
            "text": "\t\t\t\t\t\t\t// Terminate kernel",
            "lineNumber": 513
          },
          {
            "text": "\t\t\t\t\t\t\tterminateKernel(path);",
            "lineNumber": 514
          },
          {
            "text": "\t\t\t\t\t\t\t// Clear warning flag after a delay (canvas might be reopened)",
            "lineNumber": 515
          },
          {
            "text": "\t\t\t\t\t\t\tsetTimeout(() =&gt; {",
            "lineNumber": 516
          },
          {
            "text": "\t\t\t\t\t\t\t\thasShownOutputWarningForPath.delete(path);",
            "lineNumber": 517
          },
          {
            "text": "\t\t\t\t\t\t\t}, 60000); // Clear after 1 minute",
            "lineNumber": 518
          },
          {
            "text": "\t\t\t\t\t\t}",
            "lineNumber": 519
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 520
          },
          {
            "text": "\t\t\t\t\tpreviousCanvasPaths = openPaths;",
            "lineNumber": 521
          },
          {
            "text": "\t\t\t\t})",
            "lineNumber": 522
          },
          {
            "text": "\t\t\t);",
            "lineNumber": 523
          },
          {
            "lineNumber": 524
          },
          {
            "text": "\t\t\t// Floating role labels on canvas: sync when active leaf is a canvas, clear when not",
            "lineNumber": 525
          },
          {
            "text": "\t\t\tlet roleLabelsContainerEl: HTMLElement | null = null;",
            "lineNumber": 526
          },
          {
            "text": "\t\t\tlet roleLabelsIntervalId: number | null = null;",
            "lineNumber": 527
          },
          {
            "text": "\t\t\tconst runSyncLabels = (): void =&gt; {",
            "lineNumber": 528
          },
          {
            "text": "\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 529
          },
          {
            "text": ";",
            "lineNumber": 588
          },
          {
            "text": "\t}",
            "lineNumber": 595
          },
          {
            "text": "}",
            "lineNumber": 878,
            "isSignature": true
          }
        ]
      },
      "score": 0.23572176694869995
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/views/ZettelControlsView.ts",
        "range": {
          "startPosition": {
            "line": 25
          },
          "endPosition": {
            "line": 215,
            "column": 1
          }
        },
        "contents": "export class ZettelControlsView extends ItemView {\nasync onOpen(): Promise&lt;void&gt; {\n\n\t\tconst addEnvRow = (key = \"\", value = \"\") =&gt; {\n\t\t\tconst row = envList.createDiv({ cls: \"ztb-env-row\" });\n\t\t\tconst keyInp = row.createEl(\"input\", { type: \"text\", cls: \"ztb-env-key\" });\n\t\t\tkeyInp.placeholder = \"KEY\";\n\t\t\tkeyInp.value = key;\n\t\t\tconst valInp = row.createEl(\"input\", { type: \"text\", cls: \"ztb-env-val\" });\n\t\t\tvalInp.placeholder = \"value\";\n\t\t\tvalInp.value = value;\n\t\t\tkeyInp.addEventListener(\"change\", () =&gt; {\n\t\t\t\tif (key) delete envVars[key];\n\t\t\t\tenvVars[keyInp.value.trim()] = valInp.value.trim();\n\t\t\t});\n\t\t\tvalInp.addEventListener(\"change\", () =&gt; {\n\t\t\t\tenvVars[keyInp.value.trim()] = valInp.value.trim();\n\t\t\t});\n\t\t\trow.createEl(\"button\", { text: \"Remove\", cls: \"ztb-env-remove\" }).addEventListener(\"click\", () =&gt; {\n\t\t\t\tdelete envVars[keyInp.value.trim()];\n\t\t\t\trow.remove();\n\t\t\t});\n\t\t};\n\t\tfor (const [k, v] of Object.entries(envVars)) addEnvRow(k, v);\n\t\tconst addBtn = el.createEl(\"button\", { text: \"Add variable\", cls: \"ztb-env-add\" });\n\t\taddBtn.addEventListener(\"click\", () =&gt; addEnvRow());\n\n\t\t// Console (obsidian_log output)\n\t\tel.createEl(\"h4\", { text: \"Console\", cls: \"ztb-section-title\" });\n\t\tconst consoleTip = el.createEl(\"p\", { cls: \"ztb-controls-tip\" });\n\t\tconsoleTip.setText(\"In Python cards, call obsidian_log('your message') to see output here.\");\n\t\tconst consoleEl = el.createDiv({ cls: \"ztb-console\" });\n\t\tconst appendLog = (line: string) =&gt; {\n\t\t\tconst p = consoleEl.createEl(\"p\", { cls: \"ztb-console-line\" });\n\t\t\tp.setText(line);\n\t\t\tconsoleEl.scrollTop = consoleEl.scrollHeight;\n\t\t};\n\n\t\tconst wireKernelLog = () =&gt; {\n\t\t\tconst kernel = this.plugin.getKernelForActiveCanvas();\n\t\t\tif (kernel) kernel.onLog = (line: string) =&gt; {\n\t\t\t\tif (this.containerEl.isConnected) appendLog(line);\n\t\t\t};\n\t\t};\n\t\twireKernelLog();\n\t\tthis.plugin.registerEvent(\n\t\t\tthis.plugin.app.workspace.on(\"active-leaf-change\", wireKernelLog)\n\t\t);\n\n\t\t// Guide tips (features that are not immediately obvious)\n\t\tel.createEl(\"h4\", { text: \"Guide tips\", cls: \"ztb-section-title\" });\n\t\tconst guideDetails = el.createEl(\"details\", { cls: \"ztb-guide-details\" });\n\t\tguideDetails.createEl(\"summary\", { cls: \"ztb-guide-summary\",\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 26,
                "column": 1
              },
              "endPosition": {
                "line": 26,
                "column": 8
              }
            },
            {
              "startPosition": {
                "line": 26,
                "column": 8
              },
              "endPosition": {
                "line": 27,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 43,
                "column": 2
              },
              "endPosition": {
                "line": 44,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export class ZettelControlsView extends ItemView {",
            "lineNumber": 26,
            "isSignature": true
          },
          {
            "text": "async onOpen(): Promise&lt;void&gt; {",
            "lineNumber": 43
          },
          {
            "lineNumber": 144
          },
          {
            "text": "\t\tconst addEnvRow = (key = \"\", value = \"\") =&gt; {",
            "lineNumber": 145
          },
          {
            "text": "\t\t\tconst row = envList.createDiv({ cls: \"ztb-env-row\" });",
            "lineNumber": 146
          },
          {
            "text": "\t\t\tconst keyInp = row.createEl(\"input\", { type: \"text\", cls: \"ztb-env-key\" });",
            "lineNumber": 147
          },
          {
            "text": "\t\t\tkeyInp.placeholder = \"KEY\";",
            "lineNumber": 148
          },
          {
            "text": "\t\t\tkeyInp.value = key;",
            "lineNumber": 149
          },
          {
            "text": "\t\t\tconst valInp = row.createEl(\"input\", { type: \"text\", cls: \"ztb-env-val\" });",
            "lineNumber": 150
          },
          {
            "text": "\t\t\tvalInp.placeholder = \"value\";",
            "lineNumber": 151
          },
          {
            "text": "\t\t\tvalInp.value = value;",
            "lineNumber": 152
          },
          {
            "text": "\t\t\tkeyInp.addEventListener(\"change\", () =&gt; {",
            "lineNumber": 153
          },
          {
            "text": "\t\t\t\tif (key) delete envVars[key];",
            "lineNumber": 154
          },
          {
            "text": "\t\t\t\tenvVars[keyInp.value.trim()] = valInp.value.trim();",
            "lineNumber": 155
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 156
          },
          {
            "text": "\t\t\tvalInp.addEventListener(\"change\", () =&gt; {",
            "lineNumber": 157
          },
          {
            "text": "\t\t\t\tenvVars[keyInp.value.trim()] = valInp.value.trim();",
            "lineNumber": 158
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 159
          },
          {
            "text": "\t\t\trow.createEl(\"button\", { text: \"Remove\", cls: \"ztb-env-remove\" }).addEventListener(\"click\", () =&gt; {",
            "lineNumber": 160
          },
          {
            "text": "\t\t\t\tdelete envVars[keyInp.value.trim()];",
            "lineNumber": 161
          },
          {
            "text": "\t\t\t\trow.remove();",
            "lineNumber": 162
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 163
          },
          {
            "text": "\t\t};",
            "lineNumber": 164
          },
          {
            "text": "\t\tfor (const [k, v] of Object.entries(envVars)) addEnvRow(k, v);",
            "lineNumber": 165
          },
          {
            "text": "\t\tconst addBtn = el.createEl(\"button\", { text: \"Add variable\", cls: \"ztb-env-add\" });",
            "lineNumber": 166
          },
          {
            "text": "\t\taddBtn.addEventListener(\"click\", () =&gt; addEnvRow());",
            "lineNumber": 167
          },
          {
            "lineNumber": 168
          },
          {
            "text": "\t\t// Console (obsidian_log output)",
            "lineNumber": 169
          },
          {
            "text": "\t\tel.createEl(\"h4\", { text: \"Console\", cls: \"ztb-section-title\" });",
            "lineNumber": 170
          },
          {
            "text": "\t\tconst consoleTip = el.createEl(\"p\", { cls: \"ztb-controls-tip\" });",
            "lineNumber": 171
          },
          {
            "text": "\t\tconsoleTip.setText(\"In Python cards, call obsidian_log('your message') to see output here.\");",
            "lineNumber": 172
          },
          {
            "text": "\t\tconst consoleEl = el.createDiv({ cls: \"ztb-console\" });",
            "lineNumber": 173
          },
          {
            "text": "\t\tconst appendLog = (line: string) =&gt; {",
            "lineNumber": 174
          },
          {
            "text": "\t\t\tconst p = consoleEl.createEl(\"p\", { cls: \"ztb-console-line\" });",
            "lineNumber": 175
          },
          {
            "text": "\t\t\tp.setText(line);",
            "lineNumber": 176
          },
          {
            "text": "\t\t\tconsoleEl.scrollTop = consoleEl.scrollHeight;",
            "lineNumber": 177
          },
          {
            "text": "\t\t};",
            "lineNumber": 178
          },
          {
            "lineNumber": 179
          },
          {
            "text": "\t\tconst wireKernelLog = () =&gt; {",
            "lineNumber": 180
          },
          {
            "text": "\t\t\tconst kernel = this.plugin.getKernelForActiveCanvas();",
            "lineNumber": 181
          },
          {
            "text": "\t\t\tif (kernel) kernel.onLog = (line: string) =&gt; {",
            "lineNumber": 182
          },
          {
            "text": "\t\t\t\tif (this.containerEl.isConnected) appendLog(line);",
            "lineNumber": 183
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 184
          },
          {
            "text": "\t\t};",
            "lineNumber": 185
          },
          {
            "text": "\t\twireKernelLog();",
            "lineNumber": 186
          },
          {
            "text": "\t\tthis.plugin.registerEvent(",
            "lineNumber": 187
          },
          {
            "text": "\t\t\tthis.plugin.app.workspace.on(\"active-leaf-change\", wireKernelLog)",
            "lineNumber": 188
          },
          {
            "text": "\t\t);",
            "lineNumber": 189
          },
          {
            "lineNumber": 190
          },
          {
            "text": "\t\t// Guide tips (features that are not immediately obvious)",
            "lineNumber": 191
          },
          {
            "text": "\t\tel.createEl(\"h4\", { text: \"Guide tips\", cls: \"ztb-section-title\" });",
            "lineNumber": 192
          },
          {
            "text": "\t\tconst guideDetails = el.createEl(\"details\", { cls: \"ztb-guide-details\" });",
            "lineNumber": 193
          },
          {
            "text": "\t\tguideDetails.createEl(\"summary\", { cls: \"ztb-guide-summary\",",
            "lineNumber": 194
          },
          {
            "text": "\t}",
            "lineNumber": 210
          },
          {
            "text": "}",
            "lineNumber": 216,
            "isSignature": true
          }
        ]
      },
      "score": 0.22916199266910553
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 97
          },
          "endPosition": {
            "line": 313,
            "column": 1
          }
        },
        "contents": "function getTutorialCanvasData(settings: ZettelPluginSettings): CanvasData {\nconst y5 =  TUT_WELCOME_BOTTOM_GAP;\n\tconst y6 = TUT_TOP + TUT_WELCOME_H + TUT_WELCOME_BOTTOM_GAP;\n\n\t// Group bounds (x, y, w, h) for each workflow block\n\tconst TUT_WELCOME_CARD_H = 132;\n\tconst groupWelcome = g(\n\t\t\"grp-welcome\",\n\t\tTUT_LEFT - TUT_GROUP_PAD,\n\t\twelcomeY - TUT_GROUP_PAD,\n\t\tTUT_WELCOME_W + 2 * TUT_GROUP_PAD,\n\t\tTUT_WELCOME_CARD_H + 2 * TUT_GROUP_PAD,\n\t\t\"Welcome\"\n\t);\n\tconst groupCol1 = g(\n\t\t\"grp-col1\",\n\t\tcommentLeftX(col1) - TUT_GROUP_PAD,\n\t\torangeY - TUT_GROUP_PAD,\n\t\tTUT_COL_TOTAL_W + 2 * TUT_GROUP_PAD,\n\t\torangeOutY + TUT_NODE_H - orangeY + 2 * TUT_GROUP_PAD,\n\t\t\"Primary model\"\n\t);\n\tconst groupCol2 = g(\n\t\t\"grp-col2\",\n\t\tcommentLeftX(col2) - TUT_GROUP_PAD,\n\t\tpurpleY - TUT_GROUP_PAD,\n\t\tTUT_COL_TOTAL_W + 2 * TUT_GROUP_PAD,\n\t\tblueOutY + TUT_NODE_H - purpleY + 2 * TUT_GROUP_PAD,\n\t\t\"Node types\"\n\t);\n\tconst groupCol3 = g(\n\t\t\"grp-col3\",\n\t\tcommentLeftX(col3) - TUT_GROUP_PAD,\n\t\tconcatCommentY - TUT_GROUP_PAD,\n\t\tTUT_COL_TOTAL_W + 2 * TUT_GROUP_PAD,\n\t\tconcatOutY + TUT_NODE_H - concatCommentY + 2 * TUT_GROUP_PAD,\n\t\t\"Concatenation\"\n\t);\n\tconst groupCol4 = g(\n\t\t\"grp-col4\",\n\t\tcommentLeftX(col4) - TUT_GROUP_PAD,\n\t\tinjectFirstY - TUT_GROUP_PAD,\n\t\tTUT_COL_TOTAL_W + 2 * TUT_GROUP_PAD,\n\t\tinjectOutY + TUT_NODE_H - injectFirstY + 2 * TUT_GROUP_PAD,\n\t\t\"Variable injection\"\n\t);\n\tconst groupCol5 = g(\n\t\t\"grp-col5\",\n\t\tcommentLeftX(col5) - TUT_GROUP_PAD,\n\t\ty5 - TUT_GROUP_PAD,\n\t\tTUT_COL_TOTAL_W + 2 * TUT_GROUP_PAD,\n\t\t195 + 2 * TUT_GROUP_PAD,\n\t\t\"How to run\"\n\t);\n\tconst groupCol6 = g(\n\t\t\"grp-col6\",\n\t\tcommentLeftX(col6) - TUT_GROUP_PAD,\n\t\ty6 - TUT_GROUP_PAD,\n\t\tTUT_COL_TOTAL_W + 2 * TUT_GROUP_PAD,\n\t\t145 + 2 * TUT_GROUP_PAD,\n\t\t\"Sidebar\"\n\t);\n\n\tconst nodes: CanvasData[\"nodes\"] = [\n\t\t// Groups first (render behind)\n\t\tgroupWelcome\n,\n\t];\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 98,
                "column": 1
              },
              "endPosition": {
                "line": 99,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "function getTutorialCanvasData(settings: ZettelPluginSettings): CanvasData {",
            "lineNumber": 98,
            "isSignature": true
          },
          {
            "text": "const y5 =  TUT_WELCOME_BOTTOM_GAP;",
            "lineNumber": 197
          },
          {
            "text": "\tconst y6 = TUT_TOP + TUT_WELCOME_H + TUT_WELCOME_BOTTOM_GAP;",
            "lineNumber": 198
          },
          {
            "lineNumber": 199
          },
          {
            "text": "\t// Group bounds (x, y, w, h) for each workflow block",
            "lineNumber": 200
          },
          {
            "text": "\tconst TUT_WELCOME_CARD_H = 132;",
            "lineNumber": 201
          },
          {
            "text": "\tconst groupWelcome = g(",
            "lineNumber": 202
          },
          {
            "text": "\t\t\"grp-welcome\",",
            "lineNumber": 203
          },
          {
            "text": "\t\tTUT_LEFT - TUT_GROUP_PAD,",
            "lineNumber": 204
          },
          {
            "text": "\t\twelcomeY - TUT_GROUP_PAD,",
            "lineNumber": 205
          },
          {
            "text": "\t\tTUT_WELCOME_W + 2 * TUT_GROUP_PAD,",
            "lineNumber": 206
          },
          {
            "text": "\t\tTUT_WELCOME_CARD_H + 2 * TUT_GROUP_PAD,",
            "lineNumber": 207
          },
          {
            "text": "\t\t\"Welcome\"",
            "lineNumber": 208
          },
          {
            "text": "\t);",
            "lineNumber": 209
          },
          {
            "text": "\tconst groupCol1 = g(",
            "lineNumber": 210
          },
          {
            "text": "\t\t\"grp-col1\",",
            "lineNumber": 211
          },
          {
            "text": "\t\tcommentLeftX(col1) - TUT_GROUP_PAD,",
            "lineNumber": 212
          },
          {
            "text": "\t\torangeY - TUT_GROUP_PAD,",
            "lineNumber": 213
          },
          {
            "text": "\t\tTUT_COL_TOTAL_W + 2 * TUT_GROUP_PAD,",
            "lineNumber": 214
          },
          {
            "text": "\t\torangeOutY + TUT_NODE_H - orangeY + 2 * TUT_GROUP_PAD,",
            "lineNumber": 215
          },
          {
            "text": "\t\t\"Primary model\"",
            "lineNumber": 216
          },
          {
            "text": "\t);",
            "lineNumber": 217
          },
          {
            "text": "\tconst groupCol2 = g(",
            "lineNumber": 218
          },
          {
            "text": "\t\t\"grp-col2\",",
            "lineNumber": 219
          },
          {
            "text": "\t\tcommentLeftX(col2) - TUT_GROUP_PAD,",
            "lineNumber": 220
          },
          {
            "text": "\t\tpurpleY - TUT_GROUP_PAD,",
            "lineNumber": 221
          },
          {
            "text": "\t\tTUT_COL_TOTAL_W + 2 * TUT_GROUP_PAD,",
            "lineNumber": 222
          },
          {
            "text": "\t\tblueOutY + TUT_NODE_H - purpleY + 2 * TUT_GROUP_PAD,",
            "lineNumber": 223
          },
          {
            "text": "\t\t\"Node types\"",
            "lineNumber": 224
          },
          {
            "text": "\t);",
            "lineNumber": 225
          },
          {
            "text": "\tconst groupCol3 = g(",
            "lineNumber": 226
          },
          {
            "text": "\t\t\"grp-col3\",",
            "lineNumber": 227
          },
          {
            "text": "\t\tcommentLeftX(col3) - TUT_GROUP_PAD,",
            "lineNumber": 228
          },
          {
            "text": "\t\tconcatCommentY - TUT_GROUP_PAD,",
            "lineNumber": 229
          },
          {
            "text": "\t\tTUT_COL_TOTAL_W + 2 * TUT_GROUP_PAD,",
            "lineNumber": 230
          },
          {
            "text": "\t\tconcatOutY + TUT_NODE_H - concatCommentY + 2 * TUT_GROUP_PAD,",
            "lineNumber": 231
          },
          {
            "text": "\t\t\"Concatenation\"",
            "lineNumber": 232
          },
          {
            "text": "\t);",
            "lineNumber": 233
          },
          {
            "text": "\tconst groupCol4 = g(",
            "lineNumber": 234
          },
          {
            "text": "\t\t\"grp-col4\",",
            "lineNumber": 235
          },
          {
            "text": "\t\tcommentLeftX(col4) - TUT_GROUP_PAD,",
            "lineNumber": 236
          },
          {
            "text": "\t\tinjectFirstY - TUT_GROUP_PAD,",
            "lineNumber": 237
          },
          {
            "text": "\t\tTUT_COL_TOTAL_W + 2 * TUT_GROUP_PAD,",
            "lineNumber": 238
          },
          {
            "text": "\t\tinjectOutY + TUT_NODE_H - injectFirstY + 2 * TUT_GROUP_PAD,",
            "lineNumber": 239
          },
          {
            "text": "\t\t\"Variable injection\"",
            "lineNumber": 240
          },
          {
            "text": "\t);",
            "lineNumber": 241
          },
          {
            "text": "\tconst groupCol5 = g(",
            "lineNumber": 242
          },
          {
            "text": "\t\t\"grp-col5\",",
            "lineNumber": 243
          },
          {
            "text": "\t\tcommentLeftX(col5) - TUT_GROUP_PAD,",
            "lineNumber": 244
          },
          {
            "text": "\t\ty5 - TUT_GROUP_PAD,",
            "lineNumber": 245
          },
          {
            "text": "\t\tTUT_COL_TOTAL_W + 2 * TUT_GROUP_PAD,",
            "lineNumber": 246
          },
          {
            "text": "\t\t195 + 2 * TUT_GROUP_PAD,",
            "lineNumber": 247
          },
          {
            "text": "\t\t\"How to run\"",
            "lineNumber": 248
          },
          {
            "text": "\t);",
            "lineNumber": 249
          },
          {
            "text": "\tconst groupCol6 = g(",
            "lineNumber": 250
          },
          {
            "text": "\t\t\"grp-col6\",",
            "lineNumber": 251
          },
          {
            "text": "\t\tcommentLeftX(col6) - TUT_GROUP_PAD,",
            "lineNumber": 252
          },
          {
            "text": "\t\ty6 - TUT_GROUP_PAD,",
            "lineNumber": 253
          },
          {
            "text": "\t\tTUT_COL_TOTAL_W + 2 * TUT_GROUP_PAD,",
            "lineNumber": 254
          },
          {
            "text": "\t\t145 + 2 * TUT_GROUP_PAD,",
            "lineNumber": 255
          },
          {
            "text": "\t\t\"Sidebar\"",
            "lineNumber": 256
          },
          {
            "text": "\t);",
            "lineNumber": 257
          },
          {
            "lineNumber": 258
          },
          {
            "text": "\tconst nodes: CanvasData[\"nodes\"] = [",
            "lineNumber": 259
          },
          {
            "text": "\t\t// Groups first (render behind)",
            "lineNumber": 260
          },
          {
            "text": "\t\tgroupWelcome",
            "lineNumber": 261
          },
          {
            "text": ",",
            "lineNumber": 300
          },
          {
            "text": "\t];",
            "lineNumber": 301
          },
          {
            "text": "}",
            "lineNumber": 314,
            "isSignature": true
          }
        ]
      },
      "score": 0.2229284942150116
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 97
          },
          "endPosition": {
            "line": 313,
            "column": 1
          }
        },
        "contents": "function getTutorialCanvasData(settings: ZettelPluginSettings): CanvasData {\nconst nodes: CanvasData[\"nodes\"] = [\n TUT_NODE_LANE_W, TUT_NODE_H),\n\t\tn(blueOut, \"\", laneNodeX(col2, 0), blueOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),\n\n\t\t// Column 3\n\t\tn(lab3, \"Concatenation: no edge label → parent output appended before your prompt (then \\\"---\\\", then this card).\", commentLeftX(col3), concatCommentY, \"\", TUT_COMMENT_W, TUT_LABEL_H + 12),\n\t\tn(concatComment, \"I'm input text. My full text is added to the next node's prompt.\", laneNodeX(col3, 0), concatCommentY, cYellow, TUT_NODE_LANE_W, TUT_NODE_H),\n\t\tn(concatOrange, \"Reply in one word: what did the previous card say?\", laneNodeX(col3, LANE_OFFSET), concatOrangeY, cOrange, TUT_NODE_LANE_W, TUT_NODE_H),\n\t\tn(concatOut, \"\", laneNodeX(col3, 0), concatOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),\n\n\t\t// Column 4\n\t\tn(lab4, \"Variable injection: put a name on the edge and use {{var:name}} in the prompt; that parent is injected there.\", commentLeftX(col4), injectFirstY, \"\", TUT_COMMENT_W, TUT_LABEL_H + 12),\n\t\tn(injectFirst, \"Say exactly: Hello world.\", laneNodeX(col4, 0), injectFirstY, cOrange, TUT_NODE_LANE_W, TUT_NODE_H),\n\t\tn(injectSecond, \"They said: {{var:reply}}. Confirm in 2 words.\", laneNodeX(col4, LANE_OFFSET), injectSecondY, cOrange, TUT_NODE_LANE_W, TUT_NODE_H),\n\t\tn(injectOut, \"\", laneNodeX(col4, 0), injectOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),\n\n\t\t// Column 5 &amp; 6: plain text labels only\n\t\tn(lab5, \"How to run: Right-click a node → Run node or Run chain. Right-click empty canvas → Run entire canvas or Dismiss all output. Title bar: ▶ Run entire canvas, 🗑 Dismiss all. Commands: Open Zettel Controls; Create tutorial canvas.\", commentLeftX(col5), y5, \"\", TUT_COMMENT_W + TUT_LANE_GAP + TUT_NODE_LANE_W, 195),\n\t\tn(lab6, \"Sidebar: Open Zettel Controls. There: pick Ollama models and Temperature; restart Python kernel; env vars; Console (obsidian_log in Python cards).\", commentLeftX(col6), y6, \"\", TUT_COMMENT_W + TUT_LANE_GAP + TUT_NODE_LANE_W, 145),\n\t];\n\n\tconst edges: CanvasData[\"edges\"] = [\n\t\te(\"e-orange-out\", orangeNode, orangeOut, EDGE_LABEL_OUTPUT)\n,\n\t];\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 98,
                "column": 1
              },
              "endPosition": {
                "line": 99,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 259,
                "column": 2
              },
              "endPosition": {
                "line": 259,
                "column": 8
              }
            },
            {
              "startPosition": {
                "line": 259,
                "column": 8
              },
              "endPosition": {
                "line": 260,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "function getTutorialCanvasData(settings: ZettelPluginSettings): CanvasData {",
            "lineNumber": 98,
            "isSignature": true
          },
          {
            "text": "const nodes: CanvasData[\"nodes\"] = [",
            "lineNumber": 259
          },
          {
            "text": " TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 283
          },
          {
            "text": "\t\tn(blueOut, \"\", laneNodeX(col2, 0), blueOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 284
          },
          {
            "lineNumber": 285
          },
          {
            "text": "\t\t// Column 3",
            "lineNumber": 286
          },
          {
            "text": "\t\tn(lab3, \"Concatenation: no edge label → parent output appended before your prompt (then \\\"---\\\", then this card).\", commentLeftX(col3), concatCommentY, \"\", TUT_COMMENT_W, TUT_LABEL_H + 12),",
            "lineNumber": 287
          },
          {
            "text": "\t\tn(concatComment, \"I'm input text. My full text is added to the next node's prompt.\", laneNodeX(col3, 0), concatCommentY, cYellow, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 288
          },
          {
            "text": "\t\tn(concatOrange, \"Reply in one word: what did the previous card say?\", laneNodeX(col3, LANE_OFFSET), concatOrangeY, cOrange, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 289
          },
          {
            "text": "\t\tn(concatOut, \"\", laneNodeX(col3, 0), concatOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 290
          },
          {
            "lineNumber": 291
          },
          {
            "text": "\t\t// Column 4",
            "lineNumber": 292
          },
          {
            "text": "\t\tn(lab4, \"Variable injection: put a name on the edge and use {{var:name}} in the prompt; that parent is injected there.\", commentLeftX(col4), injectFirstY, \"\", TUT_COMMENT_W, TUT_LABEL_H + 12),",
            "lineNumber": 293
          },
          {
            "text": "\t\tn(injectFirst, \"Say exactly: Hello world.\", laneNodeX(col4, 0), injectFirstY, cOrange, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 294
          },
          {
            "text": "\t\tn(injectSecond, \"They said: {{var:reply}}. Confirm in 2 words.\", laneNodeX(col4, LANE_OFFSET), injectSecondY, cOrange, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 295
          },
          {
            "text": "\t\tn(injectOut, \"\", laneNodeX(col4, 0), injectOutY, cGreen, TUT_NODE_LANE_W, TUT_NODE_H),",
            "lineNumber": 296
          },
          {
            "lineNumber": 297
          },
          {
            "text": "\t\t// Column 5 &amp; 6: plain text labels only",
            "lineNumber": 298
          },
          {
            "text": "\t\tn(lab5, \"How to run: Right-click a node → Run node or Run chain. Right-click empty canvas → Run entire canvas or Dismiss all output. Title bar: ▶ Run entire canvas, 🗑 Dismiss all. Commands: Open Zettel Controls; Create tutorial canvas.\", commentLeftX(col5), y5, \"\", TUT_COMMENT_W + TUT_LANE_GAP + TUT_NODE_LANE_W, 195),",
            "lineNumber": 299
          },
          {
            "text": "\t\tn(lab6, \"Sidebar: Open Zettel Controls. There: pick Ollama models and Temperature; restart Python kernel; env vars; Console (obsidian_log in Python cards).\", commentLeftX(col6), y6, \"\", TUT_COMMENT_W + TUT_LANE_GAP + TUT_NODE_LANE_W, 145),",
            "lineNumber": 300
          },
          {
            "text": "\t];",
            "lineNumber": 301
          },
          {
            "lineNumber": 302
          },
          {
            "text": "\tconst edges: CanvasData[\"edges\"] = [",
            "lineNumber": 303
          },
          {
            "text": "\t\te(\"e-orange-out\", orangeNode, orangeOut, EDGE_LABEL_OUTPUT)",
            "lineNumber": 304
          },
          {
            "text": ",",
            "lineNumber": 310
          },
          {
            "text": "\t];",
            "lineNumber": 311
          },
          {
            "text": "}",
            "lineNumber": 314,
            "isSignature": true
          }
        ]
      },
      "score": 0.22251339256763458
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 94,
            "column": 1
          },
          "endPosition": {
            "line": 313,
            "column": 1
          }
        },
        "contents": "/** Build tutorial canvas: columns with comment margins, node lane center, edges, groups. */\nfunction getTutorialCanvasData(settings: ZettelPluginSettings): CanvasData {\n\tconst cOrange = tutorialColor(settings, \"colorOrange\");\n\tconst cPurple = tutorialColor(settings, \"colorPurple\");\n\tconst cBlue = tutorialColor(settings, \"colorBlue\");\n\tconst cYellow = tutorialColor(settings, \"colorYellow\");\n\tconst cGreen = tutorialColor(settings, \"colorGreen\");\n\n\t/** Plain text node (no role): use for labels/instructions so they are not treated as comment nodes. */\n\tconst n = (id: string, text: string, x: number, y: number, color: string, w: number, h: number) =&gt;\n\t\t({ id, type: \"text\" as const, text, x, y, width: w, height: h, color });\n\tconst e = (id: string, from: string, to: string, label?: string) =&gt; ({\n\t\tid,\n\t\tfromNode: from,\n\t\ttoNode: to,\n\t\tfromSide: \"bottom\" as const,\n\t\ttoSide: \"top\" as const,\n\t\tlabel: label ?? \"\",\n\t});\n\t/** Group node to visually separate a workflow block. */\n\tconst g = (id: string, x: number, y: number, w: number, h: number, label: string) =&gt;\n\t\t({ id, type: \"group\" as const, x, y, width: w, height: h, label });\n\n\t/** Column 1..6: x of left comment margin (column 1 starts right after welcome). */\n\tconst colLeft = (index: number) =&gt;\n\t\tTUT_LEFT + TUT_WELCOME_W + TUT_COL_GAP + (index - 1) * (TUT_COL_TOTAL_W + TUT_COL_GAP);\n\tconst commentLeftX = (colIndex: number) =&gt; colLeft(colIndex);\n\t/** Node lane: center x; offsetPx shifts right so alternating nodes make arrows more visible. */\n\tconst laneNodeX = (colIndex: number, offsetPx: number = 0) =&gt;\n\t\tcolLeft(colIndex) + TUT_COMMENT_W + TUT_LANE_GAP + offsetPx;\n\tconst commentRightX = (colIndex: number) =&gt;\n\t\tcolLeft(colIndex) + TUT_COMMENT_W + TUT_LANE_GAP + TUT_NODE_LANE_W + TUT_LANE_GAP;\n\tconst LANE_OFFSET = 36;\n\n\t// —— Welcome: alone in first block, no overlap with column 1 ——\n\tconst welcome = \"welcome\";\n\tconst welcomeY = TUT_TOP;\n\n\t// —— Column 1: Primary (comment left, node → output in lane) ——\n\tconst col1 = 1;\n\tconst lab1 = \"lab-primary\";\n\tconst orangeNode = \"orange-example\";\n\tconst orangeOut = \"orange-out\";\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Build tutorial canvas: columns with comment margins, node lane center, edges, groups. */",
            "lineNumber": 97
          },
          {
            "text": "function getTutorialCanvasData(settings: ZettelPluginSettings): CanvasData {",
            "lineNumber": 98,
            "isSignature": true
          },
          {
            "text": "\tconst cOrange = tutorialColor(settings, \"colorOrange\");",
            "lineNumber": 99
          },
          {
            "text": "\tconst cPurple = tutorialColor(settings, \"colorPurple\");",
            "lineNumber": 100
          },
          {
            "text": "\tconst cBlue = tutorialColor(settings, \"colorBlue\");",
            "lineNumber": 101
          },
          {
            "text": "\tconst cYellow = tutorialColor(settings, \"colorYellow\");",
            "lineNumber": 102
          },
          {
            "text": "\tconst cGreen = tutorialColor(settings, \"colorGreen\");",
            "lineNumber": 103
          },
          {
            "lineNumber": 104
          },
          {
            "text": "\t/** Plain text node (no role): use for labels/instructions so they are not treated as comment nodes. */",
            "lineNumber": 105
          },
          {
            "text": "\tconst n = (id: string, text: string, x: number, y: number, color: string, w: number, h: number) =&gt;",
            "lineNumber": 106
          },
          {
            "text": "\t\t({ id, type: \"text\" as const, text, x, y, width: w, height: h, color });",
            "lineNumber": 107
          },
          {
            "text": "\tconst e = (id: string, from: string, to: string, label?: string) =&gt; ({",
            "lineNumber": 108
          },
          {
            "text": "\t\tid,",
            "lineNumber": 109
          },
          {
            "text": "\t\tfromNode: from,",
            "lineNumber": 110
          },
          {
            "text": "\t\ttoNode: to,",
            "lineNumber": 111
          },
          {
            "text": "\t\tfromSide: \"bottom\" as const,",
            "lineNumber": 112
          },
          {
            "text": "\t\ttoSide: \"top\" as const,",
            "lineNumber": 113
          },
          {
            "text": "\t\tlabel: label ?? \"\",",
            "lineNumber": 114
          },
          {
            "text": "\t});",
            "lineNumber": 115
          },
          {
            "text": "\t/** Group node to visually separate a workflow block. */",
            "lineNumber": 116
          },
          {
            "text": "\tconst g = (id: string, x: number, y: number, w: number, h: number, label: string) =&gt;",
            "lineNumber": 117
          },
          {
            "text": "\t\t({ id, type: \"group\" as const, x, y, width: w, height: h, label });",
            "lineNumber": 118
          },
          {
            "lineNumber": 119
          },
          {
            "text": "\t/** Column 1..6: x of left comment margin (column 1 starts right after welcome). */",
            "lineNumber": 120
          },
          {
            "text": "\tconst colLeft = (index: number) =&gt;",
            "lineNumber": 121
          },
          {
            "text": "\t\tTUT_LEFT + TUT_WELCOME_W + TUT_COL_GAP + (index - 1) * (TUT_COL_TOTAL_W + TUT_COL_GAP);",
            "lineNumber": 122
          },
          {
            "text": "\tconst commentLeftX = (colIndex: number) =&gt; colLeft(colIndex);",
            "lineNumber": 123
          },
          {
            "text": "\t/** Node lane: center x; offsetPx shifts right so alternating nodes make arrows more visible. */",
            "lineNumber": 124
          },
          {
            "text": "\tconst laneNodeX = (colIndex: number, offsetPx: number = 0) =&gt;",
            "lineNumber": 125
          },
          {
            "text": "\t\tcolLeft(colIndex) + TUT_COMMENT_W + TUT_LANE_GAP + offsetPx;",
            "lineNumber": 126
          },
          {
            "text": "\tconst commentRightX = (colIndex: number) =&gt;",
            "lineNumber": 127
          },
          {
            "text": "\t\tcolLeft(colIndex) + TUT_COMMENT_W + TUT_LANE_GAP + TUT_NODE_LANE_W + TUT_LANE_GAP;",
            "lineNumber": 128
          },
          {
            "text": "\tconst LANE_OFFSET = 36;",
            "lineNumber": 129
          },
          {
            "lineNumber": 130
          },
          {
            "text": "\t// —— Welcome: alone in first block, no overlap with column 1 ——",
            "lineNumber": 131
          },
          {
            "text": "\tconst welcome = \"welcome\";",
            "lineNumber": 132
          },
          {
            "text": "\tconst welcomeY = TUT_TOP;",
            "lineNumber": 133
          },
          {
            "lineNumber": 134
          },
          {
            "text": "\t// —— Column 1: Primary (comment left, node → output in lane) ——",
            "lineNumber": 135
          },
          {
            "text": "\tconst col1 = 1;",
            "lineNumber": 136
          },
          {
            "text": "\tconst lab1 = \"lab-primary\";",
            "lineNumber": 137
          },
          {
            "text": "\tconst orangeNode = \"orange-example\";",
            "lineNumber": 138
          },
          {
            "text": "\tconst orangeOut = \"orange-out\";",
            "lineNumber": 139
          },
          {
            "text": "}",
            "lineNumber": 314,
            "isSignature": true
          }
        ]
      },
      "score": 0.22124195098876953
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/canvasNodeLabels.ts",
        "range": {
          "startPosition": {
            "line": 86,
            "column": 1
          },
          "endPosition": {
            "line": 124,
            "column": 92
          }
        },
        "contents": "/** Build and append the legend to the canvas container (vanilla DOM, no innerHTML). Order: primary → tertiary, then Python, Text, Output. */\nfunction syncCanvasLegend(containerEl: HTMLElement, settings: ZettelPluginSettings): void {\n\tclearCanvasLegend(containerEl);\n\tif (!settings.showNodeRoleLabels) return;\n\tconst legend = document.createElement(\"div\");\n\tlegend.setAttribute(\"class\", LEGEND_CLASS);\n\tconst title = document.createElement(\"div\");\n\ttitle.setAttribute(\"class\", \"ztb-legend-title\");\n\ttitle.textContent = \"Legend\";\n\tlegend.appendChild(title);\n\tfor (const role of COLOR_ROLES) {\n\t\tconst key = &#96;color${role.charAt(0).toUpperCase() + role.slice(1)}&#96; as keyof ZettelPluginSettings;\n\t\tconst color = (settings[key] as CanvasColor) ?? \"\";\n\t\tconst row = document.createElement(\"div\");\n\t\trow.setAttribute(\"class\", \"ztb-legend-row\");\n\t\trow.appendChild(createLegendSwatch(color));\n\t\tconst text = document.createElement(\"span\");\n\t\ttext.setAttribute(\"class\", \"ztb-legend-text\");\n\t\ttext.textContent = getRoleLabel(role, settings);\n\t\trow.appendChild(text);\n\t\tlegend.appendChild(row);\n\t}\n\tconst otherRow = document.createElement(\"div\");\n\totherRow.setAttribute(\"class\", \"ztb-legend-row\");\n\tconst otherSwatch = document.createElement(\"span\");\n\totherSwatch.setAttribute(\"class\", \"ztb-legend-swatch ztb-legend-swatch--other\");\n\totherSwatch.style.backgroundColor = \"var(--text-muted)\";\n\totherRow.appendChild(otherSwatch);\n\tconst otherText = document.createElement(\"span\");\n\totherText.setAttribute(\"class\", \"ztb-legend-text\");\n\totherText.textContent = \"Uncolored / unused color = not connected; does not add to prompt.\";\n\totherRow.appendChild(otherText);\n\tlegend.appendChild(otherRow);\n\tcontainerEl.appendChild(legend);\n}\n\n/** Create a label element using Obsidian's canvas-node-label class (same as file nodes). */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Build and append the legend to the canvas container (vanilla DOM, no innerHTML). Order: primary → tertiary, then Python, Text, Output. */",
            "lineNumber": 89
          },
          {
            "text": "function syncCanvasLegend(containerEl: HTMLElement, settings: ZettelPluginSettings): void {",
            "lineNumber": 90,
            "isSignature": true
          },
          {
            "text": "\tclearCanvasLegend(containerEl);",
            "lineNumber": 91
          },
          {
            "text": "\tif (!settings.showNodeRoleLabels) return;",
            "lineNumber": 92
          },
          {
            "text": "\tconst legend = document.createElement(\"div\");",
            "lineNumber": 93
          },
          {
            "text": "\tlegend.setAttribute(\"class\", LEGEND_CLASS);",
            "lineNumber": 94
          },
          {
            "text": "\tconst title = document.createElement(\"div\");",
            "lineNumber": 95
          },
          {
            "text": "\ttitle.setAttribute(\"class\", \"ztb-legend-title\");",
            "lineNumber": 96
          },
          {
            "text": "\ttitle.textContent = \"Legend\";",
            "lineNumber": 97
          },
          {
            "text": "\tlegend.appendChild(title);",
            "lineNumber": 98
          },
          {
            "text": "\tfor (const role of COLOR_ROLES) {",
            "lineNumber": 99
          },
          {
            "text": "\t\tconst key = &#96;color${role.charAt(0).toUpperCase() + role.slice(1)}&#96; as keyof ZettelPluginSettings;",
            "lineNumber": 100
          },
          {
            "text": "\t\tconst color = (settings[key] as CanvasColor) ?? \"\";",
            "lineNumber": 101
          },
          {
            "text": "\t\tconst row = document.createElement(\"div\");",
            "lineNumber": 102
          },
          {
            "text": "\t\trow.setAttribute(\"class\", \"ztb-legend-row\");",
            "lineNumber": 103
          },
          {
            "text": "\t\trow.appendChild(createLegendSwatch(color));",
            "lineNumber": 104
          },
          {
            "text": "\t\tconst text = document.createElement(\"span\");",
            "lineNumber": 105
          },
          {
            "text": "\t\ttext.setAttribute(\"class\", \"ztb-legend-text\");",
            "lineNumber": 106
          },
          {
            "text": "\t\ttext.textContent = getRoleLabel(role, settings);",
            "lineNumber": 107
          },
          {
            "text": "\t\trow.appendChild(text);",
            "lineNumber": 108
          },
          {
            "text": "\t\tlegend.appendChild(row);",
            "lineNumber": 109
          },
          {
            "text": "\t}",
            "lineNumber": 110
          },
          {
            "text": "\tconst otherRow = document.createElement(\"div\");",
            "lineNumber": 111
          },
          {
            "text": "\totherRow.setAttribute(\"class\", \"ztb-legend-row\");",
            "lineNumber": 112
          },
          {
            "text": "\tconst otherSwatch = document.createElement(\"span\");",
            "lineNumber": 113
          },
          {
            "text": "\totherSwatch.setAttribute(\"class\", \"ztb-legend-swatch ztb-legend-swatch--other\");",
            "lineNumber": 114
          },
          {
            "text": "\totherSwatch.style.backgroundColor = \"var(--text-muted)\";",
            "lineNumber": 115
          },
          {
            "text": "\totherRow.appendChild(otherSwatch);",
            "lineNumber": 116
          },
          {
            "text": "\tconst otherText = document.createElement(\"span\");",
            "lineNumber": 117
          },
          {
            "text": "\totherText.setAttribute(\"class\", \"ztb-legend-text\");",
            "lineNumber": 118
          },
          {
            "text": "\totherText.textContent = \"Uncolored / unused color = not connected; does not add to prompt.\";",
            "lineNumber": 119
          },
          {
            "text": "\totherRow.appendChild(otherText);",
            "lineNumber": 120
          },
          {
            "text": "\tlegend.appendChild(otherRow);",
            "lineNumber": 121
          },
          {
            "text": "\tcontainerEl.appendChild(legend);",
            "lineNumber": 122
          },
          {
            "text": "}",
            "lineNumber": 123,
            "isSignature": true
          },
          {
            "lineNumber": 124
          },
          {
            "text": "/** Create a label element using Obsidian's canvas-node-label class (same as file nodes). */",
            "lineNumber": 125
          }
        ]
      },
      "score": 0.21940229833126068
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/canvasNodeLabels.ts",
        "range": {
          "startPosition": {
            "line": 228
          },
          "endPosition": {
            "line": 329,
            "column": 1
          }
        },
        "contents": "export async function syncCanvasEdgeModeLabels(\n\tvault: Vault,\n\tcanvasFilePath: string,\n\tcontainerEl: HTMLElement,\n\tcanvas: LiveCanvas | null,\n\tisStillActive?: () =&gt; boolean\n): Promise&lt;void&gt; {\n\n\tfor (const edge of data.edges) {\n\t\tif (isOutputEdge(edge)) continue;\n\t\tconst isRunning = runningNodeId != null &amp;&amp; edge.toNode === runningNodeId;\n\t\tconst mode = getEdgeMode(canvasKey, edge.id);\n\t\tconst state: EdgeDisplayState | null = isRunning\n\t\t\t? \"running\"\n\t\t\t: mode === \"inject\"\n\t\t\t\t? \"inject\"\n\t\t\t\t: mode === \"concatenate\"\n\t\t\t\t\t? \"concatenate\"\n\t\t\t\t\t: null;\n\t\tif (!state) continue;\n\t\tconst fromEl =\n\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, edge.fromNode)) ||\n\t\t\tfindNodeElementByDataId(containerEl, edge.fromNode);\n\t\tconst toEl =\n\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, edge.toNode)) ||\n\t\t\tfindNodeElementByDataId(containerEl, edge.toNode);\n\t\tif (!fromEl || !toEl) continue;\n\t\tconst fromCenter = getElCenter(fromEl);\n\t\tconst toCenter = getElCenter(toEl);\n\t\tconst targetViewportX = (fromCenter.x + toCenter.x) / 2;\n\t\tconst targetViewportY = (fromCenter.y + toCenter.y) / 2;\n\t\tconst pathEl = findPathForEdge(containerEl, targetViewportX, targetViewportY);\n\t\tif (!pathEl) continue;\n\t\tconst group = pathEl.closest(\"g\");\n\t\tif (!group) continue;\n\t\tconst mid = getPathMidpointSvg(pathEl);\n\t\tconst labelGroup = document.createElementNS(SVG_NS, \"g\");\n\t\tlabelGroup.setAttribute(\"class\", EDGE_MODE_SVG_LABEL_CLASS);\n\t\tlabelGroup.setAttribute(EDGE_MODE_DATA_ATTR, edge.id);\n\t\tlabelGroup.setAttribute(EDGE_MODE_STATE_ATTR, state);\n\t\tlabelGroup.setAttribute(\"transform\", &#96;translate(${mid.x}, ${mid.y + Y_OFFSET_BELOW_PATH})&#96;);\n\t\tlabelGroup.setAttribute(\"style\", \"z-index: 100; isolation: isolate;\");\n\t\tconst textContent =\n\t\t\tstate === \"running\" ? \"…\" : state === \"inject\" ? \"(injected)\" : \"(concatenated)\";\n\t\tlet textX = 0;\n\t\tconst fontSize = state === \"running\" ? FONT_SIZE_RUNNING : FONT_SIZE;\n\t\tif (state === \"running\") {\n\t\t\tconst circle = document.createElementNS(SVG_NS, \"circle\");\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 229,
                "column": 1
              },
              "endPosition": {
                "line": 229,
                "column": 8
              }
            },
            {
              "startPosition": {
                "line": 229,
                "column": 8
              },
              "endPosition": {
                "line": 236,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export async function syncCanvasEdgeModeLabels(",
            "lineNumber": 229,
            "isSignature": true
          },
          {
            "text": "\tvault: Vault,",
            "lineNumber": 230,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 231,
            "isSignature": true
          },
          {
            "text": "\tcontainerEl: HTMLElement,",
            "lineNumber": 232,
            "isSignature": true
          },
          {
            "text": "\tcanvas: LiveCanvas | null,",
            "lineNumber": 233,
            "isSignature": true
          },
          {
            "text": "\tisStillActive?: () =&gt; boolean",
            "lineNumber": 234,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;void&gt; {",
            "lineNumber": 235,
            "isSignature": true
          },
          {
            "lineNumber": 252
          },
          {
            "text": "\tfor (const edge of data.edges) {",
            "lineNumber": 253
          },
          {
            "text": "\t\tif (isOutputEdge(edge)) continue;",
            "lineNumber": 254
          },
          {
            "text": "\t\tconst isRunning = runningNodeId != null &amp;&amp; edge.toNode === runningNodeId;",
            "lineNumber": 255
          },
          {
            "text": "\t\tconst mode = getEdgeMode(canvasKey, edge.id);",
            "lineNumber": 256
          },
          {
            "text": "\t\tconst state: EdgeDisplayState | null = isRunning",
            "lineNumber": 257
          },
          {
            "text": "\t\t\t? \"running\"",
            "lineNumber": 258
          },
          {
            "text": "\t\t\t: mode === \"inject\"",
            "lineNumber": 259
          },
          {
            "text": "\t\t\t\t? \"inject\"",
            "lineNumber": 260
          },
          {
            "text": "\t\t\t\t: mode === \"concatenate\"",
            "lineNumber": 261
          },
          {
            "text": "\t\t\t\t\t? \"concatenate\"",
            "lineNumber": 262
          },
          {
            "text": "\t\t\t\t\t: null;",
            "lineNumber": 263
          },
          {
            "text": "\t\tif (!state) continue;",
            "lineNumber": 264
          },
          {
            "text": "\t\tconst fromEl =",
            "lineNumber": 265
          },
          {
            "text": "\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, edge.fromNode)) ||",
            "lineNumber": 266
          },
          {
            "text": "\t\t\tfindNodeElementByDataId(containerEl, edge.fromNode);",
            "lineNumber": 267
          },
          {
            "text": "\t\tconst toEl =",
            "lineNumber": 268
          },
          {
            "text": "\t\t\t(canvas &amp;&amp; getNodeElFromCanvas(canvas, edge.toNode)) ||",
            "lineNumber": 269
          },
          {
            "text": "\t\t\tfindNodeElementByDataId(containerEl, edge.toNode);",
            "lineNumber": 270
          },
          {
            "text": "\t\tif (!fromEl || !toEl) continue;",
            "lineNumber": 271
          },
          {
            "text": "\t\tconst fromCenter = getElCenter(fromEl);",
            "lineNumber": 272
          },
          {
            "text": "\t\tconst toCenter = getElCenter(toEl);",
            "lineNumber": 273
          },
          {
            "text": "\t\tconst targetViewportX = (fromCenter.x + toCenter.x) / 2;",
            "lineNumber": 274
          },
          {
            "text": "\t\tconst targetViewportY = (fromCenter.y + toCenter.y) / 2;",
            "lineNumber": 275
          },
          {
            "text": "\t\tconst pathEl = findPathForEdge(containerEl, targetViewportX, targetViewportY);",
            "lineNumber": 276
          },
          {
            "text": "\t\tif (!pathEl) continue;",
            "lineNumber": 277
          },
          {
            "text": "\t\tconst group = pathEl.closest(\"g\");",
            "lineNumber": 278
          },
          {
            "text": "\t\tif (!group) continue;",
            "lineNumber": 279
          },
          {
            "text": "\t\tconst mid = getPathMidpointSvg(pathEl);",
            "lineNumber": 280
          },
          {
            "text": "\t\tconst labelGroup = document.createElementNS(SVG_NS, \"g\");",
            "lineNumber": 281
          },
          {
            "text": "\t\tlabelGroup.setAttribute(\"class\", EDGE_MODE_SVG_LABEL_CLASS);",
            "lineNumber": 282
          },
          {
            "text": "\t\tlabelGroup.setAttribute(EDGE_MODE_DATA_ATTR, edge.id);",
            "lineNumber": 283
          },
          {
            "text": "\t\tlabelGroup.setAttribute(EDGE_MODE_STATE_ATTR, state);",
            "lineNumber": 284
          },
          {
            "text": "\t\tlabelGroup.setAttribute(\"transform\", &#96;translate(${mid.x}, ${mid.y + Y_OFFSET_BELOW_PATH})&#96;);",
            "lineNumber": 285
          },
          {
            "text": "\t\tlabelGroup.setAttribute(\"style\", \"z-index: 100; isolation: isolate;\");",
            "lineNumber": 286
          },
          {
            "text": "\t\tconst textContent =",
            "lineNumber": 287
          },
          {
            "text": "\t\t\tstate === \"running\" ? \"…\" : state === \"inject\" ? \"(injected)\" : \"(concatenated)\";",
            "lineNumber": 288
          },
          {
            "text": "\t\tlet textX = 0;",
            "lineNumber": 289
          },
          {
            "text": "\t\tconst fontSize = state === \"running\" ? FONT_SIZE_RUNNING : FONT_SIZE;",
            "lineNumber": 290
          },
          {
            "text": "\t\tif (state === \"running\") {",
            "lineNumber": 291
          },
          {
            "text": "\t\t\tconst circle = document.createElementNS(SVG_NS, \"circle\");",
            "lineNumber": 292
          },
          {
            "text": "}",
            "lineNumber": 330,
            "isSignature": true
          }
        ]
      },
      "score": 0.21782159805297852
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 329
          },
          "endPosition": {
            "line": 877,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\n\n\n\t/** Returns the active canvas view if the active leaf is a canvas. */\n\tgetActiveCanvasView(): { canvas: unknown; file: { path: string }; containerEl: HTMLElement } | null {\n\t\tconst leaf = this.app.workspace.activeLeaf;\n\t\tif (!leaf?.view) return null;\n\t\tconst v = leaf.view as {\n\t\t\tgetViewType?: () =&gt; string;\n\t\t\tcanvas?: unknown;\n\t\t\tfile?: { path: string };\n\t\t\tcontainerEl?: HTMLElement;\n\t\t};\n\t\tif (v.getViewType?.() !== \"canvas\") return null;\n\t\tif (v.canvas == null || v.file == null || !v.containerEl) return null;\n\t\treturn { canvas: v.canvas, file: v.file, containerEl: v.containerEl };\n\t}\n\n\t/**\n\t * Returns the active canvas view, or the first open canvas if the active leaf is not a canvas.\n\t * Use this when the user may be focused on the control panel (e.g. Restart kernel button).\n\t */\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 330,
                "column": 1
              },
              "endPosition": {
                "line": 330,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 330,
                "column": 16
              },
              "endPosition": {
                "line": 331,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 330,
            "isSignature": true
          },
          {
            "lineNumber": 744
          },
          {
            "lineNumber": 745
          },
          {
            "text": "\t/** Returns the active canvas view if the active leaf is a canvas. */",
            "lineNumber": 746
          },
          {
            "text": "\tgetActiveCanvasView(): { canvas: unknown; file: { path: string }; containerEl: HTMLElement } | null {",
            "lineNumber": 747
          },
          {
            "text": "\t\tconst leaf = this.app.workspace.activeLeaf;",
            "lineNumber": 748
          },
          {
            "text": "\t\tif (!leaf?.view) return null;",
            "lineNumber": 749
          },
          {
            "text": "\t\tconst v = leaf.view as {",
            "lineNumber": 750
          },
          {
            "text": "\t\t\tgetViewType?: () =&gt; string;",
            "lineNumber": 751
          },
          {
            "text": "\t\t\tcanvas?: unknown;",
            "lineNumber": 752
          },
          {
            "text": "\t\t\tfile?: { path: string };",
            "lineNumber": 753
          },
          {
            "text": "\t\t\tcontainerEl?: HTMLElement;",
            "lineNumber": 754
          },
          {
            "text": "\t\t};",
            "lineNumber": 755
          },
          {
            "text": "\t\tif (v.getViewType?.() !== \"canvas\") return null;",
            "lineNumber": 756
          },
          {
            "text": "\t\tif (v.canvas == null || v.file == null || !v.containerEl) return null;",
            "lineNumber": 757
          },
          {
            "text": "\t\treturn { canvas: v.canvas, file: v.file, containerEl: v.containerEl };",
            "lineNumber": 758
          },
          {
            "text": "\t}",
            "lineNumber": 759
          },
          {
            "lineNumber": 760
          },
          {
            "text": "\t/**",
            "lineNumber": 761
          },
          {
            "text": "\t * Returns the active canvas view, or the first open canvas if the active leaf is not a canvas.",
            "lineNumber": 762
          },
          {
            "text": "\t * Use this when the user may be focused on the control panel (e.g. Restart kernel button).",
            "lineNumber": 763
          },
          {
            "text": "\t */",
            "lineNumber": 764
          },
          {
            "text": "}",
            "lineNumber": 878,
            "isSignature": true
          }
        ]
      },
      "score": 0.21224640309810638
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/settings.ts",
        "range": {
          "startPosition": {
            "line": 256
          },
          "endPosition": {
            "line": 345,
            "column": 1
          }
        },
        "contents": "function addModelBlock(\n\tcontainerEl: HTMLElement,\n\trole: \"orange\" | \"purple\" | \"red\",\n\tmodels: string[] | null,\n\tplugin: Plugin &amp; { settings: ZettelPluginSettings; saveSettings(): Promise&lt;void&gt; },\n\twarningCallback?: (message: string | null) =&gt; void\n): void {\n\n\n\tfunction updateSummaryText(): void {\n\t\tconst name = (plugin.settings[modelKey] as string)?.trim() || \"\";\n\t\tconst label = (plugin.settings[labelKey] as string)?.trim() || \"\";\n\t\tconst part = label ? &#96;${label}: ${name || \"(no model)\"}&#96; : name || \"(no model selected)\";\n\t\tsummary.setText(&#96;${title} — ${part}&#96;);\n\t}\n\n\tif (models &amp;&amp; models.length &gt; 0) {\n\t\tnew Setting(content)\n\t\t\t.setName(\"Model\")\n\t\t\t.setDesc(\"Ollama model used when you run this model node\")\n\t\t\t.addDropdown((dropdown) =&gt; {\n\t\t\t\tdropdown.addOption(\"\", \"— Select model —\");\n\t\t\t\tfor (const name of models) dropdown.addOption(name, name);\n\t\t\t\tconst current = (s[modelKey] as string) || \"\";\n\t\t\t\tdropdown.setValue(current &amp;&amp; models.includes(current) ? current : \"\");\n\t\t\t\tdropdown.onChange(async (value) =&gt; {\n\t\t\t\t\t(plugin.settings as unknown as Record&lt;string, string&gt;)[modelKey] = value;\n\t\t\t\t\tupdateSummaryText();\n\t\t\t\t\tawait plugin.saveSettings();\n\t\t\t\t});\n\t\t\t});\n\t} else {\n\t\tnew Setting(content)\n\t\t\t.setName(\"Model\")\n\t\t\t.setDesc(\"Ollama model name (e.g. llama2, mistral). Enter manually if Ollama is not reachable.\")\n\t\t\t.addText((text) =&gt; text\n\t\t\t\t.setPlaceholder(\"e.g. llama2\")\n\t\t\t\t.setValue((s[modelKey] as string) || \"\")\n\t\t\t\t.onChange(async (value) =&gt; {\n\t\t\t\t\t(plugin.settings as unknown as Record&lt;string, string&gt;)[modelKey] = value;\n\t\t\t\t\tupdateSummaryText();\n\t\t\t\t\tawait plugin.saveSettings();\n\t\t\t\t}));\n\t}\n\n\tnew Setting(content)\n\t\t.setName(\"Label\")\n\t\t.setDesc(\"Optional label on the canvas (e.g. quick, big); model name is shown after it\")\n\t\t.addText((text) =&gt; text\n\t\t\t.setPlaceholder(\"e.g. quick\")\n\t\t\t.setValue((s[labelKey] as string) || \"\")\n\t\t\t.onChange(async (value) =&gt; {\n\t\t\t\t(plugin.settings as unknown as Record&lt;string, string&gt;)[labelKey] = value;\n\t\t\t\tupdateSummaryText();\n\t\t\t\tawait plugin.saveSettings();\n\t\t\t}));\n\n\tnew Setting(content)\n\t\t.setName(\"Temperature\")\n\t\t.setDesc\n\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 257,
                "column": 1
              },
              "endPosition": {
                "line": 264,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "function addModelBlock(",
            "lineNumber": 257,
            "isSignature": true
          },
          {
            "text": "\tcontainerEl: HTMLElement,",
            "lineNumber": 258,
            "isSignature": true
          },
          {
            "text": "\trole: \"orange\" | \"purple\" | \"red\",",
            "lineNumber": 259,
            "isSignature": true
          },
          {
            "text": "\tmodels: string[] | null,",
            "lineNumber": 260,
            "isSignature": true
          },
          {
            "text": "\tplugin: Plugin &amp; { settings: ZettelPluginSettings; saveSettings(): Promise&lt;void&gt; },",
            "lineNumber": 261,
            "isSignature": true
          },
          {
            "text": "\twarningCallback?: (message: string | null) =&gt; void",
            "lineNumber": 262,
            "isSignature": true
          },
          {
            "text": "): void {",
            "lineNumber": 263,
            "isSignature": true
          },
          {
            "lineNumber": 275
          },
          {
            "lineNumber": 276
          },
          {
            "text": "\tfunction updateSummaryText(): void {",
            "lineNumber": 277,
            "isSignature": true
          },
          {
            "text": "\t\tconst name = (plugin.settings[modelKey] as string)?.trim() || \"\";",
            "lineNumber": 278
          },
          {
            "text": "\t\tconst label = (plugin.settings[labelKey] as string)?.trim() || \"\";",
            "lineNumber": 279
          },
          {
            "text": "\t\tconst part = label ? &#96;${label}: ${name || \"(no model)\"}&#96; : name || \"(no model selected)\";",
            "lineNumber": 280
          },
          {
            "text": "\t\tsummary.setText(&#96;${title} — ${part}&#96;);",
            "lineNumber": 281
          },
          {
            "text": "\t}",
            "lineNumber": 282,
            "isSignature": true
          },
          {
            "lineNumber": 283
          },
          {
            "text": "\tif (models &amp;&amp; models.length &gt; 0) {",
            "lineNumber": 284
          },
          {
            "text": "\t\tnew Setting(content)",
            "lineNumber": 285
          },
          {
            "text": "\t\t\t.setName(\"Model\")",
            "lineNumber": 286
          },
          {
            "text": "\t\t\t.setDesc(\"Ollama model used when you run this model node\")",
            "lineNumber": 287
          },
          {
            "text": "\t\t\t.addDropdown((dropdown) =&gt; {",
            "lineNumber": 288
          },
          {
            "text": "\t\t\t\tdropdown.addOption(\"\", \"— Select model —\");",
            "lineNumber": 289
          },
          {
            "text": "\t\t\t\tfor (const name of models) dropdown.addOption(name, name);",
            "lineNumber": 290
          },
          {
            "text": "\t\t\t\tconst current = (s[modelKey] as string) || \"\";",
            "lineNumber": 291
          },
          {
            "text": "\t\t\t\tdropdown.setValue(current &amp;&amp; models.includes(current) ? current : \"\");",
            "lineNumber": 292
          },
          {
            "text": "\t\t\t\tdropdown.onChange(async (value) =&gt; {",
            "lineNumber": 293
          },
          {
            "text": "\t\t\t\t\t(plugin.settings as unknown as Record&lt;string, string&gt;)[modelKey] = value;",
            "lineNumber": 294
          },
          {
            "text": "\t\t\t\t\tupdateSummaryText();",
            "lineNumber": 295
          },
          {
            "text": "\t\t\t\t\tawait plugin.saveSettings();",
            "lineNumber": 296
          },
          {
            "text": "\t\t\t\t});",
            "lineNumber": 297
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 298
          },
          {
            "text": "\t} else {",
            "lineNumber": 299
          },
          {
            "text": "\t\tnew Setting(content)",
            "lineNumber": 300
          },
          {
            "text": "\t\t\t.setName(\"Model\")",
            "lineNumber": 301
          },
          {
            "text": "\t\t\t.setDesc(\"Ollama model name (e.g. llama2, mistral). Enter manually if Ollama is not reachable.\")",
            "lineNumber": 302
          },
          {
            "text": "\t\t\t.addText((text) =&gt; text",
            "lineNumber": 303
          },
          {
            "text": "\t\t\t\t.setPlaceholder(\"e.g. llama2\")",
            "lineNumber": 304
          },
          {
            "text": "\t\t\t\t.setValue((s[modelKey] as string) || \"\")",
            "lineNumber": 305
          },
          {
            "text": "\t\t\t\t.onChange(async (value) =&gt; {",
            "lineNumber": 306
          },
          {
            "text": "\t\t\t\t\t(plugin.settings as unknown as Record&lt;string, string&gt;)[modelKey] = value;",
            "lineNumber": 307
          },
          {
            "text": "\t\t\t\t\tupdateSummaryText();",
            "lineNumber": 308
          },
          {
            "text": "\t\t\t\t\tawait plugin.saveSettings();",
            "lineNumber": 309
          },
          {
            "text": "\t\t\t\t}));",
            "lineNumber": 310
          },
          {
            "text": "\t}",
            "lineNumber": 311
          },
          {
            "lineNumber": 312
          },
          {
            "text": "\tnew Setting(content)",
            "lineNumber": 313
          },
          {
            "text": "\t\t.setName(\"Label\")",
            "lineNumber": 314
          },
          {
            "text": "\t\t.setDesc(\"Optional label on the canvas (e.g. quick, big); model name is shown after it\")",
            "lineNumber": 315
          },
          {
            "text": "\t\t.addText((text) =&gt; text",
            "lineNumber": 316
          },
          {
            "text": "\t\t\t.setPlaceholder(\"e.g. quick\")",
            "lineNumber": 317
          },
          {
            "text": "\t\t\t.setValue((s[labelKey] as string) || \"\")",
            "lineNumber": 318
          },
          {
            "text": "\t\t\t.onChange(async (value) =&gt; {",
            "lineNumber": 319
          },
          {
            "text": "\t\t\t\t(plugin.settings as unknown as Record&lt;string, string&gt;)[labelKey] = value;",
            "lineNumber": 320
          },
          {
            "text": "\t\t\t\tupdateSummaryText();",
            "lineNumber": 321
          },
          {
            "text": "\t\t\t\tawait plugin.saveSettings();",
            "lineNumber": 322
          },
          {
            "text": "\t\t\t}));",
            "lineNumber": 323
          },
          {
            "lineNumber": 324
          },
          {
            "text": "\tnew Setting(content)",
            "lineNumber": 325
          },
          {
            "text": "\t\t.setName(\"Temperature\")",
            "lineNumber": 326
          },
          {
            "text": "\t\t.setDesc",
            "lineNumber": 327
          },
          {
            "lineNumber": 334
          },
          {
            "text": "}",
            "lineNumber": 346,
            "isSignature": true
          }
        ]
      },
      "score": 0.21072080731391907
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/types.ts",
        "range": {
          "startPosition": {
            "line": 121,
            "column": 50
          },
          "endPosition": {
            "line": 156,
            "column": 84
          }
        },
        "contents": "/** Find the Green (output) node for a given source node. Edge-first (label \"output\"), then position fallback. */\nexport function findOutputNodeForSource(\n\tdata: CanvasData,\n\tsourceNodeId: string,\n\tsettings: ZettelPluginSettings\n): string | null {\n\tconst outputEdge = data.edges.find(\n\t\t(e) =&gt; e.fromNode === sourceNodeId &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT\n\t);\n\tif (outputEdge) return outputEdge.toNode;\n\tconst source = getNodeById(data, sourceNodeId);\n\tif (!source) return null;\n\tconst greenColor = normalizeColor(settings.colorGreen as CanvasColor | undefined);\n\tif (!greenColor) return null;\n\tconst expectedY = source.y + source.height + GREEN_NODE_PADDING;\n\tconst toleranceAbove = 30; // allow small layout drift above default\n\tconst candidates: { id: string; centerY: number }[] = [];\n\tfor (const node of data.nodes) {\n\t\tif (node.id === sourceNodeId) continue;\n\t\tif (normalizeColor(node.color) !== greenColor) continue;\n\t\tif (Math.abs(node.x - source.x) &gt; 50) continue;\n\t\tif (node.y &lt; expectedY - toleranceAbove || node.y &gt; expectedY + OUTPUT_POSITION_FALLBACK_MAX_Y) continue;\n\t\tconst centerY = node.y + (node.height ?? 0) / 2;\n\t\tcandidates.push({ id: node.id, centerY });\n\t}\n\tif (candidates.length === 0) return null;\n\t// Prefer the green whose center is closest to expectedY (avoids wrong match when sources are stacked)\n\tconst best = candidates.reduce((a, b) =&gt;\n\t\tMath.abs(a.centerY - expectedY) &lt;= Math.abs(b.centerY - expectedY) ? a : b\n\t);\n\treturn best.id;\n}\n\n/** Check if canvas has any output nodes (green nodes connected by output edges). */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Find the Green (output) node for a given source node. Edge-first (label \"output\"), then position fallback. */",
            "lineNumber": 124
          },
          {
            "text": "export function findOutputNodeForSource(",
            "lineNumber": 125,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 126,
            "isSignature": true
          },
          {
            "text": "\tsourceNodeId: string,",
            "lineNumber": 127,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings",
            "lineNumber": 128,
            "isSignature": true
          },
          {
            "text": "): string | null {",
            "lineNumber": 129,
            "isSignature": true
          },
          {
            "text": "\tconst outputEdge = data.edges.find(",
            "lineNumber": 130
          },
          {
            "text": "\t\t(e) =&gt; e.fromNode === sourceNodeId &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT",
            "lineNumber": 131
          },
          {
            "text": "\t);",
            "lineNumber": 132
          },
          {
            "text": "\tif (outputEdge) return outputEdge.toNode;",
            "lineNumber": 133
          },
          {
            "text": "\tconst source = getNodeById(data, sourceNodeId);",
            "lineNumber": 134
          },
          {
            "text": "\tif (!source) return null;",
            "lineNumber": 135
          },
          {
            "text": "\tconst greenColor = normalizeColor(settings.colorGreen as CanvasColor | undefined);",
            "lineNumber": 136
          },
          {
            "text": "\tif (!greenColor) return null;",
            "lineNumber": 137
          },
          {
            "text": "\tconst expectedY = source.y + source.height + GREEN_NODE_PADDING;",
            "lineNumber": 138
          },
          {
            "text": "\tconst toleranceAbove = 30; // allow small layout drift above default",
            "lineNumber": 139
          },
          {
            "text": "\tconst candidates: { id: string; centerY: number }[] = [];",
            "lineNumber": 140
          },
          {
            "text": "\tfor (const node of data.nodes) {",
            "lineNumber": 141
          },
          {
            "text": "\t\tif (node.id === sourceNodeId) continue;",
            "lineNumber": 142
          },
          {
            "text": "\t\tif (normalizeColor(node.color) !== greenColor) continue;",
            "lineNumber": 143
          },
          {
            "text": "\t\tif (Math.abs(node.x - source.x) &gt; 50) continue;",
            "lineNumber": 144
          },
          {
            "text": "\t\tif (node.y &lt; expectedY - toleranceAbove || node.y &gt; expectedY + OUTPUT_POSITION_FALLBACK_MAX_Y) continue;",
            "lineNumber": 145
          },
          {
            "text": "\t\tconst centerY = node.y + (node.height ?? 0) / 2;",
            "lineNumber": 146
          },
          {
            "text": "\t\tcandidates.push({ id: node.id, centerY });",
            "lineNumber": 147
          },
          {
            "text": "\t}",
            "lineNumber": 148
          },
          {
            "text": "\tif (candidates.length === 0) return null;",
            "lineNumber": 149
          },
          {
            "text": "\t// Prefer the green whose center is closest to expectedY (avoids wrong match when sources are stacked)",
            "lineNumber": 150
          },
          {
            "text": "\tconst best = candidates.reduce((a, b) =&gt;",
            "lineNumber": 151
          },
          {
            "text": "\t\tMath.abs(a.centerY - expectedY) &lt;= Math.abs(b.centerY - expectedY) ? a : b",
            "lineNumber": 152
          },
          {
            "text": "\t);",
            "lineNumber": 153
          },
          {
            "text": "\treturn best.id;",
            "lineNumber": 154
          },
          {
            "text": "}",
            "lineNumber": 155,
            "isSignature": true
          },
          {
            "lineNumber": 156
          },
          {
            "text": "/** Check if canvas has any output nodes (green nodes connected by output edges). */",
            "lineNumber": 157
          }
        ]
      },
      "score": 0.20773565769195557
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "column": 76
          },
          "endPosition": {
            "line": 43,
            "column": 99
          }
        },
        "contents": " from \"obsidian\";\nimport {DEFAULT_SETTINGS, ZettelPluginSettings, ZettelSettingTab} from \"./settings\";\nimport {ZettelControlsView, ZETTEL_CONTROLS_VIEW_TYPE} from \"./views/ZettelControlsView\";\nimport {CanvasTemplateModal} from \"./views/CanvasTemplateModal\";\nimport {duplicateCanvasTemplate, saveCanvasAsTemplate, isCanvasInTemplateFolder} from \"./canvas/canvasTemplates\";\nimport {\n\tdismissAllOutput as runnerDismissAllOutput,\n\tdismissOutput as runnerDismissOutput,\n\trunChain as runnerRunChain,\n\trunEntireCanvas as runnerRunEntireCanvas,\n\trunNode as runnerRunNode,\n} from \"./engine/runner\";\nimport {\n\tclearCanvasEdgeModeLabels,\n\tclearCanvasLegend,\n\tclearCanvasRoleLabels,\n\tsyncCanvasEdgeModeLabels,\n\tsyncCanvasRoleLabels,\n} from \"./canvas/canvasNodeLabels\";\nimport {hasOutputNodes, loadCanvasData, saveCanvasData} from \"./canvas/nodes\";\nimport type {CanvasData} from \"./canvas/types\";\nimport {EDGE_LABEL_OUTPUT} from \"./canvas/types\";\nimport {getKernelForCanvas, terminateAllKernels, terminateKernel} from \"./engine/kernelManager\";\nimport {getExample1CanvasData} from \"./tutorials/example1Data\";\nimport {getExample4CanvasData} from \"./tutorials/example4Data\";\n\n/** Layout constants: comment margins left/right, central lane for nodes, no overlap. */\nconst TUT_LEFT = 80;\nconst TUT_TOP = 50;\nconst TUT_WELCOME_W = 420;\nconst TUT_WELCOME_H = 118;\nconst TUT_WELCOME_BOTTOM_GAP = 70;\n/** Per-column: left comment margin | node lane | right comment margin. */\nconst TUT_COMMENT_W = 185;\nconst TUT_LANE_GAP = 22;\nconst TUT_NODE_LANE_W = 260;\nconst TUT_COL_TOTAL_W = TUT_COMMENT_W + TUT_LANE_GAP + TUT_NODE_LANE_W + TUT_LANE_GAP + TUT_COMMENT_W;\nconst TUT_COL_GAP = 85;\nconst TUT_NODE_H = 115;\nconst TUT_NODE_GAP = 58;\nconst TUT_LABEL_H = 88;\nconst TUT_GROUP_PAD = 18;\n\n/** Resolve role color from settings (fallback to default so tutorial always has a valid color). */",
        "signatures": {},
        "detailedLines": [
          {
            "text": " from \"obsidian\";",
            "lineNumber": 1
          },
          {
            "text": "import {DEFAULT_SETTINGS, ZettelPluginSettings, ZettelSettingTab} from \"./settings\";",
            "lineNumber": 2
          },
          {
            "text": "import {ZettelControlsView, ZETTEL_CONTROLS_VIEW_TYPE} from \"./views/ZettelControlsView\";",
            "lineNumber": 3
          },
          {
            "text": "import {CanvasTemplateModal} from \"./views/CanvasTemplateModal\";",
            "lineNumber": 4
          },
          {
            "text": "import {duplicateCanvasTemplate, saveCanvasAsTemplate, isCanvasInTemplateFolder} from \"./canvas/canvasTemplates\";",
            "lineNumber": 5
          },
          {
            "text": "import {",
            "lineNumber": 6
          },
          {
            "text": "\tdismissAllOutput as runnerDismissAllOutput,",
            "lineNumber": 7
          },
          {
            "text": "\tdismissOutput as runnerDismissOutput,",
            "lineNumber": 8
          },
          {
            "text": "\trunChain as runnerRunChain,",
            "lineNumber": 9
          },
          {
            "text": "\trunEntireCanvas as runnerRunEntireCanvas,",
            "lineNumber": 10
          },
          {
            "text": "\trunNode as runnerRunNode,",
            "lineNumber": 11
          },
          {
            "text": "} from \"./engine/runner\";",
            "lineNumber": 12
          },
          {
            "text": "import {",
            "lineNumber": 13
          },
          {
            "text": "\tclearCanvasEdgeModeLabels,",
            "lineNumber": 14
          },
          {
            "text": "\tclearCanvasLegend,",
            "lineNumber": 15
          },
          {
            "text": "\tclearCanvasRoleLabels,",
            "lineNumber": 16
          },
          {
            "text": "\tsyncCanvasEdgeModeLabels,",
            "lineNumber": 17
          },
          {
            "text": "\tsyncCanvasRoleLabels,",
            "lineNumber": 18
          },
          {
            "text": "} from \"./canvas/canvasNodeLabels\";",
            "lineNumber": 19
          },
          {
            "text": "import {hasOutputNodes, loadCanvasData, saveCanvasData} from \"./canvas/nodes\";",
            "lineNumber": 20
          },
          {
            "text": "import type {CanvasData} from \"./canvas/types\";",
            "lineNumber": 21
          },
          {
            "text": "import {EDGE_LABEL_OUTPUT} from \"./canvas/types\";",
            "lineNumber": 22
          },
          {
            "text": "import {getKernelForCanvas, terminateAllKernels, terminateKernel} from \"./engine/kernelManager\";",
            "lineNumber": 23
          },
          {
            "text": "import {getExample1CanvasData} from \"./tutorials/example1Data\";",
            "lineNumber": 24
          },
          {
            "text": "import {getExample4CanvasData} from \"./tutorials/example4Data\";",
            "lineNumber": 25
          },
          {
            "lineNumber": 26
          },
          {
            "text": "/** Layout constants: comment margins left/right, central lane for nodes, no overlap. */",
            "lineNumber": 27
          },
          {
            "text": "const TUT_LEFT = 80;",
            "lineNumber": 28
          },
          {
            "text": "const TUT_TOP = 50;",
            "lineNumber": 29
          },
          {
            "text": "const TUT_WELCOME_W = 420;",
            "lineNumber": 30
          },
          {
            "text": "const TUT_WELCOME_H = 118;",
            "lineNumber": 31
          },
          {
            "text": "const TUT_WELCOME_BOTTOM_GAP = 70;",
            "lineNumber": 32
          },
          {
            "text": "/** Per-column: left comment margin | node lane | right comment margin. */",
            "lineNumber": 33
          },
          {
            "text": "const TUT_COMMENT_W = 185;",
            "lineNumber": 34
          },
          {
            "text": "const TUT_LANE_GAP = 22;",
            "lineNumber": 35
          },
          {
            "text": "const TUT_NODE_LANE_W = 260;",
            "lineNumber": 36
          },
          {
            "text": "const TUT_COL_TOTAL_W = TUT_COMMENT_W + TUT_LANE_GAP + TUT_NODE_LANE_W + TUT_LANE_GAP + TUT_COMMENT_W;",
            "lineNumber": 37
          },
          {
            "text": "const TUT_COL_GAP = 85;",
            "lineNumber": 38
          },
          {
            "text": "const TUT_NODE_H = 115;",
            "lineNumber": 39
          },
          {
            "text": "const TUT_NODE_GAP = 58;",
            "lineNumber": 40
          },
          {
            "text": "const TUT_LABEL_H = 88;",
            "lineNumber": 41
          },
          {
            "text": "const TUT_GROUP_PAD = 18;",
            "lineNumber": 42
          },
          {
            "lineNumber": 43
          },
          {
            "text": "/** Resolve role color from settings (fallback to default so tutorial always has a valid color). */",
            "lineNumber": 44
          }
        ]
      },
      "score": 0.20739954710006714
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 251,
            "column": 1
          },
          "endPosition": {
            "line": 346,
            "column": 1
          }
        },
        "contents": "/** Run a single node: get input + parent context (concatenate or {{var:name}}), call LLM or Python, store result. */\nasync function runSingleNode(\n\tapp: App,\n\tsettings: ZettelPluginSettings,\n\tcanvasKey: string,\n\tcanvasFilePath: string,\n\tdata: CanvasData,\n\tnodeId: string,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;string&gt; {\n\tconst node = getNodeById(data, nodeId);\n\tif (!node) return \"\";\n\tconst role = getNodeRole(node, settings);\n\tif (!role || role === \"yellow\" || role === \"green\") {\n\t\t// Yellow = text (input pass-through): use node content as result\n\t\tif (role === \"yellow\") {\n\t\t\tconst content = await getNodeContent(node, app.vault);\n\t\t\tsetNodeResult(canvasKey, nodeId, content);\n\t\t\treturn content;\n\t\t}\n\t\treturn \"\";\n\t}\n\t// For Python (blue) text nodes, auto-wrap content in &#96;&#96;&#96;python ... &#96;&#96;&#96; so # comments render correctly\n\tif (role === \"blue\" &amp;&amp; isTextNode(node)) {\n\t\tconst raw = getTextNodeContent(node as CanvasTextData);\n\t\tif (!isPythonCodeFenced(raw)) {\n\t\t\t(node as CanvasTextData).text = ensurePythonCodeFence(raw);\n\t\t\tliveCanvas?.setData?.(data);\n\t\t\tawait saveCanvasData(app.vault, canvasFilePath, data);\n\t\t}\n\t}\n\tconst incoming = getIncomingEdgesWithLabels(nodeId, data);\n\tconst nodeInput = await getNodeContent(node, app.vault);\n\tconst { concatenatedPart, template, edgeModes } = buildInputWithVariables(\n\t\tcanvasKey,\n\t\tnodeInput,\n\t\tincoming\n\t);\n\tconst fullPrompt =\n\t\tconcatenatedPart.length &gt; 0 ? &#96;${concatenatedPart}\\n\\n---\\n\\n${template}&#96; : template;\n\n\tif (role === \"orange\") {\n\t\tconst model = settings.ollamaOrangeModel || \"llama2\";\n\t\tconst temperature = settings.ollamaOrangeTemperature ?? DEFAULT_SETTINGS.ollamaOrangeTemperature;\n\t\tconst result = await ollamaGenerate({\n\t\t\tmodel,\n\t\t\tprompt: fullPrompt,\n\t\t\tstream: false,\n\t\t\toptions: { temperature },\n\t\t});\n\t\tsetNodeResult(canvasKey, nodeId, result);\n\t\tensureOutputNodeAndEdge(data, node, result, settings);\n\t\tawait updateEdgeLabelsAndSave(app.vault, canvasFilePath, data, nodeId, edgeModes, liveCanvas);\n\t\treturn result;\n\t}\n\tif (role === \"purple\") {\n\t\tconst model = settings.ollamaPurpleModel || \"llama2\";\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Run a single node: get input + parent context (concatenate or {{var:name}}), call LLM or Python, store result. */",
            "lineNumber": 254
          },
          {
            "text": "async function runSingleNode(",
            "lineNumber": 255,
            "isSignature": true
          },
          {
            "text": "\tapp: App,",
            "lineNumber": 256,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 257,
            "isSignature": true
          },
          {
            "text": "\tcanvasKey: string,",
            "lineNumber": 258,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 259,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 260,
            "isSignature": true
          },
          {
            "text": "\tnodeId: string,",
            "lineNumber": 261,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 262,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;string&gt; {",
            "lineNumber": 263,
            "isSignature": true
          },
          {
            "text": "\tconst node = getNodeById(data, nodeId);",
            "lineNumber": 264
          },
          {
            "text": "\tif (!node) return \"\";",
            "lineNumber": 265
          },
          {
            "text": "\tconst role = getNodeRole(node, settings);",
            "lineNumber": 266
          },
          {
            "text": "\tif (!role || role === \"yellow\" || role === \"green\") {",
            "lineNumber": 267
          },
          {
            "text": "\t\t// Yellow = text (input pass-through): use node content as result",
            "lineNumber": 268
          },
          {
            "text": "\t\tif (role === \"yellow\") {",
            "lineNumber": 269
          },
          {
            "text": "\t\t\tconst content = await getNodeContent(node, app.vault);",
            "lineNumber": 270
          },
          {
            "text": "\t\t\tsetNodeResult(canvasKey, nodeId, content);",
            "lineNumber": 271
          },
          {
            "text": "\t\t\treturn content;",
            "lineNumber": 272
          },
          {
            "text": "\t\t}",
            "lineNumber": 273
          },
          {
            "text": "\t\treturn \"\";",
            "lineNumber": 274
          },
          {
            "text": "\t}",
            "lineNumber": 275
          },
          {
            "text": "\t// For Python (blue) text nodes, auto-wrap content in &#96;&#96;&#96;python ... &#96;&#96;&#96; so # comments render correctly",
            "lineNumber": 276
          },
          {
            "text": "\tif (role === \"blue\" &amp;&amp; isTextNode(node)) {",
            "lineNumber": 277
          },
          {
            "text": "\t\tconst raw = getTextNodeContent(node as CanvasTextData);",
            "lineNumber": 278
          },
          {
            "text": "\t\tif (!isPythonCodeFenced(raw)) {",
            "lineNumber": 279
          },
          {
            "text": "\t\t\t(node as CanvasTextData).text = ensurePythonCodeFence(raw);",
            "lineNumber": 280
          },
          {
            "text": "\t\t\tliveCanvas?.setData?.(data);",
            "lineNumber": 281
          },
          {
            "text": "\t\t\tawait saveCanvasData(app.vault, canvasFilePath, data);",
            "lineNumber": 282
          },
          {
            "text": "\t\t}",
            "lineNumber": 283
          },
          {
            "text": "\t}",
            "lineNumber": 284
          },
          {
            "text": "\tconst incoming = getIncomingEdgesWithLabels(nodeId, data);",
            "lineNumber": 285
          },
          {
            "text": "\tconst nodeInput = await getNodeContent(node, app.vault);",
            "lineNumber": 286
          },
          {
            "text": "\tconst { concatenatedPart, template, edgeModes } = buildInputWithVariables(",
            "lineNumber": 287
          },
          {
            "text": "\t\tcanvasKey,",
            "lineNumber": 288
          },
          {
            "text": "\t\tnodeInput,",
            "lineNumber": 289
          },
          {
            "text": "\t\tincoming",
            "lineNumber": 290
          },
          {
            "text": "\t);",
            "lineNumber": 291
          },
          {
            "text": "\tconst fullPrompt =",
            "lineNumber": 292
          },
          {
            "text": "\t\tconcatenatedPart.length &gt; 0 ? &#96;${concatenatedPart}\\n\\n---\\n\\n${template}&#96; : template;",
            "lineNumber": 293
          },
          {
            "lineNumber": 294
          },
          {
            "text": "\tif (role === \"orange\") {",
            "lineNumber": 295
          },
          {
            "text": "\t\tconst model = settings.ollamaOrangeModel || \"llama2\";",
            "lineNumber": 296
          },
          {
            "text": "\t\tconst temperature = settings.ollamaOrangeTemperature ?? DEFAULT_SETTINGS.ollamaOrangeTemperature;",
            "lineNumber": 297
          },
          {
            "text": "\t\tconst result = await ollamaGenerate({",
            "lineNumber": 298
          },
          {
            "text": "\t\t\tmodel,",
            "lineNumber": 299
          },
          {
            "text": "\t\t\tprompt: fullPrompt,",
            "lineNumber": 300
          },
          {
            "text": "\t\t\tstream: false,",
            "lineNumber": 301
          },
          {
            "text": "\t\t\toptions: { temperature },",
            "lineNumber": 302
          },
          {
            "text": "\t\t});",
            "lineNumber": 303
          },
          {
            "text": "\t\tsetNodeResult(canvasKey, nodeId, result);",
            "lineNumber": 304
          },
          {
            "text": "\t\tensureOutputNodeAndEdge(data, node, result, settings);",
            "lineNumber": 305
          },
          {
            "text": "\t\tawait updateEdgeLabelsAndSave(app.vault, canvasFilePath, data, nodeId, edgeModes, liveCanvas);",
            "lineNumber": 306
          },
          {
            "text": "\t\treturn result;",
            "lineNumber": 307
          },
          {
            "text": "\t}",
            "lineNumber": 308
          },
          {
            "text": "\tif (role === \"purple\") {",
            "lineNumber": 309
          },
          {
            "text": "\t\tconst model = settings.ollamaPurpleModel || \"llama2\";",
            "lineNumber": 310
          },
          {
            "text": "}",
            "lineNumber": 347,
            "isSignature": true
          }
        ]
      },
      "score": 0.20643126964569092
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/canvasNodeLabels.ts",
        "range": {
          "startPosition": {
            "line": 15,
            "column": 61
          },
          "endPosition": {
            "line": 51,
            "column": 1
          }
        },
        "contents": "/** Try to get a canvas node's root DOM element from the live canvas (Obsidian uses .canvas-node, no data-id). */\nfunction getNodeElFromCanvas(canvas: LiveCanvas, nodeId: string): HTMLElement | null {\n\tconst nodes = canvas.nodes;\n\tif (!nodes) return null;\n\tlet view: {\n\t\tid?: string;\n\t\tnodeEl?: HTMLElement;\n\t\tel?: HTMLElement;\n\t\twrapperEl?: HTMLElement;\n\t\tcontainerEl?: HTMLElement;\n\t} | undefined;\n\tif (nodes instanceof Map) {\n\t\tview = nodes.get(nodeId) as typeof view;\n\t} else {\n\t\tfor (const n of nodes as Iterable&lt;typeof view&gt;) {\n\t\t\tif (n?.id === nodeId) {\n\t\t\t\tview = n;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\tif (!view) return null;\n\t// Obsidian canvas node view exposes the .canvas-node root via one of these\n\tif (view.nodeEl instanceof HTMLElement) return view.nodeEl;\n\tif (view.el instanceof HTMLElement) return view.el;\n\tif (view.wrapperEl instanceof HTMLElement) return view.wrapperEl;\n\tif (view.containerEl instanceof HTMLElement) return view.containerEl;\n\tif (view instanceof HTMLElement) return view;\n\treturn null;\n}\n\n/** Fallback: find node by data-id if present (some builds may use it). */\nfunction findNodeElementByDataId(containerEl: HTMLElement, nodeId: string): HTMLElement | null {\n\t\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Try to get a canvas node's root DOM element from the live canvas (Obsidian uses .canvas-node, no data-id). */",
            "lineNumber": 17
          },
          {
            "text": "function getNodeElFromCanvas(canvas: LiveCanvas, nodeId: string): HTMLElement | null {",
            "lineNumber": 18,
            "isSignature": true
          },
          {
            "text": "\tconst nodes = canvas.nodes;",
            "lineNumber": 19
          },
          {
            "text": "\tif (!nodes) return null;",
            "lineNumber": 20
          },
          {
            "text": "\tlet view: {",
            "lineNumber": 21
          },
          {
            "text": "\t\tid?: string;",
            "lineNumber": 22
          },
          {
            "text": "\t\tnodeEl?: HTMLElement;",
            "lineNumber": 23
          },
          {
            "text": "\t\tel?: HTMLElement;",
            "lineNumber": 24
          },
          {
            "text": "\t\twrapperEl?: HTMLElement;",
            "lineNumber": 25
          },
          {
            "text": "\t\tcontainerEl?: HTMLElement;",
            "lineNumber": 26
          },
          {
            "text": "\t} | undefined;",
            "lineNumber": 27
          },
          {
            "text": "\tif (nodes instanceof Map) {",
            "lineNumber": 28
          },
          {
            "text": "\t\tview = nodes.get(nodeId) as typeof view;",
            "lineNumber": 29
          },
          {
            "text": "\t} else {",
            "lineNumber": 30
          },
          {
            "text": "\t\tfor (const n of nodes as Iterable&lt;typeof view&gt;) {",
            "lineNumber": 31
          },
          {
            "text": "\t\t\tif (n?.id === nodeId) {",
            "lineNumber": 32
          },
          {
            "text": "\t\t\t\tview = n;",
            "lineNumber": 33
          },
          {
            "text": "\t\t\t\tbreak;",
            "lineNumber": 34
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 35
          },
          {
            "text": "\t\t}",
            "lineNumber": 36
          },
          {
            "text": "\t}",
            "lineNumber": 37
          },
          {
            "text": "\tif (!view) return null;",
            "lineNumber": 38
          },
          {
            "text": "\t// Obsidian canvas node view exposes the .canvas-node root via one of these",
            "lineNumber": 39
          },
          {
            "text": "\tif (view.nodeEl instanceof HTMLElement) return view.nodeEl;",
            "lineNumber": 40
          },
          {
            "text": "\tif (view.el instanceof HTMLElement) return view.el;",
            "lineNumber": 41
          },
          {
            "text": "\tif (view.wrapperEl instanceof HTMLElement) return view.wrapperEl;",
            "lineNumber": 42
          },
          {
            "text": "\tif (view.containerEl instanceof HTMLElement) return view.containerEl;",
            "lineNumber": 43
          },
          {
            "text": "\tif (view instanceof HTMLElement) return view;",
            "lineNumber": 44
          },
          {
            "text": "\treturn null;",
            "lineNumber": 45
          },
          {
            "text": "}",
            "lineNumber": 46,
            "isSignature": true
          },
          {
            "lineNumber": 47
          },
          {
            "text": "/** Fallback: find node by data-id if present (some builds may use it). */",
            "lineNumber": 48
          },
          {
            "text": "function findNodeElementByDataId(containerEl: HTMLElement, nodeId: string): HTMLElement | null {",
            "lineNumber": 49,
            "isSignature": true
          },
          {
            "text": "\t",
            "lineNumber": 50
          },
          {
            "text": "}",
            "lineNumber": 52,
            "isSignature": true
          }
        ]
      },
      "score": 0.2062617987394333
    }
  ]
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "append|createEl|canvas-node|pointer-events",
  "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "append|createEl|canvas-node|pointer-events",
    "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board": {
        "content": {
          "matches": [
            {
              "file": "src/settings.ts",
              "matches": [
                {
                  "lineNumber": 266,
                  "content": "\tconst details = containerEl.createEl(\"details\", { cls: \"ztb-model-block\" });"
                },
                {
                  "lineNumber": 270,
                  "content": "\tconst summary = details.createEl(\"summary\", { cls: \"ztb-model-block-summary\" });"
                },
                {
                  "lineNumber": 374,
                  "content": "\tinfo.createEl(\"div\", { cls: \"setting-item-name\", text: label });"
                },
                {
                  "lineNumber": 375,
                  "content": "\tinfo.createEl(\"div\", { cls: \"setting-item-description\", text: desc });"
                },
                {
                  "lineNumber": 397,
                  "content": "\tconst dropdownButton = dropdownContainer.createEl(\"button\", {"
                },
                {
                  "lineNumber": 493,
                  "content": "\tconst customHex = control.createEl(\"input\", {"
                },
                {
                  "lineNumber": 558,
                  "content": "\t\texecutionSection.createEl(\"h4\", { text: \"Model Configuration\", cls: \"ztb-section-title\" });"
                },
                {
                  "lineNumber": 570,
                  "content": "\t\t\t\tfallback.createEl(\"p\", { text: \"Ollama not reachable or no models installed. Enter model names manually or check Installation &amp; Dependencies section above.\" });"
                },
                {
                  "lineNumber": 591,
                  "content": "\t\tdisplaySection.createEl(\"h4\", { text: \"Display\", cls: \"ztb-section-title\" });"
                },
                {
                  "lineNumber": 632,
                  "content": "\t\ttemplatesSection.createEl(\"h4\", { text: \"Canvas Templates\", cls: \"ztb-section-title\" });"
                },
                {
                  "lineNumber": 663,
                  "content": "\t\tconst details = installSection.createEl(\"details\", { cls: \"ztb-install-section\" });"
                },
                {
                  "lineNumber": 664,
                  "content": "\t\tconst summary = details.createEl(\"summary\", { cls: \"ztb-section-title-clickable\" });"
                },
                {
                  "lineNumber": 665,
                  "content": "\t\tsummary.createEl(\"h4\", { text: \"Installation &amp; Dependencies\", cls: \"ztb-section-title-inline\" });"
                },
                {
                  "lineNumber": 751,
                  "content": "\t\tconst modelsDetails = content.createEl(\"details\", { cls: \"ztb-models-subsection\" });"
                },
                {
                  "lineNumber": 752,
                  "content": "\t\tconst modelsSummary = modelsDetails.createEl(\"summary\", { cls: \"ztb-subsection-summary\" });"
                },
                {
                  "lineNumber": 753,
                  "content": "\t\tmodelsSummary.createEl(\"h5\", { text: \"Recommended Models\", cls: \"ztb-subsection-title-inline\" });"
                }
              ]
            },
            {
              "file": "src/canvas/canvasNodeLabels.ts",
              "matches": [
                {
                  "lineNumber": 17,
                  "content": "/** Try to get a canvas node's root DOM element from the live canvas (Obsidian uses .canvas-node, no data-id). */"
                },
                {
                  "lineNumber": 39,
                  "content": "\t// Obsidian canvas node view exposes the .canvas-node root via one of these"
                },
                {
                  "lineNumber": 50,
                  "content": "\tconst el = containerEl.querySelector(&#96;.canvas-node[data-id=\"${nodeId}\"], [data-id=\"${nodeId}\"]&#96;);"
                },
                {
                  "lineNumber": 78,
                  "content": "\tconst swatch = document.createElement(\"span\");"
                },
                {
                  "lineNumber": 89,
                  "content": "/** Build and append the legend to the canvas container (vanilla DOM, no innerHTML). Order: primary → tertiary, then Python, Text, Output. */"
                },
                {
                  "lineNumber": 93,
                  "content": "\tconst legend = document.createElement(\"div\");"
                },
                {
                  "lineNumber": 95,
                  "content": "\tconst title = document.createElement(\"div\");"
                },
                {
                  "lineNumber": 98,
                  "content": "\tlegend.appendChild(title);"
                },
                {
                  "lineNumber": 102,
                  "content": "\t\tconst row = document.createElement(\"div\");"
                },
                {
                  "lineNumber": 104,
                  "content": "\t\trow.appendChild(createLegendSwatch(color));"
                },
                {
                  "lineNumber": 105,
                  "content": "\t\tconst text = document.createElement(\"span\");"
                },
                {
                  "lineNumber": 108,
                  "content": "\t\trow.appendChild(text);"
                },
                {
                  "lineNumber": 109,
                  "content": "\t\tlegend.appendChild(row);"
                },
                {
                  "lineNumber": 111,
                  "content": "\tconst otherRow = document.createElement(\"div\");"
                },
                {
                  "lineNumber": 113,
                  "content": "\tconst otherSwatch = document.createElement(\"span\");"
                },
                {
                  "lineNumber": 116,
                  "content": "\totherRow.appendChild(otherSwatch);"
                },
                {
                  "lineNumber": 117,
                  "content": "\tconst otherText = document.createElement(\"span\");"
                },
                {
                  "lineNumber": 120,
                  "content": "\totherRow.appendChild(otherText);"
                },
                {
                  "lineNumber": 121,
                  "content": "\tlegend.appendChild(otherRow);"
                },
                {
                  "lineNumber": 122,
                  "content": "\tcontainerEl.appendChild(legend);"
                },
                {
                  "lineNumber": 125,
                  "content": "/** Create a label element using Obsidian's canvas-node-label class (same as file nodes). */"
                },
                {
                  "lineNumber": 127,
                  "content": "\tconst el = document.createElement(\"div\");"
                },
                {
                  "lineNumber": 128,
                  "content": "\tel.setAttribute(\"class\", &#96;${LABEL_CLASS} canvas-node-label&#96;);"
                },
                {
                  "lineNumber": 137,
                  "content": " * Uses the live canvas node map to find each node's DOM element (.canvas-node)."
                },
                {
                  "lineNumber": 172,
                  "content": "\t\t// Append after .canvas-node-container so it matches Obsidian file node label position"
                },
                {
                  "lineNumber": 173,
                  "content": "\t\tnodeEl.append(label);"
                },
                {
                  "lineNumber": 281,
                  "content": "\t\tconst labelGroup = document.createElementNS(SVG_NS, \"g\");"
                },
                {
                  "lineNumber": 292,
                  "content": "\t\t\tconst circle = document.createElementNS(SVG_NS, \"circle\");"
                },
                {
                  "lineNumber": 297,
                  "content": "\t\t\tlabelGroup.appendChild(circle);"
                },
                {
                  "lineNumber": 300,
                  "content": "\t\tconst textEl = document.createElementNS(SVG_NS, \"text\");"
                },
                {
                  "lineNumber": 308,
                  "content": "\t\tlabelGroup.appendChild(textEl);"
                },
                {
                  "lineNumber": 309,
                  "content": "\t\tgroup.appendChild(labelGroup);"
                }
              ]
            },
            {
              "file": "src/main.ts",
              "matches": [
                {
                  "lineNumber": 287,
                  "content": "\t\tn(lab3, \"Concatenation: no edge label → parent output appended before your prompt (then \\\"---\\\", then this card).\", commentLeftX(col3), concatCommentY, \"\", TUT_COMMENT_W, TUT_LABEL_H + 12),"
                },
                {
                  "lineNumber": 441,
                  "content": "\t\t\t\t\tthis.registerEvent(on(\"canvas-node-menu\", addNodeMenuItems));"
                },
                {
                  "lineNumber": 794,
                  "content": "\t\tconst runBtn = bar.createEl(\"button\", { cls: \"ztb-toolbar-btn\" });"
                },
                {
                  "lineNumber": 799,
                  "content": "\t\tconst dismissBtn = bar.createEl(\"button\", { cls: \"ztb-toolbar-btn\" });"
                }
              ]
            },
            {
              "file": "src/tutorials/example4Data.ts",
              "matches": [
                {
                  "lineNumber": 80,
                  "content": "\t\t\t\ttext: \"# Init shared state\\nif 'notes' not in globals():\\n    notes = []\\n\\nnotes.append(input)\\nprint(f\\\"Stored: {input}\\\")\\nobsidian_log(f\\\"Total notes: {len(notes)}\\\")\","
                },
                {
                  "lineNumber": 100,
                  "content": "\t\t\t\ttext: \"# Reuse state\\nnotes.append(input)\\nprint(f\\\"Stored: {input}\\\")\\nobsidian_log(f\\\"Total notes: {len(notes)}\\\")\","
                }
              ]
            },
            {
              "file": "src/views/CanvasTemplateModal.ts",
              "matches": [
                {
                  "lineNumber": 29,
                  "content": "\t\tcontentEl.createEl(\"h2\", {text: \"Select canvas template\"});"
                },
                {
                  "lineNumber": 36,
                  "content": "\t\t\tmsg.createEl(\"p\", {text: \"No canvas templates found.\"});"
                },
                {
                  "lineNumber": 37,
                  "content": "\t\t\tmsg.createEl(\"p\", {"
                },
                {
                  "lineNumber": 43,
                  "content": "\t\t\tconst closeBtn = btnContainer.createEl(\"button\", {text: \"Close\"});"
                },
                {
                  "lineNumber": 74,
                  "content": "\t\tconst cancelBtn = btnContainer.createEl(\"button\", {text: \"Cancel\"});"
                }
              ]
            },
            {
              "file": "src/views/ZettelControlsView.ts",
              "matches": [
                {
                  "lineNumber": 51,
                  "content": "\t\tel.createEl(\"h4\", { text: \"Model mapping\", cls: \"ztb-section-title\" });"
                },
                {
                  "lineNumber": 124,
                  "content": "\t\tel.createEl(\"h4\", { text: \"Kernel controls\", cls: \"ztb-section-title\" });"
                },
                {
                  "lineNumber": 141,
                  "content": "\t\tel.createEl(\"h4\", { text: \"Environment variables\", cls: \"ztb-section-title\" });"
                },
                {
                  "lineNumber": 142,
                  "content": "\t\tconst envDesc = el.createEl(\"p\", { cls: \"ztb-env-desc\" });"
                },
                {
                  "lineNumber": 147,
                  "content": "\t\t\tconst keyInp = row.createEl(\"input\", { type: \"text\", cls: \"ztb-env-key\" });"
                },
                {
                  "lineNumber": 150,
                  "content": "\t\t\tconst valInp = row.createEl(\"input\", { type: \"text\", cls: \"ztb-env-val\" });"
                },
                {
                  "lineNumber": 160,
                  "content": "\t\t\trow.createEl(\"button\", { text: \"Remove\", cls: \"ztb-env-remove\" }).addEventListener(\"click\", () =&gt; {"
                },
                {
                  "lineNumber": 166,
                  "content": "\t\tconst addBtn = el.createEl(\"button\", { text: \"Add variable\", cls: \"ztb-env-add\" });"
                },
                {
                  "lineNumber": 170,
                  "content": "\t\tel.createEl(\"h4\", { text: \"Console\", cls: \"ztb-section-title\" });"
                },
                {
                  "lineNumber": 171,
                  "content": "\t\tconst consoleTip = el.createEl(\"p\", { cls: \"ztb-controls-tip\" });"
                },
                {
                  "lineNumber": 174,
                  "content": "\t\tconst appendLog = (line: string) =&gt; {"
                },
                {
                  "lineNumber": 175,
                  "content": "\t\t\tconst p = consoleEl.createEl(\"p\", { cls: \"ztb-console-line\" });"
                },
                {
                  "lineNumber": 183,
                  "content": "\t\t\t\tif (this.containerEl.isConnected) appendLog(line);"
                },
                {
                  "lineNumber": 192,
                  "content": "\t\tel.createEl(\"h4\", { text: \"Guide tips\", cls: \"ztb-section-title\" });"
                },
                {
                  "lineNumber": 193,
                  "content": "\t\tconst guideDetails = el.createEl(\"details\", { cls: \"ztb-guide-details\" });"
                },
                {
                  "lineNumber": 194,
                  "content": "\t\tguideDetails.createEl(\"summary\", { cls: \"ztb-guide-summary\", text: \"How to use the canvas\" });"
                },
                {
                  "lineNumber": 195,
                  "content": "\t\tconst guideList = guideDetails.createEl(\"ul\", { cls: \"ztb-guide-list\" });"
                },
                {
                  "lineNumber": 207,
                  "content": "\t\t\tconst li = guideList.createEl(\"li\");"
                }
              ]
            }
          ],
          "totalLines": 77,
          "totalMatchedLines": 77
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/styles.css</summary>

</details>
</tool-use>

---





---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/canvas/canvasNodeLabels.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/canvas/canvasNodeLabels.ts</summary>

</details>
</tool-use>

---


Checking how the canvas view gets live nodes and whether `setData` is used after run:


---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "setData|syncCanvasRoleLabels",
  "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "setData|syncCanvasRoleLabels",
    "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board": {
        "content": {
          "matches": [
            {
              "file": "src/engine/runner.ts",
              "matches": [
                {
                  "lineNumber": 249,
                  "content": "\tliveCanvas?.setData?.(data);"
                },
                {
                  "lineNumber": 281,
                  "content": "\t\t\tliveCanvas?.setData?.(data);"
                },
                {
                  "lineNumber": 660,
                  "content": "\tliveCanvas?.setData?.(data);"
                },
                {
                  "lineNumber": 681,
                  "content": "\tliveCanvas?.setData?.(data);"
                }
              ]
            },
            {
              "file": "src/canvas/canvasNodeLabels.ts",
              "matches": [
                {
                  "lineNumber": 140,
                  "content": "export async function syncCanvasRoleLabels("
                }
              ]
            },
            {
              "file": "src/main.ts",
              "matches": [
                {
                  "lineNumber": 18,
                  "content": "\tsyncCanvasRoleLabels,"
                },
                {
                  "lineNumber": 575,
                  "content": "\t\t\t\tsyncCanvasRoleLabels(this.app.vault, view.file.path, view.containerEl, this.settings, liveCanvas, isStillActive);"
                },
                {
                  "lineNumber": 582,
                  "content": "\t\t\t\t\t\t\tsyncCanvasRoleLabels(this.app.vault, v.file.path, v.containerEl, this.settings, v.canvas as import(\"./engine/canvasApi\").LiveCanvas, stillActive);"
                }
              ]
            },
            {
              "file": "src/engine/canvasApi.ts",
              "matches": [
                {
                  "lineNumber": 15,
                  "content": "\tsetData?(data: unknown): void;"
                }
              ]
            }
          ],
          "totalLines": 9,
          "totalMatchedLines": 9
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/canvas/canvasNodeLabels.ts</summary>

</details>
</tool-use>

---


Checking how Obsidian structures canvas nodes and whether our label could be covering the drag handle:


---

<tool-use data-tool-type="search" data-tool-name="web_search">
<details>
            <summary>Tool use: **web_search** • Searched web `undefined` • **1** results</summary>
        
| Title | URL | Chunk |
|-------|-----|-------|
| Web search results for query: Obsidian canvas node DOM structure draggable .canvas-node |  | Links:<br/>1. [Search code, repositories, users, issues, pull requests...](https://github.com/sofanati-nour/obsidian-canvas-web-renderer)<br/>2. [How to drag and drop DOM image into the canvas](https://konvajs.org/docs/sandbox/Drop_DOM_Element.html)<br/>3. [Search code, repositories, users, issues, pull requests...](https://github.com/obsidianmd/obsidian-api/blob/master/canvas.d.ts)<br/>4. [Search code, repositories, users, issues, pull requests...](https://github.com/shahriarkh/obsidian-canvas-snippets)<br/>5. [Nodes \| craft.js](https://craft.js.org/docs/concepts/nodes)<br/><br/># Obsidian Canvas Node DOM Structure<br/><br/>Based on the available search results, there is limited specific information about the `.canvas-node` DOM structure and its draggable properties in Obsidian Canvas.<br/><br/>## What's Available<br/><br/>The Obsidian API documentation defines canvas nodes at the data level through TypeScript interfaces.[3] Nodes contain:<br/>- **id**: unique identifier<br/>- **x, y, width, height**: positional and dimensional data<br/>- **color**: optional node color<br/><br/>The data structure supports multiple node types (file, text, link, group).[3]<br/><br/>## General Context<br/><br/>While the search results don't provide detailed DOM structure specifics for `.canvas-node`, they do reference related canvas concepts:<br/>- Obsidian Canvas is a visual note-linking system with nodes and edges[3]<br/>- There are community projects for canvas rendering and customization[1][4]<br/>- Canvas nodes in general frameworks (like craft.js) represent draggable/droppable elements with parent-child relationships[5]<br/><br/>## Note<br/><br/>To get precise information about the `.canvas-node` DOM class structure and its drag-and-drop implementation, you would need to inspect the Obsidian source code directly or consult plugin development documentation, as this specific implementation detail is not covered in the available search results. |

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/styles.css</summary>

</details>
</tool-use>

---


Forming a hypothesis: the plugin appends a role label ("Output node") to every node with a role, including green output nodes. That label is appended to the node's DOM and can sit on top of the drag handle; even with `pointer-events: none` in our CSS, Obsidian's `.canvas-node-label` or stacking could still block dragging. Skipping the role label for green (output) nodes and setting an inline `pointer-events: none` on the label element as a fallback.


---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Add debug logs to test hypotheses for output node position not moving
- [-] User reproduces bug; analyze logs and fix with evidence
- [ ] Verify fix with post-fix logs; remove instrumentation after confirmation
- [-] Fix: skip role label on output nodes so they stay draggable

</details>
</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** • Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/canvas/canvasNodeLabels.ts</summary>

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** • Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/canvas/canvasNodeLabels.ts</summary>

</details>

</tool-use>

---


Preserving existing output node position when updating so re-running doesn't snap moved nodes back:


---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>
</tool-use>

---


Preserving existing output node position when only updating content so re-runs don't snap it back.


---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** • Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>

</tool-use>

---





---

<tool-use data-tool-type="unknown" data-tool-name="read_lints">
<details>
<summary>Tool use: **read_lints**</summary>


Parameters:

```json
{
  "paths": [
    "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/canvas/canvasNodeLabels.ts",
    "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts"
  ]
}
```
Result:

```json
{
  "linterErrorsByFile": [
    {
      "relativeWorkspacePath": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/canvas/canvasNodeLabels.ts"
    },
    {
      "relativeWorkspacePath": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts"
    }
  ]
}
```
Status: **completed**


</details>
</tool-use>

---


Summary of what’s in place and what to do next.

**Cause (likely)**  
With the plugin enabled, we add a role label (“Output node”) to **every** node that has a role, including green output nodes. That label is a div appended to the node’s DOM. When the plugin creates the green nodes (e.g. via “Run entire canvas”), that label can sit on top of the node and block the canvas drag handle, so the node can’t be moved. With the plugin disabled, no label is added, so the same nodes are draggable.

**Changes made**

1. **Don’t add the role label on output (green) nodes**  
   In `syncCanvasRoleLabels` we now skip appending the label when `role === "green"`. Output nodes stay draggable and still show as green; they just don’t get the “Output node” label.

2. **Safer label behavior for other nodes**  
   In `createLabelEl` we set `el.style.pointerEvents = "none"` so the label never captures pointer events even if theme/plugin CSS overrides our class.

3. **Keep existing position when updating output**  
   In `ensureOutputNodeAndEdge`, when we **update** an existing output node (same node, new content), we keep its current `x`/`y` instead of resetting to the auto-chosen position. So if you move a green node and run again, it won’t jump back.

Debug instrumentation in `runner.ts` is still there for now so we can confirm behavior; we can remove it after you confirm everything works.

**What you should see**

- After rebuilding and reloading the plugin: run the canvas so green output nodes appear, then drag them. They should move.
- After moving a green node and running again: its position should stay where you put it.

<reproduction_steps>
1. Run `npm run build` in the plugin directory.
2. Reload Obsidian (or restart) so the updated plugin is loaded.
3. Open a canvas, run it (e.g. “Run entire canvas”) so green output nodes are created.
4. Drag a green output node to a new position and confirm it moves.
5. Run the canvas again (e.g. “Run entire canvas” or “Run node” on the source) and confirm the green node stays where you moved it.
6. Click **Proceed** to confirm or report any remaining issue.
</reproduction_steps>

---

_**User**_

Revert to having a label on a green output box (because that is not the problem). I found that I can move the green output node in a test vault with fewer plugins, fewer themes and styling.

---

_**Agent (model default, mode Agent)**_


Reverting the change that skipped the role label on green output nodes so the "Output node" label appears again.


---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** • Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/canvas/canvasNodeLabels.ts</summary>

</details>

</tool-use>

---


Reverted: green output nodes again get the “Output node” role label.

Still in place:
- **Inline `pointer-events: none`** on the role label element (so the label is less likely to block interaction under other themes/plugins).
- **Preserve existing position** when updating an existing output node so moved nodes don’t snap back on re-run.

So the drag issue in your main vault is likely from another plugin or theme (e.g. CSS or DOM that sits on top of canvas nodes). You can track it down by disabling other community plugins and switching to a default theme in that vault until the problem disappears, then re-enabling one by one.

---

_**User**_

I found that in a more complicated vault where the green output node could not be moved, the output node also wasn't saved when I switched away to another page and came back. Can you guide me on what could have happened?

---

_**Agent (model default, mode Agent)**_


Investigating how the plugin and Obsidian persist canvas data and what runs when we switch leaves:


---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "setData|saveCanvasData|requestSave|active-leaf|file-open",
  "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "setData|saveCanvasData|requestSave|active-leaf|file-open",
    "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board": {
        "content": {
          "matches": [
            {
              "file": "src/engine/runner.ts",
              "matches": [
                {
                  "lineNumber": 14,
                  "content": "\tsaveCanvasData,"
                },
                {
                  "lineNumber": 249,
                  "content": "\tliveCanvas?.setData?.(data);"
                },
                {
                  "lineNumber": 250,
                  "content": "\tconst saved = await saveCanvasData(vault, canvasFilePath, data);"
                },
                {
                  "lineNumber": 281,
                  "content": "\t\t\tliveCanvas?.setData?.(data);"
                },
                {
                  "lineNumber": 282,
                  "content": "\t\t\tawait saveCanvasData(app.vault, canvasFilePath, data);"
                },
                {
                  "lineNumber": 663,
                  "content": "\tliveCanvas?.setData?.(data);"
                },
                {
                  "lineNumber": 664,
                  "content": "\tif (liveCanvas?.requestSave) liveCanvas.requestSave();"
                },
                {
                  "lineNumber": 665,
                  "content": "\tconst saved = await saveCanvasData(vault, canvasFilePath, data);"
                },
                {
                  "lineNumber": 684,
                  "content": "\tliveCanvas?.setData?.(data);"
                },
                {
                  "lineNumber": 685,
                  "content": "\tif (liveCanvas?.requestSave) liveCanvas.requestSave();"
                },
                {
                  "lineNumber": 686,
                  "content": "\tconst saved = await saveCanvasData(vault, canvasFilePath, data);"
                }
              ]
            },
            {
              "file": "src/main.ts",
              "matches": [
                {
                  "lineNumber": 20,
                  "content": "import {hasOutputNodes, loadCanvasData, saveCanvasData} from \"./canvas/nodes\";"
                },
                {
                  "lineNumber": 589,
                  "content": "\t\t\tthis.registerEvent(this.app.workspace.on(\"active-leaf-change\", runSyncLabels));"
                },
                {
                  "lineNumber": 641,
                  "content": "\t\tconst saved = await saveCanvasData(vault, path, data);"
                }
              ]
            },
            {
              "file": "src/canvas/nodes.ts",
              "matches": [
                {
                  "lineNumber": 27,
                  "content": "export async function saveCanvasData(vault: Vault, filePath: string, data: CanvasData): Promise&lt;boolean&gt; {"
                }
              ]
            },
            {
              "file": "src/canvas/canvasTemplates.ts",
              "matches": [
                {
                  "lineNumber": 3,
                  "content": "import {loadCanvasData, saveCanvasData} from \"./nodes\";"
                },
                {
                  "lineNumber": 109,
                  "content": "\tconst success = await saveCanvasData(vault, outputPath, newCanvasData);"
                }
              ]
            },
            {
              "file": "src/views/ZettelControlsView.ts",
              "matches": [
                {
                  "lineNumber": 188,
                  "content": "\t\t\tthis.plugin.app.workspace.on(\"active-leaf-change\", wireKernelLog)"
                }
              ]
            },
            {
              "file": "src/engine/canvasApi.ts",
              "matches": [
                {
                  "lineNumber": 11,
                  "content": "\trequestSave?: () =&gt; void;"
                },
                {
                  "lineNumber": 15,
                  "content": "\tsetData?(data: unknown): void;"
                }
              ]
            }
          ],
          "totalLines": 20,
          "totalMatchedLines": 20
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="semantic_search_full">
<details>
<summary>Tool use: **semantic_search_full**</summary>


Parameters:

```json
{
  "query": "When does the plugin save canvas data or call setData on the canvas?",
  "includePattern": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
  "topK": 10,
  "explanation": ""
}
```
Result:

```json
{
  "codeResults": [
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/nodes.ts",
        "range": {
          "startPosition": {
            "line": 23,
            "column": 1
          },
          "endPosition": {
            "line": 56,
            "column": 1
          }
        },
        "contents": "/** Save canvas data to vault (writes the canvas file). */\nexport async function saveCanvasData(vault: Vault, filePath: string, data: CanvasData): Promise&lt;boolean&gt; {\n\ttry {\n\t\tconst raw = JSON.stringify(data);\n\t\tawait vault.adapter.write(filePath, raw);\n\t\treturn true;\n\t} catch {\n\t\treturn false;\n\t}\n}\n\n/** Get input content for a node: text node content or full file content. */\nexport async function getNodeContent(\n\tnode: AllCanvasNodeData,\n\tvault: Vault\n): Promise&lt;string&gt; {\n\t\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Save canvas data to vault (writes the canvas file). */",
            "lineNumber": 26
          },
          {
            "text": "export async function saveCanvasData(vault: Vault, filePath: string, data: CanvasData): Promise&lt;boolean&gt; {",
            "lineNumber": 27,
            "isSignature": true
          },
          {
            "text": "\ttry {",
            "lineNumber": 28
          },
          {
            "text": "\t\tconst raw = JSON.stringify(data);",
            "lineNumber": 29
          },
          {
            "text": "\t\tawait vault.adapter.write(filePath, raw);",
            "lineNumber": 30
          },
          {
            "text": "\t\treturn true;",
            "lineNumber": 31
          },
          {
            "text": "\t} catch {",
            "lineNumber": 32
          },
          {
            "text": "\t\treturn false;",
            "lineNumber": 33
          },
          {
            "text": "\t}",
            "lineNumber": 34
          },
          {
            "text": "}",
            "lineNumber": 35,
            "isSignature": true
          },
          {
            "lineNumber": 36
          },
          {
            "text": "/** Get input content for a node: text node content or full file content. */",
            "lineNumber": 37
          },
          {
            "text": "export async function getNodeContent(",
            "lineNumber": 38,
            "isSignature": true
          },
          {
            "text": "\tnode: AllCanvasNodeData,",
            "lineNumber": 39,
            "isSignature": true
          },
          {
            "text": "\tvault: Vault",
            "lineNumber": 40,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;string&gt; {",
            "lineNumber": 41,
            "isSignature": true
          },
          {
            "text": "\t",
            "lineNumber": 42
          },
          {
            "text": "}",
            "lineNumber": 57,
            "isSignature": true
          }
        ]
      },
      "score": 0.3718244135379791
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 329
          },
          "endPosition": {
            "line": 877,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\nasync onload() {\n // Track which paths we've warned about\n\t\t\tthis.registerEvent(\n\t\t\t\tthis.app.workspace.on(\"layout-change\", async () =&gt; {\n\t\t\t\t\tconst leaves = this.app.workspace.getLeavesOfType(\"canvas\");\n\t\t\t\t\tconst openPaths = new Set&lt;string&gt;();\n\t\t\t\t\tfor (const leaf of leaves) {\n\t\t\t\t\t\tconst v = leaf.view as { file?: { path: string } };\n\t\t\t\t\t\tif (v?.file?.path) openPaths.add(v.file.path);\n\t\t\t\t\t}\n\t\t\t\t\tfor (const path of previousCanvasPaths) {\n\t\t\t\t\t\tif (!openPaths.has(path)) {\n\t\t\t\t\t\t\t// Canvas is being closed - check for output nodes\n\t\t\t\t\t\t\tif (!hasShownOutputWarningForPath.has(path)) {\n\t\t\t\t\t\t\t\tconst data = await loadCanvasData(this.app.vault, path);\n\t\t\t\t\t\t\t\tif (data &amp;&amp; hasOutputNodes(data)) {\n\t\t\t\t\t\t\t\t\t// Show reminder about output nodes\n\t\t\t\t\t\t\t\t\tnew Notice(\"Canvas has output nodes. Remember to use \\\"Dismiss all output\\\" if you want to clean up before closing.\", 5000);\n\t\t\t\t\t\t\t\t\thasShownOutputWarningForPath.add(path);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t// Terminate kernel\n\t\t\t\t\t\t\tterminateKernel(path);\n\t\t\t\t\t\t\t// Clear warning flag after a delay (canvas might be reopened)\n\t\t\t\t\t\t\tsetTimeout(() =&gt; {\n\t\t\t\t\t\t\t\thasShownOutputWarningForPath.delete(path);\n\t\t\t\t\t\t\t}, 60000); // Clear after 1 minute\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tpreviousCanvasPaths = openPaths;\n\t\t\t\t})\n\t\t\t);\n\n\t\t\t// Floating role labels on canvas: sync when active leaf is a canvas, clear when not\n\t\t\tlet roleLabelsContainerEl: HTMLElement | null = null;\n\t\t\tlet roleLabelsIntervalId: number | null = null;\n\t\t\tconst runSyncLabels = (): void =&gt; {\n\t\t\t\tconst view = this.getActiveCanvasView();\n;\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 330,
                "column": 1
              },
              "endPosition": {
                "line": 330,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 330,
                "column": 16
              },
              "endPosition": {
                "line": 331,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 333,
                "column": 2
              },
              "endPosition": {
                "line": 334,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 330,
            "isSignature": true
          },
          {
            "text": "async onload() {",
            "lineNumber": 333
          },
          {
            "text": " // Track which paths we've warned about",
            "lineNumber": 493
          },
          {
            "text": "\t\t\tthis.registerEvent(",
            "lineNumber": 494
          },
          {
            "text": "\t\t\t\tthis.app.workspace.on(\"layout-change\", async () =&gt; {",
            "lineNumber": 495
          },
          {
            "text": "\t\t\t\t\tconst leaves = this.app.workspace.getLeavesOfType(\"canvas\");",
            "lineNumber": 496
          },
          {
            "text": "\t\t\t\t\tconst openPaths = new Set&lt;string&gt;();",
            "lineNumber": 497
          },
          {
            "text": "\t\t\t\t\tfor (const leaf of leaves) {",
            "lineNumber": 498
          },
          {
            "text": "\t\t\t\t\t\tconst v = leaf.view as { file?: { path: string } };",
            "lineNumber": 499
          },
          {
            "text": "\t\t\t\t\t\tif (v?.file?.path) openPaths.add(v.file.path);",
            "lineNumber": 500
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 501
          },
          {
            "text": "\t\t\t\t\tfor (const path of previousCanvasPaths) {",
            "lineNumber": 502
          },
          {
            "text": "\t\t\t\t\t\tif (!openPaths.has(path)) {",
            "lineNumber": 503
          },
          {
            "text": "\t\t\t\t\t\t\t// Canvas is being closed - check for output nodes",
            "lineNumber": 504
          },
          {
            "text": "\t\t\t\t\t\t\tif (!hasShownOutputWarningForPath.has(path)) {",
            "lineNumber": 505
          },
          {
            "text": "\t\t\t\t\t\t\t\tconst data = await loadCanvasData(this.app.vault, path);",
            "lineNumber": 506
          },
          {
            "text": "\t\t\t\t\t\t\t\tif (data &amp;&amp; hasOutputNodes(data)) {",
            "lineNumber": 507
          },
          {
            "text": "\t\t\t\t\t\t\t\t\t// Show reminder about output nodes",
            "lineNumber": 508
          },
          {
            "text": "\t\t\t\t\t\t\t\t\tnew Notice(\"Canvas has output nodes. Remember to use \\\"Dismiss all output\\\" if you want to clean up before closing.\", 5000);",
            "lineNumber": 509
          },
          {
            "text": "\t\t\t\t\t\t\t\t\thasShownOutputWarningForPath.add(path);",
            "lineNumber": 510
          },
          {
            "text": "\t\t\t\t\t\t\t\t}",
            "lineNumber": 511
          },
          {
            "text": "\t\t\t\t\t\t\t}",
            "lineNumber": 512
          },
          {
            "text": "\t\t\t\t\t\t\t// Terminate kernel",
            "lineNumber": 513
          },
          {
            "text": "\t\t\t\t\t\t\tterminateKernel(path);",
            "lineNumber": 514
          },
          {
            "text": "\t\t\t\t\t\t\t// Clear warning flag after a delay (canvas might be reopened)",
            "lineNumber": 515
          },
          {
            "text": "\t\t\t\t\t\t\tsetTimeout(() =&gt; {",
            "lineNumber": 516
          },
          {
            "text": "\t\t\t\t\t\t\t\thasShownOutputWarningForPath.delete(path);",
            "lineNumber": 517
          },
          {
            "text": "\t\t\t\t\t\t\t}, 60000); // Clear after 1 minute",
            "lineNumber": 518
          },
          {
            "text": "\t\t\t\t\t\t}",
            "lineNumber": 519
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 520
          },
          {
            "text": "\t\t\t\t\tpreviousCanvasPaths = openPaths;",
            "lineNumber": 521
          },
          {
            "text": "\t\t\t\t})",
            "lineNumber": 522
          },
          {
            "text": "\t\t\t);",
            "lineNumber": 523
          },
          {
            "lineNumber": 524
          },
          {
            "text": "\t\t\t// Floating role labels on canvas: sync when active leaf is a canvas, clear when not",
            "lineNumber": 525
          },
          {
            "text": "\t\t\tlet roleLabelsContainerEl: HTMLElement | null = null;",
            "lineNumber": 526
          },
          {
            "text": "\t\t\tlet roleLabelsIntervalId: number | null = null;",
            "lineNumber": 527
          },
          {
            "text": "\t\t\tconst runSyncLabels = (): void =&gt; {",
            "lineNumber": 528
          },
          {
            "text": "\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 529
          },
          {
            "text": ";",
            "lineNumber": 588
          },
          {
            "text": "\t}",
            "lineNumber": 595
          },
          {
            "text": "}",
            "lineNumber": 878,
            "isSignature": true
          }
        ]
      },
      "score": 0.3397946357727051
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 220,
            "column": 1
          },
          "endPosition": {
            "line": 253,
            "column": 117
          }
        },
        "contents": "/** Persist only base variable name in edge.label; store inject/concatenate in state for floating label. */\nasync function updateEdgeLabelsAndSave(\n\tvault: App[\"vault\"],\n\tcanvasFilePath: string,\n\tdata: CanvasData,\n\tnodeId: string,\n\tedgeModes: Map&lt;string, EdgeInputMode&gt;,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;void&gt; {\n\tconst canvasKey = getCanvasKey(canvasFilePath);\n\tsetEdgeModes(canvasKey, edgeModes);\n\tlet changed = false;\n\tfor (const edge of data.edges) {\n\t\tif (edge.toNode !== nodeId) continue;\n\t\tif (isOutputEdge(edge)) continue;\n\t\tconst mode = edgeModes.get(edge.id);\n\t\tif (mode == null) continue;\n\t\tconst baseName = parseEdgeVariableName(edge.label);\n\t\tif (baseName.length === 0) continue;\n\t\t// Keep only the variable name in the stored label so the user can edit it without touching (injected)/(concatenated)\n\t\tif (edge.label !== baseName) {\n\t\t\tedge.label = baseName;\n\t\t\tchanged = true;\n\t\t}\n\t}\n\t// Always persist so output node/edge mutations from ensureOutputNodeAndEdge are saved\n\tliveCanvas?.setData?.(data);\n\tconst saved = await saveCanvasData(vault, canvasFilePath, data);\n\tif (!saved) new Notice(\"Failed to save canvas.\");\n}\n\n/** Run a single node: get input + parent context (concatenate or {{var:name}}), call LLM or Python, store result. */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Persist only base variable name in edge.label; store inject/concatenate in state for floating label. */",
            "lineNumber": 223
          },
          {
            "text": "async function updateEdgeLabelsAndSave(",
            "lineNumber": 224,
            "isSignature": true
          },
          {
            "text": "\tvault: App[\"vault\"],",
            "lineNumber": 225,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 226,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 227,
            "isSignature": true
          },
          {
            "text": "\tnodeId: string,",
            "lineNumber": 228,
            "isSignature": true
          },
          {
            "text": "\tedgeModes: Map&lt;string, EdgeInputMode&gt;,",
            "lineNumber": 229,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 230,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;void&gt; {",
            "lineNumber": 231,
            "isSignature": true
          },
          {
            "text": "\tconst canvasKey = getCanvasKey(canvasFilePath);",
            "lineNumber": 232
          },
          {
            "text": "\tsetEdgeModes(canvasKey, edgeModes);",
            "lineNumber": 233
          },
          {
            "text": "\tlet changed = false;",
            "lineNumber": 234
          },
          {
            "text": "\tfor (const edge of data.edges) {",
            "lineNumber": 235
          },
          {
            "text": "\t\tif (edge.toNode !== nodeId) continue;",
            "lineNumber": 236
          },
          {
            "text": "\t\tif (isOutputEdge(edge)) continue;",
            "lineNumber": 237
          },
          {
            "text": "\t\tconst mode = edgeModes.get(edge.id);",
            "lineNumber": 238
          },
          {
            "text": "\t\tif (mode == null) continue;",
            "lineNumber": 239
          },
          {
            "text": "\t\tconst baseName = parseEdgeVariableName(edge.label);",
            "lineNumber": 240
          },
          {
            "text": "\t\tif (baseName.length === 0) continue;",
            "lineNumber": 241
          },
          {
            "text": "\t\t// Keep only the variable name in the stored label so the user can edit it without touching (injected)/(concatenated)",
            "lineNumber": 242
          },
          {
            "text": "\t\tif (edge.label !== baseName) {",
            "lineNumber": 243
          },
          {
            "text": "\t\t\tedge.label = baseName;",
            "lineNumber": 244
          },
          {
            "text": "\t\t\tchanged = true;",
            "lineNumber": 245
          },
          {
            "text": "\t\t}",
            "lineNumber": 246
          },
          {
            "text": "\t}",
            "lineNumber": 247
          },
          {
            "text": "\t// Always persist so output node/edge mutations from ensureOutputNodeAndEdge are saved",
            "lineNumber": 248
          },
          {
            "text": "\tliveCanvas?.setData?.(data);",
            "lineNumber": 249
          },
          {
            "text": "\tconst saved = await saveCanvasData(vault, canvasFilePath, data);",
            "lineNumber": 250
          },
          {
            "text": "\tif (!saved) new Notice(\"Failed to save canvas.\");",
            "lineNumber": 251
          },
          {
            "text": "}",
            "lineNumber": 252,
            "isSignature": true
          },
          {
            "lineNumber": 253
          },
          {
            "text": "/** Run a single node: get input + parent context (concatenate or {{var:name}}), call LLM or Python, store result. */",
            "lineNumber": 254
          }
        ]
      },
      "score": 0.33599376678466797
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 329
          },
          "endPosition": {
            "line": 877,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\nasync onload() {\nconst runSyncLabels = \n\n\t\t\t\tif (leaf?.view) {\n\t\t\t\t\tconst itemView = leaf.view as ViewWithFlag;\n\t\t\t\t\tif (itemView._ztbTitleBarActionsAdded) {\n\t\t\t\t\t\taddedToTitleBar = true;\n\t\t\t\t\t} else if (typeof itemView.addAction === \"function\") {\n\t\t\t\t\t\titemView.addAction(\"play\", \"Run entire canvas\", () =&gt; this.runEntireCanvas());\n\t\t\t\t\t\titemView.addAction(\"trash\", \"Dismiss all output\", () =&gt; this.dismissAllOutput());\n\t\t\t\t\t\titemView._ztbTitleBarActionsAdded = true;\n\t\t\t\t\t\taddedToTitleBar = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (!addedToTitleBar) this.addCanvasToolbarToContainer(view.containerEl);\n\t\t\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;\n\t\t\t\tconst isStillActive = (): boolean =&gt; this.getActiveCanvasView()?.containerEl === roleLabelsContainerEl;\n\t\t\t\tsyncCanvasRoleLabels(this.app.vault, view.file.path, view.containerEl, this.settings, liveCanvas, isStillActive);\n\t\t\t\tsyncCanvasEdgeModeLabels(this.app.vault, view.file.path, view.containerEl, liveCanvas, isStillActive);\n\t\t\t\tif (roleLabelsIntervalId == null) {\n\t\t\t\t\troleLabelsIntervalId = window.setInterval(() =&gt; {\n\t\t\t\t\t\tconst v = this.getActiveCanvasView();\n\t\t\t\t\t\tif (v != null &amp;&amp; v.containerEl === roleLabelsContainerEl) {\n\t\t\t\t\t\t\tconst stillActive = (): boolean =&gt; this.getActiveCanvasView()?.containerEl === roleLabelsContainerEl;\n\t\t\t\t\t\t\tsyncCanvasRoleLabels(this.app.vault, v.file.path, v.containerEl, this.settings, v.canvas as import(\"./engine/canvasApi\").LiveCanvas, stillActive);\n\t\t\t\t\t\t\tsyncCanvasEdgeModeLabels(this.app.vault, v.file.path, v.containerEl, v.canvas as import(\"./engine/canvasApi\").LiveCanvas, stillActive);\n\t\t\t\t\t\t}\n\t\t\t\t\t}, 2000);\n\t\t\t\t\t(this as unknown as { _roleLabelsIntervalId: number })._roleLabelsIntervalId = roleLabelsIntervalId;\n\t\t\t\t}\n\t\t\t};\n\t\t\tthis.registerEvent(this.app.workspace.on(\"active-leaf-change\", runSyncLabels));\n\t\t\trunSyncLabels();\n\t\t} catch (e) {\n\t\t\tconsole.error(\"Zettel Thinking Board onload error:\", e);\n\t\t\tthrow e;\n\t\t}\n\t}\n\n\tonunload() {\n\t\tterminateAllKernels();\n\t\tconst id = (;\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 330,
                "column": 1
              },
              "endPosition": {
                "line": 330,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 330,
                "column": 16
              },
              "endPosition": {
                "line": 331,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 333,
                "column": 2
              },
              "endPosition": {
                "line": 334,
                "column": 3
              }
            },
            {
              "startPosition": {
                "line": 528,
                "column": 4
              },
              "endPosition": {
                "line": 528,
                "column": 10
              }
            },
            {
              "startPosition": {
                "line": 528,
                "column": 10
              },
              "endPosition": {
                "line": 528,
                "column": 26
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 330,
            "isSignature": true
          },
          {
            "text": "async onload() {",
            "lineNumber": 333
          },
          {
            "text": "const runSyncLabels = ",
            "lineNumber": 528
          },
          {
            "lineNumber": 560
          },
          {
            "text": "\t\t\t\tif (leaf?.view) {",
            "lineNumber": 561
          },
          {
            "text": "\t\t\t\t\tconst itemView = leaf.view as ViewWithFlag;",
            "lineNumber": 562
          },
          {
            "text": "\t\t\t\t\tif (itemView._ztbTitleBarActionsAdded) {",
            "lineNumber": 563
          },
          {
            "text": "\t\t\t\t\t\taddedToTitleBar = true;",
            "lineNumber": 564
          },
          {
            "text": "\t\t\t\t\t} else if (typeof itemView.addAction === \"function\") {",
            "lineNumber": 565
          },
          {
            "text": "\t\t\t\t\t\titemView.addAction(\"play\", \"Run entire canvas\", () =&gt; this.runEntireCanvas());",
            "lineNumber": 566
          },
          {
            "text": "\t\t\t\t\t\titemView.addAction(\"trash\", \"Dismiss all output\", () =&gt; this.dismissAllOutput());",
            "lineNumber": 567
          },
          {
            "text": "\t\t\t\t\t\titemView._ztbTitleBarActionsAdded = true;",
            "lineNumber": 568
          },
          {
            "text": "\t\t\t\t\t\taddedToTitleBar = true;",
            "lineNumber": 569
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 570
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 571
          },
          {
            "text": "\t\t\t\tif (!addedToTitleBar) this.addCanvasToolbarToContainer(view.containerEl);",
            "lineNumber": 572
          },
          {
            "text": "\t\t\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;",
            "lineNumber": 573
          },
          {
            "text": "\t\t\t\tconst isStillActive = (): boolean =&gt; this.getActiveCanvasView()?.containerEl === roleLabelsContainerEl;",
            "lineNumber": 574
          },
          {
            "text": "\t\t\t\tsyncCanvasRoleLabels(this.app.vault, view.file.path, view.containerEl, this.settings, liveCanvas, isStillActive);",
            "lineNumber": 575
          },
          {
            "text": "\t\t\t\tsyncCanvasEdgeModeLabels(this.app.vault, view.file.path, view.containerEl, liveCanvas, isStillActive);",
            "lineNumber": 576
          },
          {
            "text": "\t\t\t\tif (roleLabelsIntervalId == null) {",
            "lineNumber": 577
          },
          {
            "text": "\t\t\t\t\troleLabelsIntervalId = window.setInterval(() =&gt; {",
            "lineNumber": 578
          },
          {
            "text": "\t\t\t\t\t\tconst v = this.getActiveCanvasView();",
            "lineNumber": 579
          },
          {
            "text": "\t\t\t\t\t\tif (v != null &amp;&amp; v.containerEl === roleLabelsContainerEl) {",
            "lineNumber": 580
          },
          {
            "text": "\t\t\t\t\t\t\tconst stillActive = (): boolean =&gt; this.getActiveCanvasView()?.containerEl === roleLabelsContainerEl;",
            "lineNumber": 581
          },
          {
            "text": "\t\t\t\t\t\t\tsyncCanvasRoleLabels(this.app.vault, v.file.path, v.containerEl, this.settings, v.canvas as import(\"./engine/canvasApi\").LiveCanvas, stillActive);",
            "lineNumber": 582
          },
          {
            "text": "\t\t\t\t\t\t\tsyncCanvasEdgeModeLabels(this.app.vault, v.file.path, v.containerEl, v.canvas as import(\"./engine/canvasApi\").LiveCanvas, stillActive);",
            "lineNumber": 583
          },
          {
            "text": "\t\t\t\t\t\t}",
            "lineNumber": 584
          },
          {
            "text": "\t\t\t\t\t}, 2000);",
            "lineNumber": 585
          },
          {
            "text": "\t\t\t\t\t(this as unknown as { _roleLabelsIntervalId: number })._roleLabelsIntervalId = roleLabelsIntervalId;",
            "lineNumber": 586
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 587
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 588
          },
          {
            "text": "\t\t\tthis.registerEvent(this.app.workspace.on(\"active-leaf-change\", runSyncLabels));",
            "lineNumber": 589
          },
          {
            "text": "\t\t\trunSyncLabels();",
            "lineNumber": 590
          },
          {
            "text": "\t\t} catch (e) {",
            "lineNumber": 591
          },
          {
            "text": "\t\t\tconsole.error(\"Zettel Thinking Board onload error:\", e);",
            "lineNumber": 592
          },
          {
            "text": "\t\t\tthrow e;",
            "lineNumber": 593
          },
          {
            "text": "\t\t}",
            "lineNumber": 594
          },
          {
            "text": "\t}",
            "lineNumber": 595
          },
          {
            "lineNumber": 596
          },
          {
            "text": "\tonunload() {",
            "lineNumber": 597
          },
          {
            "text": "\t\tterminateAllKernels();",
            "lineNumber": 598
          },
          {
            "text": "\t\tconst id = (;",
            "lineNumber": 599
          },
          {
            "text": "\t}",
            "lineNumber": 601
          },
          {
            "text": "}",
            "lineNumber": 878,
            "isSignature": true
          }
        ]
      },
      "score": 0.33342933654785156
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 582,
            "column": 1
          },
          "endPosition": {
            "line": 644,
            "column": 1
          }
        },
        "contents": "const CYCLE_ERROR_MESSAGE = \"Execution graph contains a cycle; fix connections and try again.\";\n\n/** Run all nodes reachable from any root, in topological order. */\nexport async function runEntireCanvas(\n\tapp: App,\n\tsettings: ZettelPluginSettings,\n\tcanvasFilePath: string,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;{ ok: boolean; message?: string }&gt; {\n\tconst data = await loadCanvasData(app.vault, canvasFilePath);\n\tif (!data) return { ok: false, message: \"Could not load canvas data.\" };\n\tconst topo = topologicalOrderFull(data, settings);\n\tif (\"cycle\" in topo) return { ok: false, message: CYCLE_ERROR_MESSAGE };\n\tconst order = topo.order;\n\tconst canvasKey = getCanvasKey(canvasFilePath);\n\ttry {\n\t\tfor (const nid of order) {\n\t\t\ttry {\n\t\t\t\tsetRunningNodeId(canvasKey, nid);\n\t\t\t\tawait runSingleNode(app, settings, canvasKey, canvasFilePath, data, nid, liveCanvas);\n\t\t\t} finally {\n\t\t\t\tsetRunningNodeId(canvasKey, null);\n\t\t\t}\n\t\t}\n\t\treturn { ok: true };\n\t} catch (e) {\n\t\treturn { ok: false, message: e instanceof Error ? e.message : String(e) };\n\t}\n}\n\n/** Run chain from roots to the given node. */\nexport async function runChain(\n\tapp: App,\n\tsettings: ZettelPluginSettings,\n\tcanvasFilePath: string,\n\tnodeId: string,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;{ ok: boolean; message?: string }&gt; {\n\t\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "const CYCLE_ERROR_MESSAGE = \"Execution graph contains a cycle; fix connections and try again.\";",
            "lineNumber": 585
          },
          {
            "lineNumber": 586
          },
          {
            "text": "/** Run all nodes reachable from any root, in topological order. */",
            "lineNumber": 587
          },
          {
            "text": "export async function runEntireCanvas(",
            "lineNumber": 588,
            "isSignature": true
          },
          {
            "text": "\tapp: App,",
            "lineNumber": 589,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 590,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 591,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 592,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;{ ok: boolean; message?: string }&gt; {",
            "lineNumber": 593,
            "isSignature": true
          },
          {
            "text": "\tconst data = await loadCanvasData(app.vault, canvasFilePath);",
            "lineNumber": 594
          },
          {
            "text": "\tif (!data) return { ok: false, message: \"Could not load canvas data.\" };",
            "lineNumber": 595
          },
          {
            "text": "\tconst topo = topologicalOrderFull(data, settings);",
            "lineNumber": 596
          },
          {
            "text": "\tif (\"cycle\" in topo) return { ok: false, message: CYCLE_ERROR_MESSAGE };",
            "lineNumber": 597
          },
          {
            "text": "\tconst order = topo.order;",
            "lineNumber": 598
          },
          {
            "text": "\tconst canvasKey = getCanvasKey(canvasFilePath);",
            "lineNumber": 599
          },
          {
            "text": "\ttry {",
            "lineNumber": 600
          },
          {
            "text": "\t\tfor (const nid of order) {",
            "lineNumber": 601
          },
          {
            "text": "\t\t\ttry {",
            "lineNumber": 602
          },
          {
            "text": "\t\t\t\tsetRunningNodeId(canvasKey, nid);",
            "lineNumber": 603
          },
          {
            "text": "\t\t\t\tawait runSingleNode(app, settings, canvasKey, canvasFilePath, data, nid, liveCanvas);",
            "lineNumber": 604
          },
          {
            "text": "\t\t\t} finally {",
            "lineNumber": 605
          },
          {
            "text": "\t\t\t\tsetRunningNodeId(canvasKey, null);",
            "lineNumber": 606
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 607
          },
          {
            "text": "\t\t}",
            "lineNumber": 608
          },
          {
            "text": "\t\treturn { ok: true };",
            "lineNumber": 609
          },
          {
            "text": "\t} catch (e) {",
            "lineNumber": 610
          },
          {
            "text": "\t\treturn { ok: false, message: e instanceof Error ? e.message : String(e) };",
            "lineNumber": 611
          },
          {
            "text": "\t}",
            "lineNumber": 612
          },
          {
            "text": "}",
            "lineNumber": 613,
            "isSignature": true
          },
          {
            "lineNumber": 614
          },
          {
            "text": "/** Run chain from roots to the given node. */",
            "lineNumber": 615
          },
          {
            "text": "export async function runChain(",
            "lineNumber": 616,
            "isSignature": true
          },
          {
            "text": "\tapp: App,",
            "lineNumber": 617,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 618,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 619,
            "isSignature": true
          },
          {
            "text": "\tnodeId: string,",
            "lineNumber": 620,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 621,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;{ ok: boolean; message?: string }&gt; {",
            "lineNumber": 622,
            "isSignature": true
          },
          {
            "text": "\t",
            "lineNumber": 623
          },
          {
            "text": "}",
            "lineNumber": 645,
            "isSignature": true
          }
        ]
      },
      "score": 0.32396209239959717
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 324,
            "column": 1
          },
          "endPosition": {
            "line": 877,
            "column": 1
          }
        },
        "contents": "/** Debug: set to true when canvas:node-menu callback has fired at least once (proves event is received). */\nlet debugNodeMenuFired = false;\n\nexport default class ZettelThinkingBoardPlugin extends Plugin {\n\tsettings: ZettelPluginSettings;\n\n\tasync onload() {\n\t\ttry {\n\t\t\tawait this.loadSettings();\n\t\t\tthis.addSettingTab(new ZettelSettingTab(this.app, this));\n\n\t\t\tthis.registerView(\n\t\t\t\tZETTEL_CONTROLS_VIEW_TYPE,\n\t\t\t\t(leaf: WorkspaceLeaf) =&gt; new ZettelControlsView(leaf, this)\n\t\t\t);\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"open-zettel-controls\",\n\t\t\t\tname: \"Open Zettel Controls\",\n\t\t\t\tcallback: () =&gt; this.activateZettelControls(),\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"create-tutorial-canvas\",\n\t\t\t\tname: \"Create tutorial canvas\",\n\t\t\t\tcallback: () =&gt; this.createTutorialCanvas(),\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"duplicate-canvas-template\",\n\t\t\t\tname: \"Duplicate canvas template\",\n\t\t\t\tcallback: () =&gt; this.duplicateCanvasTemplate(),\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"save-canvas-as-template\",\n\t\t\t\tname: \"Save canvas as template\",\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\t\tif (!view) return false;\n\t\t\t\t\tif (checking) return true;\n\t\t\t\t\tthis.saveCanvasAsTemplate();\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"edit-canvas-template\",\n\t\t\t\tname: \"Edit canvas template\",\n\t\t\t\tcallback: () =&gt; this.editCanvasTemplate(),\n\t\t\t});\n\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"run-node\",\n\t\t\t\tname: \"Run node\",\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\t\tif (!view) return false;\n\t\t\t\t\tif (checking) return true;\n\t\t\t\t\t// Command palette: no node selected; prompt user to use context menu\n\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Run node\\\" to run it.\");\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tthis.addCommand\n\n\t}\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Debug: set to true when canvas:node-menu callback has fired at least once (proves event is received). */",
            "lineNumber": 327
          },
          {
            "text": "let debugNodeMenuFired = false;",
            "lineNumber": 328
          },
          {
            "lineNumber": 329
          },
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 330,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings;",
            "lineNumber": 331
          },
          {
            "lineNumber": 332
          },
          {
            "text": "\tasync onload() {",
            "lineNumber": 333
          },
          {
            "text": "\t\ttry {",
            "lineNumber": 334
          },
          {
            "text": "\t\t\tawait this.loadSettings();",
            "lineNumber": 335
          },
          {
            "text": "\t\t\tthis.addSettingTab(new ZettelSettingTab(this.app, this));",
            "lineNumber": 336
          },
          {
            "lineNumber": 337
          },
          {
            "text": "\t\t\tthis.registerView(",
            "lineNumber": 338
          },
          {
            "text": "\t\t\t\tZETTEL_CONTROLS_VIEW_TYPE,",
            "lineNumber": 339
          },
          {
            "text": "\t\t\t\t(leaf: WorkspaceLeaf) =&gt; new ZettelControlsView(leaf, this)",
            "lineNumber": 340
          },
          {
            "text": "\t\t\t);",
            "lineNumber": 341
          },
          {
            "lineNumber": 342
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 343
          },
          {
            "text": "\t\t\t\tid: \"open-zettel-controls\",",
            "lineNumber": 344
          },
          {
            "text": "\t\t\t\tname: \"Open Zettel Controls\",",
            "lineNumber": 345
          },
          {
            "text": "\t\t\t\tcallback: () =&gt; this.activateZettelControls(),",
            "lineNumber": 346
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 347
          },
          {
            "lineNumber": 348
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 349
          },
          {
            "text": "\t\t\t\tid: \"create-tutorial-canvas\",",
            "lineNumber": 350
          },
          {
            "text": "\t\t\t\tname: \"Create tutorial canvas\",",
            "lineNumber": 351
          },
          {
            "text": "\t\t\t\tcallback: () =&gt; this.createTutorialCanvas(),",
            "lineNumber": 352
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 353
          },
          {
            "lineNumber": 354
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 355
          },
          {
            "text": "\t\t\t\tid: \"duplicate-canvas-template\",",
            "lineNumber": 356
          },
          {
            "text": "\t\t\t\tname: \"Duplicate canvas template\",",
            "lineNumber": 357
          },
          {
            "text": "\t\t\t\tcallback: () =&gt; this.duplicateCanvasTemplate(),",
            "lineNumber": 358
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 359
          },
          {
            "lineNumber": 360
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 361
          },
          {
            "text": "\t\t\t\tid: \"save-canvas-as-template\",",
            "lineNumber": 362
          },
          {
            "text": "\t\t\t\tname: \"Save canvas as template\",",
            "lineNumber": 363
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 364
          },
          {
            "text": "\t\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 365
          },
          {
            "text": "\t\t\t\t\tif (!view) return false;",
            "lineNumber": 366
          },
          {
            "text": "\t\t\t\t\tif (checking) return true;",
            "lineNumber": 367
          },
          {
            "text": "\t\t\t\t\tthis.saveCanvasAsTemplate();",
            "lineNumber": 368
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 369
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 370
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 371
          },
          {
            "lineNumber": 372
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 373
          },
          {
            "text": "\t\t\t\tid: \"edit-canvas-template\",",
            "lineNumber": 374
          },
          {
            "text": "\t\t\t\tname: \"Edit canvas template\",",
            "lineNumber": 375
          },
          {
            "text": "\t\t\t\tcallback: () =&gt; this.editCanvasTemplate(),",
            "lineNumber": 376
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 377
          },
          {
            "lineNumber": 378
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 379
          },
          {
            "text": "\t\t\t\tid: \"run-node\",",
            "lineNumber": 380
          },
          {
            "text": "\t\t\t\tname: \"Run node\",",
            "lineNumber": 381
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 382
          },
          {
            "text": "\t\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 383
          },
          {
            "text": "\t\t\t\t\tif (!view) return false;",
            "lineNumber": 384
          },
          {
            "text": "\t\t\t\t\tif (checking) return true;",
            "lineNumber": 385
          },
          {
            "text": "\t\t\t\t\t// Command palette: no node selected; prompt user to use context menu",
            "lineNumber": 386
          },
          {
            "text": "\t\t\t\t\tnew Notice(\"Right-click a node and choose \\\"Run node\\\" to run it.\");",
            "lineNumber": 387
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 388
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 389
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 390
          },
          {
            "lineNumber": 391
          },
          {
            "text": "\t\t\tthis.addCommand",
            "lineNumber": 392
          },
          {
            "lineNumber": 402
          },
          {
            "text": "\t}",
            "lineNumber": 595
          },
          {
            "text": "}",
            "lineNumber": 878,
            "isSignature": true
          }
        ]
      },
      "score": 0.3153381943702698
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 666,
            "column": 1
          },
          "endPosition": {
            "line": 687,
            "column": 1
          }
        },
        "contents": "/** Remove all Green output nodes and their output edges on the canvas; mutates data and saves. */\nexport async function dismissAllOutput(\n\tvault: App[\"vault\"],\n\tcanvasFilePath: string,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;void&gt; {\n\tconst data = await loadCanvasData(vault, canvasFilePath);\n\tif (!data) return;\n\tconst outputNodeIds = new Set(\n\t\tdata.edges\n\t\t\t.filter((e) =&gt; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT)\n\t\t\t.map((e) =&gt; e.toNode)\n\t);\n\tdata.nodes = data.nodes.filter((n) =&gt; !outputNodeIds.has(n.id));\n\tdata.edges = data.edges.filter((e) =&gt; parseEdgeVariableName(e.label) !== EDGE_LABEL_OUTPUT);\n\tliveCanvas?.setData?.(data);\n\tif (liveCanvas?.requestSave) liveCanvas.requestSave();\n\tconst saved = await saveCanvasData(vault, canvasFilePath, data);\n\tif (!saved) new Notice(\"Failed to save canvas.\");\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Remove all Green output nodes and their output edges on the canvas; mutates data and saves. */",
            "lineNumber": 669
          },
          {
            "text": "export async function dismissAllOutput(",
            "lineNumber": 670,
            "isSignature": true
          },
          {
            "text": "\tvault: App[\"vault\"],",
            "lineNumber": 671,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 672,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 673,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;void&gt; {",
            "lineNumber": 674,
            "isSignature": true
          },
          {
            "text": "\tconst data = await loadCanvasData(vault, canvasFilePath);",
            "lineNumber": 675
          },
          {
            "text": "\tif (!data) return;",
            "lineNumber": 676
          },
          {
            "text": "\tconst outputNodeIds = new Set(",
            "lineNumber": 677
          },
          {
            "text": "\t\tdata.edges",
            "lineNumber": 678
          },
          {
            "text": "\t\t\t.filter((e) =&gt; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT)",
            "lineNumber": 679
          },
          {
            "text": "\t\t\t.map((e) =&gt; e.toNode)",
            "lineNumber": 680
          },
          {
            "text": "\t);",
            "lineNumber": 681
          },
          {
            "text": "\tdata.nodes = data.nodes.filter((n) =&gt; !outputNodeIds.has(n.id));",
            "lineNumber": 682
          },
          {
            "text": "\tdata.edges = data.edges.filter((e) =&gt; parseEdgeVariableName(e.label) !== EDGE_LABEL_OUTPUT);",
            "lineNumber": 683
          },
          {
            "text": "\tliveCanvas?.setData?.(data);",
            "lineNumber": 684
          },
          {
            "text": "\tif (liveCanvas?.requestSave) liveCanvas.requestSave();",
            "lineNumber": 685
          },
          {
            "text": "\tconst saved = await saveCanvasData(vault, canvasFilePath, data);",
            "lineNumber": 686
          },
          {
            "text": "\tif (!saved) new Notice(\"Failed to save canvas.\");",
            "lineNumber": 687
          },
          {
            "text": "}",
            "lineNumber": 688,
            "isSignature": true
          }
        ]
      },
      "score": 0.3111443519592285
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 329
          },
          "endPosition": {
            "line": 877,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\n\n\n\tasync saveSettings() {\n\t\tawait this.saveData(this.settings);\n\t}\n\n\tasync activateZettelControls(): Promise&lt;void&gt; {\n\t\tconst {workspace} = this.app;\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 330,
                "column": 1
              },
              "endPosition": {
                "line": 330,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 330,
                "column": 16
              },
              "endPosition": {
                "line": 331,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 330,
            "isSignature": true
          },
          {
            "lineNumber": 609
          },
          {
            "lineNumber": 610
          },
          {
            "text": "\tasync saveSettings() {",
            "lineNumber": 611
          },
          {
            "text": "\t\tawait this.saveData(this.settings);",
            "lineNumber": 612
          },
          {
            "text": "\t}",
            "lineNumber": 613
          },
          {
            "lineNumber": 614
          },
          {
            "text": "\tasync activateZettelControls(): Promise&lt;void&gt; {",
            "lineNumber": 615
          },
          {
            "text": "\t\tconst {workspace} = this.app;",
            "lineNumber": 616
          },
          {
            "text": "\t}",
            "lineNumber": 628
          },
          {
            "text": "}",
            "lineNumber": 878,
            "isSignature": true
          }
        ]
      },
      "score": 0.3073357343673706
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/canvasApi.ts",
        "range": {
          "startPosition": {
            "column": 86
          },
          "endPosition": {
            "line": 15,
            "column": 1
          }
        },
        "contents": "export interface LiveCanvas {\n\tcreateTextNode(options: {\n\t\ttext: string;\n\t\tpos: { x: number; y: number };\n\t\tsize: { width: number; height: number };\n\t\tsave?: boolean;\n\t\tfocus?: boolean;\n\t}): { id: string; x: number; y: number; width: number; height: number; moveTo: (pos: { x: number; y: number }) =&gt; void; resize: (size: { width: number; height: number }) =&gt; void };\n\taddNode(node: unknown): void;\n\trequestSave?: () =&gt; void;\n\tremoveNode?(node: unknown): void;\n\tnodes?: Map&lt;string, unknown&gt; | Iterable&lt;unknown&gt;;\n\t/** If present, used to refresh canvas after edge label updates (Obsidian canvas view). */\n\tsetData?(data: unknown): void;\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "export interface LiveCanvas {",
            "lineNumber": 2,
            "isSignature": true
          },
          {
            "text": "\tcreateTextNode(options: {",
            "lineNumber": 3
          },
          {
            "text": "\t\ttext: string;",
            "lineNumber": 4
          },
          {
            "text": "\t\tpos: { x: number; y: number };",
            "lineNumber": 5
          },
          {
            "text": "\t\tsize: { width: number; height: number };",
            "lineNumber": 6
          },
          {
            "text": "\t\tsave?: boolean;",
            "lineNumber": 7
          },
          {
            "text": "\t\tfocus?: boolean;",
            "lineNumber": 8
          },
          {
            "text": "\t}): { id: string; x: number; y: number; width: number; height: number; moveTo: (pos: { x: number; y: number }) =&gt; void; resize: (size: { width: number; height: number }) =&gt; void };",
            "lineNumber": 9
          },
          {
            "text": "\taddNode(node: unknown): void;",
            "lineNumber": 10
          },
          {
            "text": "\trequestSave?: () =&gt; void;",
            "lineNumber": 11
          },
          {
            "text": "\tremoveNode?(node: unknown): void;",
            "lineNumber": 12
          },
          {
            "text": "\tnodes?: Map&lt;string, unknown&gt; | Iterable&lt;unknown&gt;;",
            "lineNumber": 13
          },
          {
            "text": "\t/** If present, used to refresh canvas after edge label updates (Obsidian canvas view). */",
            "lineNumber": 14
          },
          {
            "text": "\tsetData?(data: unknown): void;",
            "lineNumber": 15,
            "isSignature": true
          },
          {
            "text": "}",
            "lineNumber": 16,
            "isSignature": true
          }
        ]
      },
      "score": 0.30588799715042114
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 644,
            "column": 1
          },
          "endPosition": {
            "line": 668,
            "column": 98
          }
        },
        "contents": "/** Remove the Green output node and its output edge for a given source node; mutates data and saves. */\nexport async function dismissOutput(\n\tvault: App[\"vault\"],\n\tcanvasFilePath: string,\n\tsourceNodeId: string,\n\tsettings: ZettelPluginSettings,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;void&gt; {\n\tconst data = await loadCanvasData(vault, canvasFilePath);\n\tif (!data) return;\n\tconst outId = findOutputNodeForSource(data, sourceNodeId, settings);\n\tif (!outId) return;\n\tdata.nodes = data.nodes.filter((n) =&gt; n.id !== outId);\n\tdata.edges = data.edges.filter(\n\t\t(e) =&gt; !(e.fromNode === sourceNodeId &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT)\n\t);\n\tliveCanvas?.setData?.(data);\n\tif (liveCanvas?.requestSave) liveCanvas.requestSave();\n\tconst saved = await saveCanvasData(vault, canvasFilePath, data);\n\tif (!saved) new Notice(\"Failed to save canvas.\");\n}\n\n/** Remove all Green output nodes and their output edges on the canvas; mutates data and saves. */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Remove the Green output node and its output edge for a given source node; mutates data and saves. */",
            "lineNumber": 647
          },
          {
            "text": "export async function dismissOutput(",
            "lineNumber": 648,
            "isSignature": true
          },
          {
            "text": "\tvault: App[\"vault\"],",
            "lineNumber": 649,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 650,
            "isSignature": true
          },
          {
            "text": "\tsourceNodeId: string,",
            "lineNumber": 651,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 652,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 653,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;void&gt; {",
            "lineNumber": 654,
            "isSignature": true
          },
          {
            "text": "\tconst data = await loadCanvasData(vault, canvasFilePath);",
            "lineNumber": 655
          },
          {
            "text": "\tif (!data) return;",
            "lineNumber": 656
          },
          {
            "text": "\tconst outId = findOutputNodeForSource(data, sourceNodeId, settings);",
            "lineNumber": 657
          },
          {
            "text": "\tif (!outId) return;",
            "lineNumber": 658
          },
          {
            "text": "\tdata.nodes = data.nodes.filter((n) =&gt; n.id !== outId);",
            "lineNumber": 659
          },
          {
            "text": "\tdata.edges = data.edges.filter(",
            "lineNumber": 660
          },
          {
            "text": "\t\t(e) =&gt; !(e.fromNode === sourceNodeId &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT)",
            "lineNumber": 661
          },
          {
            "text": "\t);",
            "lineNumber": 662
          },
          {
            "text": "\tliveCanvas?.setData?.(data);",
            "lineNumber": 663
          },
          {
            "text": "\tif (liveCanvas?.requestSave) liveCanvas.requestSave();",
            "lineNumber": 664
          },
          {
            "text": "\tconst saved = await saveCanvasData(vault, canvasFilePath, data);",
            "lineNumber": 665
          },
          {
            "text": "\tif (!saved) new Notice(\"Failed to save canvas.\");",
            "lineNumber": 666
          },
          {
            "text": "}",
            "lineNumber": 667,
            "isSignature": true
          },
          {
            "lineNumber": 668
          },
          {
            "text": "/** Remove all Green output nodes and their output edges on the canvas; mutates data and saves. */",
            "lineNumber": 669
          }
        ]
      },
      "score": 0.2929190397262573
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 329
          },
          "endPosition": {
            "line": 877,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\n\n\n\t/** Create a new tutorial canvas file in the vault and open it. */\n\tasync createTutorialCanvas(): Promise&lt;void&gt; {\n\t\tconst {vault, workspace} = this.app;\n\t\tconst baseName = \"Tutorial canvas\";\n\t\tlet n = 0;\n\t\tlet path = normalizePath(&#96;${baseName}.canvas&#96;);\n\t\twhile (vault.getAbstractFileByPath(path) != null) {\n\t\t\tn += 1;\n\t\t\tpath = normalizePath(&#96;${baseName} ${n}.canvas&#96;);\n\t\t}\n\t\tconst data = getCombinedTutorialCanvasData(this.settings);\n\t\tconst saved = await saveCanvasData(vault, path, data);\n\t\tif (!saved) {\n\t\t\tnew Notice(\"Could not create tutorial canvas.\");\n\t\t\treturn;\n\t\t}\n\t\tconst file = vault.getAbstractFileByPath(path);\n\t\tif (file instanceof TFile) {\n\t\t\tawait workspace.getLeaf().openFile(file);\n\t\t} else {\n\t\t\tawait workspace.openLinkText(path, \"\", false);\n\t\t}\n\t\tnew Notice(\"Tutorial canvas created. 3 workflows: Concatenation | Variable Injection | Python State. Right-click any colored node → Run node or Run chain.\");\n\t}\n\n\t/** Duplicate a canvas template: open modal to select template, then create new canvas from it. */\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 330,
                "column": 1
              },
              "endPosition": {
                "line": 330,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 330,
                "column": 16
              },
              "endPosition": {
                "line": 331,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 330,
            "isSignature": true
          },
          {
            "lineNumber": 628
          },
          {
            "lineNumber": 629
          },
          {
            "text": "\t/** Create a new tutorial canvas file in the vault and open it. */",
            "lineNumber": 630
          },
          {
            "text": "\tasync createTutorialCanvas(): Promise&lt;void&gt; {",
            "lineNumber": 631
          },
          {
            "text": "\t\tconst {vault, workspace} = this.app;",
            "lineNumber": 632
          },
          {
            "text": "\t\tconst baseName = \"Tutorial canvas\";",
            "lineNumber": 633
          },
          {
            "text": "\t\tlet n = 0;",
            "lineNumber": 634
          },
          {
            "text": "\t\tlet path = normalizePath(&#96;${baseName}.canvas&#96;);",
            "lineNumber": 635
          },
          {
            "text": "\t\twhile (vault.getAbstractFileByPath(path) != null) {",
            "lineNumber": 636
          },
          {
            "text": "\t\t\tn += 1;",
            "lineNumber": 637
          },
          {
            "text": "\t\t\tpath = normalizePath(&#96;${baseName} ${n}.canvas&#96;);",
            "lineNumber": 638
          },
          {
            "text": "\t\t}",
            "lineNumber": 639
          },
          {
            "text": "\t\tconst data = getCombinedTutorialCanvasData(this.settings);",
            "lineNumber": 640
          },
          {
            "text": "\t\tconst saved = await saveCanvasData(vault, path, data);",
            "lineNumber": 641
          },
          {
            "text": "\t\tif (!saved) {",
            "lineNumber": 642
          },
          {
            "text": "\t\t\tnew Notice(\"Could not create tutorial canvas.\");",
            "lineNumber": 643
          },
          {
            "text": "\t\t\treturn;",
            "lineNumber": 644
          },
          {
            "text": "\t\t}",
            "lineNumber": 645
          },
          {
            "text": "\t\tconst file = vault.getAbstractFileByPath(path);",
            "lineNumber": 646
          },
          {
            "text": "\t\tif (file instanceof TFile) {",
            "lineNumber": 647
          },
          {
            "text": "\t\t\tawait workspace.getLeaf().openFile(file);",
            "lineNumber": 648
          },
          {
            "text": "\t\t} else {",
            "lineNumber": 649
          },
          {
            "text": "\t\t\tawait workspace.openLinkText(path, \"\", false);",
            "lineNumber": 650
          },
          {
            "text": "\t\t}",
            "lineNumber": 651
          },
          {
            "text": "\t\tnew Notice(\"Tutorial canvas created. 3 workflows: Concatenation | Variable Injection | Python State. Right-click any colored node → Run node or Run chain.\");",
            "lineNumber": 652
          },
          {
            "text": "\t}",
            "lineNumber": 653
          },
          {
            "lineNumber": 654
          },
          {
            "text": "\t/** Duplicate a canvas template: open modal to select template, then create new canvas from it. */",
            "lineNumber": 655
          },
          {
            "text": "}",
            "lineNumber": 878,
            "isSignature": true
          }
        ]
      },
      "score": 0.2920908033847809
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 612,
            "column": 1
          },
          "endPosition": {
            "line": 646,
            "column": 104
          }
        },
        "contents": "/** Run chain from roots to the given node. */\nexport async function runChain(\n\tapp: App,\n\tsettings: ZettelPluginSettings,\n\tcanvasFilePath: string,\n\tnodeId: string,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;{ ok: boolean; message?: string }&gt; {\n\tconst data = await loadCanvasData(app.vault, canvasFilePath);\n\tif (!data) return { ok: false, message: \"Could not load canvas data.\" };\n\tconst roots = getRootIds(data);\n\tconst rootsReachingCurrent = roots.filter((r) =&gt; canReach(data, r, nodeId));\n\tif (rootsReachingCurrent.length === 0) return { ok: false, message: \"No root reaches this node.\" };\n\tconst topo = topologicalOrderToTarget(data, nodeId, settings);\n\tif (\"cycle\" in topo) return { ok: false, message: CYCLE_ERROR_MESSAGE };\n\tconst order = topo.order;\n\tconst canvasKey = getCanvasKey(canvasFilePath);\n\ttry {\n\t\tfor (const nid of order) {\n\t\t\ttry {\n\t\t\t\tsetRunningNodeId(canvasKey, nid);\n\t\t\t\tawait runSingleNode(app, settings, canvasKey, canvasFilePath, data, nid, liveCanvas);\n\t\t\t} finally {\n\t\t\t\tsetRunningNodeId(canvasKey, null);\n\t\t\t}\n\t\t}\n\t\treturn { ok: true };\n\t} catch (e) {\n\t\treturn { ok: false, message: e instanceof Error ? e.message : String(e) };\n\t}\n}\n\n/** Remove the Green output node and its output edge for a given source node; mutates data and saves. */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Run chain from roots to the given node. */",
            "lineNumber": 615
          },
          {
            "text": "export async function runChain(",
            "lineNumber": 616,
            "isSignature": true
          },
          {
            "text": "\tapp: App,",
            "lineNumber": 617,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 618,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 619,
            "isSignature": true
          },
          {
            "text": "\tnodeId: string,",
            "lineNumber": 620,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 621,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;{ ok: boolean; message?: string }&gt; {",
            "lineNumber": 622,
            "isSignature": true
          },
          {
            "text": "\tconst data = await loadCanvasData(app.vault, canvasFilePath);",
            "lineNumber": 623
          },
          {
            "text": "\tif (!data) return { ok: false, message: \"Could not load canvas data.\" };",
            "lineNumber": 624
          },
          {
            "text": "\tconst roots = getRootIds(data);",
            "lineNumber": 625
          },
          {
            "text": "\tconst rootsReachingCurrent = roots.filter((r) =&gt; canReach(data, r, nodeId));",
            "lineNumber": 626
          },
          {
            "text": "\tif (rootsReachingCurrent.length === 0) return { ok: false, message: \"No root reaches this node.\" };",
            "lineNumber": 627
          },
          {
            "text": "\tconst topo = topologicalOrderToTarget(data, nodeId, settings);",
            "lineNumber": 628
          },
          {
            "text": "\tif (\"cycle\" in topo) return { ok: false, message: CYCLE_ERROR_MESSAGE };",
            "lineNumber": 629
          },
          {
            "text": "\tconst order = topo.order;",
            "lineNumber": 630
          },
          {
            "text": "\tconst canvasKey = getCanvasKey(canvasFilePath);",
            "lineNumber": 631
          },
          {
            "text": "\ttry {",
            "lineNumber": 632
          },
          {
            "text": "\t\tfor (const nid of order) {",
            "lineNumber": 633
          },
          {
            "text": "\t\t\ttry {",
            "lineNumber": 634
          },
          {
            "text": "\t\t\t\tsetRunningNodeId(canvasKey, nid);",
            "lineNumber": 635
          },
          {
            "text": "\t\t\t\tawait runSingleNode(app, settings, canvasKey, canvasFilePath, data, nid, liveCanvas);",
            "lineNumber": 636
          },
          {
            "text": "\t\t\t} finally {",
            "lineNumber": 637
          },
          {
            "text": "\t\t\t\tsetRunningNodeId(canvasKey, null);",
            "lineNumber": 638
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 639
          },
          {
            "text": "\t\t}",
            "lineNumber": 640
          },
          {
            "text": "\t\treturn { ok: true };",
            "lineNumber": 641
          },
          {
            "text": "\t} catch (e) {",
            "lineNumber": 642
          },
          {
            "text": "\t\treturn { ok: false, message: e instanceof Error ? e.message : String(e) };",
            "lineNumber": 643
          },
          {
            "text": "\t}",
            "lineNumber": 644
          },
          {
            "text": "}",
            "lineNumber": 645,
            "isSignature": true
          },
          {
            "lineNumber": 646
          },
          {
            "text": "/** Remove the Green output node and its output edge for a given source node; mutates data and saves. */",
            "lineNumber": 647
          }
        ]
      },
      "score": 0.2839741110801697
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 329
          },
          "endPosition": {
            "line": 877,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\nasync onload() {\n\n\t\t\tconst registerCanvasNodeMenu = () =&gt; {\n\t\t\t\ttry {\n\t\t\t\t\tconst on = this.app.workspace.on.bind(this.app.workspace) as (\n\t\t\t\t\t\tname: string,\n\t\t\t\t\t\tcallback: (menu: Menu, node: unknown) =&gt; void\n\t\t\t\t\t) =&gt; ReturnType&lt;typeof this.app.workspace.on&gt;;\n\t\t\t\t\t// Try documented-style event name first; some Obsidian builds use \"canvas:node-menu\".\n\t\t\t\t\tthis.registerEvent(on(\"canvas:node-menu\", addNodeMenuItems));\n\t\t\t\t\t// Fallback: try hyphenated name in case the app triggers a different event.\n\t\t\t\t\tthis.registerEvent(on(\"canvas-node-menu\", addNodeMenuItems));\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconsole.error(\"Zettel Thinking Board: could not register canvas node menu.\", e);\n\t\t\t\t}\n\t\t\t};\n\t\t\tconst timeoutId = window.setTimeout(registerCanvasNodeMenu, 0);\n\t\t\tthis.register(() =&gt; window.clearTimeout(timeoutId));\n\n\t\t\t// Canvas background context menu: use undocumented \"canvas:edge-menu\" (Obsidian broadcasts it;\n\t\t\t// when right-click is on empty area, edge is null). Same pattern as canvas:node-menu: addItem with setTitle, setIcon, onClick.\n\t\t\tconst addCanvasMenuItems = (menu: Menu): void =&gt; {\n\t\t\t\tmenu.addItem((item) =&gt;\n\t\t\t\t\titem.setTitle(\"Run entire canvas\").setIcon(\"play\").onClick(() =&gt; this.runEntireCanvas())\n\t\t\t\t);\n\t\t\t\tmenu.addItem((item) =&gt;\n\t\t\t\t\titem.setTitle(\"Dismiss all output\").setIcon(\"trash\").onClick(() =&gt; this.dismissAllOutput())\n\t\t\t\t);\n\t\t\t};\n\t\t\ttry {\n\t\t\t\tconst onWorkspace = this.app.workspace.on.bind(this.app.workspace) as (\n\t\t\t\t\tname: string,\n\t\t\t\t\tcallback: (menu: Menu, edge: unknown) =&gt; void\n\t\t\t\t) =&gt; ReturnType&lt;typeof this.app.workspace.on&gt;;\n\t\t\t\tthis.registerEvent(\n\t\t\t\t\tonWorkspace(\"canvas:edge-menu\", (menu: Menu, edge: unknown) =&gt; {\n\t\t\t\t\t\tif (edge == null) addCanvasMenuItems(menu);\n\t\t\t\t\t})\n\t\t\t\t);\n\t\t\t} catch (e) {\n\t\t\t\tconsole.error(\"Zettel Thinking Board: could not register canvas background menu.\", e);\n\t\t\t}\n\n\t\t\t// Debug: command to test if we can affect the canvas and if canvas:node-menu ever fires.\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 330,
                "column": 1
              },
              "endPosition": {
                "line": 330,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 330,
                "column": 16
              },
              "endPosition": {
                "line": 331,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 333,
                "column": 2
              },
              "endPosition": {
                "line": 334,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 330,
            "isSignature": true
          },
          {
            "text": "async onload() {",
            "lineNumber": 333
          },
          {
            "lineNumber": 431
          },
          {
            "text": "\t\t\tconst registerCanvasNodeMenu = () =&gt; {",
            "lineNumber": 432
          },
          {
            "text": "\t\t\t\ttry {",
            "lineNumber": 433
          },
          {
            "text": "\t\t\t\t\tconst on = this.app.workspace.on.bind(this.app.workspace) as (",
            "lineNumber": 434
          },
          {
            "text": "\t\t\t\t\t\tname: string,",
            "lineNumber": 435
          },
          {
            "text": "\t\t\t\t\t\tcallback: (menu: Menu, node: unknown) =&gt; void",
            "lineNumber": 436
          },
          {
            "text": "\t\t\t\t\t) =&gt; ReturnType&lt;typeof this.app.workspace.on&gt;;",
            "lineNumber": 437
          },
          {
            "text": "\t\t\t\t\t// Try documented-style event name first; some Obsidian builds use \"canvas:node-menu\".",
            "lineNumber": 438
          },
          {
            "text": "\t\t\t\t\tthis.registerEvent(on(\"canvas:node-menu\", addNodeMenuItems));",
            "lineNumber": 439
          },
          {
            "text": "\t\t\t\t\t// Fallback: try hyphenated name in case the app triggers a different event.",
            "lineNumber": 440
          },
          {
            "text": "\t\t\t\t\tthis.registerEvent(on(\"canvas-node-menu\", addNodeMenuItems));",
            "lineNumber": 441
          },
          {
            "text": "\t\t\t\t} catch (e) {",
            "lineNumber": 442
          },
          {
            "text": "\t\t\t\t\tconsole.error(\"Zettel Thinking Board: could not register canvas node menu.\", e);",
            "lineNumber": 443
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 444
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 445
          },
          {
            "text": "\t\t\tconst timeoutId = window.setTimeout(registerCanvasNodeMenu, 0);",
            "lineNumber": 446
          },
          {
            "text": "\t\t\tthis.register(() =&gt; window.clearTimeout(timeoutId));",
            "lineNumber": 447
          },
          {
            "lineNumber": 448
          },
          {
            "text": "\t\t\t// Canvas background context menu: use undocumented \"canvas:edge-menu\" (Obsidian broadcasts it;",
            "lineNumber": 449
          },
          {
            "text": "\t\t\t// when right-click is on empty area, edge is null). Same pattern as canvas:node-menu: addItem with setTitle, setIcon, onClick.",
            "lineNumber": 450
          },
          {
            "text": "\t\t\tconst addCanvasMenuItems = (menu: Menu): void =&gt; {",
            "lineNumber": 451
          },
          {
            "text": "\t\t\t\tmenu.addItem((item) =&gt;",
            "lineNumber": 452
          },
          {
            "text": "\t\t\t\t\titem.setTitle(\"Run entire canvas\").setIcon(\"play\").onClick(() =&gt; this.runEntireCanvas())",
            "lineNumber": 453
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 454
          },
          {
            "text": "\t\t\t\tmenu.addItem((item) =&gt;",
            "lineNumber": 455
          },
          {
            "text": "\t\t\t\t\titem.setTitle(\"Dismiss all output\").setIcon(\"trash\").onClick(() =&gt; this.dismissAllOutput())",
            "lineNumber": 456
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 457
          },
          {
            "text": "\t\t\t};",
            "lineNumber": 458
          },
          {
            "text": "\t\t\ttry {",
            "lineNumber": 459
          },
          {
            "text": "\t\t\t\tconst onWorkspace = this.app.workspace.on.bind(this.app.workspace) as (",
            "lineNumber": 460
          },
          {
            "text": "\t\t\t\t\tname: string,",
            "lineNumber": 461
          },
          {
            "text": "\t\t\t\t\tcallback: (menu: Menu, edge: unknown) =&gt; void",
            "lineNumber": 462
          },
          {
            "text": "\t\t\t\t) =&gt; ReturnType&lt;typeof this.app.workspace.on&gt;;",
            "lineNumber": 463
          },
          {
            "text": "\t\t\t\tthis.registerEvent(",
            "lineNumber": 464
          },
          {
            "text": "\t\t\t\t\tonWorkspace(\"canvas:edge-menu\", (menu: Menu, edge: unknown) =&gt; {",
            "lineNumber": 465
          },
          {
            "text": "\t\t\t\t\t\tif (edge == null) addCanvasMenuItems(menu);",
            "lineNumber": 466
          },
          {
            "text": "\t\t\t\t\t})",
            "lineNumber": 467
          },
          {
            "text": "\t\t\t\t);",
            "lineNumber": 468
          },
          {
            "text": "\t\t\t} catch (e) {",
            "lineNumber": 469
          },
          {
            "text": "\t\t\t\tconsole.error(\"Zettel Thinking Board: could not register canvas background menu.\", e);",
            "lineNumber": 470
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 471
          },
          {
            "lineNumber": 472
          },
          {
            "text": "\t\t\t// Debug: command to test if we can affect the canvas and if canvas:node-menu ever fires.",
            "lineNumber": 473
          },
          {
            "text": "\t}",
            "lineNumber": 595
          },
          {
            "text": "}",
            "lineNumber": 878,
            "isSignature": true
          }
        ]
      },
      "score": 0.27289819717407227
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/types.ts",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 12,
            "column": 1
          }
        },
        "contents": "import type {App} from \"obsidian\";\nimport type {ZettelPluginSettings} from \"./settings\";\n\n/** Plugin interface used by views to avoid circular dependency on main. */\nexport interface IZettelThinkingBoardPlugin {\n\tapp: App;\n\tsettings: ZettelPluginSettings;\n\tsaveSettings(): Promise&lt;void&gt;;\n\tgetActiveCanvasView(): { canvas: unknown; file: { path: string } } | null;\n\tgetActiveOrFirstCanvasView(): { canvas: unknown; file: { path: string } } | null;\n\tgetKernelForActiveCanvas(): { onLog?: ((line: string) =&gt; void) | undefined; run(code: string, inputText: string): Promise&lt;string&gt;; terminate(): void } | null;\n\tregisterEvent(ref: unknown): void;\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "import type {App} from \"obsidian\";",
            "lineNumber": 1
          },
          {
            "text": "import type {ZettelPluginSettings} from \"./settings\";",
            "lineNumber": 2
          },
          {
            "lineNumber": 3
          },
          {
            "text": "/** Plugin interface used by views to avoid circular dependency on main. */",
            "lineNumber": 4
          },
          {
            "text": "export interface IZettelThinkingBoardPlugin {",
            "lineNumber": 5,
            "isSignature": true
          },
          {
            "text": "\tapp: App;",
            "lineNumber": 6
          },
          {
            "text": "\tsettings: ZettelPluginSettings;",
            "lineNumber": 7
          },
          {
            "text": "\tsaveSettings(): Promise&lt;void&gt;;",
            "lineNumber": 8
          },
          {
            "text": "\tgetActiveCanvasView(): { canvas: unknown; file: { path: string } } | null;",
            "lineNumber": 9
          },
          {
            "text": "\tgetActiveOrFirstCanvasView(): { canvas: unknown; file: { path: string } } | null;",
            "lineNumber": 10
          },
          {
            "text": "\tgetKernelForActiveCanvas(): { onLog?: ((line: string) =&gt; void) | undefined; run(code: string, inputText: string): Promise&lt;string&gt;; terminate(): void } | null;",
            "lineNumber": 11
          },
          {
            "text": "\tregisterEvent(ref: unknown): void;",
            "lineNumber": 12,
            "isSignature": true
          },
          {
            "text": "}",
            "lineNumber": 13,
            "isSignature": true
          }
        ]
      },
      "score": 0.2682051658630371
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 251,
            "column": 1
          },
          "endPosition": {
            "line": 346,
            "column": 1
          }
        },
        "contents": "/** Run a single node: get input + parent context (concatenate or {{var:name}}), call LLM or Python, store result. */\nasync function runSingleNode(\n\tapp: App,\n\tsettings: ZettelPluginSettings,\n\tcanvasKey: string,\n\tcanvasFilePath: string,\n\tdata: CanvasData,\n\tnodeId: string,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;string&gt; {\n\tconst node = getNodeById(data, nodeId);\n\tif (!node) return \"\";\n\tconst role = getNodeRole(node, settings);\n\tif (!role || role === \"yellow\" || role === \"green\") {\n\t\t// Yellow = text (input pass-through): use node content as result\n\t\tif (role === \"yellow\") {\n\t\t\tconst content = await getNodeContent(node, app.vault);\n\t\t\tsetNodeResult(canvasKey, nodeId, content);\n\t\t\treturn content;\n\t\t}\n\t\treturn \"\";\n\t}\n\t// For Python (blue) text nodes, auto-wrap content in &#96;&#96;&#96;python ... &#96;&#96;&#96; so # comments render correctly\n\tif (role === \"blue\" &amp;&amp; isTextNode(node)) {\n\t\tconst raw = getTextNodeContent(node as CanvasTextData);\n\t\tif (!isPythonCodeFenced(raw)) {\n\t\t\t(node as CanvasTextData).text = ensurePythonCodeFence(raw);\n\t\t\tliveCanvas?.setData?.(data);\n\t\t\tawait saveCanvasData(app.vault, canvasFilePath, data);\n\t\t}\n\t}\n\tconst incoming = getIncomingEdgesWithLabels(nodeId, data);\n\tconst nodeInput = await getNodeContent(node, app.vault);\n\tconst { concatenatedPart, template, edgeModes } = buildInputWithVariables(\n\t\tcanvasKey,\n\t\tnodeInput,\n\t\tincoming\n\t);\n\tconst fullPrompt =\n\t\tconcatenatedPart.length &gt; 0 ? &#96;${concatenatedPart}\\n\\n---\\n\\n${template}&#96; : template;\n\n\tif (role === \"orange\") {\n\t\tconst model = settings.ollamaOrangeModel || \"llama2\";\n\t\tconst temperature = settings.ollamaOrangeTemperature ?? DEFAULT_SETTINGS.ollamaOrangeTemperature;\n\t\tconst result = await ollamaGenerate({\n\t\t\tmodel,\n\t\t\tprompt: fullPrompt,\n\t\t\tstream: false,\n\t\t\toptions: { temperature },\n\t\t});\n\t\tsetNodeResult(canvasKey, nodeId, result);\n\t\tensureOutputNodeAndEdge(data, node, result, settings);\n\t\tawait updateEdgeLabelsAndSave(app.vault, canvasFilePath, data, nodeId, edgeModes, liveCanvas);\n\t\treturn result;\n\t}\n\tif (role === \"purple\") {\n\t\tconst model = settings.ollamaPurpleModel || \"llama2\";\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Run a single node: get input + parent context (concatenate or {{var:name}}), call LLM or Python, store result. */",
            "lineNumber": 254
          },
          {
            "text": "async function runSingleNode(",
            "lineNumber": 255,
            "isSignature": true
          },
          {
            "text": "\tapp: App,",
            "lineNumber": 256,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 257,
            "isSignature": true
          },
          {
            "text": "\tcanvasKey: string,",
            "lineNumber": 258,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 259,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 260,
            "isSignature": true
          },
          {
            "text": "\tnodeId: string,",
            "lineNumber": 261,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 262,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;string&gt; {",
            "lineNumber": 263,
            "isSignature": true
          },
          {
            "text": "\tconst node = getNodeById(data, nodeId);",
            "lineNumber": 264
          },
          {
            "text": "\tif (!node) return \"\";",
            "lineNumber": 265
          },
          {
            "text": "\tconst role = getNodeRole(node, settings);",
            "lineNumber": 266
          },
          {
            "text": "\tif (!role || role === \"yellow\" || role === \"green\") {",
            "lineNumber": 267
          },
          {
            "text": "\t\t// Yellow = text (input pass-through): use node content as result",
            "lineNumber": 268
          },
          {
            "text": "\t\tif (role === \"yellow\") {",
            "lineNumber": 269
          },
          {
            "text": "\t\t\tconst content = await getNodeContent(node, app.vault);",
            "lineNumber": 270
          },
          {
            "text": "\t\t\tsetNodeResult(canvasKey, nodeId, content);",
            "lineNumber": 271
          },
          {
            "text": "\t\t\treturn content;",
            "lineNumber": 272
          },
          {
            "text": "\t\t}",
            "lineNumber": 273
          },
          {
            "text": "\t\treturn \"\";",
            "lineNumber": 274
          },
          {
            "text": "\t}",
            "lineNumber": 275
          },
          {
            "text": "\t// For Python (blue) text nodes, auto-wrap content in &#96;&#96;&#96;python ... &#96;&#96;&#96; so # comments render correctly",
            "lineNumber": 276
          },
          {
            "text": "\tif (role === \"blue\" &amp;&amp; isTextNode(node)) {",
            "lineNumber": 277
          },
          {
            "text": "\t\tconst raw = getTextNodeContent(node as CanvasTextData);",
            "lineNumber": 278
          },
          {
            "text": "\t\tif (!isPythonCodeFenced(raw)) {",
            "lineNumber": 279
          },
          {
            "text": "\t\t\t(node as CanvasTextData).text = ensurePythonCodeFence(raw);",
            "lineNumber": 280
          },
          {
            "text": "\t\t\tliveCanvas?.setData?.(data);",
            "lineNumber": 281
          },
          {
            "text": "\t\t\tawait saveCanvasData(app.vault, canvasFilePath, data);",
            "lineNumber": 282
          },
          {
            "text": "\t\t}",
            "lineNumber": 283
          },
          {
            "text": "\t}",
            "lineNumber": 284
          },
          {
            "text": "\tconst incoming = getIncomingEdgesWithLabels(nodeId, data);",
            "lineNumber": 285
          },
          {
            "text": "\tconst nodeInput = await getNodeContent(node, app.vault);",
            "lineNumber": 286
          },
          {
            "text": "\tconst { concatenatedPart, template, edgeModes } = buildInputWithVariables(",
            "lineNumber": 287
          },
          {
            "text": "\t\tcanvasKey,",
            "lineNumber": 288
          },
          {
            "text": "\t\tnodeInput,",
            "lineNumber": 289
          },
          {
            "text": "\t\tincoming",
            "lineNumber": 290
          },
          {
            "text": "\t);",
            "lineNumber": 291
          },
          {
            "text": "\tconst fullPrompt =",
            "lineNumber": 292
          },
          {
            "text": "\t\tconcatenatedPart.length &gt; 0 ? &#96;${concatenatedPart}\\n\\n---\\n\\n${template}&#96; : template;",
            "lineNumber": 293
          },
          {
            "lineNumber": 294
          },
          {
            "text": "\tif (role === \"orange\") {",
            "lineNumber": 295
          },
          {
            "text": "\t\tconst model = settings.ollamaOrangeModel || \"llama2\";",
            "lineNumber": 296
          },
          {
            "text": "\t\tconst temperature = settings.ollamaOrangeTemperature ?? DEFAULT_SETTINGS.ollamaOrangeTemperature;",
            "lineNumber": 297
          },
          {
            "text": "\t\tconst result = await ollamaGenerate({",
            "lineNumber": 298
          },
          {
            "text": "\t\t\tmodel,",
            "lineNumber": 299
          },
          {
            "text": "\t\t\tprompt: fullPrompt,",
            "lineNumber": 300
          },
          {
            "text": "\t\t\tstream: false,",
            "lineNumber": 301
          },
          {
            "text": "\t\t\toptions: { temperature },",
            "lineNumber": 302
          },
          {
            "text": "\t\t});",
            "lineNumber": 303
          },
          {
            "text": "\t\tsetNodeResult(canvasKey, nodeId, result);",
            "lineNumber": 304
          },
          {
            "text": "\t\tensureOutputNodeAndEdge(data, node, result, settings);",
            "lineNumber": 305
          },
          {
            "text": "\t\tawait updateEdgeLabelsAndSave(app.vault, canvasFilePath, data, nodeId, edgeModes, liveCanvas);",
            "lineNumber": 306
          },
          {
            "text": "\t\treturn result;",
            "lineNumber": 307
          },
          {
            "text": "\t}",
            "lineNumber": 308
          },
          {
            "text": "\tif (role === \"purple\") {",
            "lineNumber": 309
          },
          {
            "text": "\t\tconst model = settings.ollamaPurpleModel || \"llama2\";",
            "lineNumber": 310
          },
          {
            "text": "}",
            "lineNumber": 347,
            "isSignature": true
          }
        ]
      },
      "score": 0.26360273361206055
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 329
          },
          "endPosition": {
            "line": 877,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\nasync onload() {\n\n\n\t\t\t// Debug: command to test if we can affect the canvas and if canvas:node-menu ever fires.\n\t\t\tthis.addCommand({\n\t\t\t\tid: \"zettel-debug-canvas-hook\",\n\t\t\t\tname: \"Debug canvas hook\",\n\t\t\t\tcheckCallback: (checking: boolean) =&gt; {\n\t\t\t\t\tif (checking) return true;\n\t\t\t\t\tconst canvasActive = this.getActiveCanvasView() != null;\n\t\t\t\t\tconst msg =\n\t\t\t\t\t\t\"Canvas active: \" +\n\t\t\t\t\t\t(canvasActive ? \"yes\" : \"no (focus a canvas first)\") +\n\t\t\t\t\t\t\". Node menu ever fired: \" +\n\t\t\t\t\t\t(debugNodeMenuFired ? \"yes\" : \"no (right-click a node to test).\");\n\t\t\t\t\tnew Notice(msg);\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t});\n\n\t\t\t// Terminate kernel when a canvas is closed (one kernel per canvas)\n\t\t\t// Also check for output nodes and remind user to dismiss them\n\t\t\tlet previousCanvasPaths = new Set&lt;string&gt;();\n\t\t\tlet hasShownOutputWarningForPath = new Set&lt;string&gt;(); // Track which paths we've warned about\n\t\t\tthis.registerEvent(\n\t\t\t\tthis.app.workspace.on(\"layout-change\",\n\n\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 330,
                "column": 1
              },
              "endPosition": {
                "line": 330,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 330,
                "column": 16
              },
              "endPosition": {
                "line": 331,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 333,
                "column": 2
              },
              "endPosition": {
                "line": 334,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 330,
            "isSignature": true
          },
          {
            "text": "async onload() {",
            "lineNumber": 333
          },
          {
            "lineNumber": 471
          },
          {
            "lineNumber": 472
          },
          {
            "text": "\t\t\t// Debug: command to test if we can affect the canvas and if canvas:node-menu ever fires.",
            "lineNumber": 473
          },
          {
            "text": "\t\t\tthis.addCommand({",
            "lineNumber": 474
          },
          {
            "text": "\t\t\t\tid: \"zettel-debug-canvas-hook\",",
            "lineNumber": 475
          },
          {
            "text": "\t\t\t\tname: \"Debug canvas hook\",",
            "lineNumber": 476
          },
          {
            "text": "\t\t\t\tcheckCallback: (checking: boolean) =&gt; {",
            "lineNumber": 477
          },
          {
            "text": "\t\t\t\t\tif (checking) return true;",
            "lineNumber": 478
          },
          {
            "text": "\t\t\t\t\tconst canvasActive = this.getActiveCanvasView() != null;",
            "lineNumber": 479
          },
          {
            "text": "\t\t\t\t\tconst msg =",
            "lineNumber": 480
          },
          {
            "text": "\t\t\t\t\t\t\"Canvas active: \" +",
            "lineNumber": 481
          },
          {
            "text": "\t\t\t\t\t\t(canvasActive ? \"yes\" : \"no (focus a canvas first)\") +",
            "lineNumber": 482
          },
          {
            "text": "\t\t\t\t\t\t\". Node menu ever fired: \" +",
            "lineNumber": 483
          },
          {
            "text": "\t\t\t\t\t\t(debugNodeMenuFired ? \"yes\" : \"no (right-click a node to test).\");",
            "lineNumber": 484
          },
          {
            "text": "\t\t\t\t\tnew Notice(msg);",
            "lineNumber": 485
          },
          {
            "text": "\t\t\t\t\treturn true;",
            "lineNumber": 486
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 487
          },
          {
            "text": "\t\t\t});",
            "lineNumber": 488
          },
          {
            "lineNumber": 489
          },
          {
            "text": "\t\t\t// Terminate kernel when a canvas is closed (one kernel per canvas)",
            "lineNumber": 490
          },
          {
            "text": "\t\t\t// Also check for output nodes and remind user to dismiss them",
            "lineNumber": 491
          },
          {
            "text": "\t\t\tlet previousCanvasPaths = new Set&lt;string&gt;();",
            "lineNumber": 492
          },
          {
            "text": "\t\t\tlet hasShownOutputWarningForPath = new Set&lt;string&gt;(); // Track which paths we've warned about",
            "lineNumber": 493
          },
          {
            "text": "\t\t\tthis.registerEvent(",
            "lineNumber": 494
          },
          {
            "text": "\t\t\t\tthis.app.workspace.on(\"layout-change\",",
            "lineNumber": 495
          },
          {
            "lineNumber": 522
          },
          {
            "lineNumber": 523
          },
          {
            "text": "\t}",
            "lineNumber": 595
          },
          {
            "text": "}",
            "lineNumber": 878,
            "isSignature": true
          }
        ]
      },
      "score": 0.2622818946838379
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 532,
            "column": 1
          },
          "endPosition": {
            "line": 584,
            "column": 93
          }
        },
        "contents": "/** Run a single node (for \"Run Node\" command). If parents are not run, runs chain to this node instead. */\nexport async function runNode(\n\tapp: App,\n\tsettings: ZettelPluginSettings,\n\tcanvasFilePath: string,\n\tnodeId: string,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;{ ok: boolean; message?: string }&gt; {\n\tconst data = await loadCanvasData(app.vault, canvasFilePath);\n\tif (!data) return { ok: false, message: \"Could not load canvas data.\" };\n\t// #region agent log\n\tconst outputNodesFromFile = data.nodes\n\t\t.filter((n) =&gt; data.edges.some((e) =&gt; e.toNode === n.id &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT))\n\t\t.map((n) =&gt; ({ id: n.id, x: (n as { x?: number }).x, y: (n as { y?: number }).y }));\n\tfetch(\"http://127.0.0.1:7243/ingest/453147b6-6b57-40b4-a769-82c9dd3c5ee7\", {\n\t\tmethod: \"POST\",\n\t\theaders: { \"Content-Type\": \"application/json\" },\n\t\tbody: JSON.stringify({\n\t\t\tlocation: \"runner.ts:runNode(after load)\",\n\t\t\tmessage: \"Output node positions as loaded from file\",\n\t\t\tdata: { outputNodesFromFile },\n\t\t\ttimestamp: Date.now(),\n\t\t\tsessionId: \"debug-session\",\n\t\t\thypothesisId: \"H2\",\n\t\t}),\n\t}).catch(() =&gt; {});\n\t// #endregion\n\tconst node = getNodeById(data, nodeId);\n\tif (!node) return { ok: false, message: \"Node not found.\" };\n\tconst role = getNodeRole(node, settings);\n\tif (!role) return { ok: false, message: \"Node color is not mapped to a role.\" };\n\tif (role === \"green\") return { ok: false, message: \"Green nodes are output-only.\" };\n\tconst parentIds = getParentIdsSortedByY(nodeId, data);\n\tconst canvasKey = getCanvasKey(canvasFilePath);\n\tfor (const pid of parentIds) {\n\t\tif (getNodeResult(canvasKey, pid) == null) {\n\t\t\treturn runChain(app, settings, canvasFilePath, nodeId, liveCanvas);\n\t\t}\n\t}\n\ttry {\n\t\tsetRunningNodeId(canvasKey, nodeId);\n\t\tawait runSingleNode(app, settings, canvasKey, canvasFilePath, data, nodeId, liveCanvas);\n\t\treturn { ok: true };\n\t} catch (e) {\n\t\treturn { ok: false, message: e instanceof Error ? e.message : String(e) };\n\t} finally {\n\t\tsetRunningNodeId(canvasKey, null);\n\t}\n}\n\nconst CYCLE_ERROR_MESSAGE = \"Execution graph contains a cycle; fix connections and try again.\";",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Run a single node (for \"Run Node\" command). If parents are not run, runs chain to this node instead. */",
            "lineNumber": 535
          },
          {
            "text": "export async function runNode(",
            "lineNumber": 536,
            "isSignature": true
          },
          {
            "text": "\tapp: App,",
            "lineNumber": 537,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 538,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 539,
            "isSignature": true
          },
          {
            "text": "\tnodeId: string,",
            "lineNumber": 540,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 541,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;{ ok: boolean; message?: string }&gt; {",
            "lineNumber": 542,
            "isSignature": true
          },
          {
            "text": "\tconst data = await loadCanvasData(app.vault, canvasFilePath);",
            "lineNumber": 543
          },
          {
            "text": "\tif (!data) return { ok: false, message: \"Could not load canvas data.\" };",
            "lineNumber": 544
          },
          {
            "text": "\t// #region agent log",
            "lineNumber": 545
          },
          {
            "text": "\tconst outputNodesFromFile = data.nodes",
            "lineNumber": 546
          },
          {
            "text": "\t\t.filter((n) =&gt; data.edges.some((e) =&gt; e.toNode === n.id &amp;&amp; parseEdgeVariableName(e.label) === EDGE_LABEL_OUTPUT))",
            "lineNumber": 547
          },
          {
            "text": "\t\t.map((n) =&gt; ({ id: n.id, x: (n as { x?: number }).x, y: (n as { y?: number }).y }));",
            "lineNumber": 548
          },
          {
            "text": "\tfetch(\"http://127.0.0.1:7243/ingest/453147b6-6b57-40b4-a769-82c9dd3c5ee7\", {",
            "lineNumber": 549
          },
          {
            "text": "\t\tmethod: \"POST\",",
            "lineNumber": 550
          },
          {
            "text": "\t\theaders: { \"Content-Type\": \"application/json\" },",
            "lineNumber": 551
          },
          {
            "text": "\t\tbody: JSON.stringify({",
            "lineNumber": 552
          },
          {
            "text": "\t\t\tlocation: \"runner.ts:runNode(after load)\",",
            "lineNumber": 553
          },
          {
            "text": "\t\t\tmessage: \"Output node positions as loaded from file\",",
            "lineNumber": 554
          },
          {
            "text": "\t\t\tdata: { outputNodesFromFile },",
            "lineNumber": 555
          },
          {
            "text": "\t\t\ttimestamp: Date.now(),",
            "lineNumber": 556
          },
          {
            "text": "\t\t\tsessionId: \"debug-session\",",
            "lineNumber": 557
          },
          {
            "text": "\t\t\thypothesisId: \"H2\",",
            "lineNumber": 558
          },
          {
            "text": "\t\t}),",
            "lineNumber": 559
          },
          {
            "text": "\t}).catch(() =&gt; {});",
            "lineNumber": 560
          },
          {
            "text": "\t// #endregion",
            "lineNumber": 561
          },
          {
            "text": "\tconst node = getNodeById(data, nodeId);",
            "lineNumber": 562
          },
          {
            "text": "\tif (!node) return { ok: false, message: \"Node not found.\" };",
            "lineNumber": 563
          },
          {
            "text": "\tconst role = getNodeRole(node, settings);",
            "lineNumber": 564
          },
          {
            "text": "\tif (!role) return { ok: false, message: \"Node color is not mapped to a role.\" };",
            "lineNumber": 565
          },
          {
            "text": "\tif (role === \"green\") return { ok: false, message: \"Green nodes are output-only.\" };",
            "lineNumber": 566
          },
          {
            "text": "\tconst parentIds = getParentIdsSortedByY(nodeId, data);",
            "lineNumber": 567
          },
          {
            "text": "\tconst canvasKey = getCanvasKey(canvasFilePath);",
            "lineNumber": 568
          },
          {
            "text": "\tfor (const pid of parentIds) {",
            "lineNumber": 569
          },
          {
            "text": "\t\tif (getNodeResult(canvasKey, pid) == null) {",
            "lineNumber": 570
          },
          {
            "text": "\t\t\treturn runChain(app, settings, canvasFilePath, nodeId, liveCanvas);",
            "lineNumber": 571
          },
          {
            "text": "\t\t}",
            "lineNumber": 572
          },
          {
            "text": "\t}",
            "lineNumber": 573
          },
          {
            "text": "\ttry {",
            "lineNumber": 574
          },
          {
            "text": "\t\tsetRunningNodeId(canvasKey, nodeId);",
            "lineNumber": 575
          },
          {
            "text": "\t\tawait runSingleNode(app, settings, canvasKey, canvasFilePath, data, nodeId, liveCanvas);",
            "lineNumber": 576
          },
          {
            "text": "\t\treturn { ok: true };",
            "lineNumber": 577
          },
          {
            "text": "\t} catch (e) {",
            "lineNumber": 578
          },
          {
            "text": "\t\treturn { ok: false, message: e instanceof Error ? e.message : String(e) };",
            "lineNumber": 579
          },
          {
            "text": "\t} finally {",
            "lineNumber": 580
          },
          {
            "text": "\t\tsetRunningNodeId(canvasKey, null);",
            "lineNumber": 581
          },
          {
            "text": "\t}",
            "lineNumber": 582
          },
          {
            "text": "}",
            "lineNumber": 583,
            "isSignature": true
          },
          {
            "lineNumber": 584
          },
          {
            "text": "const CYCLE_ERROR_MESSAGE = \"Execution graph contains a cycle; fix connections and try again.\";",
            "lineNumber": 585
          }
        ]
      },
      "score": 0.2549985647201538
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 329
          },
          "endPosition": {
            "line": 877,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\nasync onload() {\n\n\t\t\tconst runSyncLabels = (): void =&gt; {\n\t\t\t\tconst view = this.getActiveCanvasView();\n\t\t\t\tif (!view) {\n\t\t\t\t\tif (roleLabelsIntervalId != null) {\n\t\t\t\t\t\tclearInterval(roleLabelsIntervalId);\n\t\t\t\t\t\troleLabelsIntervalId = null;\n\t\t\t\t\t\tdelete (this as unknown as Record&lt;string, unknown&gt;)._roleLabelsIntervalId;\n\t\t\t\t\t}\n\t\t\t\t\tif (roleLabelsContainerEl != null) {\n\t\t\t\t\t\tclearCanvasRoleLabels(roleLabelsContainerEl);\n\t\t\t\t\t\tclearCanvasLegend(roleLabelsContainerEl);\n\t\t\t\t\t\tclearCanvasEdgeModeLabels(roleLabelsContainerEl);\n\t\t\t\t\t\tthis.clearCanvasToolbar(roleLabelsContainerEl);\n\t\t\t\t\t\tthis.clearTemplateBanner(roleLabelsContainerEl);\n\t\t\t\t\t\troleLabelsContainerEl = null;\n\t\t\t\t\t}\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tif (roleLabelsContainerEl != null &amp;&amp; roleLabelsContainerEl !== view.containerEl) {\n\t\t\t\t\tclearCanvasRoleLabels(roleLabelsContainerEl);\n\t\t\t\t\tclearCanvasLegend(roleLabelsContainerEl);\n\t\t\t\t\tclearCanvasEdgeModeLabels(roleLabelsContainerEl);\n\t\t\t\t\tthis.clearCanvasToolbar(roleLabelsContainerEl);\n\t\t\t\t\tthis.clearTemplateBanner(roleLabelsContainerEl);\n\t\t\t\t}\n\t\t\t\troleLabelsContainerEl = view.containerEl;\n\t\t\t\t// Show template banner if this canvas is in the template folder\n\t\t\t\tthis.syncTemplateBanner(view.containerEl, view.file.path);\n\t\t\t\t// Add \"Run entire canvas\" and \"Dismiss all output\" to the canvas (title bar if supported, else toolbar in container).\n\t\t\t\t// Use a property on the view so we only add once even after plugin hot-reload (WeakSet would be cleared on reload).\n\t\t\t\tconst leaf = this.app.workspace.activeLeaf;\n\t\t\t\tlet addedToTitleBar = false;\n\t\t\t\ttype ViewWithFlag = ItemView &amp; { addAction?: (icon: string, title: string, callback: (evt: MouseEvent) =&gt; void) =&gt; HTMLElement; _ztbTitleBarActionsAdded?: boolean };\n\t\t\t\tif (leaf?.view) {\n\t\t\t\t\tconst itemView = leaf.view as ViewWithFlag;\n;\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 330,
                "column": 1
              },
              "endPosition": {
                "line": 330,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 330,
                "column": 16
              },
              "endPosition": {
                "line": 331,
                "column": 2
              }
            },
            {
              "startPosition": {
                "line": 333,
                "column": 2
              },
              "endPosition": {
                "line": 334,
                "column": 3
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 330,
            "isSignature": true
          },
          {
            "text": "async onload() {",
            "lineNumber": 333
          },
          {
            "lineNumber": 527
          },
          {
            "text": "\t\t\tconst runSyncLabels = (): void =&gt; {",
            "lineNumber": 528
          },
          {
            "text": "\t\t\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 529
          },
          {
            "text": "\t\t\t\tif (!view) {",
            "lineNumber": 530
          },
          {
            "text": "\t\t\t\t\tif (roleLabelsIntervalId != null) {",
            "lineNumber": 531
          },
          {
            "text": "\t\t\t\t\t\tclearInterval(roleLabelsIntervalId);",
            "lineNumber": 532
          },
          {
            "text": "\t\t\t\t\t\troleLabelsIntervalId = null;",
            "lineNumber": 533
          },
          {
            "text": "\t\t\t\t\t\tdelete (this as unknown as Record&lt;string, unknown&gt;)._roleLabelsIntervalId;",
            "lineNumber": 534
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 535
          },
          {
            "text": "\t\t\t\t\tif (roleLabelsContainerEl != null) {",
            "lineNumber": 536
          },
          {
            "text": "\t\t\t\t\t\tclearCanvasRoleLabels(roleLabelsContainerEl);",
            "lineNumber": 537
          },
          {
            "text": "\t\t\t\t\t\tclearCanvasLegend(roleLabelsContainerEl);",
            "lineNumber": 538
          },
          {
            "text": "\t\t\t\t\t\tclearCanvasEdgeModeLabels(roleLabelsContainerEl);",
            "lineNumber": 539
          },
          {
            "text": "\t\t\t\t\t\tthis.clearCanvasToolbar(roleLabelsContainerEl);",
            "lineNumber": 540
          },
          {
            "text": "\t\t\t\t\t\tthis.clearTemplateBanner(roleLabelsContainerEl);",
            "lineNumber": 541
          },
          {
            "text": "\t\t\t\t\t\troleLabelsContainerEl = null;",
            "lineNumber": 542
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 543
          },
          {
            "text": "\t\t\t\t\treturn;",
            "lineNumber": 544
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 545
          },
          {
            "text": "\t\t\t\tif (roleLabelsContainerEl != null &amp;&amp; roleLabelsContainerEl !== view.containerEl) {",
            "lineNumber": 546
          },
          {
            "text": "\t\t\t\t\tclearCanvasRoleLabels(roleLabelsContainerEl);",
            "lineNumber": 547
          },
          {
            "text": "\t\t\t\t\tclearCanvasLegend(roleLabelsContainerEl);",
            "lineNumber": 548
          },
          {
            "text": "\t\t\t\t\tclearCanvasEdgeModeLabels(roleLabelsContainerEl);",
            "lineNumber": 549
          },
          {
            "text": "\t\t\t\t\tthis.clearCanvasToolbar(roleLabelsContainerEl);",
            "lineNumber": 550
          },
          {
            "text": "\t\t\t\t\tthis.clearTemplateBanner(roleLabelsContainerEl);",
            "lineNumber": 551
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 552
          },
          {
            "text": "\t\t\t\troleLabelsContainerEl = view.containerEl;",
            "lineNumber": 553
          },
          {
            "text": "\t\t\t\t// Show template banner if this canvas is in the template folder",
            "lineNumber": 554
          },
          {
            "text": "\t\t\t\tthis.syncTemplateBanner(view.containerEl, view.file.path);",
            "lineNumber": 555
          },
          {
            "text": "\t\t\t\t// Add \"Run entire canvas\" and \"Dismiss all output\" to the canvas (title bar if supported, else toolbar in container).",
            "lineNumber": 556
          },
          {
            "text": "\t\t\t\t// Use a property on the view so we only add once even after plugin hot-reload (WeakSet would be cleared on reload).",
            "lineNumber": 557
          },
          {
            "text": "\t\t\t\tconst leaf = this.app.workspace.activeLeaf;",
            "lineNumber": 558
          },
          {
            "text": "\t\t\t\tlet addedToTitleBar = false;",
            "lineNumber": 559
          },
          {
            "text": "\t\t\t\ttype ViewWithFlag = ItemView &amp; { addAction?: (icon: string, title: string, callback: (evt: MouseEvent) =&gt; void) =&gt; HTMLElement; _ztbTitleBarActionsAdded?: boolean };",
            "lineNumber": 560
          },
          {
            "text": "\t\t\t\tif (leaf?.view) {",
            "lineNumber": 561
          },
          {
            "text": "\t\t\t\t\tconst itemView = leaf.view as ViewWithFlag;",
            "lineNumber": 562
          },
          {
            "text": ";",
            "lineNumber": 588
          },
          {
            "text": "\t}",
            "lineNumber": 595
          },
          {
            "text": "}",
            "lineNumber": 878,
            "isSignature": true
          }
        ]
      },
      "score": 0.24913980066776276
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 329
          },
          "endPosition": {
            "line": 877,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\n\n\n\t/** Save current canvas as template: duplicate current canvas to template folder. */\n\tasync saveCanvasAsTemplate(): Promise&lt;void&gt; {\n\t\tconst view = this.getActiveCanvasView();\n\t\tif (!view) {\n\t\t\tnew Notice(\"No active canvas.\");\n\t\t\treturn;\n\t\t}\n\n\t\tconst templateFolder = this.settings.canvasTemplateFolder.trim();\n\t\tif (!templateFolder) {\n\t\t\tnew Notice(\"Canvas template folder not configured. Please set it in Settings → Zettel Thinking Board → Canvas Templates.\");\n\t\t\treturn;\n\t\t}\n\n\t\tconst currentPath = view.file.path;\n\t\tconst newTemplatePath = await saveCanvasAsTemplate(\n\t\t\tthis.app.vault,\n\t\t\tcurrentPath,\n\t\t\ttemplateFolder\n\t\t);\n\n\t\tif (!newTemplatePath) {\n\t\t\tnew Notice(\"Failed to save canvas as template.\");\n\t\t\treturn;\n\t\t}\n\n\t\tconst file = this.app.vault.getAbstractFileByPath(newTemplatePath);\n\t\tif (file instanceof TFile) {\n\t\t\tnew Notice(&#96;Template saved: ${file.basename}&#96;);\n\t\t} else {\n\t\t\tnew Notice(&#96;Template saved at: ${newTemplatePath}&#96;);\n\t\t}\n\t}\n\n\t/** Edit canvas template: open modal to select template, then open it. */\n\tasync editCanvasTemplate(): Promise&lt;void&gt; {\n\t\tconst templateFolder = this.settings.canvasTemplateFolder.trim();\n\t}\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 330,
                "column": 1
              },
              "endPosition": {
                "line": 330,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 330,
                "column": 16
              },
              "endPosition": {
                "line": 331,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 330,
            "isSignature": true
          },
          {
            "lineNumber": 691
          },
          {
            "lineNumber": 692
          },
          {
            "text": "\t/** Save current canvas as template: duplicate current canvas to template folder. */",
            "lineNumber": 693
          },
          {
            "text": "\tasync saveCanvasAsTemplate(): Promise&lt;void&gt; {",
            "lineNumber": 694
          },
          {
            "text": "\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 695
          },
          {
            "text": "\t\tif (!view) {",
            "lineNumber": 696
          },
          {
            "text": "\t\t\tnew Notice(\"No active canvas.\");",
            "lineNumber": 697
          },
          {
            "text": "\t\t\treturn;",
            "lineNumber": 698
          },
          {
            "text": "\t\t}",
            "lineNumber": 699
          },
          {
            "lineNumber": 700
          },
          {
            "text": "\t\tconst templateFolder = this.settings.canvasTemplateFolder.trim();",
            "lineNumber": 701
          },
          {
            "text": "\t\tif (!templateFolder) {",
            "lineNumber": 702
          },
          {
            "text": "\t\t\tnew Notice(\"Canvas template folder not configured. Please set it in Settings → Zettel Thinking Board → Canvas Templates.\");",
            "lineNumber": 703
          },
          {
            "text": "\t\t\treturn;",
            "lineNumber": 704
          },
          {
            "text": "\t\t}",
            "lineNumber": 705
          },
          {
            "lineNumber": 706
          },
          {
            "text": "\t\tconst currentPath = view.file.path;",
            "lineNumber": 707
          },
          {
            "text": "\t\tconst newTemplatePath = await saveCanvasAsTemplate(",
            "lineNumber": 708
          },
          {
            "text": "\t\t\tthis.app.vault,",
            "lineNumber": 709
          },
          {
            "text": "\t\t\tcurrentPath,",
            "lineNumber": 710
          },
          {
            "text": "\t\t\ttemplateFolder",
            "lineNumber": 711
          },
          {
            "text": "\t\t);",
            "lineNumber": 712
          },
          {
            "lineNumber": 713
          },
          {
            "text": "\t\tif (!newTemplatePath) {",
            "lineNumber": 714
          },
          {
            "text": "\t\t\tnew Notice(\"Failed to save canvas as template.\");",
            "lineNumber": 715
          },
          {
            "text": "\t\t\treturn;",
            "lineNumber": 716
          },
          {
            "text": "\t\t}",
            "lineNumber": 717
          },
          {
            "lineNumber": 718
          },
          {
            "text": "\t\tconst file = this.app.vault.getAbstractFileByPath(newTemplatePath);",
            "lineNumber": 719
          },
          {
            "text": "\t\tif (file instanceof TFile) {",
            "lineNumber": 720
          },
          {
            "text": "\t\t\tnew Notice(&#96;Template saved: ${file.basename}&#96;);",
            "lineNumber": 721
          },
          {
            "text": "\t\t} else {",
            "lineNumber": 722
          },
          {
            "text": "\t\t\tnew Notice(&#96;Template saved at: ${newTemplatePath}&#96;);",
            "lineNumber": 723
          },
          {
            "text": "\t\t}",
            "lineNumber": 724
          },
          {
            "text": "\t}",
            "lineNumber": 725
          },
          {
            "lineNumber": 726
          },
          {
            "text": "\t/** Edit canvas template: open modal to select template, then open it. */",
            "lineNumber": 727
          },
          {
            "text": "\tasync editCanvasTemplate(): Promise&lt;void&gt; {",
            "lineNumber": 728
          },
          {
            "text": "\t\tconst templateFolder = this.settings.canvasTemplateFolder.trim();",
            "lineNumber": 729
          },
          {
            "text": "\t}",
            "lineNumber": 744
          },
          {
            "text": "}",
            "lineNumber": 878,
            "isSignature": true
          }
        ]
      },
      "score": 0.24813604354858398
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/canvasTemplates.ts",
        "range": {
          "startPosition": {
            "line": 46,
            "column": 1
          },
          "endPosition": {
            "line": 118,
            "column": 3
          }
        },
        "contents": "/**\n * Duplicate a canvas to a target folder.\n * Creates a new canvas file with a unique name and copies all nodes and edges.\n * Returns the path of the new canvas file, or null if failed.\n */\nasync function duplicateCanvasToFolder(\n\tvault: Vault,\n\tsourcePath: string,\n\ttargetFolder: string,\n\tbaseName?: string\n): Promise&lt;string | null&gt; {\n\t// Load the source canvas data\n\tconst sourceData = await loadCanvasData(vault, sourcePath);\n\tif (!sourceData) return null;\n\n\t// Determine the base name for the new canvas\n\tconst sourceFile = vault.getAbstractFileByPath(sourcePath);\n\tif (!sourceFile || !(sourceFile instanceof TFile)) return null;\n\n\tconst nameBase = baseName || sourceFile.basename;\n\n\t// Determine the output path\n\tconst targetFolderNormalized = targetFolder ? normalizePath(targetFolder) : \"\";\n\tlet outputPath: string;\n\tlet counter = 0;\n\n\t// Find a unique name\n\twhile (true) {\n\t\tconst fileName = counter === 0 ? &#96;${nameBase}.canvas&#96; : &#96;${nameBase} ${counter}.canvas&#96;;\n\t\toutputPath = targetFolderNormalized\n\t\t\t? normalizePath(&#96;${targetFolderNormalized}/${fileName}&#96;)\n\t\t\t: normalizePath(fileName);\n\n\t\tif (!vault.getAbstractFileByPath(outputPath)) break;\n\t\tcounter += 1;\n\n\t\t// Safety: prevent infinite loop\n\t\tif (counter &gt; 1000) return null;\n\t}\n\n\t// Ensure the target folder exists\n\tif (targetFolderNormalized) {\n\t\tconst folder = vault.getAbstractFileByPath(targetFolderNormalized);\n\t\tif (!folder) {\n\t\t\ttry {\n\t\t\t\tawait vault.createFolder(targetFolderNormalized);\n\t\t\t} catch (e) {\n\t\t\t\tconsole.error(\"Failed to create target folder:\", e);\n\t\t\t\treturn null;\n\t\t\t}\n\t\t}\n\t}\n\n\t// Create a deep copy of the canvas data to avoid mutation\n\tconst newCanvasData: CanvasData = {\n\t\tnodes: sourceData.nodes.map((node) =&gt; ({ ...node })),\n\t\tedges: sourceData.edges.map((edge) =&gt; ({ ...edge })),\n\t};\n\n\t// Save the new canvas\n\tconst success = await saveCanvasData(vault, outputPath, newCanvasData);\n\tif (!success) return null;\n\n\treturn outputPath;\n}\n\n/**\n * Duplicate a canvas template to the output folder.\n * Creates a new canvas file with a unique name and copies all nodes and edges.\n * Returns the path of the new canvas file, or null if failed.\n */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/**",
            "lineNumber": 49
          },
          {
            "text": " * Duplicate a canvas to a target folder.",
            "lineNumber": 50
          },
          {
            "text": " * Creates a new canvas file with a unique name and copies all nodes and edges.",
            "lineNumber": 51
          },
          {
            "text": " * Returns the path of the new canvas file, or null if failed.",
            "lineNumber": 52
          },
          {
            "text": " */",
            "lineNumber": 53
          },
          {
            "text": "async function duplicateCanvasToFolder(",
            "lineNumber": 54,
            "isSignature": true
          },
          {
            "text": "\tvault: Vault,",
            "lineNumber": 55,
            "isSignature": true
          },
          {
            "text": "\tsourcePath: string,",
            "lineNumber": 56,
            "isSignature": true
          },
          {
            "text": "\ttargetFolder: string,",
            "lineNumber": 57,
            "isSignature": true
          },
          {
            "text": "\tbaseName?: string",
            "lineNumber": 58,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;string | null&gt; {",
            "lineNumber": 59,
            "isSignature": true
          },
          {
            "text": "\t// Load the source canvas data",
            "lineNumber": 60
          },
          {
            "text": "\tconst sourceData = await loadCanvasData(vault, sourcePath);",
            "lineNumber": 61
          },
          {
            "text": "\tif (!sourceData) return null;",
            "lineNumber": 62
          },
          {
            "lineNumber": 63
          },
          {
            "text": "\t// Determine the base name for the new canvas",
            "lineNumber": 64
          },
          {
            "text": "\tconst sourceFile = vault.getAbstractFileByPath(sourcePath);",
            "lineNumber": 65
          },
          {
            "text": "\tif (!sourceFile || !(sourceFile instanceof TFile)) return null;",
            "lineNumber": 66
          },
          {
            "lineNumber": 67
          },
          {
            "text": "\tconst nameBase = baseName || sourceFile.basename;",
            "lineNumber": 68
          },
          {
            "lineNumber": 69
          },
          {
            "text": "\t// Determine the output path",
            "lineNumber": 70
          },
          {
            "text": "\tconst targetFolderNormalized = targetFolder ? normalizePath(targetFolder) : \"\";",
            "lineNumber": 71
          },
          {
            "text": "\tlet outputPath: string;",
            "lineNumber": 72
          },
          {
            "text": "\tlet counter = 0;",
            "lineNumber": 73
          },
          {
            "lineNumber": 74
          },
          {
            "text": "\t// Find a unique name",
            "lineNumber": 75
          },
          {
            "text": "\twhile (true) {",
            "lineNumber": 76
          },
          {
            "text": "\t\tconst fileName = counter === 0 ? &#96;${nameBase}.canvas&#96; : &#96;${nameBase} ${counter}.canvas&#96;;",
            "lineNumber": 77
          },
          {
            "text": "\t\toutputPath = targetFolderNormalized",
            "lineNumber": 78
          },
          {
            "text": "\t\t\t? normalizePath(&#96;${targetFolderNormalized}/${fileName}&#96;)",
            "lineNumber": 79
          },
          {
            "text": "\t\t\t: normalizePath(fileName);",
            "lineNumber": 80
          },
          {
            "lineNumber": 81
          },
          {
            "text": "\t\tif (!vault.getAbstractFileByPath(outputPath)) break;",
            "lineNumber": 82
          },
          {
            "text": "\t\tcounter += 1;",
            "lineNumber": 83
          },
          {
            "lineNumber": 84
          },
          {
            "text": "\t\t// Safety: prevent infinite loop",
            "lineNumber": 85
          },
          {
            "text": "\t\tif (counter &gt; 1000) return null;",
            "lineNumber": 86
          },
          {
            "text": "\t}",
            "lineNumber": 87
          },
          {
            "lineNumber": 88
          },
          {
            "text": "\t// Ensure the target folder exists",
            "lineNumber": 89
          },
          {
            "text": "\tif (targetFolderNormalized) {",
            "lineNumber": 90
          },
          {
            "text": "\t\tconst folder = vault.getAbstractFileByPath(targetFolderNormalized);",
            "lineNumber": 91
          },
          {
            "text": "\t\tif (!folder) {",
            "lineNumber": 92
          },
          {
            "text": "\t\t\ttry {",
            "lineNumber": 93
          },
          {
            "text": "\t\t\t\tawait vault.createFolder(targetFolderNormalized);",
            "lineNumber": 94
          },
          {
            "text": "\t\t\t} catch (e) {",
            "lineNumber": 95
          },
          {
            "text": "\t\t\t\tconsole.error(\"Failed to create target folder:\", e);",
            "lineNumber": 96
          },
          {
            "text": "\t\t\t\treturn null;",
            "lineNumber": 97
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 98
          },
          {
            "text": "\t\t}",
            "lineNumber": 99
          },
          {
            "text": "\t}",
            "lineNumber": 100
          },
          {
            "lineNumber": 101
          },
          {
            "text": "\t// Create a deep copy of the canvas data to avoid mutation",
            "lineNumber": 102
          },
          {
            "text": "\tconst newCanvasData: CanvasData = {",
            "lineNumber": 103
          },
          {
            "text": "\t\tnodes: sourceData.nodes.map((node) =&gt; ({ ...node })),",
            "lineNumber": 104
          },
          {
            "text": "\t\tedges: sourceData.edges.map((edge) =&gt; ({ ...edge })),",
            "lineNumber": 105
          },
          {
            "text": "\t};",
            "lineNumber": 106
          },
          {
            "lineNumber": 107
          },
          {
            "text": "\t// Save the new canvas",
            "lineNumber": 108
          },
          {
            "text": "\tconst success = await saveCanvasData(vault, outputPath, newCanvasData);",
            "lineNumber": 109
          },
          {
            "text": "\tif (!success) return null;",
            "lineNumber": 110
          },
          {
            "lineNumber": 111
          },
          {
            "text": "\treturn outputPath;",
            "lineNumber": 112
          },
          {
            "text": "}",
            "lineNumber": 113,
            "isSignature": true
          },
          {
            "lineNumber": 114
          },
          {
            "text": "/**",
            "lineNumber": 115
          },
          {
            "text": " * Duplicate a canvas template to the output folder.",
            "lineNumber": 116
          },
          {
            "text": " * Creates a new canvas file with a unique name and copies all nodes and edges.",
            "lineNumber": 117
          },
          {
            "text": " * Returns the path of the new canvas file, or null if failed.",
            "lineNumber": 118
          },
          {
            "text": " */",
            "lineNumber": 119
          }
        ]
      },
      "score": 0.2460107058286667
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/canvas/nodes.ts",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 34,
            "column": 1
          }
        },
        "contents": "import type {Vault} from \"obsidian\";\nimport type {AllCanvasNodeData, CanvasData, CanvasFileData, CanvasTextData} from \"obsidian/canvas\";\nimport {\n\tgetFileNodePath,\n\tgetNodeById,\n\tgetNodeRole,\n\tgetParentIdsSortedByY,\n\tgetTextNodeContent,\n\tisFileNode,\n\tisTextNode,\n} from \"./types\";\nimport type {ZettelPluginSettings} from \"../settings\";\n\n/** Load canvas data from vault by reading the canvas file (JSON). */\nexport async function loadCanvasData(vault: Vault, filePath: string): Promise&lt;CanvasData | null&gt; {\n\ttry {\n\t\tconst raw = await vault.adapter.read(filePath);\n\t\tconst data = JSON.parse(raw) as CanvasData;\n\t\tif (data &amp;&amp; Array.isArray(data.nodes) &amp;&amp; Array.isArray(data.edges)) return data;\n\t} catch {\n\t\t// ignore\n\t}\n\treturn null;\n}\n\n/** Save canvas data to vault (writes the canvas file). */\nexport async function saveCanvasData(vault: Vault, filePath: string, data: CanvasData): Promise&lt;boolean&gt; {\n\t\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "import type {Vault} from \"obsidian\";",
            "lineNumber": 1
          },
          {
            "text": "import type {AllCanvasNodeData, CanvasData, CanvasFileData, CanvasTextData} from \"obsidian/canvas\";",
            "lineNumber": 2
          },
          {
            "text": "import {",
            "lineNumber": 3
          },
          {
            "text": "\tgetFileNodePath,",
            "lineNumber": 4
          },
          {
            "text": "\tgetNodeById,",
            "lineNumber": 5
          },
          {
            "text": "\tgetNodeRole,",
            "lineNumber": 6
          },
          {
            "text": "\tgetParentIdsSortedByY,",
            "lineNumber": 7
          },
          {
            "text": "\tgetTextNodeContent,",
            "lineNumber": 8
          },
          {
            "text": "\tisFileNode,",
            "lineNumber": 9
          },
          {
            "text": "\tisTextNode,",
            "lineNumber": 10
          },
          {
            "text": "} from \"./types\";",
            "lineNumber": 11
          },
          {
            "text": "import type {ZettelPluginSettings} from \"../settings\";",
            "lineNumber": 12
          },
          {
            "lineNumber": 13
          },
          {
            "text": "/** Load canvas data from vault by reading the canvas file (JSON). */",
            "lineNumber": 14
          },
          {
            "text": "export async function loadCanvasData(vault: Vault, filePath: string): Promise&lt;CanvasData | null&gt; {",
            "lineNumber": 15,
            "isSignature": true
          },
          {
            "text": "\ttry {",
            "lineNumber": 16
          },
          {
            "text": "\t\tconst raw = await vault.adapter.read(filePath);",
            "lineNumber": 17
          },
          {
            "text": "\t\tconst data = JSON.parse(raw) as CanvasData;",
            "lineNumber": 18
          },
          {
            "text": "\t\tif (data &amp;&amp; Array.isArray(data.nodes) &amp;&amp; Array.isArray(data.edges)) return data;",
            "lineNumber": 19
          },
          {
            "text": "\t} catch {",
            "lineNumber": 20
          },
          {
            "text": "\t\t// ignore",
            "lineNumber": 21
          },
          {
            "text": "\t}",
            "lineNumber": 22
          },
          {
            "text": "\treturn null;",
            "lineNumber": 23
          },
          {
            "text": "}",
            "lineNumber": 24,
            "isSignature": true
          },
          {
            "lineNumber": 25
          },
          {
            "text": "/** Save canvas data to vault (writes the canvas file). */",
            "lineNumber": 26
          },
          {
            "text": "export async function saveCanvasData(vault: Vault, filePath: string, data: CanvasData): Promise&lt;boolean&gt; {",
            "lineNumber": 27,
            "isSignature": true
          },
          {
            "text": "\t",
            "lineNumber": 28
          },
          {
            "text": "}",
            "lineNumber": 35,
            "isSignature": true
          }
        ]
      },
      "score": 0.24292020499706268
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {
            "line": 254
          },
          "endPosition": {
            "line": 348,
            "column": 99
          }
        },
        "contents": "async function runSingleNode(\n\tapp: App,\n\tsettings: ZettelPluginSettings,\n\tcanvasKey: string,\n\tcanvasFilePath: string,\n\tdata: CanvasData,\n\tnodeId: string,\n\tliveCanvas: LiveCanvas | null\n): Promise&lt;string&gt; {\n\n\tif (role === \"purple\") {\n\t\tconst model = settings.ollamaPurpleModel || \"llama2\";\n\t\tconst temperature = settings.ollamaPurpleTemperature ?? DEFAULT_SETTINGS.ollamaPurpleTemperature;\n\t\tconst result = await ollamaGenerate({\n\t\t\tmodel,\n\t\t\tprompt: fullPrompt,\n\t\t\tstream: false,\n\t\t\toptions: { temperature },\n\t\t});\n\t\tsetNodeResult(canvasKey, nodeId, result);\n\t\tensureOutputNodeAndEdge(data, node, result, settings);\n\t\tawait updateEdgeLabelsAndSave(app.vault, canvasFilePath, data, nodeId, edgeModes, liveCanvas);\n\t\treturn result;\n\t}\n\tif (role === \"red\") {\n\t\tconst model = settings.ollamaRedModel || \"llama2\";\n\t\tconst temperature = settings.ollamaRedTemperature ?? DEFAULT_SETTINGS.ollamaRedTemperature;\n\t\tconst result = await ollamaGenerate({\n\t\t\tmodel,\n\t\t\tprompt: fullPrompt,\n\t\t\tstream: false,\n\t\t\toptions: { temperature },\n\t\t});\n\t\tsetNodeResult(canvasKey, nodeId, result);\n\t\tensureOutputNodeAndEdge(data, node, result, settings);\n\t\tawait updateEdgeLabelsAndSave(app.vault, canvasFilePath, data, nodeId, edgeModes, liveCanvas);\n\t\treturn result;\n\t}\n\tif (role === \"blue\") {\n\t\tconst kernel = getKernelForCanvas(canvasKey, settings.pythonPath);\n\t\tconst code = stripPythonCodeFence(template);\n\t\tconst result = await kernel.run(code, concatenatedPart);\n\t\tsetNodeResult(canvasKey, nodeId, result);\n\t\tensureOutputNodeAndEdge(data, node, result, settings);\n\t\tawait updateEdgeLabelsAndSave(app.vault, canvasFilePath, data, nodeId, edgeModes, liveCanvas);\n\t\treturn result;\n\t}\n\treturn \"\";\n}\n\n/** Max horizontal offset (px) for output box collision avoidance; beyond this we allow overlap. */",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 255,
                "column": 1
              },
              "endPosition": {
                "line": 264,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "async function runSingleNode(",
            "lineNumber": 255,
            "isSignature": true
          },
          {
            "text": "\tapp: App,",
            "lineNumber": 256,
            "isSignature": true
          },
          {
            "text": "\tsettings: ZettelPluginSettings,",
            "lineNumber": 257,
            "isSignature": true
          },
          {
            "text": "\tcanvasKey: string,",
            "lineNumber": 258,
            "isSignature": true
          },
          {
            "text": "\tcanvasFilePath: string,",
            "lineNumber": 259,
            "isSignature": true
          },
          {
            "text": "\tdata: CanvasData,",
            "lineNumber": 260,
            "isSignature": true
          },
          {
            "text": "\tnodeId: string,",
            "lineNumber": 261,
            "isSignature": true
          },
          {
            "text": "\tliveCanvas: LiveCanvas | null",
            "lineNumber": 262,
            "isSignature": true
          },
          {
            "text": "): Promise&lt;string&gt; {",
            "lineNumber": 263,
            "isSignature": true
          },
          {
            "lineNumber": 308
          },
          {
            "text": "\tif (role === \"purple\") {",
            "lineNumber": 309
          },
          {
            "text": "\t\tconst model = settings.ollamaPurpleModel || \"llama2\";",
            "lineNumber": 310
          },
          {
            "text": "\t\tconst temperature = settings.ollamaPurpleTemperature ?? DEFAULT_SETTINGS.ollamaPurpleTemperature;",
            "lineNumber": 311
          },
          {
            "text": "\t\tconst result = await ollamaGenerate({",
            "lineNumber": 312
          },
          {
            "text": "\t\t\tmodel,",
            "lineNumber": 313
          },
          {
            "text": "\t\t\tprompt: fullPrompt,",
            "lineNumber": 314
          },
          {
            "text": "\t\t\tstream: false,",
            "lineNumber": 315
          },
          {
            "text": "\t\t\toptions: { temperature },",
            "lineNumber": 316
          },
          {
            "text": "\t\t});",
            "lineNumber": 317
          },
          {
            "text": "\t\tsetNodeResult(canvasKey, nodeId, result);",
            "lineNumber": 318
          },
          {
            "text": "\t\tensureOutputNodeAndEdge(data, node, result, settings);",
            "lineNumber": 319
          },
          {
            "text": "\t\tawait updateEdgeLabelsAndSave(app.vault, canvasFilePath, data, nodeId, edgeModes, liveCanvas);",
            "lineNumber": 320
          },
          {
            "text": "\t\treturn result;",
            "lineNumber": 321
          },
          {
            "text": "\t}",
            "lineNumber": 322
          },
          {
            "text": "\tif (role === \"red\") {",
            "lineNumber": 323
          },
          {
            "text": "\t\tconst model = settings.ollamaRedModel || \"llama2\";",
            "lineNumber": 324
          },
          {
            "text": "\t\tconst temperature = settings.ollamaRedTemperature ?? DEFAULT_SETTINGS.ollamaRedTemperature;",
            "lineNumber": 325
          },
          {
            "text": "\t\tconst result = await ollamaGenerate({",
            "lineNumber": 326
          },
          {
            "text": "\t\t\tmodel,",
            "lineNumber": 327
          },
          {
            "text": "\t\t\tprompt: fullPrompt,",
            "lineNumber": 328
          },
          {
            "text": "\t\t\tstream: false,",
            "lineNumber": 329
          },
          {
            "text": "\t\t\toptions: { temperature },",
            "lineNumber": 330
          },
          {
            "text": "\t\t});",
            "lineNumber": 331
          },
          {
            "text": "\t\tsetNodeResult(canvasKey, nodeId, result);",
            "lineNumber": 332
          },
          {
            "text": "\t\tensureOutputNodeAndEdge(data, node, result, settings);",
            "lineNumber": 333
          },
          {
            "text": "\t\tawait updateEdgeLabelsAndSave(app.vault, canvasFilePath, data, nodeId, edgeModes, liveCanvas);",
            "lineNumber": 334
          },
          {
            "text": "\t\treturn result;",
            "lineNumber": 335
          },
          {
            "text": "\t}",
            "lineNumber": 336
          },
          {
            "text": "\tif (role === \"blue\") {",
            "lineNumber": 337
          },
          {
            "text": "\t\tconst kernel = getKernelForCanvas(canvasKey, settings.pythonPath);",
            "lineNumber": 338
          },
          {
            "text": "\t\tconst code = stripPythonCodeFence(template);",
            "lineNumber": 339
          },
          {
            "text": "\t\tconst result = await kernel.run(code, concatenatedPart);",
            "lineNumber": 340
          },
          {
            "text": "\t\tsetNodeResult(canvasKey, nodeId, result);",
            "lineNumber": 341
          },
          {
            "text": "\t\tensureOutputNodeAndEdge(data, node, result, settings);",
            "lineNumber": 342
          },
          {
            "text": "\t\tawait updateEdgeLabelsAndSave(app.vault, canvasFilePath, data, nodeId, edgeModes, liveCanvas);",
            "lineNumber": 343
          },
          {
            "text": "\t\treturn result;",
            "lineNumber": 344
          },
          {
            "text": "\t}",
            "lineNumber": 345
          },
          {
            "text": "\treturn \"\";",
            "lineNumber": 346
          },
          {
            "text": "}",
            "lineNumber": 347,
            "isSignature": true
          },
          {
            "lineNumber": 348
          },
          {
            "text": "/** Max horizontal offset (px) for output box collision avoidance; beyond this we allow overlap. */",
            "lineNumber": 349
          }
        ]
      },
      "score": 0.23914030194282532
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/engine/runner.ts",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 32,
            "column": 109
          }
        },
        "contents": "import type {App} from \"obsidian\";\nimport {Notice} from \"obsidian\";\nimport {\n\tEDGE_LABEL_OUTPUT,\n\tfindOutputNodeForSource,\n\tgetNodeById,\n\tgetNodeContent,\n\tgetNodeRole,\n\tgetIncomingEdgesWithLabels,\n\tgetParentIdsSortedByY,\n\tGREEN_NODE_PADDING,\n\tisOutputEdge,\n\tloadCanvasData,\n\tsaveCanvasData,\n} from \"../canvas/nodes\";\nimport type {AllCanvasNodeData, CanvasData, CanvasEdgeData, CanvasTextData} from \"../canvas/types\";\nimport { getTextNodeContent, parseEdgeVariableName } from \"../canvas/types\";\nimport {isTextNode} from \"../canvas/types\";\nimport type {LiveCanvas} from \"./canvasApi\";\nimport {getKernelForCanvas} from \"./kernelManager\";\nimport {ollamaGenerate} from \"./ollama\";\nimport {\n\tgetCanvasKey,\n\tgetNodeResult,\n\tsetNodeResult,\n\tsetEdgeModes,\n\tsetRunningNodeId,\n} from \"./state\";\nimport {DEFAULT_SETTINGS, type NodeRole, type ZettelPluginSettings} from \"../settings\";\n\ntype EdgeInputMode = \"inject\" | \"concatenate\";\n\n/** True if the role is non-AI (Python or text pass-through); prefer running these first for early output. */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "import type {App} from \"obsidian\";",
            "lineNumber": 1
          },
          {
            "text": "import {Notice} from \"obsidian\";",
            "lineNumber": 2
          },
          {
            "text": "import {",
            "lineNumber": 3
          },
          {
            "text": "\tEDGE_LABEL_OUTPUT,",
            "lineNumber": 4
          },
          {
            "text": "\tfindOutputNodeForSource,",
            "lineNumber": 5
          },
          {
            "text": "\tgetNodeById,",
            "lineNumber": 6
          },
          {
            "text": "\tgetNodeContent,",
            "lineNumber": 7
          },
          {
            "text": "\tgetNodeRole,",
            "lineNumber": 8
          },
          {
            "text": "\tgetIncomingEdgesWithLabels,",
            "lineNumber": 9
          },
          {
            "text": "\tgetParentIdsSortedByY,",
            "lineNumber": 10
          },
          {
            "text": "\tGREEN_NODE_PADDING,",
            "lineNumber": 11
          },
          {
            "text": "\tisOutputEdge,",
            "lineNumber": 12
          },
          {
            "text": "\tloadCanvasData,",
            "lineNumber": 13
          },
          {
            "text": "\tsaveCanvasData,",
            "lineNumber": 14
          },
          {
            "text": "} from \"../canvas/nodes\";",
            "lineNumber": 15
          },
          {
            "text": "import type {AllCanvasNodeData, CanvasData, CanvasEdgeData, CanvasTextData} from \"../canvas/types\";",
            "lineNumber": 16
          },
          {
            "text": "import { getTextNodeContent, parseEdgeVariableName } from \"../canvas/types\";",
            "lineNumber": 17
          },
          {
            "text": "import {isTextNode} from \"../canvas/types\";",
            "lineNumber": 18
          },
          {
            "text": "import type {LiveCanvas} from \"./canvasApi\";",
            "lineNumber": 19
          },
          {
            "text": "import {getKernelForCanvas} from \"./kernelManager\";",
            "lineNumber": 20
          },
          {
            "text": "import {ollamaGenerate} from \"./ollama\";",
            "lineNumber": 21
          },
          {
            "text": "import {",
            "lineNumber": 22
          },
          {
            "text": "\tgetCanvasKey,",
            "lineNumber": 23
          },
          {
            "text": "\tgetNodeResult,",
            "lineNumber": 24
          },
          {
            "text": "\tsetNodeResult,",
            "lineNumber": 25
          },
          {
            "text": "\tsetEdgeModes,",
            "lineNumber": 26
          },
          {
            "text": "\tsetRunningNodeId,",
            "lineNumber": 27
          },
          {
            "text": "} from \"./state\";",
            "lineNumber": 28
          },
          {
            "text": "import {DEFAULT_SETTINGS, type NodeRole, type ZettelPluginSettings} from \"../settings\";",
            "lineNumber": 29
          },
          {
            "lineNumber": 30
          },
          {
            "text": "type EdgeInputMode = \"inject\" | \"concatenate\";",
            "lineNumber": 31,
            "isSignature": true
          },
          {
            "lineNumber": 32
          },
          {
            "text": "/** True if the role is non-AI (Python or text pass-through); prefer running these first for early output. */",
            "lineNumber": 33
          }
        ]
      },
      "score": 0.23282653093338013
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 329
          },
          "endPosition": {
            "line": 877,
            "column": 1
          }
        },
        "contents": "export default class ZettelThinkingBoardPlugin extends Plugin {\n\n\n\t/** Run entire canvas (call from canvas background context menu). */\n\tasync runEntireCanvas(): Promise&lt;void&gt; {\n\t\tconst view = this.getActiveCanvasView();\n\t\tif (!view) return;\n\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;\n\t\tconst result = await runnerRunEntireCanvas(this.app, this.settings, view.file.path, liveCanvas);\n\t\tif (!result.ok) new Notice(result.message ?? \"Run entire canvas failed.\");\n\t}\n\n\t/** Dismiss all output nodes on the canvas (call from canvas background context menu). */\n}",
        "signatures": {
          "ranges": [
            {
              "startPosition": {
                "line": 330,
                "column": 1
              },
              "endPosition": {
                "line": 330,
                "column": 16
              }
            },
            {
              "startPosition": {
                "line": 330,
                "column": 16
              },
              "endPosition": {
                "line": 331,
                "column": 2
              }
            }
          ]
        },
        "detailedLines": [
          {
            "text": "export default class ZettelThinkingBoardPlugin extends Plugin {",
            "lineNumber": 330,
            "isSignature": true
          },
          {
            "lineNumber": 853
          },
          {
            "lineNumber": 854
          },
          {
            "text": "\t/** Run entire canvas (call from canvas background context menu). */",
            "lineNumber": 855
          },
          {
            "text": "\tasync runEntireCanvas(): Promise&lt;void&gt; {",
            "lineNumber": 856
          },
          {
            "text": "\t\tconst view = this.getActiveCanvasView();",
            "lineNumber": 857
          },
          {
            "text": "\t\tif (!view) return;",
            "lineNumber": 858
          },
          {
            "text": "\t\tconst liveCanvas = view.canvas as import(\"./engine/canvasApi\").LiveCanvas;",
            "lineNumber": 859
          },
          {
            "text": "\t\tconst result = await runnerRunEntireCanvas(this.app, this.settings, view.file.path, liveCanvas);",
            "lineNumber": 860
          },
          {
            "text": "\t\tif (!result.ok) new Notice(result.message ?? \"Run entire canvas failed.\");",
            "lineNumber": 861
          },
          {
            "text": "\t}",
            "lineNumber": 862
          },
          {
            "lineNumber": 863
          },
          {
            "text": "\t/** Dismiss all output nodes on the canvas (call from canvas background context menu). */",
            "lineNumber": 864
          },
          {
            "text": "}",
            "lineNumber": 878,
            "isSignature": true
          }
        ]
      },
      "score": 0.23256045579910278
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/main.ts",
        "range": {
          "startPosition": {
            "line": 66,
            "column": 1
          },
          "endPosition": {
            "line": 96,
            "column": 92
          }
        },
        "contents": "/** Build combined tutorial canvas: 3 workflows showcasing concatenation, variable injection, and Python state. */\nfunction getCombinedTutorialCanvasData(settings: ZettelPluginSettings): CanvasData {\n\tconst wf1 = getExample1CanvasData();\n\tconst wf23 = getExample4CanvasData();\n\tconst wf23Nodes = wf23.nodes.map((node) =&gt; ({\n\t\t...node,\n\t\tid: TUTORIAL_WORKFLOWS_23_ID_PREFIX + node.id,\n\t\tx: (node as { x: number }).x + TUTORIAL_WORKFLOWS_23_X_OFFSET,\n\t\tcolor: applyColorSettings(node.color, settings),\n\t}));\n\tconst wf23Edges = wf23.edges.map((edge, i) =&gt; ({\n\t\t...edge,\n\t\tid: &#96;${TUTORIAL_WORKFLOWS_23_ID_PREFIX}edge-${i}&#96;,\n\t\tfromNode: TUTORIAL_WORKFLOWS_23_ID_PREFIX + edge.fromNode,\n\t\ttoNode: TUTORIAL_WORKFLOWS_23_ID_PREFIX + edge.toNode,\n\t\tlabel: edge.label,\n\t}));\n\t// Apply color settings to workflow 1 as well\n\tconst wf1NodesWithColors = wf1.nodes.map((node) =&gt; ({\n\t\t...node,\n\t\tcolor: applyColorSettings(node.color, settings),\n\t}));\n\treturn {\n\t\tnodes: [...wf1NodesWithColors, ...wf23Nodes],\n\t\tedges: [...wf1.edges, ...wf23Edges],\n\t};\n}\n\n/** Build tutorial canvas: columns with comment margins, node lane center, edges, groups. */",
        "signatures": {},
        "detailedLines": [
          {
            "text": "/** Build combined tutorial canvas: 3 workflows showcasing concatenation, variable injection, and Python state. */",
            "lineNumber": 69
          },
          {
            "text": "function getCombinedTutorialCanvasData(settings: ZettelPluginSettings): CanvasData {",
            "lineNumber": 70,
            "isSignature": true
          },
          {
            "text": "\tconst wf1 = getExample1CanvasData();",
            "lineNumber": 71
          },
          {
            "text": "\tconst wf23 = getExample4CanvasData();",
            "lineNumber": 72
          },
          {
            "text": "\tconst wf23Nodes = wf23.nodes.map((node) =&gt; ({",
            "lineNumber": 73
          },
          {
            "text": "\t\t...node,",
            "lineNumber": 74
          },
          {
            "text": "\t\tid: TUTORIAL_WORKFLOWS_23_ID_PREFIX + node.id,",
            "lineNumber": 75
          },
          {
            "text": "\t\tx: (node as { x: number }).x + TUTORIAL_WORKFLOWS_23_X_OFFSET,",
            "lineNumber": 76
          },
          {
            "text": "\t\tcolor: applyColorSettings(node.color, settings),",
            "lineNumber": 77
          },
          {
            "text": "\t}));",
            "lineNumber": 78
          },
          {
            "text": "\tconst wf23Edges = wf23.edges.map((edge, i) =&gt; ({",
            "lineNumber": 79
          },
          {
            "text": "\t\t...edge,",
            "lineNumber": 80
          },
          {
            "text": "\t\tid: &#96;${TUTORIAL_WORKFLOWS_23_ID_PREFIX}edge-${i}&#96;,",
            "lineNumber": 81
          },
          {
            "text": "\t\tfromNode: TUTORIAL_WORKFLOWS_23_ID_PREFIX + edge.fromNode,",
            "lineNumber": 82
          },
          {
            "text": "\t\ttoNode: TUTORIAL_WORKFLOWS_23_ID_PREFIX + edge.toNode,",
            "lineNumber": 83
          },
          {
            "text": "\t\tlabel: edge.label,",
            "lineNumber": 84
          },
          {
            "text": "\t}));",
            "lineNumber": 85
          },
          {
            "text": "\t// Apply color settings to workflow 1 as well",
            "lineNumber": 86
          },
          {
            "text": "\tconst wf1NodesWithColors = wf1.nodes.map((node) =&gt; ({",
            "lineNumber": 87
          },
          {
            "text": "\t\t...node,",
            "lineNumber": 88
          },
          {
            "text": "\t\tcolor: applyColorSettings(node.color, settings),",
            "lineNumber": 89
          },
          {
            "text": "\t}));",
            "lineNumber": 90
          },
          {
            "text": "\treturn {",
            "lineNumber": 91
          },
          {
            "text": "\t\tnodes: [...wf1NodesWithColors, ...wf23Nodes],",
            "lineNumber": 92
          },
          {
            "text": "\t\tedges: [...wf1.edges, ...wf23Edges],",
            "lineNumber": 93
          },
          {
            "text": "\t};",
            "lineNumber": 94
          },
          {
            "text": "}",
            "lineNumber": 95,
            "isSignature": true
          },
          {
            "lineNumber": 96
          },
          {
            "text": "/** Build tutorial canvas: columns with comment margins, node lane center, edges, groups. */",
            "lineNumber": 97
          }
        ]
      },
      "score": 0.23243699967861176
    }
  ]
}
```
Status: **completed**


</details>
</tool-use>

---


Checking whether we notify Obsidian to persist after adding the output node:


---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/main.ts</summary>

</details>
</tool-use>

---


Checking the run path for a missing `requestSave`:


---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "requestSave",
  "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
  "contextBefore": 1,
  "contextAfter": 1,
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "requestSave",
    "path": "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src",
    "outputMode": "content",
    "workspaceResults": {
      "/Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board": {
        "content": {
          "matches": [
            {
              "file": "src/engine/runner.ts",
              "matches": [
                {
                  "lineNumber": 663,
                  "content": "\tliveCanvas?.setData?.(data);",
                  "isContextLine": true
                },
                {
                  "lineNumber": 664,
                  "content": "\tif (liveCanvas?.requestSave) liveCanvas.requestSave();"
                },
                {
                  "lineNumber": 665,
                  "content": "\tconst saved = await saveCanvasData(vault, canvasFilePath, data);",
                  "isContextLine": true
                },
                {
                  "lineNumber": 684,
                  "content": "\tliveCanvas?.setData?.(data);",
                  "isContextLine": true
                },
                {
                  "lineNumber": 685,
                  "content": "\tif (liveCanvas?.requestSave) liveCanvas.requestSave();"
                },
                {
                  "lineNumber": 686,
                  "content": "\tconst saved = await saveCanvasData(vault, canvasFilePath, data);",
                  "isContextLine": true
                }
              ]
            },
            {
              "file": "src/engine/canvasApi.ts",
              "matches": [
                {
                  "lineNumber": 10,
                  "content": "\taddNode(node: unknown): void;",
                  "isContextLine": true
                },
                {
                  "lineNumber": 11,
                  "content": "\trequestSave?: () =&gt; void;"
                },
                {
                  "lineNumber": 12,
                  "content": "\tremoveNode?(node: unknown): void;",
                  "isContextLine": true
                }
              ]
            }
          ],
          "totalLines": 9,
          "totalMatchedLines": 3
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---


Identifying cause: we call `requestSave` only for dismiss, not after run. So after adding an output node we write the file with `saveCanvasData` but don't tell Obsidian the canvas is dirty. On tab switch Obsidian can save the view's internal state and overwrite our file. Adding `requestSave` after we update the canvas in the run path.


---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** • Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>

</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>
</tool-use>

---





---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** • Edit file: /Users/caffae/Notes/TestPlugin/.obsidian/plugins/Zettel-Thinking-Board/src/engine/runner.ts</summary>

</details>

</tool-use>

---


Here’s a concise guide to what was going on and what was changed.

---

## What likely happened

**Two things together:**

1. **Plugin saves, but doesn’t tell Obsidian the canvas is dirty**  
   After run, the plugin:
   - Calls `setData(data)` so the canvas view shows the new output node.
   - Calls `saveCanvasData(...)` and writes the canvas file to disk.

   It never calls Obsidian’s `requestSave()`, so the canvas view is not marked as “modified”.

2. **On “switch away”, Obsidian may save the view’s own state**  
   When you change tab or leave the canvas, Obsidian can trigger a save of the **view’s** current state. In a busy vault (many plugins, sync, themes), that can run after our write. If the view’s internal state wasn’t considered updated by our `setData`, or was still an older snapshot, Obsidian can write **that** state to the file and overwrite the version that contained the output node. Result: you come back and the output node is gone.

So: our write was correct, but a later save from the canvas view could overwrite it when we hadn’t told Obsidian the canvas was dirty.

**Other possible contributors in a “complicated” vault:**

- **Sync** (e.g. iCloud, Obsidian Sync): another device or sync process might write an older version of the file.
- **Other plugins** that touch the same canvas file or trigger saves.
- **Save timing**: our write might not be flushed before the view’s save runs.

---

## What was changed in code

- **After run (when we add/update the output node):** we now call `requestSave()` right after `setData(data)` (in `updateEdgeLabelsAndSave` and in the Python code-fence path). That way Obsidian marks the canvas as dirty with the state we just set, so when you switch away it should save **that** state instead of an older one.
- **Dismiss paths** already called `requestSave()`; no change there.

So the intended behavior now is:

1. Run adds the output node → we `setData` and write the file.
2. We call `requestSave()` so the canvas is “dirty” with the same data.
3. When you switch away, Obsidian saves the canvas and should persist the output node instead of overwriting it.

Try again in the complicated vault: run so the green output node appears, switch to another note, then come back. If the output node still disappears, the next place to look is sync or another plugin overwriting the file; we can add targeted logging around save/load to confirm.

---

